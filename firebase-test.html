<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase äº‘ç«¯å¤‡ä»½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #4285f4;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .status.disconnected {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
        }
        
        .status.connecting {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .status.connected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary {
            background: #4285f4;
            color: white;
        }
        
        .btn-success {
            background: #34a853;
            color: white;
        }
        
        .btn-warning {
            background: #fbbc04;
            color: #212529;
        }
        
        .btn-danger {
            background: #ea4335;
            color: white;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        
        .code-display {
            background: #f8fff9;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
            display: none;
        }
        
        .code-text {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            letter-spacing: 4px;
            margin-bottom: 8px;
        }
        
        .code-expiry {
            font-size: 12px;
            color: #666;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .sync-details {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            display: none;
        }
        
        .sync-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .sync-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 16px;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Firebase äº‘ç«¯å¤‡ä»½æµ‹è¯•</h1>
    
    <div class="container">
        <h2>ğŸ“Š è¿æ¥çŠ¶æ€</h2>
        <div id="firebase-status" class="status disconnected">
            <span id="status-icon">âšª</span>
            <span id="status-text">æœªè¿æ¥</span>
        </div>
        <div id="user-info" style="display: none;">
            <p><strong>ç”¨æˆ·ID:</strong> <span id="user-id">-</span></p>
            <p><strong>è®¾å¤‡:</strong> <span id="device-name">-</span></p>
        </div>
    </div>
    
    <div class="container">
        <h2>ğŸ”— ä¸»è®¾å¤‡æ“ä½œ</h2>
        <p>åœ¨ä¸»è®¾å¤‡ä¸Šåˆå§‹åŒ–äº‘ç«¯å¤‡ä»½å¹¶ç”Ÿæˆè¿æ¥ç </p>
        
        <button id="init-firebase" class="btn btn-primary">ğŸ”¥ åˆå§‹åŒ– Firebase</button>
        <button id="generate-code" class="btn btn-success" disabled>ğŸ”‘ ç”Ÿæˆè¿æ¥ç </button>
        <button id="backup-data" class="btn btn-warning" disabled>â˜ï¸ å¤‡ä»½æ•°æ®</button>
        
        <div id="connection-code-display" class="code-display">
            <div class="code-text" id="connection-code">------</div>
            <div class="code-expiry">è¿æ¥ç æœ‰æ•ˆæœŸï¼š5åˆ†é’Ÿ</div>
            <button id="copy-code" class="btn btn-primary">ğŸ“‹ å¤åˆ¶è¿æ¥ç </button>
        </div>
    </div>
    
    <div class="container">
        <h2>ğŸ“± ä»è®¾å¤‡æ“ä½œ</h2>
        <p>è¾“å…¥ä¸»è®¾å¤‡ç”Ÿæˆçš„è¿æ¥ç æ¥åŒæ­¥æ•°æ®</p>
        
        <div class="input-group">
            <label for="code-input">è¿æ¥ç  (6ä½)</label>
            <input type="text" id="code-input" placeholder="è¾“å…¥è¿æ¥ç " maxlength="6" style="text-transform: uppercase; text-align: center; letter-spacing: 2px;">
        </div>
        
        <button id="connect-device" class="btn btn-primary">ğŸ”— è¿æ¥åŒæ­¥</button>
        <button id="restore-data" class="btn btn-success" disabled>ğŸ“¥ æ¢å¤æ•°æ®</button>
    </div>
    
    <div class="container">
        <h2>ğŸ“Š æ•°æ®ç®¡ç†</h2>
        
        <button id="check-status" class="btn btn-primary">ğŸ” æ£€æŸ¥åŒæ­¥çŠ¶æ€</button>
        <button id="disconnect" class="btn btn-danger" disabled>ğŸ”Œ æ–­å¼€è¿æ¥</button>
        
        <div id="sync-details" class="sync-details">
            <div class="sync-item">
                <span><strong>ğŸ“± å® ç‰©æ•°æ®:</strong></span>
                <span id="sync-pet">-</span>
            </div>
            <div class="sync-item">
                <span><strong>ğŸ¤– AIè®¾ç½®:</strong></span>
                <span id="sync-ai">-</span>
            </div>
            <div class="sync-item">
                <span><strong>ğŸ¨ å¤´åƒ:</strong></span>
                <span id="sync-avatar">-</span>
            </div>
            <div class="sync-item">
                <span><strong>â° æœ€ååŒæ­¥:</strong></span>
                <span id="sync-time">-</span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
        <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
        <button id="clear-log" class="btn btn-warning">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyA74TnN9IoyQjCncKOIOShWEktrL1hd96o",
            authDomain: "kpop-pett.firebaseapp.com",
            projectId: "kpop-pett",
            storageBucket: "kpop-pett.firebasestorage.app",
            messagingSenderId: "264650615774",
            appId: "1:264650615774:web:f500ff555183110c3f0b4f",
            measurementId: "G-3BH0GMJR3D"
        };

        // å…¨å±€å˜é‡
        let app = null;
        let auth = null;
        let db = null;
        let storage = null;
        let currentUser = null;
        let connectionCode = null;

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, message) {
            const statusElement = document.getElementById('firebase-status');
            const iconElement = document.getElementById('status-icon');
            const textElement = document.getElementById('status-text');
            const userInfo = document.getElementById('user-info');

            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusElement.className = 'status';
            
            switch (status) {
                case 'connected':
                    statusElement.classList.add('connected');
                    iconElement.textContent = 'ğŸŸ¢';
                    textElement.textContent = message || 'å·²è¿æ¥';
                    if (currentUser) {
                        document.getElementById('user-id').textContent = currentUser.uid.substring(0, 8) + '...';
                        document.getElementById('device-name').textContent = getDeviceName();
                        userInfo.style.display = 'block';
                    }
                    // å¯ç”¨æŒ‰é’®
                    document.getElementById('generate-code').disabled = false;
                    document.getElementById('backup-data').disabled = false;
                    document.getElementById('restore-data').disabled = false;
                    document.getElementById('disconnect').disabled = false;
                    break;
                    
                case 'connecting':
                    statusElement.classList.add('connecting');
                    iconElement.textContent = 'ğŸŸ¡';
                    textElement.textContent = message || 'è¿æ¥ä¸­...';
                    userInfo.style.display = 'none';
                    break;
                    
                case 'error':
                    statusElement.classList.add('error');
                    iconElement.textContent = 'ğŸ”´';
                    textElement.textContent = message || 'è¿æ¥é”™è¯¯';
                    userInfo.style.display = 'none';
                    break;
                    
                default: // disconnected
                    statusElement.classList.add('disconnected');
                    iconElement.textContent = 'âšª';
                    textElement.textContent = message || 'æœªè¿æ¥';
                    userInfo.style.display = 'none';
                    // ç¦ç”¨æŒ‰é’®
                    document.getElementById('generate-code').disabled = true;
                    document.getElementById('backup-data').disabled = true;
                    document.getElementById('restore-data').disabled = true;
                    document.getElementById('disconnect').disabled = true;
                    break;
            }
        }

        // è·å–è®¾å¤‡åç§°
        function getDeviceName() {
            const userAgent = navigator.userAgent;
            if (/iPad|iPhone|iPod/.test(userAgent)) {
                return 'iOSè®¾å¤‡';
            } else if (/Android/.test(userAgent)) {
                return 'Androidè®¾å¤‡';
            } else if (/Windows/.test(userAgent)) {
                return 'Windowsç”µè„‘';
            } else if (/Mac/.test(userAgent)) {
                return 'Macç”µè„‘';
            } else {
                return 'æœªçŸ¥è®¾å¤‡';
            }
        }

        // Firebase åˆå§‹åŒ–
        async function initializeFirebase() {
            try {
                log('ğŸ”¥ å¼€å§‹åˆå§‹åŒ– Firebase...');
                updateStatus('connecting', 'åˆå§‹åŒ–ä¸­...');

                // åˆå§‹åŒ– Firebase åº”ç”¨
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();

                // åˆå§‹åŒ– Analytics (å¯é€‰)
                try {
                    if (firebase.analytics && firebaseConfig.measurementId) {
                        firebase.analytics();
                        log('ğŸ“Š Firebase Analyticså·²å¯ç”¨');
                    }
                } catch (analyticsError) {
                    log(`âš ï¸ Firebase Analyticsåˆå§‹åŒ–å¤±è´¥: ${analyticsError.message}`);
                }

                log('âœ… Firebase åº”ç”¨åˆå§‹åŒ–æˆåŠŸ');

                // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user) {
                        log(`ğŸ‘¤ ç”¨æˆ·å·²ç™»å½•: ${user.uid}`);
                        updateStatus('connected', 'å·²è¿æ¥');
                    } else {
                        log('ğŸ‘¤ ç”¨æˆ·æœªç™»å½•');
                        updateStatus('disconnected', 'æœªç™»å½•');
                    }
                });

                // åŒ¿åç™»å½•
                log('ğŸ” æ‰§è¡ŒåŒ¿åç™»å½•...');
                const userCredential = await auth.signInAnonymously();
                currentUser = userCredential.user;

                log(`âœ… åŒ¿åç™»å½•æˆåŠŸ: ${currentUser.uid}`);

                // åˆ›å»ºç”¨æˆ·é…ç½®æ–‡æ¡£
                await createUserProfile();

                updateStatus('connected', 'å·²è¿æ¥');
                return true;

            } catch (error) {
                log(`âŒ Firebase åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                updateStatus('error', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // åˆ›å»ºç”¨æˆ·é…ç½®æ–‡æ¡£
        async function createUserProfile() {
            try {
                if (!currentUser) return;

                const userDoc = db.collection('users').doc(currentUser.uid);
                const docSnapshot = await userDoc.get();

                if (!docSnapshot.exists) {
                    const userProfile = {
                        uid: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deviceName: getDeviceName(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        dataVersion: '1.0'
                    };

                    await userDoc.set(userProfile);
                    log('ğŸ‘¤ ç”¨æˆ·é…ç½®æ–‡æ¡£å·²åˆ›å»º');
                } else {
                    // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
                    await userDoc.update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        deviceName: getDeviceName()
                    });
                    log('ğŸ‘¤ ç”¨æˆ·é…ç½®æ–‡æ¡£å·²æ›´æ–°');
                }
            } catch (error) {
                log(`âŒ åˆ›å»ºç”¨æˆ·é…ç½®å¤±è´¥: ${error.message}`);
            }
        }

        // ç”Ÿæˆè¿æ¥ç 
        async function generateConnectionCode() {
            try {
                if (!currentUser) {
                    throw new Error('ç”¨æˆ·æœªç™»å½•');
                }

                log('ğŸ”‘ ç”Ÿæˆè¿æ¥ç ...');

                // ç”Ÿæˆ6ä½éšæœºè¿æ¥ç 
                const code = generateRandomCode();
                const expiry = Date.now() + (5 * 60 * 1000); // 5åˆ†é’Ÿåè¿‡æœŸ

                // ä¿å­˜è¿æ¥ç åˆ°Firestore
                const codeDoc = db.collection('connectionCodes').doc(code);
                await codeDoc.set({
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(expiry),
                    used: false
                });

                connectionCode = code;

                log(`âœ… è¿æ¥ç ç”ŸæˆæˆåŠŸ: ${code}`);

                // æ˜¾ç¤ºè¿æ¥ç 
                document.getElementById('connection-code').textContent = code;
                document.getElementById('connection-code-display').style.display = 'block';

                // 5åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†è¿‡æœŸè¿æ¥ç 
                setTimeout(() => {
                    cleanupExpiredCode(code);
                }, 5 * 60 * 1000);

                return code;
            } catch (error) {
                log(`âŒ ç”Ÿæˆè¿æ¥ç å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // ç”Ÿæˆéšæœºè¿æ¥ç 
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // æ¸…ç†è¿‡æœŸè¿æ¥ç 
        async function cleanupExpiredCode(code) {
            try {
                const codeDoc = db.collection('connectionCodes').doc(code);
                await codeDoc.delete();
                log(`ğŸ§¹ å·²æ¸…ç†è¿‡æœŸè¿æ¥ç : ${code}`);
            } catch (error) {
                log(`âŒ æ¸…ç†è¿æ¥ç å¤±è´¥: ${error.message}`);
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼ŒFirebaseæµ‹è¯•å·¥å…·å·²å‡†å¤‡å°±ç»ª');
            updateStatus('disconnected');

            // ç»‘å®šäº‹ä»¶
            bindEvents();
        });

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // åˆå§‹åŒ–FirebaseæŒ‰é’®
            document.getElementById('init-firebase').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;

                try {
                    button.disabled = true;
                    button.textContent = 'ğŸ”„ åˆå§‹åŒ–ä¸­...';

                    await initializeFirebase();

                    button.textContent = 'âœ… åˆå§‹åŒ–å®Œæˆ';
                    button.className = 'btn btn-success';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-primary';
                        button.disabled = false;
                    }, 2000);

                } catch (error) {
                    button.textContent = 'âŒ åˆå§‹åŒ–å¤±è´¥';
                    button.className = 'btn btn-danger';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-primary';
                        button.disabled = false;
                    }, 3000);
                }
            });

            // ç”Ÿæˆè¿æ¥ç æŒ‰é’®
            document.getElementById('generate-code').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;

                try {
                    button.disabled = true;
                    button.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';

                    await generateConnectionCode();

                    button.textContent = 'âœ… å·²ç”Ÿæˆ';
                    button.className = 'btn btn-success';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-success';
                        button.disabled = false;
                    }, 2000);

                } catch (error) {
                    button.textContent = 'âŒ ç”Ÿæˆå¤±è´¥';
                    button.className = 'btn btn-danger';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-success';
                        button.disabled = false;
                    }, 3000);
                }
            });

            // å¤åˆ¶è¿æ¥ç æŒ‰é’®
            document.getElementById('copy-code').addEventListener('click', function() {
                const codeText = document.getElementById('connection-code').textContent;

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(codeText).then(() => {
                        log('ğŸ“‹ è¿æ¥ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');

                        const button = this;
                        const originalText = button.textContent;
                        button.textContent = 'âœ… å·²å¤åˆ¶';
                        setTimeout(() => {
                            button.textContent = originalText;
                        }, 2000);
                    }).catch(() => {
                        log('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    });
                } else {
                    // é™çº§æ–¹æ¡ˆ
                    const textArea = document.createElement('textarea');
                    textArea.value = codeText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        log('ğŸ“‹ è¿æ¥ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (err) {
                        log('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    }
                    document.body.removeChild(textArea);
                }
            });

            // è¿æ¥ç è¾“å…¥æ¡†æ ¼å¼åŒ–
            document.getElementById('code-input').addEventListener('input', function() {
                let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (value.length > 6) {
                    value = value.substring(0, 6);
                }
                this.value = value;
            });

            // è¿æ¥ç è¾“å…¥æ¡†å›è½¦é”®
            document.getElementById('code-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('connect-device').click();
                }
            });

            // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
            document.getElementById('clear-log').addEventListener('click', function() {
                document.getElementById('log').textContent = '';
                log('æ—¥å¿—å·²æ¸…ç©º');
            });

            // è¿æ¥è®¾å¤‡æŒ‰é’®
            document.getElementById('connect-device').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;
                const codeInput = document.getElementById('code-input');
                const code = codeInput.value.trim().toUpperCase();

                if (!code || code.length !== 6) {
                    log('âš ï¸ è¯·è¾“å…¥6ä½è¿æ¥ç ');
                    codeInput.focus();
                    return;
                }

                try {
                    button.disabled = true;
                    button.textContent = 'ğŸ”„ è¿æ¥ä¸­...';
                    codeInput.disabled = true;

                    // å¦‚æœè¿˜æ²¡åˆå§‹åŒ–Firebaseï¼Œå…ˆåˆå§‹åŒ–
                    if (!app) {
                        await initializeFirebase();
                    }

                    await connectWithCode(code);

                    button.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                    button.className = 'btn btn-success';
                    codeInput.value = '';
                    codeInput.disabled = false;

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-primary';
                        button.disabled = false;
                    }, 2000);

                } catch (error) {
                    button.textContent = 'âŒ è¿æ¥å¤±è´¥';
                    button.className = 'btn btn-danger';
                    codeInput.disabled = false;

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-primary';
                        button.disabled = false;
                    }, 3000);
                }
            });

            // å¤‡ä»½æ•°æ®æŒ‰é’®
            document.getElementById('backup-data').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;

                try {
                    button.disabled = true;
                    button.textContent = 'â˜ï¸ å¤‡ä»½ä¸­...';

                    await backupTestData();

                    button.textContent = 'âœ… å¤‡ä»½å®Œæˆ';
                    button.className = 'btn btn-success';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-warning';
                        button.disabled = false;
                    }, 2000);

                } catch (error) {
                    button.textContent = 'âŒ å¤‡ä»½å¤±è´¥';
                    button.className = 'btn btn-danger';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-warning';
                        button.disabled = false;
                    }, 3000);
                }
            });

            // æ¢å¤æ•°æ®æŒ‰é’®
            document.getElementById('restore-data').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;

                if (!confirm('ç¡®å®šè¦ä»äº‘ç«¯æ¢å¤æ•°æ®å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼')) {
                    return;
                }

                try {
                    button.disabled = true;
                    button.textContent = 'ğŸ“¥ æ¢å¤ä¸­...';

                    await restoreTestData();

                    button.textContent = 'âœ… æ¢å¤å®Œæˆ';
                    button.className = 'btn btn-success';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-success';
                        button.disabled = false;
                    }, 2000);

                } catch (error) {
                    button.textContent = 'âŒ æ¢å¤å¤±è´¥';
                    button.className = 'btn btn-danger';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-success';
                        button.disabled = false;
                    }, 3000);
                }
            });

            // æ£€æŸ¥çŠ¶æ€æŒ‰é’®
            document.getElementById('check-status').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;

                try {
                    button.disabled = true;
                    button.textContent = 'ğŸ” æ£€æŸ¥ä¸­...';

                    const status = await checkSyncStatus();

                    // æ›´æ–°åŒæ­¥è¯¦æƒ…æ˜¾ç¤º
                    document.getElementById('sync-pet').textContent = status.hasPetData ? 'âœ… å·²åŒæ­¥' : 'âŒ æœªåŒæ­¥';
                    document.getElementById('sync-ai').textContent = status.hasAISettings ? 'âœ… å·²åŒæ­¥' : 'âŒ æœªåŒæ­¥';
                    document.getElementById('sync-avatar').textContent = status.hasAvatar ? 'âœ… å·²åŒæ­¥' : 'âŒ æœªåŒæ­¥';
                    document.getElementById('sync-time').textContent = status.lastBackup ? status.lastBackup.toLocaleString() : 'ä»æœªå¤‡ä»½';

                    document.getElementById('sync-details').style.display = 'block';

                    button.textContent = 'âœ… æ£€æŸ¥å®Œæˆ';
                    button.className = 'btn btn-success';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-primary';
                        button.disabled = false;
                    }, 2000);

                } catch (error) {
                    button.textContent = 'âŒ æ£€æŸ¥å¤±è´¥';
                    button.className = 'btn btn-danger';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-primary';
                        button.disabled = false;
                    }, 3000);
                }
            });

            // æ–­å¼€è¿æ¥æŒ‰é’®
            document.getElementById('disconnect').addEventListener('click', async function() {
                const button = this;
                const originalText = button.textContent;

                if (!confirm('ç¡®å®šè¦æ–­å¼€äº‘ç«¯è¿æ¥å—ï¼Ÿ\n\næ–­å¼€åå°†æ— æ³•åŒæ­¥æ•°æ®ï¼Œä½†æœ¬åœ°æ•°æ®ä¼šä¿ç•™ã€‚')) {
                    return;
                }

                try {
                    button.disabled = true;
                    button.textContent = 'ğŸ”Œ æ–­å¼€ä¸­...';

                    await disconnectFirebase();

                    // éšè—ç›¸å…³UI
                    document.getElementById('connection-code-display').style.display = 'none';
                    document.getElementById('sync-details').style.display = 'none';

                    button.textContent = 'âœ… å·²æ–­å¼€';
                    button.className = 'btn btn-success';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-danger';
                        button.disabled = false;
                    }, 2000);

                } catch (error) {
                    button.textContent = 'âŒ æ–­å¼€å¤±è´¥';
                    button.className = 'btn btn-warning';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.className = 'btn btn-danger';
                        button.disabled = false;
                    }, 3000);
                }
            });
        }

        // ä½¿ç”¨è¿æ¥ç è¿æ¥åˆ°ä¸»è®¾å¤‡
        async function connectWithCode(code) {
            try {
                log(`ğŸ”— å°è¯•è¿æ¥ç : ${code}`);

                // æŸ¥æ‰¾è¿æ¥ç 
                const codeDoc = db.collection('connectionCodes').doc(code.toUpperCase());
                const docSnapshot = await codeDoc.get();

                if (!docSnapshot.exists) {
                    throw new Error('è¿æ¥ç ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
                }

                const codeData = docSnapshot.data();

                // æ£€æŸ¥è¿æ¥ç æ˜¯å¦è¿‡æœŸ
                if (codeData.expiresAt.toDate() < new Date()) {
                    await codeDoc.delete();
                    throw new Error('è¿æ¥ç å·²è¿‡æœŸ');
                }

                // æ£€æŸ¥è¿æ¥ç æ˜¯å¦å·²ä½¿ç”¨
                if (codeData.used) {
                    throw new Error('è¿æ¥ç å·²è¢«ä½¿ç”¨');
                }

                // æ ‡è®°è¿æ¥ç ä¸ºå·²ä½¿ç”¨
                await codeDoc.update({
                    used: true,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    secondaryUserId: currentUser.uid
                });

                // ä»ä¸»è®¾å¤‡åŒæ­¥æ•°æ®
                await syncDataFromPrimary(codeData.userId);

                log('âœ… è¿æ¥æˆåŠŸï¼Œæ•°æ®å·²åŒæ­¥');

                return true;
            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // ä»ä¸»è®¾å¤‡åŒæ­¥æ•°æ®
        async function syncDataFromPrimary(primaryUserId) {
            try {
                log('ğŸ“¥ ä»ä¸»è®¾å¤‡åŒæ­¥æ•°æ®...');

                const userDoc = db.collection('users').doc(primaryUserId);
                const docSnapshot = await userDoc.get();

                if (!docSnapshot.exists) {
                    throw new Error('ä¸»è®¾å¤‡æ•°æ®ä¸å­˜åœ¨');
                }

                const userData = docSnapshot.data();

                // åŒæ­¥æµ‹è¯•æ•°æ®
                if (userData.testData) {
                    localStorage.setItem('firebase-test-data', JSON.stringify(userData.testData));
                    log('âœ… æµ‹è¯•æ•°æ®å·²åŒæ­¥');
                }

                log('âœ… æ‰€æœ‰æ•°æ®å·²ä»ä¸»è®¾å¤‡åŒæ­¥å®Œæˆ');

            } catch (error) {
                log(`âŒ æ•°æ®åŒæ­¥å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // å¤‡ä»½æµ‹è¯•æ•°æ®
        async function backupTestData() {
            try {
                if (!currentUser) {
                    throw new Error('ç”¨æˆ·æœªç™»å½•');
                }

                log('â˜ï¸ å¤‡ä»½æµ‹è¯•æ•°æ®åˆ°Firebase...');

                const userDoc = db.collection('users').doc(currentUser.uid);

                // å‡†å¤‡æµ‹è¯•æ•°æ®
                const testData = {
                    petData: {
                        name: 'æµ‹è¯•å® ç‰©',
                        level: 5,
                        health: 80,
                        happiness: 90,
                        hunger: 70,
                        energy: 85,
                        coins: 150,
                        experience: 250
                    },
                    aiSettings: {
                        apiType: 'openai',
                        model: 'gpt-3.5-turbo',
                        temperature: 0.7
                    },
                    avatar: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    timestamp: Date.now()
                };

                const backupData = {
                    lastBackup: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceName: getDeviceName(),
                    dataVersion: '1.0',
                    testData: testData
                };

                // æ‰§è¡Œå¤‡ä»½
                await userDoc.set(backupData, { merge: true });

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('firebase-test-data', JSON.stringify(testData));

                log('âœ… æµ‹è¯•æ•°æ®å¤‡ä»½å®Œæˆ');

                return true;
            } catch (error) {
                log(`âŒ æ•°æ®å¤‡ä»½å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // æ¢å¤æµ‹è¯•æ•°æ®
        async function restoreTestData() {
            try {
                if (!currentUser) {
                    throw new Error('ç”¨æˆ·æœªç™»å½•');
                }

                log('ğŸ“¥ ä»Firebaseæ¢å¤æµ‹è¯•æ•°æ®...');

                const userDoc = db.collection('users').doc(currentUser.uid);
                const docSnapshot = await userDoc.get();

                if (!docSnapshot.exists) {
                    throw new Error('äº‘ç«¯æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ•°æ®');
                }

                const userData = docSnapshot.data();

                if (!userData.testData) {
                    throw new Error('äº‘ç«¯æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®');
                }

                // æ¢å¤åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('firebase-test-data', JSON.stringify(userData.testData));

                const lastBackup = userData.lastBackup ? userData.lastBackup.toDate().toLocaleString() : 'æœªçŸ¥';
                log(`âœ… æµ‹è¯•æ•°æ®å·²æ¢å¤\næœ€åå¤‡ä»½æ—¶é—´: ${lastBackup}`);

                return userData.testData;
            } catch (error) {
                log(`âŒ æ•°æ®æ¢å¤å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        // æ£€æŸ¥åŒæ­¥çŠ¶æ€
        async function checkSyncStatus() {
            try {
                if (!currentUser) {
                    return {
                        connected: false,
                        message: 'æœªè¿æ¥åˆ°äº‘ç«¯'
                    };
                }

                const userDoc = db.collection('users').doc(currentUser.uid);
                const docSnapshot = await userDoc.get();

                if (!docSnapshot.exists) {
                    return {
                        connected: true,
                        hasBackup: false,
                        message: 'å·²è¿æ¥ï¼Œä½†æ²¡æœ‰å¤‡ä»½æ•°æ®'
                    };
                }

                const userData = docSnapshot.data();
                const lastBackup = userData.lastBackup ? userData.lastBackup.toDate() : null;

                log(`ğŸ” åŒæ­¥çŠ¶æ€æ£€æŸ¥å®Œæˆ`);

                return {
                    connected: true,
                    hasBackup: true,
                    lastBackup: lastBackup,
                    hasPetData: !!(userData.testData && userData.testData.petData),
                    hasAISettings: !!(userData.testData && userData.testData.aiSettings),
                    hasAvatar: !!(userData.testData && userData.testData.avatar),
                    deviceName: userData.deviceName,
                    message: lastBackup ? `æœ€åå¤‡ä»½: ${lastBackup.toLocaleString()}` : 'æœ‰å¤‡ä»½æ•°æ®'
                };
            } catch (error) {
                log(`âŒ æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥: ${error.message}`);
                return {
                    connected: false,
                    error: true,
                    message: `æ£€æŸ¥å¤±è´¥: ${error.message}`
                };
            }
        }

        // æ–­å¼€Firebaseè¿æ¥
        async function disconnectFirebase() {
            try {
                if (currentUser) {
                    await auth.signOut();
                    log('ğŸ‘‹ å·²æ–­å¼€Firebaseè¿æ¥');
                }

                currentUser = null;
                connectionCode = null;

                updateStatus('disconnected', 'å·²æ–­å¼€è¿æ¥');

                return true;
            } catch (error) {
                log(`âŒ æ–­å¼€è¿æ¥å¤±è´¥: ${error.message}`);
                throw error;
            }
        }
    </script>
</body>
</html>
