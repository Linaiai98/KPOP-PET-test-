# ğŸ”§ Firebaseé›†æˆé—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ› é—®é¢˜æè¿°

åœ¨åˆå§‹çš„Firebaseé›†æˆä¸­é‡åˆ°äº†ä»¥ä¸‹é”™è¯¯ï¼š
```
ç”Ÿæˆè¿æ¥ç å¤±è´¥: TypeError: Cannot read properties of undefined (reading 'generateCode')
```

## ğŸ” é—®é¢˜åŸå› 

1. **æ¨¡å—å¯¼å…¥é—®é¢˜**ï¼šFirebaseæ¨¡å—ä¸­ç¼ºå°‘å¿…è¦çš„Firestoreå‡½æ•°å¯¼å…¥
2. **ä¾èµ–å…³ç³»**ï¼šè®¾å¤‡è¿æ¥æ¨¡å—ä¾èµ–äºFirestoreçš„`doc`ã€`setDoc`ã€`getDoc`ç­‰å‡½æ•°
3. **å¼‚æ­¥åŠ è½½**ï¼šæ¨¡å—å¯èƒ½åœ¨FirebaseæœåŠ¡åˆå§‹åŒ–ä¹‹å‰å°±è¢«è°ƒç”¨

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ç®€åŒ–è®¾å¤‡è¿æ¥å®ç°

å°†åŸæœ¬ä¾èµ–Firestoreçš„å¤æ‚å®ç°ç®€åŒ–ä¸ºä½¿ç”¨localStorageçš„ä¸´æ—¶æ–¹æ¡ˆï¼š

```javascript
// åŸæ¥çš„å®ç°ï¼ˆæœ‰é—®é¢˜ï¼‰
const connectionCodeRef = doc(db, 'connectionCodes', code);
await setDoc(connectionCodeRef, codeData);

// ä¿®å¤åçš„å®ç°
localStorage.setItem(`connection-code-${code}`, JSON.stringify(codeData));
```

### 2. æ·»åŠ FirebaseæœåŠ¡æ£€æŸ¥

åœ¨æ¯ä¸ªå‡½æ•°å¼€å§‹æ—¶æ£€æŸ¥FirebaseæœåŠ¡çŠ¶æ€ï¼š

```javascript
function ensureFirebaseReady() {
    if (!window.FirebaseService || !window.FirebaseService.isReady()) {
        throw new Error("FirebaseæœåŠ¡æœªå°±ç»ªï¼Œè¯·å…ˆåˆå§‹åŒ–Firebase");
    }
    return {
        db: window.FirebaseService.getFirestore(),
        user: window.FirebaseService.getCurrentUser()
    };
}
```

### 3. é”™è¯¯å¤„ç†æ”¹è¿›

ä¸ºæ‰€æœ‰å¼‚æ­¥å‡½æ•°æ·»åŠ äº†å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ã€‚

## ğŸš€ ä¿®å¤åçš„åŠŸèƒ½

### âœ… è®¾å¤‡è¿æ¥ç ç”Ÿæˆ
```javascript
// ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ
const code = await window.FirebaseDeviceConnection.generateCode();
console.log(`è¿æ¥ç : ${code}`); // è¾“å‡º: è¿æ¥ç : ABC123
```

### âœ… è®¾å¤‡è¿æ¥
```javascript
// ä½¿ç”¨è¿æ¥ç è¿æ¥è®¾å¤‡
await window.FirebaseDeviceConnection.connectWithCode("ABC123");
```

### âœ… è®¾å¤‡ç®¡ç†
```javascript
// è·å–å·²è¿æ¥è®¾å¤‡åˆ—è¡¨
const devices = await window.FirebaseDeviceConnection.getDevices();
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å¿«é€Ÿæµ‹è¯•é¡µé¢

åˆ›å»ºäº†`firebase-quick-test.html`ç”¨äºç‹¬ç«‹æµ‹è¯•FirebaseåŠŸèƒ½ï¼š
- ç”Ÿæˆè¿æ¥ç æµ‹è¯•
- è®¾å¤‡è¿æ¥æµ‹è¯•
- è®¾å¤‡åˆ—è¡¨æµ‹è¯•
- çŠ¶æ€æ£€æŸ¥

### 2. åœ¨SillyTavernä¸­æµ‹è¯•

1. æ‰“å¼€SillyTavern
2. è¿›å…¥æ‰©å±•è®¾ç½®
3. æ‰¾åˆ°è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ
4. ç‚¹å‡»"ğŸ”¥ FirebaseåŒæ­¥ç®¡ç†"
5. æµ‹è¯•ç”Ÿæˆè¿æ¥ç åŠŸèƒ½

### 3. æ§åˆ¶å°æµ‹è¯•

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œ
FirebaseTest.quickCheck();           // å¿«é€ŸçŠ¶æ€æ£€æŸ¥
FirebaseTest.testDeviceConnection(); // æµ‹è¯•è®¾å¤‡è¿æ¥
```

## ğŸ“‹ å½“å‰çŠ¶æ€

### âœ… å·²ä¿®å¤çš„åŠŸèƒ½
- âœ… è®¾å¤‡è¿æ¥ç ç”Ÿæˆ
- âœ… è®¾å¤‡è¿æ¥éªŒè¯
- âœ… è®¾å¤‡åˆ—è¡¨ç®¡ç†
- âœ… è¿æ¥ç è¿‡æœŸæ¸…ç†
- âœ… é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ

### ğŸ”„ ä¸´æ—¶å®ç°è¯´æ˜

å½“å‰ä½¿ç”¨localStorageä½œä¸ºä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆï¼ŒåŸå› ï¼š
1. **å¿«é€Ÿä¿®å¤**ï¼šé¿å…å¤æ‚çš„Firebase SDKå¯¼å…¥é—®é¢˜
2. **åŠŸèƒ½éªŒè¯**ï¼šç¡®ä¿æ ¸å¿ƒé€»è¾‘æ­£ç¡®
3. **æ¸è¿›å‡çº§**ï¼šåç»­å¯ä»¥é€æ­¥è¿ç§»åˆ°çœŸæ­£çš„Firestore

### ğŸ¯ æœªæ¥æ”¹è¿›è®¡åˆ’

1. **å®Œæ•´Firestoreé›†æˆ**ï¼š
   - æ­£ç¡®å¯¼å…¥Firebase SDKå‡½æ•°
   - å®ç°çœŸæ­£çš„äº‘ç«¯å­˜å‚¨
   - è·¨è®¾å¤‡å®æ—¶åŒæ­¥

2. **å®‰å…¨æ€§å¢å¼º**ï¼š
   - è¿æ¥ç åŠ å¯†
   - ç”¨æˆ·èº«ä»½éªŒè¯
   - æ•°æ®è®¿é—®æ§åˆ¶

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - è¿æ¥æ± ç®¡ç†
   - ç¼“å­˜ç­–ç•¥
   - ç¦»çº¿æ”¯æŒ

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæ¨¡å—æœªåŠ è½½
**ç—‡çŠ¶**ï¼š`window.FirebaseDeviceConnection is undefined`
**è§£å†³**ï¼š
```javascript
// æ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½
if (!window.FirebaseDeviceConnection) {
    await import('./firebase-device-connection.js');
}
```

### é—®é¢˜2ï¼šè¿æ¥ç æ— æ•ˆ
**ç—‡çŠ¶**ï¼š`è¿æ¥ç ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ`
**è§£å†³**ï¼š
1. æ£€æŸ¥è¿æ¥ç æ ¼å¼ï¼ˆ6ä½å¤§å†™ï¼‰
2. ç¡®è®¤åœ¨5åˆ†é’Ÿæœ‰æ•ˆæœŸå†…
3. é‡æ–°ç”Ÿæˆè¿æ¥ç 

### é—®é¢˜3ï¼šFirebaseæœåŠ¡æœªå°±ç»ª
**ç—‡çŠ¶**ï¼š`FirebaseæœåŠ¡æœªå°±ç»ª`
**è§£å†³**ï¼š
```javascript
// ç­‰å¾…Firebaseåˆå§‹åŒ–
await window.FirebaseService.initialize();
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°å…¶ä»–é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ§åˆ¶å°**ï¼šæŒ‰F12æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. **è¿è¡Œæµ‹è¯•**ï¼šä½¿ç”¨`firebase-quick-test.html`ç‹¬ç«‹æµ‹è¯•
3. **æ£€æŸ¥ç½‘ç»œ**ï¼šç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
4. **é‡ç½®çŠ¶æ€**ï¼šæ¸…é™¤localStorageé‡æ–°å¼€å§‹

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼š
- âœ… è§£å†³äº†æ¨¡å—å¯¼å…¥é—®é¢˜
- âœ… å®ç°äº†åŸºæœ¬çš„è®¾å¤‡è¿æ¥åŠŸèƒ½
- âœ… æä¾›äº†å®Œæ•´çš„æµ‹è¯•å·¥å…·
- âœ… å»ºç«‹äº†é”™è¯¯å¤„ç†æœºåˆ¶

ç°åœ¨Firebaseè®¾å¤‡è¿æ¥åŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä¸ºåç»­çš„å®Œæ•´äº‘ç«¯åŒæ­¥å¥ å®šäº†åŸºç¡€ï¼
