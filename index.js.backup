// è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ - SillyTavernæ’ä»¶
console.log("ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿè„šæœ¬å¼€å§‹åŠ è½½...");

// ä½¿ç”¨ jQuery ç¡®ä¿åœ¨ DOM åŠ è½½å®Œæ¯•åæ‰§è¡Œæˆ‘ä»¬çš„ä»£ç 
jQuery(async () => {
    console.log("ğŸ¾ jQuery ready, å¼€å§‹åˆå§‹åŒ–...");

    // -----------------------------------------------------------------
    // 1. å®šä¹‰å¸¸é‡å’ŒçŠ¶æ€å˜é‡
    // -----------------------------------------------------------------
    const extensionName = "virtual-pet-system";
    const extensionFolderPath = `scripts/extensions/third-party/${extensionName}`;

    console.log(`[${extensionName}] Starting initialization...`);
    console.log(`[${extensionName}] Extension folder path: ${extensionFolderPath}`);
    
    // å­˜å‚¨é”®
    const STORAGE_KEY_BUTTON_POS = "virtual-pet-button-position";
    const STORAGE_KEY_ENABLED = "virtual-pet-enabled";
    const STORAGE_KEY_PET_DATA = "virtual-pet-data";
    const STORAGE_KEY_CUSTOM_AVATAR = "virtual-pet-custom-avatar";

    // Firebase ç›¸å…³å¸¸é‡
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyA74TnN9IoyQjCncKOIOShWEktrL1hd96o",
        authDomain: "kpop-pett.firebaseapp.com",
        projectId: "kpop-pett",
        storageBucket: "kpop-pett.firebasestorage.app",
        messagingSenderId: "264650615774",
        appId: "1:264650615774:web:f500ff555183110c3f0b4f",
        measurementId: "G-3BH0GMJR3D"
    };

    const FIREBASE_STORAGE_KEYS = {
        PET_DATA: "pet_data",
        AI_SETTINGS: "ai_settings",
        AVATAR: "avatar",
        USER_PROFILE: "user_profile",
        CONNECTION_CODES: "connection_codes"
    };
    
    // DOM IDs and Selectors
    const BUTTON_ID = "virtual-pet-button";
    const OVERLAY_ID = "virtual-pet-popup-overlay";
    const POPUP_ID = "virtual-pet-popup";
    const CLOSE_BUTTON_ID = "virtual-pet-popup-close-button";
    const TOGGLE_ID = "#virtual-pet-enabled-toggle";
    
    // DOM å…ƒç´ å¼•ç”¨
    let overlay, mainView, petView, settingsView, chatView;
    let petContainer;

    // å¼¹çª—çŠ¶æ€ç®¡ç†
    let isPopupOpen = false;

    // è‡ªå®šä¹‰å¤´åƒç®¡ç†
    let customAvatarData = null;

    // åŒæ­¥ä¿å­˜é™åˆ¶æœºåˆ¶
    let lastSyncSaveTime = 0;
    const SYNC_SAVE_COOLDOWN = 2000; // 2ç§’å†·å´æ—¶é—´ï¼Œé¿å…é¢‘ç¹ä¿å­˜

    // Firebase çŠ¶æ€ç®¡ç†
    let firebaseApp = null;
    let firebaseAuth = null;
    let firebaseDb = null;
    let firebaseStorage = null;
    let currentUser = null;
    let isFirebaseInitialized = false;
    let connectionCode = null;
    let connectionCodeExpiry = null;

    // èŠå¤©åŠŸèƒ½çŠ¶æ€ç®¡ç†
    let chatHistory = [];
    let isAIResponding = false;
    let chatInitialized = false;

    // å®‰å…¨çš„z-indexå€¼ï¼Œé¿å…å½±å“å…¶ä»–æ’ä»¶
    const SAFE_Z_INDEX = {
        button: 10000,      // æ‚¬æµ®æŒ‰é’® - ä½äºå…¶ä»–æ‚¬æµ®æ’ä»¶
        popup: 10001,       // å¼¹çª—
        overlay: 10000,     // é®ç½©å±‚
        notification: 10002 // é€šçŸ¥
    };

    // æ ·å¼éš”ç¦»å‰ç¼€ï¼Œç¡®ä¿ä¸å½±å“å…¶ä»–æ’ä»¶
    const STYLE_PREFIX = 'virtual-pet-';

    /**
     * è·å–å®‰å…¨çš„ä¸»é¢˜é¢œè‰²
     */
    function getSafeThemeColors() {
        // å°è¯•è·å–SillyTavernçš„ä¸»é¢˜é¢œè‰²ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼
        const computedStyle = getComputedStyle(document.documentElement);

        const bodyColor = computedStyle.getPropertyValue('--SmartThemeBodyColor') ||
                         computedStyle.getPropertyValue('--body-color') ||
                         '#2d2d2d'; // å®‰å…¨çš„é»˜è®¤æ·±è‰²èƒŒæ™¯

        const textColor = computedStyle.getPropertyValue('--SmartThemeEmColor') ||
                         computedStyle.getPropertyValue('--text-color') ||
                         '#ffffff'; // å®‰å…¨çš„é»˜è®¤ç™½è‰²æ–‡å­—

        const borderColor = computedStyle.getPropertyValue('--border-color') || '#444444';

        console.log(`[${extensionName}] ä¸»é¢˜é¢œè‰²: èƒŒæ™¯=${bodyColor}, æ–‡å­—=${textColor}, è¾¹æ¡†=${borderColor}`);

        return {
            background: bodyColor.trim(),
            text: textColor.trim(),
            border: borderColor.trim()
        };
    }

    /**
     * åˆ›å»ºæ ·å¼éš”ç¦»çš„CSSè§„åˆ™ - ä¸ä¾èµ–ä¸»é¢˜å˜é‡
     */
    function createIsolatedStyles() {
        const styleId = `${STYLE_PREFIX}isolated-styles`;

        // å¦‚æœå·²ç»å­˜åœ¨ï¼Œå…ˆç§»é™¤
        $(`#${styleId}`).remove();

        // è·å–å®‰å…¨çš„ä¸»é¢˜é¢œè‰²
        const colors = getSafeThemeColors();

        const isolatedCSS = `
            /* è™šæ‹Ÿå® ç‰©æ’ä»¶æ ·å¼éš”ç¦» - å®Œå…¨å®‰å…¨ç‰ˆæœ¬ */

            /* åªå½±å“è™šæ‹Ÿå® ç‰©ç›¸å…³å…ƒç´ ï¼Œä¸ä½¿ç”¨CSSå˜é‡ */
            #${BUTTON_ID} {
                font-family: inherit !important;
                line-height: normal !important;
                box-sizing: border-box !important;
            }

            #${POPUP_ID}, #${OVERLAY_ID} {
                font-family: inherit !important;
                line-height: normal !important;
                box-sizing: border-box !important;
            }

            /* è™šæ‹Ÿå® ç‰©å®¹å™¨æ ·å¼éš”ç¦» */
            .${STYLE_PREFIX}container,
            .${STYLE_PREFIX}container * {
                box-sizing: border-box !important;
            }

            /* ç¡®ä¿è™šæ‹Ÿå® ç‰©å…ƒç´ ä¸è¢«å…¶ä»–æ ·å¼å½±å“ */
            [id*="virtual-pet"],
            [class*="virtual-pet"] {
                font-family: inherit !important;
            }

            /* è™šæ‹Ÿå® ç‰©è¡¨å•å…ƒç´ å®‰å…¨æ ·å¼ */
            #virtual-pet-personality-select,
            #virtual-pet-custom-personality,
            #ai-api-select,
            #ai-url-input,
            #ai-key-input,
            #ai-model-select,
            #ai-model-input {
                background: ${colors.background} !important;
                color: ${colors.text} !important;
                border: 1px solid ${colors.border} !important;
                font-family: inherit !important;
            }
        `;

        $('head').append(`<style id="${styleId}">${isolatedCSS}</style>`);
        console.log(`[${extensionName}] å®‰å…¨æ ·å¼éš”ç¦»å·²åº”ç”¨ï¼Œä½¿ç”¨é¢œè‰²: ${JSON.stringify(colors)}`);
    }

    /**
     * ç´§æ€¥æ¸…é™¤å¯èƒ½å½±å“SillyTavernçš„æ ·å¼
     */
    function emergencyStyleCleanup() {
        console.log(`[${extensionName}] ğŸš¨ æ‰§è¡Œç´§æ€¥æ ·å¼æ¸…ç†...`);

        // ç§»é™¤å¯èƒ½æœ‰é—®é¢˜çš„æ ·å¼
        $(`#${STYLE_PREFIX}isolated-styles`).remove();

        // æ¸…é™¤ä»»ä½•å¯èƒ½å½±å“bodyæˆ–å…¨å±€çš„æ ·å¼
        $('style').each(function() {
            const content = $(this).text();
            if (content.includes('body >') ||
                content.includes('position: relative !important') ||
                content.includes('virtual-pet')) {
                console.log(`[${extensionName}] ç§»é™¤å¯ç–‘æ ·å¼:`, content.substring(0, 100));
                $(this).remove();
            }
        });

        // é‡æ–°åº”ç”¨å®‰å…¨çš„æ ·å¼éš”ç¦»
        createIsolatedStyles();

        console.log(`[${extensionName}] âœ… ç´§æ€¥æ ·å¼æ¸…ç†å®Œæˆ`);
    }

    /**
     * æ£€æŸ¥å¹¶ä¿®å¤CSSå˜é‡æ±¡æŸ“
     */
    function checkAndFixCSSVariables() {
        console.log(`[${extensionName}] ğŸ” æ£€æŸ¥CSSå˜é‡æ±¡æŸ“...`);

        // æ£€æŸ¥æ˜¯å¦æœ‰æ’ä»¶ä¿®æ”¹äº†å…³é”®çš„CSSå˜é‡
        const rootStyle = getComputedStyle(document.documentElement);
        const criticalVars = [
            '--SmartThemeBodyColor',
            '--SmartThemeEmColor',
            '--body-color',
            '--text-color',
            '--border-color'
        ];

        let hasIssues = false;
        criticalVars.forEach(varName => {
            const value = rootStyle.getPropertyValue(varName);
            if (value && (value.includes('virtual-pet') || value.includes('undefined'))) {
                console.log(`âš ï¸ å‘ç°CSSå˜é‡æ±¡æŸ“: ${varName} = ${value}`);
                hasIssues = true;
                // æ¸…é™¤è¢«æ±¡æŸ“çš„å˜é‡
                document.documentElement.style.removeProperty(varName);
            }
        });

        if (hasIssues) {
            console.log(`[${extensionName}] ğŸ§¹ å·²æ¸…ç†CSSå˜é‡æ±¡æŸ“`);
        } else {
            console.log(`[${extensionName}] âœ… CSSå˜é‡æ£€æŸ¥æ­£å¸¸`);
        }

        return !hasIssues;
    }

    // å…¨å±€ç´§æ€¥ä¿®å¤å‡½æ•°
    window.emergencyFixSillyTavernUI = function() {
        console.log('ğŸš¨ ç´§æ€¥ä¿®å¤SillyTavern UI...');

        // 1. æ£€æŸ¥å¹¶ä¿®å¤CSSå˜é‡æ±¡æŸ“
        checkAndFixCSSVariables();

        // 2. ç§»é™¤æ‰€æœ‰è™šæ‹Ÿå® ç‰©ç›¸å…³æ ·å¼
        $('style').each(function() {
            const content = $(this).text();
            if (content.includes('virtual-pet') ||
                content.includes('body >') ||
                content.includes('position: relative !important') ||
                content.includes(':root')) {
                console.log('ç§»é™¤æ ·å¼:', $(this).attr('id') || 'åŒ¿åæ ·å¼');
                $(this).remove();
            }
        });

        // 3. é‡ç½®bodyæ ·å¼
        $('body').removeAttr('style');
        $('body').css({
            'position': '',
            'overflow': '',
            'display': '',
            'visibility': ''
        });

        // 4. é‡ç½®htmlæ ·å¼
        $('html').removeAttr('style');
        $('html').css({
            'position': '',
            'overflow': '',
            'display': '',
            'visibility': ''
        });

        // 5. æ¸…é™¤document.documentElementä¸Šçš„æ ·å¼
        const docStyle = document.documentElement.style;
        for (let i = docStyle.length - 1; i >= 0; i--) {
            const prop = docStyle[i];
            if (prop.includes('virtual-pet') || prop.startsWith('--')) {
                docStyle.removeProperty(prop);
            }
        }

        // 6. ç§»é™¤è™šæ‹Ÿå® ç‰©å…ƒç´ 
        $('[id*="virtual-pet"]').remove();
        $('[class*="virtual-pet"]').remove();

        // 7. å¼ºåˆ¶åˆ·æ–°é¡µé¢å¸ƒå±€
        $('body').hide().show();

        console.log('âœ… ç´§æ€¥ä¿®å¤å®Œæˆï¼è¯·åˆ·æ–°é¡µé¢ä»¥å®Œå…¨æ¢å¤ã€‚');
        alert('ğŸš¨ ç´§æ€¥ä¿®å¤å®Œæˆï¼\n\nè¯·æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°é¡µé¢ä»¥å®Œå…¨æ¢å¤SillyTavernç•Œé¢ã€‚\n\nå¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·ç¦ç”¨è™šæ‹Ÿå® ç‰©æ’ä»¶ã€‚');

        return true;
    };

    // ç«‹å³æ‰§è¡Œç´§æ€¥æ¸…ç†ï¼ˆå¦‚æœæ£€æµ‹åˆ°é—®é¢˜ï¼‰
    setTimeout(() => {
        if ($('body').children().length === 0 ||
            $('body').css('display') === 'none' ||
            $('#send_textarea').length === 0) {
            console.log(`[${extensionName}] ğŸš¨ æ£€æµ‹åˆ°SillyTavern UIé—®é¢˜ï¼Œæ‰§è¡Œç´§æ€¥ä¿®å¤...`);
            window.emergencyFixSillyTavernUI();
        }
    }, 1000);

    /**
     * å®‰å…¨çš„SillyTavernè®¾ç½®ä¿å­˜å‡½æ•°
     */
    function safeSillyTavernSave() {
        const now = Date.now();
        if (now - lastSyncSaveTime < SYNC_SAVE_COOLDOWN) {
            console.log(`[${extensionName}] åŒæ­¥ä¿å­˜å†·å´ä¸­ï¼Œè·³è¿‡æ­¤æ¬¡ä¿å­˜`);
            return false;
        }

        try {
            if (typeof window.saveSettingsDebounced === 'function' &&
                typeof window.extension_settings === 'object' &&
                window.extension_settings !== null) {

                window.saveSettingsDebounced();
                lastSyncSaveTime = now;
                return true;
            }
        } catch (error) {
            console.warn(`[${extensionName}] SillyTavernä¿å­˜å¤±è´¥:`, error);
        }
        return false;
    }

    // æ‹“éº»æ­Œå­é£æ ¼é…è‰²æ–¹æ¡ˆ
    const candyColors = {
        // ä¸»è‰²è°ƒ - ç»å…¸æ‹“éº»æ­Œå­é£æ ¼
        primary: '#000000',      // é»‘è‰²ä¸»è‰²
        secondary: '#333333',    // æ·±ç°
        accent: '#666666',       // ä¸­ç°
        warning: '#FF8000',      // æ©™è‰²è­¦å‘Š
        success: '#008000',      // ç»¿è‰²æˆåŠŸ

        // èƒŒæ™¯è‰² - ç³–æœè‰²æ¸å˜
        background: 'linear-gradient(135deg, #FFE5F1 0%, #E5F9F0 50%, #E5F4FF 100%)', // ç³–æœæ¸å˜
        backgroundSolid: '#FFF8FC', // çº¯è‰²èƒŒæ™¯å¤‡é€‰
        screen: '#FFE5F1',       // ç³–æœç²‰å±å¹•
        screenDark: '#E5F9F0',   // è–„è·ç»¿å±å¹•

        // æ–‡å­—è‰² - ç³–æœè‰²é€‚é…
        textPrimary: '#2D3748',   // æ·±ç°è‰²æ–‡å­—
        textSecondary: '#4A5568', // ä¸­ç°è‰²æ–‡å­—
        textLight: '#718096',     // æµ…ç°è‰²æ–‡å­—
        textWhite: '#FFFFFF',     // ç™½è‰²æ–‡å­—

        // è¾¹æ¡†å’Œé˜´å½± - æŸ”å’Œé£æ ¼
        border: '#E2E8F0',       // æµ…è¾¹æ¡†
        borderAccent: '#FF9EC7', // å¼ºè°ƒè¾¹æ¡†
        shadow: 'rgba(255, 158, 199, 0.2)', // ç²‰è‰²é˜´å½±
        shadowLight: 'rgba(255, 158, 199, 0.1)', // æµ…ç²‰è‰²é˜´å½±

        // æŒ‰é’®è‰² - ç³–æœè‰²é£æ ¼
        buttonPrimary: '#FF9EC7',
        buttonSecondary: '#A8E6CF',
        buttonAccent: '#87CEEB',
        buttonHover: '#FF7FB3',

        // çŠ¶æ€æ è‰² - ç³–æœè‰²é£æ ¼
        health: '#FF6B9D',       // å¥åº· - ç³–æœç²‰
        happiness: '#FFD93D',    // å¿«ä¹ - æŸ æª¬é»„
        hunger: '#FF9F43',       // é¥±é£Ÿ - èœœæ¡ƒæ©™
        energy: '#74B9FF',       // ç²¾åŠ› - å¤©ç©ºè“
        experience: '#A29BFE',   // ç»éªŒ - è–°è¡£è‰ç´«

        // é¢å¤–æŒ‰é’®è‰²
        info: '#17A2B8'          // ä¿¡æ¯è“ - ç”¨äºèŠå¤©æŒ‰é’®
    };
    
    // å® ç‰©æ•°æ®ç»“æ„ - æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿ
    let petData = {
        name: "å°å® ç‰©",
        type: "cat", // cat, dog, dragon, etc.
        level: 1,
        experience: 0,
        health: 35,      // åˆå§‹å€¼ï¼Œé¦–æ¬¡æ‰“å¼€ä¼šéšæœºåŒ–åˆ°50ä»¥ä¸‹
        happiness: 30,   // åˆå§‹å€¼ï¼Œé¦–æ¬¡æ‰“å¼€ä¼šéšæœºåŒ–åˆ°50ä»¥ä¸‹
        hunger: 40,      // åˆå§‹å€¼ï¼Œé¦–æ¬¡æ‰“å¼€ä¼šéšæœºåŒ–åˆ°50ä»¥ä¸‹
        energy: 45,      // åˆå§‹å€¼ï¼Œé¦–æ¬¡æ‰“å¼€ä¼šéšæœºåŒ–åˆ°50ä»¥ä¸‹

        // æ‹“éº»æ­Œå­å¼ç”Ÿå‘½çŠ¶æ€
        lifeStage: "baby",    // baby, child, teen, adult, senior
        age: 0,               // å¹´é¾„ï¼ˆå°æ—¶ï¼‰
        isAlive: true,        // æ˜¯å¦å­˜æ´»
        deathReason: null,    // æ­»äº¡åŸå› 

        // æ‹“éº»æ­Œå­å¼æŠ¤ç†çŠ¶æ€
        sickness: 0,          // ç–¾ç—…ç¨‹åº¦ 0-100
        discipline: 50,       // çºªå¾‹å€¼ 0-100
        weight: 30,           // ä½“é‡

        // æ—¶é—´è®°å½•
        lastFeedTime: Date.now(),
        lastPlayTime: Date.now(),
        lastSleepTime: Date.now(),
        lastUpdateTime: Date.now(),
        lastCareTime: Date.now(),     // æœ€åç…§é¡¾æ—¶é—´
        created: Date.now(),

        // æ‹“éº»æ­Œå­å¼è®¡æ•°å™¨
        careNeglectCount: 0,          // å¿½è§†ç…§é¡¾æ¬¡æ•°
        sicknessDuration: 0,          // ç”Ÿç—…æŒç»­æ—¶é—´

        // å•†åº—ç³»ç»Ÿ
        coins: 100,                   // é‡‘å¸
        inventory: {},                // ç‰©å“åº“å­˜

        // AIäººè®¾ç³»ç»Ÿ
        personality: '',              // å½“å‰äººè®¾å†…å®¹

        dataVersion: 4.0 // æ•°æ®ç‰ˆæœ¬æ ‡è®° - å‡çº§åˆ°4.0è¡¨ç¤ºæ‹“éº»æ­Œå­ç³»ç»Ÿ
    };

    // -----------------------------------------------------------------
    // 2. Firebase äº‘ç«¯å¤‡ä»½ç³»ç»Ÿ
    // -----------------------------------------------------------------

    /**
     * åˆå§‹åŒ–FirebaseæœåŠ¡
     */
    async function initializeFirebase() {
        try {
            console.log(`[${extensionName}] ğŸ”¥ åˆå§‹åŒ–FirebaseæœåŠ¡...`);

            // æ£€æŸ¥Firebase SDKæ˜¯å¦å·²åŠ è½½
            if (typeof firebase === 'undefined') {
                console.log(`[${extensionName}] ğŸ“¦ åŠ è½½Firebase SDK...`);
                await loadFirebaseSDK();
            }

            // åˆå§‹åŒ–Firebaseåº”ç”¨
            if (!firebaseApp) {
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.firestore();
                firebaseStorage = firebase.storage();

                // åˆå§‹åŒ–Analytics (å¯é€‰)
                try {
                    if (firebase.analytics && FIREBASE_CONFIG.measurementId) {
                        firebase.analytics();
                        console.log(`[${extensionName}] ğŸ“Š Firebase Analyticså·²å¯ç”¨`);
                    }
                } catch (analyticsError) {
                    console.warn(`[${extensionName}] âš ï¸ Firebase Analyticsåˆå§‹åŒ–å¤±è´¥:`, analyticsError);
                }

                console.log(`[${extensionName}] âœ… Firebaseåº”ç”¨åˆå§‹åŒ–æˆåŠŸ`);
            }

            // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬å™¨
            firebaseAuth.onAuthStateChanged((user) => {
                currentUser = user;
                updateFirebaseStatus('auth_changed'); // Use a specific status to trigger UI update

                if (user) {
                    console.log(`[${extensionName}] ğŸ‘¤ ç”¨æˆ·å·²ç™»å½•: ${user.uid}`);
                } else {
                    console.log(`[${extensionName}] ğŸ‘¤ ç”¨æˆ·æœªç™»å½•`);
                }
            });

            isFirebaseInitialized = true;
            updateFirebaseStatus('auth_changed'); // Initial check

            return true;
        } catch (error) {
            console.error(`[${extensionName}] âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:`, error);
            updateFirebaseStatus('error', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            return false;
        }
    }

    /**
     * åŠ¨æ€åŠ è½½Firebase SDK
     */
    async function loadFirebaseSDK() {
        return new Promise((resolve, reject) => {
            // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½äº†Firebase
            if (typeof firebase !== 'undefined') {
                console.log(`[${extensionName}] ğŸ“¦ Firebase SDKå·²å­˜åœ¨`);
                resolve();
                return;
            }

            // Firebaseæ ¸å¿ƒSDK (ä½¿ç”¨compatç‰ˆæœ¬ä»¥ä¿æŒå…¼å®¹æ€§)
            const coreScript = document.createElement('script');
            coreScript.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
            coreScript.onload = () => {
                // Firebaseè®¤è¯SDK
                const authScript = document.createElement('script');
                authScript.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js';
                authScript.onload = () => {
                    // Firebase Firestore SDK
                    const firestoreScript = document.createElement('script');
                    firestoreScript.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js';
                    firestoreScript.onload = () => {
                        // Firebase Storage SDK
                        const storageScript = document.createElement('script');
                        storageScript.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js';
                        storageScript.onload = () => {
                            // Firebase Analytics SDK (å¯é€‰)
                            const analyticsScript = document.createElement('script');
                            analyticsScript.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js';
                            analyticsScript.onload = () => {
                                console.log(`[${extensionName}] ğŸ“¦ Firebase SDKåŠ è½½å®Œæˆ`);
                                resolve();
                            };
                            analyticsScript.onerror = () => {
                                console.warn(`[${extensionName}] âš ï¸ Firebase AnalyticsåŠ è½½å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨å…¶ä»–åŠŸèƒ½`);
                                resolve(); // Analyticså¤±è´¥ä¸å½±å“å…¶ä»–åŠŸèƒ½
                            };
                            document.head.appendChild(analyticsScript);
                        };
                        storageScript.onerror = reject;
                        document.head.appendChild(storageScript);
                    };
                    firestoreScript.onerror = reject;
                    document.head.appendChild(firestoreScript);
                };
                authScript.onerror = reject;
                document.head.appendChild(authScript);
            };
            coreScript.onerror = reject;
            document.head.appendChild(coreScript);
        });
    }

    /**
     * åŒ¿åç™»å½•Firebase
     */
    async function signInAnonymously() {
        try {
            if (!isFirebaseInitialized) {
                throw new Error('Firebaseæœªåˆå§‹åŒ–');
            }

            console.log(`[${extensionName}] ğŸ” æ‰§è¡ŒåŒ¿åç™»å½•...`);
            updateFirebaseStatus('connecting', 'æ­£åœ¨ç™»å½•...');

            const userCredential = await firebaseAuth.signInAnonymously();
            currentUser = userCredential.user;

            console.log(`[${extensionName}] âœ… åŒ¿åç™»å½•æˆåŠŸ: ${currentUser.uid}`);

            // åˆ›å»ºç”¨æˆ·é…ç½®æ–‡æ¡£
            await createUserProfile();

            updateFirebaseStatus('connected', 'å·²è¿æ¥');
            return currentUser;
        } catch (error) {
            console.error(`[${extensionName}] âŒ åŒ¿åç™»å½•å¤±è´¥:`, error);
            updateFirebaseStatus('error', `ç™»å½•å¤±è´¥: ${error.message}`);
            throw error;
        }
    }

    /**
     * åˆ›å»ºç”¨æˆ·é…ç½®æ–‡æ¡£
     */
    async function createUserProfile() {
        try {
            if (!currentUser) return;

            const userDoc = firebaseDb.collection('users').doc(currentUser.uid);
            const docSnapshot = await userDoc.get();

            if (!docSnapshot.exists) {
                const userProfile = {
                    uid: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceName: getDeviceName(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    dataVersion: '1.0'
                };

                await userDoc.set(userProfile);
                console.log(`[${extensionName}] ğŸ‘¤ ç”¨æˆ·é…ç½®æ–‡æ¡£å·²åˆ›å»º`);
            } else {
                // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
                await userDoc.update({
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceName: getDeviceName()
                });
                console.log(`[${extensionName}] ğŸ‘¤ ç”¨æˆ·é…ç½®æ–‡æ¡£å·²æ›´æ–°`);
            }
        } catch (error) {
            console.error(`[${extensionName}] âŒ åˆ›å»ºç”¨æˆ·é…ç½®å¤±è´¥:`, error);
        }
    }

    /**
     * è·å–è®¾å¤‡åç§°
     */
    function getDeviceName() {
        const userAgent = navigator.userAgent;
        if (/iPad|iPhone|iPod/.test(userAgent)) {
            return 'iOSè®¾å¤‡';
        } else if (/Android/.test(userAgent)) {
            return 'Androidè®¾å¤‡';
        } else if (/Windows/.test(userAgent)) {
            return 'Windowsç”µè„‘';
        } else if (/Mac/.test(userAgent)) {
            return 'Macç”µè„‘';
        } else {
            return 'æœªçŸ¥è®¾å¤‡';
        }
    }

    /**
     * ç”Ÿæˆè®¾å¤‡è¿æ¥ç 
     */
    async function generateConnectionCode() {
        try {
            if (!currentUser) {
                throw new Error('ç”¨æˆ·æœªç™»å½•');
            }

            console.log(`[${extensionName}] ğŸ”‘ ç”Ÿæˆè¿æ¥ç ...`);

            // ç”Ÿæˆ6ä½éšæœºè¿æ¥ç 
            const code = generateRandomCode();
            const expiry = Date.now() + (5 * 60 * 1000); // 5åˆ†é’Ÿåè¿‡æœŸ

            // ä¿å­˜è¿æ¥ç åˆ°Firestore
            const codeDoc = firebaseDb.collection('connectionCodes').doc(code);
            await codeDoc.set({
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(expiry),
                used: false
            });

            connectionCode = code;
            connectionCodeExpiry = expiry;

            console.log(`[${extensionName}] âœ… è¿æ¥ç ç”ŸæˆæˆåŠŸ: ${code}`);

            // 5åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†è¿‡æœŸè¿æ¥ç 
            setTimeout(() => {
                cleanupExpiredCode(code);
            }, 5 * 60 * 1000);

            return code;
        } catch (error) {
            console.error(`[${extensionName}] âŒ ç”Ÿæˆè¿æ¥ç å¤±è´¥:`, error);
            throw error;
        }
    }

    /**
     * ç”Ÿæˆéšæœºè¿æ¥ç 
     */
    function generateRandomCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    /**
     * æ¸…ç†è¿‡æœŸè¿æ¥ç 
     */
    async function cleanupExpiredCode(code) {
        try {
            const codeDoc = firebaseDb.collection('connectionCodes').doc(code);
            await codeDoc.delete();
            console.log(`[${extensionName}] ğŸ§¹ å·²æ¸…ç†è¿‡æœŸè¿æ¥ç : ${code}`);
        } catch (error) {
            console.error(`[${extensionName}] âŒ æ¸…ç†è¿æ¥ç å¤±è´¥:`, error);
        }
    }

    /**
     * ä½¿ç”¨è¿æ¥ç è¿æ¥åˆ°ä¸»è®¾å¤‡
     */
    async function connectWithCode(code) {
        try {
            if (!isFirebaseInitialized) {
                throw new Error('Firebaseæœªåˆå§‹åŒ–');
            }

            console.log(`[${extensionName}] ğŸ”— å°è¯•è¿æ¥ç : ${code}`);

            // æŸ¥æ‰¾è¿æ¥ç 
            const codeDoc = firebaseDb.collection('connectionCodes').doc(code.toUpperCase());
            const docSnapshot = await codeDoc.get();

            if (!docSnapshot.exists) {
                throw new Error('è¿æ¥ç ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
            }

            const codeData = docSnapshot.data();

            // æ£€æŸ¥è¿æ¥ç æ˜¯å¦è¿‡æœŸ
            if (codeData.expiresAt.toDate() < new Date()) {
                await codeDoc.delete();
                throw new Error('è¿æ¥ç å·²è¿‡æœŸ');
            }

            // æ£€æŸ¥è¿æ¥ç æ˜¯å¦å·²ä½¿ç”¨
            if (codeData.used) {
                throw new Error('è¿æ¥ç å·²è¢«ä½¿ç”¨');
            }

            // åŒ¿åç™»å½•
            await signInAnonymously();

            // é‡‡ç”¨ä¸»è®¾å¤‡çš„ç”¨æˆ·ID
            const primaryUserId = codeData.userId;

            // æ ‡è®°è¿æ¥ç ä¸ºå·²ä½¿ç”¨
            await codeDoc.update({
                used: true,
                usedAt: firebase.firestore.FieldValue.serverTimestamp(),
                secondaryUserId: currentUser.uid
            });

            // ä»ä¸»è®¾å¤‡åŒæ­¥æ•°æ®
            await syncDataFromPrimary(primaryUserId);

            console.log(`[${extensionName}] âœ… è¿æ¥æˆåŠŸï¼Œæ•°æ®å·²åŒæ­¥`);

            return true;
        } catch (error) {
            console.error(`[${extensionName}] âŒ è¿æ¥å¤±è´¥:`, error);
            throw error;
        }
    }

    /**
     * ä»ä¸»è®¾å¤‡åŒæ­¥æ•°æ®
     */
    async function syncDataFromPrimary(primaryUserId) {
        try {
            console.log(`[${extensionName}] ğŸ“¥ ä»ä¸»è®¾å¤‡åŒæ­¥æ•°æ®...`);

            const userDoc = firebaseDb.collection('users').doc(primaryUserId);
            const docSnapshot = await userDoc.get();

            if (!docSnapshot.exists) {
                throw new Error('ä¸»è®¾å¤‡æ•°æ®ä¸å­˜åœ¨');
            }

            const userData = docSnapshot.data();

            // åŒæ­¥å® ç‰©æ•°æ®
            if (userData.petData) {
                petData = { ...petData, ...userData.petData };
                savePetData();
                console.log(`[${extensionName}] âœ… å® ç‰©æ•°æ®å·²åŒæ­¥`);
            }

            // åŒæ­¥AIè®¾ç½®
            if (userData.aiSettings) {
                localStorage.setItem(`${extensionName}-ai-settings`, JSON.stringify(userData.aiSettings));
                console.log(`[${extensionName}] âœ… AIè®¾ç½®å·²åŒæ­¥`);
            }

            // åŒæ­¥å¤´åƒ (ä¼˜å…ˆä½¿ç”¨avatarUrl)
            if (userData.avatarUrl) {
                customAvatarData = userData.avatarUrl;
                localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, userData.avatarUrl);
                console.log(`[${extensionName}] âœ… å¤´åƒURLå·²åŒæ­¥`);
            } else if (userData.avatar) { // å…¼å®¹æ—§æ•°æ®
                customAvatarData = userData.avatar;
                localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, userData.avatar);
                console.log(`[${extensionName}] âœ… æ—§ç‰ˆå¤´åƒæ•°æ®å·²åŒæ­¥`);
            }

            // æ›´æ–°UI
            renderPetStatus();
            loadAISettings();
            loadCustomAvatar();

            toastr.success('æ‰€æœ‰æ•°æ®å·²ä»ä¸»è®¾å¤‡åŒæ­¥å®Œæˆï¼', 'ğŸ‰ åŒæ­¥æˆåŠŸ');

        } catch (error) {
            console.error(`[${extensionName}] âŒ æ•°æ®åŒæ­¥å¤±è´¥:`, error);
            throw error;
        }
    }

    /**
     * ä¸Šä¼ å¤´åƒåˆ°Firebase Storageå¹¶è¿”å›URL
     * @param {string} dataUrl base64æ•°æ®URL
     * @returns {Promise<string>} å¤´åƒçš„å…¬å¼€URL
     */
    async function uploadAvatarToStorage(dataUrl) {
        if (!currentUser || !firebaseStorage) {
            throw new Error('Firebase Storageæœªåˆå§‹åŒ–æˆ–ç”¨æˆ·æœªç™»å½•');
        }
        console.log(`[${extensionName}] â˜ï¸ ä¸Šä¼ å¤´åƒåˆ°Firebase Storage...`);

        const storageRef = firebaseStorage.ref().child(`avatars/${currentUser.uid}/avatar.png`);

        try {
            // Firebase Storageçš„putStringæ–¹æ³•å¯ä»¥ç›´æ¥å¤„ç†data_url
            const uploadTask = await storageRef.putString(dataUrl, 'data_url');
            const downloadURL = await uploadTask.ref.getDownloadURL();
            
            console.log(`[${extensionName}] âœ… å¤´åƒä¸Šä¼ æˆåŠŸï¼ŒURL: ${downloadURL}`);
            return downloadURL;
        } catch (error) {
            console.error(`[${extensionName}] âŒ å¤´åƒä¸Šä¼ å¤±è´¥:`, error);
            throw new Error(`å¤´åƒä¸Šä¼ å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * å¤‡ä»½æ‰€æœ‰æ•°æ®åˆ°Firebase
     */
    async function backupAllDataToFirebase() {
        try {
            if (!currentUser) {
                throw new Error('ç”¨æˆ·æœªç™»å½•');
            }

            console.log(`[${extensionName}] â˜ï¸ å¤‡ä»½æ‰€æœ‰æ•°æ®åˆ°Firebase...`);

            const userDoc = firebaseDb.collection('users').doc(currentUser.uid);

            // å‡†å¤‡å¤‡ä»½æ•°æ®
            const backupData = {
                lastBackup: firebase.firestore.FieldValue.serverTimestamp(),
                deviceName: getDeviceName(),
                dataVersion: '1.1' // ç‰ˆæœ¬å‡çº§ï¼Œè¡¨ç¤ºä½¿ç”¨Storage
            };

            // å¤‡ä»½å® ç‰©æ•°æ®
            if (petData) {
                backupData.petData = {
                    ...petData,
                    lastSyncTime: Date.now()
                };
            }

            // å¤‡ä»½AIè®¾ç½®
            const aiSettings = localStorage.getItem(`${extensionName}-ai-settings`);
            if (aiSettings) {
                try {
                    backupData.aiSettings = JSON.parse(aiSettings);
                } catch (e) {
                    console.warn(`[${extensionName}] AIè®¾ç½®è§£æå¤±è´¥ï¼Œè·³è¿‡å¤‡ä»½`);
                }
            }

            // å¤‡ä»½å¤´åƒåˆ°Firebase Storage
            if (customAvatarData) {
                // å¦‚æœæ˜¯base64æ•°æ®, åˆ™ä¸Šä¼ å¹¶è·å–URL
                if (customAvatarData.startsWith('data:image')) {
                    try {
                        const avatarUrl = await uploadAvatarToStorage(customAvatarData);
                        backupData.avatarUrl = avatarUrl;
                        // ä¸Šä¼ æˆåŠŸåï¼Œå¯ä»¥æ›´æ–°æœ¬åœ°å­˜å‚¨ä¸ºURLï¼Œå‡å°‘æœªæ¥é‡å¤ä¸Šä¼ 
                        localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, avatarUrl);
                        customAvatarData = avatarUrl;
                    } catch (uploadError) {
                        console.error(`[${extensionName}] âŒ å¤´åƒå¤‡ä»½å¤±è´¥ï¼Œè·³è¿‡å¤´åƒå¤‡ä»½:`, uploadError);
                        toastr.warning('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œæœ¬æ¬¡å¤‡ä»½å°†ä¸åŒ…å«å¤´åƒã€‚', 'âš ï¸ å¤‡ä»½è­¦å‘Š');
                    }
                } else if (customAvatarData.startsWith('http')) {
                    // å¦‚æœå·²ç»æ˜¯URLï¼Œç›´æ¥ä¿å­˜
                    backupData.avatarUrl = customAvatarData;
                }
            }

            // æ‰§è¡Œå¤‡ä»½
            await userDoc.set(backupData, { merge: true });

            console.log(`[${extensionName}] âœ… æ•°æ®å¤‡ä»½å®Œæˆ`);
            toastr.success('æ‰€æœ‰æ•°æ®å·²å¤‡ä»½åˆ°äº‘ç«¯ï¼', 'â˜ï¸ å¤‡ä»½æˆåŠŸ');

            return true;
        } catch (error) {
            console.error(`[${extensionName}] âŒ æ•°æ®å¤‡ä»½å¤±è´¥:`, error);
            toastr.error(`å¤‡ä»½å¤±è´¥: ${error.message}`, 'âŒ å¤‡ä»½å¤±è´¥');
            throw error;
        }
    }

    /**
     * ä»Firebaseæ¢å¤æ•°æ®
     */
    async function restoreDataFromFirebase() {
        try {
            if (!currentUser) {
                throw new Error('ç”¨æˆ·æœªç™»å½•');
            }

            console.log(`[${extensionName}] ğŸ“¥ ä»Firebaseæ¢å¤æ•°æ®...`);

            const userDoc = firebaseDb.collection('users').doc(currentUser.uid);
            const docSnapshot = await userDoc.get();

            if (!docSnapshot.exists) {
                throw new Error('äº‘ç«¯æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ•°æ®');
            }

            const userData = docSnapshot.data();
            let restoredCount = 0;

            // æ¢å¤å® ç‰©æ•°æ®
            if (userData.petData) {
                petData = { ...petData, ...userData.petData };
                savePetData();
                restoredCount++;
                console.log(`[${extensionName}] âœ… å® ç‰©æ•°æ®å·²æ¢å¤`);
            }

            // æ¢å¤AIè®¾ç½®
            if (userData.aiSettings) {
                localStorage.setItem(`${extensionName}-ai-settings`, JSON.stringify(userData.aiSettings));
                restoredCount++;
                console.log(`[${extensionName}] âœ… AIè®¾ç½®å·²æ¢å¤`);
            }

            // æ¢å¤å¤´åƒ (ä¼˜å…ˆä½¿ç”¨avatarUrl)
            if (userData.avatarUrl) {
                customAvatarData = userData.avatarUrl;
                localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, userData.avatarUrl);
                restoredCount++;
                console.log(`[${extensionName}] âœ… å¤´åƒURLå·²æ¢å¤`);
            } else if (userData.avatar) { // å…¼å®¹æ—§æ•°æ®
                customAvatarData = userData.avatar;
                localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, userData.avatar);
                restoredCount++;
                console.log(`[${extensionName}] âœ… æ—§ç‰ˆå¤´åƒæ•°æ®å·²æ¢å¤`);
            }

            // æ›´æ–°UI
            renderPetStatus();
            loadAISettings();
            loadCustomAvatar();
            updateAvatarDisplay();
            updateFloatingButtonAvatar();

            const lastBackup = userData.lastBackup ? userData.lastBackup.toDate().toLocaleString() : 'æœªçŸ¥';
            toastr.success(`å·²æ¢å¤ ${restoredCount} é¡¹æ•°æ®\næœ€åå¤‡ä»½æ—¶é—´: ${lastBackup}`, 'ğŸ“¥ æ¢å¤æˆåŠŸ', { timeOut: 5000 });

            return restoredCount;
        } catch (error) {
            console.error(`[${extensionName}] âŒ æ•°æ®æ¢å¤å¤±è´¥:`, error);
            toastr.error(`æ¢å¤å¤±è´¥: ${error.message}`, 'âŒ æ¢å¤å¤±è´¥');
            throw error;
        }
    }

    /**
     * æ£€æŸ¥FirebaseåŒæ­¥çŠ¶æ€
     */
    async function checkFirebaseSyncStatus() {
        try {
            if (!currentUser) {
                return {
                    connected: false,
                    message: 'æœªè¿æ¥åˆ°äº‘ç«¯'
                };
            }

            const userDoc = firebaseDb.collection('users').doc(currentUser.uid);
            const docSnapshot = await userDoc.get();

            if (!docSnapshot.exists) {
                return {
                    connected: true,
                    hasBackup: false,
                    message: 'å·²è¿æ¥ï¼Œä½†æ²¡æœ‰å¤‡ä»½æ•°æ®'
                };
            }

            const userData = docSnapshot.data();
            const lastBackup = userData.lastBackup ? userData.lastBackup.toDate() : null;

            return {
                connected: true,
                hasBackup: true,
                lastBackup: lastBackup,
                hasPetData: !!userData.petData,
                hasAISettings: !!userData.aiSettings,
                hasAvatar: !!userData.avatar,
                deviceName: userData.deviceName,
                message: lastBackup ? `æœ€åå¤‡ä»½: ${lastBackup.toLocaleString()}` : 'æœ‰å¤‡ä»½æ•°æ®'
            };
        } catch (error) {
            console.error(`[${extensionName}] âŒ æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥:`, error);
            return {
                connected: false,
                error: true,
                message: `æ£€æŸ¥å¤±è´¥: ${error.message}`
            };
        }
    }

    /**
     * æ–­å¼€Firebaseè¿æ¥
     */
    async function disconnectFirebase() {
        try {
            if (currentUser) {
                await firebaseAuth.signOut();
                console.log(`[${extensionName}] ğŸ‘‹ å·²æ–­å¼€Firebaseè¿æ¥`);
            }

            currentUser = null;
            connectionCode = null;
            connectionCodeExpiry = null;

            updateFirebaseStatus('disconnected', 'å·²æ–­å¼€è¿æ¥');
            toastr.info('å·²æ–­å¼€äº‘ç«¯è¿æ¥', 'ğŸ”Œ æ–­å¼€è¿æ¥');

            return true;
        } catch (error) {
            console.error(`[${extensionName}] âŒ æ–­å¼€è¿æ¥å¤±è´¥:`, error);
            throw error;
        }
    }

    /**
     * æ›´æ–°FirebaseçŠ¶æ€æ˜¾ç¤ºï¼ˆç®€åŒ–ç‰ˆï¼‰
     */
    function updateFirebaseStatus(status = 'disconnected', message = '') {
        const statusIcon = $('#firebase-status-icon');
        const statusText = $('#firebase-status-text');
        const primaryControls = $('#firebase-primary-controls');
        const secondaryControls = $('#firebase-secondary-controls');
        const managementControls = $('#firebase-management-controls');
        const initBtn = $('#firebase-init-btn');

        switch (status) {
            case 'connected':
                statusIcon.text('ğŸŸ¢');
                statusText.text(message || 'å·²è¿æ¥');
                initBtn.text('âœ… å·²è¿æ¥').prop('disabled', true);
                primaryControls.show();
                // è¿æ¥æˆåŠŸåä»ç„¶æ˜¾ç¤ºä»è®¾å¤‡è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿å…¶ä»–è®¾å¤‡è¿æ¥
                secondaryControls.show();
                managementControls.show();
                break;

            case 'connecting':
                statusIcon.text('ğŸŸ¡');
                statusText.text(message || 'è¿æ¥ä¸­...');
                initBtn.text('ğŸ”„ è¿æ¥ä¸­...').prop('disabled', true);
                break;

            case 'error':
                statusIcon.text('ğŸ”´');
                statusText.text(message || 'è¿æ¥é”™è¯¯');
                initBtn.text('âŒ é‡è¯•').prop('disabled', false);
                primaryControls.hide();
                managementControls.hide();
                secondaryControls.show();
                break;

            default: // disconnected
                statusIcon.text('âšª');
                statusText.text(message || 'æœªè¿æ¥');
                initBtn.text('ğŸ”— è¿æ¥').prop('disabled', false);
                primaryControls.hide();
                managementControls.hide();
                secondaryControls.show();
                break;
        }
    }

    /**
     * ç»‘å®šFirebase UIäº‹ä»¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
     */
    function bindFirebaseEvents() {
        // åˆå§‹åŒ–è¿æ¥æŒ‰é’®
        $('#firebase-init-btn').on('click', async function() {
            try {
                updateFirebaseStatus('connecting', 'è¿æ¥ä¸­...');

                await initializeFirebase();
                await signInAnonymously();

                updateFirebaseStatus('connected', 'å·²è¿æ¥');
                toastr.success('äº‘ç«¯å¤‡ä»½å·²è¿æ¥ï¼', 'â˜ï¸ è¿æ¥æˆåŠŸ');

            } catch (error) {
                updateFirebaseStatus('error', 'è¿æ¥å¤±è´¥');
                toastr.error(`è¿æ¥å¤±è´¥: ${error.message}`, 'âŒ è¿æ¥é”™è¯¯');
            }
        });

        // ç”Ÿæˆè¿æ¥ç æŒ‰é’®
        $('#firebase-generate-code-btn').on('click', async function() {
            try {
                const code = await generateConnectionCode();
                $('#firebase-connection-code-text').val(code);
                $('#firebase-connection-code-display').show();
                toastr.success(`è¿æ¥ç å·²ç”Ÿæˆ: ${code}`, 'ğŸ”‘ ç”ŸæˆæˆåŠŸ');
            } catch (error) {
                toastr.error(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'âŒ é”™è¯¯');
            }
        });

        // å¤åˆ¶è¿æ¥ç æŒ‰é’®
        $('#firebase-copy-code-btn').on('click', function() {
            const code = $('#firebase-connection-code-text').val();
            navigator.clipboard.writeText(code).then(() => {
                toastr.success('è¿æ¥ç å·²å¤åˆ¶ï¼', 'ğŸ“‹ å¤åˆ¶æˆåŠŸ');
            }).catch(() => {
                toastr.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'âŒ å¤åˆ¶å¤±è´¥');
            });
        });

        // è¿æ¥åŒæ­¥æŒ‰é’®
        $('#firebase-connect-btn').on('click', async function() {
            const code = $('#firebase-connection-code-input').val().trim().toUpperCase();

            if (!code || code.length !== 6) {
                toastr.warning('è¯·è¾“å…¥6ä½è¿æ¥ç ', 'âš ï¸ è¾“å…¥é”™è¯¯');
                return;
            }

            try {
                updateFirebaseStatus('connecting', 'è¿æ¥ä¸­...');

                if (!isFirebaseInitialized) {
                    await initializeFirebase();
                }

                await connectWithCode(code);
                updateFirebaseStatus('connected', 'å·²è¿æ¥');
                $('#firebase-connection-code-input').val('');
                toastr.success('è®¾å¤‡è¿æ¥æˆåŠŸï¼Œæ•°æ®å·²åŒæ­¥ï¼', 'ğŸ”— è¿æ¥æˆåŠŸ');

            } catch (error) {
                updateFirebaseStatus('error', 'è¿æ¥å¤±è´¥');
                toastr.error(`è¿æ¥å¤±è´¥: ${error.message}`, 'âŒ è¿æ¥é”™è¯¯');
            }
        });

        // ç«‹å³å¤‡ä»½æŒ‰é’®
        $('#firebase-backup-now-btn').on('click', async function() {
            try {
                await backupAllDataToFirebase();
                toastr.success('æ•°æ®å·²å¤‡ä»½åˆ°äº‘ç«¯ï¼', 'â˜ï¸ å¤‡ä»½æˆåŠŸ');
            } catch (error) {
                toastr.error(`å¤‡ä»½å¤±è´¥: ${error.message}`, 'âŒ å¤‡ä»½å¤±è´¥');
            }
        });

        // æ¢å¤æ•°æ®æŒ‰é’®
        $('#firebase-restore-btn').on('click', async function() {
            if (!confirm('ç¡®å®šè¦ä»äº‘ç«¯æ¢å¤æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ï¼')) {
                return;
            }

            try {
                await restoreDataFromFirebase();
                toastr.success('æ•°æ®å·²ä»äº‘ç«¯æ¢å¤ï¼', 'ğŸ“¥ æ¢å¤æˆåŠŸ');
            } catch (error) {
                toastr.error(`æ¢å¤å¤±è´¥: ${error.message}`, 'âŒ æ¢å¤å¤±è´¥');
            }
        });

        // æ–­å¼€è¿æ¥æŒ‰é’®
        $('#firebase-disconnect-btn').on('click', async function() {
            if (!confirm('ç¡®å®šè¦æ–­å¼€äº‘ç«¯è¿æ¥å—ï¼Ÿæ–­å¼€åå°†æ— æ³•åŒæ­¥æ•°æ®ã€‚')) {
                return;
            }

            try {
                await disconnectFirebase();
                updateFirebaseStatus('disconnected', 'å·²æ–­å¼€è¿æ¥');
                $('#firebase-connection-code-display').hide();
                toastr.info('å·²æ–­å¼€äº‘ç«¯è¿æ¥', 'ğŸ”Œ æ–­å¼€è¿æ¥');
            } catch (error) {
                toastr.error(`æ–­å¼€å¤±è´¥: ${error.message}`, 'âŒ é”™è¯¯');
            }
        });

        // è¿æ¥ç è¾“å…¥æ¡†æ ¼å¼åŒ–
        $('#firebase-connection-code-input').on('input', function() {
            let value = $(this).val().toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            $(this).val(value);
        });

        // è¿æ¥ç è¾“å…¥æ¡†å›è½¦é”®
        $('#firebase-connection-code-input').on('keypress', function(e) {
            if (e.which === 13) {
                $('#firebase-connect-btn').click();
            }
        });
    }

    // -----------------------------------------------------------------
    // 7. é¢„è®¾äººè®¾å®šä¹‰
    // -----------------------------------------------------------------

    const PRESET_PERSONALITIES = {
        'default': "ä¸€åªé«˜å†·ä½†å†…å¿ƒæ¸©æŸ”çš„çŒ«ï¼Œå–œæ¬¢è¢«æŠ•å–‚ï¼Œä½†å˜´ä¸Šä¸æ‰¿è®¤ã€‚è¯´è¯æ—¶ç»å¸¸ç”¨'å“¼'å¼€å¤´ï¼Œå¶å°”ä¼šéœ²å‡ºå¯çˆ±çš„ä¸€é¢ã€‚",
        'cheerful': "ä¸€åªæ´»æ³¼å¯çˆ±çš„å°ç‹—ï¼Œæ€»æ˜¯å……æ»¡æ´»åŠ›ï¼Œå–œæ¬¢å’Œä¸»äººç©è€ã€‚è¯´è¯çƒ­æƒ…æ´‹æº¢ï¼Œç»å¸¸ç”¨æ„Ÿå¹å·ï¼Œå–œæ¬¢æ’’å¨‡å–èŒã€‚",
        'elegant': "ä¸€åªä¼˜é›…çš„é¾™ï¼Œè¯´è¯å¤å…¸æ–‡é›…ï¼Œæœ‰ç€é«˜è´µçš„æ°”è´¨ã€‚å–œæ¬¢ç”¨æ–‡è¨€æ–‡æˆ–å¤é£è¯æ±‡ï¼Œä¸¾æ­¢ä¼˜é›…ï¼Œä½†å†…å¿ƒå…¶å®å¾ˆæ¸©æš–ã€‚",
        'shy': "ä¸€åªå®³ç¾çš„å…”å­ï¼Œè¯´è¯è½»å£°ç»†è¯­ï¼Œå®¹æ˜“è„¸çº¢ã€‚æ€§æ ¼æ¸©æŸ”å†…å‘ï¼Œå–œæ¬¢ç”¨'...'å’Œé¢œæ–‡å­—ï¼Œå¶å°”ä¼šç»“å·´ã€‚",
        'smart': "ä¸€åªèªæ˜çš„é¸Ÿï¼Œå–œæ¬¢è¯´ä¿çš®è¯ï¼Œæœ‰æ—¶ä¼šè°ƒçš®æ£è›‹ã€‚è¯´è¯æœºæ™ºå¹½é»˜ï¼Œå–œæ¬¢ç”¨åŒå…³è¯­å’Œå°èªæ˜ï¼Œå¶å°”ä¼šç‚«è€€çŸ¥è¯†ã€‚"
    };



    /**
     * è·å–å½“å‰æœ‰æ•ˆçš„äººè®¾
     * @returns {string} å½“å‰äººè®¾æè¿°
     */
    function getCurrentPersonality() {
        const selectedType = localStorage.getItem(`${extensionName}-personality-type`) || 'default';

        if (selectedType === 'custom') {
            const customPersonality = localStorage.getItem(`${extensionName}-custom-personality`) || '';
            // å¦‚æœè‡ªå®šä¹‰äººè®¾ä¸ºç©ºï¼Œè¿”å›é€šç”¨çš„é»˜è®¤äººè®¾ï¼Œé¿å…åŠ¨ç‰©ç±»å‹æ··æ·†
            if (!customPersonality.trim()) {
                return "ä¸€ä¸ªå¯çˆ±çš„è™šæ‹Ÿå® ç‰©ï¼Œæ€§æ ¼æ¸©å’Œå‹å–„ï¼Œå–œæ¬¢å’Œä¸»äººäº’åŠ¨ã€‚";
            }
            return customPersonality;
        } else {
            return PRESET_PERSONALITIES[selectedType] || PRESET_PERSONALITIES.default;
        }
    }

    /**
     * ä¿å­˜äººè®¾è®¾ç½®
     * @param {string} type äººè®¾ç±»å‹
     * @param {string} customText è‡ªå®šä¹‰äººè®¾æ–‡æœ¬ï¼ˆä»…å½“typeä¸º'custom'æ—¶ä½¿ç”¨ï¼‰
     */
    function savePersonalitySettings(type, customText = '') {
        localStorage.setItem(`${extensionName}-personality-type`, type);
        if (type === 'custom') {
            localStorage.setItem(`${extensionName}-custom-personality`, customText);
        }

        // æ›´æ–°petDataä¸­çš„personalityå­—æ®µ
        petData.personality = getCurrentPersonality();
        savePetData();

        console.log(`[${extensionName}] äººè®¾å·²æ›´æ–°ä¸º: ${type === 'custom' ? 'è‡ªå®šä¹‰' : type}`);
        console.log(`[${extensionName}] äººè®¾å†…å®¹: ${petData.personality}`);
    }

    /**
     * æ¸…ç†æ—§çš„è§’è‰²å¡æ•°æ®
     */
    function cleanupOldCharacterData() {
        // æ£€æŸ¥è‡ªå®šä¹‰äººè®¾æ˜¯å¦åŒ…å«JSONæ ¼å¼çš„è§’è‰²å¡æ•°æ®
        const customPersonality = localStorage.getItem(`${extensionName}-custom-personality`) || '';
        if (customPersonality.trim().startsWith('{')) {
            console.log(`[${extensionName}] æ£€æµ‹åˆ°æ—§çš„JSONæ ¼å¼è§’è‰²å¡æ•°æ®ï¼Œæ­£åœ¨æ¸…ç†...`);
            // æ¸…ç©ºè‡ªå®šä¹‰äººè®¾ï¼Œå›é€€åˆ°é»˜è®¤äººè®¾
            localStorage.removeItem(`${extensionName}-custom-personality`);
            localStorage.setItem(`${extensionName}-personality-type`, 'default');
            toastr.info('æ£€æµ‹åˆ°æ—§çš„è§’è‰²å¡æ•°æ®æ ¼å¼ï¼Œå·²è‡ªåŠ¨æ¸…ç†å¹¶é‡ç½®ä¸ºé»˜è®¤äººè®¾');
        }
    }

    // -----------------------------------------------------------------
    // AI API é…ç½®
    // -----------------------------------------------------------------









    /**
     * ç›´æ¥ä»åç«¯APIè·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨ - å…¨æ–°æ–¹æ³•
     */
    async function getAvailableAPIs() {
        try {
            console.log(`[${extensionName}] ğŸ¯ ç›´æ¥ä»åç«¯APIè·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨...`);
            const availableAPIs = [];

            // æ–¹æ³•1: ç›´æ¥è°ƒç”¨å„å¤§APIæä¾›å•†çš„æ¨¡å‹åˆ—è¡¨ç«¯ç‚¹
            console.log(`[${extensionName}] ğŸŒ å°è¯•ç›´æ¥è°ƒç”¨åç«¯API...`);

            // æ„å»ºAPIæä¾›å•†åˆ—è¡¨ï¼Œä¼˜å…ˆä½¿ç”¨ç”¨æˆ·é…ç½®çš„URL
            const apiProviders = [
                {
                    name: 'OpenAI (ç”¨æˆ·é…ç½®)',
                    type: 'openai',
                    endpoints: [
                        userApiUrls.openai + '/models',
                        userApiUrls.openai.replace('/v1', '') + '/v1/models'  // å¤‡ç”¨æ ¼å¼
                    ],
                    requiresAuth: true,
                    authHeader: 'Authorization',
                    authPrefix: 'Bearer '
                },
                {
                    name: 'OpenAI (å®˜æ–¹)',
                    type: 'openai_official',
                    endpoints: [
                        'https://api.openai.com/v1/models',
                        'https://api.openai.com/v1/engines'
                    ],
                    requiresAuth: true,
                    authHeader: 'Authorization',
                    authPrefix: 'Bearer '
                },
                {
                    name: 'Anthropic Claude',
                    type: 'claude',
                    endpoints: [
                        'https://api.anthropic.com/v1/models'
                    ],
                    requiresAuth: true,
                    authHeader: 'x-api-key',
                    authPrefix: ''
                },
                {
                    name: 'Google AI',
                    type: 'google',
                    endpoints: [
                        'https://generativelanguage.googleapis.com/v1beta/models'
                    ],
                    requiresAuth: true,
                    authHeader: 'Authorization',
                    authPrefix: 'Bearer '
                },
                {
                    name: 'Ollama (æœ¬åœ°)',
                    type: 'ollama',
                    endpoints: [
                        'http://localhost:11434/api/tags',
                        'http://127.0.0.1:11434/api/tags'
                    ],
                    requiresAuth: false
                },
                {
                    name: 'LM Studio (æœ¬åœ°)',
                    type: 'lmstudio',
                    endpoints: [
                        'http://localhost:1234/v1/models',
                        'http://127.0.0.1:1234/v1/models'
                    ],
                    requiresAuth: false
                },
                {
                    name: 'Text Generation WebUI',
                    type: 'textgen',
                    endpoints: [
                        'http://localhost:5000/v1/models',
                        'http://127.0.0.1:5000/v1/models'
                    ],
                    requiresAuth: false
                }
            ];

            // å°è¯•ä»ç”¨æˆ·é…ç½®ä¸­è·å–APIå¯†é’¥å’ŒURL
            const userApiKeys = {
                openai: $('#ai-key-input').val() || localStorage.getItem('openai_api_key'),
                claude: localStorage.getItem('claude_api_key'),
                google: localStorage.getItem('google_api_key')
            };

            const userApiUrls = {
                openai: $('#ai-url-input').val() || 'https://api.openai.com/v1',
                claude: 'https://api.anthropic.com/v1',
                google: 'https://generativelanguage.googleapis.com/v1beta'
            };

            for (const provider of apiProviders) {
                console.log(`[${extensionName}] ğŸ” æ£€æŸ¥ ${provider.name}...`);

                for (const endpoint of provider.endpoints) {
                    try {
                        const headers = {
                            'Content-Type': 'application/json'
                        };

                        // æ·»åŠ è®¤è¯å¤´ï¼ˆå¦‚æœéœ€è¦ä¸”æœ‰å¯†é’¥ï¼‰
                        if (provider.requiresAuth && userApiKeys[provider.type]) {
                            headers[provider.authHeader] = provider.authPrefix + userApiKeys[provider.type];
                            console.log(`[${extensionName}] ğŸ”‘ ä½¿ç”¨APIå¯†é’¥è¿›è¡Œè®¤è¯`);
                        }

                        console.log(`[${extensionName}] ğŸ”— å°è¯•: ${endpoint}`);

                        const response = await fetch(endpoint, {
                            method: 'GET',
                            headers: headers,
                            // æ·»åŠ è¶…æ—¶å’Œé”™è¯¯å¤„ç†
                            signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log(`[${extensionName}] âœ… ${provider.name} æˆåŠŸ:`, data);

                            // è§£æä¸åŒAPIçš„å“åº”æ ¼å¼
                            let models = [];

                            if (provider.type === 'openai') {
                                // OpenAIæ ¼å¼: {data: [{id: "gpt-4", ...}, ...]}
                                models = data.data || data.models || [];
                            } else if (provider.type === 'claude') {
                                // Claudeæ ¼å¼å¯èƒ½ä¸åŒ
                                models = data.models || data.data || [];
                            } else if (provider.type === 'google') {
                                // Google AIæ ¼å¼: {models: [{name: "models/gemini-pro", ...}, ...]}
                                models = data.models || [];
                            } else if (provider.type === 'ollama') {
                                // Ollamaæ ¼å¼: {models: [{name: "llama2", ...}, ...]}
                                models = data.models || [];
                            } else {
                                // é€šç”¨æ ¼å¼å¤„ç†
                                models = data.models || data.data || data.engines || [];
                            }

                            // æ·»åŠ æ£€æµ‹åˆ°çš„æ¨¡å‹
                            models.forEach(model => {
                                let modelName = '';
                                let modelId = '';

                                if (typeof model === 'string') {
                                    modelName = modelId = model;
                                } else if (model.id) {
                                    modelId = model.id;
                                    modelName = model.id;
                                } else if (model.name) {
                                    modelId = model.name;
                                    modelName = model.name.replace('models/', ''); // å¤„ç†Google AIçš„æ ¼å¼
                                }

                                if (modelName) {
                                    availableAPIs.push({
                                        type: provider.type,
                                        name: modelName,
                                        id: modelId,
                                        status: 'available',
                                        source: endpoint,
                                        provider: provider.name,
                                        requiresAuth: provider.requiresAuth,
                                        hasAuth: provider.requiresAuth ? !!userApiKeys[provider.type] : true
                                    });
                                }
                            });

                            // æ‰¾åˆ°å¯ç”¨çš„APIåï¼Œä¸å†å°è¯•è¯¥æä¾›å•†çš„å…¶ä»–ç«¯ç‚¹
                            break;

                        } else if (response.status === 401) {
                            console.log(`[${extensionName}] ğŸ” ${provider.name} éœ€è¦APIå¯†é’¥è®¤è¯`);
                            availableAPIs.push({
                                type: provider.type,
                                name: `${provider.name} (éœ€è¦APIå¯†é’¥)`,
                                status: 'auth_required',
                                source: endpoint,
                                provider: provider.name,
                                requiresAuth: true,
                                hasAuth: false
                            });
                        } else {
                            console.log(`[${extensionName}] âŒ ${endpoint}: HTTP ${response.status}`);
                        }

                    } catch (error) {
                        if (error.name === 'TimeoutError') {
                            console.log(`[${extensionName}] â° ${endpoint} è¶…æ—¶`);
                        } else if (error.message.includes('CORS')) {
                            console.log(`[${extensionName}] ğŸš« ${endpoint} CORSé™åˆ¶`);
                        } else {
                            console.log(`[${extensionName}] âŒ ${endpoint} å¤±è´¥: ${error.message}`);
                        }
                    }
                }
            }

            // æ–¹æ³•2: ä»SillyTavernä¸Šä¸‹æ–‡è·å–å½“å‰é…ç½®ä½œä¸ºè¡¥å……
            console.log(`[${extensionName}] ğŸ“‹ è·å–SillyTavernå½“å‰é…ç½®ä½œä¸ºè¡¥å……...`);
            if (typeof SillyTavern !== 'undefined' && SillyTavern.getContext) {
                try {
                    const context = SillyTavern.getContext();

                    if (context.main_api) {
                        console.log(`[${extensionName}] ğŸ¯ SillyTavernå½“å‰API: ${context.main_api}`);
                        availableAPIs.push({
                            type: context.main_api,
                            name: `${getAPIDisplayName(context.main_api)} (SillyTavernå½“å‰)`,
                            status: context.online_status ? 'connected' : 'configured',
                            source: 'SillyTavern',
                            provider: 'SillyTaverné…ç½®'
                        });
                    }

                    if (context.model) {
                        console.log(`[${extensionName}] ğŸ¤– SillyTavernå½“å‰æ¨¡å‹: ${context.model}`);
                        availableAPIs.push({
                            type: 'current_model',
                            name: context.model,
                            status: 'current',
                            source: 'SillyTavern',
                            provider: 'SillyTavernå½“å‰æ¨¡å‹'
                        });
                    }

                } catch (error) {
                    console.warn(`[${extensionName}] âš ï¸ è·å–SillyTavernä¸Šä¸‹æ–‡å¤±è´¥:`, error);
                }
            }

            // å»é‡å¹¶æ’åº
            const uniqueAPIs = availableAPIs.filter((api, index, self) =>
                index === self.findIndex(a => a.name === api.name && a.type === api.type)
            ).sort((a, b) => {
                // ä¼˜å…ˆæ˜¾ç¤ºæœ‰è®¤è¯çš„API
                if (a.hasAuth !== b.hasAuth) {
                    return b.hasAuth ? 1 : -1;
                }
                // ç„¶åæŒ‰çŠ¶æ€æ’åº
                const statusOrder = { 'current': 0, 'connected': 1, 'available': 2, 'auth_required': 3 };
                const aOrder = statusOrder[a.status] || 4;
                const bOrder = statusOrder[b.status] || 4;
                if (aOrder !== bOrder) {
                    return aOrder - bOrder;
                }
                // æœ€åæŒ‰åç§°æ’åº
                return a.name.localeCompare(b.name);
            });

            console.log(`[${extensionName}] ğŸ‰ æœ€ç»ˆå‘ç° ${uniqueAPIs.length} ä¸ªå¯ç”¨API:`, uniqueAPIs);

            if (uniqueAPIs.length === 0) {
                console.log(`[${extensionName}] âš ï¸ æœªå‘ç°ä»»ä½•APIï¼Œå¯èƒ½çš„åŸå› :`);
                console.log(`[${extensionName}] 1. ç½‘ç»œè¿æ¥é—®é¢˜æˆ–CORSé™åˆ¶`);
                console.log(`[${extensionName}] 2. éœ€è¦é…ç½®APIå¯†é’¥`);
                console.log(`[${extensionName}] 3. æœ¬åœ°APIæœåŠ¡æœªå¯åŠ¨ï¼ˆå¦‚Ollamaã€LM Studioï¼‰`);
                console.log(`[${extensionName}] 4. APIç«¯ç‚¹åœ°å€å‘ç”Ÿå˜åŒ–`);
                console.log(`[${extensionName}] ğŸ’¡ å»ºè®®: å…ˆåœ¨AIé…ç½®ä¸­è¾“å…¥APIå¯†é’¥ï¼Œç„¶åé‡æ–°åˆ·æ–°`);
            } else {
                console.log(`[${extensionName}] ğŸ“‹ å‘ç°çš„APIåˆ†å¸ƒ:`);
                const providerCount = {};
                const statusCount = {};
                uniqueAPIs.forEach(api => {
                    providerCount[api.provider] = (providerCount[api.provider] || 0) + 1;
                    statusCount[api.status] = (statusCount[api.status] || 0) + 1;
                });
                console.log(`[${extensionName}] ğŸ“Š æŒ‰æä¾›å•†:`, providerCount);
                console.log(`[${extensionName}] ğŸ“Š æŒ‰çŠ¶æ€:`, statusCount);

                // æä¾›ä½¿ç”¨å»ºè®®
                const authRequiredCount = uniqueAPIs.filter(api => api.status === 'auth_required').length;
                if (authRequiredCount > 0) {
                    console.log(`[${extensionName}] ğŸ’¡ æœ‰ ${authRequiredCount} ä¸ªAPIéœ€è¦å¯†é’¥è®¤è¯`);
                }

                const availableCount = uniqueAPIs.filter(api => api.status === 'available').length;
                if (availableCount > 0) {
                    console.log(`[${extensionName}] âœ… æœ‰ ${availableCount} ä¸ªAPIå¯ç›´æ¥ä½¿ç”¨`);
                }
            }

            return uniqueAPIs;

        } catch (error) {
            console.error(`[${extensionName}] âŒ è·å–APIåˆ—è¡¨å¤±è´¥:`, error);
            return [];
        }
    }

    /**
     * è·å–APIæ˜¾ç¤ºåç§°
     */
    function getAPIDisplayName(apiType) {
        const displayNames = {
            'openai': 'OpenAI',
            'claude': 'Claude',
            'google': 'Google',
            'deepseek': 'DeepSeek',
            'mistral': 'Mistral AI',
            'ollama': 'Ollama (æœ¬åœ°)',
            'kobold': 'KoboldAI',
            'tabby': 'TabbyAPI',
            'horde': 'AI Horde',
            'custom': 'è‡ªå®šä¹‰API'
        };
        return displayNames[apiType] || apiType;
    }

    /**
     * æ›´æ–°æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨ - æ–°çš„ä¸»è¦åŠŸèƒ½
     */
    function updateModelDropdown(models) {
        const select = $('#ai-model-select');
        const currentValue = select.val();

        console.log(`[${extensionName}] ğŸ”„ æ›´æ–°æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨ï¼Œå…± ${models.length} ä¸ªæ¨¡å‹`);

        // ä¿ç•™åŸæœ‰çš„é™æ€é€‰é¡¹
        const staticOptions = `
            <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
            <option value="gpt-4">GPT-4</option>
            <option value="gpt-4-turbo">GPT-4 Turbo</option>
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
            <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
            <option value="gemini-pro">Gemini Pro</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            <option value="custom">ğŸ”§ è‡ªå®šä¹‰æ¨¡å‹</option>
        `;

        // æŒ‰æä¾›å•†åˆ†ç»„åŠ¨æ€æ¨¡å‹
        const groupedModels = {};
        models.forEach(model => {
            const group = model.provider || 'Other';
            if (!groupedModels[group]) {
                groupedModels[group] = [];
            }
            groupedModels[group].push(model);
        });

        // ç”ŸæˆåŠ¨æ€é€‰é¡¹
        let dynamicOptions = '';
        if (Object.keys(groupedModels).length > 0) {
            // æŒ‰ä¼˜å…ˆçº§æ’åºç»„
            const groupOrder = ['OpenAI', 'Anthropic Claude', 'Google AI', 'Ollama (æœ¬åœ°)', 'LM Studio (æœ¬åœ°)', 'ç¬¬ä¸‰æ–¹API', 'ç”¨æˆ·é…ç½®API', 'Other'];
            const sortedGroups = Object.keys(groupedModels).sort((a, b) => {
                const aIndex = groupOrder.indexOf(a);
                const bIndex = groupOrder.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });

            sortedGroups.forEach(group => {
                const groupModels = groupedModels[group];
                dynamicOptions += `<optgroup label="â”â”â” ${group} â”â”â”">`;

                groupModels.forEach(model => {
                    const value = `api_model:${model.id || model.name}`;
                    const statusIcon = getStatusIcon(model.status);
                    let displayName = model.name;

                    // æ·»åŠ çŠ¶æ€æç¤º
                    if (model.status === 'suggested') {
                        displayName += ' (æ¨è)';
                    } else if (model.status === 'auth_required') {
                        displayName += ' (éœ€è¦å¯†é’¥)';
                    }

                    // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
                    if (displayName.length > 40) {
                        displayName = displayName.substring(0, 37) + '...';
                    }

                    dynamicOptions += `<option value="${value}" data-model-id="${model.id}" data-status="${model.status}">${statusIcon} ${displayName}</option>`;
                });
                dynamicOptions += '</optgroup>';
            });
        }

        select.html(staticOptions + dynamicOptions);

        // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
        if (currentValue) {
            select.val(currentValue);
        }

        console.log(`[${extensionName}] âœ… æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨æ›´æ–°å®Œæˆ`);

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        const totalModels = models.length;
        const availableModels = models.filter(model => model.status === 'available').length;
        const suggestedModels = models.filter(model => model.status === 'suggested').length;

        if (totalModels > 0) {
            console.log(`[${extensionName}] ğŸ“Š æ¨¡å‹ç»Ÿè®¡: æ€»è®¡${totalModels}ä¸ª, å¯ç”¨${availableModels}ä¸ª, æ¨è${suggestedModels}ä¸ª`);
        }
    }

    /**
     * æ›´æ–°APIä¸‹æ‹‰åˆ—è¡¨ - ä¿ç•™å…¼å®¹æ€§
     */
    function updateAPIDropdown(apis) {
        // ä¸ºäº†å…¼å®¹æ€§ï¼Œå°†APIåˆ—è¡¨è½¬æ¢ä¸ºæ¨¡å‹åˆ—è¡¨æ ¼å¼
        const models = apis.map(api => ({
            id: api.name,
            name: api.name,
            status: api.status,
            provider: api.provider,
            type: api.type
        }));

        updateModelDropdown(models);
    }

    /**
     * è·å–çŠ¶æ€å›¾æ ‡
     */
    function getStatusIcon(status) {
        const icons = {
            'available': 'âœ…',
            'connected': 'ğŸŸ¢',
            'current': 'â­',
            'configured': 'ğŸ”§',
            'stored': 'ğŸ’¾',
            'detected': 'ğŸ”',
            'unknown': 'â“'
        };
        return icons[status] || 'â“';
    }

    /**
     * ä¿å­˜AIé…ç½®è®¾ç½® - æ”¯æŒå¤šç«¯åŒæ­¥
     */
    function saveAISettings() {
        // è·å–å½“å‰é€‰æ‹©çš„æ¨¡å‹
        let currentModel = '';
        const modelSelect = $('#ai-model-select').val();
        const modelInput = $('#ai-model-input').val();

        if (modelSelect === 'custom') {
            currentModel = modelInput;
        } else if (modelSelect && modelSelect.startsWith('api_model:')) {
            currentModel = modelSelect.replace('api_model:', '');
        } else if (modelSelect) {
            currentModel = modelSelect;
        } else {
            currentModel = modelInput;
        }

        const settings = {
            apiType: $('#ai-api-select').val(),
            apiUrl: $('#ai-url-input').val(),
            apiKey: $('#ai-key-input').val(),
            apiModel: currentModel,
            lastTestTime: Date.now(),
            lastTestResult: $('#ai-connection-status').text().includes('âœ…'),
            lastSyncTime: Date.now() // æ·»åŠ åŒæ­¥æ—¶é—´æˆ³
        };

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem(`${extensionName}-ai-settings`, JSON.stringify(settings));

        // ä¿å­˜åˆ°åŒæ­¥å­˜å‚¨
        saveAISettingsToSync(settings);

        console.log(`[${extensionName}] AIè®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥:`, settings);
    }

    /**
     * åŠ è½½AIé…ç½®è®¾ç½® - æ”¯æŒå¤šç«¯åŒæ­¥
     */
    function loadAISettings() {
        try {
            // é¦–å…ˆå°è¯•ä»åŒæ­¥å­˜å‚¨åŠ è½½
            const syncSettings = loadAISettingsFromSync();
            const localSettings = localStorage.getItem(`${extensionName}-ai-settings`);

            let settings = null;

            // æ¯”è¾ƒåŒæ­¥æ•°æ®å’Œæœ¬åœ°æ•°æ®ï¼Œé€‰æ‹©æœ€æ–°çš„
            if (syncSettings && localSettings) {
                try {
                    const syncParsed = typeof syncSettings === 'object' ? syncSettings : JSON.parse(syncSettings);
                    const localParsed = JSON.parse(localSettings);

                    const syncTime = syncParsed.lastSyncTime || 0;
                    const localTime = localParsed.lastSyncTime || 0;

                    if (syncTime > localTime) {
                        settings = syncParsed;
                        console.log(`[${extensionName}] ä½¿ç”¨åŒæ­¥çš„AIè®¾ç½®ï¼ˆæ›´æ–°ï¼‰`);
                    } else {
                        settings = localParsed;
                        console.log(`[${extensionName}] ä½¿ç”¨æœ¬åœ°AIè®¾ç½®ï¼ˆæ›´æ–°ï¼‰`);
                    }
                } catch (error) {
                    console.warn(`[${extensionName}] AIè®¾ç½®æ¯”è¾ƒå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®¾ç½®:`, error);
                    settings = JSON.parse(localSettings);
                }
            } else if (syncSettings) {
                settings = typeof syncSettings === 'object' ? syncSettings : JSON.parse(syncSettings);
                console.log(`[${extensionName}] ä½¿ç”¨åŒæ­¥çš„AIè®¾ç½®ï¼ˆä»…æœ‰åŒæ­¥ï¼‰`);
            } else if (localSettings) {
                settings = JSON.parse(localSettings);
                console.log(`[${extensionName}] ä½¿ç”¨æœ¬åœ°AIè®¾ç½®ï¼ˆä»…æœ‰æœ¬åœ°ï¼‰`);
            }

            if (settings) {
                $('#ai-api-select').val(settings.apiType || '');
                $('#ai-url-input').val(settings.apiUrl || '');
                $('#ai-key-input').val(settings.apiKey || '');

                // å¤„ç†æ¨¡å‹è®¾ç½®
                const savedModel = settings.apiModel || '';
                if (savedModel) {
                    // å°è¯•åœ¨æ¨¡å‹é€‰æ‹©æ¡†ä¸­æ‰¾åˆ°åŒ¹é…çš„é€‰é¡¹
                    const modelSelect = $('#ai-model-select');
                    const matchingOption = modelSelect.find(`option[value="${savedModel}"]`);

                    if (matchingOption.length > 0) {
                        // åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­æ‰¾åˆ°äº†åŒ¹é…çš„æ¨¡å‹
                        modelSelect.val(savedModel);
                        $('#ai-model-input').hide().val(savedModel);
                    } else {
                        // æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ¨¡å¼
                        modelSelect.val('custom');
                        $('#ai-model-input').show().val(savedModel);
                    }
                } else {
                    $('#ai-model-input').val('');
                }

                // æ ¹æ®APIç±»å‹æ˜¾ç¤º/éšè—é…ç½®è¾“å…¥æ¡†
                toggleApiConfigInputs(settings.apiType);

                // æ˜¾ç¤ºä¸Šæ¬¡æµ‹è¯•ç»“æœ
                if (settings.lastTestResult && settings.lastTestTime) {
                    const timeAgo = Math.floor((Date.now() - settings.lastTestTime) / (1000 * 60));
                    $('#ai-connection-status').text(`âœ… ä¸Šæ¬¡æµ‹è¯•æˆåŠŸ (${timeAgo}åˆ†é’Ÿå‰)`).css('color', '#48bb78');
                }

                console.log(`[${extensionName}] AIè®¾ç½®å·²åŠ è½½:`, settings);

                return settings;
            }
        } catch (error) {
            console.error(`[${extensionName}] åŠ è½½AIè®¾ç½®å¤±è´¥:`, error);
        }

        // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿè¦æ›´æ–°èŠå¤©æŒ‰é’®çŠ¶æ€
        updateChatButtonVisibility();
        return {};
    }

    /**
     * æ›´æ–°èŠå¤©æŒ‰é’®å¯è§æ€§ - è®©èŠå¤©æŒ‰é’®åƒå•†åº—æŒ‰é’®ä¸€æ ·å¸¸é©»æ˜¾ç¤º
     */
    function updateChatButtonVisibility() {
        console.log(`[${extensionName}] æ›´æ–°èŠå¤©æŒ‰é’®å¯è§æ€§...`);

        // èŠå¤©æŒ‰é’®åº”è¯¥å§‹ç»ˆæ˜¾ç¤ºï¼Œå°±åƒå•†åº—æŒ‰é’®ä¸€æ ·
        // å¦‚æœAPIæœªé…ç½®ï¼Œç‚¹å‡»æ—¶ä¼šæ˜¾ç¤ºé…ç½®æç¤ºï¼Œè€Œä¸æ˜¯éšè—æŒ‰é’®
        const chatButtons = $('.chat-btn');

        if (chatButtons.length > 0) {
            // ç¡®ä¿èŠå¤©æŒ‰é’®å§‹ç»ˆå¯è§
            chatButtons.show();
            console.log(`[${extensionName}] èŠå¤©æŒ‰é’®å·²è®¾ç½®ä¸ºå¯è§ (æ‰¾åˆ° ${chatButtons.length} ä¸ªæŒ‰é’®)`);
        } else {
            console.log(`[${extensionName}] æœªæ‰¾åˆ°èŠå¤©æŒ‰é’®ï¼Œå¯èƒ½è¿˜æœªæ¸²æŸ“`);
        }
    }











    /**
     * ğŸ”§ æ£€æŸ¥å’Œä¿®å¤æ‚¬æµ®æŒ‰é’®
     */
    window.checkFloatingButton = function() {
        console.log('ğŸ”§ æ£€æŸ¥æ‚¬æµ®æŒ‰é’®çŠ¶æ€...');

        // 1. æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
        const button = $(`#${BUTTON_ID}`);
        console.log(`æŒ‰é’®å­˜åœ¨: ${button.length > 0 ? 'âœ…' : 'âŒ'}`);

        if (button.length === 0) {
            console.log('ğŸ”„ æŒ‰é’®ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°åˆ›å»º...');

            // æ£€æŸ¥æ’ä»¶æ˜¯å¦å¯ç”¨
            const isEnabled = localStorage.getItem(STORAGE_KEY_ENABLED) !== "false";
            console.log(`æ’ä»¶å¯ç”¨çŠ¶æ€: ${isEnabled ? 'âœ…' : 'âŒ'}`);

            if (isEnabled) {
                initializeFloatingButton();

                // å†æ¬¡æ£€æŸ¥
                setTimeout(() => {
                    const newButton = $(`#${BUTTON_ID}`);
                    console.log(`é‡æ–°åˆ›å»ºç»“æœ: ${newButton.length > 0 ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);

                    if (newButton.length > 0) {
                        console.log('âœ… æ‚¬æµ®æŒ‰é’®å·²æ¢å¤ï¼');
                    } else {
                        console.log('âŒ æ‚¬æµ®æŒ‰é’®åˆ›å»ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    }
                }, 100);
            } else {
                console.log('âŒ æ’ä»¶å·²ç¦ç”¨ï¼Œè¯·åœ¨è®¾ç½®ä¸­å¯ç”¨');
            }
        } else {
            console.log('âœ… æ‚¬æµ®æŒ‰é’®æ­£å¸¸å­˜åœ¨');

            // æ£€æŸ¥æŒ‰é’®æ ·å¼
            const styles = button[0].style;
            console.log('æŒ‰é’®æ ·å¼:', {
                position: styles.position,
                display: styles.display,
                visibility: styles.visibility,
                zIndex: styles.zIndex
            });
        }
    };

    /**
     * ğŸ” æ£€æŸ¥AIè°ƒç”¨å‡½æ•°çš„å®é™…å†…å®¹
     */
    window.debugAIFunctions = function() {
        console.log('ğŸ” æ£€æŸ¥AIè°ƒç”¨å‡½æ•°çš„å®é™…å†…å®¹...');

        // æ£€æŸ¥ callAIAPI å‡½æ•°
        if (typeof callAIAPI === 'function') {
            console.log('ğŸ“‹ callAIAPI å‡½æ•°æºç :');
            console.log(callAIAPI.toString());
        } else {
            console.log('âŒ callAIAPI å‡½æ•°ä¸å­˜åœ¨');
        }

        // æ£€æŸ¥ callCustomAPI å‡½æ•°
        if (typeof callCustomAPI === 'function') {
            console.log('ğŸ“‹ callCustomAPI å‡½æ•°æºç :');
            console.log(callCustomAPI.toString());
        } else {
            console.log('âŒ callCustomAPI å‡½æ•°ä¸å­˜åœ¨');
        }

        // æ£€æŸ¥ callAI å‡½æ•°
        if (typeof callAI === 'function') {
            console.log('ğŸ“‹ callAI å‡½æ•°æºç  (å‰100å­—ç¬¦):');
            console.log(callAI.toString().substring(0, 200) + '...');
        } else {
            console.log('âŒ callAI å‡½æ•°ä¸å­˜åœ¨');
        }
    };

    /**
     * ğŸ§ª æµ‹è¯•ç›´è¿+ä¸­ç»§é€€å›é€»è¾‘
     */
    window.testDirectConnection = function() {
        console.log('ğŸ§ª æµ‹è¯•ç›´è¿+ä¸­ç»§é€€å›é€»è¾‘...');

        const settings = loadAISettings();
        if (!settings.apiType || !settings.apiUrl || !settings.apiKey) {
            console.log('âŒ è¯·å…ˆé…ç½®APIè®¾ç½®');
            return;
        }

        console.log(`ğŸ“‹ å½“å‰é…ç½®: ${settings.apiType} | ${settings.apiUrl}`);

        const isOfficialAPI = ['openai', 'claude', 'google', 'deepseek'].includes(settings.apiType);
        const isCustomAPI = settings.apiType === 'custom';

        if (isOfficialAPI) {
            console.log('âœ… å®˜æ–¹API - å°†å°è¯•ç›´è¿ï¼Œå¤±è´¥æ—¶é€€å›ä¸­ç»§');
        } else if (isCustomAPI) {
            console.log('ğŸ”§ è‡ªå®šä¹‰API - å°†å°è¯•ç›´è¿ï¼Œå¤±è´¥æ—¶é€€å›ä¸­ç»§');
        } else {
            console.log('â“ æœªçŸ¥APIç±»å‹');
        }

        console.log('\nğŸš€ å‘é€æµ‹è¯•è¯·æ±‚...');
        callAI('è¯·ç®€å•å›å¤"æµ‹è¯•æˆåŠŸ"', 10000).then(response => {
            console.log('âœ… æµ‹è¯•æˆåŠŸï¼ŒAIå›å¤:', response);
        }).catch(error => {
            console.log('âŒ æµ‹è¯•å¤±è´¥:', error.message);
        });
    };

    /**
     * ğŸ§ª æµ‹è¯•è‡ªå®šä¹‰APIçš„ç›´è¿+ä¸­ç»§é€€å›åŠŸèƒ½
     */
    window.testCustomAPIConnection = function() {
        console.log('ğŸ§ª æµ‹è¯•è‡ªå®šä¹‰APIçš„ç›´è¿+ä¸­ç»§é€€å›åŠŸèƒ½...');

        const settings = loadAISettings();
        if (settings.apiType !== 'custom') {
            console.log('âŒ è¯·å…ˆå°†APIç±»å‹è®¾ç½®ä¸º"è‡ªå®šä¹‰API"');
            return;
        }

        if (!settings.apiUrl || !settings.apiKey) {
            console.log('âŒ è¯·å…ˆé…ç½®è‡ªå®šä¹‰APIçš„URLå’Œå¯†é’¥');
            return;
        }

        console.log(`ğŸ“‹ è‡ªå®šä¹‰APIé…ç½®:`);
        console.log(`   URL: ${settings.apiUrl}`);
        console.log(`   æ¨¡å‹: ${settings.apiModel || 'é»˜è®¤'}`);
        console.log(`   å¯†é’¥: ${settings.apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);

        console.log('\nğŸ¯ å¼€å§‹æµ‹è¯•è‡ªå®šä¹‰APIè¿æ¥ç­–ç•¥...');
        console.log('1ï¸âƒ£ é¦–å…ˆå°è¯•ç›´è¿è‡ªå®šä¹‰API');
        console.log('2ï¸âƒ£ å¦‚æœç›´è¿å¤±è´¥ï¼Œå°†è‡ªåŠ¨é€€å›ä¸­ç»§æœåŠ¡å™¨');

        const testPrompt = 'è¯·ç®€å•å›å¤"è‡ªå®šä¹‰APIæµ‹è¯•æˆåŠŸ"ï¼Œä¸è¶…è¿‡10ä¸ªå­—ã€‚';

        callAI(testPrompt, 15000).then(response => {
            console.log('âœ… è‡ªå®šä¹‰APIæµ‹è¯•æˆåŠŸï¼');
            console.log(`ğŸ“ AIå›å¤: ${response}`);
            toastr.success(`è‡ªå®šä¹‰APIæµ‹è¯•æˆåŠŸï¼AIå›å¤: ${response.substring(0, 50)}`, 'ğŸ”§ è‡ªå®šä¹‰API');
        }).catch(error => {
            console.log('âŒ è‡ªå®šä¹‰APIæµ‹è¯•å¤±è´¥:', error.message);
            toastr.error(`è‡ªå®šä¹‰APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'âŒ æµ‹è¯•å¤±è´¥');
        });
    };

    /**
     * ğŸ§ª æµ‹è¯•æ¨¡å‹è·å–ï¼ˆç›´è¿+ä¸­ç»§é€€å›ï¼‰
     */
    window.testModelFetch = async function() {
        console.log('ğŸ§ª æµ‹è¯•æ¨¡å‹è·å–åŠŸèƒ½...');

        try {
            console.log('ğŸ“‹ å½“å‰APIé…ç½®:');
            console.log(`  ç±»å‹: ${$('#ai-api-select').val()}`);
            console.log(`  URL: ${$('#ai-url-input').val()}`);
            console.log(`  å¯†é’¥: ${$('#ai-key-input').val() ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);

            console.log('\nğŸš€ å¼€å§‹è·å–æ¨¡å‹åˆ—è¡¨...');
            const models = await getThirdPartyModels();

            if (models && models.length > 0) {
                console.log(`âœ… æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹:`);
                models.forEach((model, index) => {
                    console.log(`  ${index + 1}. ${model.name} (${model.id})`);
                });

                // æ›´æ–°UIä¸­çš„æ¨¡å‹ä¸‹æ‹‰æ¡†
                const modelSelect = $('#ai-model-input');
                if (modelSelect.length > 0) {
                    const currentValue = modelSelect.val();
                    modelSelect.empty();

                    models.forEach(model => {
                        modelSelect.append(`<option value="${model.id}">${model.name}</option>`);
                    });

                    // å°è¯•æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                    if (currentValue && models.find(m => m.id === currentValue)) {
                        modelSelect.val(currentValue);
                    }

                    console.log('âœ… æ¨¡å‹ä¸‹æ‹‰æ¡†å·²æ›´æ–°');
                }

            } else {
                console.log('âš ï¸ æœªè·å–åˆ°ä»»ä½•æ¨¡å‹');
            }

        } catch (error) {
            console.error('âŒ æ¨¡å‹è·å–æµ‹è¯•å¤±è´¥:', error);
        }

        console.log('âœ… æ¨¡å‹è·å–æµ‹è¯•å®Œæˆ');
    };

    /**
     * ğŸ§ª æµ‹è¯•Google API URLæ„å»º
     */
    window.testGoogleURLBuild = function() {
        console.log('ğŸ§ª æµ‹è¯•Google API URLæ„å»º...');

        const testCases = [
            {
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta',
                model: 'gemini-pro',
                expected: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            },
            {
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta',
                model: 'models/gemini-pro',
                expected: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            },
            {
                baseUrl: 'https://generativelanguage.googleapis.com/v1beta',
                model: 'gemini-2.5-pro',
                expected: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent'
            }
        ];

        testCases.forEach((testCase, index) => {
            let targetApiUrl = testCase.baseUrl;
            let modelName = testCase.model;

            // åº”ç”¨ç›¸åŒçš„é€»è¾‘
            if (modelName.startsWith('models/')) {
                modelName = modelName.replace('models/', '');
            }

            if (targetApiUrl.endsWith('/v1beta')) {
                targetApiUrl += `/models/${modelName}:generateContent`;
            }

            const success = targetApiUrl === testCase.expected;
            console.log(`æµ‹è¯• ${index + 1}: ${success ? 'âœ…' : 'âŒ'}`);
            console.log(`  è¾“å…¥: ${testCase.baseUrl} + ${testCase.model}`);
            console.log(`  æœŸæœ›: ${testCase.expected}`);
            console.log(`  å®é™…: ${targetApiUrl}`);
            console.log('');
        });

        console.log('âœ… Google API URLæ„å»ºæµ‹è¯•å®Œæˆ');
    };

    /**
     * ğŸ”§ é‡ç½®APIé…ç½®
     */
    window.resetAPIConfig = function() {
        console.log('ğŸ”§ é‡ç½®APIé…ç½®...');

        // è·å–å½“å‰é€‰æ‹©çš„APIç±»å‹
        const currentApiType = $('#ai-api-select').val();
        console.log(`å½“å‰APIç±»å‹: ${currentApiType}`);

        // å¼ºåˆ¶é‡æ–°å¡«å…¥æ­£ç¡®çš„URL
        switch(currentApiType) {
            case 'openai':
                $('#ai-url-input').val('https://api.openai.com/v1');
                console.log('âœ… é‡ç½®ä¸ºOpenAIå®˜æ–¹ç«¯ç‚¹');
                break;
            case 'claude':
                $('#ai-url-input').val('https://api.anthropic.com/v1');
                console.log('âœ… é‡ç½®ä¸ºClaudeå®˜æ–¹ç«¯ç‚¹');
                break;
            case 'google':
                $('#ai-url-input').val('https://generativelanguage.googleapis.com/v1beta');
                console.log('âœ… é‡ç½®ä¸ºGoogleå®˜æ–¹ç«¯ç‚¹');
                break;
            case 'deepseek':
                $('#ai-url-input').val('https://api.deepseek.com/v1');
                console.log('âœ… é‡ç½®ä¸ºDeepSeekå®˜æ–¹ç«¯ç‚¹');
                break;
            case 'ollama':
                $('#ai-url-input').val('http://localhost:11434/v1');
                console.log('âœ… é‡ç½®ä¸ºOllamaé»˜è®¤ç«¯ç‚¹');
                break;
            case 'lmstudio':
                $('#ai-url-input').val('http://localhost:1234/v1');
                console.log('âœ… é‡ç½®ä¸ºLM Studioé»˜è®¤ç«¯ç‚¹');
                break;
            default:
                console.log('â“ æœªçŸ¥APIç±»å‹ï¼Œæ— æ³•é‡ç½®');
                break;
        }

        // ä¿å­˜è®¾ç½®
        saveAISettings();
        console.log('âœ… APIé…ç½®å·²é‡ç½®å¹¶ä¿å­˜');
    };

    /**
     * ğŸ§ª æµ‹è¯•è‡ªåŠ¨å¡«å……URLåŠŸèƒ½
     */
    window.testAutoFillURL = function() {
        console.log('ğŸ§ª æµ‹è¯•è‡ªåŠ¨å¡«å……URLåŠŸèƒ½...');

        const apiTypes = ['openai', 'claude', 'google', 'deepseek', 'ollama', 'lmstudio', 'custom'];
        const expectedUrls = {
            'openai': 'https://api.openai.com/v1',
            'claude': 'https://api.anthropic.com/v1',
            'google': 'https://generativelanguage.googleapis.com/v1beta',
            'deepseek': 'https://api.deepseek.com/v1',
            'ollama': 'http://localhost:11434/v1',
            'lmstudio': 'http://localhost:1234/v1',
            'custom': 'ä¸è‡ªåŠ¨å¡«å……'
        };

        console.log('ğŸ“‹ æµ‹è¯•å„APIç±»å‹çš„è‡ªåŠ¨å¡«å……...');

        apiTypes.forEach(apiType => {
            // æ¨¡æ‹Ÿé€‰æ‹©APIç±»å‹
            $('#ai-api-select').val(apiType).trigger('change');

            // æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®å¡«å……
            const currentUrl = $('#ai-url-input').val();
            const expectedUrl = expectedUrls[apiType];

            if (apiType === 'custom') {
                console.log(`${apiType}: ä¿æŒç°æœ‰URL (${currentUrl}) âœ…`);
            } else if (currentUrl === expectedUrl) {
                console.log(`${apiType}: ${currentUrl} âœ…`);
            } else {
                console.log(`${apiType}: æœŸæœ› ${expectedUrl}, å®é™… ${currentUrl} âŒ`);
            }
        });

        console.log('\nâœ… è‡ªåŠ¨å¡«å……URLæµ‹è¯•å®Œæˆ');
        console.log('ğŸ’¡ ç°åœ¨åˆ‡æ¢APIç±»å‹æ—¶åº”è¯¥è‡ªåŠ¨å¡«å…¥å¯¹åº”çš„å®˜æ–¹ç«¯ç‚¹');
    };

    /**
     * ğŸ§ª æµ‹è¯•APIé…ç½®ä¼˜åŒ–
     */
    window.testAPIConfig = function() {
        console.log('ğŸ§ª æµ‹è¯•APIé…ç½®ä¼˜åŒ–...');

        // æµ‹è¯•APIç±»å‹é€‰é¡¹
        const apiSelect = $('#ai-api-select');
        const options = apiSelect.find('option');

        console.log('ğŸ“‹ å¯ç”¨çš„APIç±»å‹:');
        options.each(function() {
            const value = $(this).val();
            const text = $(this).text();
            if (value) {
                console.log(`  ${value}: ${text}`);
            }
        });

        // æµ‹è¯•é»˜è®¤URLè®¾ç½®
        console.log('\nğŸ”— é»˜è®¤URLé…ç½®:');
        const defaults = {
            'openai': 'https://api.openai.com/v1',
            'claude': 'https://api.anthropic.com/v1',
            'google': 'https://generativelanguage.googleapis.com/v1beta',
            'deepseek': 'https://api.deepseek.com/v1'
        };

        Object.entries(defaults).forEach(([type, url]) => {
            console.log(`  ${type}: ${url}`);
        });

        console.log('\nâœ… APIé…ç½®ä¼˜åŒ–éªŒè¯å®Œæˆ');
        console.log('ğŸ’¡ ç°åœ¨APIç±»å‹åç§°æ›´ç®€æ´ï¼Œé€‰æ‹©åä¼šè‡ªåŠ¨å¡«å…¥å®˜æ–¹ç«¯ç‚¹');
    };

    /**
     * ğŸ§ª ç®€å•æµ‹è¯•ä¸­ç»§æœåŠ¡å™¨è¿æ¥
     */
    window.testRelayServerSimple = function() {
        console.log('ğŸ§ª ç®€å•æµ‹è¯•ä¸­ç»§æœåŠ¡å™¨è¿æ¥...');

        const relayServerUrl = 'http://154.12.38.33:3000/health';

        console.log(`ğŸŒ æµ‹è¯•URL: ${relayServerUrl}`);

        fetch(relayServerUrl, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        }).then(response => {
            console.log(`âœ… ä¸­ç»§æœåŠ¡å™¨å“åº”: ${response.status}`);
            return response.text();
        }).then(data => {
            console.log(`ğŸ“¦ å“åº”å†…å®¹:`, data);
        }).catch(error => {
            console.error(`âŒ ä¸­ç»§æœåŠ¡å™¨è¿æ¥å¤±è´¥:`, error);
        });
    };

    /**
     * æµ‹è¯•ä¸­ç»§æœåŠ¡å™¨è¿æ¥
     */
    window.testRelayServer = function() {
        console.log('ğŸ§ª æµ‹è¯•ä¸­ç»§æœåŠ¡å™¨è¿æ¥...');

        const relayServerUrl = 'http://154.12.38.33:3000/proxy';

        // æ„å»ºæµ‹è¯•è¯·æ±‚
        const testRequest = {
            targetUrl: 'https://httpbin.org/get',
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            body: null
        };

        console.log(`ğŸ”— æµ‹è¯•ä¸­ç»§æœåŠ¡å™¨: ${relayServerUrl}`);
        console.log(`ğŸ¯ æµ‹è¯•ç›®æ ‡: ${testRequest.targetUrl}`);

        return fetch(relayServerUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testRequest)
        })
        .then(response => {
            console.log(`ğŸ“¡ ä¸­ç»§æœåŠ¡å™¨å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

            if (response.ok) {
                return response.json();
            } else {
                throw new Error(`ä¸­ç»§æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
            }
        })
        .then(data => {
            console.log('âœ… ä¸­ç»§æœåŠ¡å™¨æµ‹è¯•æˆåŠŸï¼');
            console.log('ğŸ“¦ å“åº”æ•°æ®:', data);
            return true;
        })
        .catch(error => {
            console.error('âŒ ä¸­ç»§æœåŠ¡å™¨æµ‹è¯•å¤±è´¥:', error);
            console.log('ğŸ’¡ è¯·ç¡®ä¿:');
            console.log('  1. ä¸­ç»§æœåŠ¡å™¨å·²å¯åŠ¨ (node server.js)');
            console.log('  2. æœåŠ¡å™¨IPåœ°å€æ­£ç¡®: 154.12.38.33');
            console.log('  3. ç«¯å£3000å·²å¼€æ”¾');
            console.log('  4. é˜²ç«å¢™å…è®¸è®¿é—®');
            return false;
        });
    };

    /**
     * åˆ‡æ¢APIé…ç½®è¾“å…¥æ¡†çš„æ˜¾ç¤ºçŠ¶æ€ - åç«¯APIç‰ˆæœ¬
     */
    function toggleApiConfigInputs(apiType) {
        const container = $('#ai-config-container');

        console.log(`[${extensionName}] ğŸ”§ å¤„ç†APIç±»å‹: ${apiType}`);

        // å¤„ç†ä»åç«¯APIæ£€æµ‹åˆ°çš„APIç±»å‹
        let processedApiType = apiType;
        let backendInfo = null;

        if (apiType && apiType.startsWith('backend:')) {
            // è§£æåç«¯APIä¿¡æ¯: backend:type:name
            const parts = apiType.split(':');
            if (parts.length >= 3) {
                const backendType = parts[1];
                const backendName = parts.slice(2).join(':'); // å¤„ç†åç§°ä¸­å¯èƒ½åŒ…å«å†’å·çš„æƒ…å†µ

                processedApiType = backendType;
                backendInfo = {
                    type: backendType,
                    name: backendName
                };

                console.log(`[${extensionName}] ğŸ” åç«¯APIä¿¡æ¯:`, backendInfo);

                // è‡ªåŠ¨å¡«å……æ¨¡å‹åç§°
                $('#ai-model-input').val(backendName);

                // æ ¹æ®APIç±»å‹æä¾›é…ç½®å»ºè®®
                let configMessage = `å·²é€‰æ‹©æ¨¡å‹: ${backendName}`;
                if (backendType === 'openai') {
                    configMessage += 'ï¼Œè¯·è¾“å…¥OpenAI APIå¯†é’¥';
                } else if (backendType === 'claude') {
                    configMessage += 'ï¼Œè¯·è¾“å…¥Claude APIå¯†é’¥';
                } else if (backendType === 'google') {
                    configMessage += 'ï¼Œè¯·è¾“å…¥Google APIå¯†é’¥';
                } else if (backendType === 'deepseek') {
                    configMessage += 'ï¼Œè¯·è¾“å…¥DeepSeek APIå¯†é’¥';
                } else if (backendType === 'ollama' || backendType === 'lmstudio') {
                    configMessage += 'ï¼Œæœ¬åœ°APIæ— éœ€å¯†é’¥';
                } else {
                    configMessage += 'ï¼Œè¯·é…ç½®ç›¸åº”çš„URLå’Œå¯†é’¥';
                }

                toastr.info(configMessage, 'ğŸ¤– æ¨¡å‹å·²é€‰æ‹©', { timeOut: 6000 });
            }
        } else if (apiType && apiType.startsWith('detected:')) {
            // å…¼å®¹æ—§æ ¼å¼
            const parts = apiType.split(':');
            if (parts.length >= 3) {
                const detectedType = parts[1];
                const detectedName = parts.slice(2).join(':');
                processedApiType = detectedType;
                $('#ai-model-input').val(detectedName);
                toastr.info(`å·²é€‰æ‹©æ£€æµ‹åˆ°çš„API: ${detectedName}ï¼Œè¯·é…ç½®ç›¸åº”çš„URLå’Œå¯†é’¥`, '', { timeOut: 6000 });
            }
        } else if (apiType && apiType.startsWith('model:')) {
            // å…¼å®¹æ›´æ—§çš„æ ¼å¼
            const modelName = apiType.replace('model:', '');
            processedApiType = 'custom';
            $('#ai-model-input').val(modelName);
            toastr.info(`å·²é€‰æ‹©æ¨¡å‹: ${modelName}ï¼Œè¯·é…ç½®å¯¹åº”çš„API URLå’Œå¯†é’¥`, '', { timeOut: 5000 });
        }

        if (processedApiType && processedApiType !== 'auto' && processedApiType !== '') {
            container.show();

            // æ ¹æ®APIç±»å‹è®¾ç½®é»˜è®¤å€¼
            const defaults = {
                'openai': { url: 'https://api.openai.com/v1', model: 'gpt-4' },
                'claude': { url: 'https://api.anthropic.com/v1', model: 'claude-3-sonnet-20240229' },
                'google': { url: 'https://generativelanguage.googleapis.com/v1beta', model: 'gemini-pro' },
                'deepseek': { url: 'https://api.deepseek.com/v1', model: 'deepseek-chat' },
                'mistral': { url: 'https://api.mistral.ai/v1', model: 'mistral-medium' },
                'ollama': { url: 'http://localhost:11434/v1', model: 'llama2' },
                'lmstudio': { url: 'http://localhost:1234/v1', model: 'local-model' },
                'textgen': { url: 'http://localhost:5000/v1', model: 'text-generation-webui' },
                'kobold': { url: 'http://localhost:5001', model: 'kobold' },
                'tabby': { url: 'http://localhost:5000', model: 'tabby' },
                'horde': { url: 'https://horde.koboldai.net', model: 'horde' },
                'custom': { url: '', model: '' }
            };

            // è®¾ç½®é»˜è®¤å€¼ï¼ˆå¦‚æœå½“å‰è¾“å…¥æ¡†ä¸ºç©ºï¼‰
            if (defaults[processedApiType]) {
                if (!$('#ai-url-input').val() && defaults[processedApiType].url) {
                    $('#ai-url-input').val(defaults[processedApiType].url);
                    $('#ai-url-input').attr('placeholder', defaults[processedApiType].url);
                }
                if (!$('#ai-model-input').val() && defaults[processedApiType].model && !backendInfo) {
                    $('#ai-model-input').attr('placeholder', defaults[processedApiType].model);
                }
            }

            // å¦‚æœæ˜¯ä»åç«¯æ£€æµ‹åˆ°çš„APIï¼Œæä¾›ç‰¹å®šçš„é…ç½®å»ºè®®
            if (backendInfo) {
                console.log(`[${extensionName}] ğŸ’¡ ä¸ºåç«¯APIæä¾›é…ç½®å»ºè®®`);

                // æ ¹æ®APIç±»å‹è‡ªåŠ¨è®¾ç½®URLï¼ˆå®˜æ–¹APIæ€»æ˜¯å¡«å…¥å®˜æ–¹ç«¯ç‚¹ï¼‰
                if (backendInfo.type === 'openai') {
                    $('#ai-url-input').val('https://api.openai.com/v1');
                } else if (backendInfo.type === 'claude') {
                    $('#ai-url-input').val('https://api.anthropic.com/v1');
                } else if (backendInfo.type === 'google') {
                    $('#ai-url-input').val('https://generativelanguage.googleapis.com/v1beta');
                } else if (backendInfo.type === 'deepseek') {
                    $('#ai-url-input').val('https://api.deepseek.com/v1');
                } else if (backendInfo.type === 'ollama') {
                    if (!$('#ai-url-input').val()) {
                        $('#ai-url-input').val('http://localhost:11434/v1');
                    }
                } else if (backendInfo.type === 'lmstudio') {
                    if (!$('#ai-url-input').val()) {
                        $('#ai-url-input').val('http://localhost:1234/v1');
                    }
                }

                // ä¸ºæœ¬åœ°APIéšè—å¯†é’¥è¾“å…¥æ¡†æˆ–æä¾›æç¤º
                if (backendInfo.type === 'ollama' || backendInfo.type === 'lmstudio' || backendInfo.type === 'textgen') {
                    $('#ai-key-input').attr('placeholder', 'æœ¬åœ°APIé€šå¸¸ä¸éœ€è¦å¯†é’¥');
                }
            }
        } else {
            container.hide();
        }
    }

    /**
     * æµ‹è¯•AIè¿æ¥
     */
    async function testAIConnection() {
        const statusElement = $('#ai-connection-status');
        const testButton = $('#test-ai-connection-btn');
        const settings = loadAISettings();

        // æ›´æ–°çŠ¶æ€ä¸ºæµ‹è¯•ä¸­
        statusElement.text('ğŸ”„ æµ‹è¯•ä¸­...').css('color', '#ffa500');
        testButton.prop('disabled', true);

        try {
            if (!settings.apiType || !settings.apiUrl || !settings.apiKey) {
                throw new Error('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®ä¿¡æ¯ï¼ˆç±»å‹ã€URLå’Œå¯†é’¥ï¼‰');
            }

            // å‘é€æµ‹è¯•è¯·æ±‚
            const testPrompt = "è¯·ç®€å•å›å¤'æµ‹è¯•æˆåŠŸ'ï¼Œä¸è¶…è¿‡10ä¸ªå­—ã€‚";
            console.log(`[${extensionName}] å¼€å§‹æµ‹è¯•APIè¿æ¥...`);

            const response = await callCustomAPI(testPrompt, settings, 10000); // 10ç§’è¶…æ—¶ç”¨äºæµ‹è¯•

            if (response && response.trim()) {
                statusElement.text('âœ… è¿æ¥æˆåŠŸ').css('color', '#48bb78');
                toastr.success(`APIè¿æ¥æµ‹è¯•æˆåŠŸï¼ç±»å‹: ${settings.apiType}ï¼ŒAIå›å¤: ${response.substring(0, 50)}`);

                // ä¿å­˜æµ‹è¯•ç»“æœ
                saveAISettings();
                return true;
            } else {
                throw new Error('APIè¿”å›ç©ºå“åº”');
            }

        } catch (error) {
            statusElement.text('âŒ è¿æ¥å¤±è´¥').css('color', '#f56565');
            toastr.error('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);

            // æä¾›è¯¦ç»†çš„é”™è¯¯å¸®åŠ©
            if (error.message.includes('500')) {
                setTimeout(() => {
                    toastr.info('500é”™è¯¯è¡¨ç¤ºæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œå¯èƒ½æ˜¯ï¼š1) APIæœåŠ¡å™¨æ•…éšœ 2) è¯·æ±‚æ ¼å¼ä¸æ­£ç¡® 3) æ¨¡å‹åç§°é”™è¯¯', '', { timeOut: 10000 });
                }, 1000);
            } else if (error.message.includes('403')) {
                setTimeout(() => {
                    toastr.info('403é”™è¯¯é€šå¸¸è¡¨ç¤ºAPIå¯†é’¥æ— æ•ˆæˆ–æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®', '', { timeOut: 8000 });
                }, 1000);
            } else if (error.message.includes('401')) {
                setTimeout(() => {
                    toastr.info('401é”™è¯¯è¡¨ç¤ºè®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æ ¼å¼æ˜¯å¦æ­£ç¡®', '', { timeOut: 8000 });
                }, 1000);
            } else if (error.message.includes('404')) {
                setTimeout(() => {
                    toastr.info('404é”™è¯¯è¡¨ç¤ºAPIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥API URLæ˜¯å¦æ­£ç¡®', '', { timeOut: 8000 });
                }, 1000);
            }

            return false;
        } finally {
            testButton.prop('disabled', false);
        }
    }



    /**
     * ğŸš€ ç»Ÿä¸€AIè°ƒç”¨å‡½æ•° - æ‰€æœ‰AIè¯·æ±‚çš„å”¯ä¸€å…¥å£
     * å®˜æ–¹APIé¦–é€‰ç›´è¿ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨é€€å›ä¸­ç»§æœåŠ¡å™¨
     * @param {string} prompt - è¦å‘é€ç»™AIçš„æç¤ºè¯
     * @param {number} timeout - è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     * @returns {Promise<string>} - AIç”Ÿæˆçš„å›å¤
     */
    async function callAI(prompt, timeout = 60000) {
        console.log(`[${extensionName}] ğŸš€ ç»Ÿä¸€AIè°ƒç”¨å¼€å§‹`);
        console.log(`[${extensionName}] ğŸ“ æç¤ºè¯é•¿åº¦: ${prompt.length} å­—ç¬¦`);
        console.log(`[${extensionName}] â±ï¸ è¶…æ—¶è®¾ç½®: ${timeout}ms`);

        try {
            // 1. è·å–APIé…ç½®
            const settings = loadAISettings();
            if (!settings.apiType || !settings.apiUrl || !settings.apiKey) {
                throw new Error('è¯·å…ˆåœ¨æ’ä»¶è®¾ç½®ä¸­é…ç½®APIä¿¡æ¯ï¼ˆç±»å‹ã€URLå’Œå¯†é’¥ï¼‰');
            }

            console.log(`[${extensionName}] ğŸ”§ APIé…ç½®: ${settings.apiType} | ${settings.apiUrl}`);

            // 2. åˆ¤æ–­APIç±»å‹å¹¶åº”ç”¨é¦–é€‰ç›´è¿å¤‡é€‰ä¸­ç»§ç­–ç•¥
            const isOfficialAPI = ['openai', 'claude', 'google', 'deepseek'].includes(settings.apiType);
            const isCustomAPI = settings.apiType === 'custom';

            if (isOfficialAPI) {
                console.log(`[${extensionName}] ğŸ¯ æ£€æµ‹åˆ°å®˜æ–¹APIï¼Œå°è¯•ç›´è¿...`);
                try {
                    return await callDirectAPI(prompt, settings, timeout);
                } catch (directError) {
                    console.log(`[${extensionName}] âš ï¸ å®˜æ–¹APIç›´è¿å¤±è´¥ï¼Œé€€å›ä¸­ç»§æœåŠ¡å™¨: ${directError.message}`);
                    return await callViaRelay(prompt, settings, timeout);
                }
            } else if (isCustomAPI) {
                console.log(`[${extensionName}] ğŸ”§ æ£€æµ‹åˆ°è‡ªå®šä¹‰APIï¼Œå°è¯•ç›´è¿...`);
                try {
                    return await callDirectAPI(prompt, settings, timeout);
                } catch (directError) {
                    console.log(`[${extensionName}] âš ï¸ è‡ªå®šä¹‰APIç›´è¿å¤±è´¥ï¼Œé€€å›ä¸­ç»§æœåŠ¡å™¨: ${directError.message}`);
                    return await callViaRelay(prompt, settings, timeout);
                }
            } else {
                throw new Error(`ä¸æ”¯æŒçš„APIç±»å‹: ${settings.apiType}`);
            }

        } catch (error) {
            console.error(`[${extensionName}] âŒ ç»Ÿä¸€AIè°ƒç”¨å¤±è´¥:`, error);
            throw error;
        }
    }

    /**
     * ğŸ¯ ç›´è¿APIï¼ˆæ”¯æŒå®˜æ–¹APIå’Œè‡ªå®šä¹‰APIï¼‰
     */
    async function callDirectAPI(prompt, settings, timeout) {
        console.log(`[${extensionName}] ğŸ¯ å¼€å§‹ç›´è¿API...`);

        try {
            // 1. æ„å»ºç›®æ ‡API URL
            let targetApiUrl = settings.apiUrl.replace(/\/+$/, '');

            // æ ¹æ®APIç±»å‹è‡ªåŠ¨æ·»åŠ æ­£ç¡®çš„ç«¯ç‚¹
            if (settings.apiType === 'openai' || settings.apiType === 'deepseek') {
                if (!targetApiUrl.includes('/chat/completions')) {
                    if (targetApiUrl.endsWith('/v1')) {
                        targetApiUrl += '/chat/completions';
                    } else if (!targetApiUrl.includes('/v1')) {
                        targetApiUrl += '/v1/chat/completions';
                    } else {
                        targetApiUrl += '/chat/completions';
                    }
                }
            } else if (settings.apiType === 'claude') {
                if (!targetApiUrl.includes('/messages')) {
                    if (targetApiUrl.endsWith('/v1')) {
                        targetApiUrl += '/messages';
                    } else if (!targetApiUrl.includes('/v1')) {
                        targetApiUrl += '/v1/messages';
                    } else {
                        targetApiUrl += '/messages';
                    }
                }
            } else if (settings.apiType === 'google') {
                if (!targetApiUrl.includes(':generateContent')) {
                    let modelName = settings.apiModel || 'gemini-pro';

                    // ç¡®ä¿æ¨¡å‹åç§°ä¸åŒ…å« models/ å‰ç¼€
                    if (modelName.startsWith('models/')) {
                        modelName = modelName.replace('models/', '');
                    }

                    if (targetApiUrl.endsWith('/v1beta')) {
                        targetApiUrl += `/models/${modelName}:generateContent`;
                    } else if (!targetApiUrl.includes('/v1beta')) {
                        targetApiUrl += `/v1beta/models/${modelName}:generateContent`;
                    } else {
                        targetApiUrl += `/models/${modelName}:generateContent`;
                    }
                }
            } else if (settings.apiType === 'custom') {
                // è‡ªå®šä¹‰APIï¼šå°è¯•æ™ºèƒ½æ„å»ºç«¯ç‚¹
                if (!targetApiUrl.includes('/chat/completions') && !targetApiUrl.includes('/messages') && !targetApiUrl.includes(':generateContent')) {
                    // é»˜è®¤å‡è®¾æ˜¯OpenAIå…¼å®¹çš„API
                    if (targetApiUrl.endsWith('/v1')) {
                        targetApiUrl += '/chat/completions';
                    } else if (!targetApiUrl.includes('/v1')) {
                        targetApiUrl += '/v1/chat/completions';
                    } else {
                        targetApiUrl += '/chat/completions';
                    }
                }
            }

            console.log(`[${extensionName}] ğŸ¯ ç›´è¿ç›®æ ‡: ${targetApiUrl}`);

            // 2. æ„å»ºè¯·æ±‚å¤´
            const headers = { 'Content-Type': 'application/json' };

            // 3. æ ¹æ®APIç±»å‹è®¾ç½®è®¤è¯å¤´
            if (settings.apiType === 'google') {
                headers['x-goog-api-key'] = settings.apiKey;
            } else if (settings.apiType === 'claude') {
                headers['x-api-key'] = settings.apiKey;
                headers['anthropic-version'] = '2023-06-01';
            } else {
                // OpenAIã€DeepSeek å’Œè‡ªå®šä¹‰APIï¼ˆé»˜è®¤ä½¿ç”¨Bearer Tokenï¼‰
                headers['Authorization'] = `Bearer ${settings.apiKey}`;
            }

            // 4. æ„å»ºè¯·æ±‚ä½“
            let requestBody;
            if (settings.apiType === 'claude') {
                requestBody = {
                    model: settings.apiModel || 'claude-3-sonnet-20240229',
                    max_tokens: 1000,
                    messages: [{ role: 'user', content: prompt }]
                };
            } else if (settings.apiType === 'google') {
                requestBody = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        maxOutputTokens: 1000,
                        temperature: 0.7
                    }
                };
            } else {
                // OpenAIã€DeepSeek å’Œè‡ªå®šä¹‰APIæ ¼å¼ï¼ˆé»˜è®¤ä½¿ç”¨OpenAIå…¼å®¹æ ¼å¼ï¼‰
                let defaultModel = 'gpt-3.5-turbo';
                if (settings.apiType === 'deepseek') {
                    defaultModel = 'deepseek-chat';
                } else if (settings.apiType === 'custom') {
                    defaultModel = settings.apiModel || 'gpt-3.5-turbo'; // è‡ªå®šä¹‰APIä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„æ¨¡å‹
                }

                requestBody = {
                    model: settings.apiModel || defaultModel,
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 1000,
                    temperature: 0.7
                };
            }

            // 5. å‘é€ç›´è¿è¯·æ±‚
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            console.log(`[${extensionName}] ğŸš€ å¼€å§‹ç›´è¿è¯·æ±‚...`);

            const response = await fetch(targetApiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();

            // 6. è§£æå“åº”
            let aiReply;
            if (settings.apiType === 'claude') {
                if (data.content && data.content[0] && data.content[0].text) {
                    aiReply = data.content[0].text;
                } else {
                    throw new Error('Claude APIå“åº”æ ¼å¼å¼‚å¸¸');
                }
            } else if (settings.apiType === 'google') {
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    aiReply = data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Google APIå“åº”æ ¼å¼å¼‚å¸¸');
                }
            } else {
                // OpenAIã€DeepSeek å’Œè‡ªå®šä¹‰APIæ ¼å¼ï¼ˆé»˜è®¤ä½¿ç”¨OpenAIå…¼å®¹æ ¼å¼ï¼‰
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    aiReply = data.choices[0].message.content;
                } else {
                    throw new Error(`${settings.apiType === 'custom' ? 'è‡ªå®šä¹‰API' : 'API'}å“åº”æ ¼å¼å¼‚å¸¸`);
                }
            }

            console.log(`[${extensionName}] âœ… ç›´è¿æˆåŠŸï¼ŒAIå›å¤: ${aiReply.substring(0, 50)}...`);
            return aiReply.trim();

        } catch (error) {
            console.error(`[${extensionName}] âŒ ç»Ÿä¸€AIè°ƒç”¨å¤±è´¥:`, error);
            throw error;
        }
    }

    /**
     * ğŸ”„ é€šè¿‡ä¸­ç»§æœåŠ¡å™¨è°ƒç”¨API
     */
    async function callViaRelay(prompt, settings, timeout) {
        console.log(`[${extensionName}] ğŸ”„ å¼€å§‹ä¸­ç»§æœåŠ¡å™¨è°ƒç”¨...`);

        const relayServerUrl = 'http://154.12.38.33:3000/proxy';

        // è¿™é‡Œä½¿ç”¨åŸæœ‰çš„ä¸­ç»§æœåŠ¡å™¨é€»è¾‘
        // æ„å»ºç›®æ ‡API URL
        let targetApiUrl = settings.apiUrl.replace(/\/+$/, '');

        // æ ¹æ®APIç±»å‹è‡ªåŠ¨æ·»åŠ æ­£ç¡®çš„ç«¯ç‚¹
        if (settings.apiType === 'openai' || settings.apiType === 'custom' || settings.apiType === 'deepseek') {
            if (!targetApiUrl.includes('/chat/completions')) {
                if (targetApiUrl.endsWith('/v1')) {
                    targetApiUrl += '/chat/completions';
                } else if (!targetApiUrl.includes('/v1')) {
                    targetApiUrl += '/v1/chat/completions';
                } else {
                    targetApiUrl += '/chat/completions';
                }
            }
        } else if (settings.apiType === 'claude') {
            if (!targetApiUrl.includes('/messages')) {
                if (targetApiUrl.endsWith('/v1')) {
                    targetApiUrl += '/messages';
                } else if (!targetApiUrl.includes('/v1')) {
                    targetApiUrl += '/v1/messages';
                } else {
                    targetApiUrl += '/messages';
                }
            }
        } else if (settings.apiType === 'google') {
            if (!targetApiUrl.includes(':generateContent')) {
                let modelName = settings.apiModel || 'gemini-pro';

                // ç¡®ä¿æ¨¡å‹åç§°ä¸åŒ…å« models/ å‰ç¼€
                if (modelName.startsWith('models/')) {
                    modelName = modelName.replace('models/', '');
                }

                if (targetApiUrl.endsWith('/v1beta')) {
                    targetApiUrl += `/models/${modelName}:generateContent`;
                } else if (!targetApiUrl.includes('/v1beta')) {
                    targetApiUrl += `/v1beta/models/${modelName}:generateContent`;
                } else {
                    targetApiUrl += `/models/${modelName}:generateContent`;
                }
            }
        }

        // æ„å»ºè¯·æ±‚å¤´
        const targetHeaders = { 'Content-Type': 'application/json' };

        // æ ¹æ®APIç±»å‹è®¾ç½®è®¤è¯å¤´
        if (settings.apiType === 'google') {
            targetHeaders['x-goog-api-key'] = settings.apiKey;
        } else if (settings.apiType === 'claude') {
            targetHeaders['x-api-key'] = settings.apiKey;
            targetHeaders['anthropic-version'] = '2023-06-01';
        } else {
            targetHeaders['Authorization'] = `Bearer ${settings.apiKey}`;
        }

        // æ„å»ºè¯·æ±‚ä½“
        let targetRequestBody;
        if (settings.apiType === 'openai' || settings.apiType === 'custom' || settings.apiType === 'deepseek') {
            targetRequestBody = {
                model: settings.apiModel || (settings.apiType === 'deepseek' ? 'deepseek-chat' : 'gpt-3.5-turbo'),
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 4000,
                temperature: 0.8
            };
        } else if (settings.apiType === 'claude') {
            targetRequestBody = {
                model: settings.apiModel || 'claude-3-sonnet-20240229',
                max_tokens: 4000,
                messages: [{ role: 'user', content: prompt }]
            };
        } else if (settings.apiType === 'google') {
            targetRequestBody = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { maxOutputTokens: 4000, temperature: 0.8 }
            };
        }

        // æ„å»ºä¸­ç»§æœåŠ¡å™¨è¯·æ±‚ä½“
        const relayRequestBody = {
            targetUrl: targetApiUrl,
            method: 'POST',
            headers: targetHeaders,
            body: targetRequestBody
        };

        // å‘é€è¯·æ±‚
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
            const response = await fetch(relayServerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(relayRequestBody),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ä¸­ç»§æœåŠ¡å™¨é”™è¯¯: ${response.status} ${errorText}`);
            }

            const data = await response.json();

            // è§£æå“åº”
            let result = '';
            if (settings.apiType === 'openai' || settings.apiType === 'custom' || settings.apiType === 'deepseek') {
                result = data.choices?.[0]?.message?.content || '';
            } else if (settings.apiType === 'claude') {
                result = data.content?.[0]?.text || '';
            } else if (settings.apiType === 'google') {
                result = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            }

            console.log(`[${extensionName}] âœ… ä¸­ç»§è°ƒç”¨æˆåŠŸï¼ŒAIå›å¤: ${result.substring(0, 50)}...`);
            return result.trim();

        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    /**
     * ğŸ”„ å…¼å®¹æ€§å‡½æ•° - é‡å®šå‘æ‰€æœ‰æ—§çš„AIè°ƒç”¨åˆ°ç»Ÿä¸€å‡½æ•°
     */

    // ä¸»è¦çš„AIè°ƒç”¨å‡½æ•° - é‡å®šå‘åˆ°ç»Ÿä¸€å‡½æ•°
    async function callAIAPI(prompt, timeout = 60000) {
        console.log(`[${extensionName}] ğŸ”„ callAIAPI -> callAI é‡å®šå‘`);
        return await callAI(prompt, timeout);
    }

    // è‡ªå®šä¹‰APIè°ƒç”¨å‡½æ•° - é‡å®šå‘åˆ°ç»Ÿä¸€å‡½æ•°
    async function callCustomAPI(prompt, settings = null, timeout = 60000) {
        console.log(`[${extensionName}] ğŸ”„ callCustomAPI -> callAI é‡å®šå‘`);
        return await callAI(prompt, timeout);
    }

    /**
     * æ£€æŸ¥AI APIæ˜¯å¦å¯ç”¨
     * @returns {boolean} - APIæ˜¯å¦å¯ç”¨
     */
    function isAIAPIAvailable() {
        // åªæ£€æŸ¥è‡ªå®šä¹‰AIé…ç½®
        const settings = loadAISettings();
        const customAPIAvailable = settings.apiType && settings.apiUrl && settings.apiKey;

        console.log(`[${extensionName}] APIå¯ç”¨æ€§æ£€æŸ¥:`, {
            apiType: settings.apiType || 'æœªè®¾ç½®',
            apiUrl: settings.apiUrl || 'æœªè®¾ç½®',
            apiKey: settings.apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
            available: customAPIAvailable
        });

        return customAPIAvailable;
    }

    /**
     * æ„å»ºäº’åŠ¨Prompt
     * @param {string} action - ç”¨æˆ·çš„è¡Œä¸º ('feed', 'play', 'sleep')
     * @returns {string} - æ„å»ºå¥½çš„Prompt
     */
    function buildInteractionPrompt(action) {
        // è·å–å½“å‰æ—¶é—´ä¿¡æ¯
        const now = new Date();
        const timeOfDay = now.getHours() < 12 ? 'ä¸Šåˆ' : now.getHours() < 18 ? 'ä¸‹åˆ' : 'æ™šä¸Š';

        // æ ¹æ®è¡Œä¸ºç±»å‹è®¾ç½®æè¿°
        const actionDescriptions = {
            'feed': 'ç»™æˆ‘å–‚äº†é£Ÿç‰©',
            'play': 'é™ªæˆ‘ç©è€',
            'sleep': 'è®©æˆ‘ä¼‘æ¯',
            'hug': 'ç»™äº†æˆ‘ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±'
        };

        // å®‰å…¨è·å–è¡Œä¸ºæè¿°ï¼Œç¡®ä¿ä¸ä¼šå‡ºç°undefined
        const actionDescription = actionDescriptions[action] || `ä¸æˆ‘è¿›è¡Œäº†${action || 'æœªçŸ¥'}äº’åŠ¨`;

        // è°ƒè¯•æ—¥å¿—
        console.log(`[buildInteractionPrompt] action: "${action}", description: "${actionDescription}"`);

        // è·å–å½“å‰äººè®¾ï¼Œç¡®ä¿ä¸åŒ…å«å†²çªä¿¡æ¯
        const currentPersonality = getCurrentPersonality();

        // æ„å»ºå®Œæ•´çš„Prompt - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œé¿å…é‡‘å¸ç†è§£é”™è¯¯
        const prompt = `ä½ æ˜¯${petData.name}ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹äººè®¾å›åº”ç”¨æˆ·ã€‚

ã€ä½ çš„èº«ä»½è®¾å®šã€‘ï¼š
${currentPersonality}

ã€é‡è¦ã€‘ï¼šè¯·å®Œå…¨æŒ‰ç…§ä¸Šè¿°èº«ä»½è®¾å®šå›åº”ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–èº«ä»½ç‰¹å¾ã€‚

ã€å½“å‰çŠ¶æ€ã€‘ï¼š
- å¥åº·ï¼š${Math.round(petData.health)}/100 ${petData.health < 30 ? '(æ„Ÿè§‰ä¸å¤ªèˆ’æœ)' : petData.health > 70 ? '(ç²¾ç¥å¾ˆå¥½)' : '(è¿˜ç®—å¥åº·)'}
- å¿«ä¹ï¼š${Math.round(petData.happiness)}/100 ${petData.happiness < 30 ? '(å¿ƒæƒ…ä¸å¤ªå¥½)' : petData.happiness > 70 ? '(å¾ˆå¼€å¿ƒ)' : '(å¿ƒæƒ…ä¸€èˆ¬)'}
- é¥±é£Ÿï¼š${Math.round(petData.hunger)}/100 ${petData.hunger < 30 ? '(å¾ˆé¥¿)' : petData.hunger > 70 ? '(å¾ˆé¥±)' : '(æœ‰ç‚¹é¥¿)'}
- ç²¾åŠ›ï¼š${Math.round(petData.energy)}/100 ${petData.energy < 30 ? '(å¾ˆç´¯)' : petData.energy > 70 ? '(ç²¾åŠ›å……æ²›)' : '(æœ‰ç‚¹ç´¯)'}

ã€æƒ…æ™¯ã€‘ï¼šç°åœ¨æ˜¯${timeOfDay}ï¼Œç”¨æˆ·åˆšåˆš${actionDescription}ã€‚

ã€æ³¨æ„ã€‘ï¼šä¸è¦åœ¨å›å¤ä¸­æåŠé‡‘å¸ã€å¥–åŠ±æˆ–ä»»ä½•æ¸¸æˆæœºåˆ¶ï¼Œåªéœ€è¦æŒ‰ç…§ä½ çš„äººè®¾è‡ªç„¶å›åº”å³å¯ã€‚

è¯·ä»¥${petData.name}çš„èº«ä»½ï¼Œä¸¥æ ¼æŒ‰ç…§ä½ çš„äººè®¾å›åº”ï¼ˆä¸è¶…è¿‡30å­—ï¼‰ï¼š`;

        return prompt;
    }

    /**
     * å¤„ç†AIå›å¤çš„é€šç”¨å‡½æ•°
     * @param {string} action - è¡Œä¸ºç±»å‹
     * @param {string} fallbackMessage - å›é€€æ¶ˆæ¯
     * @param {Object} rewards - å¥–åŠ±ä¿¡æ¯ {coins: number, experience: number}
     * @returns {Promise<void>}
     */
    async function handleAIReply(action, fallbackMessage, rewards = null) {
        try {
            if (isAIAPIAvailable()) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingToast = toastr.info(`${petData.name} æ­£åœ¨æ€è€ƒ...`, "", {
                    timeOut: 0,
                    extendedTimeOut: 0,
                    closeButton: false
                });

                try {
                    // æ„å»ºPromptå¹¶è°ƒç”¨AI
                    const prompt = buildInteractionPrompt(action);
                    console.log(`[${extensionName}] å‘é€çš„æç¤ºè¯:`, prompt);
                    const aiReply = await callAIAPI(prompt, 90000); // å¢åŠ åˆ°90ç§’è¶…æ—¶

                    // æ¸…é™¤åŠ è½½æç¤º
                    toastr.clear(loadingToast);

                    // æ˜¾ç¤ºAIç”Ÿæˆçš„å›å¤
                    toastr.success(aiReply || fallbackMessage, "", {
                        timeOut: 5000,
                        extendedTimeOut: 2000
                    });

                    console.log(`[${extensionName}] AIå›å¤æˆåŠŸ: ${aiReply}`);

                } catch (apiError) {
                    // æ¸…é™¤åŠ è½½æç¤º
                    toastr.clear(loadingToast);

                    console.warn(`[${extensionName}] AIå›å¤å¤±è´¥ï¼Œä½¿ç”¨å›é€€æ¶ˆæ¯:`, apiError);
                    toastr.success(fallbackMessage, "", {
                        timeOut: 4000,
                        extendedTimeOut: 1000
                    });

                    // å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªæç¤º
                    if (apiError.message.includes('è¶…æ—¶')) {
                        setTimeout(() => {
                            toastr.warning("AIå›å¤è¶…æ—¶ï¼Œå·²ä½¿ç”¨é»˜è®¤å›å¤", "", { timeOut: 3000 });
                        }, 500);
                    }
                }
            } else {
                // APIä¸å¯ç”¨ï¼Œç›´æ¥ä½¿ç”¨å›é€€æ¶ˆæ¯
                console.log(`[${extensionName}] AI APIä¸å¯ç”¨ï¼Œä½¿ç”¨é™æ€å›å¤`);
                toastr.success(fallbackMessage, "", {
                    timeOut: 4000,
                    extendedTimeOut: 1000
                });
            }

            // ç‹¬ç«‹æ˜¾ç¤ºå¥–åŠ±ä¿¡æ¯ï¼ˆå¦‚æœæä¾›äº†å¥–åŠ±æ•°æ®ï¼‰
            if (rewards && (rewards.coins > 0 || rewards.experience > 0)) {
                setTimeout(() => {
                    showRewardNotification(rewards);
                }, 1000); // å»¶è¿Ÿ1ç§’æ˜¾ç¤ºï¼Œè®©AIå›å¤å…ˆæ˜¾ç¤º
            }

        } catch (error) {
            console.error(`[${extensionName}] å¤„ç†AIå›å¤æ—¶å‘ç”Ÿé”™è¯¯:`, error);
            // æœ€ç»ˆå›é€€
            toastr.success(fallbackMessage);

            // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºå¥–åŠ±
            if (rewards && (rewards.coins > 0 || rewards.experience > 0)) {
                setTimeout(() => {
                    showRewardNotification(rewards);
                }, 500);
            }
        }
    }

    /**
     * æ˜¾ç¤ºå¥–åŠ±é€šçŸ¥
     * @param {Object} rewards - å¥–åŠ±ä¿¡æ¯ {coins: number, experience: number}
     */
    function showRewardNotification(rewards) {
        let rewardText = "ğŸ è·å¾—å¥–åŠ±ï¼š";
        const rewardParts = [];

        if (rewards.coins > 0) {
            rewardParts.push(`ğŸ’° ${rewards.coins} é‡‘å¸`);
        }

        if (rewards.experience > 0) {
            rewardParts.push(`â­ ${rewards.experience} ç»éªŒ`);
        }

        if (rewardParts.length > 0) {
            rewardText += rewardParts.join("ï¼Œ");

            // æ˜¾ç¤ºå¥–åŠ±é€šçŸ¥
            toastr.info(rewardText, "", {
                timeOut: 3000,
                extendedTimeOut: 1000,
                positionClass: "toast-bottom-right" // æ˜¾ç¤ºåœ¨å³ä¸‹è§’ï¼Œé¿å…ä¸AIå›å¤é‡å 
            });

            console.log(`ğŸ ${rewardText}`);
        }
    }

    /**
     * åˆå§‹åŒ–è®¾ç½®é¢æ¿
     */
    function initializeSettingsPanel() {
        // æ¸…ç†æ—§çš„è§’è‰²å¡æ•°æ®
        cleanupOldCharacterData();

        // åŠ è½½å½“å‰è®¾ç½®
        const currentPersonalityType = localStorage.getItem(`${extensionName}-personality-type`) || 'default';
        const customPersonality = localStorage.getItem(`${extensionName}-custom-personality`) || '';

        // è®¾ç½®ä¸‹æ‹‰æ¡†çš„å€¼
        $("#virtual-pet-personality-select").val(currentPersonalityType);
        $("#virtual-pet-custom-personality").val(customPersonality);

        // æ ¹æ®é€‰æ‹©æ˜¾ç¤º/éšè—è‡ªå®šä¹‰è¾“å…¥æ¡†
        toggleCustomPersonalityInput(currentPersonalityType === 'custom');

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        $("#virtual-pet-personality-select").on('change', function() {
            const selectedType = $(this).val();
            const isCustom = selectedType === 'custom';

            toggleCustomPersonalityInput(isCustom);

            if (!isCustom) {
                // å¦‚æœé€‰æ‹©äº†é¢„è®¾äººè®¾ï¼Œç«‹å³ä¿å­˜
                savePersonalitySettings(selectedType);
                toastr.success(`å·²åˆ‡æ¢åˆ°${$(this).find('option:selected').text()}äººè®¾`);
            }
        });

        $("#virtual-pet-custom-personality").on('input', function() {
            // è‡ªå®šä¹‰äººè®¾æ–‡æœ¬å˜åŒ–æ—¶ä¿å­˜
            const customText = $(this).val().trim();
            savePersonalitySettings('custom', customText);
        });

        // å¯ç”¨/ç¦ç”¨è™šæ‹Ÿå® ç‰©ç³»ç»Ÿçš„äº‹ä»¶ç›‘å¬å™¨
        $("#virtual-pet-enabled-toggle").on('change', function() {
            const enabled = $(this).is(':checked');
            localStorage.setItem(`${extensionName}-enabled`, enabled);

            if (enabled) {
                toastr.success("è™šæ‹Ÿå® ç‰©ç³»ç»Ÿå·²å¯ç”¨");
                // å¦‚æœå½“å‰æ²¡æœ‰æ˜¾ç¤ºå® ç‰©æŒ‰é’®ï¼Œé‡æ–°åˆ›å»º
                if ($("#virtual-pet-button").length === 0) {
                    createPetButton();
                }
            } else {
                toastr.info("è™šæ‹Ÿå® ç‰©ç³»ç»Ÿå·²ç¦ç”¨");
                // éšè—å® ç‰©æŒ‰é’®
                $("#virtual-pet-button").hide();
            }
        });

        // åŠ è½½å¯ç”¨çŠ¶æ€
        const enabled = localStorage.getItem(`${extensionName}-enabled`) !== 'false';
        $("#virtual-pet-enabled-toggle").prop('checked', enabled);

        // åŠ è½½AIè®¾ç½®
        loadAISettings();

        // ç»‘å®šAIç›¸å…³äº‹ä»¶
        $('#ai-api-select').on('change', function() {
            const apiType = $(this).val();

            // æ ¹æ®é€‰æ‹©çš„APIç±»å‹è‡ªåŠ¨å¡«å……å®˜æ–¹ç«¯ç‚¹URL
            switch(apiType) {
                case 'openai':
                    $('#ai-url-input').val('https://api.openai.com/v1');
                    break;
                case 'claude':
                    $('#ai-url-input').val('https://api.anthropic.com/v1');
                    break;
                case 'google':
                    $('#ai-url-input').val('https://generativelanguage.googleapis.com/v1beta');
                    break;
                case 'deepseek':
                    $('#ai-url-input').val('https://api.deepseek.com/v1');
                    break;
                case 'ollama':
                    $('#ai-url-input').val('http://localhost:11434/v1');
                    break;
                case 'lmstudio':
                    $('#ai-url-input').val('http://localhost:1234/v1');
                    break;
                case 'custom':
                    // è‡ªå®šä¹‰APIä¸è‡ªåŠ¨å¡«å……ï¼Œä¿æŒç”¨æˆ·è¾“å…¥
                    break;
                default:
                    // å…¶ä»–æƒ…å†µä¸è‡ªåŠ¨å¡«å……
                    break;
            }

            toggleApiConfigInputs(apiType);
            saveAISettings();
            // æ¸…é™¤ä¹‹å‰çš„æµ‹è¯•ç»“æœ
            $('#ai-connection-status').text('æœªæµ‹è¯•').css('color', '#888');
        });

        // ç»‘å®šAPIé…ç½®è¾“å…¥æ¡†äº‹ä»¶
        $('#ai-url-input, #ai-key-input, #ai-model-input').on('input', function() {
            saveAISettings();
        });

        // ç»‘å®šURLé‡ç½®æŒ‰é’®äº‹ä»¶
        $('#ai-url-reset-btn').on('click', function() {
            const currentApiType = $('#ai-api-select').val();

            if (!currentApiType || currentApiType === 'custom') {
                toastr.info('è‡ªå®šä¹‰APIç±»å‹æ— æ³•é‡ç½®ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥URL', 'ğŸ’¡ æç¤º', { timeOut: 3000 });
                return;
            }

            // è°ƒç”¨é‡ç½®å‡½æ•°
            resetAPIConfig();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const apiNames = {
                'openai': 'OpenAI',
                'claude': 'Claude',
                'google': 'Google',
                'deepseek': 'DeepSeek',
                'ollama': 'Ollama',
                'lmstudio': 'LM Studio'
            };

            const apiName = apiNames[currentApiType] || currentApiType;
            toastr.success(`å·²é‡ç½®ä¸º${apiName}å®˜æ–¹ç«¯ç‚¹`, 'ğŸ”„ é‡ç½®æˆåŠŸ', { timeOut: 3000 });
        });

        $('#test-ai-connection-btn').on('click', function(e) {
            e.preventDefault();
            testAIConnection();
        });

        // ç»‘å®šæ¨¡å‹é€‰æ‹©æ¡†äº‹ä»¶
        $('#ai-model-select').on('change', function() {
            const selectedValue = $(this).val();
            console.log(`[${extensionName}] æ¨¡å‹é€‰æ‹©å˜åŒ–: ${selectedValue}`);

            if (selectedValue === 'custom') {
                // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡†
                $('#ai-model-input').show().focus();
                $('#ai-model-input').attr('placeholder', 'è¯·è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°');
                toastr.info('è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°', 'ğŸ”§ è‡ªå®šä¹‰æ¨¡å‹', { timeOut: 3000 });
            } else if (selectedValue && selectedValue.startsWith('api_model:')) {
                // å¤„ç†ä»APIè·å–çš„æ¨¡å‹
                const modelId = selectedValue.replace('api_model:', '');
                $('#ai-model-input').hide().val(modelId);
                toastr.success(`å·²é€‰æ‹©APIæ¨¡å‹: ${modelId}`, 'ğŸ¤– æ¨¡å‹å·²é€‰æ‹©', { timeOut: 2000 });
                console.log(`[${extensionName}] é€‰æ‹©äº†APIæ¨¡å‹: ${modelId}`);
            } else if (selectedValue) {
                // éšè—è‡ªå®šä¹‰è¾“å…¥æ¡†ï¼Œä½¿ç”¨é€‰æ‹©çš„æ¨¡å‹
                $('#ai-model-input').hide().val(selectedValue);
                toastr.success(`å·²é€‰æ‹©æ¨¡å‹: ${selectedValue}`, 'ğŸ¤– æ¨¡å‹å·²é€‰æ‹©', { timeOut: 2000 });
            } else {
                // æœªé€‰æ‹©ï¼Œéšè—è‡ªå®šä¹‰è¾“å…¥æ¡†
                $('#ai-model-input').hide().val('');
            }

            // ä¿å­˜è®¾ç½®
            saveAISettings();
        });

        // ç»‘å®šåˆ·æ–°æ¨¡å‹åˆ—è¡¨æŒ‰é’®äº‹ä»¶
        $('#refresh-models-btn').on('click', async function(e) {
            e.preventDefault();
            const button = $(this);
            const originalText = button.text();

            button.prop('disabled', true).text('ğŸ”„ è·å–ä¸­...');

            try {
                console.log(`[${extensionName}] å¼€å§‹åˆ·æ–°æ¨¡å‹åˆ—è¡¨...`);

                // æ£€æŸ¥APIé…ç½®
                const userApiUrl = $('#ai-url-input').val();

                if (!userApiUrl) {
                    toastr.warning('è¯·å…ˆé…ç½®API URL', 'âš ï¸ é…ç½®ä¸å®Œæ•´', { timeOut: 3000 });
                    return;
                }

                let models = [];

                console.log(`[${extensionName}] ä»é…ç½®çš„APIè·å–æ¨¡å‹åˆ—è¡¨...`);

                // ä½¿ç”¨ç¬¬ä¸‰æ–¹APIä¸“ç”¨æ–¹æ³•è·å–æ¨¡å‹
                const thirdPartyModels = await getThirdPartyModels();
                if (thirdPartyModels.length > 0) {
                    models = thirdPartyModels;
                    console.log(`[${extensionName}] ä»ç¬¬ä¸‰æ–¹APIè·å–åˆ° ${thirdPartyModels.length} ä¸ªæ¨¡å‹`);
                } else {
                    // å¤‡é€‰ï¼šä½¿ç”¨é€šç”¨æ–¹æ³•
                    const userModels = await getUserConfiguredModels();
                    if (userModels.length > 0) {
                        models = userModels;
                        console.log(`[${extensionName}] ä»ç”¨æˆ·é…ç½®APIè·å–åˆ° ${userModels.length} ä¸ªæ¨¡å‹`);
                    }
                }

                // æ›´æ–°æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨
                updateModelDropdown(models);

                if (models.length > 0) {
                    toastr.success(`ğŸ‰ ä»æ‚¨çš„APIè·å–åˆ° ${models.length} ä¸ªæ¨¡å‹ï¼`, 'æ¨¡å‹è·å–æˆåŠŸ', { timeOut: 4000 });
                } else {
                    toastr.warning('æœªèƒ½ä»æ‚¨çš„APIè·å–åˆ°æ¨¡å‹ï¼Œè¯·æ£€æŸ¥URLå’Œå¯†é’¥é…ç½®', 'âš ï¸ æ¨¡å‹è·å–å¤±è´¥', { timeOut: 4000 });
                }
            } catch (error) {
                console.error(`[${extensionName}] åˆ·æ–°æ¨¡å‹åˆ—è¡¨å¤±è´¥:`, error);
                toastr.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message, 'âŒ è·å–å¤±è´¥', { timeOut: 5000 });
            } finally {
                button.prop('disabled', false).text(originalText);
            }
        });

        // åˆå§‹åŒ–æ—¶è‡ªåŠ¨å°è¯•è·å–APIåˆ—è¡¨ï¼ˆé™é»˜æ¨¡å¼ï¼‰
        setTimeout(async () => {
            try {
                console.log(`[${extensionName}] åˆå§‹åŒ–æ—¶è‡ªåŠ¨è·å–APIåˆ—è¡¨...`);
                const apis = await getAvailableAPIs();
                if (apis.length > 0) {
                    updateAPIDropdown(apis);
                    console.log(`[${extensionName}] è‡ªåŠ¨å‘ç° ${apis.length} ä¸ªAPI`);
                }
            } catch (error) {
                console.log(`[${extensionName}] è‡ªåŠ¨è·å–APIåˆ—è¡¨å¤±è´¥ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰:`, error.message);
            }
        }, 1000);

        // ç»‘å®šFirebaseäº‹ä»¶
        bindFirebaseEvents();

        console.log(`[${extensionName}] è®¾ç½®é¢æ¿åˆå§‹åŒ–å®Œæˆ`);
        console.log(`[${extensionName}] å½“å‰äººè®¾ç±»å‹: ${currentPersonalityType}`);
        console.log(`[${extensionName}] å½“å‰äººè®¾å†…å®¹: ${getCurrentPersonality()}`);
        console.log(`[${extensionName}] ğŸ’¡ æç¤º: ç‚¹å‡»"ğŸ”„ åˆ·æ–°"æŒ‰é’®å¯ä»¥ä»SillyTavernè·å–å¯ç”¨çš„APIåˆ—è¡¨`);
        console.log(`[${extensionName}] ğŸ’¡ æç¤º: åœ¨æ§åˆ¶å°è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•:`);
        console.log(`[${extensionName}] ğŸ’¡   - diagnoseSillyTavernEnvironment() // ç¯å¢ƒè¯Šæ–­`);
        console.log(`[${extensionName}] ğŸ’¡   - testVirtualPetAPIDiscovery() // APIå‘ç°æµ‹è¯•`);
        console.log(`[${extensionName}] ğŸ’¡   - quickAPITest() // å¿«é€ŸAPIæµ‹è¯•`);
    }

    /**
     * åˆ‡æ¢è‡ªå®šä¹‰äººè®¾è¾“å…¥æ¡†çš„æ˜¾ç¤ºçŠ¶æ€
     * @param {boolean} show æ˜¯å¦æ˜¾ç¤º
     */
    function toggleCustomPersonalityInput(show) {
        if (show) {
            $("#virtual-pet-custom-personality-container").show();
        } else {
            $("#virtual-pet-custom-personality-container").hide();
        }
    }

    // -----------------------------------------------------------------
    // 3. å® ç‰©ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
    // -----------------------------------------------------------------
    
    /**
     * åŠ è½½å® ç‰©æ•°æ®ï¼ˆæ”¯æŒè·¨è®¾å¤‡åŒæ­¥ï¼‰
     */
    function loadPetData() {
        // é¦–å…ˆå°è¯•ä»åŒæ­¥å­˜å‚¨åŠ è½½
        const syncData = loadFromSyncStorage();
        const localData = localStorage.getItem(STORAGE_KEY_PET_DATA);

        let savedData = null;

        // æ¯”è¾ƒåŒæ­¥æ•°æ®å’Œæœ¬åœ°æ•°æ®ï¼Œé€‰æ‹©æœ€æ–°çš„
        if (syncData && localData) {
            try {
                const syncParsed = typeof syncData === 'object' ? syncData : JSON.parse(syncData);
                const localParsed = JSON.parse(localData);

                const syncTime = syncParsed.lastSyncTime || 0;
                const localTime = localParsed.lastSyncTime || 0;

                if (syncTime > localTime) {
                    savedData = syncParsed;
                    console.log(`[${extensionName}] ä½¿ç”¨åŒæ­¥æ•°æ®ï¼ˆæ›´æ–°ï¼‰`);
                } else {
                    savedData = localParsed;
                    console.log(`[${extensionName}] ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼ˆæ›´æ–°ï¼‰`);
                }
            } catch (error) {
                console.warn(`[${extensionName}] æ•°æ®æ¯”è¾ƒå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:`, error);
                savedData = JSON.parse(localData);
            }
        } else if (syncData) {
            savedData = typeof syncData === 'object' ? syncData : JSON.parse(syncData);
            console.log(`[${extensionName}] ä½¿ç”¨åŒæ­¥æ•°æ®ï¼ˆä»…æœ‰åŒæ­¥ï¼‰`);
        } else if (localData) {
            savedData = JSON.parse(localData);
            console.log(`[${extensionName}] ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼ˆä»…æœ‰æœ¬åœ°ï¼‰`);
        }

        if (savedData) {
            try {
                // savedData å·²ç»æ˜¯è§£æåçš„å¯¹è±¡ï¼Œä¸éœ€è¦å†æ¬¡è§£æ

                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ•°æ®è¿ç§»åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿ
                const needsMigration = !savedData.dataVersion || savedData.dataVersion < 4.0;

                if (needsMigration) {
                    console.log(`[${extensionName}] æ£€æµ‹åˆ°æ—§æ•°æ®ç‰ˆæœ¬ ${savedData.dataVersion || 'æœªçŸ¥'}ï¼Œæ‰§è¡Œæ•°æ®è¿ç§»åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿ4.0...`);

                    // è¿ç§»åˆ°æ‹“éº»æ­Œå­å¼æ•°æ®ç»“æ„
                    const migratedData = {
                        // ä¿ç•™åŸºæœ¬ä¿¡æ¯
                        name: savedData.name || petData.name,
                        type: savedData.type || petData.type,
                        level: savedData.level || petData.level,
                        experience: savedData.experience || petData.experience,
                        created: savedData.created || petData.created,
                        personality: savedData.personality || getCurrentPersonality(), // ä¿ç•™äººè®¾ä¿¡æ¯

                        // åŸºç¡€æ•°å€¼ï¼ˆä½¿ç”¨æ›´åˆç†çš„åˆå§‹å€¼ï¼‰
                        health: Math.min(savedData.health || 35, 70),
                        happiness: Math.min(savedData.happiness || 25, 70),
                        hunger: Math.min(savedData.hunger || 40, 70),
                        energy: Math.min(savedData.energy || 50, 70),

                        // æ–°å¢æ‹“éº»æ­Œå­å¼å±æ€§
                        lifeStage: "baby",
                        age: 0,
                        isAlive: true,
                        deathReason: null,
                        sickness: 0,
                        discipline: 50,
                        weight: 30,

                        // æ—¶é—´è®°å½•
                        lastFeedTime: savedData.lastFeedTime || petData.lastFeedTime,
                        lastPlayTime: savedData.lastPlayTime || petData.lastPlayTime,
                        lastSleepTime: savedData.lastSleepTime || petData.lastSleepTime,
                        lastUpdateTime: savedData.lastUpdateTime || petData.lastUpdateTime,
                        lastCareTime: Date.now(),

                        // æ‹“éº»æ­Œå­å¼è®¡æ•°å™¨
                        careNeglectCount: 0,
                        sicknessDuration: 0,

                        // å•†åº—ç³»ç»Ÿ
                        coins: savedData.coins || 100,
                        inventory: savedData.inventory || {},

                        dataVersion: 4.0 // æ ‡è®°ä¸ºæ‹“éº»æ­Œå­ç³»ç»Ÿç‰ˆæœ¬
                    };

                    petData = migratedData;

                    // åº”ç”¨æ‹“éº»æ­Œå­å¼å‡½æ•°
                    applyTamagotchiSystem();

                    savePetData(); // ä¿å­˜è¿ç§»åçš„æ•°æ®

                    console.log(`[${extensionName}] æ•°æ®è¿ç§»å®Œæˆï¼æ‹“éº»æ­Œå­ç³»ç»Ÿå·²å¯ç”¨`);
                    console.log(`æ–°çš„æ‹“éº»æ­Œå­å¼å® ç‰© - ç”Ÿå‘½é˜¶æ®µ: ${petData.lifeStage}, å¹´é¾„: ${petData.age}å°æ—¶`);

                    toastr.info('ğŸ¥š æ¬¢è¿æ¥åˆ°æ‹“éº»æ­Œå­ä¸–ç•Œï¼ä½ çš„å® ç‰©ç°åœ¨éœ€è¦çœŸæ­£çš„ç…§é¡¾ï¼Œè¯·å®šæœŸå…³æ³¨å®ƒçš„çŠ¶æ€ï¼', '', { timeOut: 8000 });
                } else {
                    // æ•°æ®ç‰ˆæœ¬æ­£ç¡®ï¼Œç›´æ¥åŠ è½½
                    petData = { ...petData, ...savedData };
                    console.log(`[${extensionName}] åŠ è½½å·²æœ‰æ•°æ®`);

                    // æ£€æŸ¥æ˜¯å¦éœ€è¦åº”ç”¨é¦–æ¬¡æ‰“å¼€çš„éšæœºåŒ–
                    if (!savedData.hasBeenRandomized) {
                        applyFirstTimeRandomization();
                    }

                    // ç¡®ä¿æ‹“éº»æ­Œå­ç³»ç»Ÿå·²åº”ç”¨
                    applyTamagotchiSystem();
                }

                // ç¡®ä¿äººè®¾æ•°æ®å®Œæ•´æ€§
                if (!petData.personality) {
                    petData.personality = getCurrentPersonality();
                }
            } catch (error) {
                console.error(`[${extensionName}] Error loading pet data:`, error);
            }
        } else {
            // æ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œé¦–æ¬¡ä½¿ç”¨
            petData.dataVersion = 4.0;
            petData.personality = getCurrentPersonality(); // è®¾ç½®åˆå§‹äººè®¾
            applyTamagotchiSystem();
            applyFirstTimeRandomization(); // é¦–æ¬¡éšæœºåŒ–
            savePetData();
        }

        // æ·»åŠ åˆå§‹åŒ–ç¼“å†²æœºåˆ¶
        applyInitializationBuffer();
    }

    /**
     * é¦–æ¬¡æ‰“å¼€éšæœºåŒ– - æ•°å€¼éšæœºä½†ä¸è¶…è¿‡50
     */
    function applyFirstTimeRandomization() {
        console.log(`[${extensionName}] åº”ç”¨é¦–æ¬¡æ‰“å¼€éšæœºåŒ–...`);

        // éšæœºåŒ–æ•°å€¼ï¼Œä½†ä¸è¶…è¿‡50ï¼Œä¸”ä¿è¯ä¸€å®šçš„å¹³è¡¡æ€§
        petData.health = Math.floor(Math.random() * 20) + 30;      // 30-49
        petData.happiness = Math.floor(Math.random() * 20) + 25;   // 25-44
        petData.hunger = Math.floor(Math.random() * 20) + 30;      // 30-49
        petData.energy = Math.floor(Math.random() * 20) + 25;      // 25-44

        // æ ‡è®°å·²ç»éšæœºåŒ–è¿‡
        petData.hasBeenRandomized = true;

        console.log(`[${extensionName}] éšæœºåŒ–å®Œæˆ: å¥åº·${petData.health}, å¿«ä¹${petData.happiness}, é¥±é£Ÿ${petData.hunger}, ç²¾åŠ›${petData.energy}`);

        toastr.info('ğŸ² æ¬¢è¿ï¼ä½ çš„å® ç‰©çŠ¶æ€å·²éšæœºåˆå§‹åŒ–', '', { timeOut: 4000 });
    }

    /**
     * åˆå§‹åŒ–ç¼“å†²æœºåˆ¶ - é¿å…é•¿æ—¶é—´ç¦»çº¿åçŠ¶æ€è¿‡ä½
     */
    function applyInitializationBuffer() {
        const now = Date.now();
        const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
        const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);

        // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°è¶…è¿‡2å°æ—¶ï¼Œç»™äºˆç¼“å†²
        if (hoursElapsed > 2) {
            console.log(`[${extensionName}] æ£€æµ‹åˆ°é•¿æ—¶é—´æœªæ›´æ–° (${hoursElapsed.toFixed(1)}å°æ—¶)ï¼Œåº”ç”¨åˆå§‹åŒ–ç¼“å†²...`);

            // åŸºç¡€ç¼“å†²æ•°å€¼ï¼ˆé˜²æ­¢è¿‡ä½ä½†ä¸å¼ºåˆ¶é‡ç½®ï¼‰
            const minValues = {
                hunger: 25,    // æœ€ä½é¥±é£Ÿåº¦25
                energy: 20,    // æœ€ä½ç²¾åŠ›20
                happiness: 15, // æœ€ä½å¿«ä¹åº¦15
                health: 30     // æœ€ä½å¥åº·åº¦30
            };

            let buffered = false;
            Object.entries(minValues).forEach(([key, minValue]) => {
                if (petData[key] < minValue) {
                    console.log(`[${extensionName}] ç¼“å†² ${key}: ${petData[key]} â†’ ${minValue}`);
                    petData[key] = minValue;
                    buffered = true;
                }
            });

            if (buffered) {
                // æ›´æ–°æ—¶é—´æˆ³ï¼Œé¿å…ç«‹å³å†æ¬¡è¡°å‡
                petData.lastUpdateTime = now;
                savePetData();

                toastr.info('ğŸŒŸ æ¬¢è¿å›æ¥ï¼å·²ä¸ºä½ çš„å® ç‰©æä¾›äº†åŸºç¡€ç…§é¡¾ã€‚', '', { timeOut: 4000 });
                console.log(`[${extensionName}] åˆå§‹åŒ–ç¼“å†²å·²åº”ç”¨`);
            }
        }
    }
    
    /**
     * ä¿å­˜å® ç‰©æ•°æ®
     */
    function savePetData() {
        try {
            // æ·»åŠ æ—¶é—´æˆ³ç”¨äºåŒæ­¥
            const dataWithTimestamp = {
                ...petData,
                lastSyncTime: Date.now()
            };

            localStorage.setItem(STORAGE_KEY_PET_DATA, JSON.stringify(dataWithTimestamp));

            // åŒæ—¶ä¿å­˜åˆ°å…¨å±€åŒæ­¥å­˜å‚¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            saveToSyncStorage(dataWithTimestamp);

        } catch (error) {
            console.error(`[${extensionName}] Error saving pet data:`, error);
        }
    }

    /**
     * ä¿å­˜åˆ°åŒæ­¥å­˜å‚¨ï¼ˆè·¨è®¾å¤‡ï¼‰- å®‰å…¨ç‰ˆæœ¬
     */
    function saveToSyncStorage(data) {
        try {
            // ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„é”®åç”¨äºè·¨è®¾å¤‡åŒæ­¥
            const syncKey = `${extensionName}-sync-data`;
            localStorage.setItem(syncKey, JSON.stringify(data));

            // å®‰å…¨åœ°å°è¯•ä½¿ç”¨SillyTavernçš„åŒæ­¥æœºåˆ¶
            if (typeof window.saveSettingsDebounced === 'function' &&
                typeof window.extension_settings === 'object' &&
                window.extension_settings !== null) {

                try {
                    // ç¡®ä¿ä¸è¦†ç›–ç°æœ‰çš„æ‰©å±•è®¾ç½®
                    if (!window.extension_settings[extensionName]) {
                        window.extension_settings[extensionName] = {};
                    }

                    // åªä¿å­˜å® ç‰©æ•°æ®ï¼Œä¸å½±å“å…¶ä»–è®¾ç½®
                    window.extension_settings[extensionName][`${extensionName}_pet_data`] = data;

                    // ä½¿ç”¨å®‰å…¨çš„ä¿å­˜æœºåˆ¶
                    if (safeSillyTavernSave()) {
                        console.log(`[${extensionName}] æ•°æ®å·²ä¿å­˜åˆ°SillyTavernè®¾ç½®`);
                    }
                } catch (settingsError) {
                    console.warn(`[${extensionName}] SillyTavernè®¾ç½®ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:`, settingsError);
                }
            }

            console.log(`[${extensionName}] æ•°æ®å·²ä¿å­˜åˆ°åŒæ­¥å­˜å‚¨`);
        } catch (error) {
            console.warn(`[${extensionName}] åŒæ­¥å­˜å‚¨ä¿å­˜å¤±è´¥:`, error);
        }
    }

    /**
     * ä»åŒæ­¥å­˜å‚¨åŠ è½½æ•°æ®
     */
    function loadFromSyncStorage() {
        try {
            // é¦–å…ˆå°è¯•ä»SillyTavernè®¾ç½®åŠ è½½
            if (typeof window.extension_settings === 'object' &&
                window.extension_settings[extensionName] &&
                window.extension_settings[extensionName][`${extensionName}_pet_data`]) {

                const syncData = window.extension_settings[extensionName][`${extensionName}_pet_data`];
                console.log(`[${extensionName}] ä»SillyTavernè®¾ç½®åŠ è½½åŒæ­¥æ•°æ®`);
                return syncData;
            }

            // å…¶æ¬¡å°è¯•ä»åŒæ­¥é”®åŠ è½½
            const syncKey = `${extensionName}-sync-data`;
            const syncData = localStorage.getItem(syncKey);
            if (syncData) {
                console.log(`[${extensionName}] ä»åŒæ­¥å­˜å‚¨åŠ è½½æ•°æ®`);
                return JSON.parse(syncData);
            }

            return null;
        } catch (error) {
            console.warn(`[${extensionName}] åŒæ­¥å­˜å‚¨åŠ è½½å¤±è´¥:`, error);
            return null;
        }
    }

    /**
     * ä¿å­˜AIè®¾ç½®åˆ°åŒæ­¥å­˜å‚¨ - å®‰å…¨ç‰ˆæœ¬
     */
    function saveAISettingsToSync(settings) {
        try {
            // ä½¿ç”¨ä¸“é—¨çš„AIè®¾ç½®åŒæ­¥é”®
            const syncKey = `${extensionName}-ai-settings-sync`;
            localStorage.setItem(syncKey, JSON.stringify(settings));

            // å®‰å…¨åœ°å°è¯•ä½¿ç”¨SillyTavernçš„åŒæ­¥æœºåˆ¶
            if (typeof window.saveSettingsDebounced === 'function' &&
                typeof window.extension_settings === 'object' &&
                window.extension_settings !== null) {

                try {
                    // ç¡®ä¿ä¸è¦†ç›–ç°æœ‰çš„æ‰©å±•è®¾ç½®
                    if (!window.extension_settings[extensionName]) {
                        window.extension_settings[extensionName] = {};
                    }

                    // åªä¿å­˜AIè®¾ç½®ï¼Œä¸å½±å“å…¶ä»–è®¾ç½®
                    window.extension_settings[extensionName][`${extensionName}_ai_settings`] = settings;

                    // ä½¿ç”¨å®‰å…¨çš„ä¿å­˜æœºåˆ¶
                    if (safeSillyTavernSave()) {
                        console.log(`[${extensionName}] AIè®¾ç½®å·²ä¿å­˜åˆ°SillyTavernè®¾ç½®`);
                    }
                } catch (settingsError) {
                    console.warn(`[${extensionName}] SillyTavern AIè®¾ç½®ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:`, settingsError);
                }
            }

            console.log(`[${extensionName}] AIè®¾ç½®å·²ä¿å­˜åˆ°åŒæ­¥å­˜å‚¨`);
        } catch (error) {
            console.warn(`[${extensionName}] AIè®¾ç½®åŒæ­¥å­˜å‚¨ä¿å­˜å¤±è´¥:`, error);
        }
    }

    /**
     * ä»åŒæ­¥å­˜å‚¨åŠ è½½AIè®¾ç½®
     */
    function loadAISettingsFromSync() {
        try {
            // é¦–å…ˆå°è¯•ä»SillyTavernè®¾ç½®åŠ è½½
            if (typeof window.extension_settings === 'object' &&
                window.extension_settings[extensionName] &&
                window.extension_settings[extensionName][`${extensionName}_ai_settings`]) {

                const syncSettings = window.extension_settings[extensionName][`${extensionName}_ai_settings`];
                console.log(`[${extensionName}] ä»SillyTavernè®¾ç½®åŠ è½½AIåŒæ­¥è®¾ç½®`);
                return syncSettings;
            }

            // å…¶æ¬¡å°è¯•ä»åŒæ­¥é”®åŠ è½½
            const syncKey = `${extensionName}-ai-settings-sync`;
            const syncSettings = localStorage.getItem(syncKey);
            if (syncSettings) {
                console.log(`[${extensionName}] ä»åŒæ­¥å­˜å‚¨åŠ è½½AIè®¾ç½®`);
                return JSON.parse(syncSettings);
            }

            return null;
        } catch (error) {
            console.warn(`[${extensionName}] AIè®¾ç½®åŒæ­¥å­˜å‚¨åŠ è½½å¤±è´¥:`, error);
            return null;
        }
    }

    /**
     * ä¿å­˜å¤´åƒåˆ°åŒæ­¥å­˜å‚¨ - å®‰å…¨ç‰ˆæœ¬
     */
    function saveAvatarToSync(avatarData) {
        try {
            // ä½¿ç”¨ä¸“é—¨çš„å¤´åƒåŒæ­¥é”®
            const syncKey = `${extensionName}-avatar-sync`;
            localStorage.setItem(syncKey, avatarData);

            // å®‰å…¨åœ°å°è¯•ä½¿ç”¨SillyTavernçš„åŒæ­¥æœºåˆ¶
            // æ³¨æ„ï¼šå¤´åƒæ•°æ®å¯èƒ½å¾ˆå¤§ï¼Œè°¨æ…ä¿å­˜åˆ°SillyTavernè®¾ç½®
            if (typeof window.saveSettingsDebounced === 'function' &&
                typeof window.extension_settings === 'object' &&
                window.extension_settings !== null &&
                avatarData.length < 500000) { // é™åˆ¶å¤´åƒå¤§å° < 500KB

                try {
                    // ç¡®ä¿ä¸è¦†ç›–ç°æœ‰çš„æ‰©å±•è®¾ç½®
                    if (!window.extension_settings[extensionName]) {
                        window.extension_settings[extensionName] = {};
                    }

                    // åªä¿å­˜å¤´åƒï¼Œä¸å½±å“å…¶ä»–è®¾ç½®
                    window.extension_settings[extensionName][`${extensionName}_avatar`] = avatarData;

                    // ä½¿ç”¨å®‰å…¨çš„ä¿å­˜æœºåˆ¶
                    if (safeSillyTavernSave()) {
                        console.log(`[${extensionName}] å¤´åƒå·²ä¿å­˜åˆ°SillyTavernè®¾ç½®`);
                    }
                } catch (settingsError) {
                    console.warn(`[${extensionName}] SillyTavernå¤´åƒä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:`, settingsError);
                }
            } else if (avatarData.length >= 500000) {
                console.log(`[${extensionName}] å¤´åƒè¿‡å¤§(${Math.round(avatarData.length/1024)}KB)ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨`);
            }

            console.log(`[${extensionName}] å¤´åƒå·²ä¿å­˜åˆ°åŒæ­¥å­˜å‚¨`);
        } catch (error) {
            console.warn(`[${extensionName}] å¤´åƒåŒæ­¥å­˜å‚¨ä¿å­˜å¤±è´¥:`, error);
        }
    }

    /**
     * ä»åŒæ­¥å­˜å‚¨åŠ è½½å¤´åƒ
     */
    function loadAvatarFromSync() {
        try {
            // é¦–å…ˆå°è¯•ä»SillyTavernè®¾ç½®åŠ è½½
            if (typeof window.extension_settings === 'object' &&
                window.extension_settings[extensionName] &&
                window.extension_settings[extensionName][`${extensionName}_avatar`]) {

                const syncAvatar = window.extension_settings[extensionName][`${extensionName}_avatar`];
                console.log(`[${extensionName}] ä»SillyTavernè®¾ç½®åŠ è½½å¤´åƒåŒæ­¥æ•°æ®`);
                return syncAvatar;
            }

            // å…¶æ¬¡å°è¯•ä»åŒæ­¥é”®åŠ è½½
            const syncKey = `${extensionName}-avatar-sync`;
            const syncAvatar = localStorage.getItem(syncKey);
            if (syncAvatar) {
                console.log(`[${extensionName}] ä»åŒæ­¥å­˜å‚¨åŠ è½½å¤´åƒ`);
                return syncAvatar;
            }

            return null;
        } catch (error) {
            console.warn(`[${extensionName}] å¤´åƒåŒæ­¥å­˜å‚¨åŠ è½½å¤±è´¥:`, error);
            return null;
        }
    }

    /**
     * ä»åŒæ­¥å­˜å‚¨æ¸…é™¤å¤´åƒ - å®‰å…¨ç‰ˆæœ¬
     */
    function clearAvatarFromSync() {
        try {
            // æ¸…é™¤åŒæ­¥é”®
            const syncKey = `${extensionName}-avatar-sync`;
            localStorage.removeItem(syncKey);

            // å®‰å…¨åœ°å°è¯•ä»SillyTavernè®¾ç½®ä¸­æ¸…é™¤
            if (typeof window.saveSettingsDebounced === 'function' &&
                typeof window.extension_settings === 'object' &&
                window.extension_settings !== null &&
                window.extension_settings[extensionName]) {

                try {
                    // åªåˆ é™¤å¤´åƒï¼Œä¸å½±å“å…¶ä»–è®¾ç½®
                    delete window.extension_settings[extensionName][`${extensionName}_avatar`];

                    // ä½¿ç”¨å®‰å…¨çš„ä¿å­˜æœºåˆ¶
                    if (safeSillyTavernSave()) {
                        console.log(`[${extensionName}] å¤´åƒå·²ä»SillyTavernè®¾ç½®æ¸…é™¤`);
                    }
                } catch (settingsError) {
                    console.warn(`[${extensionName}] SillyTavernå¤´åƒæ¸…é™¤å¤±è´¥:`, settingsError);
                }
            }

            console.log(`[${extensionName}] å¤´åƒå·²ä»åŒæ­¥å­˜å‚¨æ¸…é™¤`);
        } catch (error) {
            console.warn(`[${extensionName}] å¤´åƒåŒæ­¥å­˜å‚¨æ¸…é™¤å¤±è´¥:`, error);
        }
    }
    
    /**
     * éªŒè¯å¹¶ä¿®å¤æ•°å€¼èŒƒå›´
     */
    function validateAndFixValues() {
        // ç¡®ä¿æ‰€æœ‰æ•°å€¼éƒ½åœ¨0-100èŒƒå›´å†…
        petData.health = Math.max(0, Math.min(100, Number(petData.health) || 0));
        petData.happiness = Math.max(0, Math.min(100, Number(petData.happiness) || 0));
        petData.hunger = Math.max(0, Math.min(100, Number(petData.hunger) || 0));
        petData.energy = Math.max(0, Math.min(100, Number(petData.energy) || 0));
        petData.experience = Math.max(0, Number(petData.experience) || 0);
        petData.level = Math.max(1, Number(petData.level) || 1);

        // ç¡®ä¿æ—¶é—´æˆ³æ˜¯æœ‰æ•ˆçš„
        const now = Date.now();
        if (!petData.lastUpdateTime || petData.lastUpdateTime > now) {
            petData.lastUpdateTime = now;
        }
        if (!petData.lastFeedTime || petData.lastFeedTime > now) {
            petData.lastFeedTime = now;
        }
        if (!petData.lastPlayTime || petData.lastPlayTime > now) {
            petData.lastPlayTime = now;
        }
        if (!petData.lastSleepTime || petData.lastSleepTime > now) {
            petData.lastSleepTime = now;
        }
    }

    /**
     * æ›´æ–°å® ç‰©çŠ¶æ€ï¼ˆåŸºäºæ—¶é—´æµé€ï¼‰
     */
    function updatePetStatus() {
        const now = Date.now();
        const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
        const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);

        // é˜²æ­¢å¼‚å¸¸å¤§çš„æ—¶é—´å·®ï¼ˆè¶…è¿‡24å°æ—¶çš„æŒ‰24å°æ—¶è®¡ç®—ï¼‰
        const safeHoursElapsed = Math.min(hoursElapsed, 24);

        // éšæ—¶é—´é™ä½çš„å±æ€§ï¼ˆå‡ç¼“è¡°å‡é€Ÿåº¦ï¼‰
        if (safeHoursElapsed > 0.2) { // æ¯12åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            petData.hunger = Math.max(0, petData.hunger - safeHoursElapsed * 0.8);
            petData.energy = Math.max(0, petData.energy - safeHoursElapsed * 0.6);

            // é¥¥é¥¿å’Œç–²åŠ³å½±å“å¥åº·å’Œå¿«ä¹ï¼ˆå‡ç¼“å½±å“ï¼‰
            if (petData.hunger < 20) {
                petData.health = Math.max(0, petData.health - safeHoursElapsed * 1);
                petData.happiness = Math.max(0, petData.happiness - safeHoursElapsed * 0.8);
            }

            if (petData.energy < 20) {
                petData.happiness = Math.max(0, petData.happiness - safeHoursElapsed * 0.5);
            }

            petData.lastUpdateTime = now;

            // éªŒè¯å¹¶ä¿®å¤æ•°å€¼
            validateAndFixValues();

            savePetData();

            // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€é€šçŸ¥
            checkAndSendNotifications();
        }
    }
    

    
    /**
     * è·å¾—ç»éªŒå€¼
     */
    function gainExperience(exp) {
        petData.experience += exp;
        const expNeeded = petData.level * 100;

        if (petData.experience >= expNeeded) {
            petData.level++;
            petData.experience -= expNeeded;
            petData.health = Math.min(100, petData.health + 30); // å‡çº§æ¢å¤éƒ¨åˆ†å¥åº·

            // å‡çº§å¥–åŠ±é‡‘å¸
            const coinReward = petData.level * 10;
            gainCoins(coinReward);

            toastr.success(`ğŸ‰ ${petData.name} å‡çº§äº†ï¼ç°åœ¨æ˜¯ ${petData.level} çº§ï¼è·å¾— ${coinReward} é‡‘å¸å¥–åŠ±ï¼`);
        }
    }

    /**
     * è·å¾—é‡‘å¸
     */
    function gainCoins(amount) {
        if (!petData.coins) petData.coins = 100;
        petData.coins += amount;
        console.log(`ğŸ’° è·å¾— ${amount} é‡‘å¸ï¼Œå½“å‰é‡‘å¸: ${petData.coins}`);

        // ç«‹å³æ›´æ–°UIæ˜¾ç¤º
        setTimeout(() => {
            if (typeof updateUnifiedUIStatus === 'function') {
                updateUnifiedUIStatus();
            }
            if (typeof renderPetStatus === 'function') {
                renderPetStatus();
            }
        }, 50);
    }

    /**
     * æ£€æŸ¥å¹¶å‘é€é€šçŸ¥
     */
    function checkAndSendNotifications() {
        const notifications = localStorage.getItem(`${extensionName}-notifications`) !== "false";
        if (!notifications) return;

        const now = Date.now();
        const lastNotification = localStorage.getItem(`${extensionName}-last-notification`) || 0;

        // é™åˆ¶é€šçŸ¥é¢‘ç‡ï¼Œè‡³å°‘é—´éš”10åˆ†é’Ÿ
        if (now - lastNotification < 600000) return;

        let needsAttention = false;
        let message = `${petData.name} éœ€è¦ä½ çš„å…³æ³¨ï¼`;

        if (petData.health < 30) {
            message = `${petData.name} çš„å¥åº·çŠ¶å†µä¸ä½³ï¼Œå¿«æ¥ç…§é¡¾å®ƒå§ï¼`;
            needsAttention = true;
        } else if (petData.hunger < 20) {
            message = `${petData.name} é¥¿äº†ï¼Œè¯¥å–‚é£Ÿäº†ï¼`;
            needsAttention = true;
        } else if (petData.happiness < 30) {
            message = `${petData.name} çœ‹èµ·æ¥ä¸å¤ªå¼€å¿ƒï¼Œé™ªå®ƒç©ç©å§ï¼`;
            needsAttention = true;
        } else if (petData.energy < 20) {
            message = `${petData.name} å¾ˆç´¯äº†ï¼Œè®©å®ƒä¼‘æ¯ä¸€ä¸‹å§ï¼`;
            needsAttention = true;
        }

        if (needsAttention) {
            toastr.warning(message, "å® ç‰©æé†’", {
                timeOut: 8000,
                extendedTimeOut: 3000
            });
            localStorage.setItem(`${extensionName}-last-notification`, now);
        }
    }
    
    // ----------------------------------------------------------------- 
    // 3. å¼¹çª—å’Œè§†å›¾ç®¡ç†
    // -----------------------------------------------------------------
    
    /**
     * æ‰“å¼€å¼¹çª—å¹¶æ˜¾ç¤ºä¸»è§†å›¾
     */
    function showPopup() {
        console.log(`[${extensionName}] Attempting to show popup`);

        // æ£€æµ‹è®¾å¤‡ç±»å‹ - ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¹³å°
        const windowWidth = $(window).width();
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMobile = windowWidth <= 767 || isIOS || isAndroid;

        console.log(`[${extensionName}] Device: iOS=${isIOS}, Android=${isAndroid}, Mobile=${isMobile}, Width=${windowWidth}`);

        // ç›´æ¥é€šè¿‡IDæŸ¥æ‰¾å…ƒç´ ï¼Œä¸ä¾èµ–å…¨å±€å˜é‡
        let overlayElement = $(`#${OVERLAY_ID}`);

        // æ¸…é™¤æ‰€æœ‰ç°æœ‰å¼¹çª—ï¼Œç¡®ä¿ç»Ÿä¸€
        $(`#${OVERLAY_ID}`).remove();
        $(".virtual-pet-popup-overlay").remove();

        console.log(`[${extensionName}] Creating unified popup for all platforms`);

        // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´æ ·å¼
        const containerMaxWidth = isMobile ? "300px" : "380px";
        const containerPadding = isMobile ? "14px" : "18px";
        const borderRadius = isIOS ? "16px" : "12px";
        const iosTransform = isIOS ? "-webkit-transform: translateZ(0) !important; transform: translateZ(0) !important;" : "";

        // åˆ›å»ºç»Ÿä¸€çš„å¼¹çª—HTML
        const unifiedPopupHtml = `
            <div id="${OVERLAY_ID}" class="virtual-pet-popup-overlay" style="
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.8) !important;
                z-index: ${SAFE_Z_INDEX.overlay} !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 10px !important;
                box-sizing: border-box !important;
                -webkit-overflow-scrolling: touch !important;
                overflow: hidden !important;
                ${iosTransform}
            ">
                <div id="${POPUP_ID}" class="pet-popup-container" style="
                    position: relative !important;
                    width: 100% !important;
                    height: auto !important;
                    max-width: ${containerMaxWidth} !important;
                    max-height: calc(100vh - 60px) !important;
                    background: ${candyColors.background} !important;
                    color: ${candyColors.textPrimary} !important;
                    border: 4px solid ${candyColors.border} !important;
                    border-radius: 8px !important;
                    padding: ${containerPadding} !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch !important;
                    box-shadow: 4px 4px 0px ${candyColors.shadow} !important;
                    font-family: 'Courier New', monospace !important;
                    image-rendering: pixelated !important;
                    image-rendering: -moz-crisp-edges !important;
                    image-rendering: crisp-edges !important;
                    ${iosTransform}
                ">
                    ${generateUnifiedUI()}
                </div>
            </div>
        `;

            $("body").append(unifiedPopupHtml);
            overlayElement = $(`#${OVERLAY_ID}`);

            // ç»‘å®šå¤–éƒ¨ç‚¹å‡»å…³é—­äº‹ä»¶
            if (isIOS) {
                // iOSå¤–éƒ¨ç‚¹å‡»å…³é—­
                overlayElement.on("touchstart", function(e) {
                    if (e.target === this) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(`[${extensionName}] iOS overlay touched - closing popup`);
                        closePopup();
                    }
                });
            } else {
                // éiOSè®¾å¤‡çš„å¤–éƒ¨ç‚¹å‡»å…³é—­
                overlayElement.on("click touchend", function(e) {
                    if (e.target === this) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(`[${extensionName}] Overlay clicked - closing popup`);
                        closePopup();
                    }
                });
            }

            // ç»‘å®šç»Ÿä¸€çš„æ“ä½œæŒ‰é’®äº‹ä»¶
            bindUnifiedUIEvents(overlayElement);

        console.log(`[${extensionName}] Unified popup created and displayed for all platforms`);

        // æ›´æ–°å¼¹çª—çŠ¶æ€
        isPopupOpen = true;
    }
    
    /**
     * å…³é—­å¼¹çª— - iOSä¼˜åŒ–ç‰ˆæœ¬
     */
    function closePopup() {
        console.log(`[${extensionName}] Closing popup`);

        // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å¼¹çª—å…ƒç´ 
        const overlayElement = $(`#${OVERLAY_ID}`);
        const allOverlays = $(".virtual-pet-popup-overlay");

        if (overlayElement.length > 0) {
            // ä½¿ç”¨åŠ¨ç”»å…³é—­ï¼ŒiOSä½“éªŒæ›´å¥½
            overlayElement.fadeOut(200, function() {
                $(this).remove();
                console.log(`[${extensionName}] Popup closed with animation`);
            });
        } else if (allOverlays.length > 0) {
            // å¤‡ç”¨æ–¹æ¡ˆï¼šç§»é™¤æ‰€æœ‰å¼¹çª—
            allOverlays.fadeOut(200, function() {
                $(this).remove();
                console.log(`[${extensionName}] All popups closed`);
            });
        } else {
            console.log(`[${extensionName}] No popup found to close`);
        }

        // å¼ºåˆ¶æ¸…ç†ï¼Œç¡®ä¿iOSä¸Šå®Œå…¨å…³é—­
        setTimeout(() => {
            $(`#${OVERLAY_ID}`).remove();
            $(".virtual-pet-popup-overlay").remove();
        }, 250);

        // æ›´æ–°å¼¹çª—çŠ¶æ€
        isPopupOpen = false;
    }

    /**
     * æ‰“å¼€å¤´åƒé€‰æ‹©å™¨
     */
    window.openAvatarSelector = function() {
        console.log(`[${extensionName}] Opening avatar selector`);

        // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';

        fileInput.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº2MBçš„å›¾ç‰‡');
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºbase64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;

                    // ä¿å­˜å¤´åƒæ•°æ®
                    if (saveCustomAvatar(imageData)) {
                        // æ›´æ–°æ˜¾ç¤º
                        updateAvatarDisplay();
                        updateFloatingButtonAvatar();
                        console.log(`[${extensionName}] Avatar updated successfully`);
                    } else {
                        alert('ä¿å­˜å¤´åƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                };
                reader.readAsDataURL(file);
            }

            // æ¸…ç†æ–‡ä»¶è¾“å…¥å…ƒç´ 
            document.body.removeChild(fileInput);
        };

        // æ·»åŠ åˆ°DOMå¹¶è§¦å‘ç‚¹å‡»
        document.body.appendChild(fileInput);
        fileInput.click();
    };

    /**
     * é‡ç½®å¤´åƒä¸ºé»˜è®¤
     */
    window.resetAvatar = function() {
        console.log(`[${extensionName}] Resetting avatar to default`);

        if (clearCustomAvatar()) {
            // æ›´æ–°æ˜¾ç¤º
            updateAvatarDisplay();
            updateFloatingButtonAvatar();
            console.log(`[${extensionName}] Avatar reset successfully`);
        } else {
            alert('é‡ç½®å¤´åƒå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    };

    /**
     * ç¼–è¾‘å® ç‰©åå­—
     */
    window.editPetName = function() {
        const currentName = petData.name;
        const newName = prompt('è¯·è¾“å…¥æ–°çš„å® ç‰©åå­—:', currentName);

        if (newName && newName.trim() && newName.trim() !== currentName) {
            const trimmedName = newName.trim();
            if (trimmedName.length > 20) {
                alert('å® ç‰©åå­—ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦ï¼');
                return;
            }

            petData.name = trimmedName;
            savePetData();

            // æ›´æ–°æ‰€æœ‰UIä¸­çš„åå­—æ˜¾ç¤º
            updateUnifiedUIStatus();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            if (typeof toastr !== 'undefined') {
                toastr.success(`å® ç‰©åå­—å·²æ›´æ”¹ä¸º "${trimmedName}"`);
            } else {
                alert(`å® ç‰©åå­—å·²æ›´æ”¹ä¸º "${trimmedName}"`);
            }
        }
    };

    /**
     * æ›´æ–°ç»Ÿä¸€UIä¸­çš„çŠ¶æ€æ˜¾ç¤º
     */
    function updateUnifiedUIStatus() {
        // æ›´æ–°ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯UIä¸­çš„çŠ¶æ€æ¡
        const healthBars = $('.status-item').find('div[style*="background: ' + candyColors.health + '"]');
        const hungerBars = $('.status-item').find('div[style*="background: ' + candyColors.warning + '"]');
        const happinessBars = $('.status-item').find('div[style*="background: ' + candyColors.happiness + '"]');

        // æ›´æ–°å¥åº·çŠ¶æ€
        healthBars.each(function() {
            $(this).css('width', petData.health + '%');
        });

        // æ›´æ–°é¥±é£Ÿåº¦çŠ¶æ€
        hungerBars.each(function() {
            $(this).css('width', petData.hunger + '%');
        });

        // æ›´æ–°å¿«ä¹åº¦çŠ¶æ€
        happinessBars.each(function() {
            $(this).css('width', petData.happiness + '%');
        });

        // æ›´æ–°æ•°å€¼æ˜¾ç¤º
        $('.status-item').each(function() {
            const $item = $(this);
            const label = $item.find('span').first().text();

            if (label.includes('å¥åº·')) {
                $item.find('span').last().text(Math.round(petData.health) + '/100');
            } else if (label.includes('é¥±é£Ÿåº¦')) {
                $item.find('span').last().text(Math.round(petData.hunger) + '/100');
            } else if (label.includes('å¿«ä¹åº¦')) {
                $item.find('span').last().text(Math.round(petData.happiness) + '/100');
            }
        });

        // æ›´æ–°å® ç‰©åå­—å’Œç­‰çº§
        $('.pet-name').each(function() {
            $(this).text(petData.name);
            // ç¡®ä¿ç‚¹å‡»äº‹ä»¶ä»ç„¶å­˜åœ¨
            if (!$(this).attr('onclick')) {
                $(this).attr('onclick', 'editPetName()');
                $(this).attr('title', 'ç‚¹å‡»ç¼–è¾‘å® ç‰©åå­—');
                $(this).css({
                    'cursor': 'pointer',
                    'text-decoration': 'underline'
                });
            }
        });
        $('.pet-level').text('Lv.' + petData.level);
    }

    /**
     * æ˜¾ç¤ºå¤´åƒå³é”®èœå•
     */
    window.showAvatarContextMenu = function(event) {
        event.preventDefault();

        if (customAvatarData) {
            // å¦‚æœæœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæ˜¾ç¤ºé‡ç½®é€‰é¡¹
            if (confirm('æ˜¯å¦è¦é‡ç½®å¤´åƒä¸ºé»˜è®¤æ ·å¼ï¼Ÿ')) {
                resetAvatar();
            }
        } else {
            // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»æ›´æ¢
            alert('ç‚¹å‡»å¤´åƒå¯ä»¥æ›´æ¢ä¸ºè‡ªå®šä¹‰å›¾ç‰‡');
        }

        return false;
    };

    /**
     * æ›´æ–°å¤´åƒæ˜¾ç¤º
     */
    function updateAvatarDisplay() {
        // æ›´æ–°å¼¹çª—ä¸­çš„å¤´åƒ
        const avatarCircle = $('.pet-avatar-circle');
        if (avatarCircle.length > 0) {
            avatarCircle.html(getAvatarContent());
        }
    }

    /**
     * æ›´æ–°æ‚¬æµ®æŒ‰é’®å¤´åƒ
     */
    function updateFloatingButtonAvatar() {
        const button = $(`#${BUTTON_ID}`);
        if (button.length > 0) {
            if (customAvatarData) {
                // æ˜¾ç¤ºè‡ªå®šä¹‰å¤´åƒ
                button.html(`<img src="${customAvatarData}" alt="å® ç‰©å¤´åƒ" style="
                    width: 100% !important;
                    height: 100% !important;
                    object-fit: cover !important;
                    border-radius: 50% !important;
                ">`);
            } else {
                // æ˜¾ç¤ºé»˜è®¤çˆªå­å›¾æ¡ˆ
                button.html('ğŸ¾');
            }
        }
    }

    /**
     * åˆ‡æ¢å¼¹çª—çŠ¶æ€ - å¦‚æœå¼¹çª—æ‰“å¼€åˆ™å…³é—­ï¼Œå¦‚æœå…³é—­åˆ™æ‰“å¼€
     */
    function togglePopup() {
        console.log(`[${extensionName}] Toggling popup, current state: ${isPopupOpen ? 'open' : 'closed'}`);

        if (isPopupOpen) {
            // å¼¹çª—å·²æ‰“å¼€ï¼Œå…³é—­å®ƒ
            closePopup();
        } else {
            // å¼¹çª—å·²å…³é—­ï¼Œæ‰“å¼€å®ƒ
            showPopup();
        }
    }
    
    /**
     * åˆ‡æ¢åˆ°æŒ‡å®šè§†å›¾
     */
    function switchView(viewIdToShow) {
        console.log(`[${extensionName}] åˆ‡æ¢è§†å›¾ï¼Œç›®æ ‡è§†å›¾: #${viewIdToShow}`);
        
        // éšè—æ‰€æœ‰ .pet-view å…ƒç´ 
        $('.pet-view').hide();

        // æ˜¾ç¤ºç›®æ ‡è§†å›¾
        const $view = $(`#${viewIdToShow}`);
        if ($view.length > 0) {
            $view.show();
            console.log(`[${extensionName}] è§†å›¾ #${viewIdToShow} å·²æ˜¾ç¤º`);
        } else {
            console.error(`[${extensionName}] é”™è¯¯: è§†å›¾ #${viewIdToShow} ä¸å­˜åœ¨`);
        }
    }
    
    /**
     * æ˜¾ç¤ºä¸»è§†å›¾
     */
    function showMainView() {
        switchView('pet-main-view');
        renderPetStatus();
    }
    
    /**
     * æ˜¾ç¤ºå® ç‰©è¯¦æƒ…è§†å›¾
     */
    function showPetView() {
        switchView('pet-detail-view');
        renderPetDetails();
    }
    
    /**
     * æ˜¾ç¤ºè®¾ç½®è§†å›¾
     */
    function showSettingsView() {
        switchView('pet-settings-view');
        renderSettings();
    }

    // showChatViewå‡½æ•°å·²è¢«ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨openChatModal()æ›¿ä»£

    /**
     * æµ‹è¯•èŠå¤©æ¨¡æ€å¼¹çª—åŠŸèƒ½ - æ›´æ–°ä¸ºå•†åº—é£æ ¼ç‰ˆæœ¬
     */
    window.testChatModal = function() {
        console.log(`[${extensionName}] ğŸ§ª æµ‹è¯•æ–°ç‰ˆèŠå¤©æ¨¡æ€å¼¹çª—åŠŸèƒ½...`);

        try {
            // æµ‹è¯•æ‰“å¼€èŠå¤©æ¨¡æ€å¼¹çª—
            console.log(`[${extensionName}] 1. æµ‹è¯•æ‰“å¼€å•†åº—é£æ ¼èŠå¤©æ¨¡æ€å¼¹çª—...`);
            openChatModal();

            // æ£€æŸ¥æ¨¡æ€å¼¹çª—æ˜¯å¦åˆ›å»ºæˆåŠŸ
            setTimeout(() => {
                const modal = $('#chat-modal-overlay');
                const container = $('#chat-modal-container');
                const input = $('#chat-modal-input');
                const sendBtn = $('#chat-modal-send-btn');
                const messages = $('#chat-modal-messages');
                const closeBtn = $('#chat-modal-close-btn');

                console.log(`[${extensionName}] 2. æ£€æŸ¥DOMå…ƒç´ ...`);
                console.log(`   - æ¨¡æ€å¼¹çª—é®ç½©: ${modal.length > 0 ? 'âœ…' : 'âŒ'}`);
                console.log(`   - å¼¹çª—å®¹å™¨: ${container.length > 0 ? 'âœ…' : 'âŒ'}`);
                console.log(`   - è¾“å…¥æ¡†: ${input.length > 0 ? 'âœ…' : 'âŒ'}`);
                console.log(`   - å‘é€æŒ‰é’®: ${sendBtn.length > 0 ? 'âœ…' : 'âŒ'}`);
                console.log(`   - æ¶ˆæ¯å®¹å™¨: ${messages.length > 0 ? 'âœ…' : 'âŒ'}`);
                console.log(`   - å…³é—­æŒ‰é’®: ${closeBtn.length > 0 ? 'âœ…' : 'âŒ'}`);

                // æ£€æŸ¥æ ·å¼åº”ç”¨
                console.log(`[${extensionName}] 3. æ£€æŸ¥å•†åº—é£æ ¼æ ·å¼...`);
                const modalBg = modal.css('background-color');
                const containerBg = container.css('background');
                console.log(`   - é®ç½©èƒŒæ™¯: ${modalBg.includes('rgba') ? 'âœ…' : 'âŒ'}`);
                console.log(`   - å®¹å™¨æ¸å˜: ${containerBg.includes('gradient') || containerBg.includes('linear') ? 'âœ…' : 'âŒ'}`);
                console.log(`   - z-index: ${modal.css('z-index') === '1000001' ? 'âœ…' : 'âŒ'}`);

                // æ£€æŸ¥APIé…ç½®
                const config = getAIConfiguration();
                console.log(`[${extensionName}] 4. æ£€æŸ¥APIé…ç½®...`);
                console.log(`   - APIç±»å‹: ${config.type || 'æœªé…ç½®'}`);
                console.log(`   - API URL: ${config.url || 'æœªé…ç½®'}`);
                console.log(`   - APIå¯†é’¥: ${config.key ? 'å·²é…ç½®' : 'æœªé…ç½®'}`);
                console.log(`   - é…ç½®å®Œæ•´: ${config.isConfigured ? 'âœ…' : 'âŒ'}`);

                // æµ‹è¯•äº¤äº’åŠŸèƒ½
                console.log(`[${extensionName}] 5. æµ‹è¯•äº¤äº’åŠŸèƒ½...`);
                if (input.length > 0) {
                    input.focus();
                    console.log(`   - è¾“å…¥æ¡†èšç„¦: âœ…`);
                }

                // æµ‹è¯•æ·»åŠ æ¶ˆæ¯åŠŸèƒ½
                console.log(`[${extensionName}] 6. æµ‹è¯•æ¶ˆæ¯æ·»åŠ åŠŸèƒ½...`);
                addMessageToChat('user', 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯');
                addMessageToChat('pet', 'è¿™æ˜¯å® ç‰©çš„å›å¤æ¶ˆæ¯');

                const messageCount = messages.children().length;
                console.log(`   - æ¶ˆæ¯æ•°é‡: ${messageCount} (åº”è¯¥ >= 3ï¼ŒåŒ…æ‹¬æ¬¢è¿æ¶ˆæ¯)`);

                console.log(`[${extensionName}] ğŸ‰ æ–°ç‰ˆèŠå¤©æ¨¡æ€å¼¹çª—æµ‹è¯•å®Œæˆï¼`);
                console.log(`[${extensionName}] ğŸ’¡ æç¤º: ç°åœ¨å¯ä»¥å°è¯•åœ¨èŠå¤©æ¡†ä¸­è¾“å…¥æ¶ˆæ¯è¿›è¡Œæµ‹è¯•`);
                console.log(`[${extensionName}] ğŸ¨ æ–°ç‰¹æ€§: å•†åº—é£æ ¼çš„æ¸å˜èƒŒæ™¯å’Œå†…è”æ ·å¼`);
                console.log(`[${extensionName}] ğŸ”§ æµ‹è¯•å…³é—­: ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–å¤–éƒ¨åŒºåŸŸå…³é—­å¼¹çª—`);

            }, 100);

        } catch (error) {
            console.error(`[${extensionName}] âŒ èŠå¤©æ¨¡æ€å¼¹çª—æµ‹è¯•å¤±è´¥:`, error);
        }
    };

    /**
     * å¤„ç†èŠå¤©æŒ‰é’®ç‚¹å‡»
     */
    function handleChatButtonClick() {
        console.log(`[${extensionName}] èŠå¤©æŒ‰é’®è¢«ç‚¹å‡»ï¼Œæ‰“å¼€èŠå¤©æ¨¡æ€å¼¹çª—`);

        // æ£€æŸ¥APIé…ç½®
        const config = getAIConfiguration();
        if (!config.isConfigured) {
            toastr.warning('è¯·å…ˆåœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®AI APIä¿¡æ¯ï¼ˆç±»å‹ã€URLå’Œå¯†é’¥ï¼‰', 'èŠå¤©åŠŸèƒ½éœ€è¦é…ç½®', { timeOut: 5000 });
            return;
        }

        // æ‰“å¼€ç‹¬ç«‹çš„èŠå¤©æ¨¡æ€å¼¹çª—
        openChatModal();
    }
    
    // -----------------------------------------------------------------
    // 3.5. èŠå¤©åŠŸèƒ½é€»è¾‘
    // -----------------------------------------------------------------

    /**
     * åˆå§‹åŒ–èŠå¤©ç•Œé¢
     */
    function initializeChatInterface() {
        console.log(`[${extensionName}] åˆå§‹åŒ–èŠå¤©ç•Œé¢...`);

        // æ£€æŸ¥èŠå¤©è§†å›¾æ˜¯å¦å­˜åœ¨
        const chatViewElement = $('#pet-chat-view');
        console.log(`[${extensionName}] èŠå¤©è§†å›¾å…ƒç´ å­˜åœ¨: ${chatViewElement.length > 0}`);

        // æ£€æŸ¥èŠå¤©å®¹å™¨æ˜¯å¦å­˜åœ¨
        const chatContainer = $('#chat-messages-container');
        console.log(`[${extensionName}] èŠå¤©å®¹å™¨å…ƒç´ å­˜åœ¨: ${chatContainer.length > 0}`);

        // æ£€æŸ¥APIé…ç½®
        const config = getAIConfiguration();
        console.log(`[${extensionName}] APIé…ç½®çŠ¶æ€: ${config.isConfigured ? 'å·²é…ç½®' : 'æœªé…ç½®'}`);

        if (!config.isConfigured) {
            console.log(`[${extensionName}] æ˜¾ç¤ºé…ç½®æç¤º...`);
            // æ˜¾ç¤ºé…ç½®æç¤ºåœ¨èŠå¤©ç•Œé¢å†…
            showChatConfigurationHint();
        } else {
            console.log(`[${extensionName}] æ˜¾ç¤ºæ­£å¸¸èŠå¤©ç•Œé¢...`);
            // é…ç½®å®Œæ•´ï¼Œæ˜¾ç¤ºæ­£å¸¸èŠå¤©ç•Œé¢
            showNormalChatInterface();
        }

        console.log(`[${extensionName}] ç»‘å®šèŠå¤©äº‹ä»¶...`);
        // ç»‘å®šèŠå¤©ç›¸å…³äº‹ä»¶ï¼ˆæ€»æ˜¯ç»‘å®šï¼‰
        bindChatEvents();

        chatInitialized = true;
        console.log(`[${extensionName}] èŠå¤©ç•Œé¢åˆå§‹åŒ–å®Œæˆ`);
    }

    /**
     * æ˜¾ç¤ºèŠå¤©é…ç½®æç¤º
     */
    function showChatConfigurationHint() {
        console.log(`[${extensionName}] å¼€å§‹æ˜¾ç¤ºèŠå¤©é…ç½®æç¤º...`);

        // æ¸…ç©ºèŠå¤©å®¹å™¨
        const container = $('#chat-messages-container');
        console.log(`[${extensionName}] èŠå¤©å®¹å™¨æŸ¥æ‰¾ç»“æœ: ${container.length > 0 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);

        if (container.length === 0) {
            console.error(`[${extensionName}] é”™è¯¯: æ‰¾ä¸åˆ°èŠå¤©æ¶ˆæ¯å®¹å™¨ #chat-messages-container`);
            return;
        }

        container.empty();
        console.log(`[${extensionName}] èŠå¤©å®¹å™¨å·²æ¸…ç©º`);


        // æ·»åŠ é…ç½®æç¤º
        const configHint = `
            <div class="chat-config-hint" style="text-align: center; padding: 20px;">
                <div style="font-size: 3em; margin-bottom: 15px;">ğŸ¤–</div>
                <h3 style="color: var(--primary-accent-color); margin-bottom: 15px;">éœ€è¦é…ç½®AI API</h3>
                <p style="margin-bottom: 15px; line-height: 1.5;">
                    è¦ä¸å® ç‰©èŠå¤©ï¼Œéœ€è¦å…ˆé…ç½®AI APIã€‚<br>
                </p>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 10px;">ğŸ“‹ é…ç½®æ­¥éª¤ï¼š</div>
                    <ol style="margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li>ç‚¹å‡»å³ä¸Šè§’çš„ <strong>æ‰©å±•</strong> æŒ‰é’® (ğŸ§©)</li>
                        <li>æ‰¾åˆ° <strong>ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ</strong> è®¾ç½®</li>
                        <li>åœ¨ <strong>ğŸ¤– AI API é…ç½®</strong> éƒ¨åˆ†å¡«å†™ï¼š
                            <ul style="margin-top: 5px;">
                                <li>é€‰æ‹©APIç±»å‹ï¼ˆå¦‚OpenAIã€Claudeç­‰ï¼‰</li>
                                <li>å¡«å†™API URL</li>
                                <li>å¡«å†™APIå¯†é’¥</li>
                            </ul>
                        </li>
                        <li>ç‚¹å‡» <strong>ğŸ”— æµ‹è¯•è¿æ¥</strong> éªŒè¯é…ç½®</li>
                    </ol>
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 20px; text-align: left; border-left: 4px solid #ffc107;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">ğŸ’¡ å¸¸ç”¨APIæ¨èï¼š</div>
                    <div style="font-size: 0.9em; color: #856404; line-height: 1.5;">
                        â€¢ <strong>OpenAI</strong>ï¼šhttps://api.openai.com/v1<br>
                        â€¢ <strong>æœ¬åœ°Ollama</strong>ï¼šhttp://localhost:11434/v1<br>
                        â€¢ <strong>LM Studio</strong>ï¼šhttp://localhost:1234/v1<br>
                        â€¢ <strong>ç¬¬ä¸‰æ–¹ä»£ç†</strong>ï¼šæ ¹æ®æä¾›å•†æ–‡æ¡£é…ç½®
                    </div>
                </div>
                <button id="goto-settings-from-chat-view" class="pet-button success">
                    âš™ï¸ å»é…ç½®
                </button>
            </div>
        `;

        container.html(configHint);
        console.log(`[${extensionName}] é…ç½®æç¤ºHTMLå·²æ·»åŠ `);

        // ç»‘å®šå»é…ç½®æŒ‰é’®äº‹ä»¶
        const configButton = $('#goto-settings-from-chat-view');
        console.log(`[${extensionName}] é…ç½®æŒ‰é’®æŸ¥æ‰¾ç»“æœ: ${configButton.length > 0 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);

        configButton.on('click', function() {
            console.log(`[${extensionName}] é…ç½®æŒ‰é’®è¢«ç‚¹å‡»ï¼Œè·³è½¬åˆ°è®¾ç½®è§†å›¾`);
            showSettingsView();
        });

        // ç¦ç”¨èŠå¤©è¾“å…¥
        const chatInput = $('#chat-input');
        const sendButton = $('#send-chat-btn');

        console.log(`[${extensionName}] èŠå¤©è¾“å…¥æ¡†æŸ¥æ‰¾ç»“æœ: ${chatInput.length > 0 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);
        console.log(`[${extensionName}] å‘é€æŒ‰é’®æŸ¥æ‰¾ç»“æœ: ${sendButton.length > 0 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);

        chatInput.prop('disabled', true).attr('placeholder', 'è¯·å…ˆé…ç½®AI API...');
        sendButton.prop('disabled', true);

        console.log(`[${extensionName}] èŠå¤©é…ç½®æç¤ºæ˜¾ç¤ºå®Œæˆ`);
    }

    /**
     * æ˜¾ç¤ºæ­£å¸¸èŠå¤©ç•Œé¢
     */
    function showNormalChatInterface() {
        // å¯ç”¨èŠå¤©è¾“å…¥
        $('#chat-input').prop('disabled', false).attr('placeholder', 'è¾“å…¥æ¶ˆæ¯...');

        // åŠ è½½èŠå¤©å†å²
        loadChatHistory();
    }

    /**
     * ç»‘å®šèŠå¤©ç›¸å…³äº‹ä»¶
     */
    function bindChatEvents() {
        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#send-chat-btn').off('click').on('click', handleSendMessage);

        // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        $('#chat-input').off('keypress').on('keypress', function(e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶ï¼ˆæ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€ï¼‰
        $('#chat-input').off('input').on('input', function() {
            const hasText = $(this).val().trim().length > 0;
            $('#send-chat-btn').prop('disabled', !hasText || isAIResponding);
        });
    }

    /**
     * æ„å»ºèŠå¤©Prompt
     * @param {string} userInput - ç”¨æˆ·çš„è¾“å…¥
     * @returns {string} - æ„å»ºå¥½çš„Prompt
     */
    function buildChatPrompt(userInput) {
        const currentPersonality = getCurrentPersonality();
        const prompt = `ä½ æ˜¯${petData.name}ï¼Œä½ çš„è®¾å®šæ˜¯ï¼š${currentPersonality}ã€‚ç”¨æˆ·å¯¹ä½ è¯´äº†ï¼šâ€œ${userInput}â€ã€‚è¯·æ ¹æ®ä½ çš„è®¾å®šï¼Œç”¨ç®€çŸ­ã€å¯çˆ±ã€è‡ªç„¶çš„è¯­è¨€å›å¤ã€‚`;
        return prompt;
    }

    /**
     * æ„å»ºä¸å® ç‰©èŠå¤©çš„Prompt
     * @param {string} userInput ç”¨æˆ·çš„è¾“å…¥æ¶ˆæ¯
     * @returns {string} æ„å»ºå¥½çš„ã€ç”¨äºAPIè¯·æ±‚çš„Prompt
     */
    function buildChatPrompt(userInput) {
        const personality = getCurrentPersonality();
        // ä¼˜åŒ–åçš„Promptï¼Œæ›´æ¸…æ™°åœ°å®šä¹‰äº†è§’è‰²å’Œä»»åŠ¡ï¼Œé¿å…AIæ··æ·†
        const prompt = `ä½ æ˜¯ä¸€åªåå«â€œ${petData.name}â€çš„è™šæ‹Ÿå® ç‰©ã€‚ä½ çš„æ€§æ ¼è®¾å®šæ˜¯ï¼šâ€œ${personality}â€ã€‚ç°åœ¨ï¼Œä½ çš„ä¸»äººå¯¹ä½ è¯´äº†ï¼šâ€œ${userInput}â€ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„æ€§æ ¼è®¾å®šï¼Œä»¥å® ç‰©çš„èº«ä»½å’Œå£å»ï¼Œç»™ä¸»äººä¸€ä¸ªç®€çŸ­ã€å¯çˆ±ã€è‡ªç„¶çš„å›å¤ã€‚`;
        console.log(`[buildChatPrompt] Generated prompt: ${prompt}`);
        return prompt;
    }

    /**
     * æ„å»ºèŠå¤©Promptï¼ˆæ”¯æŒå†å²è®°å½•ï¼‰
     */
    function buildChatPromptWithHistory(userInput) {
        const personality = getCurrentPersonality();

        // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡
        let historyContext = '';
        if (chatHistory.length > 0) {
            // åªå–æœ€è¿‘çš„5æ¡å¯¹è¯ä½œä¸ºä¸Šä¸‹æ–‡
            const recentHistory = chatHistory.slice(-5);
            const historyText = recentHistory.map(item => {
                const role = item.sender === 'user' ? 'ä¸»äºº' : petData.name;
                return `${role}: ${item.message}`;
            }).join('\n');
            historyContext = `\n\nä¹‹å‰çš„å¯¹è¯:\n${historyText}\n`;
        }

        // æ„å»ºå®Œæ•´çš„Prompt
        const prompt = `ä½ æ˜¯ä¸€åªåå«"${petData.name}"çš„è™šæ‹Ÿå® ç‰©ã€‚ä½ çš„æ€§æ ¼è®¾å®šæ˜¯ï¼š"${personality}"ã€‚${historyContext}
ç°åœ¨ï¼Œä½ çš„ä¸»äººå¯¹ä½ è¯´äº†ï¼š"${userInput}"ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä½ çš„æ€§æ ¼è®¾å®šï¼Œç»“åˆä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œä»¥å® ç‰©çš„èº«ä»½å’Œå£å»ï¼Œç»™ä¸»äººä¸€ä¸ªç®€çŸ­ã€å¯çˆ±ã€è‡ªç„¶çš„å›å¤ã€‚`;

        console.log(`[buildChatPrompt] Generated prompt with ${chatHistory.length} history items`);
        return prompt;
    }

    /**
     * å¤„ç†å‘é€èŠå¤©æ¶ˆæ¯
     */
    async function handleSendMessage() {
        console.log(`[${extensionName}] handleSendMessage è¢«è°ƒç”¨`);

        const input = $('#chat-modal-input');
        const sendBtn = $('#chat-modal-send-btn');
        const message = input.val().trim();

        // éªŒè¯è¾“å…¥
        if (!message) {
            console.log(`[${extensionName}] æ¶ˆæ¯ä¸ºç©ºï¼Œå¿½ç•¥å‘é€`);
            return;
        }

        if (isAIResponding) {
            console.log(`[${extensionName}] AIæ­£åœ¨å“åº”ä¸­ï¼Œå¿½ç•¥æ–°æ¶ˆæ¯`);
            return;
        }

        // éªŒè¯APIé…ç½®
        const config = getAIConfiguration();
        if (!config.isConfigured) {
            console.log(`[${extensionName}] APIæœªé…ç½®ï¼Œæ˜¾ç¤ºæç¤ºæ¶ˆæ¯`);
            addMessageToChat('pet', 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶ä¸èƒ½å’Œä½ èŠå¤©ã€‚è¯·ä¸»äººå…ˆå¸®æˆ‘é…ç½®å¥½AI APIå“¦ï¼');
            return;
        }

        console.log(`[${extensionName}] å¼€å§‹å¤„ç†æ¶ˆæ¯: "${message}"`);

        // æ¸…ç©ºè¾“å…¥æ¡†å¹¶ç¦ç”¨å‘é€æŒ‰é’®
        input.val('');
        sendBtn.prop('disabled', true);

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessageToChat('user', message);
        isAIResponding = true;

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        addMessageToChat('pet', '...');

        try {
            console.log(`[${extensionName}] æ„å»ºæç¤ºè¯å¹¶è°ƒç”¨AI API`);

            const prompt = buildChatPromptWithHistory(message);
            const aiResponse = await callAIAPI(prompt, 60000);

            // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
            $('#chat-modal-messages .chat-message.pet-message').last().remove();

            // æ·»åŠ AIå›å¤
            const finalResponse = aiResponse || "å—¯...æˆ‘åœ¨æƒ³ä»€ä¹ˆå‘¢ï¼Ÿ";
            addMessageToChat('pet', finalResponse);

            console.log(`[${extensionName}] AIå›å¤æˆåŠŸ: "${finalResponse}"`);

            // ä¿å­˜èŠå¤©å†å²
            saveChatHistory();

        } catch (error) {
            console.error(`[${extensionName}] AIå›å¤å¤±è´¥:`, error);

            // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
            $('#chat-modal-messages .chat-message.pet-message').last().remove();

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            let errorMessage = 'å‘œ...æˆ‘çš„è„‘è¢‹æœ‰ç‚¹ä¹±ï¼Œç¨åå†è¯•å§ï¼';
            if (error.message.includes('timeout')) {
                errorMessage = 'æŠ±æ­‰ï¼Œæˆ‘æƒ³å¾—å¤ªä¹…äº†...è¯·å†è¯•ä¸€æ¬¡å§ï¼';
            } else if (error.message.includes('API')) {
                errorMessage = 'æˆ‘çš„å¤§è„‘è¿æ¥å‡ºäº†ç‚¹é—®é¢˜ï¼Œè¯·æ£€æŸ¥APIé…ç½®å“¦ï¼';
            }

            addMessageToChat('pet', errorMessage);

        } finally {
            isAIResponding = false;
            sendBtn.prop('disabled', false);

            // èšç„¦åˆ°è¾“å…¥æ¡†
            input.focus();

            console.log(`[${extensionName}] handleSendMessage å¤„ç†å®Œæˆ`);
        }
    }

    /**
     * æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£ - é€‚é…æ–°çš„å•†åº—é£æ ¼æ¨¡æ€å¼¹çª—
     * @param {string} sender 'user' æˆ– 'pet'
     * @param {string} message æ¶ˆæ¯å†…å®¹
     */
    function addMessageToChat(sender, message) {
        const container = $('#chat-modal-messages');
        if (container.length === 0) {
            console.log(`[${extensionName}] èŠå¤©æ¶ˆæ¯å®¹å™¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ æ¶ˆæ¯`);
            return;
        }

        // æ£€æµ‹ç§»åŠ¨ç«¯ - å­¦ä¹ å•†åº—çš„å“åº”å¼è®¾è®¡
        const isMobile = window.innerWidth <= 767;
        const isSmallMobile = window.innerWidth <= 480;

        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const isUser = sender === 'user';
        const avatar = isUser ? 'ğŸ‘¤' : getPetEmoji();

        // å“åº”å¼å°ºå¯¸å‚æ•°
        const avatarSize = isSmallMobile ? '32px' : isMobile ? '36px' : '40px';
        const avatarFontSize = isSmallMobile ? '16px' : isMobile ? '18px' : '20px';
        const messagePadding = isSmallMobile ? '8px 12px' : isMobile ? '10px 14px' : '12px 16px';
        const messageBorderRadius = isSmallMobile ? '14px' : isMobile ? '16px' : '18px';
        const messageMaxWidth = isSmallMobile ? '85%' : isMobile ? '80%' : '70%';
        const messageFontSize = isMobile ? '0.9em' : '1em';

        // å¤„ç†æ‰“å­—æŒ‡ç¤ºå™¨
        const messageContent = message === '...'
            ? `<div style="
                display: flex !important;
                align-items: center !important;
                gap: 4px !important;
                padding: 8px 0 !important;
            ">
                <span style="
                    width: 8px !important;
                    height: 8px !important;
                    background: #A0AEC0 !important;
                    border-radius: 50% !important;
                    animation: typingBounce 1.4s infinite ease-in-out !important;
                    animation-delay: 0s !important;
                "></span>
                <span style="
                    width: 8px !important;
                    height: 8px !important;
                    background: #A0AEC0 !important;
                    border-radius: 50% !important;
                    animation: typingBounce 1.4s infinite ease-in-out !important;
                    animation-delay: 0.2s !important;
                "></span>
                <span style="
                    width: 8px !important;
                    height: 8px !important;
                    background: #A0AEC0 !important;
                    border-radius: 50% !important;
                    animation: typingBounce 1.4s infinite ease-in-out !important;
                    animation-delay: 0.4s !important;
                "></span>
            </div>`
            : escapeHtml(message);

        // å­¦ä¹ å•†åº—é£æ ¼çš„æ¶ˆæ¯HTMLç»“æ„
        const messageHtml = `
            <div style="
                display: flex !important;
                gap: 12px !important;
                align-items: flex-start !important;
                ${isUser ? 'flex-direction: row-reverse !important;' : ''}
                animation: messageSlideIn 0.3s ease-out !important;
            ">
                <div style="
                    width: ${avatarSize} !important;
                    height: ${avatarSize} !important;
                    border-radius: 50% !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    font-size: ${avatarFontSize} !important;
                    background: linear-gradient(145deg, ${isUser ? '#FF9EC7, #FF7FB3' : '#A8E6CF, #87CEEB'}) !important;
                    border: 2px solid white !important;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
                    flex-shrink: 0 !important;
                ">${avatar}</div>
                <div style="
                    max-width: ${messageMaxWidth} !important;
                    background: ${isUser ? 'linear-gradient(135deg, #87CEEB, #A8E6CF)' : 'white'} !important;
                    border-radius: ${messageBorderRadius} !important;
                    padding: ${messagePadding} !important;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
                    border: 1px solid ${isUser ? 'rgba(135,206,235,0.3)' : 'rgba(168,230,207,0.3)'} !important;
                    color: ${isUser ? 'white' : '#2D3748'} !important;
                    position: relative !important;
                ">
                    <div style="
                        margin: 0 !important;
                        line-height: 1.4 !important;
                        word-wrap: break-word !important;
                        font-size: ${messageFontSize} !important;
                    ">${messageContent}</div>
                    ${message !== '...' ? `<div style="
                        font-size: 0.75em !important;
                        color: ${isUser ? 'rgba(255, 255, 255, 0.8)' : '#A0AEC0'} !important;
                        margin-top: 4px !important;
                        text-align: right !important;
                    ">${timestamp}</div>` : ''}
                </div>
            </div>
        `;

        container.append(messageHtml);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        container.scrollTop(container[0].scrollHeight);

        // ä¿å­˜èŠå¤©å†å²ï¼ˆä¸ä¿å­˜æ‰“å­—æŒ‡ç¤ºå™¨ï¼‰
        if (message !== '...') {
            chatHistory.push({ sender, message, timestamp: Date.now() });
            if (chatHistory.length > 50) chatHistory.shift();
        }

        console.log(`[${extensionName}] å·²æ·»åŠ ${isUser ? 'ç”¨æˆ·' : 'å® ç‰©'}æ¶ˆæ¯: ${message.substring(0, 20)}...`);
    }

    /**
     * æ‰“å¼€ç‹¬ç«‹çš„èŠå¤©æ¨¡æ€å¼¹çª— - å­¦ä¹ å•†åº—è®¾è®¡æ¨¡å¼
     */
    function openChatModal() {
        console.log(`[${extensionName}] æ‰“å¼€èŠå¤©æ¨¡æ€å¼¹çª—...`);

        // ç¡®ä¿åªæœ‰ä¸€ä¸ªèŠå¤©å¼¹çª—
        $('#chat-modal-overlay').remove();

        // æ£€æµ‹ç§»åŠ¨ç«¯ - å­¦ä¹ å•†åº—çš„å“åº”å¼è®¾è®¡
        const isMobile = window.innerWidth <= 767;
        const isSmallMobile = window.innerWidth <= 480;

        // æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´æ ·å¼å‚æ•° - ä¸å•†åº—å¼¹çª—ä¿æŒä¸€è‡´çš„å°ºå¯¸
        const overlayPadding = isSmallMobile ? '5px' : isMobile ? '10px' : '20px';
        const containerMaxWidth = isMobile ? '300px' : '380px'; // ä¸ä¸»UIä¿æŒä¸€è‡´
        const containerMaxHeight = isSmallMobile ? 'calc(100vh - 20px)' : isMobile ? 'calc(100vh - 40px)' : '70vh'; // ä¸å•†åº—å¼¹çª—ä¸€è‡´
        const borderRadius = isSmallMobile ? '8px' : isMobile ? '12px' : '15px';
        const headerPadding = isMobile ? '12px 16px' : '16px 20px';
        const messagesPadding = isSmallMobile ? '12px' : isMobile ? '16px' : '20px';
        const inputAreaPadding = isSmallMobile ? '10px 12px' : isMobile ? '12px 16px' : '16px 20px';

        // å­¦ä¹ å•†åº—æ¨¡æ€å¼¹çª—çš„è®¾è®¡ï¼Œä½¿ç”¨å†…è”æ ·å¼ç¡®ä¿ä¼˜å…ˆçº§
        const chatModal = $(`
            <div id="chat-modal-overlay" style="
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.8) !important;
                z-index: 1000001 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: ${overlayPadding} !important;
                box-sizing: border-box !important;
            ">
                <div id="chat-modal-container" style="
                    background: linear-gradient(135deg, #FF9EC7 0%, #A8E6CF 50%, #87CEEB 100%) !important;
                    border-radius: ${borderRadius} !important;
                    padding: 0 !important;
                    max-width: ${containerMaxWidth} !important;
                    width: 100% !important;
                    max-height: ${containerMaxHeight} !important;
                    overflow: hidden !important;
                    color: white !important;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important;
                    display: flex !important;
                    flex-direction: column !important;
                ">
                    <!-- æ ‡é¢˜æ  -->
                    <div style="
                        padding: ${headerPadding} !important;
                        background: linear-gradient(145deg, rgba(255,158,199,0.9), rgba(255,158,199,0.7)) !important;
                        display: flex !important;
                        justify-content: space-between !important;
                        align-items: center !important;
                        border-bottom: 1px solid rgba(255,255,255,0.2) !important;
                    ">
                        <h3 style="
                            margin: 0 !important;
                            color: white !important;
                            font-size: 1.2em !important;
                            font-weight: 600 !important;
                        ">ğŸ’¬ ä¸ ${escapeHtml(petData.name)} èŠå¤©</h3>
                        <button id="chat-modal-close-btn" style="
                            background: transparent !important;
                            border: none !important;
                            color: white !important;
                            font-size: 24px !important;
                            font-weight: bold !important;
                            cursor: pointer !important;
                            padding: 4px 8px !important;
                            border-radius: 4px !important;
                            min-width: 32px !important;
                            height: 32px !important;
                            display: flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            transition: all 0.2s ease !important;
                        ">&times;</button>
                    </div>

                    <!-- æ¶ˆæ¯åŒºåŸŸ -->
                    <div id="chat-modal-messages" style="
                        flex: 1 !important;
                        padding: ${messagesPadding} !important;
                        overflow-y: auto !important;
                        background: linear-gradient(135deg, rgba(248,249,255,0.9) 0%, rgba(255,248,252,0.9) 50%, rgba(240,248,255,0.9) 100%) !important;
                        display: flex !important;
                        flex-direction: column !important;
                        gap: ${isMobile ? '12px' : '16px'} !important;
                    ">

                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div style="
                        padding: ${inputAreaPadding} !important;
                        background: rgba(255,255,255,0.9) !important;
                        border-top: 1px solid rgba(255,255,255,0.2) !important;
                        display: flex !important;
                        gap: ${isMobile ? '10px' : '12px'} !important;
                        align-items: center !important;
                        box-shadow: 0 -2px 8px rgba(0,0,0,0.05) !important;
                    ">
                        <input type="text" id="chat-modal-input" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500" style="
                            flex: 1 !important;
                            padding: ${isSmallMobile ? '8px 12px' : isMobile ? '10px 14px' : '12px 16px'} !important;
                            border: 1px solid rgba(255,158,199,0.3) !important;
                            border-radius: ${isSmallMobile ? '18px' : isMobile ? '20px' : '25px'} !important;
                            font-size: ${isMobile ? '16px' : '0.9em'} !important;
                            background: white !important;
                            color: #2D3748 !important;
                            outline: none !important;
                            transition: all 0.3s ease !important;
                        ">
                        <button id="chat-modal-send-btn" style="
                            padding: ${isSmallMobile ? '8px 14px' : isMobile ? '10px 16px' : '12px 20px'} !important;
                            background: linear-gradient(145deg, #FF9EC7, #FF7FB3) !important;
                            color: white !important;
                            border: none !important;
                            border-radius: ${isSmallMobile ? '18px' : isMobile ? '20px' : '25px'} !important;
                            font-size: ${isSmallMobile ? '0.8em' : isMobile ? '0.85em' : '0.9em'} !important;
                            font-weight: 600 !important;
                            cursor: pointer !important;
                            min-width: ${isSmallMobile ? '60px' : isMobile ? '70px' : '80px'} !important;
                            display: flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            gap: 6px !important;
                            transition: all 0.2s ease !important;
                        ">å‘é€</button>
                    </div>
                </div>
            </div>
        `);

        $('body').append(chatModal);

        // åŠ è½½å†å²è®°å½•
        loadChatHistory();

        // ç»‘å®šäº‹ä»¶ - å­¦ä¹ å•†åº—çš„äº‹ä»¶ç»‘å®šæ–¹å¼
        // å…³é—­æŒ‰é’®äº‹ä»¶
        $('#chat-modal-close-btn').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeChatModal();
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ - å­¦ä¹ å•†åº—çš„å®ç°
        chatModal.on('click', function(e) {
            if (e.target === this) {
                closeChatModal();
            }
        });

        // é˜»æ­¢å†…å®¹åŒºåŸŸç‚¹å‡»å†’æ³¡
        $('#chat-modal-container').on('click', e => e.stopPropagation());

        // å‘é€æŒ‰é’®äº‹ä»¶
        $('#chat-modal-send-btn').on('click', handleSendMessage);

        // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        $('#chat-modal-input').on('keypress', function(e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // è¾“å…¥æ¡†èšç„¦å’Œæ ·å¼
        $('#chat-modal-input').on('focus', function() {
            $(this).css({
                'border-color': '#FF9EC7',
                'box-shadow': '0 0 0 3px rgba(255, 158, 199, 0.2)'
            });
        }).on('blur', function() {
            $(this).css({
                'border-color': 'rgba(255,158,199,0.3)',
                'box-shadow': 'none'
            });
        });

        // å‘é€æŒ‰é’®æ‚¬åœæ•ˆæœ
        $('#chat-modal-send-btn').on('mouseenter', function() {
            if (!$(this).prop('disabled')) {
                $(this).css({
                    'background': 'linear-gradient(145deg, #FF7FB3, #FF6BA3)',
                    'transform': 'translateY(-1px)',
                    'box-shadow': '0 4px 12px rgba(255, 158, 199, 0.4)'
                });
            }
        }).on('mouseleave', function() {
            $(this).css({
                'background': 'linear-gradient(145deg, #FF9EC7, #FF7FB3)',
                'transform': 'translateY(0)',
                'box-shadow': 'none'
            });
        });

        // å…³é—­æŒ‰é’®æ‚¬åœæ•ˆæœ
        $('#chat-modal-close-btn').on('mouseenter', function() {
            $(this).css({
                'background': 'rgba(255, 255, 255, 0.2)',
                'transform': 'scale(1.1)'
            });
        }).on('mouseleave', function() {
            $(this).css({
                'background': 'transparent',
                'transform': 'scale(1)'
            });
        });

        // èšç„¦åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
            $('#chat-modal-input').focus();
        }, 100);

        console.log(`[${extensionName}] èŠå¤©æ¨¡æ€å¼¹çª—å·²æ‰“å¼€`);
    }

    /**
     * å…³é—­èŠå¤©æ¨¡æ€å¼¹çª— - å­¦ä¹ å•†åº—çš„å…³é—­æ–¹å¼
     */
    function closeChatModal() {
        console.log(`[${extensionName}] å…³é—­èŠå¤©æ¨¡æ€å¼¹çª—`);
        $('#chat-modal-overlay').remove();
    }

    /**
     * è·å–AIé…ç½®
     */
    function getAIConfiguration() {
        // ä»æ‰©å±•è®¾ç½®ä¸­è·å–AIé…ç½®
        try {
            const settings = JSON.parse(localStorage.getItem(`${extensionName}-ai-settings`));
            if (settings) {
                return {
                    type: settings.apiType || '',
                    url: settings.apiUrl || '',
                    key: settings.apiKey || '',
                    model: settings.apiModel || '',
                    isConfigured: settings.apiType && settings.apiUrl && settings.apiKey
                };
            }
        } catch (error) {
            console.error(`[${extensionName}] è·å–AIé…ç½®å¤±è´¥:`, error);
        }

        return { isConfigured: false };
    }

    /**
     * åŠ è½½èŠå¤©å†å²
     */
    function loadChatHistory() {
        try {
            const saved = localStorage.getItem('virtual-pet-chat-history');
            if (saved) {
                chatHistory = JSON.parse(saved);

                // æ¸²ï¿½ï¿½ï¿½å†å²æ¶ˆæ¯
                const container = $('#chat-messages-container');
                // æ¸…ç©ºé™¤äº†æ¬¢è¿æ¶ˆæ¯ä¹‹å¤–çš„æ‰€æœ‰æ¶ˆæ¯
                container.find('.chat-message').not('.chat-welcome-message .chat-message').remove();

                chatHistory.forEach(item => {
                    const timestamp = new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const isUser = item.sender === 'user';

                    const messageHtml = `
                        <div class="chat-message ${isUser ? 'user-message' : 'pet-message'}">
                            <div class="message-avatar">${isUser ? 'ğŸ‘¤' : getPetEmoji()}</div>
                            <div class="message-content">
                                <div class="message-text">${escapeHtml(item.message)}</div>
                                <div class="message-timestamp">${timestamp}</div>
                            </div>
                        </div>
                    `;

                    container.append(messageHtml);
                });

                // æ»šåŠ¨åˆ°åº•éƒ¨
                container.scrollTop(container[0].scrollHeight);
            }
        } catch (error) {
            console.error(`[${extensionName}] åŠ è½½èŠå¤©å†å²å¤±è´¥:`, error);
            chatHistory = [];
        }
    }

    /**
     * ä¿å­˜èŠå¤©å†å²
     */
    function saveChatHistory() {
        try {
            localStorage.setItem('virtual-pet-chat-history', JSON.stringify(chatHistory));
        } catch (error) {
            console.error(`[${extensionName}] ä¿å­˜èŠå¤©å†å²å¤±è´¥:`, error);
        }
    }

    /**
     * è½¬ä¹‰HTMLå­—ç¬¦
     */
    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * æµ‹è¯•èŠå¤©æŒ‰é’®åŠŸèƒ½
     */
    window.testChatButton = function() {
        console.log('ğŸ§ª æµ‹è¯•èŠå¤©æŒ‰é’®åŠŸèƒ½...');

        // 1. æ£€æŸ¥å¼¹çª—æ˜¯å¦å­˜åœ¨
        const popup = $('.virtual-pet-popup-overlay');
        console.log(`å¼¹çª—å­˜åœ¨: ${popup.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${popup.length})`);

        if (popup.length === 0) {
            console.log('âŒ è¯·å…ˆæ‰“å¼€å® ç‰©ç•Œé¢');
            return false;
        }

        // 2. æ£€æŸ¥èŠå¤©æŒ‰é’®æ˜¯å¦å­˜åœ¨
        const chatBtn = popup.find('.chat-btn');
        console.log(`èŠå¤©æŒ‰é’®å­˜åœ¨: ${chatBtn.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${chatBtn.length})`);

        if (chatBtn.length === 0) {
            console.log('âŒ èŠå¤©æŒ‰é’®æœªæ‰¾åˆ°');
            return false;
        }

        // 3. æ£€æŸ¥æŒ‰é’®æ ·å¼
        const btnStyle = chatBtn.attr('style');
        console.log(`æŒ‰é’®æ ·å¼: ${btnStyle ? 'âœ… æœ‰æ ·å¼' : 'âŒ æ— æ ·å¼'}`);
        if (btnStyle) {
            console.log(`èƒŒæ™¯è‰²: ${btnStyle.includes('background') ? 'âœ…' : 'âŒ'}`);
        }

        // 4. æ£€æŸ¥äº‹ä»¶ç»‘å®š
        const events = $._data(chatBtn[0], 'events');
        console.log(`äº‹ä»¶ç»‘å®š: ${events ? 'âœ…' : 'âŒ'}`);
        if (events) {
            console.log(`- click: ${events.click ? 'âœ…' : 'âŒ'}`);
            console.log(`- touchend: ${events.touchend ? 'âœ…' : 'âŒ'}`);
        }

        // 5. æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
        console.log(`handleChatButtonClickå‡½æ•°: ${typeof handleChatButtonClick === 'function' ? 'âœ…' : 'âŒ'}`);
        console.log(`showChatViewå‡½æ•°: ${typeof showChatView === 'function' ? 'âœ…' : 'âŒ'}`);
        console.log(`initializeChatInterfaceå‡½æ•°: ${typeof initializeChatInterface === 'function' ? 'âœ…' : 'âŒ'}`);

        // 6. æ£€æŸ¥APIé…ç½®çŠ¶æ€
        const config = getAIConfiguration();
        console.log(`APIé…ç½®çŠ¶æ€: ${config.isConfigured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`);

        // 7. æµ‹è¯•ç‚¹å‡»
        console.log('ğŸ¯ æ¨¡æ‹Ÿç‚¹å‡»èŠå¤©æŒ‰é’®...');
        try {
            chatBtn.trigger('click');
            console.log('âœ… ç‚¹å‡»äº‹ä»¶å·²è§¦å‘');

            // æ£€æŸ¥æ˜¯å¦åˆ‡æ¢åˆ°èŠå¤©è§†å›¾
            setTimeout(() => {
                const chatView = $('#pet-chat-view');
                const isVisible = chatView.is(':visible');
                console.log(`èŠå¤©è§†å›¾æ˜¾ç¤º: ${isVisible ? 'âœ…' : 'âŒ'}`);

                if (isVisible) {
                    const configHint = chatView.find('.chat-config-hint');
                    const hasConfigHint = configHint.length > 0;
                    console.log(`é…ç½®æç¤ºæ˜¾ç¤º: ${hasConfigHint ? 'âœ…' : 'âŒ'}`);
                }
            }, 100);

        } catch (error) {
            console.error('âŒ ç‚¹å‡»äº‹ä»¶å¤±è´¥:', error);
        }

        return true;
    };

    /**
     * æ˜¾ç¤ºAPIé…ç½®æç¤º
     */
    function showAPIConfigurationPrompt() {
        // æ£€æŸ¥å…·ä½“ç¼ºå°‘å“ªäº›é…ç½®
        const config = getAIConfiguration();
        let missingItems = [];

        if (!config.type) missingItems.push('APIç±»å‹');
        if (!config.url) missingItems.push('API URL');
        if (!config.key) missingItems.push('APIå¯†é’¥');

        const missingText = missingItems.join('ã€');

        // åˆ›å»ºå‹å¥½çš„æç¤ºæ¶ˆæ¯
        const message = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 3em; margin-bottom: 15px;">ğŸ¤–</div>
                <h3 style="color: var(--primary-accent-color); margin-bottom: 15px;">éœ€è¦é…ç½®AI API</h3>
                <p style="margin-bottom: 15px; line-height: 1.5;">
                    è¦ä¸å® ç‰©èŠå¤©ï¼Œéœ€è¦å…ˆé…ç½®AI APIã€‚<br>
                    å½“å‰ç¼ºå°‘ï¼š<strong>${missingText}</strong>
                </p>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 10px;">ğŸ“‹ é…ç½®æ­¥éª¤ï¼š</div>
                    <ol style="margin: 0; padding-left: 20px; line-height: 1.6;">
                        <li>ç‚¹å‡»å³ä¸Šè§’çš„ <strong>æ‰©å±•</strong> æŒ‰é’® (ğŸ§©)</li>
                        <li>æ‰¾åˆ° <strong>ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ</strong> è®¾ç½®</li>
                        <li>åœ¨ <strong>ğŸ¤– AI API é…ç½®</strong> éƒ¨åˆ†å¡«å†™ï¼š
                            <ul style="margin-top: 5px;">
                                <li>é€‰æ‹©APIç±»å‹ï¼ˆå¦‚OpenAIã€Claudeç­‰ï¼‰</li>
                                <li>å¡«å†™API URL</li>
                                <li>å¡«å†™APIå¯†é’¥</li>
                            </ul>
                        </li>
                        <li>ç‚¹å‡» <strong>ğŸ”— æµ‹è¯•è¿æ¥</strong> éªŒè¯é…ç½®</li>
                    </ol>
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 20px; text-align: left; border-left: 4px solid #ffc107;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">ğŸ’¡ å¸¸ç”¨APIæ¨èï¼š</div>
                    <div style="font-size: 0.9em; color: #856404; line-height: 1.5;">
                        â€¢ <strong>OpenAI</strong>ï¼šhttps://api.openai.com/v1<br>
                        â€¢ <strong>æœ¬åœ°Ollama</strong>ï¼šhttp://localhost:11434/v1<br>
                        â€¢ <strong>LM Studio</strong>ï¼šhttp://localhost:1234/v1<br>
                        â€¢ <strong>ç¬¬ä¸‰æ–¹ä»£ç†</strong>ï¼šæ ¹æ®æä¾›å•†æ–‡æ¡£é…ç½®
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="goto-settings-from-chat" class="pet-button success">
                        âš™ï¸ å»é…ç½®
                    </button>
                    <button id="close-config-prompt" class="pet-button">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        `;

        // åˆ›å»ºæç¤ºå¼¹çª—
        const promptOverlay = $(`
            <div id="api-config-prompt-overlay" class="virtual-pet-popup-overlay" style="display: flex;">
                <div class="pet-popup-container" style="max-width: 450px; height: auto;">
                    <div class="pet-popup-body">
                        ${message}
                    </div>
                </div>
            </div>
        `);

        // æ·»åŠ åˆ°é¡µé¢
        $('body').append(promptOverlay);

        // ç»‘å®šäº‹ä»¶
        $('#goto-settings-from-chat').on('click', function() {
            promptOverlay.remove();
            showSettingsView();
        });

        $('#close-config-prompt').on('click', function() {
            promptOverlay.remove();
        });

        // ç‚¹å‡»é®ç½©å…³é—­
        promptOverlay.on('click', function(e) {
            if (e.target === this) {
                promptOverlay.remove();
            }
        });
    }



    // -----------------------------------------------------------------
    // 4. UI æ¸²æŸ“é€»è¾‘
    // -----------------------------------------------------------------
    
    /**
     * æ¸²æŸ“å® ç‰©çŠ¶æ€
     */
    function renderPetStatus() {
        if (!petContainer) return;
        
        const statusHtml = `
            <div class="pet-avatar-container" style="
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 12px !important;
                padding: 20px !important;
            ">
                <!-- æ‹“éº»æ­Œå­é£æ ¼å¤´åƒæ¡† -->
                <div class="pet-avatar-circle" style="
                    width: 80px !important;
                    height: 80px !important;
                    border-radius: 8px !important;
                    background: ${candyColors.screen} !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    font-size: 3em !important;
                    overflow: hidden !important;
                    border: 3px solid ${candyColors.border} !important;
                    box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                    cursor: pointer !important;
                    font-family: 'Courier New', monospace !important;
                    image-rendering: pixelated !important;
                    image-rendering: -moz-crisp-edges !important;
                    image-rendering: crisp-edges !important;
                " onclick="openAvatarSelector()" oncontextmenu="showAvatarContextMenu(event)" title="ç‚¹å‡»æ›´æ¢å¤´åƒï¼Œå³é”®é‡ç½®">
                    ${getAvatarContent()}
                </div>

                <!-- å® ç‰©ä¿¡æ¯ -->
                <div class="pet-info" style="text-align: center !important;">
                    <div class="pet-name" style="
                        font-size: 1.3em !important;
                        font-weight: bold !important;
                        margin-bottom: 4px !important;
                        color: #ffffff !important;
                    ">${escapeHtml(petData.name)}</div>
                    <div class="pet-level" style="
                        color: #7289da !important;
                        font-size: 1em !important;
                    ">${petData.isAlive ?
                        `${LIFE_STAGES[petData.lifeStage]?.emoji || 'ğŸ¾'} ${LIFE_STAGES[petData.lifeStage]?.name || 'æœªçŸ¥'} Lv.${petData.level}` :
                        'ğŸ’€ å·²æ­»äº¡'
                    }</div>
                </div>
            </div>
            <div class="pet-stats">
                <div class="stat-bar" style="
                    display: flex !important;
                    align-items: center !important;
                    margin-bottom: 8px !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 12px !important;
                    font-weight: bold !important;
                ">
                    <label style="
                        width: 50px !important;
                        color: ${candyColors.textPrimary} !important;
                        margin-right: 8px !important;
                    ">HP</label>
                    <div class="progress-bar" style="
                        flex: 1 !important;
                        height: 12px !important;
                        background: ${candyColors.backgroundSolid} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        overflow: hidden !important;
                        margin-right: 8px !important;
                    ">
                        <div class="progress-fill health" style="
                            width: ${petData.health}% !important;
                            height: 100% !important;
                            background: ${candyColors.health} !important;
                            transition: none !important;
                        "></div>
                    </div>
                    <span style="
                        width: 40px !important;
                        text-align: right !important;
                        color: ${candyColors.textPrimary} !important;
                    ">${Math.round(petData.health)}</span>
                </div>
                <div class="stat-bar" style="
                    display: flex !important;
                    align-items: center !important;
                    margin-bottom: 8px !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 12px !important;
                    font-weight: bold !important;
                ">
                    <label style="
                        width: 50px !important;
                        color: ${candyColors.textPrimary} !important;
                        margin-right: 8px !important;
                    ">JOY</label>
                    <div class="progress-bar" style="
                        flex: 1 !important;
                        height: 12px !important;
                        background: ${candyColors.backgroundSolid} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        overflow: hidden !important;
                        margin-right: 8px !important;
                    ">
                        <div class="progress-fill happiness" style="
                            width: ${petData.happiness}% !important;
                            height: 100% !important;
                            background: ${candyColors.happiness} !important;
                            transition: none !important;
                        "></div>
                    </div>
                    <span style="
                        width: 40px !important;
                        text-align: right !important;
                        color: ${candyColors.textPrimary} !important;
                    ">${Math.round(petData.happiness)}</span>
                </div>
                <div class="stat-bar" style="
                    display: flex !important;
                    align-items: center !important;
                    margin-bottom: 8px !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 12px !important;
                    font-weight: bold !important;
                ">
                    <label style="
                        width: 50px !important;
                        color: ${candyColors.textPrimary} !important;
                        margin-right: 8px !important;
                    ">FOOD</label>
                    <div class="progress-bar" style="
                        flex: 1 !important;
                        height: 12px !important;
                        background: ${candyColors.backgroundSolid} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        overflow: hidden !important;
                        margin-right: 8px !important;
                    ">
                        <div class="progress-fill hunger" style="
                            width: ${petData.hunger}% !important;
                            height: 100% !important;
                            background: ${candyColors.hunger} !important;
                            transition: none !important;
                        "></div>
                    </div>
                    <span style="
                        width: 40px !important;
                        text-align: right !important;
                        color: ${candyColors.textPrimary} !important;
                    ">${Math.round(petData.hunger)}</span>
                </div>
                <div class="stat-bar" style="
                    display: flex !important;
                    align-items: center !important;
                    margin-bottom: 8px !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 12px !important;
                    font-weight: bold !important;
                ">
                    <label style="
                        width: 50px !important;
                        color: ${candyColors.textPrimary} !important;
                        margin-right: 8px !important;
                    ">PWR</label>
                    <div class="progress-bar" style="
                        flex: 1 !important;
                        height: 12px !important;
                        background: ${candyColors.backgroundSolid} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        overflow: hidden !important;
                        margin-right: 8px !important;
                    ">
                        <div class="progress-fill energy" style="
                            width: ${petData.energy}% !important;
                            height: 100% !important;
                            background: ${candyColors.energy} !important;
                            transition: none !important;
                        "></div>
                    </div>
                    <span style="
                        width: 40px !important;
                        text-align: right !important;
                        color: ${candyColors.textPrimary} !important;
                    ">${Math.round(petData.energy)}</span>
                </div>
                ${petData.dataVersion >= 4.0 ? `
                <div class="stat-bar" style="
                    display: flex !important;
                    align-items: center !important;
                    margin-bottom: 8px !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 12px !important;
                    font-weight: bold !important;
                ">
                    <label style="
                        width: 50px !important;
                        color: ${candyColors.textPrimary} !important;
                        margin-right: 8px !important;
                    ">SICK</label>
                    <div class="progress-bar" style="
                        flex: 1 !important;
                        height: 12px !important;
                        background: ${candyColors.backgroundSolid} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        overflow: hidden !important;
                        margin-right: 8px !important;
                    ">
                        <div class="progress-fill sickness" style="
                            width: ${petData.sickness || 0}% !important;
                            height: 100% !important;
                            background: ${candyColors.health} !important;
                            transition: none !important;
                        "></div>
                    </div>
                    <span style="
                        width: 40px !important;
                        text-align: right !important;
                        color: ${candyColors.textPrimary} !important;
                    ">${Math.round(petData.sickness || 0)}</span>
                </div>
                <div class="stat-bar" style="
                    display: flex !important;
                    align-items: center !important;
                    margin-bottom: 8px !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 12px !important;
                    font-weight: bold !important;
                ">
                    <label style="
                        width: 50px !important;
                        color: ${candyColors.textPrimary} !important;
                        margin-right: 8px !important;
                    ">DISC</label>
                    <div class="progress-bar" style="
                        flex: 1 !important;
                        height: 12px !important;
                        background: ${candyColors.backgroundSolid} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        overflow: hidden !important;
                        margin-right: 8px !important;
                    ">
                        <div class="progress-fill discipline" style="
                            width: ${petData.discipline || 50}% !important;
                            height: 100% !important;
                            background: ${candyColors.experience} !important;
                            transition: none !important;
                        "></div>
                    </div>
                    <span style="
                        width: 40px !important;
                        text-align: right !important;
                        color: ${candyColors.textPrimary} !important;
                    ">${Math.round(petData.discipline || 50)}</span>
                </div>
                <div class="tamagotchi-info" style="
                    margin-top: 12px !important;
                    padding: 8px !important;
                    background: ${candyColors.backgroundSolid} !important;
                    border: 2px solid ${candyColors.border} !important;
                    border-radius: 0 !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 11px !important;
                    font-weight: bold !important;
                    color: ${candyColors.textPrimary} !important;
                    text-transform: uppercase !important;
                ">
                    <div style="margin-bottom: 4px !important;">AGE: ${Math.round(petData.age || 0)}H</div>
                    <div style="margin-bottom: 4px !important;">WT: ${petData.weight || 30}KG</div>
                    <div style="margin-bottom: 4px !important;">STATUS: ${petData.isAlive ? 'ALIVE' : 'DEAD'}</div>
                    ${petData.deathReason ? `<div style="color: #FF0000 !important;">CAUSE: ${
                        petData.deathReason === 'sickness' ? 'SICK' :
                        petData.deathReason === 'neglect' ? 'NEGLECT' :
                        petData.deathReason === 'disease' ? 'DISEASE' :
                        petData.deathReason === 'natural' ? 'OLD' : 'UNKNOWN'
                    }</div>` : ''}
                </div>
                ` : ''}
            </div>
        `;
        
        petContainer.html(statusHtml);

        // ç¡®ä¿èŠå¤©æŒ‰é’®å§‹ç»ˆå¯è§
        updateChatButtonVisibility();
    }
    
    /**
     * è·å–å® ç‰©è¡¨æƒ…ç¬¦å·
     */
    function getPetEmoji() {
        const emojis = {
            cat: "ğŸ±",
            dog: "ğŸ¶",
            dragon: "ğŸ‰",
            rabbit: "ğŸ°",
            bird: "ğŸ¦"
        };
        return emojis[petData.type] || "ğŸ±";
    }

    /**
     * è·å–å¤´åƒæ˜¾ç¤ºå†…å®¹ - æ”¯æŒè‡ªå®šä¹‰å›¾ç‰‡
     */
    function getAvatarContent() {
        if (customAvatarData) {
            // è¿”å›è‡ªå®šä¹‰å›¾ç‰‡çš„HTML
            return `<img src="${customAvatarData}" alt="å® ç‰©å¤´åƒ" style="
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
                border-radius: 50% !important;
            ">`;
        } else {
            // è¿”å›é»˜è®¤è¡¨æƒ…ç¬¦å·
            return getPetEmoji();
        }
    }

    /**
     * åŠ è½½è‡ªå®šä¹‰å¤´åƒæ•°æ® - æ”¯æŒå¤šç«¯åŒæ­¥
     */
    function loadCustomAvatar() {
        try {
            // é¦–å…ˆå°è¯•ä»åŒæ­¥å­˜å‚¨åŠ è½½
            const syncAvatar = loadAvatarFromSync();
            const localAvatar = localStorage.getItem(STORAGE_KEY_CUSTOM_AVATAR);

            // æ¯”è¾ƒåŒæ­¥æ•°æ®å’Œæœ¬åœ°æ•°æ®ï¼Œé€‰æ‹©æœ€æ–°çš„
            if (syncAvatar && localAvatar) {
                // å¦‚æœéƒ½å­˜åœ¨ï¼Œä¼˜å…ˆä½¿ç”¨åŒæ­¥æ•°æ®
                customAvatarData = syncAvatar;
                // åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, syncAvatar);
                console.log(`[${extensionName}] ä½¿ç”¨åŒæ­¥çš„å¤´åƒæ•°æ®å¹¶æ›´æ–°æœ¬åœ°`);
            } else if (syncAvatar) {
                customAvatarData = syncAvatar;
                // åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, syncAvatar);
                console.log(`[${extensionName}] ä½¿ç”¨åŒæ­¥çš„å¤´åƒæ•°æ®ï¼ˆä»…æœ‰åŒæ­¥ï¼‰å¹¶ä¿å­˜åˆ°æœ¬åœ°`);
            } else if (localAvatar) {
                customAvatarData = localAvatar;
                console.log(`[${extensionName}] ä½¿ç”¨æœ¬åœ°å¤´åƒæ•°æ®ï¼ˆä»…æœ‰æœ¬åœ°ï¼‰`);
            }

            if (customAvatarData) {
                console.log(`[${extensionName}] Custom avatar loaded, size: ${Math.round(customAvatarData.length/1024)}KB`);

                // ç¡®ä¿å¤´åƒæ˜¾ç¤ºæ›´æ–°
                setTimeout(() => {
                    updateAvatarDisplay();
                    updateFloatingButtonAvatar();
                }, 100);
            } else {
                console.log(`[${extensionName}] No custom avatar found`);
            }
        } catch (error) {
            console.warn(`[${extensionName}] Failed to load custom avatar:`, error);
        }
    }

    /**
     * ä¿å­˜è‡ªå®šä¹‰å¤´åƒæ•°æ® - æ”¯æŒå¤šç«¯åŒæ­¥
     */
    function saveCustomAvatar(imageData) {
        try {
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, imageData);
            customAvatarData = imageData;

            // ä¿å­˜åˆ°åŒæ­¥å­˜å‚¨
            saveAvatarToSync(imageData);

            console.log(`[${extensionName}] Custom avatar saved and synced`);
            return true;
        } catch (error) {
            console.error(`[${extensionName}] Failed to save custom avatar:`, error);
            return false;
        }
    }

    /**
     * æ¸…é™¤è‡ªå®šä¹‰å¤´åƒ - æ”¯æŒå¤šç«¯åŒæ­¥
     */
    function clearCustomAvatar() {
        try {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem(STORAGE_KEY_CUSTOM_AVATAR);
            customAvatarData = null;

            // æ¸…é™¤åŒæ­¥å­˜å‚¨
            clearAvatarFromSync();

            console.log(`[${extensionName}] Custom avatar cleared and synced`);
            return true;
        } catch (error) {
            console.error(`[${extensionName}] Failed to clear custom avatar:`, error);
            return false;
        }
    }
    
    /**
     * æ¸²æŸ“å® ç‰©è¯¦æƒ…
     */
    function renderPetDetails() {
        $("#detail-pet-name").text(petData.name);
        $("#detail-pet-type").text(getPetTypeName(petData.type));
        $("#detail-pet-level").text(petData.level);
        $("#detail-pet-exp").text(`${petData.experience}/${petData.level * 100}`);

        const createdDate = new Date(petData.created);
        const now = new Date();
        const daysDiff = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));

        let createdText = "åˆšåˆš";
        if (daysDiff > 0) {
            createdText = `${daysDiff} å¤©å‰`;
        } else {
            const hoursDiff = Math.floor((now - createdDate) / (1000 * 60 * 60));
            if (hoursDiff > 0) {
                createdText = `${hoursDiff} å°æ—¶å‰`;
            }
        }
        $("#detail-pet-created").text(createdText);

        // æ›´æ–°æˆå°±çŠ¶æ€
        updateAchievements();
    }

    /**
     * è·å–å® ç‰©ç±»å‹åç§°
     */
    function getPetTypeName(type) {
        const typeNames = {
            cat: "çŒ«å’ª",
            dog: "å°ç‹—",
            dragon: "é¾™",
            rabbit: "å…”å­",
            bird: "å°é¸Ÿ"
        };
        return typeNames[type] || "æœªçŸ¥";
    }

    /**
     * æ›´æ–°æˆå°±çŠ¶æ€
     */
    function updateAchievements() {
        const achievements = [
            {
                id: "first-feed",
                name: "åˆæ¬¡å–‚é£Ÿ",
                icon: "ğŸ¥‡",
                condition: () => petData.lastFeedTime > petData.created
            },
            {
                id: "game-master",
                name: "æ¸¸æˆè¾¾äºº",
                icon: "ğŸ®",
                condition: () => petData.lastPlayTime > petData.created && petData.level >= 3
            },
            {
                id: "level-expert",
                name: "å‡çº§ä¸“å®¶",
                icon: "â­",
                condition: () => petData.level >= 5
            }
        ];

        const container = $("#achievements-container");
        container.empty();

        achievements.forEach(achievement => {
            const isUnlocked = achievement.condition();
            const achievementEl = $(`
                <div class="achievement ${isUnlocked ? 'unlocked' : 'locked'}">
                    <span class="achievement-icon">${achievement.icon}</span>
                    <span class="achievement-name">${achievement.name}</span>
                </div>
            `);
            container.append(achievementEl);
        });
    }

    /**
     * æ¸²æŸ“è®¾ç½®
     */
    function renderSettings() {
        $("#pet-name-input").val(petData.name);
        $("#pet-type-select").val(petData.type);

        // ä»localStorageåŠ è½½è®¾ç½®
        const autoSave = localStorage.getItem(`${extensionName}-auto-save`) !== "false";
        const notifications = localStorage.getItem(`${extensionName}-notifications`) !== "false";

        $("#auto-save-checkbox").prop("checked", autoSave);
        $("#notifications-checkbox").prop("checked", notifications);
    }

    /**
     * ä¿å­˜è®¾ç½®
     */
    function saveSettings() {
        const newName = $("#pet-name-input").val().trim();
        const newType = $("#pet-type-select").val();

        if (newName && newName !== petData.name) {
            petData.name = newName;
            toastr.success(`å® ç‰©åç§°å·²æ›´æ”¹ä¸º "${newName}"`);
        }

        if (newType !== petData.type) {
            petData.type = newType;
            toastr.success(`å® ç‰©ç±»å‹å·²æ›´æ”¹ä¸º "${getPetTypeName(newType)}"`);
        }

        // ä¿å­˜å…¶ä»–è®¾ç½®
        const autoSave = $("#auto-save-checkbox").is(":checked");
        const notifications = $("#notifications-checkbox").is(":checked");

        localStorage.setItem(`${extensionName}-auto-save`, autoSave);
        localStorage.setItem(`${extensionName}-notifications`, notifications);

        savePetData();
        renderPetStatus(); // æ›´æ–°ä¸»è§†å›¾
        toastr.success("è®¾ç½®å·²ä¿å­˜ï¼");
    }

    /**
     * é‡ç½®å® ç‰©
     */
    function resetPet() {
        if (!confirm("ç¡®å®šè¦é‡ç½®å® ç‰©å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼")) {
            return;
        }

        // é‡ç½®ä¸ºæ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿ
        petData = {
            name: "å°å® ç‰©",
            type: "cat",
            level: 1,
            experience: 0,
            health: 35,    // æ™ºèƒ½ç³»ç»Ÿï¼šä¼šåœ¨é¦–æ¬¡æ‰“å¼€æ—¶éšæœºåŒ–
            happiness: 30, // æ™ºèƒ½ç³»ç»Ÿï¼šä¼šåœ¨é¦–æ¬¡æ‰“å¼€æ—¶éšæœºåŒ–
            hunger: 40,    // æ™ºèƒ½ç³»ç»Ÿï¼šä¼šåœ¨é¦–æ¬¡æ‰“å¼€æ—¶éšæœºåŒ–
            energy: 45,    // æ™ºèƒ½ç³»ç»Ÿï¼šä¼šåœ¨é¦–æ¬¡æ‰“å¼€æ—¶éšæœºåŒ–

            // æ‹“éº»æ­Œå­å¼å±æ€§
            lifeStage: "baby",
            age: 0,
            isAlive: true,
            deathReason: null,
            sickness: 0,
            discipline: 50,
            weight: 30,

            // æ—¶é—´è®°å½•
            lastFeedTime: Date.now(),
            lastPlayTime: Date.now(),
            lastSleepTime: Date.now(),
            lastUpdateTime: Date.now(),
            lastCareTime: Date.now(),
            created: Date.now(),

            // æ‹“éº»æ­Œå­å¼è®¡æ•°å™¨
            careNeglectCount: 0,
            sicknessDuration: 0,

            dataVersion: 4.0, // æ‹“éº»æ­Œå­ç³»ç»Ÿç‰ˆæœ¬
            hasBeenRandomized: false // é‡ç½®åéœ€è¦é‡æ–°éšæœºåŒ–
        };

        // åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿå’ŒéšæœºåŒ–
        applyTamagotchiSystem();
        applyFirstTimeRandomization();

        savePetData();
        renderSettings();
        toastr.success("ğŸ¥š æ–°çš„æ‹“éº»æ­Œå­å® ç‰©è¯ç”Ÿäº†ï¼è¯·å¥½å¥½ç…§é¡¾å®ƒï¼");
    }
    
    /**
     * å®‰å…¨åœ°è½¬ä¹‰HTMLå­—ç¬¦ä¸²ï¼Œé˜²æ­¢XSS
     */
    function escapeHtml(unsafe) {
        if (unsafe === null || typeof unsafe === "undefined") return "";
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    // -----------------------------------------------------------------
    // 5. æµ®åŠ¨æŒ‰é’®ç®¡ç†
    // -----------------------------------------------------------------

    /**
     * ä½¿æŒ‰é’®å¯æ‹–åŠ¨ï¼Œå¹¶å¤„ç†ç‚¹å‡»ä¸æ‹–åŠ¨çš„åŒºåˆ†ï¼ˆæœ€ç»ˆä¿®å¤ç‰ˆæœ¬ï¼‰
     */
    function makeButtonDraggable($button) {
        let isDragging = false;
        let wasDragged = false;
        let startX, startY, dragStartX, dragStartY;
        let dragThreshold = 8; // æ‹–åŠ¨é˜ˆå€¼

        console.log(`[${extensionName}] Setting up final fixed drag for button`);

        // æ¸…é™¤ç°æœ‰äº‹ä»¶
        $button.off();
        $(document).off('.petdragtemp');

        // ç»Ÿä¸€çš„äº¤äº’å¤„ç†
        $button.on('mousedown.petdrag touchstart.petdrag', function(e) {
            console.log(`[${extensionName}] Interaction start`);
            isDragging = true;
            wasDragged = false;

            // å…¼å®¹è§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
            const touch = e.originalEvent && e.originalEvent.touches && e.originalEvent.touches[0];
            startX = touch ? touch.pageX : e.pageX;
            startY = touch ? touch.pageY : e.pageY;

            // ç¡®ä¿åæ ‡æœ‰æ•ˆ
            if (typeof startX !== 'number' || typeof startY !== 'number') {
                console.warn(`[${extensionName}] Invalid coordinates, aborting`);
                return;
            }

            // è®°å½•åˆå§‹æ‹–åŠ¨åç§»é‡
            const rect = $button[0].getBoundingClientRect();
            dragStartX = startX - rect.left;
            dragStartY = startY - rect.top;

            // é˜»æ­¢é»˜è®¤è¡Œä¸º
            e.preventDefault();

            // ç»‘å®šç§»åŠ¨å’Œç»“æŸäº‹ä»¶
            $(document).on('mousemove.petdragtemp touchmove.petdragtemp', function(moveE) {
                if (!isDragging) return;

                const moveTouch = moveE.originalEvent && moveE.originalEvent.touches && moveE.originalEvent.touches[0];
                const moveX = moveTouch ? moveTouch.pageX : moveE.pageX;
                const moveY = moveTouch ? moveTouch.pageY : moveE.pageY;

                const deltaX = Math.abs(moveX - startX);
                const deltaY = Math.abs(moveY - startY);

                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ‹–åŠ¨é˜ˆå€¼
                if (deltaX > dragThreshold || deltaY > dragThreshold) {
                    if (!wasDragged) {
                        wasDragged = true;
                        console.log(`[${extensionName}] Drag detected`);

                        // æ·»åŠ æ‹–åŠ¨è§†è§‰åé¦ˆ
                        $button.addClass('dragging');
                        $button.css({
                            "cursor": "grabbing",
                            "opacity": "0.8",
                            "transform": "scale(1.05)"
                        });
                    }

                    // è®¡ç®—æ–°ä½ç½® - ä¿®å¤åçš„æ­£ç¡®è®¡ç®—æ–¹æ³•
                    const newX = moveX - dragStartX;
                    const newY = moveY - dragStartY;

                    // è¾¹ç•Œé™åˆ¶
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    const buttonWidth = $button.outerWidth() || 48;
                    const buttonHeight = $button.outerHeight() || 48;
                    const safeMargin = 10;

                    const safeX = Math.max(safeMargin, Math.min(newX, windowWidth - buttonWidth - safeMargin));
                    const safeY = Math.max(safeMargin, Math.min(newY, windowHeight - buttonHeight - safeMargin));

                    // è®¾ç½®ä½ç½®
                    $button[0].style.setProperty('left', safeX + 'px', 'important');
                    $button[0].style.setProperty('top', safeY + 'px', 'important');
                    $button[0].style.setProperty('position', 'fixed', 'important');

                    // è°ƒè¯•æ—¥å¿—ï¼ˆå¯é€‰ï¼Œç”Ÿäº§ç¯å¢ƒå¯ç§»é™¤ï¼‰
                    // console.log(`[${extensionName}] Moving to: mouse(${moveX}, ${moveY}) â†’ button(${safeX}, ${safeY})`);
                }
            });

            // ç»‘å®šç»“æŸäº‹ä»¶
            $(document).on('mouseup.petdragtemp touchend.petdragtemp', function() {
                console.log(`[${extensionName}] Interaction end, wasDragged: ${wasDragged}`);
                isDragging = false;
                $(document).off('.petdragtemp');

                // æ¢å¤æŒ‰é’®æ­£å¸¸çŠ¶æ€
                $button.removeClass('dragging');
                $button.css({
                    "cursor": "grab",
                    "opacity": "1",
                    "transform": "none"
                });

                if (wasDragged) {
                    // ä¿å­˜æ‹–åŠ¨åçš„ä½ç½®
                    const rect = $button[0].getBoundingClientRect();
                    const positionData = {
                        x: Math.round(rect.left),
                        y: Math.round(rect.top)
                    };
                    localStorage.setItem(STORAGE_KEY_BUTTON_POS, JSON.stringify(positionData));
                    console.log(`[${extensionName}] Position saved:`, positionData);

                    // çŸ­æš‚å»¶è¿Ÿé‡ç½®æ‹–åŠ¨æ ‡å¿—
                    setTimeout(() => {
                        wasDragged = false;
                    }, 100);
                } else {
                    // æ²¡æœ‰æ‹–åŠ¨ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶ - åˆ‡æ¢å¼¹çª—çŠ¶æ€
                    console.log(`[${extensionName}] Button clicked, toggling popup`);
                    try {
                        togglePopup();
                    } catch (error) {
                        console.error(`[${extensionName}] Error toggling popup:`, error);
                        alert("ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ\n\nå¼¹çª—åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...\nè¯·ç¨åå†è¯•ï¼");
                    }
                }
            });
        });

        console.log(`[${extensionName}] Final drag events bound successfully`);
    }

    /**
     * ä½¿å¼¹çª—å¯æ‹–åŠ¨
     */
    function makePopupDraggable($popup) {
        let isDragging = false;
        let dragStartX, dragStartY;
        let popupStartX, popupStartY;

        const $header = $popup.find('.pet-popup-header');
        if ($header.length === 0) return;

        const onDragStart = (e) => {
            isDragging = true;

            // å…¼å®¹è§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
            const pageX = e.pageX || e.originalEvent.touches[0].pageX;
            const pageY = e.pageY || e.originalEvent.touches[0].pageY;

            dragStartX = pageX;
            dragStartY = pageY;

            const popupOffset = $popup.offset();
            popupStartX = popupOffset.left;
            popupStartY = popupOffset.top;

            $popup.addClass('dragging');
            e.preventDefault();
        };

        const onDragMove = (e) => {
            if (!isDragging) return;

            let pageX, pageY;
            if (e.originalEvent && e.originalEvent.touches && e.originalEvent.touches[0]) {
                pageX = e.originalEvent.touches[0].pageX;
                pageY = e.originalEvent.touches[0].pageY;
            } else {
                pageX = e.pageX;
                pageY = e.pageY;
            }

            const deltaX = pageX - dragStartX;
            const deltaY = pageY - dragStartY;

            let newX = popupStartX + deltaX;
            let newY = popupStartY + deltaY;

            // é™åˆ¶åœ¨å±å¹•èŒƒå›´å†…
            const windowWidth = $(window).width();
            const windowHeight = $(window).height();
            const popupWidth = $popup.outerWidth();
            const popupHeight = $popup.outerHeight();

            newX = Math.max(0, Math.min(newX, windowWidth - popupWidth));
            newY = Math.max(0, Math.min(newY, windowHeight - popupHeight));

            $popup.css({
                position: 'fixed',
                left: newX + 'px',
                top: newY + 'px',
                transform: 'none'
            });

            e.preventDefault();
        };
        const onDragEnd = () => {
            if (isDragging) {
                isDragging = false;
                $popup.removeClass('dragging');
            }
        };

        // ç»‘å®šäº‹ä»¶åˆ°æ ‡é¢˜æ 
        $header.on("mousedown touchstart", onDragStart);
        $(document).on("mousemove touchmove", onDragMove);
        $(document).on("mouseup touchend", onDragEnd);
    }

    /**
     * åˆå§‹åŒ–å¹¶æ˜¾ç¤ºæµ®åŠ¨æŒ‰é’®
     */
    function initializeFloatingButton() {
        console.log(`[${extensionName}] initializeFloatingButton called`);

        if ($(`#${BUTTON_ID}`).length) {
            console.log(`[${extensionName}] Button already exists`);
            return;
        }

        // åˆ›å»ºæŒ‰é’®
        console.log(`[${extensionName}] Creating floating button with ID: ${BUTTON_ID}`);

        // ä½¿ç”¨å†…è”æ ·å¼ç¡®ä¿æŒ‰é’®å¯è§ï¼Œå¼ºåˆ¶ä½¿ç”¨fixedå®šä½
        const buttonHtml = `
            <div id="${BUTTON_ID}" style="
                position: fixed !important;
                z-index: ${SAFE_Z_INDEX.button} !important;
                cursor: grab !important;
                width: 48px !important;
                height: 48px !important;
                background: linear-gradient(145deg, ${candyColors.primary}, ${candyColors.buttonHover}) !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: #7289da !important;
                font-size: 24px !important;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 2px 2px rgba(255,255,255,0.05), 0 0 0 1px rgba(0,0,0,0.5) !important;
                user-select: none !important;
                opacity: 1 !important;
                visibility: visible !important;
                pointer-events: auto !important;
                transform: none !important;
                margin: 0 !important;
                top: 200px !important;
                left: 20px !important;
                bottom: auto !important;
                right: auto !important;
            ">${customAvatarData ? `<img src="${customAvatarData}" alt="å® ç‰©å¤´åƒ" style="width: 100% !important; height: 100% !important; object-fit: cover !important; border-radius: 50% !important;">` : 'ğŸ¾'}</div>
        `;

        // ç›´æ¥æ·»åŠ åˆ°bodyï¼Œé¿å…è¢«å…¶ä»–å®¹å™¨å½±å“å®šä½
        $("body").append(buttonHtml);

        const $button = $(`#${BUTTON_ID}`);
        console.log(`[${extensionName}] Button created, element count: ${$button.length}`);

        if ($button.length === 0) {
            console.error(`[${extensionName}] Failed to create button!`);
            return;
        }

        // å¼ºåˆ¶ç¡®ä¿æŒ‰é’®å¯è§å’Œæ­£ç¡®å®šä½
        $button.css({
            'position': 'fixed',
            'display': 'flex',
            'opacity': '1',
            'visibility': 'visible',
            'z-index': SAFE_Z_INDEX.button,
            'transform': 'none',
            'margin': '0',
            'pointer-events': 'auto'
        });

        // éªŒè¯æŒ‰é’®ä½ç½®æ˜¯å¦æ­£ç¡®
        setTimeout(() => {
            const rect = $button[0].getBoundingClientRect();
            console.log(`[${extensionName}] Button position check:`, {
                top: rect.top,
                left: rect.left,
                width: rect.width,
                height: rect.height,
                inViewport: rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth
            });

            // å¦‚æœä½ç½®ä¸æ­£ç¡®ï¼Œå¼ºåˆ¶ä¿®æ­£
            if (rect.top < 0 || rect.top > window.innerHeight || rect.left < 0 || rect.left > window.innerWidth) {
                console.warn(`[${extensionName}] Button position incorrect, forcing correction`);
                $button.css({
                    'top': '200px',
                    'left': '20px',
                    'position': 'fixed',
                    'transform': 'none'
                });
            }
        }, 100);

        // ä»localStorageæ¢å¤æŒ‰é’®ä½ç½®ï¼Œä½¿ç”¨å®Œå–„çš„è¾¹ç•Œæ£€æŸ¥
        const savedPos = localStorage.getItem(STORAGE_KEY_BUTTON_POS);
        if (savedPos) {
            try {
                const pos = JSON.parse(savedPos);
                // éªŒè¯ä½ç½®æ˜¯å¦åˆç†
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const buttonWidth = $button.outerWidth() || 48;
                const buttonHeight = $button.outerHeight() || 48;
                const left = parseInt(pos.x) || 20;
                const top = parseInt(pos.y) || 200;

                // ä½¿ç”¨ä¸æ‹–åŠ¨ç›¸åŒçš„è¾¹ç•Œæ£€æŸ¥é€»è¾‘
                const safeMargin = Math.min(10, Math.floor(Math.min(windowWidth, windowHeight) * 0.02));
                const minMargin = 5;
                const actualMargin = Math.max(minMargin, safeMargin);

                const maxX = windowWidth - buttonWidth - actualMargin;
                const maxY = windowHeight - buttonHeight - actualMargin;
                const minX = actualMargin;
                const minY = actualMargin;

                let safeLeft, safeTop;

                if (maxX > minX && maxY > minY) {
                    safeLeft = Math.max(minX, Math.min(left, maxX));
                    safeTop = Math.max(minY, Math.min(top, maxY));
                } else {
                    // å±å¹•å¤ªå°çš„æƒ…å†µï¼Œä½¿ç”¨ä¸­å¿ƒä½ç½®
                    safeLeft = Math.max(0, (windowWidth - buttonWidth) / 2);
                    safeTop = Math.max(0, (windowHeight - buttonHeight) / 2);
                    console.warn(`[${extensionName}] Screen too small for saved position, centering button`);
                }

                $button.css({
                    'top': safeTop + 'px',
                    'left': safeLeft + 'px',
                    'position': 'fixed',
                    'transform': 'none'
                });
                console.log(`[${extensionName}] Button position restored:`, { left: safeLeft, top: safeTop });
            } catch (error) {
                console.warn(`[${extensionName}] Failed to restore position:`, error);
                // å¦‚æœæ¢å¤ä½ç½®å¤±è´¥ï¼Œè®¾ç½®é»˜è®¤ä½ç½®
                $button.css({
                    'top': '200px',
                    'left': '20px',
                    'position': 'fixed',
                    'transform': 'none'
                });
            }
        }

        // ä½¿æŒ‰é’®å¯æ‹–åŠ¨
        makeButtonDraggable($button);

        // æ·»åŠ å®šæœŸä½ç½®æ£€æŸ¥ï¼Œé˜²æ­¢æŒ‰é’®è¢«æ„å¤–ç§»åŠ¨
        const positionCheckInterval = setInterval(() => {
            const currentButton = $(`#${BUTTON_ID}`);
            if (currentButton.length > 0) {
                const rect = currentButton[0].getBoundingClientRect();
                const styles = window.getComputedStyle(currentButton[0]);

                // æ£€æŸ¥æ˜¯å¦ä½ç½®å¼‚å¸¸æˆ–å®šä½æ–¹å¼é”™è¯¯
                if (styles.position !== 'fixed' || rect.top < -100 || rect.top > window.innerHeight + 100) {
                    console.warn(`[${extensionName}] Button position anomaly detected, correcting...`);
                    currentButton.css({
                        'position': 'fixed',
                        'top': '200px',
                        'left': '20px',
                        'transform': 'none',
                        'z-index': SAFE_Z_INDEX.button
                    });
                }
            } else {
                // å¦‚æœæŒ‰é’®æ¶ˆå¤±äº†ï¼Œæ¸…é™¤æ£€æŸ¥
                clearInterval(positionCheckInterval);
            }
        }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

        console.log(`[${extensionName}] Button initialization complete`);
    }

    /**
     * ç§»é™¤æµ®åŠ¨æŒ‰é’®
     */
    function destroyFloatingButton() {
        $(`#${BUTTON_ID}`).remove();
    }

    /**
     * æ’ä»¶å¸è½½æ¸…ç†å‡½æ•°
     * å½“æ’ä»¶è¢«ç¦ç”¨æˆ–å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†ç›¸å…³æ•°æ®å’ŒDOMå…ƒç´ 
     */
    function cleanupOnUnload() {
        console.log(`[${extensionName}] å¼€å§‹æ‰§è¡Œå¸è½½æ¸…ç†...`);

        try {
            // 1. æ¸…ç†DOMå…ƒç´ 
            $(`#${BUTTON_ID}`).remove();
            $(`#${OVERLAY_ID}`).remove();
            $('.virtual-pet-popup-overlay').remove();
            $('#shop-modal').remove();
            $('.pet-notification').remove();
            $('#ios-test-button').remove();
            $('#test-popup-button').remove();

            // 2. æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            $(document).off('.petdragtemp');
            $(document).off('visibilitychange');

            // 3. æ¸…ç†å…¨å±€å˜é‡
            if (window.testVirtualPet) delete window.testVirtualPet;
            if (window.forceShowPetButton) delete window.forceShowPetButton;
            if (window.forceDataMigration) delete window.forceDataMigration;
            if (window.forceClearAndReload) delete window.forceClearAndReload;
            if (window.fixAllIssues) delete window.fixAllIssues;
            if (window.createIOSTestButton) delete window.createIOSTestButton;
            if (window.showIOSPopup) delete window.showIOSPopup;
            if (window.clearAllPopups) delete window.clearAllPopups;
            if (window.forceCloseAllPopups) delete window.forceCloseAllPopups;
            if (window.closeShopModal) delete window.closeShopModal;
            if (window.testShopSystem) delete window.testShopSystem;

            // 4. å¯é€‰ï¼šæ¸…ç†localStorageæ•°æ®ï¼ˆç”¨æˆ·å¯é€‰æ‹©ä¿ç•™ï¼‰
            const shouldClearData = confirm(
                'æ˜¯å¦åŒæ—¶æ¸…ç†å® ç‰©æ•°æ®ï¼Ÿ\n\n' +
                'é€‰æ‹©"ç¡®å®š"ï¼šå®Œå…¨æ¸…ç†æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬å® ç‰©çŠ¶æ€ã€è®¾ç½®ç­‰ï¼‰\n' +
                'é€‰æ‹©"å–æ¶ˆ"ï¼šä¿ç•™æ•°æ®ï¼Œä¸‹æ¬¡å®‰è£…æ—¶å¯ä»¥æ¢å¤'
            );

            if (shouldClearData) {
                // æ¸…ç†æ‰€æœ‰ç›¸å…³çš„localStorageæ•°æ®
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.includes('virtual-pet') ||
                        key.includes('KPCP-PET') ||
                        key.includes('pet-system') ||
                        key.startsWith(extensionName)
                    )) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    console.log(`[${extensionName}] å·²æ¸…ç†localStorage: ${key}`);
                });

                console.log(`[${extensionName}] å·²æ¸…ç† ${keysToRemove.length} ä¸ªlocalStorageé¡¹ç›®`);
            }

            console.log(`[${extensionName}] å¸è½½æ¸…ç†å®Œæˆ`);

            // æ˜¾ç¤ºæ¸…ç†å®Œæˆæç¤º
            if (typeof toastr !== 'undefined') {
                toastr.success('è™šæ‹Ÿå® ç‰©ç³»ç»Ÿå·²å®Œå…¨æ¸…ç†ï¼', '', { timeOut: 3000 });
            }

        } catch (error) {
            console.error(`[${extensionName}] å¸è½½æ¸…ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:`, error);
            if (typeof toastr !== 'undefined') {
                toastr.warning('æ¸…ç†è¿‡ç¨‹ä¸­å‘ç”Ÿéƒ¨åˆ†é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', '', { timeOut: 5000 });
            }
        }
    }

    /**
     * æ£€æµ‹æ’ä»¶æ˜¯å¦è¢«ç¦ç”¨å¹¶æ‰§è¡Œæ¸…ç†
     */
    function setupUnloadDetection() {
        // ç›‘å¬æ’ä»¶å¼€å…³çŠ¶æ€å˜åŒ–
        const checkInterval = setInterval(() => {
            const isEnabled = localStorage.getItem(STORAGE_KEY_ENABLED) !== "false";
            const toggleElement = $(TOGGLE_ID);

            // å¦‚æœæ’ä»¶è¢«ç¦ç”¨ä¸”DOMå…ƒç´ ä»å­˜åœ¨ï¼Œæ‰§è¡Œæ¸…ç†
            if (!isEnabled && $(`#${BUTTON_ID}`).length > 0) {
                console.log(`[${extensionName}] æ£€æµ‹åˆ°æ’ä»¶è¢«ç¦ç”¨ï¼Œæ‰§è¡Œæ¸…ç†...`);
                destroyFloatingButton();
                $(`#${OVERLAY_ID}`).remove();
                $('.virtual-pet-popup-overlay').remove();
                clearInterval(checkInterval); // åœæ­¢æ£€æµ‹
            }
        }, 1000);

        // é¡µé¢å¸è½½æ—¶çš„æ¸…ç†
        window.addEventListener('beforeunload', () => {
            // ç®€å•æ¸…ç†ï¼Œä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            $(`#${BUTTON_ID}`).remove();
            $(`#${OVERLAY_ID}`).remove();
            $('.virtual-pet-popup-overlay').remove();
        });

        // ä¸ºå¼€å‘è€…æä¾›æ‰‹åŠ¨æ¸…ç†å‡½æ•°
        window.cleanupVirtualPetSystem = cleanupOnUnload;
    }

    // -----------------------------------------------------------------
    // 6. åˆå§‹åŒ–æµç¨‹
    // -----------------------------------------------------------------

    async function initializeExtension() {
        console.log(`[${extensionName}] Initializing extension...`);

        // 1. æ£€æŸ¥å¹¶ä¿®å¤CSSå˜é‡æ±¡æŸ“
        checkAndFixCSSVariables();

        // 2. åˆ›å»ºæ ·å¼éš”ç¦»
        createIsolatedStyles();

        // 3. åŠ¨æ€åŠ è½½CSS
        console.log(`[${extensionName}] Loading CSS from: ${extensionFolderPath}/style.css`);
        $("head").append(`<link rel="stylesheet" type="text/css" href="${extensionFolderPath}/style.css">`);

        // 2. å…ˆå°è¯•åˆ›å»ºç®€å•çš„è®¾ç½®é¢æ¿
        console.log(`[${extensionName}] Creating simple settings panel...`);
        const simpleSettingsHtml = `
            <div id="virtual-pet-settings">
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <b>ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ</b>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div class="flex-container">
                            <label class="checkbox_label" for="virtual-pet-enabled-toggle">
                                <input id="virtual-pet-enabled-toggle" type="checkbox" checked>
                                <span>å¯ç”¨è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ</span>
                            </label>
                        </div>
                        <small class="notes">
                            å¯ç”¨åä¼šåœ¨å±å¹•ä¸Šæ˜¾ç¤ºä¸€ä¸ªå¯æ‹–åŠ¨çš„å® ç‰©æŒ‰é’®ï¼ˆğŸ¾ï¼‰
                        </small>

                        <hr style="margin: 15px 0; border: none; border-top: 1px solid #444;">

                        <div class="flex-container">
                            <label for="virtual-pet-personality-select" style="display: block; margin-bottom: 8px; font-weight: bold;">
                                ğŸ­ å® ç‰©äººè®¾é€‰æ‹©
                            </label>
                            <select id="virtual-pet-personality-select" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                                <option value="default">ğŸ± é»˜è®¤ - é«˜å†·ä½†æ¸©æŸ”çš„çŒ«</option>
                                <option value="cheerful">ğŸ¶ æ´»æ³¼ - çƒ­æƒ…æ´‹æº¢çš„å°ç‹—</option>
                                <option value="elegant">ğŸ‰ ä¼˜é›… - å¤å…¸æ–‡é›…çš„é¾™</option>
                                <option value="shy">ğŸ° å®³ç¾ - è½»å£°ç»†è¯­çš„å…”å­</option>
                                <option value="smart">ğŸ¦ èªæ˜ - æœºæ™ºå¹½é»˜çš„é¸Ÿ</option>
                                <option value="custom">âœï¸ è‡ªå®šä¹‰äººè®¾</option>
                            </select>
                        </div>

                        <div id="virtual-pet-custom-personality-container" style="display: none; margin-top: 10px;">
                            <label for="virtual-pet-custom-personality" style="display: block; margin-bottom: 5px; font-size: 0.9em;">
                                è‡ªå®šä¹‰äººè®¾æè¿°ï¼š
                            </label>
                            <textarea id="virtual-pet-custom-personality"
                                      placeholder="æè¿°ä½ çš„å® ç‰©æ€§æ ¼ã€å–œå¥½å’Œç‰¹ç‚¹..."
                                      rows="3"
                                      maxlength="5000"
                                      style="width: 100%; padding: 8px; border-radius: 4px; resize: vertical; font-family: inherit;"></textarea>
                            <small style="color: #888; font-size: 0.8em;">æœ€å¤š5000å­—ç¬¦ï¼Œè¿™å°†å½±å“å® ç‰©ä¸ä½ äº’åŠ¨æ—¶çš„å›å¤é£æ ¼</small>
                        </div>

                        <small class="notes" style="margin-top: 10px; display: block;">
                            é€‰æ‹©æˆ–è‡ªå®šä¹‰å® ç‰©çš„æ€§æ ¼ï¼ŒAIä¼šæ ¹æ®äººè®¾ç”Ÿæˆä¸ªæ€§åŒ–å›å¤
                        </small>

                        <!-- AI é…ç½®è®¾ç½® -->
                        <hr style="margin: 15px 0; border: none; border-top: 1px solid #444;">

                        <div class="flex-container">
                            <label for="ai-api-select" style="display: block; margin-bottom: 8px; font-weight: bold;">
                                ğŸ¤– AI API é…ç½®
                            </label>
                            <select id="ai-api-select" style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px;">
                                <option value="">è¯·é€‰æ‹©APIç±»å‹...</option>
                                <option value="openai">OpenAI</option>
                                <option value="claude">Claude</option>
                                <option value="google">Google</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="mistral">Mistral AI</option>
                                <option value="ollama">Ollama (æœ¬åœ°)</option>
                                <option value="custom">è‡ªå®šä¹‰API</option>
                            </select>
                        </div>

                        <!-- APIé…ç½®è¾“å…¥æ¡† -->
                        <div id="ai-config-container" style="display: none; margin-top: 10px;">
                            <div style="margin-bottom: 10px;">
                                <label for="ai-url-input" style="display: block; margin-bottom: 5px; font-size: 0.9em;">
                                    API URL:
                                </label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input id="ai-url-input" type="text" placeholder="ä¾‹å¦‚: https://api.openai.com/v1 (åªéœ€å¡«å†™åˆ°/v1ï¼Œä¼šè‡ªåŠ¨æ·»åŠ ç«¯ç‚¹)"
                                           style="flex: 1; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                                    <button id="ai-url-reset-btn" type="button"
                                            style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.85em; white-space: nowrap; color: #666;"
                                            title="é‡ç½®ä¸ºå½“å‰APIç±»å‹çš„å®˜æ–¹ç«¯ç‚¹">
                                        ğŸ”„ é‡ç½®
                                    </button>
                                </div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 3px;">
                                    ğŸ’¡ æç¤ºï¼šåªéœ€å¡«å†™åˆ° /v1ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨æ·»åŠ  /chat/completions ç«¯ç‚¹ã€‚ç‚¹å‡»é‡ç½®æŒ‰é’®å¯æ¢å¤å®˜æ–¹ç«¯ç‚¹
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="ai-key-input" style="display: block; margin-bottom: 5px; font-size: 0.9em;">
                                    API Key:
                                </label>
                                <input id="ai-key-input" type="password" placeholder="è¾“å…¥ä½ çš„APIå¯†é’¥"
                                       style="width: 100%; padding: 6px; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="ai-model-select" style="display: block; margin-bottom: 5px; font-size: 0.9em;">
                                    æ¨¡å‹åç§°:
                                </label>
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                    <select id="ai-model-select" style="flex: 1; padding: 6px; border-radius: 4px; font-size: 0.9em;">
                                        <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                        <option value="gemini-pro">Gemini Pro</option>
                                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                        <option value="deepseek-chat">DeepSeek Chat</option>
                                        <option value="deepseek-coder">DeepSeek Coder</option>
                                        <option value="custom">ğŸ”§ è‡ªå®šä¹‰æ¨¡å‹</option>
                                    </select>
                                    <button id="refresh-models-btn" style="
                                        padding: 6px 10px;
                                        background: #4a90e2;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 0.8em;
                                        white-space: nowrap;
                                    " title="ä»é…ç½®çš„APIè·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨">
                                        ğŸ”„ è·å–
                                    </button>
                                </div>
                                <input id="ai-model-input" type="text" placeholder="è‡ªå®šä¹‰æ¨¡å‹åç§°"
                                       style="width: 100%; padding: 6px; border-radius: 4px; display: none;">
                            </div>
                        </div>

                        <div class="flex-container" style="margin-top: 10px;">
                            <button id="test-ai-connection-btn" style="padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                ğŸ”— æµ‹è¯•è¿æ¥
                            </button>
                            <span id="ai-connection-status" style="padding: 8px; font-size: 0.9em; color: #888;">
                                æœªæµ‹è¯•
                            </span>
                        </div>

                        <small class="notes" style="margin-top: 10px; display: block;">
                            é…ç½®AI APIç”¨äºç”Ÿæˆä¸ªæ€§åŒ–çš„å® ç‰©å›å¤ï¼ŒAIä¼šæ ¹æ®é€‰æ‹©çš„äººè®¾æ¥å›åº”
                        </small>

                        <!-- Firebase äº‘ç«¯å¤‡ä»½è®¾ç½® -->
                        <hr style="margin: 15px 0; border: none; border-top: 1px solid #444;">

                        <div class="flex-container">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                                â˜ï¸ äº‘ç«¯å¤‡ä»½
                            </label>
                            <small class="notes" style="margin-bottom: 10px; display: block;">
                                è·¨è®¾å¤‡åŒæ­¥å® ç‰©æ•°æ®ã€AIè®¾ç½®å’Œå¤´åƒ
                            </small>
                        </div>

                        <!-- ç®€åŒ–çš„çŠ¶æ€å’Œæ“ä½œåŒºåŸŸ -->
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span id="firebase-status-icon">âšª</span>
                                    <span id="firebase-status-text" style="font-size: 0.9em;">æœªè¿æ¥</span>
                                </div>
                                <button id="firebase-init-btn" class="firebase-btn firebase-btn-primary" style="padding: 6px 12px; font-size: 0.85em;">
                                    ğŸ”— è¿æ¥
                                </button>
                            </div>

                            <!-- ä¸»è®¾å¤‡åŠŸèƒ½ -->
                            <div id="firebase-primary-controls" style="display: none; margin-bottom: 10px;">
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <button id="firebase-generate-code-btn" class="firebase-btn firebase-btn-secondary" style="flex: 1; padding: 6px; font-size: 0.85em;">
                                        ğŸ”‘ ç”Ÿæˆè¿æ¥ç 
                                    </button>
                                    <button id="firebase-backup-now-btn" class="firebase-btn firebase-btn-success" style="flex: 1; padding: 6px; font-size: 0.85em;">
                                        â˜ï¸ å¤‡ä»½
                                    </button>
                                </div>

                                <!-- è¿æ¥ç æ˜¾ç¤º -->
                                <div id="firebase-connection-code-display" style="display: none; margin-bottom: 8px;">
                                    <label style="font-size: 0.85em; margin-bottom: 4px; display: block; color: #28a745; font-weight: bold;">
                                        ğŸ”‘ è¿æ¥ç ï¼ˆåˆ†äº«ç»™å…¶ä»–è®¾å¤‡ï¼‰
                                    </label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="text" id="firebase-connection-code-text" readonly
                                               style="flex: 1; padding: 8px; border: 2px solid #28a745; border-radius: 4px; background: #f8fff9; font-family: monospace; font-size: 16px; text-align: center; letter-spacing: 2px; font-weight: bold;">
                                        <button id="firebase-copy-code-btn" class="firebase-btn firebase-btn-outline" style="padding: 8px 12px; font-size: 0.85em;">
                                            ğŸ“‹ å¤åˆ¶
                                        </button>
                                    </div>
                                    <small style="color: #28a745; margin-top: 4px; display: block; font-size: 0.8em; text-align: center;">
                                        â° æœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼Œè¯·å°½å¿«åœ¨å…¶ä»–è®¾å¤‡ä¸Šä½¿ç”¨
                                    </small>
                                </div>
                            </div>

                            <!-- ä»è®¾å¤‡åŠŸèƒ½ -->
                            <div id="firebase-secondary-controls">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="text" id="firebase-connection-code-input" placeholder="è¾“å…¥è¿æ¥ç "
                                           maxlength="6" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 14px; text-align: center; text-transform: uppercase;">
                                    <button id="firebase-connect-btn" class="firebase-btn firebase-btn-primary" style="padding: 6px 12px; font-size: 0.85em;">
                                        è¿æ¥
                                    </button>
                                </div>
                            </div>

                            <!-- å·²è¿æ¥åçš„ç®¡ç†åŠŸèƒ½ -->
                            <div id="firebase-management-controls" style="display: none; margin-top: 10px;">
                                <div style="display: flex; gap: 8px;">
                                    <button id="firebase-restore-btn" class="firebase-btn firebase-btn-info" style="flex: 1; padding: 6px; font-size: 0.85em;">
                                        ğŸ“¥ æ¢å¤
                                    </button>
                                    <button id="firebase-disconnect-btn" class="firebase-btn firebase-btn-danger" style="flex: 1; padding: 6px; font-size: 0.85em;">
                                        æ–­å¼€
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        $("#extensions_settings2").append(simpleSettingsHtml);
        console.log(`[${extensionName}] Settings panel created`);

        // åˆå§‹åŒ–è®¾ç½®é¢æ¿
        initializeSettingsPanel();

        // 3. åŠ è½½å¼¹çª—HTMLï¼ˆå¦‚æœå¤±è´¥å°±ä½¿ç”¨ç®€å•ç‰ˆæœ¬ï¼‰
        // æ£€æµ‹æ˜¯å¦ä¸ºiOSè®¾å¤‡ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡åŸå§‹å¼¹çª—åˆ›å»º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

        if (!isIOS) {
            try {
                console.log(`[${extensionName}] Loading popup HTML...`);
                const popupHtml = await $.get(`${extensionFolderPath}/popup.html`);
                $("body").append(popupHtml);
                console.log(`[${extensionName}] Popup HTML loaded successfully`);
            } catch (error) {
                console.warn(`[${extensionName}] Failed to load popup.html, using simple version:`, error);
                // åˆ›å»ºç®€å•çš„å¼¹çª—HTML
            const simplePopupHtml = `
                <div id="virtual-pet-popup-overlay" class="virtual-pet-popup-overlay">
                    <div id="virtual-pet-popup" class="pet-popup-container">
                        <div class="pet-popup-header" style="display: none;">
                            <div class="pet-popup-title"></div>
                        </div>
                        <div class="pet-popup-body">
                            <div id="pet-main-view" class="pet-view">
                                <div class="pet-section">
                                    <div id="pet-status-container">
                                        <div class="pet-avatar">
                                            <div class="pet-emoji">ğŸ±</div>
                                            <div class="pet-name">å°å® ç‰©</div>
                                            <div class="pet-level">Lv.1</div>
                                        </div>
                                        <p>å® ç‰©ç³»ç»Ÿæ­£åœ¨å¼€å‘ä¸­...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                $("body").append(simplePopupHtml);
            }
        } else {
            console.log(`[${extensionName}] iOS detected, skipping original popup creation`);
        }

        // 3. è·å– DOM å¼•ç”¨ï¼ˆåªåœ¨éiOSè®¾å¤‡ä¸Šï¼‰
        if (!isIOS) {
            overlay = $(`#${OVERLAY_ID}`);
            mainView = $("#pet-main-view");
            petView = $("#pet-detail-view");
            settingsView = $("#pet-settings-view");
            chatView = $("#pet-chat-view");
            petContainer = $("#pet-status-container");
        }

        // 4. åŠ è½½å® ç‰©æ•°æ®
        loadPetData();

        // 4.1 ç¡®ä¿æ‹“éº»æ­Œå­ç³»ç»Ÿå·²åº”ç”¨
        if (petData.dataVersion >= 4.0) {
            applyTamagotchiSystem();
        } else {
            // æ—§ç‰ˆæœ¬æ•°æ®è‡ªåŠ¨å‡çº§åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿ
            petData.dataVersion = 4.0;
            applyTamagotchiSystem();
            savePetData();
        }

        // 5. åŠ è½½è‡ªå®šä¹‰å¤´åƒæ•°æ®
        loadCustomAvatar();

        // 5. åªåœ¨éiOSè®¾å¤‡ä¸Šåˆå§‹åŒ–åŸå§‹å¼¹çª—åŠŸèƒ½
        if (!isIOS) {
            // ä½¿å¼¹çª—å¯æ‹–æ‹½
            const $popup = $(`#${POPUP_ID}`);
            if ($popup.length > 0) {
                makePopupDraggable($popup);
                console.log(`[${extensionName}] Popup drag functionality added`);
            }

            // ç§»é™¤äº†å…³é—­æŒ‰é’®ï¼Œç°åœ¨åªèƒ½é€šè¿‡æ‚¬æµ®æŒ‰é’®æˆ–å¤–éƒ¨ç‚¹å‡»å…³é—­

            if (overlay && overlay.length > 0) {
                overlay.on("click touchend", function (event) {
                    if (event.target === this) {
                        event.preventDefault();
                        closePopup();
                    }
                });
            }
        }

        $(`#${POPUP_ID}`).on("click touchend", (e) => e.stopPropagation());

        // å® ç‰©äº¤äº’æŒ‰é’®
        $("#feed-pet-btn").on("click touchend", (e) => {
            e.preventDefault();
            feedPet();
        });

        $("#play-pet-btn").on("click touchend", (e) => {
            e.preventDefault();
            playWithPet();
        });

        $("#sleep-pet-btn").on("click touchend", (e) => {
            e.preventDefault();
            petSleep();
        });



        // è§†å›¾åˆ‡æ¢æŒ‰é’®
        $("#goto-pet-detail-btn").on("click touchend", (e) => {
            e.preventDefault();
            showPetView();
        });

        $("#goto-settings-btn").on("click touchend", (e) => {
            e.preventDefault();
            showSettingsView();
        });

        // è¿”å›ä¸»è§†å›¾æŒ‰é’® (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
        $(".pet-popup-body").on("click touchend", ".back-to-main-btn", (e) => {
            e.preventDefault();
            showMainView();
        });

        // è®¾ç½®ç›¸å…³æŒ‰é’®
        $("#save-settings-btn").on("click touchend", (e) => {
            e.preventDefault();
            saveSettings();
        });

        $("#reset-pet-btn").on("click touchend", (e) => {
            e.preventDefault();
            resetPet();
        });

        // 6. åˆå§‹çŠ¶æ€
        console.log(`[${extensionName}] Setting up initial state...`);

        // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
        setTimeout(() => {
            const isEnabled = localStorage.getItem(STORAGE_KEY_ENABLED) !== "false";
            console.log(`[${extensionName}] Extension enabled: ${isEnabled}`);

            const toggleElement = $(TOGGLE_ID);
            if (toggleElement.length === 0) {
                console.warn(`[${extensionName}] Toggle element not found: ${TOGGLE_ID}`);
                console.log(`[${extensionName}] Available elements:`, $("#extensions_settings2").find("input[type='checkbox']").length);
            } else {
                toggleElement.prop("checked", isEnabled);
                console.log(`[${extensionName}] Toggle element found and set`);
            }

            if (isEnabled) {
                console.log(`[${extensionName}] Initializing floating button...`);
                initializeFloatingButton();
            }

            // ç»‘å®šå¼€å…³äº‹ä»¶
            $(document).off("change", TOGGLE_ID).on("change", TOGGLE_ID, function () {
                const checked = $(this).is(":checked");
                console.log(`[${extensionName}] Toggle changed: ${checked}`);
                localStorage.setItem(STORAGE_KEY_ENABLED, checked);
                if (checked) {
                    initializeFloatingButton();
                } else {
                    destroyFloatingButton();
                }
            });

            console.log(`[${extensionName}] Initial setup complete`);
        }, 1000); // ç­‰å¾…1ç§’ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åŠ è½½

        // 7. å®šæœŸæ›´æ–°å® ç‰©çŠ¶æ€
        setInterval(() => {
            updatePetStatus();
            if (overlay && overlay.is(":visible")) {
                renderPetStatus();
                // å¦‚æœåœ¨è¯¦æƒ…è§†å›¾ï¼Œä¹Ÿæ›´æ–°è¯¦æƒ…
                if (petView.is(":visible")) {
                    renderPetDetails();
                }
            }
        }, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡

        // 8. é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ›´æ–°çŠ¶æ€
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updatePetStatus();
                if (overlay && overlay.is(":visible")) {
                    renderPetStatus();
                }
            }
        });

        // 9. å¦‚æœæ˜¯iOSè®¾å¤‡ï¼Œåˆ›å»ºæµ‹è¯•æŒ‰é’®
        if (isIOS) {
            console.log(`[${extensionName}] iOS detected, creating test button`);
            setTimeout(() => {
                if (typeof window.createIOSTestButton === 'function') {
                    window.createIOSTestButton();
                }
            }, 3000); // å»¶è¿Ÿ3ç§’åˆ›å»ºï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
        }

        // 10. è®¾ç½®å¸è½½æ£€æµ‹
        setupUnloadDetection();

        console.log(`[${extensionName}] Extension loaded successfully.`);
    }

    // è¿è¡Œåˆå§‹åŒ–
    try {
        await initializeExtension();
    } catch (error) {
        console.error(`[${extensionName}] Initialization failed:`, error);
        if (typeof toastr !== 'undefined') {
            toastr.error(`Extension "${extensionName}" failed to initialize: ${error.message}`);
        }
    }



    // å¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’®å‡½æ•°
    window.forceShowPetButton = function() {
        console.log("ğŸ¾ å¼ºåˆ¶æ˜¾ç¤ºå® ç‰©æŒ‰é’®...");

        // ç§»é™¤ç°æœ‰æŒ‰é’®
        $(`#${BUTTON_ID}`).remove();

        // åˆ›å»ºæŒ‰é’®å¹¶å¼ºåˆ¶è®¾ç½®æ ·å¼ï¼Œç¡®ä¿æ­£ç¡®å®šä½
        const buttonHtml = `
            <div id="${BUTTON_ID}" style="
                position: fixed !important;
                z-index: ${SAFE_Z_INDEX.button} !important;
                cursor: grab !important;
                width: 48px !important;
                height: 48px !important;
                background: linear-gradient(145deg, ${candyColors.primary}, ${candyColors.buttonHover}) !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                color: #7289da !important;
                font-size: 24px !important;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 2px 2px rgba(255,255,255,0.05), 0 0 0 1px rgba(0,0,0,0.5) !important;
                user-select: none !important;
                opacity: 1 !important;
                visibility: visible !important;
                pointer-events: auto !important;
                transform: none !important;
                margin: 0 !important;
                top: 200px !important;
                left: 20px !important;
                bottom: auto !important;
                right: auto !important;
            ">ğŸ¾</div>
        `;

        $("body").append(buttonHtml);

        const $button = $(`#${BUTTON_ID}`);
        console.log("ğŸ¾ æŒ‰é’®åˆ›å»ºç»“æœ:", $button.length > 0 ? "æˆåŠŸ" : "å¤±è´¥");

        if ($button.length > 0) {
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            $button.off().on("click touchend", function(e) {
                e.preventDefault();
                console.log("ğŸ¾ æŒ‰é’®è¢«ç‚¹å‡»");

                try {
                    // æ‰€æœ‰å¹³å°éƒ½ä½¿ç”¨ç»Ÿä¸€çš„showPopupå‡½æ•°
                    showPopup();
                } catch (error) {
                    console.error("æ˜¾ç¤ºå¼¹çª—å‡ºé”™:", error);
                    alert("ğŸ¾ è™šæ‹Ÿå® ç‰©\n\nå¼¹çª—åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...");
                }
            });

            // ä½¿æŒ‰é’®å¯æ‹–åŠ¨
            makeButtonDraggable($button);

            console.log("ğŸ¾ æŒ‰é’®åº”è¯¥ç°åœ¨å¯è§äº†ï¼");
        }

        return $button.length > 0;
    };

    // å…¨å±€æŒ‰é’®ä¿®å¤å‡½æ•°
    window.fixPetButtonPosition = function() {
        console.log("ğŸ”§ æ£€æŸ¥å¹¶ä¿®å¤æŒ‰é’®ä½ç½®...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°åˆ›å»º");
            return window.forceShowPetButton();
        }

        const rect = button[0].getBoundingClientRect();
        const styles = window.getComputedStyle(button[0]);

        console.log("å½“å‰æŒ‰é’®çŠ¶æ€:", {
            position: styles.position,
            top: rect.top,
            left: rect.left,
            visible: rect.width > 0 && rect.height > 0,
            inViewport: rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth
        });

        // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤
        const needsFix = styles.position !== 'fixed' ||
                        rect.top < 0 || rect.top > window.innerHeight ||
                        rect.left < 0 || rect.left > window.innerWidth ||
                        rect.width === 0 || rect.height === 0;

        if (needsFix) {
            console.log("ğŸ”§ ä¿®å¤æŒ‰é’®ä½ç½®å’Œæ ·å¼...");
            button.css({
                'position': 'fixed !important',
                'top': '200px !important',
                'left': '20px !important',
                'width': '48px !important',
                'height': '48px !important',
                'z-index': `${SAFE_Z_INDEX.button} !important`,
                'display': 'flex !important',
                'visibility': 'visible !important',
                'opacity': '1 !important',
                'transform': 'none !important',
                'margin': '0 !important',
                'pointer-events': 'auto !important'
            });

            setTimeout(() => {
                const newRect = button[0].getBoundingClientRect();
                console.log("ä¿®å¤åä½ç½®:", newRect);
                console.log(newRect.top >= 0 && newRect.top <= window.innerHeight ? "âœ… ä¿®å¤æˆåŠŸ" : "âŒ ä¿®å¤å¤±è´¥");
            }, 100);

            return true;
        } else {
            console.log("âœ… æŒ‰é’®ä½ç½®æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤");
            return true;
        }
    };

    // ç«‹å³ä¿®å¤æ‹–åŠ¨é—®é¢˜
    window.fixDragIssue = function() {
        console.log("ğŸ”§ ç«‹å³ä¿®å¤æ‹–åŠ¨é—®é¢˜...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        // ç§»é™¤æ‰€æœ‰å¯èƒ½å†²çªçš„äº‹ä»¶
        button.off('.petdrag');
        $(document).off('.petdragtemp');

        // é‡æ–°ç»‘å®šæ‹–åŠ¨äº‹ä»¶ï¼Œä½¿ç”¨æ›´å¼ºçš„æ ·å¼è®¾ç½®
        let isDragging = false;
        let wasDragged = false;
        let dragStartX, dragStartY, startX, startY;
        let dragTimeout;

        const onDragStart = (e) => {
            console.log("ğŸ¯ å¼€å§‹æ‹–åŠ¨");
            isDragging = true;
            wasDragged = false;

            const touch = e.originalEvent && e.originalEvent.touches && e.originalEvent.touches[0];
            const pageX = touch ? touch.pageX : e.pageX;
            const pageY = touch ? touch.pageY : e.pageY;

            startX = pageX;
            startY = pageY;

            const rect = button[0].getBoundingClientRect();
            dragStartX = pageX - rect.left;
            dragStartY = pageY - rect.top;

            e.preventDefault();
            e.stopPropagation();

            $(document).on("mousemove.fixdrag", onDragMove);
            $(document).on("touchmove.fixdrag", onDragMove);
            $(document).on("mouseup.fixdrag", onDragEnd);
            $(document).on("touchend.fixdrag", onDragEnd);
        };

        const onDragMove = (e) => {
            if (!isDragging) return;

            const touch = e.originalEvent && e.originalEvent.touches && e.originalEvent.touches[0];
            const pageX = touch ? touch.pageX : e.pageX;
            const pageY = touch ? touch.pageY : e.pageY;

            const deltaX = Math.abs(pageX - startX);
            const deltaY = Math.abs(pageY - startY);

            if (deltaX > 5 || deltaY > 5) {
                wasDragged = true;
            }

            if (wasDragged) {
                e.preventDefault();

                let newX = pageX - dragStartX;
                let newY = pageY - dragStartY;

                // è¾¹ç•Œé™åˆ¶
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const safeMargin = 10;

                newX = Math.max(safeMargin, Math.min(newX, windowWidth - 48 - safeMargin));
                newY = Math.max(safeMargin, Math.min(newY, windowHeight - 48 - safeMargin));

                // ä½¿ç”¨æœ€å¼ºçš„æ ·å¼è®¾ç½®æ–¹æ³•
                const element = button[0];
                element.style.setProperty('position', 'fixed', 'important');
                element.style.setProperty('top', newY + 'px', 'important');
                element.style.setProperty('left', newX + 'px', 'important');
                element.style.setProperty('transform', 'none', 'important');
                element.style.setProperty('z-index', SAFE_Z_INDEX.button, 'important');

                console.log(`ğŸ¯ ç§»åŠ¨åˆ°: ${newX}, ${newY}`);
            }
        };

        const onDragEnd = () => {
            if (isDragging) {
                console.log("ğŸ¯ æ‹–åŠ¨ç»“æŸ");
                isDragging = false;

                $(document).off(".fixdrag");

                if (wasDragged) {
                    const rect = button[0].getBoundingClientRect();
                    localStorage.setItem(STORAGE_KEY_BUTTON_POS, JSON.stringify({
                        x: Math.round(rect.left),
                        y: Math.round(rect.top)
                    }));

                    clearTimeout(dragTimeout);
                    dragTimeout = setTimeout(() => {
                        wasDragged = false;
                    }, 200);
                }
            }
        };

        // ç»‘å®šæ–°çš„äº‹ä»¶
        button.on("mousedown.fixdrag", onDragStart);
        button.on("touchstart.fixdrag", onDragStart);

        console.log("âœ… æ‹–åŠ¨ä¿®å¤å®Œæˆï¼Œè¯·å°è¯•æ‹–åŠ¨æŒ‰é’®");
        return true;
    };

    // ç«‹å³ä¿®å¤ç‚¹å‡»å¼¹çª—é—®é¢˜
    window.fixClickIssue = function() {
        console.log("ğŸ”§ ä¿®å¤ç‚¹å‡»å¼¹çª—é—®é¢˜...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        // æ¸…é™¤æ‰€æœ‰äº‹ä»¶
        button.off();
        $(document).off('.petdragtemp');

        // é‡æ–°ç»‘å®šç®€åŒ–çš„äº‹ä»¶å¤„ç†
        let isDragging = false;
        let wasDragged = false;
        let startX, startY;

        button.on('mousedown touchstart', function(e) {
            isDragging = true;
            wasDragged = false;

            const touch = e.originalEvent && e.originalEvent.touches && e.originalEvent.touches[0];
            startX = touch ? touch.pageX : e.pageX;
            startY = touch ? touch.pageY : e.pageY;

            e.preventDefault();

            $(document).on('mousemove.temp touchmove.temp', function(moveE) {
                if (!isDragging) return;

                const moveTouch = moveE.originalEvent && moveE.originalEvent.touches && moveE.originalEvent.touches[0];
                const moveX = moveTouch ? moveTouch.pageX : moveE.pageX;
                const moveY = moveTouch ? moveTouch.pageY : moveE.pageY;

                const deltaX = Math.abs(moveX - startX);
                const deltaY = Math.abs(moveY - startY);

                if (deltaX > 8 || deltaY > 8) {
                    wasDragged = true;

                    // ç›´æ¥è®¾ç½®ä½ç½®
                    const rect = button[0].getBoundingClientRect();
                    const newX = moveX - (startX - rect.left);
                    const newY = moveY - (startY - rect.top);

                    button[0].style.setProperty('left', newX + 'px', 'important');
                    button[0].style.setProperty('top', newY + 'px', 'important');
                }
            });

            $(document).on('mouseup.temp touchend.temp', function() {
                isDragging = false;
                $(document).off('.temp');

                if (!wasDragged) {
                    // æ²¡æœ‰æ‹–åŠ¨ï¼Œè§¦å‘ç‚¹å‡»
                    console.log("ğŸ¯ è§¦å‘å¼¹çª—");
                    try {
                        showPopup();
                    } catch (error) {
                        console.error("å¼¹çª—é”™è¯¯:", error);
                        alert("ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ\n\nå¼¹çª—åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...");
                    }
                }

                // é‡ç½®æ‹–åŠ¨æ ‡å¿—
                setTimeout(() => {
                    wasDragged = false;
                }, 100);
            });
        });

        console.log("âœ… ç‚¹å‡»ä¿®å¤å®Œæˆ");
        return true;
    };

    // ç«‹å³ä¿®å¤æ‹–åŠ¨ä½ç½®è®¡ç®—é—®é¢˜
    window.fixDragPositionIssue = function() {
        console.log("ğŸ”§ ä¿®å¤æ‹–åŠ¨ä½ç½®è®¡ç®—é—®é¢˜...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        // æ¸…é™¤æ‰€æœ‰äº‹ä»¶
        button.off();
        $(document).off('.petdragtemp');

        // é‡æ–°ç»‘å®šæ­£ç¡®çš„æ‹–åŠ¨é€»è¾‘
        let isDragging = false;
        let wasDragged = false;
        let startX, startY, dragStartX, dragStartY;

        button.on('mousedown touchstart', function(e) {
            console.log("ğŸ¯ å¼€å§‹äº¤äº’");
            isDragging = true;
            wasDragged = false;

            const touch = e.originalEvent && e.originalEvent.touches && e.originalEvent.touches[0];
            startX = touch ? touch.pageX : e.pageX;
            startY = touch ? touch.pageY : e.pageY;

            // è®°å½•æŒ‰é’®ç›¸å¯¹äºé¼ æ ‡çš„åç§»é‡
            const rect = button[0].getBoundingClientRect();
            dragStartX = startX - rect.left;
            dragStartY = startY - rect.top;

            console.log(`åˆå§‹ä½ç½®: é¼ æ ‡(${startX}, ${startY}), æŒ‰é’®(${rect.left}, ${rect.top}), åç§»(${dragStartX}, ${dragStartY})`);

            e.preventDefault();

            $(document).on('mousemove.temp touchmove.temp', function(moveE) {
                if (!isDragging) return;

                const moveTouch = moveE.originalEvent && moveE.originalEvent.touches && moveE.originalEvent.touches[0];
                const moveX = moveTouch ? moveTouch.pageX : moveE.pageX;
                const moveY = moveTouch ? moveTouch.pageY : moveE.pageY;

                const deltaX = Math.abs(moveX - startX);
                const deltaY = Math.abs(moveY - startY);

                if (deltaX > 8 || deltaY > 8) {
                    if (!wasDragged) {
                        wasDragged = true;
                        console.log("ğŸ¯ æ£€æµ‹åˆ°æ‹–åŠ¨");
                        button.css({
                            "opacity": "0.8",
                            "transform": "scale(1.05)"
                        });
                    }

                    // æ­£ç¡®è®¡ç®—æ–°ä½ç½®
                    const newX = moveX - dragStartX;
                    const newY = moveY - dragStartY;

                    // è¾¹ç•Œé™åˆ¶
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    const safeX = Math.max(10, Math.min(newX, windowWidth - 58));
                    const safeY = Math.max(10, Math.min(newY, windowHeight - 58));

                    console.log(`ç§»åŠ¨åˆ°: é¼ æ ‡(${moveX}, ${moveY}) â†’ æŒ‰é’®(${safeX}, ${safeY})`);

                    button[0].style.setProperty('left', safeX + 'px', 'important');
                    button[0].style.setProperty('top', safeY + 'px', 'important');
                    button[0].style.setProperty('position', 'fixed', 'important');
                }
            });

            $(document).on('mouseup.temp touchend.temp', function() {
                console.log("ğŸ¯ äº¤äº’ç»“æŸï¼Œæ‹–åŠ¨çŠ¶æ€:", wasDragged);
                isDragging = false;
                $(document).off('.temp');

                button.css({
                    "opacity": "1",
                    "transform": "none"
                });

                if (!wasDragged) {
                    console.log("ğŸ¯ è§¦å‘å¼¹çª—");
                    try {
                        if (typeof showPopup === 'function') {
                            showPopup();
                        } else {
                            alert("ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ\n\nå¼¹çª—åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...");
                        }
                    } catch (error) {
                        console.error("å¼¹çª—é”™è¯¯:", error);
                        alert("ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ\n\nå¼¹çª—åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...");
                    }
                } else {
                    // ä¿å­˜ä½ç½®
                    const rect = button[0].getBoundingClientRect();
                    localStorage.setItem(STORAGE_KEY_BUTTON_POS, JSON.stringify({
                        x: Math.round(rect.left),
                        y: Math.round(rect.top)
                    }));
                    console.log("ğŸ¯ ä½ç½®å·²ä¿å­˜:", { x: rect.left, y: rect.top });
                }

                setTimeout(() => {
                    wasDragged = false;
                }, 50);
            });
        });

        console.log("âœ… æ‹–åŠ¨ä½ç½®ä¿®å¤å®Œæˆ");
        return true;
    };

    // æµ‹è¯•æ‚¬æµ®æŒ‰é’®åˆ‡æ¢åŠŸèƒ½
    window.testToggleFunction = function() {
        console.log("ğŸ¯ æµ‹è¯•æ‚¬æµ®æŒ‰é’®åˆ‡æ¢åŠŸèƒ½...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æ‚¬æµ®æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        console.log("âœ… æ‚¬æµ®æŒ‰é’®å­˜åœ¨");
        console.log(`å½“å‰å¼¹çª—çŠ¶æ€: ${isPopupOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);

        // æ£€æŸ¥å¼¹çª—å®é™…çŠ¶æ€
        const overlay = $(`#${OVERLAY_ID}`);
        const actuallyOpen = overlay.length > 0;
        console.log(`å®é™…å¼¹çª—çŠ¶æ€: ${actuallyOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);

        // çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥
        const stateConsistent = isPopupOpen === actuallyOpen;
        console.log(`çŠ¶æ€ä¸€è‡´æ€§: ${stateConsistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}`);

        // æ¨¡æ‹Ÿç‚¹å‡»æµ‹è¯•
        console.log("ğŸ¯ æ¨¡æ‹Ÿç‚¹å‡»æ‚¬æµ®æŒ‰é’®...");
        const initialState = isPopupOpen;

        try {
            // ç›´æ¥è°ƒç”¨åˆ‡æ¢å‡½æ•°
            togglePopup();

            setTimeout(() => {
                const newState = isPopupOpen;
                const newOverlay = $(`#${OVERLAY_ID}`);
                const newActuallyOpen = newOverlay.length > 0;

                console.log(`ç‚¹å‡»åçŠ¶æ€: ${newState ? 'æ‰“å¼€' : 'å…³é—­'}`);
                console.log(`ç‚¹å‡»åå®é™…: ${newActuallyOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);

                const stateChanged = initialState !== newState;
                const actualChanged = actuallyOpen !== newActuallyOpen;
                const bothChanged = stateChanged && actualChanged;

                console.log(`çŠ¶æ€å˜åŒ–: ${stateChanged ? 'âœ…' : 'âŒ'}`);
                console.log(`å®é™…å˜åŒ–: ${actualChanged ? 'âœ…' : 'âŒ'}`);
                console.log(`åˆ‡æ¢æˆåŠŸ: ${bothChanged ? 'âœ…' : 'âŒ'}`);

                // å†æ¬¡ç‚¹å‡»æµ‹è¯•
                console.log("ğŸ¯ å†æ¬¡ç‚¹å‡»æµ‹è¯•...");
                togglePopup();

                setTimeout(() => {
                    const finalState = isPopupOpen;
                    const finalOverlay = $(`#${OVERLAY_ID}`);
                    const finalActuallyOpen = finalOverlay.length > 0;

                    console.log(`æœ€ç»ˆçŠ¶æ€: ${finalState ? 'æ‰“å¼€' : 'å…³é—­'}`);
                    console.log(`æœ€ç»ˆå®é™…: ${finalActuallyOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);

                    const backToOriginal = finalState === initialState;
                    const actualBackToOriginal = finalActuallyOpen === actuallyOpen;

                    console.log(`å›åˆ°åŸçŠ¶æ€: ${backToOriginal ? 'âœ…' : 'âŒ'}`);
                    console.log(`å®é™…å›åˆ°åŸçŠ¶æ€: ${actualBackToOriginal ? 'âœ…' : 'âŒ'}`);

                    const allGood = stateConsistent && bothChanged && backToOriginal && actualBackToOriginal;
                    console.log(`\nğŸ‰ åˆ‡æ¢åŠŸèƒ½æµ‹è¯•: ${allGood ? 'å®Œå…¨æˆåŠŸï¼' : 'éœ€è¦æ£€æŸ¥'}`);

                    if (allGood) {
                        console.log("âœ… æ‚¬æµ®æŒ‰é’®åˆ‡æ¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ");
                        console.log("ğŸ“‹ åŠŸèƒ½è¯´æ˜:");
                        console.log("  - ç‚¹å‡»æ‚¬æµ®æŒ‰é’®å¯ä»¥æ‰“å¼€å¼¹çª—");
                        console.log("  - å†æ¬¡ç‚¹å‡»æ‚¬æµ®æŒ‰é’®å¯ä»¥å…³é—­å¼¹çª—");
                        console.log("  - ç‚¹å‡»å¼¹çª—å¤–éƒ¨ä¹Ÿå¯ä»¥å…³é—­å¼¹çª—");
                        console.log("  - å¼¹çª—å†…éƒ¨æ²¡æœ‰å…³é—­æŒ‰é’®");
                    }

                    return allGood;
                }, 300);
            }, 300);
        } catch (error) {
            console.error("åˆ‡æ¢åŠŸèƒ½æµ‹è¯•å¤±è´¥:", error);
            return false;
        }

        return true;
    };

    // éªŒè¯æ‹–åŠ¨ä¿®å¤æ˜¯å¦æˆåŠŸ
    window.verifyDragFix = function() {
        console.log("ğŸ¯ éªŒè¯æ‹–åŠ¨ä¿®å¤æ•ˆæœ...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        // æ£€æŸ¥äº‹ä»¶ç»‘å®š
        const events = $._data(button[0], "events");
        const hasCorrectEvents = events && events.mousedown && events.touchstart;
        console.log(`äº‹ä»¶ç»‘å®š: ${hasCorrectEvents ? 'âœ…' : 'âŒ'}`);

        // æ£€æŸ¥å½“å‰ä½ç½®
        const rect = button[0].getBoundingClientRect();
        const inViewport = rect.top >= 0 && rect.left >= 0 &&
                          rect.bottom <= window.innerHeight && rect.right <= window.innerWidth;
        console.log(`ä½ç½®æ­£å¸¸: ${inViewport ? 'âœ…' : 'âŒ'} - (${rect.left}, ${rect.top})`);

        // æµ‹è¯•ä½ç½®è®¾ç½®åŠŸèƒ½
        const originalLeft = rect.left;
        const originalTop = rect.top;
        const testX = 100;
        const testY = 100;

        button[0].style.setProperty('left', testX + 'px', 'important');
        button[0].style.setProperty('top', testY + 'px', 'important');

        setTimeout(() => {
            const newRect = button[0].getBoundingClientRect();
            const positionWorks = Math.abs(newRect.left - testX) < 5 && Math.abs(newRect.top - testY) < 5;
            console.log(`ä½ç½®è®¾ç½®: ${positionWorks ? 'âœ…' : 'âŒ'}`);

            // æ¢å¤åŸä½ç½®
            button[0].style.setProperty('left', originalLeft + 'px', 'important');
            button[0].style.setProperty('top', originalTop + 'px', 'important');

            const allGood = hasCorrectEvents && inViewport && positionWorks;
            console.log(`\nğŸ‰ æ‹–åŠ¨ä¿®å¤éªŒè¯: ${allGood ? 'å®Œå…¨æˆåŠŸï¼' : 'éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥'}`);

            if (allGood) {
                console.log("âœ… æ‹–åŠ¨åŠŸèƒ½å·²å®Œå…¨ä¿®å¤å¹¶æ­£å¸¸å·¥ä½œ");
                console.log("ğŸ“‹ åŠŸèƒ½è¯´æ˜:");
                console.log("  - å¿«é€Ÿç‚¹å‡» â†’ æ˜¾ç¤ºå¼¹çª—");
                console.log("  - æŒ‰ä½æ‹–åŠ¨ â†’ ç§»åŠ¨æŒ‰é’®ä½ç½®");
                console.log("  - æ‹–åŠ¨æ—¶æœ‰è§†è§‰åé¦ˆ");
                console.log("  - è‡ªåŠ¨è¾¹ç•Œé™åˆ¶");
                console.log("  - ä½ç½®è‡ªåŠ¨ä¿å­˜");
            }

            return allGood;
        }, 100);

        return true;
    };

    // æœ€ç»ˆåŠŸèƒ½éªŒè¯æµ‹è¯•
    window.testFinalDragFix = function() {
        console.log("ğŸ¯ æœ€ç»ˆæ‹–åŠ¨ä¿®å¤éªŒè¯...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        console.log("âœ… æŒ‰é’®å­˜åœ¨");

        // æ£€æŸ¥äº‹ä»¶ç»‘å®š
        const events = $._data(button[0], "events");
        const hasMouseDown = events && events.mousedown && events.mousedown.length > 0;
        const hasTouchStart = events && events.touchstart && events.touchstart.length > 0;

        console.log(`äº‹ä»¶ç»‘å®šæ£€æŸ¥:`);
        console.log(`- mousedown: ${hasMouseDown ? 'âœ…' : 'âŒ'}`);
        console.log(`- touchstart: ${hasTouchStart ? 'âœ…' : 'âŒ'}`);

        // æ£€æŸ¥ä½ç½®
        const rect = button[0].getBoundingClientRect();
        const inViewport = rect.top >= 0 && rect.left >= 0 &&
                          rect.bottom <= window.innerHeight && rect.right <= window.innerWidth;
        console.log(`ä½ç½®æ£€æŸ¥: ${inViewport ? 'âœ…' : 'âŒ'} - (${rect.left}, ${rect.top})`);

        // æ¨¡æ‹Ÿä½ç½®æµ‹è¯•
        console.log("ğŸ¯ æµ‹è¯•ä½ç½®è®¾ç½®...");
        const testX = 250;
        const testY = 250;

        button[0].style.setProperty('left', testX + 'px', 'important');
        button[0].style.setProperty('top', testY + 'px', 'important');

        setTimeout(() => {
            const newRect = button[0].getBoundingClientRect();
            const positionCorrect = Math.abs(newRect.left - testX) < 5 && Math.abs(newRect.top - testY) < 5;
            console.log(`ä½ç½®è®¾ç½®æµ‹è¯•: ${positionCorrect ? 'âœ…' : 'âŒ'} - å®é™…ä½ç½®: (${newRect.left}, ${newRect.top})`);

            // æ¢å¤åŸä½ç½®
            button[0].style.setProperty('left', rect.left + 'px', 'important');
            button[0].style.setProperty('top', rect.top + 'px', 'important');

            // æ€»ç»“
            const allPassed = hasMouseDown && hasTouchStart && inViewport && positionCorrect;
            console.log(`\nğŸ¯ æœ€ç»ˆéªŒè¯ç»“æœ: ${allPassed ? 'ğŸ‰ å…¨éƒ¨é€šè¿‡ï¼' : 'âš ï¸ éƒ¨åˆ†å¤±è´¥'}`);

            if (allPassed) {
                console.log("âœ… æ‹–åŠ¨å’Œç‚¹å‡»åŠŸèƒ½å·²å®Œå…¨ä¿®å¤ï¼");
                console.log("ğŸ“‹ ä½¿ç”¨è¯´æ˜:");
                console.log("- å¿«é€Ÿç‚¹å‡»æŒ‰é’® â†’ æ˜¾ç¤ºå¼¹çª—");
                console.log("- æŒ‰ä½æ‹–åŠ¨æŒ‰é’® â†’ ç§»åŠ¨ä½ç½®");
                console.log("- æ‹–åŠ¨æ—¶æœ‰è§†è§‰åé¦ˆ â†’ åŠé€æ˜+æ”¾å¤§");
            } else {
                console.log("âŒ ä»æœ‰é—®é¢˜éœ€è¦è§£å†³");
            }

            return allPassed;
        }, 100);

        return true;
    };

    // ç«‹å³æµ‹è¯•åˆ‡æ¢åŠŸèƒ½
    window.testToggleNow = function() {
        console.log("ğŸ¯ ç«‹å³æµ‹è¯•æ‚¬æµ®æŒ‰é’®åˆ‡æ¢åŠŸèƒ½...");

        const button = $('#virtual-pet-button');
        if (button.length === 0) {
            console.log("âŒ æ‚¬æµ®æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        console.log("âœ… æ‚¬æµ®æŒ‰é’®å­˜åœ¨");

        // æ£€æŸ¥å½“å‰çŠ¶æ€
        const overlay = $('#virtual-pet-popup-overlay');
        const isCurrentlyOpen = overlay.length > 0;
        console.log(`å½“å‰å¼¹çª—çŠ¶æ€: ${isCurrentlyOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);

        // æ¨¡æ‹Ÿç‚¹å‡»
        console.log("ğŸ¯ æ¨¡æ‹Ÿç‚¹å‡»æ‚¬æµ®æŒ‰é’®...");

        // ç›´æ¥è§¦å‘ç‚¹å‡»äº‹ä»¶
        button.trigger('click');

        setTimeout(() => {
            const newOverlay = $('#virtual-pet-popup-overlay');
            const isNowOpen = newOverlay.length > 0;
            console.log(`ç‚¹å‡»åå¼¹çª—çŠ¶æ€: ${isNowOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);

            const stateChanged = isCurrentlyOpen !== isNowOpen;
            console.log(`çŠ¶æ€å˜åŒ–: ${stateChanged ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);

            if (stateChanged) {
                console.log("ğŸ¯ å†æ¬¡ç‚¹å‡»æµ‹è¯•...");
                button.trigger('click');

                setTimeout(() => {
                    const finalOverlay = $('#virtual-pet-popup-overlay');
                    const isFinallyOpen = finalOverlay.length > 0;
                    console.log(`å†æ¬¡ç‚¹å‡»åçŠ¶æ€: ${isFinallyOpen ? 'æ‰“å¼€' : 'å…³é—­'}`);

                    const backToOriginal = isFinallyOpen === isCurrentlyOpen;
                    console.log(`å›åˆ°åŸçŠ¶æ€: ${backToOriginal ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);

                    if (backToOriginal) {
                        console.log("ğŸ‰ åˆ‡æ¢åŠŸèƒ½æµ‹è¯•å®Œå…¨æˆåŠŸï¼");
                        console.log("ğŸ“‹ ä½¿ç”¨è¯´æ˜:");
                        console.log("  - ç‚¹å‡»æ‚¬æµ®æŒ‰é’® ğŸ¾ å¯ä»¥æ‰“å¼€/å…³é—­å¼¹çª—");
                        console.log("  - ç‚¹å‡»å¼¹çª—å¤–éƒ¨ä¹Ÿå¯ä»¥å…³é—­å¼¹çª—");
                        console.log("  - å¼¹çª—å†…éƒ¨å·²ç§»é™¤å…³é—­æŒ‰é’®");
                        console.log("  - æ“ä½œæ›´åŠ ç›´è§‚ç®€æ´");
                    } else {
                        console.log("âŒ åˆ‡æ¢åŠŸèƒ½æœ‰é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥");
                    }
                }, 300);
            } else {
                console.log("âŒ åˆ‡æ¢åŠŸèƒ½ä¸å·¥ä½œï¼Œå¯èƒ½éœ€è¦ä¿®å¤");
            }
        }, 300);

        return true;
    };

    // æµ‹è¯•æ‰€æœ‰ä¿®å¤çš„åŠŸèƒ½
    window.testAllFixedFeatures = function() {
        console.log("ğŸ¯ å¼€å§‹æµ‹è¯•æ‰€æœ‰ä¿®å¤çš„åŠŸèƒ½...");

        // 1. æµ‹è¯•ç©è€å›¾æ ‡
        console.log("\n1. æµ‹è¯•ç©è€å›¾æ ‡:");
        const playButtons = $('.play-btn span').first();
        const playIconText = playButtons.text();
        const playIconCorrect = playIconText.includes('ğŸ®') && !playIconText.includes('ï¿½');
        console.log(`ç©è€å›¾æ ‡: ${playIconCorrect ? 'âœ… æ­£ç¡®æ˜¾ç¤ºğŸ®' : 'âŒ æ˜¾ç¤ºå¼‚å¸¸: ' + playIconText}`);

        // 2. æµ‹è¯•å® ç‰©åå­—åŠŸèƒ½
        console.log("\n2. æµ‹è¯•å® ç‰©åå­—åŠŸèƒ½:");
        const petNameElements = $('.pet-name');
        const hasNameElements = petNameElements.length > 0;
        const hasClickEvent = petNameElements.first().attr('onclick') === 'editPetName()';
        const hasEditFunction = typeof window.editPetName === 'function';
        console.log(`åå­—å…ƒç´ : ${hasNameElements ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°'} (${petNameElements.length}ä¸ª)`);
        console.log(`ç‚¹å‡»äº‹ä»¶: ${hasClickEvent ? 'âœ… å·²ç»‘å®š' : 'âŒ æœªç»‘å®š'}`);
        console.log(`ç¼–è¾‘å‡½æ•°: ${hasEditFunction ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
        console.log(`å½“å‰åå­—: "${petData.name}"`);

        // 3. æµ‹è¯•æŒ‰é’®åŠŸèƒ½
        console.log("\n3. æµ‹è¯•æŒ‰é’®åŠŸèƒ½:");
        const feedBtn = $('.feed-btn');
        const playBtn = $('.play-btn');
        const sleepBtn = $('.sleep-btn');
        const hugBtn = $('.hug-btn');

        console.log(`å–‚é£ŸæŒ‰é’®: ${feedBtn.length > 0 ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
        console.log(`ç©è€æŒ‰é’®: ${playBtn.length > 0 ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
        console.log(`ç¡è§‰æŒ‰é’®: ${sleepBtn.length > 0 ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
        console.log(`æŠ±æŠ±æŒ‰é’®: ${hugBtn.length > 0 ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);

        // 4. æµ‹è¯•çŠ¶æ€æ•°å€¼
        console.log("\n4. æµ‹è¯•çŠ¶æ€æ•°å€¼:");
        console.log(`å¥åº·: ${Math.round(petData.health)}/100`);
        console.log(`é¥±é£Ÿåº¦: ${Math.round(petData.hunger)}/100`);
        console.log(`å¿«ä¹åº¦: ${Math.round(petData.happiness)}/100`);
        console.log(`ç²¾åŠ›: ${Math.round(petData.energy)}/100`);
        console.log(`ç­‰çº§: ${petData.level}`);

        // 5. æµ‹è¯•ç³–æœè‰²ä¸»é¢˜
        console.log("\n5. æµ‹è¯•ç³–æœè‰²ä¸»é¢˜:");
        const hasCandy = typeof candyColors !== 'undefined';
        console.log(`ç³–æœè‰²é…ç½®: ${hasCandy ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
        if (hasCandy) {
            console.log(`ä¸»è‰²è°ƒ: ${candyColors.primary}`);
            console.log(`èƒŒæ™¯: ${candyColors.background}`);
        }

        // 6. æµ‹è¯•UIæ›´æ–°å‡½æ•°
        console.log("\n6. æµ‹è¯•UIæ›´æ–°å‡½æ•°:");
        const hasUpdateFunction = typeof updateUnifiedUIStatus === 'function';
        console.log(`æ›´æ–°å‡½æ•°: ${hasUpdateFunction ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);

        // æ€»ç»“
        const allTests = [playIconCorrect, hasNameElements, hasClickEvent, hasEditFunction,
                         feedBtn.length > 0, playBtn.length > 0, sleepBtn.length > 0, hasCandy, hasUpdateFunction];
        const passedTests = allTests.filter(test => test).length;
        const totalTests = allTests.length;

        console.log(`\nğŸ¯ æµ‹è¯•æ€»ç»“: ${passedTests}/${totalTests} é¡¹é€šè¿‡`);

        if (passedTests === totalTests) {
            console.log("ğŸ‰ æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼");
        } else {
            console.log("âš ï¸ éƒ¨åˆ†åŠŸèƒ½éœ€è¦æ£€æŸ¥");
        }

        return {
            passed: passedTests,
            total: totalTests,
            success: passedTests === totalTests
        };
    };

    // æ¨¡æ‹ŸæŒ‰é’®ç‚¹å‡»æµ‹è¯•
    window.testButtonClicks = function() {
        console.log("ğŸ¯ æµ‹è¯•æŒ‰é’®ç‚¹å‡»åŠŸèƒ½...");

        const initialHealth = petData.health;
        const initialHunger = petData.hunger;
        const initialHappiness = petData.happiness;
        const initialEnergy = petData.energy;

        console.log("åˆå§‹çŠ¶æ€:", {
            health: Math.round(initialHealth),
            hunger: Math.round(initialHunger),
            happiness: Math.round(initialHappiness),
            energy: Math.round(initialEnergy)
        });

        // æ¨¡æ‹Ÿå–‚é£Ÿ
        console.log("\næ¨¡æ‹Ÿå–‚é£Ÿ...");
        feedPet();

        setTimeout(() => {
            console.log("å–‚é£ŸåçŠ¶æ€:", {
                health: Math.round(petData.health),
                hunger: Math.round(petData.hunger),
                happiness: Math.round(petData.happiness),
                energy: Math.round(petData.energy)
            });

            const hungerChanged = petData.hunger !== initialHunger;
            console.log(`é¥±é£Ÿåº¦å˜åŒ–: ${hungerChanged ? 'âœ… æ­£å¸¸' : 'âŒ æ— å˜åŒ–'}`);

            // æ¨¡æ‹Ÿç©è€
            console.log("\næ¨¡æ‹Ÿç©è€...");
            playWithPet();

            setTimeout(() => {
                console.log("ç©è€åçŠ¶æ€:", {
                    health: Math.round(petData.health),
                    hunger: Math.round(petData.hunger),
                    happiness: Math.round(petData.happiness),
                    energy: Math.round(petData.energy)
                });

                const happinessChanged = petData.happiness !== initialHappiness;
                console.log(`å¿«ä¹åº¦å˜åŒ–: ${happinessChanged ? 'âœ… æ­£å¸¸' : 'âŒ æ— å˜åŒ–'}`);

                // æ›´æ–°UIæ˜¾ç¤º
                updateUnifiedUIStatus();
                console.log("âœ… UIçŠ¶æ€å·²æ›´æ–°");

            }, 100);
        }, 100);
    };

    // å¼ºåˆ¶æ¸…ç†æ—§æ•°æ®å¹¶åº”ç”¨æ–°æ•°å€¼
    window.forceDataMigration = function() {
        console.log("ğŸ”„ å¼ºåˆ¶æ‰§è¡Œæ•°æ®è¿ç§»...");

        // æ¸…ç†localStorageä¸­çš„æ—§æ•°æ®
        localStorage.removeItem(STORAGE_KEY_PET_DATA);

        // é‡ç½®ä¸ºæ–°çš„åˆå§‹æ•°å€¼
        petData = {
            name: petData.name || "å°å® ç‰©", // ä¿ç•™å½“å‰åå­—
            type: "cat",
            level: 1,
            experience: 0,
            health: 40,
            happiness: 30,
            hunger: 50,
            energy: 60,
            lastFeedTime: Date.now(),
            lastPlayTime: Date.now(),
            lastSleepTime: Date.now(),
            lastUpdateTime: Date.now(),
            created: Date.now(),
            dataVersion: 3.0
        };

        // ä¿å­˜æ–°æ•°æ®
        savePetData();

        // æ›´æ–°UI
        updateUnifiedUIStatus();

        console.log("âœ… æ•°æ®è¿ç§»å®Œæˆï¼æ–°çš„åˆå§‹æ•°å€¼:");
        console.log(`å¥åº·: ${petData.health}/100`);
        console.log(`å¿«ä¹åº¦: ${petData.happiness}/100`);
        console.log(`é¥±é£Ÿåº¦: ${petData.hunger}/100`);
        console.log(`ç²¾åŠ›: ${petData.energy}/100`);

        alert("æ•°æ®è¿ç§»å®Œæˆï¼æ–°çš„åˆå§‹æ•°å€¼å·²åº”ç”¨ã€‚");
    };

    // æµ‹è¯•æ–°çš„æ•°å€¼å¹³è¡¡
    window.testNewBalance = function() {
        console.log("ğŸ¯ æµ‹è¯•æ–°çš„æ•°å€¼å¹³è¡¡ç³»ç»Ÿ...");

        // æ˜¾ç¤ºå½“å‰æ•°å€¼
        console.log("\nğŸ“Š å½“å‰çŠ¶æ€:");
        console.log(`å¥åº·: ${Math.round(petData.health)}/100`);
        console.log(`é¥±é£Ÿåº¦: ${Math.round(petData.hunger)}/100`);
        console.log(`å¿«ä¹åº¦: ${Math.round(petData.happiness)}/100`);
        console.log(`ç²¾åŠ›: ${Math.round(petData.energy)}/100`);
        console.log(`ç­‰çº§: ${petData.level}`);

        // æµ‹è¯•æ“ä½œæ•ˆæœ
        console.log("\nğŸ§ª æµ‹è¯•æ“ä½œæ•ˆæœ:");

        const originalValues = {
            health: petData.health,
            hunger: petData.hunger,
            happiness: petData.happiness,
            energy: petData.energy
        };

        // æµ‹è¯•å–‚é£Ÿ
        console.log("\nğŸ– æµ‹è¯•å–‚é£Ÿæ•ˆæœ:");
        console.log(`å–‚é£Ÿå‰ - é¥±é£Ÿåº¦: ${Math.round(originalValues.hunger)}, å¿«ä¹åº¦: ${Math.round(originalValues.happiness)}`);
        feedPet();
        console.log(`å–‚é£Ÿå - é¥±é£Ÿåº¦: ${Math.round(petData.hunger)} (+${Math.round(petData.hunger - originalValues.hunger)}), å¿«ä¹åº¦: ${Math.round(petData.happiness)} (+${Math.round(petData.happiness - originalValues.happiness)})`);

        // ç­‰å¾…ä¸€ä¸‹å†æµ‹è¯•ç©è€
        setTimeout(() => {
            const beforePlay = {
                happiness: petData.happiness,
                energy: petData.energy
            };

            console.log("\nğŸ® æµ‹è¯•ç©è€æ•ˆæœ:");
            console.log(`ç©è€å‰ - å¿«ä¹åº¦: ${Math.round(beforePlay.happiness)}, ç²¾åŠ›: ${Math.round(beforePlay.energy)}`);
            playWithPet();
            console.log(`ç©è€å - å¿«ä¹åº¦: ${Math.round(petData.happiness)} (+${Math.round(petData.happiness - beforePlay.happiness)}), ç²¾åŠ›: ${Math.round(petData.energy)} (${Math.round(petData.energy - beforePlay.energy)})`);

            // ç­‰å¾…ä¸€ä¸‹å†æµ‹è¯•ç¡è§‰
            setTimeout(() => {
                const beforeSleep = {
                    health: petData.health,
                    energy: petData.energy
                };

                console.log("\nğŸ˜´ æµ‹è¯•ç¡è§‰æ•ˆæœ:");
                console.log(`ç¡è§‰å‰ - å¥åº·: ${Math.round(beforeSleep.health)}, ç²¾åŠ›: ${Math.round(beforeSleep.energy)}`);
                petSleep();
                console.log(`ç¡è§‰å - å¥åº·: ${Math.round(petData.health)} (+${Math.round(petData.health - beforeSleep.health)}), ç²¾åŠ›: ${Math.round(petData.energy)} (+${Math.round(petData.energy - beforeSleep.energy)})`);

                // æ›´æ–°UI
                updateUnifiedUIStatus();

                console.log("\nğŸ“‹ æ•°å€¼å¹³è¡¡æ€»ç»“:");
                console.log("âœ… å–‚é£Ÿ: +15é¥±é£Ÿåº¦, +5å¿«ä¹åº¦, 20ç§’å†·å´");
                console.log("âœ… ç©è€: +12å¿«ä¹åº¦, -8ç²¾åŠ›, 40ç§’å†·å´");
                console.log("âœ… ç¡è§‰: +20ç²¾åŠ›, +5å¥åº·, 80ç§’å†·å´");
                console.log("âœ… æ—¶é—´è¡°å‡: æ¯12åˆ†é’Ÿæ›´æ–°ï¼Œé€Ÿåº¦å‡ç¼“60%");
                console.log("âœ… åˆå§‹æ•°å€¼: å¥åº·40, å¿«ä¹30, é¥±é£Ÿ50, ç²¾åŠ›60");

            }, 100);
        }, 100);
    };



    // æ¨¡æ‹Ÿæ—¶é—´æµé€æµ‹è¯•
    window.testTimeDecay = function() {
        console.log("â° æµ‹è¯•æ—¶é—´è¡°å‡æ•ˆæœ...");

        const before = {
            health: petData.health,
            hunger: petData.hunger,
            happiness: petData.happiness,
            energy: petData.energy
        };

        console.log("è¡°å‡å‰çŠ¶æ€:", before);

        // æ¨¡æ‹Ÿ1å°æ—¶æ—¶é—´æµé€
        updatePetStatus();

        console.log("è¡°å‡åçŠ¶æ€:", {
            health: Math.round(petData.health),
            hunger: Math.round(petData.hunger),
            happiness: Math.round(petData.happiness),
            energy: Math.round(petData.energy)
        });

        const changes = {
            health: Math.round(petData.health - before.health),
            hunger: Math.round(petData.hunger - before.hunger),
            happiness: Math.round(petData.happiness - before.happiness),
            energy: Math.round(petData.energy - before.energy)
        };

        console.log("æ•°å€¼å˜åŒ–:", changes);
        updateUnifiedUIStatus();
    };

    // éªŒè¯æ•°å€¼ä¿®å¤æ•ˆæœ
    window.verifyInitialValues = function() {
        console.log("ğŸ” éªŒè¯åˆå§‹æ•°å€¼ä¿®å¤æ•ˆæœ...");

        // æ£€æŸ¥å½“å‰æ•°å€¼
        console.log("\nğŸ“Š å½“å‰å® ç‰©æ•°å€¼:");
        console.log(`å¥åº·: ${petData.health}/100 ${petData.health === 40 ? 'âœ…' : 'âŒ åº”ä¸º40'}`);
        console.log(`å¿«ä¹åº¦: ${petData.happiness}/100 ${petData.happiness === 30 ? 'âœ…' : 'âŒ åº”ä¸º30'}`);
        console.log(`é¥±é£Ÿåº¦: ${petData.hunger}/100 ${petData.hunger === 50 ? 'âœ…' : 'âŒ åº”ä¸º50'}`);
        console.log(`ç²¾åŠ›: ${petData.energy}/100 ${petData.energy === 60 ? 'âœ…' : 'âŒ åº”ä¸º60'}`);
        console.log(`æ•°æ®ç‰ˆæœ¬: ${petData.dataVersion} ${petData.dataVersion === 2.0 ? 'âœ…' : 'âŒ åº”ä¸º2.0'}`);

        // æ£€æŸ¥UIæ˜¾ç¤º
        console.log("\nğŸ–¥ï¸ UIæ˜¾ç¤ºæ£€æŸ¥:");
        const healthDisplay = $('.status-item').find('span').filter(function() {
            return $(this).text().includes('å¥åº·');
        }).next().text();
    };

    // å…¨é¢æ£€æŸ¥æ•°å€¼ç³»ç»Ÿ
    window.checkValueSystem = function() {
        console.log('=== ğŸ” æ•°å€¼ç³»ç»Ÿå…¨é¢æ£€æŸ¥ ===');

        // 1. åŸºæœ¬æ•°å€¼æ£€æŸ¥
        console.log('\nğŸ“Š 1. åŸºæœ¬æ•°å€¼çŠ¶æ€:');
        console.log(`å¥åº·: ${petData.health} (${typeof petData.health})`);
        console.log(`å¿«ä¹: ${petData.happiness} (${typeof petData.happiness})`);
        console.log(`é¥±é£Ÿ: ${petData.hunger} (${typeof petData.hunger})`);
        console.log(`ç²¾åŠ›: ${petData.energy} (${typeof petData.energy})`);
        console.log(`ç­‰çº§: ${petData.level} (${typeof petData.level})`);
        console.log(`ç»éªŒ: ${petData.experience} (${typeof petData.experience})`);

        // 2. æ•°å€¼èŒƒå›´éªŒè¯
        console.log('\nğŸ¯ 2. æ•°å€¼èŒƒå›´éªŒè¯:');
        const checkRange = (name, value, min = 0, max = 100) => {
            if (isNaN(value)) return `âŒ ${name} ä¸æ˜¯æ•°å­—: ${value}`;
            if (value < min) return `âŒ ${name} å°äº${min}: ${value}`;
            if (value > max) return `âŒ ${name} å¤§äº${max}: ${value}`;
            return `âœ… ${name} æ­£å¸¸: ${value}`;
        };

        console.log(checkRange('å¥åº·', petData.health));
        console.log(checkRange('å¿«ä¹', petData.happiness));
        console.log(checkRange('é¥±é£Ÿ', petData.hunger));
        console.log(checkRange('ç²¾åŠ›', petData.energy));
        console.log(checkRange('ç­‰çº§', petData.level, 1, 999));
        console.log(checkRange('ç»éªŒ', petData.experience, 0, 99999));

        // 3. æ—¶é—´ç³»ç»Ÿæ£€æŸ¥
        console.log('\nâ° 3. æ—¶é—´ç³»ç»Ÿæ£€æŸ¥:');
        const now = Date.now();
        const checkTime = (name, timestamp) => {
            if (!timestamp) return `âŒ ${name} æ—¶é—´æˆ³ç¼ºå¤±`;
            if (timestamp > now) return `âŒ ${name} æ—¶é—´æˆ³å¼‚å¸¸(æœªæ¥æ—¶é—´): ${new Date(timestamp)}`;
            const diff = (now - timestamp) / (1000 * 60 * 60);
            return `âœ… ${name}: ${new Date(timestamp).toLocaleString()} (${Math.round(diff * 100) / 100}å°æ—¶å‰)`;
        };

        console.log(checkTime('ä¸Šæ¬¡æ›´æ–°', petData.lastUpdateTime));
        console.log(checkTime('ä¸Šæ¬¡å–‚é£Ÿ', petData.lastFeedTime));
        console.log(checkTime('ä¸Šæ¬¡ç©è€', petData.lastPlayTime));
        console.log(checkTime('ä¸Šæ¬¡ç¡è§‰', petData.lastSleepTime));
        console.log(checkTime('åˆ›å»ºæ—¶é—´', petData.created));

        // 4. æ•°å€¼é€»è¾‘æ£€æŸ¥
        console.log('\nğŸ§® 4. æ•°å€¼é€»è¾‘æ£€æŸ¥:');
        const expNeeded = petData.level * 100;
        console.log(`å½“å‰ç­‰çº§éœ€è¦ç»éªŒ: ${expNeeded}`);
        console.log(`å½“å‰ç»éªŒè¿›åº¦: ${petData.experience}/${expNeeded} (${Math.round(petData.experience / expNeeded * 100)}%)`);

        // æ£€æŸ¥å‡çº§é€»è¾‘
        if (petData.experience >= expNeeded) {
            console.log('âš ï¸ ç»éªŒå€¼å·²æ»¡è¶³å‡çº§æ¡ä»¶ï¼Œä½†æœªå‡çº§');
        } else {
            console.log('âœ… ç»éªŒå€¼æ­£å¸¸');
        }

        // 5. UIæ˜¾ç¤ºæ£€æŸ¥
        console.log('\nğŸ–¥ï¸ 5. UIæ˜¾ç¤ºæ£€æŸ¥:');
        const statusBars = $('.stat-bar');
        if (statusBars.length > 0) {
            statusBars.each(function() {
                const label = $(this).find('label').text();
                const value = $(this).find('span').text();
                const progressFill = $(this).find('.progress-fill');
                const width = progressFill.css('width');
                const expectedWidth = progressFill.attr('style')?.match(/width:\s*([^;%]+)%/)?.[1];
                console.log(`${label}: æ˜¾ç¤º=${value}, è¿›åº¦æ¡=${width}, æœŸæœ›=${expectedWidth}%`);
            });
        } else {
            console.log('âŒ æœªæ‰¾åˆ°çŠ¶æ€æ¡å…ƒç´ ');
        }

        // 6. å­˜å‚¨æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
        console.log('\nğŸ’¾ 6. å­˜å‚¨æ•°æ®ä¸€è‡´æ€§:');
        const savedData = localStorage.getItem('virtual-pet-data');
        if (savedData) {
            try {
                const parsed = JSON.parse(savedData);
                const differences = [];

                ['health', 'happiness', 'hunger', 'energy', 'level', 'experience'].forEach(key => {
                    if (Math.abs(petData[key] - parsed[key]) > 0.01) {
                        differences.push(`${key}: å†…å­˜=${petData[key]}, å­˜å‚¨=${parsed[key]}`);
                    }
                });

                if (differences.length > 0) {
                    console.log('âŒ å†…å­˜ä¸å­˜å‚¨æ•°æ®ä¸ä¸€è‡´:');
                    differences.forEach(diff => console.log(`  ${diff}`));
                } else {
                    console.log('âœ… å†…å­˜ä¸å­˜å‚¨æ•°æ®ä¸€è‡´');
                }

                console.log(`æ•°æ®ç‰ˆæœ¬: ${parsed.dataVersion}`);
            } catch (e) {
                console.log('âŒ å­˜å‚¨æ•°æ®è§£æå¤±è´¥:', e);
            }
        } else {
            console.log('âŒ æœªæ‰¾åˆ°å­˜å‚¨æ•°æ®');
        }

        // 7. å‡½æ•°å¯ç”¨æ€§æ£€æŸ¥
        console.log('\nğŸ”§ 7. æ ¸å¿ƒå‡½æ•°æ£€æŸ¥:');
        const functions = [
            'validateAndFixValues', 'updatePetStatus', 'feedPet',
            'playWithPet', 'petSleep', 'gainExperience', 'renderPetStatus'
        ];

        functions.forEach(funcName => {
            if (typeof window[funcName] === 'function' || typeof eval(funcName) === 'function') {
                console.log(`âœ… ${funcName} å‡½æ•°å¯ç”¨`);
            } else {
                console.log(`âŒ ${funcName} å‡½æ•°ä¸å¯ç”¨`);
            }
        });

        // 8. æ€»ç»“
        console.log('\nğŸ“‹ 8. ç³»ç»ŸçŠ¶æ€æ€»ç»“:');
        const issues = [];

        // æ£€æŸ¥å…³é”®é—®é¢˜
        if (isNaN(petData.health) || petData.health < 0 || petData.health > 100) issues.push('å¥åº·å€¼å¼‚å¸¸');
        if (isNaN(petData.happiness) || petData.happiness < 0 || petData.happiness > 100) issues.push('å¿«ä¹å€¼å¼‚å¸¸');
        if (isNaN(petData.hunger) || petData.hunger < 0 || petData.hunger > 100) issues.push('é¥±é£Ÿå€¼å¼‚å¸¸');
        if (isNaN(petData.energy) || petData.energy < 0 || petData.energy > 100) issues.push('ç²¾åŠ›å€¼å¼‚å¸¸');
        if (!petData.lastUpdateTime || petData.lastUpdateTime > now) issues.push('æ—¶é—´æˆ³å¼‚å¸¸');
        if (statusBars.length === 0) issues.push('UIæ˜¾ç¤ºå¼‚å¸¸');

        if (issues.length === 0) {
            console.log('ğŸ‰ æ•°å€¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼');
        } else {
            console.log('âš ï¸ å‘ç°ä»¥ä¸‹é—®é¢˜:');
            issues.forEach(issue => console.log(`  - ${issue}`));
        }

        return {
            petData: petData,
            issues: issues,
            timestamp: new Date().toISOString()
        };
    };

    // å¿«é€Ÿä¿®å¤æ•°å€¼ç³»ç»Ÿé—®é¢˜
    window.fixValueSystem = function() {
        console.log('ğŸ”§ å¼€å§‹ä¿®å¤æ•°å€¼ç³»ç»Ÿé—®é¢˜...');

        // 1. éªŒè¯å¹¶ä¿®å¤æ•°å€¼
        console.log('1. éªŒè¯å¹¶ä¿®å¤æ•°å€¼èŒƒå›´...');
        validateAndFixValues();

        // 2. å¼ºåˆ¶æ›´æ–°UI
        console.log('2. å¼ºåˆ¶æ›´æ–°UIæ˜¾ç¤º...');
        if (typeof renderPetStatus === 'function') {
            renderPetStatus();
        }

        // 3. ä¿å­˜ä¿®å¤åçš„æ•°æ®
        console.log('3. ä¿å­˜ä¿®å¤åçš„æ•°æ®...');
        savePetData();

        // 4. éªŒè¯ä¿®å¤ç»“æœ
        console.log('4. éªŒè¯ä¿®å¤ç»“æœ...');
        const result = checkValueSystem();

        if (result.issues.length === 0) {
            console.log('âœ… æ•°å€¼ç³»ç»Ÿä¿®å¤å®Œæˆï¼');
            toastr.success('æ•°å€¼ç³»ç»Ÿå·²ä¿®å¤ï¼');
        } else {
            console.log('âš ï¸ ä»æœ‰é—®é¢˜éœ€è¦æ‰‹åŠ¨å¤„ç†:', result.issues);
            toastr.warning('éƒ¨åˆ†é—®é¢˜å·²ä¿®å¤ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
        }

        return result;
    };

    // å¼ºåˆ¶é‡ç½®è¿‡é«˜æ•°å€¼åˆ°å¹³è¡¡èŒƒå›´
    window.resetHighValues = function() {
        console.log('ğŸ”§ æ£€æŸ¥å¹¶é‡ç½®è¿‡é«˜æ•°å€¼...');

        const before = {
            health: petData.health,
            happiness: petData.happiness,
            hunger: petData.hunger,
            energy: petData.energy
        };

        console.log('é‡ç½®å‰æ•°å€¼:', before);

        // æ£€æŸ¥æ˜¯å¦æœ‰è¿‡é«˜æ•°å€¼
        const hasHighValues = petData.happiness > 80 || petData.hunger > 80 ||
                             petData.health > 80 || petData.energy > 80;

        if (!hasHighValues) {
            console.log('âœ… æ•°å€¼éƒ½åœ¨åˆç†èŒƒå›´å†…ï¼Œæ— éœ€é‡ç½®');
            toastr.info('æ•°å€¼éƒ½åœ¨åˆç†èŒƒå›´å†…ï¼Œæ— éœ€é‡ç½®');
            return false;
        }

        // é‡ç½®è¿‡é«˜æ•°å€¼åˆ°å¹³è¡¡èŒƒå›´
        petData.health = Math.min(petData.health, 65);
        petData.happiness = Math.min(petData.happiness, 65);
        petData.hunger = Math.min(petData.hunger, 65);
        petData.energy = Math.min(petData.energy, 65);

        // éªŒè¯å¹¶ä¿å­˜
        validateAndFixValues();
        savePetData();
        renderPetStatus();

        const after = {
            health: petData.health,
            happiness: petData.happiness,
            hunger: petData.hunger,
            energy: petData.energy
        };

        console.log('é‡ç½®åæ•°å€¼:', after);
        console.log('âœ… è¿‡é«˜æ•°å€¼å·²é‡ç½®åˆ°å¹³è¡¡èŒƒå›´');

        toastr.success('è¿‡é«˜æ•°å€¼å·²é‡ç½®ï¼ç°åœ¨æ•°å€¼å˜åŒ–ä¼šæ›´æœ‰è¶£ã€‚');

        return {
            before: before,
            after: after,
            reset: true,
            timestamp: new Date().toISOString()
        };
    };

    // æ‰‹åŠ¨åŒæ­¥å® ç‰©æ•°æ®
    window.syncPetData = function() {
        console.log('ğŸ”„ æ‰‹åŠ¨åŒæ­¥å® ç‰©æ•°æ®...');

        // å¼ºåˆ¶ä¿å­˜å½“å‰æ•°æ®åˆ°åŒæ­¥å­˜å‚¨
        const dataWithTimestamp = {
            ...petData,
            lastSyncTime: Date.now()
        };

        saveToSyncStorage(dataWithTimestamp);
        localStorage.setItem(STORAGE_KEY_PET_DATA, JSON.stringify(dataWithTimestamp));

        console.log('âœ… å® ç‰©æ•°æ®åŒæ­¥å®Œæˆï¼');
        toastr.success('å® ç‰©æ•°æ®å·²åŒæ­¥åˆ°æ‰€æœ‰è®¾å¤‡ï¼');

        return {
            synced: true,
            timestamp: new Date().toISOString(),
            data: dataWithTimestamp
        };
    };

    // åŒæ­¥æ‰€æœ‰æ•°æ®ï¼ˆå® ç‰©æ•°æ®ã€AIè®¾ç½®ã€å¤´åƒï¼‰
    window.syncAllData = function() {
        console.log('ğŸ”„ åŒæ­¥æ‰€æœ‰æ•°æ®åˆ°äº‘ç«¯...');

        let syncResults = {
            pet: false,
            ai: false,
            avatar: false,
            timestamp: new Date().toISOString()
        };

        try {
            // 1. åŒæ­¥å® ç‰©æ•°æ®
            const dataWithTimestamp = {
                ...petData,
                lastSyncTime: Date.now()
            };
            saveToSyncStorage(dataWithTimestamp);
            localStorage.setItem(STORAGE_KEY_PET_DATA, JSON.stringify(dataWithTimestamp));
            syncResults.pet = true;
            console.log('âœ… å® ç‰©æ•°æ®åŒæ­¥å®Œæˆ');

            // 2. åŒæ­¥AIè®¾ç½®
            const aiSettings = localStorage.getItem(`${extensionName}-ai-settings`);
            if (aiSettings) {
                const settings = JSON.parse(aiSettings);
                settings.lastSyncTime = Date.now();
                localStorage.setItem(`${extensionName}-ai-settings`, JSON.stringify(settings));
                saveAISettingsToSync(settings);
                syncResults.ai = true;
                console.log('âœ… AIè®¾ç½®åŒæ­¥å®Œæˆ');
            } else {
                console.log('âš ï¸ æ— AIè®¾ç½®éœ€è¦åŒæ­¥');
            }

            // 3. åŒæ­¥å¤´åƒ
            const avatar = localStorage.getItem(STORAGE_KEY_CUSTOM_AVATAR);
            if (avatar) {
                saveAvatarToSync(avatar);
                syncResults.avatar = true;
                console.log('âœ… å¤´åƒåŒæ­¥å®Œæˆ');
            } else {
                console.log('âš ï¸ æ— è‡ªå®šä¹‰å¤´åƒéœ€è¦åŒæ­¥');
            }

            console.log('ğŸ‰ æ‰€æœ‰æ•°æ®åŒæ­¥å®Œæˆï¼');
            toastr.success('æ‰€æœ‰æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ï¼ç°åœ¨å¯ä»¥åœ¨å…¶ä»–è®¾å¤‡ä¸Šè®¿é—®äº†ã€‚', 'ğŸ‰ åŒæ­¥æˆåŠŸ', { timeOut: 5000 });

        } catch (error) {
            console.error('âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
            toastr.error('åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message, 'âŒ åŒæ­¥å¤±è´¥', { timeOut: 5000 });
        }

        return syncResults;
    };

    // ä¸“é—¨æµ‹è¯•å¤´åƒåŒæ­¥
    window.testAvatarSync = function() {
        console.log('ğŸ¨ æµ‹è¯•å¤´åƒåŒæ­¥åŠŸèƒ½...');

        // æ£€æŸ¥æœ¬åœ°å¤´åƒ
        const localAvatar = localStorage.getItem(STORAGE_KEY_CUSTOM_AVATAR);
        console.log('æœ¬åœ°å¤´åƒ:', localAvatar ? `å­˜åœ¨ (${Math.round(localAvatar.length/1024)}KB)` : 'ä¸å­˜åœ¨');

        // æ£€æŸ¥åŒæ­¥å¤´åƒ
        const syncAvatar = loadAvatarFromSync();
        console.log('åŒæ­¥å¤´åƒ:', syncAvatar ? `å­˜åœ¨ (${Math.round(syncAvatar.length/1024)}KB)` : 'ä¸å­˜åœ¨');

        // æ£€æŸ¥å½“å‰ä½¿ç”¨çš„å¤´åƒ
        console.log('å½“å‰å¤´åƒ:', customAvatarData ? `å·²åŠ è½½ (${Math.round(customAvatarData.length/1024)}KB)` : 'æœªåŠ è½½');

        // å¦‚æœæœ‰åŒæ­¥å¤´åƒä½†æœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•åŒæ­¥
        if (syncAvatar && !localAvatar) {
            console.log('ğŸ”„ å‘ç°åŒæ­¥å¤´åƒï¼Œæ­£åœ¨åŒæ­¥åˆ°æœ¬åœ°...');
            localStorage.setItem(STORAGE_KEY_CUSTOM_AVATAR, syncAvatar);
            customAvatarData = syncAvatar;
            updateAvatarDisplay();
            updateFloatingButtonAvatar();
            console.log('âœ… å¤´åƒåŒæ­¥å®Œæˆ');
            toastr.success('å¤´åƒå·²ä»äº‘ç«¯åŒæ­¥ï¼', 'ğŸ¨ å¤´åƒåŒæ­¥', { timeOut: 3000 });
        } else if (localAvatar && !syncAvatar) {
            console.log('ğŸ”„ å‘ç°æœ¬åœ°å¤´åƒï¼Œæ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...');
            saveAvatarToSync(localAvatar);
            console.log('âœ… å¤´åƒå·²åŒæ­¥åˆ°äº‘ç«¯');
            toastr.success('å¤´åƒå·²åŒæ­¥åˆ°äº‘ç«¯ï¼', 'ğŸ¨ å¤´åƒåŒæ­¥', { timeOut: 3000 });
        } else if (syncAvatar && localAvatar) {
            console.log('âœ… å¤´åƒå·²åœ¨æœ¬åœ°å’Œäº‘ç«¯åŒæ­¥');
            toastr.info('å¤´åƒå·²åŒæ­¥', 'ğŸ¨ å¤´åƒçŠ¶æ€', { timeOut: 2000 });
        } else {
            console.log('â„¹ï¸ æœªå‘ç°è‡ªå®šä¹‰å¤´åƒ');
            toastr.info('æœªå‘ç°è‡ªå®šä¹‰å¤´åƒ', 'ğŸ¨ å¤´åƒçŠ¶æ€', { timeOut: 2000 });
        }

        return {
            hasLocal: !!localAvatar,
            hasSync: !!syncAvatar,
            hasCurrent: !!customAvatarData,
            timestamp: new Date().toISOString()
        };
    };

    // å¯¼å‡ºå® ç‰©æ•°æ®
    window.exportPetData = function() {
        console.log('ğŸ“¤ å¯¼å‡ºå® ç‰©æ•°æ®...');

        const exportData = {
            ...petData,
            exportTime: Date.now(),
            exportVersion: '3.0'
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });

        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `virtual-pet-data-${new Date().toISOString().split('T')[0]}.json`;

        // è§¦å‘ä¸‹è½½
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        console.log('âœ… å® ç‰©æ•°æ®å·²å¯¼å‡ºï¼');
        toastr.success('å® ç‰©æ•°æ®å·²å¯¼å‡ºåˆ°æ–‡ä»¶ï¼');

        return exportData;
    };

    // å¯¼å…¥å® ç‰©æ•°æ®
    window.importPetData = function() {
        console.log('ğŸ“¥ å¯¼å…¥å® ç‰©æ•°æ®...');

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!importedData.name || typeof importedData.health !== 'number') {
                        throw new Error('æ— æ•ˆçš„å® ç‰©æ•°æ®æ ¼å¼');
                    }

                    // ç¡®è®¤å¯¼å…¥
                    if (confirm(`ç¡®å®šè¦å¯¼å…¥å® ç‰©æ•°æ®å—ï¼Ÿ\n\nå® ç‰©åç§°: ${importedData.name}\nç­‰çº§: ${importedData.level}\nè¿™å°†è¦†ç›–å½“å‰æ•°æ®ï¼`)) {
                        // ä¿ç•™å½“å‰çš„æ—¶é—´æˆ³ï¼Œæ›´æ–°æ•°æ®ç‰ˆæœ¬
                        const mergedData = {
                            ...importedData,
                            lastSyncTime: Date.now(),
                            dataVersion: 3.0
                        };

                        petData = mergedData;

                        // åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿ
                        applyTamagotchiSystem();

                        // ä¿å­˜æ•°æ®
                        savePetData();

                        // æ›´æ–°UI
                        renderPetStatus();
                        if (typeof renderSettings === 'function') {
                            renderSettings();
                        }

                        console.log('âœ… å® ç‰©æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                        toastr.success('å® ç‰©æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    toastr.error('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };

            reader.readAsText(file);
        };

        input.click();
    };

    // æ£€æŸ¥åŒæ­¥çŠ¶æ€ - åŒ…å«å® ç‰©æ•°æ®ã€AIè®¾ç½®å’Œå¤´åƒ
    window.checkSyncStatus = function() {
        console.log('ğŸ” æ£€æŸ¥å®Œæ•´åŒæ­¥çŠ¶æ€...');

        // æ£€æŸ¥å® ç‰©æ•°æ®
        const localData = localStorage.getItem(STORAGE_KEY_PET_DATA);
        const syncData = loadFromSyncStorage();

        console.log('\nğŸ“± å® ç‰©æ•°æ® - æœ¬åœ°:');
        if (localData) {
            try {
                const local = JSON.parse(localData);
                console.log(`- æœ€ååŒæ­¥æ—¶é—´: ${local.lastSyncTime ? new Date(local.lastSyncTime).toLocaleString() : 'æœªè®¾ç½®'}`);
                console.log(`- å® ç‰©åç§°: ${local.name}`);
                console.log(`- ç­‰çº§: ${local.level}`);
                console.log(`- æ•°æ®ç‰ˆæœ¬: ${local.dataVersion}`);
            } catch (e) {
                console.log('- æœ¬åœ°æ•°æ®è§£æå¤±è´¥');
            }
        } else {
            console.log('- æ— æœ¬åœ°æ•°æ®');
        }

        console.log('\nâ˜ï¸ å® ç‰©æ•°æ® - åŒæ­¥:');
        if (syncData) {
            try {
                const sync = typeof syncData === 'object' ? syncData : JSON.parse(syncData);
                console.log(`- æœ€ååŒæ­¥æ—¶é—´: ${sync.lastSyncTime ? new Date(sync.lastSyncTime).toLocaleString() : 'æœªè®¾ç½®'}`);
                console.log(`- å® ç‰©åç§°: ${sync.name}`);
                console.log(`- ç­‰çº§: ${sync.level}`);
                console.log(`- æ•°æ®ç‰ˆæœ¬: ${sync.dataVersion}`);
            } catch (e) {
                console.log('- åŒæ­¥æ•°æ®è§£æå¤±è´¥');
            }
        } else {
            console.log('- æ— åŒæ­¥æ•°æ®');
        }

        // æ£€æŸ¥AIè®¾ç½®
        const localAISettings = localStorage.getItem(`${extensionName}-ai-settings`);
        const syncAISettings = loadAISettingsFromSync();

        console.log('\nğŸ¤– AIè®¾ç½® - æœ¬åœ°:');
        if (localAISettings) {
            try {
                const local = JSON.parse(localAISettings);
                console.log(`- APIç±»å‹: ${local.apiType || 'æœªè®¾ç½®'}`);
                console.log(`- API URL: ${local.apiUrl ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
                console.log(`- APIå¯†é’¥: ${local.apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
                console.log(`- æ¨¡å‹: ${local.apiModel || 'æœªè®¾ç½®'}`);
                console.log(`- æœ€ååŒæ­¥æ—¶é—´: ${local.lastSyncTime ? new Date(local.lastSyncTime).toLocaleString() : 'æœªè®¾ç½®'}`);
            } catch (e) {
                console.log('- AIè®¾ç½®è§£æå¤±è´¥');
            }
        } else {
            console.log('- æ— æœ¬åœ°AIè®¾ç½®');
        }

        console.log('\nâ˜ï¸ AIè®¾ç½® - åŒæ­¥:');
        if (syncAISettings) {
            try {
                const sync = typeof syncAISettings === 'object' ? syncAISettings : JSON.parse(syncAISettings);
                console.log(`- APIç±»å‹: ${sync.apiType || 'æœªè®¾ç½®'}`);
                console.log(`- API URL: ${sync.apiUrl ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
                console.log(`- APIå¯†é’¥: ${sync.apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
                console.log(`- æ¨¡å‹: ${sync.apiModel || 'æœªè®¾ç½®'}`);
                console.log(`- æœ€ååŒæ­¥æ—¶é—´: ${sync.lastSyncTime ? new Date(sync.lastSyncTime).toLocaleString() : 'æœªè®¾ç½®'}`);
            } catch (e) {
                console.log('- åŒæ­¥AIè®¾ç½®è§£æå¤±è´¥');
            }
        } else {
            console.log('- æ— åŒæ­¥AIè®¾ç½®');
        }

        // æ£€æŸ¥å¤´åƒ
        const localAvatar = localStorage.getItem(STORAGE_KEY_CUSTOM_AVATAR);
        const syncAvatar = loadAvatarFromSync();

        console.log('\nğŸ¨ å¤´åƒ - æœ¬åœ°:');
        console.log(`- è‡ªå®šä¹‰å¤´åƒ: ${localAvatar ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
        if (localAvatar) {
            console.log(`- å¤´åƒå¤§å°: ${Math.round(localAvatar.length / 1024)}KB`);
        }

        console.log('\nâ˜ï¸ å¤´åƒ - åŒæ­¥:');
        console.log(`- è‡ªå®šä¹‰å¤´åƒ: ${syncAvatar ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
        if (syncAvatar) {
            console.log(`- å¤´åƒå¤§å°: ${Math.round(syncAvatar.length / 1024)}KB`);
        }

        console.log('\nğŸ”„ åŒæ­¥å»ºè®®:');
        if (!localData && !syncData) {
            console.log('- è¿™æ˜¯æ–°è®¾å¤‡ï¼Œæ•°æ®å°†è‡ªåŠ¨åŒæ­¥');
        } else if (localData && !syncData) {
            console.log('- å»ºè®®è¿è¡Œ syncAllData() å°†æ‰€æœ‰æ•°æ®åŒæ­¥åˆ°äº‘ç«¯');
        } else if (!localData && syncData) {
            console.log('- å°†è‡ªåŠ¨ä»äº‘ç«¯æ¢å¤æ•°æ®');
        } else {
            try {
                const local = JSON.parse(localData);
                const sync = typeof syncData === 'object' ? syncData : JSON.parse(syncData);
                const localTime = local.lastSyncTime || 0;
                const syncTime = sync.lastSyncTime || 0;

                if (localTime > syncTime) {
                    console.log('- æœ¬åœ°æ•°æ®è¾ƒæ–°ï¼Œå»ºè®®è¿è¡Œ syncAllData() åŒæ­¥åˆ°äº‘ç«¯');
                } else if (syncTime > localTime) {
                    console.log('- äº‘ç«¯æ•°æ®è¾ƒæ–°ï¼Œå°†è‡ªåŠ¨ä½¿ç”¨äº‘ç«¯æ•°æ®');
                } else {
                    console.log('- å® ç‰©æ•°æ®å·²åŒæ­¥');
                }
            } catch (e) {
                console.log('- æ•°æ®æ¯”è¾ƒå¤±è´¥ï¼Œå»ºè®®æ‰‹åŠ¨åŒæ­¥');
            }
        }

        // AIè®¾ç½®å’Œå¤´åƒåŒæ­¥å»ºè®®
        if (!syncAISettings && localAISettings) {
            console.log('- AIè®¾ç½®éœ€è¦åŒæ­¥åˆ°äº‘ç«¯');
        }
        if (!syncAvatar && localAvatar) {
            console.log('- å¤´åƒéœ€è¦åŒæ­¥åˆ°äº‘ç«¯');
        }

        return {
            hasLocal: !!localData,
            hasSync: !!syncData,
            hasLocalAI: !!localAISettings,
            hasSyncAI: !!syncAISettings,
            hasLocalAvatar: !!localAvatar,
            hasSyncAvatar: !!syncAvatar,
            timestamp: new Date().toISOString()
        };
    };

    // æµ‹è¯•æ‹“éº»æ­Œå­ç³»ç»Ÿ
    window.testTamagotchiSystem = function() {
        console.log('ğŸ¥š æµ‹è¯•æ‹“éº»æ­Œå­ç³»ç»Ÿ...');

        console.log('\nğŸ“Š å½“å‰æ‹“éº»æ­Œå­çŠ¶æ€:');
        console.log(`ç”Ÿå‘½é˜¶æ®µ: ${petData.lifeStage} (${LIFE_STAGES[petData.lifeStage]?.name})`);
        console.log(`å¹´é¾„: ${Math.round(petData.age)}å°æ—¶`);
        console.log(`æ˜¯å¦å­˜æ´»: ${petData.isAlive ? 'âœ… æ˜¯' : 'âŒ å¦'}`);
        console.log(`ç–¾ç—…ç¨‹åº¦: ${petData.sickness}/100`);
        console.log(`çºªå¾‹å€¼: ${petData.discipline}/100`);
        console.log(`ä½“é‡: ${petData.weight}kg`);
        console.log(`å¿½è§†æ¬¡æ•°: ${petData.careNeglectCount}`);
        console.log(`ç”Ÿç—…æŒç»­: ${Math.round(petData.sicknessDuration)}å°æ—¶`);

        if (petData.deathReason) {
            console.log(`æ­»äº¡åŸå› : ${petData.deathReason}`);
        }

        console.log('\nâ° æ—¶é—´æ£€æŸ¥:');
        const now = Date.now();
        const timeSinceLastCare = now - petData.lastCareTime;
        const hoursSinceLastCare = timeSinceLastCare / (1000 * 60 * 60);
        console.log(`è·ç¦»ä¸Šæ¬¡ç…§é¡¾: ${Math.round(hoursSinceLastCare * 100) / 100}å°æ—¶`);

        console.log('\nğŸ¯ æ‹“éº»æ­Œå­å¼ç‰¹æ€§:');
        console.log('- âœ… çœŸå®æ—¶é—´æµé€ï¼ˆä¸é™åˆ¶24å°æ—¶ï¼‰');
        console.log('- âœ… ç”Ÿå‘½é˜¶æ®µç³»ç»Ÿ');
        console.log('- âœ… æ­»äº¡æœºåˆ¶');
        console.log('- âœ… ç–¾ç—…ç³»ç»Ÿ');
        console.log('- âœ… å¿½è§†ç…§é¡¾æƒ©ç½š');
        console.log('- âœ… ä½“é‡ç®¡ç†');

        console.log('\nğŸ”§ å¯ç”¨å‘½ä»¤:');
        console.log('- feedPet() - å–‚é£Ÿ');
        console.log('- playWithPet() - ç©è€');
        console.log('- petSleep() - ä¼‘æ¯');
        console.log('- healPet() - æ²»ç–—');
        console.log('- resetPet() - é‡æ–°å¼€å§‹');

        return {
            lifeStage: petData.lifeStage,
            age: petData.age,
            isAlive: petData.isAlive,
            sickness: petData.sickness,
            discipline: petData.discipline,
            weight: petData.weight,
            careNeglectCount: petData.careNeglectCount,
            hoursSinceLastCare: hoursSinceLastCare,
            timestamp: new Date().toISOString()
        };
    };

    // å•†åº—ç³»ç»ŸåŠŸèƒ½
    function showShopModal() {
        // æ£€æµ‹ç§»åŠ¨ç«¯çŠ¶æ€
        const isMobile = window.innerWidth <= 768;
        const containerMaxWidth = isMobile ? '300px' : '380px'; // ä¸ä¸»UIä¿æŒä¸€è‡´

        // åˆ›å»ºå•†åº—å¼¹çª—
        const shopModal = $(`
            <div id="shop-modal" style="
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.8) !important;
                z-index: 1000000 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 20px !important;
                box-sizing: border-box !important;
            ">
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                    border-radius: 15px !important;
                    padding: 20px !important;
                    max-width: ${containerMaxWidth} !important;
                    width: 100% !important;
                    max-height: 70vh !important;
                    overflow-y: auto !important;
                    color: white !important;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important;
                ">
                    <div style="
                        display: flex !important;
                        justify-content: space-between !important;
                        align-items: center !important;
                        margin-bottom: 20px !important;
                        border-bottom: 1px solid rgba(255,255,255,0.2) !important;
                        padding-bottom: 15px !important;
                    ">
                        <h2 style="margin: 0 !important; color: #ffd700 !important;">ğŸ›’ å® ç‰©å•†åº—</h2>
                        <div style="color: #ffd700 !important; font-weight: bold !important;">
                            ğŸ’° ${petData.coins || 100} é‡‘å¸
                        </div>
                    </div>

                    <div id="shop-categories" style="
                        display: flex !important;
                        gap: 10px !important;
                        margin-bottom: 15px !important;
                        flex-wrap: wrap !important;
                    ">
                        <button class="shop-category-btn" data-category="all" style="
                            padding: 8px 15px !important;
                            background: #ffd700 !important;
                            color: #333 !important;
                            border: none !important;
                            border-radius: 20px !important;
                            cursor: pointer !important;
                            font-size: 0.9em !important;
                            font-weight: bold !important;
                        ">å…¨éƒ¨</button>
                        <button class="shop-category-btn" data-category="food" style="
                            padding: 8px 15px !important;
                            background: rgba(255,255,255,0.2) !important;
                            color: white !important;
                            border: none !important;
                            border-radius: 20px !important;
                            cursor: pointer !important;
                            font-size: 0.9em !important;
                        ">ğŸ é£Ÿç‰©</button>
                        <button class="shop-category-btn" data-category="medicine" style="
                            padding: 8px 15px !important;
                            background: rgba(255,255,255,0.2) !important;
                            color: white !important;
                            border: none !important;
                            border-radius: 20px !important;
                            cursor: pointer !important;
                            font-size: 0.9em !important;
                        ">ğŸ’Š è¯å“</button>
                        <button class="shop-category-btn" data-category="toy" style="
                            padding: 8px 15px !important;
                            background: rgba(255,255,255,0.2) !important;
                            color: white !important;
                            border: none !important;
                            border-radius: 20px !important;
                            cursor: pointer !important;
                            font-size: 0.9em !important;
                        ">ğŸ® ç©å…·</button>
                        <button class="shop-category-btn" data-category="special" style="
                            padding: 8px 15px !important;
                            background: rgba(255,255,255,0.2) !important;
                            color: white !important;
                            border: none !important;
                            border-radius: 20px !important;
                            cursor: pointer !important;
                            font-size: 0.9em !important;
                        ">âœ¨ ç‰¹æ®Š</button>
                    </div>

                    <div id="shop-items" style="
                        display: grid !important;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
                        gap: 15px !important;
                        margin-bottom: 20px !important;
                    ">
                        ${generateShopItems('all')}
                    </div>

                    <div style="text-align: center !important;">
                        <button onclick="closeShopModal()" style="
                            padding: 10px 30px !important;
                            background: #f04747 !important;
                            color: white !important;
                            border: none !important;
                            border-radius: 25px !important;
                            cursor: pointer !important;
                            font-size: 1em !important;
                        ">å…³é—­å•†åº—</button>
                    </div>
                </div>
            </div>
        `);

        $('body').append(shopModal);

        // ç»‘å®šåˆ†ç±»æŒ‰é’®äº‹ä»¶
        $('.shop-category-btn').on('click', function() {
            const category = $(this).data('category');
            $('.shop-category-btn').css({
                'background': 'rgba(255,255,255,0.2)',
                'color': 'white'
            });
            $(this).css({
                'background': '#ffd700',
                'color': '#333'
            });
            $('#shop-items').html(generateShopItems(category));
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        shopModal.on('click', function(e) {
            if (e.target === this) {
                closeShopModal();
            }
        });
    }

    function generateShopItems(category) {
        let itemsHtml = '';

        Object.entries(SHOP_ITEMS).forEach(([itemId, item]) => {
            if (category === 'all' || item.category === category) {
                const canAfford = (petData.coins || 100) >= item.price;
                const ownedCount = petData.inventory[itemId] || 0;

                itemsHtml += `
                    <div class="shop-item" style="
                        background: rgba(255,255,255,0.1) !important;
                        border-radius: 10px !important;
                        padding: 15px !important;
                        text-align: center !important;
                        border: 2px solid ${canAfford ? 'rgba(255,215,0,0.5)' : 'rgba(255,255,255,0.2)'} !important;
                    ">
                        <div style="font-size: 2em !important; margin-bottom: 8px !important;">
                            ${item.emoji}
                        </div>
                        <div style="font-weight: bold !important; margin-bottom: 5px !important;">
                            ${item.name}
                        </div>
                        <div style="font-size: 0.8em !important; color: rgba(255,255,255,0.8) !important; margin-bottom: 8px !important; min-height: 32px !important;">
                            ${item.description}
                        </div>
                        <div style="color: #ffd700 !important; font-weight: bold !important; margin-bottom: 8px !important;">
                            ğŸ’° ${item.price} é‡‘å¸
                        </div>
                        ${ownedCount > 0 ? `
                        <div style="color: #4ecdc4 !important; font-size: 0.8em !important; margin-bottom: 8px !important;">
                            æ‹¥æœ‰: ${ownedCount}
                        </div>
                        ` : ''}
                        <button onclick="buyItem('${itemId}')" style="
                            padding: 8px 16px !important;
                            background: ${canAfford ? '#43b581' : '#99aab5'} !important;
                            color: white !important;
                            border: none !important;
                            border-radius: 20px !important;
                            cursor: ${canAfford ? 'pointer' : 'not-allowed'} !important;
                            font-size: 0.9em !important;
                            width: 100% !important;
                        " ${!canAfford ? 'disabled' : ''}>
                            ${canAfford ? 'è´­ä¹°' : 'é‡‘å¸ä¸è¶³'}
                        </button>
                    </div>
                `;
            }
        });

        return itemsHtml || '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">è¯¥åˆ†ç±»æš‚æ— å•†å“</div>';
    }

    window.buyItem = function(itemId) {
        const item = SHOP_ITEMS[itemId];
        if (!item) return;

        if ((petData.coins || 100) < item.price) {
            toastr.error('é‡‘å¸ä¸è¶³ï¼');
            return;
        }

        if (!confirm(`ç¡®å®šè¦è´­ä¹° ${item.name} å—ï¼Ÿ\nä»·æ ¼ï¼š${item.price} é‡‘å¸\n\n${item.description}`)) {
            return;
        }

        // æ‰£é™¤é‡‘å¸
        petData.coins = (petData.coins || 100) - item.price;

        // æ·»åŠ åˆ°åº“å­˜
        if (!petData.inventory) petData.inventory = {};
        petData.inventory[itemId] = (petData.inventory[itemId] || 0) + 1;

        // ç«‹å³ä½¿ç”¨ç‰©å“æ•ˆæœ
        useItem(itemId);

        // ä¿å­˜æ•°æ®
        savePetData();

        // æ›´æ–°å•†åº—æ˜¾ç¤º
        const currentCategory = $('.shop-category-btn').filter(function() {
            return $(this).css('background-color') === 'rgb(255, 215, 0)' || $(this).css('background') === '#ffd700';
        }).data('category') || 'all';

        $('#shop-items').html(generateShopItems(currentCategory));
        $('.shop-modal h2').next().html(`ğŸ’° ${petData.coins} é‡‘å¸`);

        toastr.success(`è´­ä¹°æˆåŠŸï¼${item.name} å·²è‡ªåŠ¨ä½¿ç”¨ã€‚`);
    };

    function useItem(itemId) {
        const item = SHOP_ITEMS[itemId];
        if (!item || !item.effect) return;

        const effect = item.effect;

        // åº”ç”¨æ•ˆæœ
        if (effect.hunger) petData.hunger = Math.min(100, Math.max(0, petData.hunger + effect.hunger));
        if (effect.happiness) petData.happiness = Math.min(100, Math.max(0, petData.happiness + effect.happiness));
        if (effect.health) petData.health = Math.min(100, Math.max(0, petData.health + effect.health));
        if (effect.energy) petData.energy = Math.min(100, Math.max(0, petData.energy + effect.energy));
        if (effect.sickness) petData.sickness = Math.min(100, Math.max(0, (petData.sickness || 0) + effect.sickness));
        if (effect.discipline) petData.discipline = Math.min(100, Math.max(0, (petData.discipline || 50) + effect.discipline));

        // ç‰¹æ®Šæ•ˆæœ
        if (effect.timeFreeze) {
            // æ—¶é—´èƒ¶å›Šæ•ˆæœ - å»¶è¿Ÿä¸‹æ¬¡æ›´æ–°æ—¶é—´
            petData.lastUpdateTime = Date.now() + (effect.timeFreeze * 60 * 60 * 1000);
            toastr.info(`â° æ—¶é—´å·²æš‚åœ ${effect.timeFreeze} å°æ—¶ï¼`);
        }

        if (effect.revive && !petData.isAlive) {
            // å¤æ´»çŸ³æ•ˆæœ
            petData.isAlive = true;
            petData.deathReason = null;
            petData.health = Math.max(20, petData.health - (effect.healthPenalty || 0));
            petData.sickness = 0;
            petData.careNeglectCount = 0;
            toastr.success(`ğŸ’ ${petData.name} å¤æ´»äº†ï¼ä½†æœ€å¤§å¥åº·å€¼é™ä½äº†ã€‚`);
        }

        // è£…é¥°å“æ•ˆæœï¼ˆæŒç»­åŠ æˆï¼‰
        if (effect.happinessBonus || effect.disciplineBonus) {
            // è¿™äº›æ•ˆæœéœ€è¦åœ¨çŠ¶æ€æ›´æ–°æ—¶æŒç»­åº”ç”¨
            if (!petData.activeDecorations) petData.activeDecorations = [];
            if (!petData.activeDecorations.includes(itemId)) {
                petData.activeDecorations.push(itemId);
            }
        }

        validateAndFixValues();
    }

    window.closeShopModal = function() {
        $('#shop-modal').remove();
    };

    // æµ‹è¯•å•†åº—ç³»ç»Ÿ
    window.testShopSystem = function() {
        console.log('ğŸ›’ æµ‹è¯•å•†åº—ç³»ç»Ÿ...');

        console.log('\nğŸ’° å½“å‰é‡‘å¸çŠ¶æ€:');
        console.log(`é‡‘å¸: ${petData.coins || 100}`);

        console.log('\nğŸ“¦ å½“å‰åº“å­˜:');
        if (petData.inventory && Object.keys(petData.inventory).length > 0) {
            Object.entries(petData.inventory).forEach(([itemId, count]) => {
                const item = SHOP_ITEMS[itemId];
                console.log(`${item ? item.emoji + ' ' + item.name : itemId}: ${count}`);
            });
        } else {
            console.log('åº“å­˜ä¸ºç©º');
        }

        console.log('\nğŸª å•†åº—ç‰©å“:');
        Object.entries(SHOP_ITEMS).forEach(([itemId, item]) => {
            const canAfford = (petData.coins || 100) >= item.price;
            console.log(`${item.emoji} ${item.name} - ${item.price}é‡‘å¸ ${canAfford ? 'âœ…' : 'âŒ'}`);
        });

        console.log('\nğŸ® å¯ç”¨å‘½ä»¤:');
        console.log('- openShop() - æ‰“å¼€å•†åº—');
        console.log('- buyItem("itemId") - è´­ä¹°ç‰©å“');
        console.log('- gainCoins(amount) - è·å¾—é‡‘å¸');
        console.log('- petData.coins = 1000 - è®¾ç½®é‡‘å¸æ•°é‡');

        return {
            coins: petData.coins || 100,
            inventory: petData.inventory || {},
            shopItems: Object.keys(SHOP_ITEMS).length,
            timestamp: new Date().toISOString()
        };
    };

    // å¼ºåˆ¶æ›´æ–°åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿ
    window.forceUpdateToTamagotchi = function() {
        console.log('ğŸ”„ å¼ºåˆ¶æ›´æ–°åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿ...');

        // å¤‡ä»½é‡è¦æ•°æ®
        const backup = {
            name: petData.name,
            type: petData.type,
            level: petData.level,
            experience: petData.experience,
            created: petData.created,
            coins: petData.coins || 100
        };

        console.log('å¤‡ä»½æ•°æ®:', backup);

        // é‡ç½®ä¸ºæ‹“éº»æ­Œå­å¼æ•°æ®ç»“æ„
        petData = {
            ...backup,

            // æ‹“éº»æ­Œå­å¼æ•°å€¼
            health: 50,
            happiness: 50,
            hunger: 50,
            energy: 50,

            // æ‹“éº»æ­Œå­å¼ç”Ÿå‘½çŠ¶æ€
            lifeStage: "baby",
            age: 0,
            isAlive: true,
            deathReason: null,

            // æ‹“éº»æ­Œå­å¼æŠ¤ç†çŠ¶æ€
            sickness: 0,
            discipline: 50,
            weight: 30,

            // æ—¶é—´è®°å½•
            lastFeedTime: Date.now(),
            lastPlayTime: Date.now(),
            lastSleepTime: Date.now(),
            lastUpdateTime: Date.now(),
            lastCareTime: Date.now(),

            // æ‹“éº»æ­Œå­å¼è®¡æ•°å™¨
            careNeglectCount: 0,
            sicknessDuration: 0,

            // å•†åº—ç³»ç»Ÿ
            inventory: petData.inventory || {},

            dataVersion: 4.0
        };

        // åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿ
        applyTamagotchiSystem();

        // ä¿å­˜æ•°æ®
        savePetData();

        // å¼ºåˆ¶åˆ·æ–°UI
        if (typeof renderPetStatus === 'function') {
            renderPetStatus();
        }

        console.log('âœ… å¼ºåˆ¶æ›´æ–°å®Œæˆï¼');
        console.log('æ–°çš„æ‹“éº»æ­Œå­æ•°æ®:', petData);

        toastr.success('ğŸ¥š å·²å¼ºåˆ¶æ›´æ–°åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿï¼è¯·é‡æ–°æ‰“å¼€å® ç‰©ç•Œé¢æŸ¥çœ‹ã€‚');

        return petData;
    };

    // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½
    window.forceClearAndReload = function() {
        console.log('ğŸ§¹ å¼ºåˆ¶æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½...');

        // æ¸…é™¤æ‰€æœ‰å¼¹çª—
        $('.virtual-pet-popup-overlay').remove();
        $('#virtual-pet-popup-overlay').remove();
        $('#shop-modal').remove();

        // æ¸…é™¤æŒ‰é’®
        $('#virtual-pet-button').remove();

        // é‡æ–°åŠ è½½è„šæœ¬
        location.reload();
    };

    // å®Œæ•´ä¿®å¤æ‰€æœ‰é—®é¢˜
    window.fixAllIssues = function() {
        console.log('ğŸ”§ å¼€å§‹å®Œæ•´ä¿®å¤æ‰€æœ‰é—®é¢˜...');

        // 1. å¼ºåˆ¶æ›´æ–°åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿ
        console.log('1. æ›´æ–°åˆ°æ‹“éº»æ­Œå­ç³»ç»Ÿ...');
        forceUpdateToTamagotchi();

        // 2. ç¡®ä¿å•†åº—ç³»ç»Ÿå¯ç”¨
        console.log('2. æ£€æŸ¥å•†åº—ç³»ç»Ÿ...');
        if (!petData.coins) petData.coins = 100;
        if (!petData.inventory) petData.inventory = {};

        // 3. é‡æ–°ç»‘å®šäº‹ä»¶
        console.log('3. é‡æ–°ç»‘å®šUIäº‹ä»¶...');
        setTimeout(() => {
            const $popup = $('.virtual-pet-popup-overlay');
            if ($popup.length > 0) {
                bindUnifiedUIEvents($popup);
            }
        }, 500);

        // 4. ä¿å­˜æ•°æ®
        savePetData();

        console.log('âœ… æ‰€æœ‰é—®é¢˜ä¿®å¤å®Œæˆï¼');
        toastr.success('ğŸ‰ æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼å•†åº—æŒ‰é’®å’Œæ‹“éº»æ­Œå­ç³»ç»Ÿç°åœ¨åº”è¯¥æ­£å¸¸å·¥ä½œäº†ï¼');

        return {
            fixed: true,
            timestamp: new Date().toISOString(),
            petData: petData
        };
    };

    // æµ‹è¯•æ‹“éº»æ­Œå­UIé£æ ¼ (ç³–æœè‰²ç‰ˆæœ¬)
    window.testTamagotchiUI = function() {
        console.log('ğŸ® æµ‹è¯•æ‹“éº»æ­Œå­UIé£æ ¼ (ç³–æœè‰²ç‰ˆæœ¬)...');

        console.log('\nğŸ¨ é…è‰²æ–¹æ¡ˆ:');
        console.log(`ä¸»èƒŒæ™¯: ${candyColors.background}`);
        console.log(`å±å¹•è‰²: ${candyColors.screen}`);
        console.log(`è¾¹æ¡†è‰²: ${candyColors.border}`);
        console.log(`æ–‡å­—è‰²: ${candyColors.textPrimary}`);

        console.log('\nğŸ¯ UIç‰¹æ€§:');
        console.log('âœ… åƒç´ åŒ–å­—ä½“ (Courier New)');
        console.log('âœ… æ–¹å½¢è¾¹æ¡† (border-radius: 0)');
        console.log('âœ… ç³–æœè‰²æ¸å˜èƒŒæ™¯');
        console.log('âœ… æŸ”å’Œç²‰è‰²é˜´å½±');
        console.log('âœ… å¤§å†™è‹±æ–‡æŒ‰é’®æ–‡å­—');
        console.log('âœ… æ‹“éº»æ­Œå­å¼çŠ¶æ€æ ');

        console.log('\nğŸ”§ å¯ç”¨å‘½ä»¤:');
        console.log('- fixAllIssues() - ä¿®å¤æ‰€æœ‰é—®é¢˜');
        console.log('- showPopup() - æ˜¾ç¤ºæ‹“éº»æ­Œå­UI');
        console.log('- testTamagotchiSystem() - æµ‹è¯•æ‹“éº»æ­Œå­ç³»ç»Ÿ');
        console.log('- forceApplyTamagotchiSystem() - å¼ºåˆ¶åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿï¼ˆä¿®å¤é‡‘å¸é—®é¢˜ï¼‰');
        console.log('- testCleanPrompt() - æµ‹è¯•ä¼˜åŒ–åçš„æç¤ºè¯ï¼ˆé¿å…AIæ··æ·†é‡‘å¸ï¼‰');
        console.log('- diagnoseRewardSystem() - è¯Šæ–­é‡‘å¸å’Œç»éªŒå€¼é—®é¢˜');
        console.log('- checkInteractionFunctions() - æ£€æŸ¥å½“å‰ä½¿ç”¨çš„äº’åŠ¨å‡½æ•°ç‰ˆæœ¬');
        console.log('- testSimpleInteraction() - æµ‹è¯•ç®€åŒ–äº’åŠ¨ï¼ˆä¸åŒ…å«AIï¼‰');
        console.log('- testInteractionFlow() - æµ‹è¯•å®Œæ•´äº’åŠ¨æµç¨‹ï¼ˆåŒ…å«AIï¼‰');
        console.log('- traceFeedPetExecution() - è¿½è¸ªå–‚é£Ÿå‡½æ•°çš„è¯¦ç»†æ‰§è¡Œæµç¨‹');
        console.log('- checkUIButtonBinding() - æ£€æŸ¥UIæŒ‰é’®äº‹ä»¶ç»‘å®š');
        console.log('- traceUIFeedPet() - è¿½è¸ªUIç‚¹å‡»æ—¶çš„å‡½æ•°è°ƒç”¨');
        console.log('- restoreOriginalFunctions() - æ¢å¤åŸå§‹å‡½æ•°ï¼ˆè¿½è¸ªåä½¿ç”¨ï¼‰');
        console.log('- checkFeedPetVersions() - æ£€æŸ¥ä¸åŒä½œç”¨åŸŸçš„feedPetå‡½æ•°å¹¶ä¿®å¤UIç»‘å®š');
        console.log('- testFixedUIButton() - æµ‹è¯•ä¿®å¤åçš„UIæŒ‰é’®ï¼ˆåŒ…å«è¯¦ç»†è¿½è¸ªï¼‰');
        console.log('- testUIAfterCooldown() - ç­‰å¾…å†·å´æ—¶é—´åæµ‹è¯•UIæŒ‰é’®');
        console.log('- inspectUIFeedPet() - æ£€æŸ¥UIå®é™…è°ƒç”¨çš„å‡½æ•°å¹¶å¼ºåˆ¶ä¿®å¤');
        console.log('- forceUIRefresh() - å¼ºåˆ¶åˆ·æ–°UIæ˜¾ç¤ºï¼ˆè§£å†³é‡‘å¸æ˜¾ç¤ºå»¶è¿Ÿï¼‰');
        console.log('- testRewardDisplay() - æµ‹è¯•å¥–åŠ±æ˜¾ç¤ºç³»ç»Ÿ');
        console.log('- adjustDecaySystem() - è°ƒæ•´è¡°å‡é€Ÿåº¦');
        console.log('- testNewDecaySystem() - æµ‹è¯•è¡°å‡æ•ˆæœ');
        console.log('- testNewValueBalance() - æµ‹è¯•æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿçš„æ•°å€¼å¹³è¡¡');
        console.log('- testHugFunction() - æµ‹è¯•æŠ±æŠ±åŠŸèƒ½ï¼ˆæ£€æŸ¥æŒ‰é’®ã€å‡½æ•°ã€å¥–åŠ±ï¼‰');
        console.log('- testHugFunctionComplete() - å®Œæ•´æµ‹è¯•æŠ±æŠ±åŠŸèƒ½ï¼ˆåŒ…æ‹¬å‰åæ£€æŸ¥ï¼‰');
        console.log('- quickVerifyHugFunction() - å¿«é€ŸéªŒè¯æŠ±æŠ±åŠŸèƒ½æ˜¯å¦å®Œæ•´');
        console.log('- diagnose75ValueIssue() - è¯Šæ–­å’Œä¿®å¤75æ•°å€¼é—®é¢˜');
        console.log('- testSmartInitSystem() - æµ‹è¯•æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿ');
        console.log('- resetRandomizationFlag() - é‡ç½®éšæœºåŒ–æ ‡è®°ï¼ˆæµ‹è¯•ç”¨ï¼‰');
        console.log('- diagnoseValueResetIssue() - è¯Šæ–­æ•°å€¼é‡ç½®é—®é¢˜');

        // å¼ºåˆ¶åˆ·æ–°UI
        if (typeof renderPetStatus === 'function') {
            renderPetStatus();
        }

        toastr.success('ğŸ® ç³–æœè‰²æ‹“éº»æ­Œå­UIé£æ ¼å·²åº”ç”¨ï¼é‡æ–°æ‰“å¼€å® ç‰©ç•Œé¢æŸ¥çœ‹æ•ˆæœã€‚');

        return {
            uiStyle: 'tamagotchi-candy',
            colors: candyColors,
            timestamp: new Date().toISOString()
        };
    };

    // æµ‹è¯•æ–°çš„çŠ¶æ€æ é¢œè‰²
    window.testStatusColors = function() {
        console.log('ğŸ¨ æµ‹è¯•æ–°çš„çŠ¶æ€æ é¢œè‰²...');

        console.log('\nğŸŒˆ çŠ¶æ€æ é…è‰²:');
        console.log(`â¤ï¸ å¥åº·: ${candyColors.health} (ç³–æœç²‰)`);
        console.log(`ğŸ˜Š å¿«ä¹: ${candyColors.happiness} (æŸ æª¬é»„)`);
        console.log(`ğŸ– é¥±é£Ÿ: ${candyColors.hunger} (èœœæ¡ƒæ©™)`);
        console.log(`âš¡ ç²¾åŠ›: ${candyColors.energy} (å¤©ç©ºè“)`);
        console.log(`ğŸ’Š ç–¾ç—…: ${candyColors.health} (ç³–æœç²‰)`);
        console.log(`ğŸ“š çºªå¾‹: ${candyColors.experience} (è–°è¡£è‰ç´«)`);

        console.log('\nâœ¨ æŒ‰é’®é…è‰²:');
        console.log(`ğŸ– å–‚é£Ÿ: ${candyColors.buttonPrimary} (ç³–æœç²‰)`);
        console.log(`ğŸ® ç©è€: ${candyColors.buttonSecondary} (è–„è·ç»¿)`);
        console.log(`ğŸ˜´ ä¼‘æ¯: ${candyColors.buttonAccent} (å¤©ç©ºè“)`);
        console.log(`ğŸ’Š æ²»ç–—: ${candyColors.health} (ç³–æœç²‰)`);
        console.log(`ğŸ›’ å•†åº—: ${candyColors.happiness} (æŸ æª¬é»„)`);

        console.log('\nğŸ¯ æ”¹è¿›å†…å®¹:');
        console.log('âœ… çŠ¶æ€æ é¢œè‰²æ›´åŠ æŸ”å’Œç¾è§‚');
        console.log('âœ… ç§»é™¤äº†åˆºçœ¼çš„çº¯è‰² (#FF0000, #FFFF00)');
        console.log('âœ… æ·»åŠ äº†ç¼ºå¤±çš„ç²¾åŠ›çŠ¶æ€æ ');
        console.log('âœ… ç»Ÿä¸€äº†ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯çš„é¢œè‰²');
        console.log('âœ… æŒ‰é’®é¢œè‰²ä¸ç³–æœè‰²ä¸»é¢˜åè°ƒ');

        toastr.success('ğŸ¨ çŠ¶æ€æ é¢œè‰²å·²ä¼˜åŒ–ï¼é‡æ–°æ‰“å¼€å® ç‰©ç•Œé¢æŸ¥çœ‹ç¾ä¸½çš„ç³–æœè‰²æ•ˆæœã€‚');

        return {
            statusColors: {
                health: candyColors.health,
                happiness: candyColors.happiness,
                hunger: candyColors.hunger,
                energy: candyColors.energy,
                experience: candyColors.experience
            },
            timestamp: new Date().toISOString()
        };
    };

    // æµ‹è¯•æ²»ç–—æŒ‰é’®åŠŸèƒ½
    window.testHealButton = function() {
        console.log('ğŸ’Š æµ‹è¯•æ²»ç–—æŒ‰é’®åŠŸèƒ½...');

        const sicknessLevel = petData.sickness || 0;

        console.log('\nğŸ¥ å½“å‰çŠ¶æ€:');
        console.log(`ç–¾ç—…å€¼: ${sicknessLevel}`);
        console.log(`å¥åº·å€¼: ${petData.health}`);
        console.log(`æ˜¯å¦å­˜æ´»: ${petData.isAlive}`);

        console.log('\nğŸ¯ æ²»ç–—æŒ‰é’®çŠ¶æ€:');
        if (sicknessLevel > 10) {
            console.log('âœ… æ²»ç–—æŒ‰é’®æ¿€æ´» - å® ç‰©ç”Ÿç—…äº†');
            console.log(`- èƒŒæ™¯è‰²: ${candyColors.health} (ç³–æœç²‰)`);
            console.log('- é€æ˜åº¦: 1.0 (å®Œå…¨å¯è§)');
            console.log('- é¼ æ ‡æ ·å¼: pointer (å¯ç‚¹å‡»)');
        } else {
            console.log('âš ï¸ æ²»ç–—æŒ‰é’®ç¦ç”¨ - å® ç‰©å¾ˆå¥åº·');
            console.log(`- èƒŒæ™¯è‰²: ${candyColors.secondary} (ç°è‰²)`);
            console.log('- é€æ˜åº¦: 0.5 (åŠé€æ˜)');
            console.log('- é¼ æ ‡æ ·å¼: not-allowed (ç¦ç”¨)');
        }

        console.log('\nğŸ§ª æµ‹è¯•å‘½ä»¤:');
        console.log('- healPet() - å°è¯•æ²»ç–—å® ç‰©');
        console.log('- petData.sickness = 50 - è®¾ç½®å® ç‰©ç”Ÿç—…');
        console.log('- petData.sickness = 0 - è®¾ç½®å® ç‰©å¥åº·');
        console.log('- renderPetStatus() - åˆ·æ–°UIæ˜¾ç¤º');

        console.log('\nğŸ’¡ åŠŸèƒ½ç‰¹æ€§:');
        console.log('âœ… æ²»ç–—æŒ‰é’®å¸¸é©»æ˜¾ç¤º');
        console.log('âœ… ç”Ÿç—…æ—¶å¯ç‚¹å‡»ï¼Œå¥åº·æ—¶ç¦ç”¨');
        console.log('âœ… è§†è§‰åé¦ˆï¼šé¢œè‰²å’Œé€æ˜åº¦å˜åŒ–');
        console.log('âœ… ç‚¹å‡»åé¦ˆï¼šå¥åº·æ—¶æ˜¾ç¤ºéšæœºæç¤º');
        console.log('âœ… æ²»ç–—æ•ˆæœï¼šé™ä½ç–¾ç—…å€¼ï¼Œæå‡å¥åº·å€¼');

        return {
            sicknessLevel: sicknessLevel,
            canHeal: sicknessLevel > 10,
            buttonState: sicknessLevel > 10 ? 'active' : 'disabled',
            timestamp: new Date().toISOString()
        };
    };

    // æµ‹è¯•æŒ‰é’®æ–‡å­—å’Œæ ·å¼
    window.testButtonStyles = function() {
        console.log('ğŸ¨ æµ‹è¯•æŒ‰é’®æ–‡å­—å’Œæ ·å¼...');

        console.log('\nğŸ“± ç§»åŠ¨ç«¯æŒ‰é’®:');
        console.log('ğŸ– å–‚é£Ÿ - ç³–æœç²‰èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ® ç©è€ - è–„è·ç»¿èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ˜´ ä¼‘æ¯ - å¤©ç©ºè“èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ’Š æ²»ç–— - åŠ¨æ€èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ›’ å•†åº— - æŸ æª¬é»„èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('âš™ï¸ è®¾ç½® - ç°è‰²èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');

        console.log('\nğŸ–¥ï¸ æ¡Œé¢ç«¯æŒ‰é’®:');
        console.log('ğŸ– å–‚é£Ÿ - ç³–æœç²‰èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ® ç©è€ - è–„è·ç»¿èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ˜´ ä¼‘æ¯ - å¤©ç©ºè“èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ’Š æ²»ç–— - åŠ¨æ€èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('ğŸ›’ å•†åº— - æŸ æª¬é»„èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');
        console.log('âš™ï¸ è®¾ç½® - ç°è‰²èƒŒæ™¯ï¼Œä¸­æ–‡æ–‡å­—');

        console.log('\nğŸ¯ æ ·å¼ç‰¹æ€§:');
        console.log('âœ… æ‰€æœ‰æŒ‰é’®æ–‡å­—å·²æ”¹ä¸ºä¸­æ–‡');
        console.log('âœ… ç§»é™¤äº† text-transform: uppercase');
        console.log('âœ… ä¿æŒæ‹“éº»æ­Œå­åƒç´ é£æ ¼');
        console.log('âœ… ç»Ÿä¸€çš„ç³–æœè‰²é…è‰²æ–¹æ¡ˆ');
        console.log('âœ… æ–¹å½¢è¾¹æ¡†å’Œåƒç´ é˜´å½±');
        console.log('âœ… Courier New ç­‰å®½å­—ä½“');

        console.log('\nğŸ”§ å¯ç”¨å‘½ä»¤:');
        console.log('- fixAllIssues() - ä¿®å¤æ‰€æœ‰é—®é¢˜');
        console.log('- testTamagotchiUI() - æµ‹è¯•æ‹“éº»æ­Œå­UI');
        console.log('- testHealButton() - æµ‹è¯•æ²»ç–—æŒ‰é’®åŠŸèƒ½');

        toastr.success('ğŸ¨ æŒ‰é’®æ ·å¼å·²ä¼˜åŒ–ï¼æ‰€æœ‰æŒ‰é’®ç°åœ¨éƒ½æ˜¾ç¤ºä¸­æ–‡æ–‡å­—ã€‚');

        return {
            buttonsUpdated: true,
            language: 'chinese',
            style: 'tamagotchi-candy',
            timestamp: new Date().toISOString()
        };
    };

    // æµ‹è¯•æ—¶é—´è¡°å‡ä¿®å¤
    window.testDecayFix = function() {
        console.log('â° æµ‹è¯•æ—¶é—´è¡°å‡ä¿®å¤...');

        console.log('\nğŸ“Š å½“å‰è¡°å‡é€Ÿåº¦:');
        console.log('é¥±é£Ÿåº¦: æ¯å°æ—¶ -1.2 (åŸæ¥ -3.0)');
        console.log('ç²¾åŠ›: æ¯å°æ—¶ -1.0 (åŸæ¥ -2.5)');
        console.log('å¿«ä¹åº¦: æ¯å°æ—¶ -0.8 (åŸæ¥ -2.0)');

        console.log('\nğŸ›¡ï¸ åˆå§‹åŒ–ç¼“å†²æœºåˆ¶:');
        console.log('âœ… é•¿æ—¶é—´æœªæ›´æ–°æ—¶è‡ªåŠ¨ç¼“å†²');
        console.log('âœ… æœ€ä½é¥±é£Ÿåº¦: 30');
        console.log('âœ… æœ€ä½ç²¾åŠ›: 25');
        console.log('âœ… æœ€ä½å¿«ä¹åº¦: 20');
        console.log('âœ… æœ€ä½å¥åº·åº¦: 35');

        const now = Date.now();
        const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
        const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);

        console.log('\nâ±ï¸ å½“å‰çŠ¶æ€:');
        console.log(`è·ç¦»ä¸Šæ¬¡æ›´æ–°: ${hoursElapsed.toFixed(1)} å°æ—¶`);
        console.log(`é¥±é£Ÿåº¦: ${Math.round(petData.hunger)}`);
        console.log(`ç²¾åŠ›: ${Math.round(petData.energy)}`);
        console.log(`å¿«ä¹åº¦: ${Math.round(petData.happiness)}`);
        console.log(`å¥åº·åº¦: ${Math.round(petData.health)}`);

        console.log('\nğŸ§ª æµ‹è¯•å‘½ä»¤:');
        console.log('- applyInitializationBuffer() - æ‰‹åŠ¨åº”ç”¨ç¼“å†²');
        console.log('- petData.lastUpdateTime = Date.now() - 4*60*60*1000 - æ¨¡æ‹Ÿ4å°æ—¶å‰');
        console.log('- updatePetStatus() - æ‰‹åŠ¨æ›´æ–°çŠ¶æ€');

        console.log('\nğŸ’¡ ä¿®å¤æ•ˆæœ:');
        console.log('âœ… é‡æ–°æ‰“å¼€SillyTavernæ—¶ä¸ä¼šç«‹å³æç¤ºéœ€è¦ä¼‘æ¯');
        console.log('âœ… è¡°å‡é€Ÿåº¦æ›´åˆç†ï¼Œä¸ä¼šè¿‡å¿«ä¸‹é™');
        console.log('âœ… é•¿æ—¶é—´ç¦»å¼€åæœ‰åŸºç¡€ç¼“å†²ä¿æŠ¤');
        console.log('âœ… ç”¨æˆ·ä½“éªŒæ›´å‹å¥½');

        return {
            decayRates: {
                hunger: -1.2,
                energy: -1.0,
                happiness: -0.8
            },
            bufferThresholds: {
                hunger: 30,
                energy: 25,
                happiness: 20,
                health: 35
            },
            hoursElapsed: hoursElapsed,
            currentStatus: {
                hunger: Math.round(petData.hunger),
                energy: Math.round(petData.energy),
                happiness: Math.round(petData.happiness),
                health: Math.round(petData.health)
            },
            timestamp: new Date().toISOString()
        };
    };

    // æµ‹è¯•è®¾ç½®æŒ‰é’®é¢œè‰²ä¿®å¤
    window.testSettingsButtonColor = function() {
        console.log('ğŸ¨ æµ‹è¯•è®¾ç½®æŒ‰é’®é¢œè‰²ä¿®å¤...');

        console.log('\nâŒ ä¿®å¤å‰çš„é—®é¢˜:');
        console.log('èƒŒæ™¯è‰²: #333333 (æ·±ç°)');
        console.log('æ–‡å­—è‰²: #2D3748 (æ·±ç°)');
        console.log('é—®é¢˜: ä¸¤ä¸ªæ·±è‰²å¯¹æ¯”åº¦ä¸å¤Ÿï¼Œæ–‡å­—éš¾ä»¥çœ‹æ¸…');

        console.log('\nâœ… ä¿®å¤åçš„æ”¹è¿›:');
        console.log('èƒŒæ™¯è‰²: #8B5CF6 (ç´«è‰²)');
        console.log('æ–‡å­—è‰²: #FFFFFF (ç™½è‰²)');
        console.log('æ•ˆæœ: é«˜å¯¹æ¯”åº¦ï¼Œæ–‡å­—æ¸…æ™°å¯è§');

        console.log('\nğŸ¯ æŒ‰é’®é…è‰²æ–¹æ¡ˆ:');
        console.log('ğŸ– å–‚é£Ÿ: ç³–æœç²‰èƒŒæ™¯ + æ·±ç°æ–‡å­—');
        console.log('ğŸ® ç©è€: è–„è·ç»¿èƒŒæ™¯ + æ·±ç°æ–‡å­—');
        console.log('ğŸ˜´ ä¼‘æ¯: å¤©ç©ºè“èƒŒæ™¯ + æ·±ç°æ–‡å­—');
        console.log('ğŸ’Š æ²»ç–—: åŠ¨æ€èƒŒæ™¯ + ç™½è‰²æ–‡å­—');
        console.log('ğŸ›’ å•†åº—: æŸ æª¬é»„èƒŒæ™¯ + æ·±ç°æ–‡å­—');
        console.log('âš™ï¸ è®¾ç½®: ç´«è‰²èƒŒæ™¯ + ç™½è‰²æ–‡å­— â† å·²ä¿®å¤');

        console.log('\nğŸ” é¢œè‰²å¯¹æ¯”åº¦åˆ†æ:');
        console.log('è®¾ç½®æŒ‰é’®: ç´«è‰²(#8B5CF6) + ç™½è‰²(#FFFFFF) = é«˜å¯¹æ¯”åº¦ âœ…');
        console.log('å…¶ä»–æŒ‰é’®: æµ…è‰²èƒŒæ™¯ + æ·±è‰²æ–‡å­— = è‰¯å¥½å¯¹æ¯”åº¦ âœ…');

        console.log('\nğŸ¨ è®¾è®¡åŸåˆ™:');
        console.log('âœ… ä¿æŒæ‹“éº»æ­Œå­åƒç´ é£æ ¼');
        console.log('âœ… ç¡®ä¿æ–‡å­—æ¸…æ™°å¯è¯»');
        console.log('âœ… ä¸ç³–æœè‰²ä¸»é¢˜åè°ƒ');
        console.log('âœ… è®¾ç½®æŒ‰é’®æœ‰ç‹¬ç‰¹è¯†åˆ«åº¦');

        console.log('\nğŸ§ª æµ‹è¯•æ–¹æ³•:');
        console.log('1. é‡æ–°æ‰“å¼€å® ç‰©ç•Œé¢');
        console.log('2. æ£€æŸ¥è®¾ç½®æŒ‰é’®æ˜¯å¦æ¸…æ™°å¯è§');
        console.log('3. ç¡®è®¤æ–‡å­—ä¸èƒŒæ™¯å¯¹æ¯”åº¦è¶³å¤Ÿ');

        toastr.success('ğŸ¨ è®¾ç½®æŒ‰é’®é¢œè‰²å·²ä¿®å¤ï¼ç°åœ¨æ–‡å­—æ¸…æ™°å¯è§äº†ã€‚');

        return {
            fixed: true,
            oldColors: {
                background: '#333333',
                text: '#2D3748',
                contrast: 'poor'
            },
            newColors: {
                background: '#8B5CF6',
                text: '#FFFFFF',
                contrast: 'excellent'
            },
            timestamp: new Date().toISOString()
        };
    };

    // æµ‹è¯•è‡ªå®šä¹‰äººè®¾ä¿å­˜åŠŸèƒ½
    window.testPersonalitySave = function() {
        console.log('ğŸ­ æµ‹è¯•è‡ªå®šä¹‰äººè®¾ä¿å­˜åŠŸèƒ½...');

        console.log('\nğŸ“‹ å½“å‰äººè®¾çŠ¶æ€:');
        const currentType = localStorage.getItem(`${extensionName}-personality-type`) || 'default';
        const customPersonality = localStorage.getItem(`${extensionName}-custom-personality`) || '';
        console.log(`äººè®¾ç±»å‹: ${currentType}`);
        console.log(`è‡ªå®šä¹‰äººè®¾: ${customPersonality || '(ç©º)'}`);
        console.log(`petData.personality: ${petData.personality || '(ç©º)'}`);

        console.log('\nğŸ” é—®é¢˜è¯Šæ–­:');
        console.log('âœ… æ•°æ®è¿ç§»æ—¶ä¿ç•™personalityå­—æ®µ');
        console.log('âœ… åˆå§‹æ•°æ®ç»“æ„åŒ…å«personalityå­—æ®µ');
        console.log('âœ… æ–°ç”¨æˆ·åˆå§‹åŒ–æ—¶è®¾ç½®personality');
        console.log('âœ… æ•°æ®åŠ è½½æ—¶æ¢å¤personality');

        console.log('\nğŸ§ª æµ‹è¯•è‡ªå®šä¹‰äººè®¾ä¿å­˜:');
        const testPersonality = 'æˆ‘æ˜¯ä¸€åªç‰¹åˆ«å¯çˆ±çš„æµ‹è¯•å® ç‰©ï¼Œå–œæ¬¢å’Œä¸»äººäº’åŠ¨ï¼';
        console.log(`ä¿å­˜æµ‹è¯•äººè®¾: ${testPersonality}`);

        // ä¿å­˜æµ‹è¯•äººè®¾
        savePersonalitySettings('custom', testPersonality);

        // éªŒè¯ä¿å­˜ç»“æœ
        const savedType = localStorage.getItem(`${extensionName}-personality-type`);
        const savedCustom = localStorage.getItem(`${extensionName}-custom-personality`);

        console.log('\nâœ… ä¿å­˜ç»“æœéªŒè¯:');
        console.log(`localStorageäººè®¾ç±»å‹: ${savedType}`);
        console.log(`localStorageè‡ªå®šä¹‰äººè®¾: ${savedCustom}`);
        console.log(`petData.personality: ${petData.personality}`);

        // æ¨¡æ‹Ÿé‡æ–°åŠ è½½
        console.log('\nğŸ”„ æ¨¡æ‹Ÿé‡æ–°åŠ è½½æ•°æ®...');
        const reloadedPersonality = getCurrentPersonality();
        console.log(`é‡æ–°åŠ è½½åçš„äººè®¾: ${reloadedPersonality}`);

        console.log('\nğŸ¯ æµ‹è¯•ç»“æœ:');
        const isWorking = savedType === 'custom' &&
                         savedCustom === testPersonality &&
                         petData.personality === testPersonality &&
                         reloadedPersonality === testPersonality;

        if (isWorking) {
            console.log('âœ… è‡ªå®šä¹‰äººè®¾ä¿å­˜åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼');
            toastr.success('ğŸ­ è‡ªå®šä¹‰äººè®¾ä¿å­˜åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼');
        } else {
            console.log('âŒ è‡ªå®šä¹‰äººè®¾ä¿å­˜åŠŸèƒ½æœ‰é—®é¢˜ï¼');
            console.log('é—®é¢˜åˆ†æ:');
            if (savedType !== 'custom') console.log('- localStorageäººè®¾ç±»å‹æœªæ­£ç¡®ä¿å­˜');
            if (savedCustom !== testPersonality) console.log('- localStorageè‡ªå®šä¹‰äººè®¾æœªæ­£ç¡®ä¿å­˜');
            if (petData.personality !== testPersonality) console.log('- petData.personalityæœªæ­£ç¡®æ›´æ–°');
            if (reloadedPersonality !== testPersonality) console.log('- é‡æ–°åŠ è½½æ—¶äººè®¾ä¸¢å¤±');
            toastr.error('âŒ è‡ªå®šä¹‰äººè®¾ä¿å­˜åŠŸèƒ½æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
        }

        console.log('\nğŸ”§ æ‰‹åŠ¨ä¿®å¤å‘½ä»¤:');
        console.log('- savePersonalitySettings("custom", "ä½ çš„è‡ªå®šä¹‰äººè®¾") - æ‰‹åŠ¨ä¿å­˜');
        console.log('- getCurrentPersonality() - æ£€æŸ¥å½“å‰äººè®¾');
        console.log('- loadPetData() - é‡æ–°åŠ è½½æ•°æ®');

        return {
            working: isWorking,
            currentType: savedType,
            customPersonality: savedCustom,
            petDataPersonality: petData.personality,
            reloadedPersonality: reloadedPersonality,
            timestamp: new Date().toISOString()
        };
    };

    // è°ƒè¯•è‡ªå®šä¹‰äººè®¾ä¸¢å¤±é—®é¢˜
    window.debugPersonalityLoss = function() {
        console.log('ğŸ” è°ƒè¯•è‡ªå®šä¹‰äººè®¾ä¸¢å¤±é—®é¢˜...');

        console.log('\nğŸ“‹ å½“å‰çŠ¶æ€æ£€æŸ¥:');
        const personalityType = localStorage.getItem(`${extensionName}-personality-type`);
        const customPersonality = localStorage.getItem(`${extensionName}-custom-personality`);
        const petDataPersonality = petData.personality;

        console.log(`localStorageäººè®¾ç±»å‹: "${personalityType}"`);
        console.log(`localStorageè‡ªå®šä¹‰äººè®¾: "${customPersonality}"`);
        console.log(`petData.personality: "${petDataPersonality}"`);

        console.log('\nğŸ” é—®é¢˜è¯Šæ–­:');

        // æ£€æŸ¥localStorageæ˜¯å¦å­˜åœ¨
        if (!personalityType) {
            console.log('âŒ localStorageä¸­æ²¡æœ‰äººè®¾ç±»å‹ï¼Œå¯èƒ½è¢«æ¸…é™¤äº†');
        } else if (personalityType !== 'custom') {
            console.log(`âŒ äººè®¾ç±»å‹ä¸æ˜¯customï¼Œè€Œæ˜¯: ${personalityType}`);
        } else {
            console.log('âœ… localStorageäººè®¾ç±»å‹æ­£ç¡®');
        }

        if (!customPersonality) {
            console.log('âŒ localStorageä¸­æ²¡æœ‰è‡ªå®šä¹‰äººè®¾å†…å®¹');
        } else {
            console.log('âœ… localStorageè‡ªå®šä¹‰äººè®¾å†…å®¹å­˜åœ¨');
        }

        if (!petDataPersonality) {
            console.log('âŒ petData.personalityä¸ºç©º');
        } else {
            console.log('âœ… petData.personalityæœ‰å†…å®¹');
        }

        console.log('\nğŸ§ª æµ‹è¯•getCurrentPersonality():');
        const currentPersonality = getCurrentPersonality();
        console.log(`getCurrentPersonality()è¿”å›: "${currentPersonality}"`);

        console.log('\nğŸ”§ å¯èƒ½çš„åŸå› :');
        console.log('1. cleanupOldCharacterData()è¯¯åˆ äº†æ•°æ®');
        console.log('2. æ•°æ®åŠ è½½æ—¶è¢«è¦†ç›–');
        console.log('3. localStorageè¢«å…¶ä»–ä»£ç æ¸…é™¤');
        console.log('4. æ‰©å±•åç§°å˜åŒ–å¯¼è‡´keyä¸åŒ¹é…');

        console.log('\nğŸ” æ‰©å±•åç§°æ£€æŸ¥:');
        console.log(`å½“å‰extensionName: "${extensionName}"`);
        console.log(`localStorage keyå‰ç¼€: "${extensionName}-"`);

        // åˆ—å‡ºæ‰€æœ‰ç›¸å…³çš„localStorageé¡¹
        console.log('\nğŸ“¦ ç›¸å…³localStorageé¡¹:');
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.includes('virtual-pet')) {
                console.log(`${key}: "${localStorage.getItem(key)}"`);
            }
        }

        console.log('\nğŸ”§ ä¿®å¤å»ºè®®:');
        if (!personalityType || personalityType !== 'custom') {
            console.log('- è¿è¡Œ: localStorage.setItem("virtual-pet-personality-type", "custom")');
        }
        if (!customPersonality) {
            console.log('- è¿è¡Œ: localStorage.setItem("virtual-pet-custom-personality", "ä½ çš„è‡ªå®šä¹‰äººè®¾")');
        }

        return {
            personalityType: personalityType,
            customPersonality: customPersonality,
            petDataPersonality: petDataPersonality,
            currentPersonality: currentPersonality,
            extensionName: extensionName,
            allVirtualPetKeys: Object.keys(localStorage).filter(key => key.includes('virtual-pet')),
            timestamp: new Date().toISOString()
        };
    };

    // å¼ºåˆ¶ä¿®å¤è‡ªå®šä¹‰äººè®¾ä¸¢å¤±é—®é¢˜
    window.fixPersonalityLoss = function(customText) {
        console.log('ğŸ”§ å¼ºåˆ¶ä¿®å¤è‡ªå®šä¹‰äººè®¾ä¸¢å¤±é—®é¢˜...');

        if (!customText) {
            customText = prompt('è¯·è¾“å…¥ä½ çš„è‡ªå®šä¹‰äººè®¾:', 'æˆ‘æ˜¯ä¸€åªç‰¹åˆ«å¯çˆ±çš„å® ç‰©ï¼Œå–œæ¬¢å’Œä¸»äººäº’åŠ¨ï¼');
            if (!customText) {
                console.log('âŒ ç”¨æˆ·å–æ¶ˆäº†è¾“å…¥');
                return;
            }
        }

        console.log(`è®¾ç½®è‡ªå®šä¹‰äººè®¾: "${customText}"`);

        // 1. å¼ºåˆ¶è®¾ç½®localStorage
        localStorage.setItem(`${extensionName}-personality-type`, 'custom');
        localStorage.setItem(`${extensionName}-custom-personality`, customText);

        // 2. æ›´æ–°petData
        petData.personality = customText;

        // 3. ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
        savePetData();

        // 4. éªŒè¯è®¾ç½®ç»“æœ
        const verifyType = localStorage.getItem(`${extensionName}-personality-type`);
        const verifyCustom = localStorage.getItem(`${extensionName}-custom-personality`);
        const verifyPetData = petData.personality;
        const verifyCurrent = getCurrentPersonality();

        console.log('\nâœ… è®¾ç½®ç»“æœéªŒè¯:');
        console.log(`localStorageäººè®¾ç±»å‹: "${verifyType}"`);
        console.log(`localStorageè‡ªå®šä¹‰äººè®¾: "${verifyCustom}"`);
        console.log(`petData.personality: "${verifyPetData}"`);
        console.log(`getCurrentPersonality(): "${verifyCurrent}"`);

        const success = verifyType === 'custom' &&
                       verifyCustom === customText &&
                       verifyPetData === customText &&
                       verifyCurrent === customText;

        if (success) {
            console.log('âœ… è‡ªå®šä¹‰äººè®¾ä¿®å¤æˆåŠŸï¼');
            toastr.success('ğŸ­ è‡ªå®šä¹‰äººè®¾å·²ä¿®å¤ï¼ç°åœ¨åº”è¯¥ä¸ä¼šä¸¢å¤±äº†ã€‚');

            // æ›´æ–°è®¾ç½®ç•Œé¢ï¼ˆå¦‚æœæ‰“å¼€çš„è¯ï¼‰
            if ($("#virtual-pet-personality-select").length > 0) {
                $("#virtual-pet-personality-select").val('custom');
                $("#virtual-pet-custom-personality").val(customText);
                toggleCustomPersonalityInput(true);
            }
        } else {
            console.log('âŒ è‡ªå®šä¹‰äººè®¾ä¿®å¤å¤±è´¥ï¼');
            toastr.error('âŒ è‡ªå®šä¹‰äººè®¾ä¿®å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
        }

        console.log('\nğŸ’¡ é˜²æ­¢ä¸¢å¤±çš„å»ºè®®:');
        console.log('1. å®šæœŸè¿è¡Œ testPersonalitySave() æ£€æŸ¥çŠ¶æ€');
        console.log('2. å¦‚æœå‘ç°ä¸¢å¤±ï¼Œç«‹å³è¿è¡Œ fixPersonalityLoss()');
        console.log('3. é¿å…æ¸…é™¤æµè§ˆå™¨æ•°æ®');
        console.log('4. å®šæœŸå¤‡ä»½é‡è¦çš„è‡ªå®šä¹‰äººè®¾');

        return {
            success: success,
            customText: customText,
            localStorage: {
                type: verifyType,
                custom: verifyCustom
            },
            petData: verifyPetData,
            current: verifyCurrent,
            timestamp: new Date().toISOString()
        };
    };

    // æ£€æŸ¥æ•°å€¼å¢å‡é€»è¾‘
    window.checkValueChanges = function() {
        console.log('=== ğŸ” æ•°å€¼å¢å‡é€»è¾‘æ£€æŸ¥ ===');

        // è®°å½•åˆå§‹çŠ¶æ€
        const initialState = {
            health: petData.health,
            happiness: petData.happiness,
            hunger: petData.hunger,
            energy: petData.energy,
            level: petData.level,
            experience: petData.experience
        };

        console.log('\nğŸ“Š åˆå§‹çŠ¶æ€:');
        console.log(`å¥åº·: ${Math.round(initialState.health)}/100`);
        console.log(`å¿«ä¹: ${Math.round(initialState.happiness)}/100`);
        console.log(`é¥±é£Ÿ: ${Math.round(initialState.hunger)}/100`);
        console.log(`ç²¾åŠ›: ${Math.round(initialState.energy)}/100`);
        console.log(`ç­‰çº§: ${initialState.level}, ç»éªŒ: ${initialState.experience}`);

        // 1. æ£€æŸ¥å–‚é£Ÿæ•ˆæœ
        console.log('\nğŸ– 1. æµ‹è¯•å–‚é£Ÿæ•ˆæœ:');
        console.log('é¢„æœŸæ•ˆæœ: é¥±é£Ÿ+15, å¿«ä¹+5, ç»éªŒ+3');

        const beforeFeed = { ...petData };
        petData.hunger = Math.min(100, petData.hunger + 15);
        petData.happiness = Math.min(100, petData.happiness + 5);
        petData.experience += 3;

        console.log(`å®é™…æ•ˆæœ: é¥±é£Ÿ+${Math.round(petData.hunger - beforeFeed.hunger)}, å¿«ä¹+${Math.round(petData.happiness - beforeFeed.happiness)}, ç»éªŒ+${petData.experience - beforeFeed.experience}`);

        // æ£€æŸ¥ä¸Šé™
        if (petData.hunger > 100) console.log('âŒ é¥±é£Ÿåº¦è¶…è¿‡ä¸Šé™');
        if (petData.happiness > 100) console.log('âŒ å¿«ä¹åº¦è¶…è¿‡ä¸Šé™');

        // 2. æ£€æŸ¥ç©è€æ•ˆæœ
        console.log('\nğŸ® 2. æµ‹è¯•ç©è€æ•ˆæœ:');
        console.log('é¢„æœŸæ•ˆæœ: å¿«ä¹+12, ç²¾åŠ›-8, ç»éªŒ+4');

        const beforePlay = { ...petData };
        petData.happiness = Math.min(100, petData.happiness + 12);
        petData.energy = Math.max(0, petData.energy - 8);
        petData.experience += 4;

        console.log(`å®é™…æ•ˆæœ: å¿«ä¹+${Math.round(petData.happiness - beforePlay.happiness)}, ç²¾åŠ›${Math.round(petData.energy - beforePlay.energy)}, ç»éªŒ+${petData.experience - beforePlay.experience}`);

        // æ£€æŸ¥è¾¹ç•Œ
        if (petData.happiness > 100) console.log('âŒ å¿«ä¹åº¦è¶…è¿‡ä¸Šé™');
        if (petData.energy < 0) console.log('âŒ ç²¾åŠ›ä½äºä¸‹é™');

        // 3. æ£€æŸ¥ç¡è§‰æ•ˆæœ
        console.log('\nğŸ˜´ 3. æµ‹è¯•ç¡è§‰æ•ˆæœ:');
        console.log('é¢„æœŸæ•ˆæœ: ç²¾åŠ›+20, å¥åº·+5, ç»éªŒ+2');

        const beforeSleep = { ...petData };
        petData.energy = Math.min(100, petData.energy + 20);
        petData.health = Math.min(100, petData.health + 5);
        petData.experience += 2;

        console.log(`å®é™…æ•ˆæœ: ç²¾åŠ›+${Math.round(petData.energy - beforeSleep.energy)}, å¥åº·+${Math.round(petData.health - beforeSleep.health)}, ç»éªŒ+${petData.experience - beforeSleep.experience}`);

        // æ£€æŸ¥ä¸Šé™
        if (petData.energy > 100) console.log('âŒ ç²¾åŠ›è¶…è¿‡ä¸Šé™');
        if (petData.health > 100) console.log('âŒ å¥åº·è¶…è¿‡ä¸Šé™');

        // 4. æ£€æŸ¥æ—¶é—´è¡°å‡
        console.log('\nâ° 4. æµ‹è¯•æ—¶é—´è¡°å‡æ•ˆæœ:');
        console.log('æ¨¡æ‹Ÿ1å°æ—¶æ—¶é—´æµé€...');

        const beforeDecay = { ...petData };
        const hoursElapsed = 1;

        // æ¨¡æ‹Ÿè¡°å‡é€»è¾‘
        const hungerDecay = hoursElapsed * 0.8;
        const energyDecay = hoursElapsed * 0.6;

        petData.hunger = Math.max(0, petData.hunger - hungerDecay);
        petData.energy = Math.max(0, petData.energy - energyDecay);

        // æ£€æŸ¥ä½å€¼å½±å“
        let healthDecay = 0, happinessDecay = 0;
        if (petData.hunger < 20) {
            healthDecay = hoursElapsed * 1;
            happinessDecay = hoursElapsed * 0.8;
            petData.health = Math.max(0, petData.health - healthDecay);
            petData.happiness = Math.max(0, petData.happiness - happinessDecay);
        }

        if (petData.energy < 20) {
            const energyHappinessDecay = hoursElapsed * 0.5;
            petData.happiness = Math.max(0, petData.happiness - energyHappinessDecay);
            happinessDecay += energyHappinessDecay;
        }

        console.log(`é¥±é£Ÿè¡°å‡: -${Math.round(hungerDecay)} (${Math.round(beforeDecay.hunger)} â†’ ${Math.round(petData.hunger)})`);
        console.log(`ç²¾åŠ›è¡°å‡: -${Math.round(energyDecay)} (${Math.round(beforeDecay.energy)} â†’ ${Math.round(petData.energy)})`);
        if (healthDecay > 0) console.log(`å¥åº·è¡°å‡: -${Math.round(healthDecay)} (é¥¥é¥¿å½±å“)`);
        if (happinessDecay > 0) console.log(`å¿«ä¹è¡°å‡: -${Math.round(happinessDecay)} (é¥¥é¥¿/ç–²åŠ³å½±å“)`);

        // 5. æ£€æŸ¥å‡çº§é€»è¾‘
        console.log('\nğŸ†™ 5. æµ‹è¯•å‡çº§é€»è¾‘:');
        const currentLevel = petData.level;
        const currentExp = petData.experience;
        const expNeeded = currentLevel * 100;

        console.log(`å½“å‰ç­‰çº§: ${currentLevel}, ç»éªŒ: ${currentExp}/${expNeeded}`);

        if (currentExp >= expNeeded) {
            console.log('âœ… ç»éªŒè¶³å¤Ÿï¼Œåº”è¯¥å‡çº§');
            const newLevel = currentLevel + 1;
            const remainingExp = currentExp - expNeeded;
            const healthBonus = 30;

            console.log(`å‡çº§å: ç­‰çº§${newLevel}, å‰©ä½™ç»éªŒ${remainingExp}, å¥åº·+${healthBonus}`);

            // æ¨¡æ‹Ÿå‡çº§
            petData.level = newLevel;
            petData.experience = remainingExp;
            petData.health = Math.min(100, petData.health + healthBonus);
        } else {
            console.log(`âœ… ç»éªŒä¸è¶³ï¼Œè¿˜éœ€è¦ ${expNeeded - currentExp} ç»éªŒå‡çº§`);
        }

        // 6. æ•°å€¼è¾¹ç•Œæ£€æŸ¥
        console.log('\nğŸ¯ 6. æ•°å€¼è¾¹ç•Œæ£€æŸ¥:');
        const checkBounds = (name, value, min = 0, max = 100) => {
            if (value < min) {
                console.log(`âŒ ${name} ä½äºä¸‹é™: ${value} < ${min}`);
                return false;
            }
            if (value > max) {
                console.log(`âŒ ${name} è¶…è¿‡ä¸Šé™: ${value} > ${max}`);
                return false;
            }
            console.log(`âœ… ${name} åœ¨æ­£å¸¸èŒƒå›´: ${Math.round(value)}`);
            return true;
        };

        const allValid = [
            checkBounds('å¥åº·', petData.health),
            checkBounds('å¿«ä¹', petData.happiness),
            checkBounds('é¥±é£Ÿ', petData.hunger),
            checkBounds('ç²¾åŠ›', petData.energy),
            checkBounds('ç­‰çº§', petData.level, 1, 999),
            checkBounds('ç»éªŒ', petData.experience, 0, 99999)
        ].every(v => v);

        // 7. æ€»ç»“
        console.log('\nğŸ“‹ 7. æ•°å€¼å˜åŒ–æ€»ç»“:');
        const finalState = {
            health: petData.health,
            happiness: petData.happiness,
            hunger: petData.hunger,
            energy: petData.energy,
            level: petData.level,
            experience: petData.experience
        };

        console.log('æœ€ç»ˆçŠ¶æ€:');
        Object.keys(finalState).forEach(key => {
            const initial = initialState[key];
            const final = finalState[key];
            const change = final - initial;
            const changeStr = change > 0 ? `+${Math.round(change)}` : `${Math.round(change)}`;
            console.log(`  ${key}: ${Math.round(initial)} â†’ ${Math.round(final)} (${changeStr})`);
        });

        // æ¢å¤åˆå§‹çŠ¶æ€
        Object.assign(petData, initialState);

        if (allValid) {
            console.log('\nğŸ‰ æ•°å€¼å¢å‡é€»è¾‘æ£€æŸ¥é€šè¿‡ï¼');
        } else {
            console.log('\nâš ï¸ å‘ç°æ•°å€¼è¾¹ç•Œé—®é¢˜ï¼Œè¯·æ£€æŸ¥ç›¸å…³é€»è¾‘');
        }

        return {
            initialState,
            finalState,
            valid: allValid,
            timestamp: new Date().toISOString()
        };
    }

    // æ‹“éº»æ­Œå­å¼ç”Ÿå‘½é˜¶æ®µå®šä¹‰
    const LIFE_STAGES = {
        baby: { name: "å¹¼ä½“", duration: 24, emoji: "ğŸ¥š" },      // 24å°æ—¶
        child: { name: "å„¿ç«¥", duration: 48, emoji: "ğŸ£" },     // 48å°æ—¶
        teen: { name: "å°‘å¹´", duration: 72, emoji: "ğŸ¤" },      // 72å°æ—¶
        adult: { name: "æˆå¹´", duration: 120, emoji: "ğŸ¦" },    // 120å°æ—¶
        senior: { name: "è€å¹´", duration: 48, emoji: "ğŸ¦…" }     // 48å°æ—¶åæ­»äº¡
    };

    // å•†åº—ç‰©å“å®šä¹‰
    const SHOP_ITEMS = {
        // é£Ÿç‰©ç±»
        basic_food: {
            name: "åŸºç¡€é£Ÿç‰©",
            emoji: "ğŸ",
            price: 10,
            category: "food",
            description: "æ™®é€šçš„é£Ÿç‰©ï¼Œæ¢å¤é¥±é£Ÿåº¦",
            effect: { hunger: 15, happiness: 2 }
        },
        premium_food: {
            name: "é«˜çº§é£Ÿç‰©",
            emoji: "ğŸ–",
            price: 25,
            category: "food",
            description: "è¥å…»ä¸°å¯Œçš„é£Ÿç‰©ï¼Œæ¢å¤é¥±é£Ÿåº¦å’Œå¥åº·",
            effect: { hunger: 25, happiness: 5, health: 5 }
        },
        special_treat: {
            name: "ç‰¹æ®Šé›¶é£Ÿ",
            emoji: "ğŸ°",
            price: 40,
            category: "food",
            description: "ç¾å‘³çš„é›¶é£Ÿï¼Œå¤§å¹…æå‡å¿«ä¹åº¦",
            effect: { hunger: 10, happiness: 20 }
        },

        // è¯å“ç±»
        medicine: {
            name: "æ„Ÿå†’è¯",
            emoji: "ğŸ’Š",
            price: 30,
            category: "medicine",
            description: "æ²»ç–—è½»å¾®ç–¾ç—…",
            effect: { sickness: -20, health: 10 }
        },
        super_medicine: {
            name: "ç‰¹æ•ˆè¯",
            emoji: "ğŸ’‰",
            price: 80,
            category: "medicine",
            description: "æ²»ç–—ä¸¥é‡ç–¾ç—…ï¼Œå®Œå…¨æ¢å¤å¥åº·",
            effect: { sickness: -50, health: 30 }
        },

        // ç©å…·ç±»
        ball: {
            name: "å°çƒ",
            emoji: "âš½",
            price: 20,
            category: "toy",
            description: "ç®€å•çš„ç©å…·ï¼Œæå‡å¿«ä¹åº¦å’Œçºªå¾‹",
            effect: { happiness: 10, discipline: 5, energy: -5 }
        },
        robot_toy: {
            name: "æœºå™¨äººç©å…·",
            emoji: "ğŸ¤–",
            price: 60,
            category: "toy",
            description: "é«˜ç§‘æŠ€ç©å…·ï¼Œå¤§å¹…æå‡çºªå¾‹å’Œå¿«ä¹",
            effect: { happiness: 15, discipline: 15, energy: -3 }
        },

        // ç‰¹æ®Šé“å…·ç±»
        time_capsule: {
            name: "æ—¶é—´èƒ¶å›Š",
            emoji: "â°",
            price: 100,
            category: "special",
            description: "æš‚åœæ—¶é—´æµé€2å°æ—¶ï¼Œç´§æ€¥æ—¶ä½¿ç”¨",
            effect: { timeFreeze: 2 }
        },
        revival_stone: {
            name: "å¤æ´»çŸ³",
            emoji: "ğŸ’",
            price: 200,
            category: "special",
            description: "æ­»äº¡åå¯ä»¥å¤æ´»å® ç‰©ï¼Œä½†ä¼šé™ä½æœ€å¤§å¥åº·å€¼",
            effect: { revive: true, healthPenalty: 20 }
        },
        energy_drink: {
            name: "èƒ½é‡é¥®æ–™",
            emoji: "ğŸ¥¤",
            price: 35,
            category: "special",
            description: "å¿«é€Ÿæ¢å¤ç²¾åŠ›ï¼Œä½†ä¼šå¢åŠ ç–¾ç—…é£é™©",
            effect: { energy: 30, sickness: 5 }
        },

        // è£…é¥°ç±»
        hat: {
            name: "å°å¸½å­",
            emoji: "ğŸ©",
            price: 50,
            category: "decoration",
            description: "å¯çˆ±çš„è£…é¥°ï¼ŒæŒç»­æå‡å¿«ä¹åº¦",
            effect: { happinessBonus: 2 }
        },
        bow_tie: {
            name: "è´è¶ç»“",
            emoji: "ğŸ€",
            price: 45,
            category: "decoration",
            description: "ä¼˜é›…çš„è£…é¥°ï¼Œæå‡çºªå¾‹å€¼",
            effect: { disciplineBonus: 3 }
        }
    };

    // åº”ç”¨æ‹“éº»æ­Œå­å¼ç³»ç»Ÿï¼ˆå†…éƒ¨ä½¿ç”¨ï¼Œè‡ªåŠ¨è°ƒç”¨ï¼‰
    function applyTamagotchiSystem() {
        console.log('ğŸ¥š åº”ç”¨æ‹“éº»æ­Œå­å¼ç³»ç»Ÿ...');

        // é‡æ–°å®šä¹‰æ›´æ–°çŠ¶æ€å‡½æ•° - æ‹“éº»æ­Œå­å¼
        window.updatePetStatus = function() {
            if (!petData.isAlive) return; // æ­»äº¡åä¸å†æ›´æ–°

            const now = Date.now();
            const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
            const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);

            // æ‹“éº»æ­Œå­å¼ï¼šä¸é™åˆ¶æœ€å¤§æ—¶é—´å·®ï¼ŒçœŸå®æ—¶é—´æµé€
            if (hoursElapsed > 0.1) { // æ¯6åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡

                // 1. å¹´é¾„å¢é•¿
                petData.age += hoursElapsed;

                // 2. ç”Ÿå‘½é˜¶æ®µæ£€æŸ¥
                checkLifeStageProgression();

                // 3. æ‹“éº»æ­Œå­å¼è¡°å‡ï¼ˆè°ƒæ•´ä¸ºåˆç†é€Ÿåº¦ï¼‰
                petData.hunger = Math.max(0, petData.hunger - hoursElapsed * 1.2);    // æ¯å°æ—¶-1.2
                petData.energy = Math.max(0, petData.energy - hoursElapsed * 1.0);    // æ¯å°æ—¶-1.0
                petData.happiness = Math.max(0, petData.happiness - hoursElapsed * 0.8); // æ¯å°æ—¶-0.8

                // 4. å¥åº·çŠ¶å†µæ£€æŸ¥
                checkHealthConditions(hoursElapsed);

                // 5. æ­»äº¡æ£€æŸ¥
                checkDeathConditions();

                petData.lastUpdateTime = now;
                validateAndFixValues();
                savePetData();
                checkAndSendNotifications();
            }
        };

        // é‡æ–°å®šä¹‰å–‚é£Ÿå‡½æ•° - æ‹“éº»æ­Œå­å¼
        window.feedPet = async function() {
            if (!petData.isAlive) {
                toastr.error("ğŸ’€ ä½ çš„å® ç‰©å·²ç»æ­»äº¡ï¼Œæ— æ³•å–‚é£Ÿ...");
                return;
            }

            const now = Date.now();
            const timeSinceLastFeed = now - petData.lastFeedTime;

            if (timeSinceLastFeed < 30000) { // 30ç§’å†·å´
                toastr.warning("å® ç‰©è¿˜ä¸é¥¿ï¼Œç­‰ä¸€ä¼šå†å–‚å§ï¼");
                return;
            }

            // æ‹“éº»æ­Œå­å¼å–‚é£Ÿæ•ˆæœ
            petData.hunger = Math.min(100, petData.hunger + 20);
            petData.happiness = Math.min(100, petData.happiness + 5);
            petData.weight += 1; // ä½“é‡å¢åŠ 
            petData.lastFeedTime = now;
            petData.lastCareTime = now;
            petData.careNeglectCount = Math.max(0, petData.careNeglectCount - 1);

            // è¿‡åº¦å–‚é£Ÿæ£€æŸ¥
            if (petData.weight > 50) {
                petData.sickness = Math.min(100, petData.sickness + 10);
                toastr.warning("âš ï¸ å® ç‰©åƒå¾—å¤ªå¤šäº†ï¼Œå¯èƒ½ä¼šç”Ÿç—…ï¼");
            }

            validateAndFixValues();

            // å®šä¹‰å¥–åŠ±
            const rewards = { coins: 3, experience: 2 };

            // åº”ç”¨å¥–åŠ±
            gainExperience(rewards.experience);
            gainCoins(rewards.coins);

            // AIå›å¤æ—¶ä¼ é€’å¥–åŠ±ä¿¡æ¯ï¼Œç”¨äºç‹¬ç«‹æ˜¾ç¤º
            await handleAIReply('feed', `${petData.name} åƒå¾—å¾ˆå¼€å¿ƒï¼`, rewards);
            savePetData();
            renderPetStatus();
        };

        // é‡æ–°å®šä¹‰ç©è€å‡½æ•° - æ‹“éº»æ­Œå­å¼
        window.playWithPet = async function() {
            if (!petData.isAlive) {
                toastr.error("ğŸ’€ ä½ çš„å® ç‰©å·²ç»æ­»äº¡ï¼Œæ— æ³•ç©è€...");
                return;
            }

            const now = Date.now();
            const timeSinceLastPlay = now - petData.lastPlayTime;

            if (timeSinceLastPlay < 45000) { // 45ç§’å†·å´
                toastr.warning("å® ç‰©éœ€è¦ä¼‘æ¯ä¸€ä¸‹ï¼");
                return;
            }

            // æ‹“éº»æ­Œå­å¼ç©è€æ•ˆæœ
            petData.happiness = Math.min(100, petData.happiness + 15);
            petData.energy = Math.max(0, petData.energy - 10);
            petData.discipline = Math.min(100, petData.discipline + 5);
            petData.weight = Math.max(10, petData.weight - 1); // è¿åŠ¨å‡é‡
            petData.lastPlayTime = now;
            petData.lastCareTime = now;
            petData.careNeglectCount = Math.max(0, petData.careNeglectCount - 1);

            validateAndFixValues();

            // å®šä¹‰å¥–åŠ±
            const rewards = { coins: 5, experience: 3 };

            // åº”ç”¨å¥–åŠ±
            gainExperience(rewards.experience);
            gainCoins(rewards.coins);

            // AIå›å¤æ—¶ä¼ é€’å¥–åŠ±ä¿¡æ¯ï¼Œç”¨äºç‹¬ç«‹æ˜¾ç¤º
            await handleAIReply('play', `${petData.name} ç©å¾—å¾ˆå¼€å¿ƒï¼`, rewards);
            savePetData();
            renderPetStatus();
        };

        // é‡æ–°å®šä¹‰ç¡è§‰å‡½æ•° - æ‹“éº»æ­Œå­å¼
        window.petSleep = async function() {
            if (!petData.isAlive) {
                toastr.error("ğŸ’€ ä½ çš„å® ç‰©å·²ç»æ­»äº¡ï¼Œæ— æ³•ä¼‘æ¯...");
                return;
            }

            const now = Date.now();
            const timeSinceLastSleep = now - petData.lastSleepTime;

            if (timeSinceLastSleep < 120000) { // 2åˆ†é’Ÿå†·å´
                toastr.warning("å® ç‰©è¿˜ä¸å›°ï¼");
                return;
            }

            // æ‹“éº»æ­Œå­å¼ç¡è§‰æ•ˆæœ
            petData.energy = Math.min(100, petData.energy + 25);
            petData.health = Math.min(100, petData.health + 10);
            petData.sickness = Math.max(0, petData.sickness - 5); // ç¡è§‰æœ‰åŠ©äºåº·å¤
            petData.lastSleepTime = now;
            petData.lastCareTime = now;

            validateAndFixValues();

            // å®šä¹‰å¥–åŠ±
            const rewards = { coins: 2, experience: 1 };

            // åº”ç”¨å¥–åŠ±
            gainExperience(rewards.experience);
            gainCoins(rewards.coins);

            // AIå›å¤æ—¶ä¼ é€’å¥–åŠ±ä¿¡æ¯ï¼Œç”¨äºç‹¬ç«‹æ˜¾ç¤º
            await handleAIReply('sleep', `${petData.name} ç¡å¾—å¾ˆé¦™ï¼`, rewards);
            savePetData();
            renderPetStatus();
        };

        // æŠ±æŠ±å® ç‰© - æ–°çš„äº’åŠ¨æ–¹å¼
        window.hugPet = async function() {
            if (!petData.isAlive) {
                toastr.error("ğŸ’€ ä½ çš„å® ç‰©å·²ç»æ­»äº¡ï¼Œæ— æ³•æŠ±æŠ±...");
                return;
            }

            const now = Date.now();
            const timeSinceLastHug = now - (petData.lastHugTime || 0);

            if (timeSinceLastHug < 25000) { // 25ç§’å†·å´
                const remainingTime = Math.ceil((25000 - timeSinceLastHug) / 1000);
                toastr.warning(`å® ç‰©è¿˜åœ¨å›å‘³åˆšæ‰çš„æ‹¥æŠ±ï¼Œ${remainingTime}ç§’åå†è¯•å§ï¼`);
                return;
            }

            try {
                // æ‹“éº»æ­Œå­å¼æŠ±æŠ±æ•ˆæœ
                petData.happiness = Math.min(100, petData.happiness + 10);
                petData.health = Math.min(100, petData.health + 3);
                petData.discipline = Math.min(100, (petData.discipline || 50) + 2); // å¢åŠ çºªå¾‹æ€§
                petData.lastHugTime = now;
                petData.lastCareTime = now;
                petData.careNeglectCount = Math.max(0, (petData.careNeglectCount || 0) - 1);

                // ç‰¹æ®Šæ•ˆæœï¼šæŠ±æŠ±èƒ½å‡å°‘ç–¾ç—…
                if (petData.sickness > 0) {
                    petData.sickness = Math.max(0, petData.sickness - 3);
                    toastr.info("ğŸ’• æ¸©æš–çš„æ‹¥æŠ±è®©å® ç‰©æ„Ÿè§‰å¥½äº†ä¸€äº›ï¼");
                }

                validateAndFixValues();

                // å®šä¹‰å¥–åŠ±
                const rewards = { coins: 2, experience: 1 };

                // åº”ç”¨å¥–åŠ±
                gainExperience(rewards.experience);
                gainCoins(rewards.coins);

                // AIå›å¤æ—¶ä¼ é€’å¥–åŠ±ä¿¡æ¯ï¼Œç”¨äºç‹¬ç«‹æ˜¾ç¤º
                await handleAIReply('hug', `${petData.name} äº«å—ç€æ¸©æš–çš„æ‹¥æŠ±ï¼`, rewards);
                savePetData();
                renderPetStatus();

                // å¼ºåˆ¶æ›´æ–°UIæ˜¾ç¤º
                setTimeout(() => {
                    if (typeof updateUnifiedUIStatus === 'function') {
                        updateUnifiedUIStatus();
                    }
                }, 100);

            } catch (error) {
                console.error('æŠ±æŠ±å® ç‰©æ—¶å‘ç”Ÿé”™è¯¯:', error);
                toastr.error("æŠ±æŠ±æ—¶å‡ºç°äº†é—®é¢˜...");
            }
        };

        // æ·»åŠ æ²»ç–—åŠŸèƒ½
        window.healPet = async function() {
            if (!petData.isAlive) {
                toastr.error("ğŸ’€ ä½ çš„å® ç‰©å·²ç»æ­»äº¡ï¼Œæ— æ³•æ²»ç–—...");
                return;
            }

            const sicknessLevel = petData.sickness || 0;

            if (sicknessLevel < 10) {
                // æ²¡ç”Ÿç—…æ—¶çš„åé¦ˆ
                const healthyMessages = [
                    "ğŸ˜Š ä½ çš„å® ç‰©å¾ˆå¥åº·ï¼Œä¸éœ€è¦æ²»ç–—ï¼",
                    "ğŸŒŸ å® ç‰©çŠ¶æ€è‰¯å¥½ï¼Œæ— éœ€ç”¨è¯ï¼",
                    "ğŸ’ª ä½ çš„å® ç‰©ç²¾ç¥é¥±æ»¡ï¼Œä¸ç”¨æ‹…å¿ƒï¼",
                    "âœ¨ å® ç‰©å¥åº·æŒ‡æ•°æ­£å¸¸ï¼Œæš‚æ—¶ä¸éœ€è¦æ²»ç–—ï¼"
                ];
                const randomMessage = healthyMessages[Math.floor(Math.random() * healthyMessages.length)];
                toastr.info(randomMessage);

                // æ’­æ”¾æ— æ•ˆç‚¹å‡»çš„è§†è§‰åé¦ˆ
                const healBtn = $('.heal-btn');
                if (healBtn.length > 0) {
                    healBtn.css('transform', 'scale(0.95)');
                    setTimeout(() => {
                        healBtn.css('transform', 'scale(1)');
                    }, 150);
                }
                return;
            }

            // æ²»ç–—æ•ˆæœ
            const healAmount = Math.min(30, sicknessLevel); // å®é™…æ²»ç–—é‡
            petData.sickness = Math.max(0, sicknessLevel - healAmount);
            petData.health = Math.min(100, petData.health + 15);
            petData.sicknessDuration = 0;
            petData.lastCareTime = Date.now();

            validateAndFixValues();

            // æ²»ç–—æˆåŠŸçš„åé¦ˆ
            toastr.success(`ğŸ’Š æ²»ç–—æˆåŠŸï¼ç–¾ç—…å€¼é™ä½äº† ${healAmount} ç‚¹`);
            await handleAIReply('heal', `${petData.name} æ¥å—äº†æ²»ç–—ï¼Œæ„Ÿè§‰å¥½å¤šäº†ï¼`);
            savePetData();
            renderPetStatus();
        };

        // æ·»åŠ å•†åº—åŠŸèƒ½
        window.openShop = function() {
            if (!petData.isAlive) {
                toastr.error("ğŸ’€ ä½ çš„å® ç‰©å·²ç»æ­»äº¡ï¼Œæ— æ³•ä½¿ç”¨å•†åº—...");
                return;
            }

            showShopModal();
        };

        console.log('âœ… æ‹“éº»æ­Œå­å¼ç³»ç»Ÿå·²åº”ç”¨ï¼');
    }

    // æ£€æŸ¥ç”Ÿå‘½é˜¶æ®µè¿›å±•
    function checkLifeStageProgression() {
        const currentStage = LIFE_STAGES[petData.lifeStage];
        if (!currentStage) return;

        if (petData.age >= currentStage.duration) {
            const stages = Object.keys(LIFE_STAGES);
            const currentIndex = stages.indexOf(petData.lifeStage);

            if (currentIndex < stages.length - 1) {
                // è¿›åŒ–åˆ°ä¸‹ä¸€é˜¶æ®µ
                const nextStage = stages[currentIndex + 1];
                petData.lifeStage = nextStage;
                petData.age = 0; // é‡ç½®å¹´é¾„è®¡æ•°

                const nextStageInfo = LIFE_STAGES[nextStage];
                toastr.success(`ğŸ‰ ${petData.name} è¿›åŒ–äº†ï¼ç°åœ¨æ˜¯${nextStageInfo.name}é˜¶æ®µ ${nextStageInfo.emoji}`);

                // è¿›åŒ–æ—¶æ¢å¤ä¸€äº›çŠ¶æ€
                petData.health = Math.min(100, petData.health + 20);
                petData.happiness = Math.min(100, petData.happiness + 15);
            } else if (petData.lifeStage === 'senior') {
                // è€å¹´é˜¶æ®µç»“æŸï¼Œè‡ªç„¶æ­»äº¡
                petData.isAlive = false;
                petData.deathReason = "natural";
                toastr.error("ğŸ˜¢ " + petData.name + " å› ä¸ºå¹´è€è€Œå®‰è¯¦åœ°ç¦»å¼€äº†...");
            }
        }
    }

    // æ£€æŸ¥å¥åº·çŠ¶å†µ
    function checkHealthConditions(hoursElapsed) {
        // é¥¥é¥¿å½±å“å¥åº·
        if (petData.hunger < 20) {
            petData.health = Math.max(0, petData.health - hoursElapsed * 2);
            petData.sickness = Math.min(100, petData.sickness + hoursElapsed * 1.5);
        }

        // ç–²åŠ³å½±å“å¥åº·
        if (petData.energy < 20) {
            petData.health = Math.max(0, petData.health - hoursElapsed * 1);
            petData.happiness = Math.max(0, petData.happiness - hoursElapsed * 1.5);
        }

        // ä¸å¿«ä¹å½±å“å¥åº·
        if (petData.happiness < 20) {
            petData.health = Math.max(0, petData.health - hoursElapsed * 0.5);
            petData.sickness = Math.min(100, petData.sickness + hoursElapsed * 0.5);
        }

        // ç”Ÿç—…æŒç»­æ—¶é—´
        if (petData.sickness > 50) {
            petData.sicknessDuration += hoursElapsed;
            if (petData.sicknessDuration > 24) { // ç”Ÿç—…è¶…è¿‡24å°æ—¶
                petData.health = Math.max(0, petData.health - hoursElapsed * 3);
            }
        } else {
            petData.sicknessDuration = 0;
        }

        // å¿½è§†ç…§é¡¾è®¡æ•°
        const timeSinceLastCare = Date.now() - petData.lastCareTime;
        if (timeSinceLastCare > 4 * 60 * 60 * 1000) { // 4å°æ—¶æ²¡æœ‰ç…§é¡¾
            petData.careNeglectCount++;
            petData.lastCareTime = Date.now(); // é‡ç½®è®¡æ—¶å™¨
        }
    }

    // æ£€æŸ¥æ­»äº¡æ¡ä»¶
    function checkDeathConditions() {
        if (!petData.isAlive) return;

        let deathReason = null;

        // å¥åº·å€¼å½’é›¶
        if (petData.health <= 0) {
            deathReason = "sickness";
        }
        // é•¿æœŸå¿½è§†ç…§é¡¾
        else if (petData.careNeglectCount >= 6) { // 6æ¬¡å¿½è§†ï¼ˆ24å°æ—¶ï¼‰
            deathReason = "neglect";
        }
        // ä¸¥é‡ç–¾ç—…
        else if (petData.sickness >= 100 && petData.sicknessDuration > 48) {
            deathReason = "disease";
        }

        if (deathReason) {
            petData.isAlive = false;
            petData.deathReason = deathReason;

            const deathMessages = {
                sickness: "ğŸ˜¢ " + petData.name + " å› ä¸ºå¥åº·çŠ¶å†µæ¶åŒ–è€Œæ­»äº¡äº†...",
                neglect: "ğŸ’” " + petData.name + " å› ä¸ºé•¿æœŸç¼ºä¹ç…§é¡¾è€Œæ­»äº¡äº†...",
                disease: "ğŸ¦  " + petData.name + " å› ä¸ºä¸¥é‡ç–¾ç—…è€Œæ­»äº¡äº†...",
                natural: "ğŸ˜‡ " + petData.name + " å› ä¸ºå¹´è€è€Œå®‰è¯¦åœ°ç¦»å¼€äº†..."
            };

            toastr.error(deathMessages[deathReason], '', { timeOut: 10000 });

            // æ˜¾ç¤ºå¤æ´»é€‰é¡¹
            setTimeout(() => {
                if (confirm("ğŸ’€ ä½ çš„å® ç‰©æ­»äº¡äº†ï¼\n\næ˜¯å¦è¦é‡æ–°å¼€å§‹å…»è‚²æ–°çš„å® ç‰©ï¼Ÿ\nï¼ˆç‚¹å‡»ç¡®å®šé‡æ–°å¼€å§‹ï¼Œå–æ¶ˆä¿æŒå½“å‰çŠ¶æ€ï¼‰")) {
                    resetPet();
                }
            }, 3000);
        }
    }



    /**
     * å¼ºåˆ¶åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿï¼ˆç¡®ä¿é‡‘å¸åŠŸèƒ½æ­£å¸¸ï¼‰
     */
    window.forceApplyTamagotchiSystem = function() {
        console.log('ğŸ¥š å¼ºåˆ¶åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿ...');

        // æ›´æ–°æ•°æ®ç‰ˆæœ¬
        petData.dataVersion = 4.0;

        // åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿ
        applyTamagotchiSystem();

        // ä¿å­˜æ•°æ®
        savePetData();

        console.log('âœ… æ‹“éº»æ­Œå­ç³»ç»Ÿå·²å¼ºåˆ¶åº”ç”¨ï¼');
        console.log('ğŸ’° é‡‘å¸åŠŸèƒ½ç°åœ¨åº”è¯¥æ­£å¸¸å·¥ä½œäº†');

        toastr.success('æ‹“éº»æ­Œå­ç³»ç»Ÿå·²åº”ç”¨ï¼é‡‘å¸åŠŸèƒ½å·²å¯ç”¨ï¼', '', { timeOut: 3000 });

        return {
            applied: true,
            dataVersion: petData.dataVersion,
            timestamp: new Date().toISOString()
        };
    };

    /**
     * æµ‹è¯•ä¼˜åŒ–åçš„æç¤ºè¯ï¼ˆä¸åŒ…å«é‡‘å¸ä¿¡æ¯é¿å…æ··æ·†ï¼‰
     */
    window.testCleanPrompt = function(action = 'feed') {
        console.log('ğŸ¯ æµ‹è¯•ä¼˜åŒ–åçš„æç¤ºè¯...');

        console.log(`\nğŸ“Š å½“å‰çŠ¶æ€:`);
        console.log(`- å® ç‰©åç§°: ${petData.name}`);
        console.log(`- å½“å‰é‡‘å¸: ${petData.coins || 100}`);
        console.log(`- æµ‹è¯•è¡Œä¸º: ${action}`);

        const prompt = buildInteractionPrompt(action);

        console.log(`\nğŸ“ ç”Ÿæˆçš„æç¤ºè¯:`);
        console.log(prompt);

        console.log(`\nğŸ” æç¤ºè¯åˆ†æ:`);
        const includesCoins = prompt.includes('é‡‘å¸');
        const includesReward = prompt.includes('å¥–åŠ±');
        const includesGameMechanic = prompt.includes('æ¸¸æˆæœºåˆ¶');
        const hasCleanNote = prompt.includes('ä¸è¦åœ¨å›å¤ä¸­æåŠ');

        console.log(`- åŒ…å«é‡‘å¸ä¿¡æ¯: ${includesCoins ? 'âŒ æ˜¯ï¼ˆåº”è¯¥é¿å…ï¼‰' : 'âœ… å¦'}`);
        console.log(`- åŒ…å«å¥–åŠ±ä¿¡æ¯: ${includesReward ? 'âŒ æ˜¯ï¼ˆåº”è¯¥é¿å…ï¼‰' : 'âœ… å¦'}`);
        console.log(`- åŒ…å«æ¸¸æˆæœºåˆ¶: ${includesGameMechanic ? 'âŒ æ˜¯ï¼ˆåº”è¯¥é¿å…ï¼‰' : 'âœ… å¦'}`);
        console.log(`- æœ‰æ¸…æ™°çš„æ³¨æ„äº‹é¡¹: ${hasCleanNote ? 'âœ… æ˜¯' : 'âŒ å¦'}`);

        if (!includesCoins && !includesReward && hasCleanNote) {
            console.log('âœ… æç¤ºè¯å·²ä¼˜åŒ–ï¼ŒAIä¸ä¼šæ··æ·†é‡‘å¸æ¦‚å¿µï¼');
            toastr.success('æç¤ºè¯å·²ä¼˜åŒ–ï¼ŒAIä¸ä¼šæ··æ·†é‡‘å¸æ¦‚å¿µï¼', 'ğŸ¯ æµ‹è¯•æˆåŠŸ');
        } else {
            console.log('âŒ æç¤ºè¯ä»å¯èƒ½å¯¼è‡´AIæ··æ·†');
            toastr.warning('æç¤ºè¯ä»å¯èƒ½å¯¼è‡´AIæ··æ·†', 'ğŸ¯ æµ‹è¯•å¤±è´¥');
        }

        return {
            prompt: prompt,
            analysis: {
                includesCoins,
                includesReward,
                includesGameMechanic,
                hasCleanNote
            }
        };
    };

    /**
     * è¯Šæ–­é‡‘å¸å’Œç»éªŒå€¼é—®é¢˜
     */
    window.diagnoseRewardSystem = function() {
        console.log('ğŸ” è¯Šæ–­é‡‘å¸å’Œç»éªŒå€¼ç³»ç»Ÿ...');

        console.log('\nğŸ“Š å½“å‰æ•°æ®çŠ¶æ€:');
        console.log(`- æ•°æ®ç‰ˆæœ¬: ${petData.dataVersion}`);
        console.log(`- å½“å‰é‡‘å¸: ${petData.coins}`);
        console.log(`- å½“å‰ç»éªŒ: ${petData.experience}`);
        console.log(`- å½“å‰ç­‰çº§: ${petData.level}`);
        console.log(`- å® ç‰©å­˜æ´»: ${petData.isAlive}`);

        console.log('\nğŸ”§ å‡½æ•°æ£€æŸ¥:');
        console.log(`- gainCoinså‡½æ•°å­˜åœ¨: ${typeof gainCoins === 'function'}`);
        console.log(`- gainExperienceå‡½æ•°å­˜åœ¨: ${typeof gainExperience === 'function'}`);
        console.log(`- feedPetå‡½æ•°å­˜åœ¨: ${typeof window.feedPet === 'function'}`);

        console.log('\nğŸ§ª æµ‹è¯•é‡‘å¸åŠŸèƒ½:');
        const oldCoins = petData.coins || 0;
        console.log(`æµ‹è¯•å‰é‡‘å¸: ${oldCoins}`);

        try {
            gainCoins(10);
            console.log(`æµ‹è¯•åé‡‘å¸: ${petData.coins}`);
            console.log(`é‡‘å¸å¢åŠ : ${(petData.coins || 0) - oldCoins}`);

            if ((petData.coins || 0) - oldCoins === 10) {
                console.log('âœ… gainCoinså‡½æ•°å·¥ä½œæ­£å¸¸');
            } else {
                console.log('âŒ gainCoinså‡½æ•°æœ‰é—®é¢˜');
            }
        } catch (error) {
            console.log(`âŒ gainCoinså‡½æ•°é”™è¯¯: ${error.message}`);
        }

        console.log('\nğŸ§ª æµ‹è¯•ç»éªŒåŠŸèƒ½:');
        const oldExp = petData.experience || 0;
        const oldLevel = petData.level || 1;
        console.log(`æµ‹è¯•å‰ç»éªŒ: ${oldExp}, ç­‰çº§: ${oldLevel}`);

        try {
            gainExperience(5);
            console.log(`æµ‹è¯•åç»éªŒ: ${petData.experience}, ç­‰çº§: ${petData.level}`);
            console.log(`ç»éªŒå¢åŠ : ${(petData.experience || 0) - oldExp}`);

            if ((petData.experience || 0) >= oldExp) {
                console.log('âœ… gainExperienceå‡½æ•°å·¥ä½œæ­£å¸¸');
            } else {
                console.log('âŒ gainExperienceå‡½æ•°æœ‰é—®é¢˜');
            }
        } catch (error) {
            console.log(`âŒ gainExperienceå‡½æ•°é”™è¯¯: ${error.message}`);
        }

        console.log('\nğŸ” äº’åŠ¨å‡½æ•°æ£€æŸ¥:');
        const feedPetString = window.feedPet.toString();
        const hasGainCoins = feedPetString.includes('gainCoins');
        const hasGainExp = feedPetString.includes('gainExperience');

        console.log(`- feedPetåŒ…å«gainCoinsè°ƒç”¨: ${hasGainCoins ? 'âœ…' : 'âŒ'}`);
        console.log(`- feedPetåŒ…å«gainExperienceè°ƒç”¨: ${hasGainExp ? 'âœ…' : 'âŒ'}`);

        if (!hasGainCoins || !hasGainExp) {
            console.log('âŒ äº’åŠ¨å‡½æ•°ç¼ºå°‘å¥–åŠ±è°ƒç”¨ï¼Œéœ€è¦é‡æ–°åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿ');
            console.log('ğŸ’¡ è¿è¡Œ: forceApplyTamagotchiSystem()');
        }

        return {
            dataVersion: petData.dataVersion,
            coins: petData.coins,
            experience: petData.experience,
            level: petData.level,
            isAlive: petData.isAlive,
            functionsExist: {
                gainCoins: typeof gainCoins === 'function',
                gainExperience: typeof gainExperience === 'function',
                feedPet: typeof window.feedPet === 'function'
            },
            feedPetIncludes: {
                gainCoins: hasGainCoins,
                gainExperience: hasGainExp
            }
        };
    };

    /**
     * æ£€æŸ¥å½“å‰ä½¿ç”¨çš„äº’åŠ¨å‡½æ•°ç‰ˆæœ¬
     */
    window.checkInteractionFunctions = function() {
        console.log('ğŸ” æ£€æŸ¥å½“å‰ä½¿ç”¨çš„äº’åŠ¨å‡½æ•°ç‰ˆæœ¬...');

        console.log('\nğŸ“‹ å‡½æ•°æºç åˆ†æ:');

        // æ£€æŸ¥feedPetå‡½æ•°
        const feedPetCode = window.feedPet.toString();
        console.log('\nğŸ– feedPetå‡½æ•°åˆ†æ:');
        console.log(`- åŒ…å«gainCoins: ${feedPetCode.includes('gainCoins') ? 'âœ…' : 'âŒ'}`);
        console.log(`- åŒ…å«gainExperience: ${feedPetCode.includes('gainExperience') ? 'âœ…' : 'âŒ'}`);
        console.log(`- åŒ…å«handleAIReply: ${feedPetCode.includes('handleAIReply') ? 'âœ…' : 'âŒ'}`);
        console.log(`- åŒ…å«æ‹“éº»æ­Œå­ç‰¹å¾(weight): ${feedPetCode.includes('weight') ? 'âœ…' : 'âŒ'}`);
        console.log(`- å†·å´æ—¶é—´: ${feedPetCode.includes('30000') ? '30ç§’(æ‹“éº»æ­Œå­)' : feedPetCode.includes('45000') ? '45ç§’(å¹³è¡¡ç‰ˆ)' : 'æœªçŸ¥'}`);

        // æ£€æŸ¥playWithPetå‡½æ•°
        const playPetCode = window.playWithPet.toString();
        console.log('\nğŸ® playWithPetå‡½æ•°åˆ†æ:');
        console.log(`- åŒ…å«gainCoins: ${playPetCode.includes('gainCoins') ? 'âœ…' : 'âŒ'}`);
        console.log(`- åŒ…å«gainExperience: ${playPetCode.includes('gainExperience') ? 'âœ…' : 'âŒ'}`);
        console.log(`- åŒ…å«handleAIReply: ${playPetCode.includes('handleAIReply') ? 'âœ…' : 'âŒ'}`);
        console.log(`- å†·å´æ—¶é—´: ${playPetCode.includes('45000') ? '45ç§’(æ‹“éº»æ­Œå­)' : playPetCode.includes('60000') ? '60ç§’(å¹³è¡¡ç‰ˆ)' : 'æœªçŸ¥'}`);

        // æ£€æŸ¥petSleepå‡½æ•°
        const sleepCode = window.petSleep.toString();
        console.log('\nğŸ˜´ petSleepå‡½æ•°åˆ†æ:');
        console.log(`- åŒ…å«gainCoins: ${sleepCode.includes('gainCoins') ? 'âœ…' : 'âŒ'}`);
        console.log(`- åŒ…å«gainExperience: ${sleepCode.includes('gainExperience') ? 'âœ…' : 'âŒ'}`);
        console.log(`- åŒ…å«handleAIReply: ${sleepCode.includes('handleAIReply') ? 'âœ…' : 'âŒ'}`);
        console.log(`- å†·å´æ—¶é—´: ${sleepCode.includes('120000') ? '120ç§’(æ‹“éº»æ­Œå­)' : 'æœªçŸ¥'}`);

        // åˆ¤æ–­ç‰ˆæœ¬
        const isTamagotchi = feedPetCode.includes('gainCoins') && feedPetCode.includes('weight');
        const isBalanced = feedPetCode.includes('45000') && !feedPetCode.includes('gainCoins');
        const isOld = !feedPetCode.includes('gainCoins') && !feedPetCode.includes('weight');

        console.log('\nğŸ¯ ç‰ˆæœ¬åˆ¤æ–­:');
        if (isTamagotchi) {
            console.log('âœ… å½“å‰ä½¿ç”¨æ‹“éº»æ­Œå­ç‰ˆæœ¬ - åŒ…å«å®Œæ•´çš„é‡‘å¸å’Œç»éªŒå¥–åŠ±');
        } else if (isBalanced) {
            console.log('âš ï¸ å½“å‰ä½¿ç”¨å¹³è¡¡ç‰ˆæœ¬ - ç¼ºå°‘é‡‘å¸å¥–åŠ±');
        } else if (isOld) {
            console.log('âŒ å½“å‰ä½¿ç”¨æ—§ç‰ˆæœ¬ - ç¼ºå°‘é‡‘å¸å¥–åŠ±');
        } else {
            console.log('â“ æ— æ³•ç¡®å®šç‰ˆæœ¬');
        }

        // æä¾›ä¿®å¤å»ºè®®
        if (!isTamagotchi) {
            console.log('\nğŸ’¡ ä¿®å¤å»ºè®®:');
            console.log('è¿è¡Œä»¥ä¸‹å‘½ä»¤å¼ºåˆ¶åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿ:');
            console.log('forceApplyTamagotchiSystem()');
        }

        return {
            feedPet: {
                hasGainCoins: feedPetCode.includes('gainCoins'),
                hasGainExperience: feedPetCode.includes('gainExperience'),
                hasWeight: feedPetCode.includes('weight'),
                cooldown: feedPetCode.includes('30000') ? 30 : feedPetCode.includes('45000') ? 45 : 'unknown'
            },
            playWithPet: {
                hasGainCoins: playPetCode.includes('gainCoins'),
                hasGainExperience: playPetCode.includes('gainExperience'),
                cooldown: playPetCode.includes('45000') ? 45 : playPetCode.includes('60000') ? 60 : 'unknown'
            },
            petSleep: {
                hasGainCoins: sleepCode.includes('gainCoins'),
                hasGainExperience: sleepCode.includes('gainExperience'),
                cooldown: sleepCode.includes('120000') ? 120 : 'unknown'
            },
            version: isTamagotchi ? 'tamagotchi' : isBalanced ? 'balanced' : isOld ? 'old' : 'unknown'
        };
    };

    /**
     * æµ‹è¯•äº’åŠ¨æµç¨‹ä¸­çš„å¥–åŠ±æ‰§è¡Œé¡ºåº
     */
    window.testInteractionFlow = async function() {
        console.log('ğŸ§ª æµ‹è¯•äº’åŠ¨æµç¨‹ä¸­çš„å¥–åŠ±æ‰§è¡Œé¡ºåº...');

        if (!petData.isAlive) {
            console.log('âŒ å® ç‰©å·²æ­»äº¡ï¼Œæ— æ³•æµ‹è¯•');
            return;
        }

        console.log('\nğŸ“Š æµ‹è¯•å‰çŠ¶æ€:');
        const beforeCoins = petData.coins || 0;
        const beforeExp = petData.experience || 0;
        const beforeLevel = petData.level || 1;

        console.log(`- é‡‘å¸: ${beforeCoins}`);
        console.log(`- ç»éªŒ: ${beforeExp}`);
        console.log(`- ç­‰çº§: ${beforeLevel}`);

        console.log('\nğŸ”„ æ¨¡æ‹Ÿå–‚é£Ÿæµç¨‹...');

        try {
            // æ¨¡æ‹Ÿå–‚é£Ÿæµç¨‹çš„å…³é”®æ­¥éª¤
            console.log('1. æ›´æ–°å® ç‰©çŠ¶æ€...');
            petData.hunger = Math.min(100, petData.hunger + 20);
            petData.happiness = Math.min(100, petData.happiness + 5);
            petData.weight += 1;
            petData.lastFeedTime = Date.now();
            petData.lastCareTime = Date.now();

            console.log('2. éªŒè¯æ•°å€¼...');
            validateAndFixValues();

            console.log('3. è·å¾—ç»éªŒ...');
            gainExperience(2);
            console.log(`   ç»éªŒå˜åŒ–: ${beforeExp} â†’ ${petData.experience}`);

            console.log('4. è·å¾—é‡‘å¸...');
            gainCoins(3);
            console.log(`   é‡‘å¸å˜åŒ–: ${beforeCoins} â†’ ${petData.coins}`);

            console.log('5. å¤„ç†AIå›å¤...');
            await handleAIReply('feed', `${petData.name} åƒå¾—å¾ˆå¼€å¿ƒï¼`);
            console.log('   AIå›å¤å®Œæˆ');

            console.log('6. ä¿å­˜æ•°æ®...');
            savePetData();
            console.log('   æ•°æ®ä¿å­˜å®Œæˆ');

            console.log('7. æ¸²æŸ“çŠ¶æ€...');
            renderPetStatus();
            console.log('   çŠ¶æ€æ¸²æŸ“å®Œæˆ');

        } catch (error) {
            console.error('âŒ æµç¨‹æ‰§è¡Œå‡ºé”™:', error);
        }

        console.log('\nğŸ“Š æµ‹è¯•åçŠ¶æ€:');
        console.log(`- é‡‘å¸: ${petData.coins} (å˜åŒ–: +${(petData.coins || 0) - beforeCoins})`);
        console.log(`- ç»éªŒ: ${petData.experience} (å˜åŒ–: +${(petData.experience || 0) - beforeExp})`);
        console.log(`- ç­‰çº§: ${petData.level} (å˜åŒ–: +${(petData.level || 1) - beforeLevel})`);

        // éªŒè¯ç»“æœ
        const coinsGained = (petData.coins || 0) - beforeCoins;
        const expGained = (petData.experience || 0) - beforeExp;

        console.log('\nğŸ¯ æµ‹è¯•ç»“æœ:');
        if (coinsGained === 3) {
            console.log('âœ… é‡‘å¸å¥–åŠ±æ­£å¸¸ (+3)');
        } else {
            console.log(`âŒ é‡‘å¸å¥–åŠ±å¼‚å¸¸ (æœŸæœ›+3ï¼Œå®é™…+${coinsGained})`);
        }

        if (expGained >= 2) {
            console.log('âœ… ç»éªŒå¥–åŠ±æ­£å¸¸ (+2æˆ–æ›´å¤š)');
        } else {
            console.log(`âŒ ç»éªŒå¥–åŠ±å¼‚å¸¸ (æœŸæœ›+2ï¼Œå®é™…+${expGained})`);
        }

        return {
            before: { coins: beforeCoins, experience: beforeExp, level: beforeLevel },
            after: { coins: petData.coins, experience: petData.experience, level: petData.level },
            changes: { coins: coinsGained, experience: expGained, level: (petData.level || 1) - beforeLevel }
        };
    };

    /**
     * æµ‹è¯•ä¸åŒ…å«AIå›å¤çš„ç®€åŒ–äº’åŠ¨
     */
    window.testSimpleInteraction = function() {
        console.log('ğŸ§ª æµ‹è¯•ç®€åŒ–äº’åŠ¨ï¼ˆä¸åŒ…å«AIå›å¤ï¼‰...');

        if (!petData.isAlive) {
            console.log('âŒ å® ç‰©å·²æ­»äº¡ï¼Œæ— æ³•æµ‹è¯•');
            return;
        }

        console.log('\nğŸ“Š æµ‹è¯•å‰çŠ¶æ€:');
        const beforeCoins = petData.coins || 0;
        const beforeExp = petData.experience || 0;

        console.log(`- é‡‘å¸: ${beforeCoins}`);
        console.log(`- ç»éªŒ: ${beforeExp}`);

        console.log('\nğŸ”„ æ‰§è¡Œç®€åŒ–äº’åŠ¨...');

        try {
            console.log('1. è·å¾—ç»éªŒ...');
            gainExperience(2);

            console.log('2. è·å¾—é‡‘å¸...');
            gainCoins(3);

            console.log('3. ä¿å­˜æ•°æ®...');
            savePetData();

        } catch (error) {
            console.error('âŒ æ‰§è¡Œå‡ºé”™:', error);
        }

        console.log('\nğŸ“Š æµ‹è¯•åçŠ¶æ€:');
        const afterCoins = petData.coins || 0;
        const afterExp = petData.experience || 0;

        console.log(`- é‡‘å¸: ${afterCoins} (å˜åŒ–: +${afterCoins - beforeCoins})`);
        console.log(`- ç»éªŒ: ${afterExp} (å˜åŒ–: +${afterExp - beforeExp})`);

        // éªŒè¯ç»“æœ
        const coinsGained = afterCoins - beforeCoins;
        const expGained = afterExp - beforeExp;

        console.log('\nğŸ¯ æµ‹è¯•ç»“æœ:');
        if (coinsGained === 3) {
            console.log('âœ… é‡‘å¸åŠŸèƒ½æ­£å¸¸');
        } else {
            console.log(`âŒ é‡‘å¸åŠŸèƒ½å¼‚å¸¸ (æœŸæœ›+3ï¼Œå®é™…+${coinsGained})`);
        }

        if (expGained >= 2) {
            console.log('âœ… ç»éªŒåŠŸèƒ½æ­£å¸¸');
        } else {
            console.log(`âŒ ç»éªŒåŠŸèƒ½å¼‚å¸¸ (æœŸæœ›+2ï¼Œå®é™…+${expGained})`);
        }

        if (coinsGained === 3 && expGained >= 2) {
            console.log('\nğŸ’¡ ç»“è®º: å¥–åŠ±ç³»ç»Ÿæœ¬èº«æ­£å¸¸ï¼Œé—®é¢˜å¯èƒ½å‡ºåœ¨AIäº’åŠ¨æµç¨‹ä¸­');
        } else {
            console.log('\nğŸ’¡ ç»“è®º: å¥–åŠ±ç³»ç»Ÿæœ¬èº«æœ‰é—®é¢˜');
        }

        return {
            coinsGained,
            expGained,
            success: coinsGained === 3 && expGained >= 2
        };
    };

    /**
     * è¿½è¸ªå–‚é£Ÿå‡½æ•°çš„æ‰§è¡Œæµç¨‹
     */
    window.traceFeedPetExecution = async function() {
        console.log('ğŸ” è¿½è¸ªå–‚é£Ÿå‡½æ•°çš„æ‰§è¡Œæµç¨‹...');

        // è·å–åŸå§‹çš„feedPetå‡½æ•°ä»£ç 
        const feedPetCode = window.feedPet.toString();
        console.log('\nğŸ“ feedPetå‡½æ•°æºç ç‰‡æ®µ:');
        console.log(feedPetCode.substring(0, 500) + '...');

        console.log('\nğŸš€ å¼€å§‹æ‰§è¡Œè¿½è¸ªç‰ˆæœ¬çš„å–‚é£Ÿ...');

        try {
            console.log('1. æ£€æŸ¥å® ç‰©å­˜æ´»çŠ¶æ€...');
            if (!petData.isAlive) {
                console.log('âŒ å® ç‰©å·²æ­»äº¡ï¼Œå‡½æ•°åº”è¯¥åœ¨è¿™é‡Œè¿”å›');
                return;
            }
            console.log('âœ… å® ç‰©å­˜æ´»');

            console.log('2. æ£€æŸ¥å†·å´æ—¶é—´...');
            const now = Date.now();
            const timeSinceLastFeed = now - petData.lastFeedTime;
            console.log(`   è·ç¦»ä¸Šæ¬¡å–‚é£Ÿ: ${timeSinceLastFeed}ms`);
            console.log(`   å†·å´æ—¶é—´è¦æ±‚: 30000ms (30ç§’)`);

            if (timeSinceLastFeed < 30000) {
                console.log('âŒ å†·å´æ—¶é—´æœªåˆ°ï¼Œå‡½æ•°åº”è¯¥åœ¨è¿™é‡Œè¿”å›');
                return;
            }
            console.log('âœ… å†·å´æ—¶é—´å·²è¿‡');

            console.log('3. æ›´æ–°å® ç‰©çŠ¶æ€...');
            const oldHunger = petData.hunger;
            const oldHappiness = petData.happiness;
            const oldWeight = petData.weight;

            petData.hunger = Math.min(100, petData.hunger + 20);
            petData.happiness = Math.min(100, petData.happiness + 5);
            petData.weight += 1;
            petData.lastFeedTime = now;
            petData.lastCareTime = now;
            petData.careNeglectCount = Math.max(0, petData.careNeglectCount - 1);

            console.log(`   é¥±é£Ÿ: ${oldHunger} â†’ ${petData.hunger}`);
            console.log(`   å¿«ä¹: ${oldHappiness} â†’ ${petData.happiness}`);
            console.log(`   ä½“é‡: ${oldWeight} â†’ ${petData.weight}`);

            console.log('4. è¿‡åº¦å–‚é£Ÿæ£€æŸ¥...');
            if (petData.weight > 50) {
                petData.sickness = Math.min(100, petData.sickness + 10);
                console.log('âš ï¸ è§¦å‘è¿‡åº¦å–‚é£Ÿè­¦å‘Š');
            } else {
                console.log('âœ… ä½“é‡æ­£å¸¸');
            }

            console.log('5. éªŒè¯æ•°å€¼...');
            validateAndFixValues();
            console.log('âœ… æ•°å€¼éªŒè¯å®Œæˆ');

            console.log('6. è·å¾—ç»éªŒ...');
            const oldExp = petData.experience;
            const oldLevel = petData.level;
            gainExperience(2);
            console.log(`   ç»éªŒ: ${oldExp} â†’ ${petData.experience}`);
            console.log(`   ç­‰çº§: ${oldLevel} â†’ ${petData.level}`);

            console.log('7. è·å¾—é‡‘å¸...');
            const oldCoins = petData.coins;
            gainCoins(3);
            console.log(`   é‡‘å¸: ${oldCoins} â†’ ${petData.coins}`);

            console.log('8. å¤„ç†AIå›å¤...');
            await handleAIReply('feed', `${petData.name} åƒå¾—å¾ˆå¼€å¿ƒï¼`);
            console.log('âœ… AIå›å¤å®Œæˆ');

            console.log('9. ä¿å­˜æ•°æ®...');
            savePetData();
            console.log('âœ… æ•°æ®ä¿å­˜å®Œæˆ');

            console.log('10. æ¸²æŸ“çŠ¶æ€...');
            renderPetStatus();
            console.log('âœ… çŠ¶æ€æ¸²æŸ“å®Œæˆ');

            console.log('\nğŸ‰ å–‚é£Ÿæµç¨‹å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼');

        } catch (error) {
            console.error('âŒ æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            console.error('é”™è¯¯å †æ ˆ:', error.stack);
        }
    };

    /**
     * æ£€æŸ¥UIæŒ‰é’®äº‹ä»¶ç»‘å®š
     */
    window.checkUIButtonBinding = function() {
        console.log('ğŸ” æ£€æŸ¥UIæŒ‰é’®äº‹ä»¶ç»‘å®š...');

        const popup = $("#virtual-pet-popup");
        if (popup.length === 0) {
            console.log('âŒ å¼¹çª—ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰“å¼€å® ç‰©ç•Œé¢');
            console.log('ğŸ’¡ è¿è¡Œ: showPopup()');
            return false;
        }

        console.log('âœ… å¼¹çª—å­˜åœ¨');

        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
        const feedBtn = popup.find(".feed-btn");
        const playBtn = popup.find(".play-btn");
        const sleepBtn = popup.find(".sleep-btn");
        const hugBtn = popup.find(".hug-btn");

        console.log('\nğŸ“‹ æŒ‰é’®å­˜åœ¨æ€§æ£€æŸ¥:');
        console.log(`- å–‚é£ŸæŒ‰é’®: ${feedBtn.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${feedBtn.length})`);
        console.log(`- ç©è€æŒ‰é’®: ${playBtn.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${playBtn.length})`);
        console.log(`- ç¡è§‰æŒ‰é’®: ${sleepBtn.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${sleepBtn.length})`);
        console.log(`- æŠ±æŠ±æŒ‰é’®: ${hugBtn.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${hugBtn.length})`);

        // æ£€æŸ¥äº‹ä»¶ç»‘å®š
        console.log('\nğŸ”— äº‹ä»¶ç»‘å®šæ£€æŸ¥:');

        if (feedBtn.length > 0) {
            const events = $._data(feedBtn[0], 'events');
            console.log(`- å–‚é£ŸæŒ‰é’®äº‹ä»¶: ${events ? Object.keys(events).join(', ') : 'æ— '}`);

            // æµ‹è¯•ç‚¹å‡»äº‹ä»¶
            console.log('\nğŸ§ª æµ‹è¯•å–‚é£ŸæŒ‰é’®ç‚¹å‡»...');
            const oldCoins = petData.coins || 0;
            const oldExp = petData.experience || 0;

            console.log(`æµ‹è¯•å‰ - é‡‘å¸: ${oldCoins}, ç»éªŒ: ${oldExp}`);

            // æ¨¡æ‹Ÿç‚¹å‡»
            feedBtn.trigger('click');

            // ç­‰å¾…ä¸€ä¸‹å†æ£€æŸ¥ç»“æœ
            setTimeout(() => {
                console.log(`æµ‹è¯•å - é‡‘å¸: ${petData.coins}, ç»éªŒ: ${petData.experience}`);

                const coinsChanged = (petData.coins || 0) !== oldCoins;
                const expChanged = (petData.experience || 0) !== oldExp;

                if (coinsChanged || expChanged) {
                    console.log('âœ… æŒ‰é’®ç‚¹å‡»æœ‰æ•ˆæœï¼');
                } else {
                    console.log('âŒ æŒ‰é’®ç‚¹å‡»æ— æ•ˆæœ');
                    console.log('ğŸ’¡ å¯èƒ½åŸå› :');
                    console.log('  1. å†·å´æ—¶é—´æœªåˆ°');
                    console.log('  2. å® ç‰©å·²æ­»äº¡');
                    console.log('  3. äº‹ä»¶ç»‘å®šå¤±æ•ˆ');
                    console.log('  4. å‡½æ•°è¢«è¦†ç›–');
                }
            }, 1000);
        }

        // æ£€æŸ¥bindUnifiedUIEventsæ˜¯å¦è¢«è°ƒç”¨
        console.log('\nğŸ”§ ç»‘å®šå‡½æ•°æ£€æŸ¥:');
        console.log(`- bindUnifiedUIEventså‡½æ•°å­˜åœ¨: ${typeof bindUnifiedUIEvents === 'function'}`);

        return {
            popupExists: popup.length > 0,
            buttons: {
                feed: feedBtn.length,
                play: playBtn.length,
                sleep: sleepBtn.length
            },
            bindFunctionExists: typeof bindUnifiedUIEvents === 'function'
        };
    };

    /**
     * åœ¨UIç‚¹å‡»æ—¶è¿½è¸ªfeedPetå‡½æ•°æ‰§è¡Œ
     */
    window.traceUIFeedPet = function() {
        console.log('ğŸ” åœ¨UIç‚¹å‡»æ—¶è¿½è¸ªfeedPetå‡½æ•°æ‰§è¡Œ...');

        // ä¿å­˜åŸå§‹çš„gainCoinså’ŒgainExperienceå‡½æ•°
        const originalGainCoins = window.gainCoins || gainCoins;
        const originalGainExperience = window.gainExperience || gainExperience;

        // åˆ›å»ºè¿½è¸ªç‰ˆæœ¬
        window.gainCoins = function(amount) {
            console.log(`ğŸ” [è¿½è¸ª] gainCoinsè¢«è°ƒç”¨ï¼Œå‚æ•°: ${amount}`);
            console.log(`ğŸ” [è¿½è¸ª] è°ƒç”¨å †æ ˆ:`, new Error().stack);
            return originalGainCoins.call(this, amount);
        };

        window.gainExperience = function(exp) {
            console.log(`ğŸ” [è¿½è¸ª] gainExperienceè¢«è°ƒç”¨ï¼Œå‚æ•°: ${exp}`);
            console.log(`ğŸ” [è¿½è¸ª] è°ƒç”¨å †æ ˆ:`, new Error().stack);
            return originalGainExperience.call(this, exp);
        };

        console.log('âœ… è¿½è¸ªå‡½æ•°å·²è®¾ç½®');
        console.log('ğŸ’¡ ç°åœ¨ç‚¹å‡»UIä¸­çš„å–‚é£ŸæŒ‰é’®ï¼Œè§‚å¯Ÿè°ƒç”¨æƒ…å†µ');
        console.log('ğŸ’¡ å®Œæˆåè¿è¡Œ restoreOriginalFunctions() æ¢å¤åŸå§‹å‡½æ•°');

        // ä¿å­˜åŸå§‹å‡½æ•°ä»¥ä¾¿æ¢å¤
        window._originalGainCoins = originalGainCoins;
        window._originalGainExperience = originalGainExperience;

        return true;
    };

    /**
     * æ¢å¤åŸå§‹å‡½æ•°
     */
    window.restoreOriginalFunctions = function() {
        console.log('ğŸ”„ æ¢å¤åŸå§‹å‡½æ•°...');

        if (window._originalGainCoins) {
            window.gainCoins = window._originalGainCoins;
            delete window._originalGainCoins;
        }

        if (window._originalGainExperience) {
            window.gainExperience = window._originalGainExperience;
            delete window._originalGainExperience;
        }

        console.log('âœ… åŸå§‹å‡½æ•°å·²æ¢å¤');
        return true;
    };

    /**
     * æ£€æŸ¥ä¸åŒä½œç”¨åŸŸä¸­çš„feedPetå‡½æ•°
     */
    window.checkFeedPetVersions = function() {
        console.log('ğŸ” æ£€æŸ¥ä¸åŒä½œç”¨åŸŸä¸­çš„feedPetå‡½æ•°...');

        console.log('\nğŸ“‹ å‡½æ•°å­˜åœ¨æ€§æ£€æŸ¥:');
        console.log(`- window.feedPet: ${typeof window.feedPet === 'function'}`);
        console.log(`- global feedPet: ${typeof feedPet === 'function'}`);

        // å®‰å…¨æ£€æŸ¥this.feedPet
        let thisFeedPetExists = false;
        try {
            thisFeedPetExists = typeof this.feedPet === 'function';
        } catch (e) {
            thisFeedPetExists = false;
        }
        console.log(`- this.feedPet: ${thisFeedPetExists}`);

        // æ£€æŸ¥å‡½æ•°å†…å®¹
        if (typeof window.feedPet === 'function') {
            const windowFeedPetCode = window.feedPet.toString();
            console.log('\nğŸ“ window.feedPet å‡½æ•°åˆ†æ:');
            console.log(`- åŒ…å«gainCoins: ${windowFeedPetCode.includes('gainCoins')}`);
            console.log(`- åŒ…å«gainExperience: ${windowFeedPetCode.includes('gainExperience')}`);
            console.log(`- åŒ…å«handleAIReply: ${windowFeedPetCode.includes('handleAIReply')}`);
            console.log(`- åŒ…å«æ‹“éº»æ­Œå­ç‰¹å¾(weight): ${windowFeedPetCode.includes('weight')}`);
            console.log(`- å‡½æ•°é•¿åº¦: ${windowFeedPetCode.length} å­—ç¬¦`);
        }

        if (typeof feedPet === 'function' && feedPet !== window.feedPet) {
            const globalFeedPetCode = feedPet.toString();
            console.log('\nğŸ“ global feedPet å‡½æ•°åˆ†æ:');
            console.log(`- åŒ…å«gainCoins: ${globalFeedPetCode.includes('gainCoins')}`);
            console.log(`- åŒ…å«gainExperience: ${globalFeedPetCode.includes('gainExperience')}`);
            console.log(`- åŒ…å«handleAIReply: ${globalFeedPetCode.includes('handleAIReply')}`);
            console.log(`- åŒ…å«æ‹“éº»æ­Œå­ç‰¹å¾(weight): ${globalFeedPetCode.includes('weight')}`);
            console.log(`- å‡½æ•°é•¿åº¦: ${globalFeedPetCode.length} å­—ç¬¦`);
        }

        // å¼ºåˆ¶UIä½¿ç”¨window.feedPet
        console.log('\nğŸ”§ å¼ºåˆ¶ä¿®å¤UIç»‘å®š...');
        const popup = $("#virtual-pet-popup");
        if (popup.length > 0) {
            const feedBtn = popup.find(".feed-btn");
            if (feedBtn.length > 0) {
                // ç§»é™¤æ—§çš„äº‹ä»¶ç»‘å®š
                feedBtn.off("click touchend");

                // é‡æ–°ç»‘å®šåˆ°window.feedPet
                feedBtn.on("click touchend", function(e) {
                    e.preventDefault();
                    console.log("ğŸ– å–‚é£Ÿå® ç‰© (å¼ºåˆ¶ä½¿ç”¨window.feedPet)");
                    if (typeof window.feedPet === 'function') {
                        window.feedPet();
                    } else {
                        console.error('âŒ window.feedPet ä¸å­˜åœ¨');
                    }
                });

                console.log('âœ… UIæŒ‰é’®å·²é‡æ–°ç»‘å®šåˆ°window.feedPet');
            } else {
                console.log('âŒ æ‰¾ä¸åˆ°å–‚é£ŸæŒ‰é’®');
            }
        } else {
            console.log('âŒ æ‰¾ä¸åˆ°å¼¹çª—ï¼Œè¯·å…ˆæ‰“å¼€å® ç‰©ç•Œé¢');
        }

        return {
            windowFeedPet: typeof window.feedPet === 'function',
            globalFeedPet: typeof feedPet === 'function',
            areTheSame: window.feedPet === feedPet,
            uiFixed: popup.length > 0
        };
    };

    /**
     * æµ‹è¯•ä¿®å¤åçš„UIæŒ‰é’®
     */
    window.testFixedUIButton = function() {
        console.log('ğŸ§ª æµ‹è¯•ä¿®å¤åçš„UIæŒ‰é’®...');

        const popup = $("#virtual-pet-popup");
        if (popup.length === 0) {
            console.log('âŒ å¼¹çª—ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰“å¼€å® ç‰©ç•Œé¢');
            return false;
        }

        const feedBtn = popup.find(".feed-btn");
        if (feedBtn.length === 0) {
            console.log('âŒ æ‰¾ä¸åˆ°å–‚é£ŸæŒ‰é’®');
            return false;
        }

        console.log('âœ… æ‰¾åˆ°å–‚é£ŸæŒ‰é’®');

        // è®°å½•æµ‹è¯•å‰çŠ¶æ€
        const beforeCoins = petData.coins || 0;
        const beforeExp = petData.experience || 0;
        const beforeLevel = petData.level || 1;

        console.log('\nğŸ“Š æµ‹è¯•å‰çŠ¶æ€:');
        console.log(`- é‡‘å¸: ${beforeCoins}`);
        console.log(`- ç»éªŒ: ${beforeExp}`);
        console.log(`- ç­‰çº§: ${beforeLevel}`);

        // è®¾ç½®è¿½è¸ª
        let gainCoinsWasCalled = false;
        let gainExpWasCalled = false;

        const originalGainCoins = window.gainCoins || gainCoins;
        const originalGainExp = window.gainExperience || gainExperience;

        window.gainCoins = function(amount) {
            console.log(`ğŸ” [è¿½è¸ª] gainCoinsè¢«è°ƒç”¨: +${amount}`);
            gainCoinsWasCalled = true;
            return originalGainCoins.call(this, amount);
        };

        window.gainExperience = function(exp) {
            console.log(`ğŸ” [è¿½è¸ª] gainExperienceè¢«è°ƒç”¨: +${exp}`);
            gainExpWasCalled = true;
            return originalGainExp.call(this, exp);
        };

        console.log('\nğŸ–±ï¸ æ¨¡æ‹Ÿç‚¹å‡»å–‚é£ŸæŒ‰é’®...');

        // æ¨¡æ‹Ÿç‚¹å‡»
        feedBtn.trigger('click');

        // ç­‰å¾…ä¸€ä¸‹å†æ£€æŸ¥ç»“æœ
        setTimeout(() => {
            console.log('\nğŸ“Š æµ‹è¯•åçŠ¶æ€:');
            console.log(`- é‡‘å¸: ${petData.coins} (å˜åŒ–: +${(petData.coins || 0) - beforeCoins})`);
            console.log(`- ç»éªŒ: ${petData.experience} (å˜åŒ–: +${(petData.experience || 0) - beforeExp})`);
            console.log(`- ç­‰çº§: ${petData.level} (å˜åŒ–: +${(petData.level || 1) - beforeLevel})`);

            console.log('\nğŸ” å‡½æ•°è°ƒç”¨è¿½è¸ª:');
            console.log(`- gainCoinsè¢«è°ƒç”¨: ${gainCoinsWasCalled ? 'âœ…' : 'âŒ'}`);
            console.log(`- gainExperienceè¢«è°ƒç”¨: ${gainExpWasCalled ? 'âœ…' : 'âŒ'}`);

            // æ¢å¤åŸå§‹å‡½æ•°
            window.gainCoins = originalGainCoins;
            window.gainExperience = originalGainExp;

            if (!gainCoinsWasCalled && !gainExpWasCalled) {
                console.log('\nâŒ é—®é¢˜åˆ†æ: å¥–åŠ±å‡½æ•°éƒ½æ²¡æœ‰è¢«è°ƒç”¨');
                console.log('ğŸ’¡ å¯èƒ½åŸå› :');
                console.log('  1. å†·å´æ—¶é—´æœªåˆ°');
                console.log('  2. å® ç‰©å·²æ­»äº¡');
                console.log('  3. UIç»‘å®šä»ç„¶æœ‰é—®é¢˜');
                console.log('  4. å‡½æ•°æ‰§è¡Œè¢«ä¸­æ–­');

                // æ£€æŸ¥å†·å´æ—¶é—´
                const now = Date.now();
                const timeSinceLastFeed = now - (petData.lastFeedTime || 0);
                console.log(`\nâ° å†·å´æ—¶é—´æ£€æŸ¥:`);
                console.log(`- è·ç¦»ä¸Šæ¬¡å–‚é£Ÿ: ${Math.round(timeSinceLastFeed / 1000)}ç§’`);
                console.log(`- å†·å´è¦æ±‚: 30ç§’`);
                console.log(`- å†·å´çŠ¶æ€: ${timeSinceLastFeed >= 30000 ? 'âœ… å·²è¿‡' : 'âŒ æœªè¿‡'}`);

                console.log(`\nğŸ’€ å® ç‰©çŠ¶æ€æ£€æŸ¥:`);
                console.log(`- å® ç‰©å­˜æ´»: ${petData.isAlive ? 'âœ…' : 'âŒ'}`);
            }

        }, 2000); // ç­‰å¾…2ç§’

        return true;
    };

    /**
     * ç­‰å¾…å†·å´æ—¶é—´åæµ‹è¯•UIæŒ‰é’®
     */
    window.testUIAfterCooldown = function() {
        console.log('â° ç­‰å¾…å†·å´æ—¶é—´åæµ‹è¯•UIæŒ‰é’®...');

        const now = Date.now();
        const timeSinceLastFeed = now - (petData.lastFeedTime || 0);
        const cooldownRemaining = Math.max(0, 30000 - timeSinceLastFeed);

        if (cooldownRemaining > 0) {
            console.log(`â° è¿˜éœ€ç­‰å¾… ${Math.ceil(cooldownRemaining / 1000)} ç§’`);
            console.log('ğŸ’¡ è¯·ç­‰å¾…å†·å´æ—¶é—´ç»“æŸåå†æ¬¡è¿è¡Œæ­¤å‡½æ•°');
            return false;
        }

        console.log('âœ… å†·å´æ—¶é—´å·²è¿‡ï¼Œå¼€å§‹æµ‹è¯•...');

        const popup = $("#virtual-pet-popup");
        if (popup.length === 0) {
            console.log('âŒ å¼¹çª—ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰“å¼€å® ç‰©ç•Œé¢');
            return false;
        }

        const feedBtn = popup.find(".feed-btn");
        if (feedBtn.length === 0) {
            console.log('âŒ æ‰¾ä¸åˆ°å–‚é£ŸæŒ‰é’®');
            return false;
        }

        // è®°å½•æµ‹è¯•å‰çŠ¶æ€
        const beforeCoins = petData.coins || 0;
        const beforeExp = petData.experience || 0;

        console.log('\nğŸ“Š æµ‹è¯•å‰çŠ¶æ€:');
        console.log(`- é‡‘å¸: ${beforeCoins}`);
        console.log(`- ç»éªŒ: ${beforeExp}`);

        // è®¾ç½®è¿½è¸ªï¼ˆåœ¨ç‚¹å‡»å‰è®¾ç½®ï¼‰
        let gainCoinsWasCalled = false;
        let gainExpWasCalled = false;
        let coinsAmount = 0;
        let expAmount = 0;

        const originalGainCoins = window.gainCoins || gainCoins;
        const originalGainExp = window.gainExperience || gainExperience;

        window.gainCoins = function(amount) {
            console.log(`ğŸ” [è¿½è¸ª] gainCoinsè¢«è°ƒç”¨: +${amount}`);
            gainCoinsWasCalled = true;
            coinsAmount = amount;
            return originalGainCoins.call(this, amount);
        };

        window.gainExperience = function(exp) {
            console.log(`ğŸ” [è¿½è¸ª] gainExperienceè¢«è°ƒç”¨: +${exp}`);
            gainExpWasCalled = true;
            expAmount = exp;
            return originalGainExp.call(this, exp);
        };

        console.log('\nğŸ–±ï¸ ç‚¹å‡»å–‚é£ŸæŒ‰é’®...');
        feedBtn.trigger('click');

        // ç­‰å¾…ä¸€ä¸‹å†æ£€æŸ¥ç»“æœ
        setTimeout(() => {
            console.log('\nğŸ“Š æµ‹è¯•åçŠ¶æ€:');
            console.log(`- é‡‘å¸: ${petData.coins} (å˜åŒ–: +${(petData.coins || 0) - beforeCoins})`);
            console.log(`- ç»éªŒ: ${petData.experience} (å˜åŒ–: +${(petData.experience || 0) - beforeExp})`);

            console.log('\nğŸ” å‡½æ•°è°ƒç”¨è¿½è¸ª:');
            console.log(`- gainCoinsè¢«è°ƒç”¨: ${gainCoinsWasCalled ? 'âœ…' : 'âŒ'}`);
            console.log(`- gainExperienceè¢«è°ƒç”¨: ${gainExpWasCalled ? 'âœ…' : 'âŒ'}`);

            if (gainCoinsWasCalled) {
                console.log(`âœ… é‡‘å¸ç³»ç»Ÿæ­£å¸¸å·¥ä½œï¼è·å¾—äº† ${coinsAmount} é‡‘å¸`);
            }

            if (gainExpWasCalled) {
                console.log(`âœ… ç»éªŒç³»ç»Ÿæ­£å¸¸å·¥ä½œï¼è·å¾—äº† ${expAmount} ç»éªŒ`);
            }

            // æ¢å¤åŸå§‹å‡½æ•°
            window.gainCoins = originalGainCoins;
            window.gainExperience = originalGainExp;

        }, 3000); // ç­‰å¾…3ç§’

        return true;
    };

    /**
     * æ£€æŸ¥UIå®é™…è°ƒç”¨çš„feedPetå‡½æ•°å†…å®¹
     */
    window.inspectUIFeedPet = function() {
        console.log('ğŸ” æ£€æŸ¥UIå®é™…è°ƒç”¨çš„feedPetå‡½æ•°å†…å®¹...');

        const popup = $("#virtual-pet-popup");
        if (popup.length === 0) {
            console.log('âŒ å¼¹çª—ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰“å¼€å® ç‰©ç•Œé¢');
            return false;
        }

        const feedBtn = popup.find(".feed-btn");
        if (feedBtn.length === 0) {
            console.log('âŒ æ‰¾ä¸åˆ°å–‚é£ŸæŒ‰é’®');
            return false;
        }

        console.log('âœ… æ‰¾åˆ°å–‚é£ŸæŒ‰é’®');

        // è·å–æŒ‰é’®ç»‘å®šçš„äº‹ä»¶
        const events = $._data(feedBtn[0], 'events');
        console.log('\nğŸ“‹ æŒ‰é’®äº‹ä»¶:', events);

        // æ£€æŸ¥å½“å‰ä½œç”¨åŸŸä¸­çš„feedPetå‡½æ•°
        console.log('\nğŸ“ å‡½æ•°å†…å®¹åˆ†æ:');

        if (typeof window.feedPet === 'function') {
            const windowFeedPetCode = window.feedPet.toString();
            console.log('\nğŸ” window.feedPet å‡½æ•°:');
            console.log(`- é•¿åº¦: ${windowFeedPetCode.length} å­—ç¬¦`);
            console.log(`- åŒ…å«gainCoins: ${windowFeedPetCode.includes('gainCoins')}`);
            console.log(`- åŒ…å«gainExperience: ${windowFeedPetCode.includes('gainExperience')}`);
            console.log(`- åŒ…å«weight: ${windowFeedPetCode.includes('weight')}`);
            console.log(`- åŒ…å«handleAIReply: ${windowFeedPetCode.includes('handleAIReply')}`);

            // æ˜¾ç¤ºå‡½æ•°çš„å‰500ä¸ªå­—ç¬¦
            console.log('\nğŸ“„ å‡½æ•°å¼€å¤´:');
            console.log(windowFeedPetCode.substring(0, 500) + '...');
        }

        if (typeof feedPet === 'function' && feedPet !== window.feedPet) {
            const globalFeedPetCode = feedPet.toString();
            console.log('\nğŸ” global feedPet å‡½æ•°:');
            console.log(`- é•¿åº¦: ${globalFeedPetCode.length} å­—ç¬¦`);
            console.log(`- åŒ…å«gainCoins: ${globalFeedPetCode.includes('gainCoins')}`);
            console.log(`- åŒ…å«gainExperience: ${globalFeedPetCode.includes('gainExperience')}`);
            console.log(`- åŒ…å«weight: ${globalFeedPetCode.includes('weight')}`);
            console.log(`- åŒ…å«handleAIReply: ${globalFeedPetCode.includes('handleAIReply')}`);

            // æ˜¾ç¤ºå‡½æ•°çš„å‰500ä¸ªå­—ç¬¦
            console.log('\nğŸ“„ å‡½æ•°å¼€å¤´:');
            console.log(globalFeedPetCode.substring(0, 500) + '...');
        }

        // å¼ºåˆ¶é‡æ–°ç»‘å®šåˆ°æ­£ç¡®çš„å‡½æ•°
        console.log('\nğŸ”§ å¼ºåˆ¶é‡æ–°ç»‘å®šåˆ°æ‹“éº»æ­Œå­ç‰ˆæœ¬...');

        // ç§»é™¤æ—§çš„äº‹ä»¶ç»‘å®š
        feedBtn.off("click touchend");

        // é‡æ–°ç»‘å®šåˆ°ç¡®ä¿åŒ…å«é‡‘å¸å¥–åŠ±çš„ç‰ˆæœ¬
        feedBtn.on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ– å–‚é£Ÿå® ç‰© (å¼ºåˆ¶ä½¿ç”¨æ‹“éº»æ­Œå­ç‰ˆæœ¬)");

            // ç›´æ¥è°ƒç”¨æ‹“éº»æ­Œå­ç‰ˆæœ¬çš„é€»è¾‘
            if (typeof window.feedPet === 'function' && window.feedPet.toString().includes('gainCoins')) {
                window.feedPet();
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°åŒ…å«gainCoinsçš„feedPetç‰ˆæœ¬');
                // æ‰‹åŠ¨æ‰§è¡Œæ‹“éº»æ­Œå­é€»è¾‘
                console.log('ğŸ”§ æ‰‹åŠ¨æ‰§è¡Œæ‹“éº»æ­Œå­å–‚é£Ÿé€»è¾‘...');
                manualTamagotchiFeed();
            }
        });

        console.log('âœ… UIæŒ‰é’®å·²é‡æ–°ç»‘å®š');

        return true;
    };

    /**
     * æ‰‹åŠ¨æ‰§è¡Œæ‹“éº»æ­Œå­å–‚é£Ÿé€»è¾‘
     */
    function manualTamagotchiFeed() {
        console.log('ğŸ”§ æ‰‹åŠ¨æ‰§è¡Œæ‹“éº»æ­Œå­å–‚é£Ÿé€»è¾‘...');

        if (!petData.isAlive) {
            toastr.error("ğŸ’€ ä½ çš„å® ç‰©å·²ç»æ­»äº¡ï¼Œæ— æ³•å–‚é£Ÿ...");
            return;
        }

        const now = Date.now();
        const timeSinceLastFeed = now - petData.lastFeedTime;

        if (timeSinceLastFeed < 30000) { // 30ç§’å†·å´
            toastr.warning("å® ç‰©è¿˜ä¸é¥¿ï¼Œç­‰ä¸€ä¼šå†å–‚å§ï¼");
            return;
        }

        // æ‹“éº»æ­Œå­å¼å–‚é£Ÿæ•ˆæœ
        petData.hunger = Math.min(100, petData.hunger + 20);
        petData.happiness = Math.min(100, petData.happiness + 5);
        petData.weight += 1;
        petData.lastFeedTime = now;
        petData.lastCareTime = now;
        petData.careNeglectCount = Math.max(0, petData.careNeglectCount - 1);

        // è¿‡åº¦å–‚é£Ÿæ£€æŸ¥
        if (petData.weight > 50) {
            petData.sickness = Math.min(100, petData.sickness + 10);
            toastr.warning("âš ï¸ å® ç‰©åƒå¾—å¤ªå¤šäº†ï¼Œå¯èƒ½ä¼šç”Ÿç—…ï¼");
        }

        validateAndFixValues();

        // å®šä¹‰å¥–åŠ±
        const rewards = { coins: 3, experience: 2 };

        // ç¡®ä¿è°ƒç”¨å¥–åŠ±å‡½æ•°
        console.log('ğŸ ç»™äºˆå¥–åŠ±...');
        gainExperience(rewards.experience);
        gainCoins(rewards.coins);

        // AIå›å¤æ—¶ä¼ é€’å¥–åŠ±ä¿¡æ¯ï¼Œç”¨äºç‹¬ç«‹æ˜¾ç¤º
        handleAIReply('feed', `${petData.name} åƒå¾—å¾ˆå¼€å¿ƒï¼`, rewards);

        savePetData();
        renderPetStatus();

        // å¼ºåˆ¶æ›´æ–°UIæ˜¾ç¤º
        setTimeout(() => {
            updateUnifiedUIStatus();
            console.log('ğŸ”„ UIçŠ¶æ€å·²å¼ºåˆ¶åˆ·æ–°');
        }, 100);
    }

    /**
     * å¼ºåˆ¶åˆ·æ–°UIæ˜¾ç¤º
     */
    window.forceUIRefresh = function() {
        console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°UIæ˜¾ç¤º...');

        try {
            // åˆ·æ–°å® ç‰©çŠ¶æ€æ˜¾ç¤º
            if (typeof renderPetStatus === 'function') {
                renderPetStatus();
                console.log('âœ… renderPetStatus å·²è°ƒç”¨');
            }

            // åˆ·æ–°ç»Ÿä¸€UIçŠ¶æ€
            if (typeof updateUnifiedUIStatus === 'function') {
                updateUnifiedUIStatus();
                console.log('âœ… updateUnifiedUIStatus å·²è°ƒç”¨');
            }

            // å¼ºåˆ¶æ›´æ–°é‡‘å¸æ˜¾ç¤º
            const popup = $("#virtual-pet-popup");
            if (popup.length > 0) {
                const coinsElement = popup.find('.coins-display, .coin-count, [class*="coin"]');
                if (coinsElement.length > 0) {
                    coinsElement.text(`ğŸ’° ${petData.coins || 100}`);
                    console.log(`âœ… é‡‘å¸æ˜¾ç¤ºå·²æ›´æ–°: ${petData.coins || 100}`);
                } else {
                    console.log('âš ï¸ æ‰¾ä¸åˆ°é‡‘å¸æ˜¾ç¤ºå…ƒç´ ');
                }

                // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰çŠ¶æ€æ˜¾ç¤º
                popup.find('.status-value').each(function() {
                    const $this = $(this);
                    const text = $this.text();
                    if (text.includes('é‡‘å¸') || text.includes('ğŸ’°')) {
                        $this.text(`ğŸ’° ${petData.coins || 100}`);
                    }
                });
            }

            console.log('ğŸ”„ UIåˆ·æ–°å®Œæˆ');
            return true;

        } catch (error) {
            console.error('âŒ UIåˆ·æ–°å¤±è´¥:', error);
            return false;
        }
    };





    /**
     * æµ‹è¯•æ–°çš„å¥–åŠ±æ˜¾ç¤ºç³»ç»Ÿ
     */
    window.testRewardDisplay = function() {
        console.log('ğŸ æµ‹è¯•æ–°çš„å¥–åŠ±æ˜¾ç¤ºç³»ç»Ÿ...');

        // æµ‹è¯•å¥–åŠ±é€šçŸ¥æ˜¾ç¤º
        console.log('1. æµ‹è¯•å¥–åŠ±é€šçŸ¥æ˜¾ç¤º...');
        showRewardNotification({ coins: 5, experience: 3 });

        setTimeout(() => {
            console.log('2. æµ‹è¯•åªæœ‰é‡‘å¸çš„å¥–åŠ±...');
            showRewardNotification({ coins: 10, experience: 0 });
        }, 2000);

        setTimeout(() => {
            console.log('3. æµ‹è¯•åªæœ‰ç»éªŒçš„å¥–åŠ±...');
            showRewardNotification({ coins: 0, experience: 5 });
        }, 4000);

        setTimeout(() => {
            console.log('4. æµ‹è¯•å®Œæ•´çš„äº’åŠ¨æµç¨‹...');
            console.log('ğŸ’¡ ç°åœ¨å¯ä»¥ç‚¹å‡»UIä¸­çš„å–‚é£ŸæŒ‰é’®æµ‹è¯•å®Œæ•´æµç¨‹');
            console.log('é¢„æœŸæ•ˆæœï¼š');
            console.log('  1. AIå›å¤æ˜¾ç¤ºåœ¨å·¦ä¸Šè§’');
            console.log('  2. å¥–åŠ±ä¿¡æ¯æ˜¾ç¤ºåœ¨å³ä¸‹è§’');
            console.log('  3. ä¸¤è€…ä¸ä¼šé‡å ');
        }, 6000);

        return true;
    };

    /**
     * è°ƒæ•´è¡°å‡é€Ÿåº¦å’Œç¼“å†²æœºåˆ¶
     */
    window.adjustDecaySystem = function() {
        console.log('âš–ï¸ è°ƒæ•´è¡°å‡é€Ÿåº¦å’Œç¼“å†²æœºåˆ¶...');

        // é‡æ–°å®šä¹‰æ›´å¹³è¡¡çš„è¡°å‡ç³»ç»Ÿ
        window.updatePetStatus = function() {
            if (!petData.isAlive) return;

            const now = Date.now();
            const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
            const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);

            if (hoursElapsed > 0.1) { // æ¯6åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡

                // 1. å¹´é¾„å¢é•¿
                petData.age += hoursElapsed;

                // 2. ç”Ÿå‘½é˜¶æ®µæ£€æŸ¥
                if (typeof checkLifeStageProgression === 'function') {
                    checkLifeStageProgression();
                }

                // 3. æ›´çœŸå®çš„è¡°å‡é€Ÿåº¦ - è®©æ—¶é—´æµé€æ›´æœ‰æ„ŸçŸ¥
                petData.hunger = Math.max(0, petData.hunger - hoursElapsed * 3.5);    // æ¯å°æ—¶-3.5 (ç¦»çº¿8å°æ—¶ä¸‹é™28ç‚¹)
                petData.energy = Math.max(0, petData.energy - hoursElapsed * 3.0);    // æ¯å°æ—¶-3.0 (ç¦»çº¿8å°æ—¶ä¸‹é™24ç‚¹)
                petData.happiness = Math.max(0, petData.happiness - hoursElapsed * 2.5); // æ¯å°æ—¶-2.5 (ç¦»çº¿8å°æ—¶ä¸‹é™20ç‚¹)

                // 4. çŠ¶æ€ä¸ä½³æ—¶çš„æƒ©ç½šæ€§è¡°å‡ - æé«˜é—¨æ§›å’Œæƒ©ç½šåŠ›åº¦
                if (petData.hunger < 25) { // é—¨æ§›æé«˜åˆ°25ï¼Œç»™ç©å®¶æ›´å¤šååº”æ—¶é—´
                    petData.health = Math.max(0, petData.health - hoursElapsed * 1.5); // æƒ©ç½šåŠ å¤§
                    petData.happiness = Math.max(0, petData.happiness - hoursElapsed * 1.0);
                }

                if (petData.energy < 25) { // é—¨æ§›æé«˜åˆ°25
                    petData.happiness = Math.max(0, petData.happiness - hoursElapsed * 0.8);
                }

                // 5. æ­»äº¡æ£€æŸ¥
                if (typeof checkDeathConditions === 'function') {
                    checkDeathConditions();
                }

                petData.lastUpdateTime = now;
                validateAndFixValues();
                savePetData();
            }
        };

        // é‡æ–°å®šä¹‰æ›´å®½æ¾çš„ç¼“å†²æœºåˆ¶
        window.applyInitializationBuffer = function() {
            const now = Date.now();
            const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
            const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);

            // å¦‚æœè·ç¦»ä¸Šæ¬¡æ›´æ–°è¶…è¿‡2å°æ—¶ï¼Œç»™äºˆ"æ€¥æ•‘åŒ…"ç¼“å†²
            if (hoursElapsed > 2) {
                console.log(`æ£€æµ‹åˆ°é•¿æ—¶é—´æœªæ›´æ–° (${hoursElapsed.toFixed(1)}å°æ—¶)ï¼Œåº”ç”¨æ€¥æ•‘ç¼“å†²...`);

                // 50ä¸Šé™ç³»ç»Ÿï¼šæ€¥æ•‘ç¼“å†²æ•°å€¼
                const minValues = {
                    hunger: 25,    // 50ä¸Šé™ç³»ç»Ÿï¼šæ€¥æ•‘é¥±é£Ÿåº¦25
                    energy: 20,    // 50ä¸Šé™ç³»ç»Ÿï¼šæ€¥æ•‘ç²¾åŠ›20
                    happiness: 15, // 50ä¸Šé™ç³»ç»Ÿï¼šæ€¥æ•‘å¿«ä¹åº¦15
                    health: 30     // 50ä¸Šé™ç³»ç»Ÿï¼šæ€¥æ•‘å¥åº·åº¦30
                };

                let buffered = false;
                Object.entries(minValues).forEach(([key, minValue]) => {
                    if (petData[key] < minValue) {
                        console.log(`ç¼“å†² ${key}: ${petData[key]} â†’ ${minValue}`);
                        petData[key] = minValue;
                        buffered = true;
                    }
                });

                if (buffered) {
                    petData.lastUpdateTime = now;
                    savePetData();
                    toastr.info('ğŸŒŸ æ¬¢è¿å›æ¥ï¼å·²ä¸ºä½ çš„å® ç‰©æä¾›äº†åŸºç¡€ç…§é¡¾ã€‚', '', { timeOut: 4000 });
                    console.log('åˆå§‹åŒ–ç¼“å†²å·²åº”ç”¨');
                }
            }
        };

        console.log('âœ… è¡°å‡ç³»ç»Ÿå·²è°ƒæ•´ä¸ºæ›´çœŸå®çš„å…»æˆä½“éªŒ');
        console.log('ğŸ“Š æ–°çš„è¡°å‡é€Ÿåº¦ (æ›´æœ‰æ„ŸçŸ¥çš„æ—¶é—´æµé€):');
        console.log('  - é¥±é£Ÿåº¦: æ¯å°æ—¶ -3.5 (ç¦»çº¿8å°æ—¶ä¸‹é™28ç‚¹)');
        console.log('  - ç²¾åŠ›: æ¯å°æ—¶ -3.0 (ç¦»çº¿8å°æ—¶ä¸‹é™24ç‚¹)');
        console.log('  - å¿«ä¹åº¦: æ¯å°æ—¶ -2.5 (ç¦»çº¿8å°æ—¶ä¸‹é™20ç‚¹)');
        console.log('âš ï¸ æƒ©ç½šæ€§è¡°å‡ (çŠ¶æ€ä¸ä½³æ—¶):');
        console.log('  - é¥¥é¥¿é—¨æ§›: <25 (åŸæ¥ <15)');
        console.log('  - ç–²åŠ³é—¨æ§›: <25 (åŸæ¥ <15)');
        console.log('  - æƒ©ç½šåŠ›åº¦: æ˜¾è‘—å¢åŠ ');
        console.log('ğŸ›¡ï¸ æ€¥æ•‘ç¼“å†²æœºåˆ¶:');
        console.log('  - è§¦å‘æ—¶é—´: 2å°æ—¶ (æ›´ä¸¥æ ¼)');
        console.log('  - æœ€ä½é¥±é£Ÿåº¦: 35 (æ€¥æ•‘æ°´å¹³)');
        console.log('  - æœ€ä½ç²¾åŠ›: 30 (æ€¥æ•‘æ°´å¹³)');
        console.log('  - æœ€ä½å¿«ä¹åº¦: 25 (æ€¥æ•‘æ°´å¹³)');
        console.log('  - æœ€ä½å¥åº·åº¦: 40 (æ€¥æ•‘æ°´å¹³)');
        console.log('ğŸ’¡ è®¾è®¡ç†å¿µ: é¼“åŠ±é¢‘ç¹äº’åŠ¨ï¼Œä½†æä¾›æ­»äº¡ä¿æŠ¤');

        // ç«‹å³åº”ç”¨ç¼“å†²
        applyInitializationBuffer();

        return true;
    };

    /**
     * æµ‹è¯•æ–°çš„è¡°å‡ç³»ç»Ÿæ•ˆæœ
     */
    window.testNewDecaySystem = function() {
        console.log('ğŸ§ª æµ‹è¯•æ–°çš„è¡°å‡ç³»ç»Ÿæ•ˆæœ...');

        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        console.log('\nğŸ“Š å½“å‰å® ç‰©çŠ¶æ€:');
        console.log(`- é¥±é£Ÿåº¦: ${petData.hunger}/100`);
        console.log(`- ç²¾åŠ›: ${petData.energy}/100`);
        console.log(`- å¿«ä¹åº¦: ${petData.happiness}/100`);
        console.log(`- å¥åº·åº¦: ${petData.health}/100`);

        // æ¨¡æ‹Ÿä¸åŒæ—¶é•¿çš„ç¦»çº¿æ•ˆæœ
        console.log('\nâ° æ¨¡æ‹Ÿç¦»çº¿æ•ˆæœé¢„æµ‹:');

        const scenarios = [
            { hours: 2, desc: 'çŸ­æš‚ç¦»çº¿ (2å°æ—¶)' },
            { hours: 8, desc: 'ä¸€ä¸ªå·¥ä½œæ—¥ (8å°æ—¶)' },
            { hours: 24, desc: 'ä¸€æ•´å¤© (24å°æ—¶)' },
            { hours: 72, desc: 'å‘¨æœ« (72å°æ—¶)' }
        ];

        scenarios.forEach(scenario => {
            const hungerLoss = scenario.hours * 3.5;
            const energyLoss = scenario.hours * 3.0;
            const happinessLoss = scenario.hours * 2.5;

            const predictedHunger = Math.max(0, petData.hunger - hungerLoss);
            const predictedEnergy = Math.max(0, petData.energy - energyLoss);
            const predictedHappiness = Math.max(0, petData.happiness - happinessLoss);

            console.log(`\n${scenario.desc}:`);
            console.log(`  é¥±é£Ÿåº¦: ${petData.hunger} â†’ ${predictedHunger} (${hungerLoss > 0 ? '-' : ''}${hungerLoss})`);
            console.log(`  ç²¾åŠ›: ${petData.energy} â†’ ${predictedEnergy} (${energyLoss > 0 ? '-' : ''}${energyLoss})`);
            console.log(`  å¿«ä¹åº¦: ${petData.happiness} â†’ ${predictedHappiness} (${happinessLoss > 0 ? '-' : ''}${happinessLoss})`);

            // åˆ¤æ–­æ˜¯å¦ä¼šè§¦å‘ç¼“å†²
            if (scenario.hours > 2) {
                console.log(`  ğŸ›¡ï¸ ä¼šè§¦å‘æ€¥æ•‘ç¼“å†² (æœ€ä½ä¿è¯: é¥±é£Ÿ35, ç²¾åŠ›30, å¿«ä¹25)`);
            }
        });

        console.log('\nğŸ’¡ æ–°ç³»ç»Ÿç‰¹ç‚¹:');
        console.log('âœ… ç¦»çº¿æ—¶é—´æœ‰æ˜æ˜¾æ„ŸçŸ¥ - ä¸å†æ˜¯"å‡è£…çš„æ—¶é—´æµé€"');
        console.log('âœ… é¼“åŠ±é¢‘ç¹äº’åŠ¨ - çŠ¶æ€ä¸‹é™æ›´å¿«ï¼Œéœ€è¦æ›´å¤šå…³æ³¨');
        console.log('âœ… æ­»äº¡ä¿æŠ¤æœºåˆ¶ - é•¿æ—¶é—´ç¦»çº¿ä¸ä¼šç›´æ¥æ­»äº¡');
        console.log('âœ… çœŸå®çš„å…»æˆä½“éªŒ - åƒçœŸæ­£çš„å® ç‰©ä¸€æ ·éœ€è¦æŒç»­ç…§é¡¾');

        return true;
    };

    /**
     * æµ‹è¯•æ–°çš„æ•°å€¼å¹³è¡¡ä½“éªŒ
     */
    window.testNewValueBalance = function() {
        console.log('ğŸ® æµ‹è¯•æ–°çš„æ•°å€¼å¹³è¡¡ä½“éªŒ...');

        // å…ˆåº”ç”¨æ–°çš„åˆå§‹æ•°å€¼
        adjustInitialValues();

        console.log('\nğŸ“Š èµ·å§‹çŠ¶æ€:');
        console.log(`- å¥åº·: ${petData.health}/100 (${petData.health < 30 ? 'éœ€è¦ç…§é¡¾' : 'è‰¯å¥½'})`);
        console.log(`- å¿«ä¹: ${petData.happiness}/100 (${petData.happiness < 30 ? 'éœ€è¦äº’åŠ¨' : 'è‰¯å¥½'})`);
        console.log(`- é¥±é£Ÿ: ${petData.hunger}/100 (${petData.hunger < 40 ? 'éœ€è¦å–‚é£Ÿ' : 'è‰¯å¥½'})`);
        console.log(`- ç²¾åŠ›: ${petData.energy}/100 (${petData.energy < 40 ? 'éœ€è¦ä¼‘æ¯' : 'è‰¯å¥½'})`);

        console.log('\nğŸ¯ æ¨¡æ‹Ÿç…§é¡¾æµç¨‹:');

        // æ¨¡æ‹Ÿå–‚é£Ÿ
        console.log('\n1. ğŸ– å–‚é£Ÿæ•ˆæœ:');
        const oldHunger = petData.hunger;
        const oldHappiness1 = petData.happiness;
        petData.hunger = Math.min(100, petData.hunger + 20);
        petData.happiness = Math.min(100, petData.happiness + 5);
        console.log(`   é¥±é£Ÿåº¦: ${oldHunger} â†’ ${petData.hunger} (+${petData.hunger - oldHunger})`);
        console.log(`   å¿«ä¹åº¦: ${oldHappiness1} â†’ ${petData.happiness} (+${petData.happiness - oldHappiness1})`);
        console.log(`   æ•ˆæœ: ${petData.hunger >= 40 ? 'âœ… é¥±è¶³äº†' : 'âš ï¸ è¿˜éœ€è¦æ›´å¤šé£Ÿç‰©'}`);

        // æ¨¡æ‹Ÿç©è€
        console.log('\n2. ğŸ® ç©è€æ•ˆæœ:');
        const oldHappiness2 = petData.happiness;
        const oldEnergy = petData.energy;
        petData.happiness = Math.min(100, petData.happiness + 15);
        petData.energy = Math.max(0, petData.energy - 10);
        console.log(`   å¿«ä¹åº¦: ${oldHappiness2} â†’ ${petData.happiness} (+${petData.happiness - oldHappiness2})`);
        console.log(`   ç²¾åŠ›: ${oldEnergy} â†’ ${petData.energy} (${petData.energy - oldEnergy})`);
        console.log(`   æ•ˆæœ: ${petData.happiness >= 50 ? 'âœ… å¾ˆå¼€å¿ƒ' : 'âš ï¸ è¿˜éœ€è¦æ›´å¤šäº’åŠ¨'}`);

        // æ¨¡æ‹Ÿç¡è§‰
        console.log('\n3. ğŸ˜´ ç¡è§‰æ•ˆæœ:');
        const oldEnergy2 = petData.energy;
        const oldHealth = petData.health;
        petData.energy = Math.min(100, petData.energy + 25);
        petData.health = Math.min(100, petData.health + 10);
        console.log(`   ç²¾åŠ›: ${oldEnergy2} â†’ ${petData.energy} (+${petData.energy - oldEnergy2})`);
        console.log(`   å¥åº·: ${oldHealth} â†’ ${petData.health} (+${petData.health - oldHealth})`);
        console.log(`   æ•ˆæœ: ${petData.energy >= 60 ? 'âœ… ç²¾åŠ›å……æ²›' : 'âš ï¸ è¿˜éœ€è¦æ›´å¤šä¼‘æ¯'}`);

        console.log('\nğŸ“ˆ ç…§é¡¾åçŠ¶æ€:');
        console.log(`- å¥åº·: ${petData.health}/100 (${petData.health >= 50 ? 'âœ… å¥åº·' : 'âš ï¸ éœ€è¦æ›´å¤šç…§é¡¾'})`);
        console.log(`- å¿«ä¹: ${petData.happiness}/100 (${petData.happiness >= 50 ? 'âœ… å¿«ä¹' : 'âš ï¸ éœ€è¦æ›´å¤šäº’åŠ¨'})`);
        console.log(`- é¥±é£Ÿ: ${petData.hunger}/100 (${petData.hunger >= 50 ? 'âœ… é¥±è¶³' : 'âš ï¸ éœ€è¦æ›´å¤šé£Ÿç‰©'})`);
        console.log(`- ç²¾åŠ›: ${petData.energy}/100 (${petData.energy >= 60 ? 'âœ… å……æ²›' : 'âš ï¸ éœ€è¦æ›´å¤šä¼‘æ¯'})`);

        console.log('\nğŸ’¡ æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿçš„ä¼˜åŠ¿:');
        console.log('âœ… é¦–æ¬¡æ‰“å¼€éšæœºåŒ–åˆ°50ä»¥ä¸‹ï¼Œåç»­å¯è¾¾100');
        console.log('âœ… æ¯æ¬¡äº’åŠ¨éƒ½æœ‰æ˜¾è‘—çš„æ”¹å–„æ•ˆæœ');
        console.log('âœ… ç©å®¶èƒ½æ¸…æ¥šæ„Ÿå—åˆ°ç…§é¡¾çš„ä»·å€¼');
        console.log('âœ… è‡ªç„¶çš„æ—¶é—´è¡°å‡ï¼Œä¸å¼ºåˆ¶é‡ç½®');
        console.log('âœ… å¹³è¡¡çš„æŒ‘æˆ˜æ€§å’Œæˆé•¿æ„Ÿ');

        // ä¿å­˜æµ‹è¯•åçš„çŠ¶æ€
        savePetData();
        if (typeof updateUnifiedUIStatus === 'function') {
            updateUnifiedUIStatus();
        }

        return {
            startValues: { health: 35, happiness: 30, hunger: 40, energy: 45 },
            endValues: {
                health: petData.health,
                happiness: petData.happiness,
                hunger: petData.hunger,
                energy: petData.energy
            },
            maxCap: 100,
            improvement: 'æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿï¼šé¦–æ¬¡éšæœºåŒ–ï¼Œåç»­è‡ªç„¶è¡°å‡'
        };
    };

    /**
     * æµ‹è¯•æŠ±æŠ±åŠŸèƒ½
     */
    window.testHugFunction = function() {
        console.log('ğŸ¤— æµ‹è¯•æŠ±æŠ±åŠŸèƒ½...');

        // æ£€æŸ¥æŠ±æŠ±å‡½æ•°æ˜¯å¦å­˜åœ¨
        console.log('\nğŸ“‹ å‡½æ•°æ£€æŸ¥:');
        console.log(`- hugPetå‡½æ•°å­˜åœ¨: ${typeof hugPet === 'function' ? 'âœ…' : 'âŒ'}`);
        console.log(`- window.hugPetå‡½æ•°å­˜åœ¨: ${typeof window.hugPet === 'function' ? 'âœ…' : 'âŒ'}`);

        // æ£€æŸ¥UIæŒ‰é’®
        const popup = $("#virtual-pet-popup");
        if (popup.length > 0) {
            const hugBtn = popup.find(".hug-btn");
            console.log(`- æŠ±æŠ±æŒ‰é’®å­˜åœ¨: ${hugBtn.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${hugBtn.length})`);

            if (hugBtn.length > 0) {
                const events = $._data(hugBtn[0], 'events');
                console.log(`- æŠ±æŠ±æŒ‰é’®äº‹ä»¶: ${events ? Object.keys(events).join(', ') : 'æ— '}`);
            }
        } else {
            console.log('âš ï¸ å® ç‰©ç•Œé¢æœªæ‰“å¼€ï¼Œè¯·å…ˆè¿è¡Œ showPopup()');
        }

        // æ£€æŸ¥æŠ±æŠ±å‡½æ•°å†…å®¹
        if (typeof window.hugPet === 'function') {
            const hugPetCode = window.hugPet.toString();
            console.log('\nğŸ“ æŠ±æŠ±å‡½æ•°åˆ†æ:');
            console.log(`- åŒ…å«gainCoins: ${hugPetCode.includes('gainCoins') ? 'âœ…' : 'âŒ'}`);
            console.log(`- åŒ…å«gainExperience: ${hugPetCode.includes('gainExperience') ? 'âœ…' : 'âŒ'}`);
            console.log(`- åŒ…å«handleAIReply: ${hugPetCode.includes('handleAIReply') ? 'âœ…' : 'âŒ'}`);
            console.log(`- å†·å´æ—¶é—´: ${hugPetCode.includes('25000') ? '25ç§’ âœ…' : 'æœªçŸ¥ âŒ'}`);
            console.log(`- å¥–åŠ±è®¾ç½®: ${hugPetCode.includes('coins: 2') && hugPetCode.includes('experience: 1') ? 'é‡‘å¸2+ç»éªŒ1 âœ…' : 'æœªçŸ¥ âŒ'}`);
        }

        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        console.log('\nğŸ“Š å½“å‰çŠ¶æ€:');
        console.log(`- å¥åº·: ${petData.health}/100`);
        console.log(`- å¿«ä¹: ${petData.happiness}/100`);
        console.log(`- é‡‘å¸: ${petData.coins || 100}`);
        console.log(`- ç»éªŒ: ${petData.experience || 0}`);
        console.log(`- ä¸Šæ¬¡æŠ±æŠ±æ—¶é—´: ${petData.lastHugTime ? new Date(petData.lastHugTime).toLocaleTimeString() : 'ä»æœª'}`);

        // æ£€æŸ¥å†·å´çŠ¶æ€
        if (petData.lastHugTime) {
            const now = Date.now();
            const timeSinceLastHug = now - petData.lastHugTime;
            const cooldownRemaining = Math.max(0, 25000 - timeSinceLastHug);

            console.log('\nâ° å†·å´çŠ¶æ€:');
            console.log(`- è·ç¦»ä¸Šæ¬¡æŠ±æŠ±: ${Math.round(timeSinceLastHug / 1000)}ç§’`);
            console.log(`- å†·å´å‰©ä½™: ${Math.round(cooldownRemaining / 1000)}ç§’`);
            console.log(`- å¯ä»¥æŠ±æŠ±: ${cooldownRemaining === 0 ? 'âœ…' : 'âŒ'}`);
        }

        console.log('\nğŸ’¡ æŠ±æŠ±åŠŸèƒ½ç‰¹ç‚¹:');
        console.log('âœ… 25ç§’å†·å´æ—¶é—´ï¼ˆæ¯”å…¶ä»–äº’åŠ¨æ›´çŸ­ï¼‰');
        console.log('âœ… å¢åŠ å¿«ä¹åº¦+10ï¼Œå¥åº·åº¦+3');
        console.log('âœ… å¢åŠ çºªå¾‹æ€§+2');
        console.log('âœ… å‡å°‘ç–¾ç—…-3ï¼ˆå¦‚æœç”Ÿç—…ï¼‰');
        console.log('âœ… å¥–åŠ±ï¼š2é‡‘å¸ + 1ç»éªŒ');
        console.log('âœ… å‡å°‘å¿½è§†è®¡æ•°');

        return {
            functionExists: typeof window.hugPet === 'function',
            buttonExists: popup.length > 0 && popup.find(".hug-btn").length > 0,
            canHug: !petData.lastHugTime || (Date.now() - petData.lastHugTime) >= 25000,
            isAlive: petData.isAlive
        };
    };

    /**
     * å®Œæ•´æµ‹è¯•æŠ±æŠ±åŠŸèƒ½ï¼ˆåŒ…æ‹¬å‰åæ£€æŸ¥ï¼‰
     */
    window.testHugFunctionComplete = function() {
        console.log('ğŸ¤— å®Œæ•´æµ‹è¯•æŠ±æŠ±åŠŸèƒ½ï¼ˆåŒ…æ‹¬å‰åæ£€æŸ¥ï¼‰...');

        // 1. æ£€æŸ¥å‡½æ•°å®ç°
        console.log('\nğŸ“‹ 1. å‡½æ•°å®ç°æ£€æŸ¥:');
        const hugFunctionExists = typeof window.hugPet === 'function';
        console.log(`- hugPetå‡½æ•°å­˜åœ¨: ${hugFunctionExists ? 'âœ…' : 'âŒ'}`);

        if (hugFunctionExists) {
            const hugCode = window.hugPet.toString();
            console.log(`- åŒ…å«é‡‘å¸å¥–åŠ±: ${hugCode.includes('gainCoins') ? 'âœ…' : 'âŒ'}`);
            console.log(`- åŒ…å«ç»éªŒå¥–åŠ±: ${hugCode.includes('gainExperience') ? 'âœ…' : 'âŒ'}`);
            console.log(`- åŒ…å«AIå›å¤: ${hugCode.includes('handleAIReply') ? 'âœ…' : 'âŒ'}`);
            console.log(`- å†·å´æ—¶é—´è®¾ç½®: ${hugCode.includes('25000') ? '25ç§’ âœ…' : 'âŒ'}`);
            console.log(`- å¥–åŠ±é…ç½®: ${hugCode.includes('coins: 2') && hugCode.includes('experience: 1') ? '2é‡‘å¸+1ç»éªŒ âœ…' : 'âŒ'}`);
        }

        // 2. æ£€æŸ¥UIæŒ‰é’®
        console.log('\nğŸ–±ï¸ 2. UIæŒ‰é’®æ£€æŸ¥:');
        const popup = $("#virtual-pet-popup");
        if (popup.length > 0) {
            const hugBtn = popup.find(".hug-btn");
            console.log(`- æŠ±æŠ±æŒ‰é’®å­˜åœ¨: ${hugBtn.length > 0 ? 'âœ…' : 'âŒ'} (æ•°é‡: ${hugBtn.length})`);

            if (hugBtn.length > 0) {
                const events = $._data(hugBtn[0], 'events');
                console.log(`- æŒ‰é’®äº‹ä»¶ç»‘å®š: ${events ? 'âœ… ' + Object.keys(events).join(', ') : 'âŒ æ— '}`);
                console.log(`- æŒ‰é’®æ ·å¼: ${hugBtn.css('background-color') ? 'âœ… æœ‰æ ·å¼' : 'âŒ æ— æ ·å¼'}`);
            }
        } else {
            console.log('âš ï¸ å® ç‰©ç•Œé¢æœªæ‰“å¼€ï¼Œè¯·å…ˆè¿è¡Œ showPopup()');
        }

        // 3. æ£€æŸ¥æç¤ºè¯æ”¯æŒ
        console.log('\nğŸ“ 3. æç¤ºè¯æ”¯æŒæ£€æŸ¥:');
        try {
            const hugPrompt = buildInteractionPrompt('hug');
            const hasHugDescription = hugPrompt.includes('ç»™äº†æˆ‘ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±');
            console.log(`- æç¤ºè¯åŒ…å«æŠ±æŠ±æè¿°: ${hasHugDescription ? 'âœ…' : 'âŒ'}`);
            console.log(`- æç¤ºè¯é¿å…æ¸¸æˆæœºåˆ¶: ${hugPrompt.includes('ä¸è¦åœ¨å›å¤ä¸­æåŠé‡‘å¸') ? 'âœ…' : 'âŒ'}`);
        } catch (error) {
            console.log(`âŒ æç¤ºè¯ç”Ÿæˆå¤±è´¥: ${error.message}`);
        }

        // 4. æµ‹è¯•åŠŸèƒ½æ‰§è¡Œ
        console.log('\nğŸ§ª 4. åŠŸèƒ½æ‰§è¡Œæµ‹è¯•:');
        const beforeState = {
            coins: petData.coins || 100,
            experience: petData.experience || 0,
            happiness: petData.happiness || 0,
            health: petData.health || 0,
            lastHugTime: petData.lastHugTime || 0
        };

        console.log('æµ‹è¯•å‰çŠ¶æ€:');
        console.log(`- é‡‘å¸: ${beforeState.coins}`);
        console.log(`- ç»éªŒ: ${beforeState.experience}`);
        console.log(`- å¿«ä¹: ${beforeState.happiness}`);
        console.log(`- å¥åº·: ${beforeState.health}`);

        // æ£€æŸ¥å†·å´çŠ¶æ€
        const now = Date.now();
        const timeSinceLastHug = now - beforeState.lastHugTime;
        const canHug = timeSinceLastHug >= 25000;
        console.log(`- å†·å´çŠ¶æ€: ${canHug ? 'âœ… å¯ä»¥æŠ±æŠ±' : `âŒ è¿˜éœ€ç­‰å¾…${Math.ceil((25000 - timeSinceLastHug) / 1000)}ç§’`}`);

        if (canHug && hugFunctionExists) {
            console.log('\nğŸ¯ æ‰§è¡ŒæŠ±æŠ±æµ‹è¯•...');

            // è®¾ç½®è¿½è¸ª
            let coinsGained = false;
            let expGained = false;

            const originalGainCoins = window.gainCoins;
            const originalGainExp = window.gainExperience;

            window.gainCoins = function(amount) {
                console.log(`ğŸ” [è¿½è¸ª] gainCoinsè¢«è°ƒç”¨: +${amount}`);
                coinsGained = true;
                return originalGainCoins.call(this, amount);
            };

            window.gainExperience = function(exp) {
                console.log(`ğŸ” [è¿½è¸ª] gainExperienceè¢«è°ƒç”¨: +${exp}`);
                expGained = true;
                return originalGainExp.call(this, exp);
            };

            // æ‰§è¡ŒæŠ±æŠ±ï¼ˆä¸ç­‰å¾…AIå›å¤ï¼‰
            try {
                window.hugPet();

                setTimeout(() => {
                    console.log('\nğŸ“Š æµ‹è¯•åçŠ¶æ€:');
                    console.log(`- é‡‘å¸: ${petData.coins} (å˜åŒ–: +${(petData.coins || 0) - beforeState.coins})`);
                    console.log(`- ç»éªŒ: ${petData.experience} (å˜åŒ–: +${(petData.experience || 0) - beforeState.experience})`);
                    console.log(`- å¿«ä¹: ${petData.happiness} (å˜åŒ–: +${petData.happiness - beforeState.happiness})`);
                    console.log(`- å¥åº·: ${petData.health} (å˜åŒ–: +${petData.health - beforeState.health})`);

                    console.log('\nğŸ” å¥–åŠ±å‡½æ•°è°ƒç”¨:');
                    console.log(`- gainCoinsè¢«è°ƒç”¨: ${coinsGained ? 'âœ…' : 'âŒ'}`);
                    console.log(`- gainExperienceè¢«è°ƒç”¨: ${expGained ? 'âœ…' : 'âŒ'}`);

                    // æ¢å¤åŸå§‹å‡½æ•°
                    window.gainCoins = originalGainCoins;
                    window.gainExperience = originalGainExp;

                    // ç»¼åˆè¯„ä¼°
                    const allGood = hugFunctionExists && coinsGained && expGained &&
                                   (petData.coins > beforeState.coins) &&
                                   (petData.experience > beforeState.experience);

                    console.log('\nğŸ‰ ç»¼åˆè¯„ä¼°:');
                    if (allGood) {
                        console.log('âœ… æŠ±æŠ±åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼');
                        toastr.success('ğŸ¤— æŠ±æŠ±åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼', '', { timeOut: 3000 });
                    } else {
                        console.log('âŒ æŠ±æŠ±åŠŸèƒ½å­˜åœ¨é—®é¢˜');
                        toastr.warning('æŠ±æŠ±åŠŸèƒ½éœ€è¦æ£€æŸ¥', '', { timeOut: 3000 });
                    }
                }, 1000);

            } catch (error) {
                console.log(`âŒ æŠ±æŠ±æ‰§è¡Œå¤±è´¥: ${error.message}`);
                // æ¢å¤åŸå§‹å‡½æ•°
                window.gainCoins = originalGainCoins;
                window.gainExperience = originalGainExp;
            }
        }

        console.log('\nğŸ’¡ æŠ±æŠ±åŠŸèƒ½ç‰¹ç‚¹:');
        console.log('âœ… 25ç§’å†·å´æ—¶é—´');
        console.log('âœ… +10å¿«ä¹åº¦, +3å¥åº·åº¦');
        console.log('âœ… +2çºªå¾‹æ€§, -1å¿½è§†è®¡æ•°');
        console.log('âœ… å‡å°‘ç–¾ç—…-3ï¼ˆå¦‚æœç”Ÿç—…ï¼‰');
        console.log('âœ… å¥–åŠ±ï¼š2é‡‘å¸ + 1ç»éªŒ');
        console.log('âœ… AIå›å¤æ”¯æŒ');

        return {
            functionExists: hugFunctionExists,
            buttonExists: popup.length > 0 && popup.find(".hug-btn").length > 0,
            canHug: canHug,
            isAlive: petData.isAlive
        };
    };

    // æ£€æŸ¥localStorageä¸­çš„æ•°æ®
    window.checkStoredData = function() {
        console.log("ğŸ’¾ æ£€æŸ¥localStorageä¸­çš„æ•°æ®...");

        const stored = localStorage.getItem(STORAGE_KEY_PET_DATA);
        if (stored) {
            try {
                const data = JSON.parse(stored);
                console.log("å­˜å‚¨çš„æ•°æ®:", data);
                console.log(`æ•°æ®ç‰ˆæœ¬: ${data.dataVersion || 'æœªè®¾ç½®'}`);
                console.log(`å¥åº·: ${data.health}`);
                console.log(`å¿«ä¹åº¦: ${data.happiness}`);
                console.log(`é¥±é£Ÿåº¦: ${data.hunger}`);
                console.log(`ç²¾åŠ›: ${data.energy}`);
            } catch (e) {
                console.error("è§£æå­˜å‚¨æ•°æ®å¤±è´¥:", e);
            }
        } else {
            console.log("æ²¡æœ‰æ‰¾åˆ°å­˜å‚¨çš„æ•°æ®");
        }
    };

    // æµ‹è¯•å¤´åƒåŠŸèƒ½
    window.testAvatarFunction = function() {
        console.log("ğŸ¯ æµ‹è¯•å¤´åƒåŠŸèƒ½...");

        // æ£€æŸ¥å¤´åƒç›¸å…³å‡½æ•°æ˜¯å¦å­˜åœ¨
        const functions = {
            openAvatarSelector: typeof window.openAvatarSelector === 'function',
            resetAvatar: typeof window.resetAvatar === 'function',
            getAvatarContent: typeof getAvatarContent === 'function',
            loadCustomAvatar: typeof loadCustomAvatar === 'function',
            saveCustomAvatar: typeof saveCustomAvatar === 'function',
            clearCustomAvatar: typeof clearCustomAvatar === 'function'
        };

        console.log("å‡½æ•°æ£€æŸ¥:");
        Object.entries(functions).forEach(([name, exists]) => {
            console.log(`  ${exists ? 'âœ…' : 'âŒ'} ${name}`);
        });

        // æ£€æŸ¥å½“å‰å¤´åƒçŠ¶æ€
        console.log(`å½“å‰è‡ªå®šä¹‰å¤´åƒ: ${customAvatarData ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);

        // æ£€æŸ¥æ‚¬æµ®æŒ‰é’®å¤´åƒ
        const button = $(`#${BUTTON_ID}`);
        if (button.length > 0) {
            const hasCustomImage = button.find('img').length > 0;
            const hasDefaultEmoji = button.text().includes('ğŸ¾');
            console.log(`æ‚¬æµ®æŒ‰é’®å¤´åƒ: ${hasCustomImage ? 'è‡ªå®šä¹‰å›¾ç‰‡' : hasDefaultEmoji ? 'é»˜è®¤çˆªå­' : 'æœªçŸ¥'}`);
        } else {
            console.log("âŒ æ‚¬æµ®æŒ‰é’®ä¸å­˜åœ¨");
        }

        // æ£€æŸ¥å¼¹çª—ä¸­çš„å¤´åƒ
        const avatarCircle = $('.pet-avatar-circle');
        if (avatarCircle.length > 0) {
            const hasCustomImage = avatarCircle.find('img').length > 0;
            console.log(`å¼¹çª—å¤´åƒ: ${hasCustomImage ? 'è‡ªå®šä¹‰å›¾ç‰‡' : 'é»˜è®¤è¡¨æƒ…'}`);
            console.log(`å¤´åƒæ¡†æ•°é‡: ${avatarCircle.length}`);
        } else {
            console.log("å¼¹çª—å¤´åƒ: æœªæ‰¾åˆ°å¤´åƒæ¡†");
        }

        // æ£€æŸ¥å¤´åƒäº¤äº’åŠŸèƒ½
        const avatarCircleClickable = $('.pet-avatar-circle[onclick]').length > 0;
        const avatarCircleContextMenu = $('.pet-avatar-circle[oncontextmenu]').length > 0;
        console.log(`å¤´åƒç‚¹å‡»åŠŸèƒ½: ${avatarCircleClickable ? 'âœ…' : 'âŒ'}`);
        console.log(`å¤´åƒå³é”®åŠŸèƒ½: ${avatarCircleContextMenu ? 'âœ…' : 'âŒ'}`);
        console.log(`å³é”®èœå•å‡½æ•°: ${typeof window.showAvatarContextMenu === 'function' ? 'âœ…' : 'âŒ'}`);

        const allFunctionsExist = Object.values(functions).every(exists => exists);
        console.log(`\nğŸ‰ å¤´åƒåŠŸèƒ½æµ‹è¯•: ${allFunctionsExist ? 'æ‰€æœ‰åŠŸèƒ½å°±ç»ªï¼' : 'éƒ¨åˆ†åŠŸèƒ½ç¼ºå¤±'}`);

        if (allFunctionsExist) {
            console.log("ğŸ“‹ ä½¿ç”¨è¯´æ˜:");
            console.log("  ğŸ¨ å¤´åƒåŠŸèƒ½:");
            console.log("    - ç‚¹å‡»åœ†å½¢å¤´åƒæ¡†å¯ä»¥æ›´æ¢å¤´åƒ");
            console.log("    - å³é”®ç‚¹å‡»å¤´åƒæ¡†å¯ä»¥é‡ç½®ä¸ºé»˜è®¤å¤´åƒ");
            console.log("    - è‡ªå®šä¹‰å¤´åƒä¼šåŒæ—¶æ˜¾ç¤ºåœ¨å¼¹çª—å’Œæ‚¬æµ®æŒ‰é’®ä¸­");
            console.log("  ğŸ“ åå­—åŠŸèƒ½:");
            console.log("    - ç‚¹å‡»å® ç‰©åå­—å¯ä»¥ç¼–è¾‘ä¿®æ”¹");
            console.log("    - æ”¯æŒæœ€å¤š20ä¸ªå­—ç¬¦çš„è‡ªå®šä¹‰åå­—");
            console.log("  ğŸ® äº¤äº’åŠŸèƒ½:");
            console.log("    - ğŸ– å–‚é£Ÿï¼š+15é¥±é£Ÿåº¦, +5å¿«ä¹åº¦ (20ç§’å†·å´)");
            console.log("    - ğŸ® ç©è€ï¼š+12å¿«ä¹åº¦, -8ç²¾åŠ› (40ç§’å†·å´)");
            console.log("    - ğŸ˜´ ç¡è§‰ï¼š+20ç²¾åŠ›, +5å¥åº· (80ç§’å†·å´)");
            console.log("  ğŸ¨ ç•Œé¢ç‰¹è‰²:");
            console.log("    - ç³–æœè‰²ä¸»é¢˜ï¼Œæ˜äº®æ¸…æ–°");
            console.log("    - æ— èƒŒæ™¯æ¡†æ¶ï¼Œå…ƒç´ èå…¥èƒŒæ™¯");
            console.log("    - å®æ—¶æ•°å€¼æ›´æ–°ï¼ŒçŠ¶æ€æ¡åŠ¨ç”»");
            console.log("  âš–ï¸ æ•°å€¼å¹³è¡¡:");
            console.log("    - åˆå§‹æ•°å€¼ï¼šå¥åº·40, å¿«ä¹30, é¥±é£Ÿ50, ç²¾åŠ›60");
            console.log("    - æ—¶é—´è¡°å‡ï¼šæ¯12åˆ†é’Ÿæ›´æ–°ï¼Œé€Ÿåº¦å‡ç¼“");
            console.log("    - æ“ä½œå†·å´ï¼šå–‚é£Ÿ20s, ç©è€40s, ç¡è§‰80s");
        }

        return allFunctionsExist;
    };

    // æ¨¡æ‹Ÿè®¾ç½®æµ‹è¯•å¤´åƒ
    window.setTestAvatar = function() {
        console.log("ğŸ¯ è®¾ç½®æµ‹è¯•å¤´åƒ...");

        // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾ç‰‡ (1x1åƒç´ çš„çº¢è‰²å›¾ç‰‡)
        const canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');

        // ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾æ¡ˆ
        ctx.fillStyle = '#7289da';
        ctx.fillRect(0, 0, 100, 100);
        ctx.fillStyle = '#ffffff';
        ctx.font = '60px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ğŸ±', 50, 70);

        const testImageData = canvas.toDataURL('image/png');

        if (saveCustomAvatar(testImageData)) {
            updateAvatarDisplay();
            updateFloatingButtonAvatar();
            console.log("âœ… æµ‹è¯•å¤´åƒè®¾ç½®æˆåŠŸ");
            console.log("ç°åœ¨å¯ä»¥çœ‹åˆ°è‡ªå®šä¹‰å¤´åƒæ•ˆæœ");
        } else {
            console.log("âŒ æµ‹è¯•å¤´åƒè®¾ç½®å¤±è´¥");
        }
    };

    // å…¨é¢çš„æ‹–åŠ¨åŠŸèƒ½éªŒè¯æµ‹è¯•
    window.validateDragFix = function() {
        console.log("ğŸ§ª å¼€å§‹å…¨é¢éªŒè¯æ‹–åŠ¨ä¿®å¤...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨ï¼Œæ— æ³•æµ‹è¯•");
            return false;
        }

        let testResults = {
            buttonExists: true,
            positionCorrect: false,
            eventsbound: false,
            dragWorks: false,
            boundaryWorks: false,
            visualFeedback: false
        };

        // æµ‹è¯•1: æ£€æŸ¥æŒ‰é’®ä½ç½®
        const rect = button[0].getBoundingClientRect();
        const inViewport = rect.top >= 0 && rect.left >= 0 &&
                          rect.bottom <= window.innerHeight && rect.right <= window.innerWidth;
        testResults.positionCorrect = inViewport;
        console.log(`âœ… ä½ç½®æµ‹è¯•: ${inViewport ? 'é€šè¿‡' : 'å¤±è´¥'} - ä½ç½®: (${rect.left}, ${rect.top})`);

        // æµ‹è¯•2: æ£€æŸ¥äº‹ä»¶ç»‘å®š
        const events = $._data(button[0], "events");
        const hasEvents = events && (events.mousedown || events.touchstart);
        testResults.eventsbound = hasEvents;
        console.log(`âœ… äº‹ä»¶ç»‘å®šæµ‹è¯•: ${hasEvents ? 'é€šè¿‡' : 'å¤±è´¥'}`);

        // æµ‹è¯•3: æ¨¡æ‹Ÿæ‹–åŠ¨
        console.log("ğŸ¯ å¼€å§‹æ‹–åŠ¨æµ‹è¯•...");
        const originalPos = { left: rect.left, top: rect.top };
        const testPos = { left: 300, top: 300 };

        // ç›´æ¥è®¾ç½®ä½ç½®æµ‹è¯•
        button[0].style.setProperty('left', testPos.left + 'px', 'important');
        button[0].style.setProperty('top', testPos.top + 'px', 'important');

        setTimeout(() => {
            const newRect = button[0].getBoundingClientRect();
            const moved = Math.abs(newRect.left - testPos.left) < 5 && Math.abs(newRect.top - testPos.top) < 5;
            testResults.dragWorks = moved;
            console.log(`âœ… æ‹–åŠ¨æµ‹è¯•: ${moved ? 'é€šè¿‡' : 'å¤±è´¥'} - æ–°ä½ç½®: (${newRect.left}, ${newRect.top})`);

            // æ¢å¤åŸä½ç½®
            button[0].style.setProperty('left', originalPos.left + 'px', 'important');
            button[0].style.setProperty('top', originalPos.top + 'px', 'important');

            // æµ‹è¯•4: è¾¹ç•Œé™åˆ¶
            console.log("ğŸ¯ æµ‹è¯•è¾¹ç•Œé™åˆ¶...");
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            // æµ‹è¯•è¶…å‡ºè¾¹ç•Œçš„ä½ç½®
            button[0].style.setProperty('left', (windowWidth + 100) + 'px', 'important');
            button[0].style.setProperty('top', (windowHeight + 100) + 'px', 'important');

            setTimeout(() => {
                const boundaryRect = button[0].getBoundingClientRect();
                const staysInBounds = boundaryRect.left < windowWidth && boundaryRect.top < windowHeight;
                testResults.boundaryWorks = staysInBounds;
                console.log(`âœ… è¾¹ç•Œæµ‹è¯•: ${staysInBounds ? 'é€šè¿‡' : 'å¤±è´¥'}`);

                // æ¢å¤åŸä½ç½®
                button[0].style.setProperty('left', originalPos.left + 'px', 'important');
                button[0].style.setProperty('top', originalPos.top + 'px', 'important');

                // æµ‹è¯•5: è§†è§‰åé¦ˆ
                console.log("ğŸ¯ æµ‹è¯•è§†è§‰åé¦ˆ...");
                button.addClass('dragging');
                const hasDraggingClass = button.hasClass('dragging');
                button.removeClass('dragging');
                testResults.visualFeedback = hasDraggingClass;
                console.log(`âœ… è§†è§‰åé¦ˆæµ‹è¯•: ${hasDraggingClass ? 'é€šè¿‡' : 'å¤±è´¥'}`);

                // è¾“å‡ºæ€»ç»“
                const passedTests = Object.values(testResults).filter(result => result).length;
                const totalTests = Object.keys(testResults).length;

                console.log("\nğŸ¯ æµ‹è¯•æ€»ç»“:");
                console.log(`é€šè¿‡: ${passedTests}/${totalTests} é¡¹æµ‹è¯•`);
                Object.entries(testResults).forEach(([test, result]) => {
                    console.log(`${result ? 'âœ…' : 'âŒ'} ${test}`);
                });

                if (passedTests === totalTests) {
                    console.log("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ‹–åŠ¨åŠŸèƒ½ä¿®å¤æˆåŠŸï¼");
                } else {
                    console.log("âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•");
                }

                return testResults;
            }, 100);
        }, 100);

        return testResults;
    };

    // æ‹–åŠ¨åŠŸèƒ½æµ‹è¯•å’Œè¯Šæ–­
    window.testDragFunction = function() {
        console.log("ğŸ§ª æµ‹è¯•æ‹–åŠ¨åŠŸèƒ½...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨ï¼Œæ— æ³•æµ‹è¯•æ‹–åŠ¨");
            return false;
        }

        console.log("âœ… æŒ‰é’®å­˜åœ¨ï¼Œå¼€å§‹æ‹–åŠ¨æµ‹è¯•");

        // æ£€æŸ¥å½“å‰ä½ç½®
        const rect = button[0].getBoundingClientRect();
        console.log("å½“å‰ä½ç½®:", {
            left: rect.left,
            top: rect.top,
            width: rect.width,
            height: rect.height
        });

        // æ£€æŸ¥äº‹ä»¶ç»‘å®š
        const events = $._data(button[0], "events");
        console.log("ç»‘å®šçš„äº‹ä»¶:", events ? Object.keys(events) : "æ— ");

        // æ¨¡æ‹Ÿæ‹–åŠ¨åˆ°æµ‹è¯•ä½ç½®
        const testX = 300;
        const testY = 300;

        console.log(`ç§»åŠ¨æŒ‰é’®åˆ°æµ‹è¯•ä½ç½®: (${testX}, ${testY})`);
        button.css({
            'position': 'fixed',
            'left': testX + 'px',
            'top': testY + 'px'
        });

        // éªŒè¯ç§»åŠ¨ç»“æœ
        setTimeout(() => {
            const newRect = button[0].getBoundingClientRect();
            const success = Math.abs(newRect.left - testX) < 5 && Math.abs(newRect.top - testY) < 5;
            console.log(success ? "âœ… æ‹–åŠ¨æµ‹è¯•æˆåŠŸ" : "âŒ æ‹–åŠ¨æµ‹è¯•å¤±è´¥");
            console.log("æ–°ä½ç½®:", { left: newRect.left, top: newRect.top });

            // ä¿å­˜æµ‹è¯•ä½ç½®
            if (success) {
                localStorage.setItem(STORAGE_KEY_BUTTON_POS, JSON.stringify({
                    x: testX,
                    y: testY
                }));
                console.log("âœ… æµ‹è¯•ä½ç½®å·²ä¿å­˜");
            }
        }, 100);

        return true;
    };

    // æ‹–åŠ¨é—®é¢˜è¯Šæ–­
    window.diagnoseDragIssues = function() {
        console.log("ğŸ” è¯Šæ–­æ‹–åŠ¨é—®é¢˜...");

        const button = $(`#${BUTTON_ID}`);
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return;
        }

        // æ£€æŸ¥åŸºç¡€æ ·å¼
        const styles = window.getComputedStyle(button[0]);
        console.log("æ ·å¼æ£€æŸ¥:", {
            position: styles.position,
            zIndex: styles.zIndex,
            cursor: styles.cursor,
            pointerEvents: styles.pointerEvents,
            userSelect: styles.userSelect
        });

        // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
        const events = $._data(button[0], "events");
        if (events) {
            console.log("äº‹ä»¶ç›‘å¬å™¨:");
            Object.keys(events).forEach(eventType => {
                console.log(`- ${eventType}: ${events[eventType].length} ä¸ªç›‘å¬å™¨`);
            });
        } else {
            console.log("âŒ æ²¡æœ‰æ‰¾åˆ°äº‹ä»¶ç›‘å¬å™¨");
        }

        // æ£€æŸ¥ä½ç½®æ•°æ®
        const savedPos = localStorage.getItem(STORAGE_KEY_BUTTON_POS);
        if (savedPos) {
            try {
                const pos = JSON.parse(savedPos);
                console.log("ä¿å­˜çš„ä½ç½®:", pos);
            } catch (e) {
                console.log("âŒ ä½ç½®æ•°æ®æŸå:", savedPos);
            }
        } else {
            console.log("â„¹ï¸ æ²¡æœ‰ä¿å­˜çš„ä½ç½®æ•°æ®");
        }

        // æ£€æŸ¥è¾¹ç•Œ
        const rect = button[0].getBoundingClientRect();
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        console.log("è¾¹ç•Œæ£€æŸ¥:", {
            inBounds: rect.left >= 0 && rect.top >= 0 &&
                     rect.right <= windowWidth && rect.bottom <= windowHeight,
            position: { left: rect.left, top: rect.top },
            window: { width: windowWidth, height: windowHeight }
        });
    };

    // åˆ›å»ºä¸€ä¸ªæµ‹è¯•æŒ‰é’®æ¥è°ƒè¯•å¼¹çª—
    window.createTestPopupButton = function() {
        // ç§»é™¤ç°æœ‰çš„æµ‹è¯•æŒ‰é’®
        $("#test-popup-button").remove();

        // åˆ›å»ºæµ‹è¯•æŒ‰é’®
        const testButton = $(`
            <button id="test-popup-button" style="
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: ${SAFE_Z_INDEX.popup};
                background: #7289da;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            ">æµ‹è¯•å¼¹çª—</button>
        `);

        $("body").append(testButton);

        testButton.on("click touchend", function(e) {
            e.preventDefault();
            console.log("æµ‹è¯•æŒ‰é’®è¢«ç‚¹å‡»");
            try {
                showPopup();
                console.log("showPopup è°ƒç”¨æˆåŠŸ");
            } catch (error) {
                console.error("showPopup è°ƒç”¨å¤±è´¥:", error);
                alert("å¼¹çª—æµ‹è¯•å¤±è´¥: " + error.message);
            }
        });

        console.log("æµ‹è¯•æŒ‰é’®å·²åˆ›å»ºï¼Œä½äºå±å¹•å³ä¸Šè§’");
        return true;
    };

    // iOSä¸“ç”¨å¼¹çª—æ˜¾ç¤ºå‡½æ•°
    window.showIOSPopup = function() {
        console.log("ğŸ iOSä¸“ç”¨å¼¹çª—æ˜¾ç¤º");

        // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ç°æœ‰å¼¹çª—
        $("#virtual-pet-popup-overlay").remove();
        $(".virtual-pet-popup-overlay").remove();
        $("[id*='virtual-pet-popup']").remove();

        // åˆ›å»ºiOSä¼˜åŒ–çš„ç»Ÿä¸€å¼¹çª—
        const iosPopupHtml = `
            <div id="virtual-pet-popup-overlay" style="
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: rgba(0, 0, 0, 0.85) !important;
                z-index: ${SAFE_Z_INDEX.popup} !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 10px !important;
                box-sizing: border-box !important;
                -webkit-overflow-scrolling: touch !important;
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
            ">
                <div id="virtual-pet-popup" style="
                    position: relative !important;
                    width: calc(100vw - 30px) !important;
                    max-width: 300px !important;
                    max-height: calc(100vh - 60px) !important;
                    background: ${candyColors.background} !important;
                    color: ${candyColors.textPrimary} !important;
                    border-radius: 16px !important;
                    padding: 16px !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch !important;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.6) !important;
                    -webkit-transform: translateZ(0) !important;
                    transform: translateZ(0) !important;
                ">
                    ${generateUnifiedUI()}
                </div>
            </div>
        `;

        $("body").append(iosPopupHtml);

        // ç»‘å®šå¤–éƒ¨ç‚¹å‡»å…³é—­äº‹ä»¶
        const $iosOverlay = $("#virtual-pet-popup-overlay");

        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        $iosOverlay.on("click touchend", function(e) {
            if (e.target === this) {
                e.preventDefault();
                $iosOverlay.remove();
            }
        });

        // ç»‘å®šç»Ÿä¸€çš„æ“ä½œæŒ‰é’®äº‹ä»¶
        bindUnifiedUIEvents($iosOverlay);

        console.log("ğŸ iOSå¼¹çª—å·²åˆ›å»ºå¹¶æ˜¾ç¤º");
        return true;
    };

    // æµ‹è¯•ç»Ÿä¸€UIçš„å‡½æ•°
    window.testUnifiedUI = function() {
        console.log("ğŸ¨ æµ‹è¯•ç»Ÿä¸€UI...");

        // æ¸…ç†ç°æœ‰å¼¹çª—
        window.clearAllPopups();

        // æ£€æµ‹è®¾å¤‡ç±»å‹
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMobile = isIOS || isAndroid;

        console.log(`è®¾å¤‡æ£€æµ‹: iOS=${isIOS}, Android=${isAndroid}, Mobile=${isMobile}`);

        // å»¶è¿Ÿæ˜¾ç¤ºå¼¹çª—
        setTimeout(() => {
            console.log("æ˜¾ç¤ºç»Ÿä¸€UI");
            showPopup();
        }, 100);

        return true;
    };

    // ç§»åŠ¨ç«¯å°ºå¯¸æµ‹è¯•å‡½æ•°
    window.testMobileSize = function() {
        console.log("ğŸ“± æµ‹è¯•ç§»åŠ¨ç«¯å°ºå¯¸...");

        // è·å–å±å¹•ä¿¡æ¯
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const windowWidth = $(window).width();
        const windowHeight = $(window).height();

        console.log(`å±å¹•å°ºå¯¸: ${screenWidth}x${screenHeight}`);
        console.log(`çª—å£å°ºå¯¸: ${windowWidth}x${windowHeight}`);

        // æ£€æµ‹è®¾å¤‡ç±»å‹
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMobile = windowWidth <= 767;

        console.log(`è®¾å¤‡ç±»å‹: iOS=${isIOS}, Android=${isAndroid}, Mobile=${isMobile}`);

        // è®¡ç®—æ¨èçš„å¼¹çª—å°ºå¯¸
        const recommendedWidth = Math.min(300, windowWidth - 40);
        const recommendedHeight = Math.min(500, windowHeight - 100);

        console.log(`æ¨èå¼¹çª—å°ºå¯¸: ${recommendedWidth}x${recommendedHeight}`);

        // æ˜¾ç¤ºæµ‹è¯•å¼¹çª—
        window.clearAllPopups();
        setTimeout(() => {
            showPopup();
        }, 100);

        return {
            screen: { width: screenWidth, height: screenHeight },
            window: { width: windowWidth, height: windowHeight },
            device: { isIOS, isAndroid, isMobile },
            recommended: { width: recommendedWidth, height: recommendedHeight }
        };
    };

    // å®‰å“ä¸“ç”¨æµ‹è¯•å‡½æ•°
    window.testAndroidUI = function() {
        console.log("ğŸ¤– æµ‹è¯•å®‰å“UI...");

        // è·å–è®¾å¤‡ä¿¡æ¯
        const userAgent = navigator.userAgent;
        const windowWidth = $(window).width();
        const windowHeight = $(window).height();
        const isAndroid = /Android/.test(userAgent);
        const isMobile = windowWidth <= 767;

        console.log("è®¾å¤‡ä¿¡æ¯:");
        console.log("- User Agent:", userAgent);
        console.log("- çª—å£å°ºå¯¸:", windowWidth + "x" + windowHeight);
        console.log("- æ˜¯å¦å®‰å“:", isAndroid);
        console.log("- æ˜¯å¦ç§»åŠ¨ç«¯:", isMobile);

        // å¼ºåˆ¶æ¸…ç†ç°æœ‰å¼¹çª—
        window.clearAllPopups();

        // å»¶è¿Ÿæ˜¾ç¤ºå¼¹çª—
        setTimeout(() => {
            console.log("ğŸ¤– æ˜¾ç¤ºå®‰å“ä¼˜åŒ–UI");
            showPopup();
        }, 200);

        return {
            userAgent,
            windowSize: { width: windowWidth, height: windowHeight },
            isAndroid,
            isMobile
        };
    };

    // å¼ºåˆ¶åˆ·æ–°UIå‡½æ•°
    window.refreshUI = function() {
        console.log("ğŸ”„ å¼ºåˆ¶åˆ·æ–°UI...");

        // æ¸…ç†æ‰€æœ‰ç°æœ‰å¼¹çª—
        window.clearAllPopups();

        // ç­‰å¾…ä¸€ä¸‹å†é‡æ–°åˆ›å»º
        setTimeout(() => {
            const windowWidth = $(window).width();
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isMobile = windowWidth <= 767 || isIOS || isAndroid;

            console.log(`ğŸ”„ é‡æ–°ç”ŸæˆUI - Mobile: ${isMobile}, iOS: ${isIOS}, Android: ${isAndroid}, Width: ${windowWidth}`);

            showPopup();
        }, 300);

        return true;
    };

    // æ¸…ç†æ‰€æœ‰å¼¹çª—çš„å‡½æ•°
    window.clearAllPopups = function() {
        console.log("ğŸ§¹ æ¸…ç†æ‰€æœ‰å¼¹çª—...");

        // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„å¼¹çª—å…ƒç´ 
        $("#virtual-pet-popup-overlay").remove();
        $(".virtual-pet-popup-overlay").remove();
        $("[id*='virtual-pet-popup']").remove();
        $("[class*='virtual-pet-popup']").remove();
        $("[id*='pet-popup']").remove();
        $("[class*='pet-popup']").remove();

        console.log("âœ… æ‰€æœ‰å¼¹çª—å·²æ¸…ç†");
        return true;
    };

    // ç”Ÿæˆç»Ÿä¸€çš„UIå†…å®¹
    function generateUnifiedUI() {
        // æ£€æµ‹è®¾å¤‡ç±»å‹å’Œå±å¹•å°ºå¯¸
        const windowWidth = $(window).width();
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMobile = windowWidth <= 767 || isIOS || isAndroid;

        console.log(`[UI] Device: iOS=${isIOS}, Android=${isAndroid}, Mobile=${isMobile}, Width=${windowWidth}`);

        // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´å°ºå¯¸ - ä½¿ç”¨æ¡ä»¶åˆ¤æ–­è€Œä¸æ˜¯æ¨¡æ¿å­—ç¬¦ä¸²å˜é‡
        if (isMobile) {
            return generateMobileUI();
        } else {
            return generateDesktopUI();
        }
    }

    // ç”Ÿæˆç§»åŠ¨ç«¯UI
    function generateMobileUI() {
        console.log(`[UI] Generating mobile UI`);
        return `
            <div class="pet-popup-header" style="display: none;">
            </div>

            <div class="pet-main-content" style="
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            ">
                <!-- å® ç‰©å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
                <div class="pet-avatar-section" style="
                    text-align: center !important;
                    padding: 15px !important;
                ">
                    <!-- æ‹“éº»æ­Œå­é£æ ¼å¤´åƒæ¡† -->
                    <div class="pet-avatar-circle" style="
                        width: 70px !important;
                        height: 70px !important;
                        border-radius: 6px !important;
                        background: ${candyColors.screen} !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        font-size: 2.5em !important;
                        overflow: hidden !important;
                        border: 3px solid ${candyColors.border} !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        cursor: pointer !important;
                        margin: 0 auto 8px auto !important;
                        font-family: 'Courier New', monospace !important;
                        image-rendering: pixelated !important;
                        image-rendering: -moz-crisp-edges !important;
                        image-rendering: crisp-edges !important;
                    " onclick="openAvatarSelector()" oncontextmenu="showAvatarContextMenu(event)" title="ç‚¹å‡»æ›´æ¢å¤´åƒï¼Œå³é”®é‡ç½®">
                        ${getAvatarContent()}
                    </div>
                    <div class="pet-name" style="font-size: 1.2em !important; font-weight: bold !important; margin-bottom: 3px !important;">${escapeHtml(petData.name)}</div>
                    <div class="pet-level" style="color: #7289da !important; font-size: 0.9em !important;">${petData.isAlive ?
                        `${LIFE_STAGES[petData.lifeStage]?.emoji || 'ğŸ¾'} ${LIFE_STAGES[petData.lifeStage]?.name || 'æœªçŸ¥'} Lv.${petData.level}` :
                        'ğŸ’€ å·²æ­»äº¡'
                    }</div>
                </div>

                <!-- å® ç‰©çŠ¶æ€æ  -->
                <div class="pet-status-section" style="
                    padding: 10px !important;
                ">
                    <h4 style="margin: 0 0 10px 0 !important; color: ${candyColors.primary} !important; font-size: 0.9em !important;">ğŸ“Š çŠ¶æ€</h4>
                    <div class="status-bars" style="display: flex !important; flex-direction: column !important; gap: 6px !important;">
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 3px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.8em !important;">â¤ï¸ å¥åº·</span>
                                <span style="color: ${candyColors.health} !important; font-size: 0.8em !important;">${Math.round(petData.health)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 5px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.health} !important; height: 100% !important; width: ${petData.health}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 3px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.8em !important;">ğŸ– é¥±é£Ÿåº¦</span>
                                <span style="color: ${candyColors.hunger} !important; font-size: 0.8em !important;">${Math.round(petData.hunger)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 5px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.hunger} !important; height: 100% !important; width: ${petData.hunger}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 3px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.8em !important;">ğŸ˜Š å¿«ä¹åº¦</span>
                                <span style="color: ${candyColors.happiness} !important; font-size: 0.8em !important;">${Math.round(petData.happiness)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 5px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.happiness} !important; height: 100% !important; width: ${petData.happiness}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 3px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.8em !important;">âš¡ ç²¾åŠ›</span>
                                <span style="color: ${candyColors.energy} !important; font-size: 0.8em !important;">${Math.round(petData.energy)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 5px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.energy} !important; height: 100% !important; width: ${petData.energy}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é‡‘å¸æ˜¾ç¤º -->
                ${petData.dataVersion >= 4.0 ? `
                <div class="pet-coins-section" style="
                    text-align: center !important;
                    padding: 8px !important;
                    background: rgba(255,215,0,0.1) !important;
                    border-radius: 6px !important;
                    margin-bottom: 8px !important;
                ">
                    <span style="color: #ffd700 !important; font-weight: bold !important; font-size: 1em !important;">
                        ğŸ’° ${petData.coins || 100} é‡‘å¸
                    </span>
                </div>
                ` : ''}

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="pet-actions-section" style="
                    display: grid !important;
                    grid-template-columns: 1fr 1fr 1fr !important;
                    gap: 6px !important;
                ">
                    <button class="action-btn feed-btn" style="
                        padding: 8px !important;
                        background: ${candyColors.buttonPrimary} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: uppercase !important;
                        cursor: pointer !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1em !important;">ğŸ–</span>
                        <span>å–‚é£Ÿ</span>
                    </button>
                    <button class="action-btn play-btn" style="
                        padding: 8px !important;
                        background: ${candyColors.buttonSecondary} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1em !important;">ğŸ®</span>
                        <span>ç©è€</span>
                    </button>
                    <button class="action-btn sleep-btn" style="
                        padding: 8px !important;
                        background: ${candyColors.buttonAccent} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1em !important;">ğŸ˜´</span>
                        <span>ä¼‘æ¯</span>
                    </button>
                    <button class="action-btn hug-btn" style="
                        padding: 8px !important;
                        background: #FF69B4 !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1em !important;">ğŸ¤—</span>
                        <span>æŠ±æŠ±</span>
                    </button>
                    <button class="action-btn heal-btn" style="
                        padding: 8px !important;
                        background: ${(petData.sickness || 0) > 10 ? candyColors.health : candyColors.secondary} !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: uppercase !important;
                        cursor: ${(petData.sickness || 0) > 10 ? 'pointer' : 'not-allowed'} !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                        opacity: ${(petData.sickness || 0) > 10 ? '1' : '0.5'} !important;
                    ">
                        <span style="font-size: 1em !important;">ğŸ’Š</span>
                        <span>æ²»ç–—</span>
                    </button>
                    <button class="action-btn shop-btn" style="
                        padding: 8px !important;
                        background: ${candyColors.happiness} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1em !important;">ğŸ›’</span>
                        <span>å•†åº—</span>
                    </button>
                    <button class="action-btn chat-btn" style="
                        padding: 8px !important;
                        background: ${candyColors.info} !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1em !important;">ğŸ’¬</span>
                        <span>èŠå¤©</span>
                    </button>
                    <button class="action-btn settings-btn" style="
                        padding: 8px !important;
                        background: #8B5CF6 !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 11px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 36px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 4px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1em !important;">âš™ï¸</span>
                        <span>è®¾ç½®</span>
                    </button>
                </div>

                <!-- èŠå¤©è§†å›¾ (éšè—) -->
                <div id="pet-chat-view" class="pet-view" style="display: none;">
                    <div class="pet-section">
                        <h3>ğŸ’¬ ä¸ <span id="chat-pet-name"></span> èŠå¤©</h3>
                        <div id="chat-messages-container" class="chat-messages-container">
                            <!-- èŠå¤©æ¶ˆæ¯ä¼šé€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        </div>
                        <div class="chat-input-container">
                            <textarea id="chat-user-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." rows="3"></textarea>
                            <button id="chat-send-btn" class="pet-button">å‘é€</button>
                        </div>
                        <div class="pet-nav-buttons">
                            <button class="pet-button back-to-main-btn">â† è¿”å›</button>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨ä¿¡æ¯ -->
                <div class="pet-info-section" style="
                    text-align: center !important;
                    padding: 8px !important;
                    color: ${candyColors.textLight} !important;
                    font-size: 0.7em !important;
                ">
                    <p style="margin: 0 !important;">ğŸ‰ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ v1.0</p>
                    <p style="margin: 2px 0 0 0 !important;">ä¸Šæ¬¡äº’åŠ¨: åˆšåˆš</p>
                </div>
            </div>
        `;
    }

    // ç”Ÿæˆæ¡Œé¢ç«¯UI
    function generateDesktopUI() {
        console.log(`[UI] Generating desktop UI`);
        return `
            <div class="pet-popup-header" style="display: none;">
            </div>

            <div class="pet-main-content" style="
                display: flex !important;
                flex-direction: column !important;
                gap: 15px !important;
            ">
                <!-- å® ç‰©å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
                <div class="pet-avatar-section" style="
                    text-align: center !important;
                    padding: 20px !important;
                ">
                    <!-- åœ†å½¢å¤´åƒæ¡† -->
                    <div class="pet-avatar-circle" style="
                        width: 90px !important;
                        height: 90px !important;
                        border-radius: 50% !important;
                        background: ${candyColors.primary} !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        font-size: 3em !important;
                        overflow: hidden !important;
                        border: 3px solid #7289da !important;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
                        cursor: pointer !important;
                        margin: 0 auto 10px auto !important;
                        transition: transform 0.2s ease !important;
                    " onclick="openAvatarSelector()" oncontextmenu="showAvatarContextMenu(event)" title="ç‚¹å‡»æ›´æ¢å¤´åƒï¼Œå³é”®é‡ç½®">
                        ${getAvatarContent()}
                    </div>
                    <div class="pet-name" style="font-size: 1.3em !important; font-weight: bold !important; margin-bottom: 4px !important; color: ${candyColors.textPrimary} !important; cursor: pointer !important; text-decoration: underline !important;" onclick="editPetName()" title="ç‚¹å‡»ç¼–è¾‘å® ç‰©åå­—">${escapeHtml(petData.name)}</div>
                    <div class="pet-level" style="color: ${candyColors.primary} !important; font-size: 1em !important;">${petData.isAlive ?
                        `${LIFE_STAGES[petData.lifeStage]?.emoji || 'ğŸ¾'} ${LIFE_STAGES[petData.lifeStage]?.name || 'æœªçŸ¥'} Lv.${petData.level}` :
                        'ğŸ’€ å·²æ­»äº¡'
                    }</div>
                </div>

                <!-- å® ç‰©çŠ¶æ€æ  -->
                <div class="pet-status-section" style="
                    padding: 12px !important;
                ">
                    <h4 style="margin: 0 0 12px 0 !important; color: ${candyColors.primary} !important; font-size: 1em !important;">ğŸ“Š çŠ¶æ€</h4>
                    <div class="status-bars" style="display: flex !important; flex-direction: column !important; gap: 8px !important;">
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 4px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.9em !important;">â¤ï¸ å¥åº·</span>
                                <span style="color: ${candyColors.health} !important; font-size: 0.9em !important;">${Math.round(petData.health)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 6px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.health} !important; height: 100% !important; width: ${petData.health}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 4px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.9em !important;">ğŸ– é¥±é£Ÿåº¦</span>
                                <span style="color: ${candyColors.hunger} !important; font-size: 0.9em !important;">${Math.round(petData.hunger)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 6px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.hunger} !important; height: 100% !important; width: ${petData.hunger}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 4px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.9em !important;">ğŸ˜Š å¿«ä¹åº¦</span>
                                <span style="color: ${candyColors.happiness} !important; font-size: 0.9em !important;">${Math.round(petData.happiness)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 6px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.happiness} !important; height: 100% !important; width: ${petData.happiness}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div style="display: flex !important; justify-content: space-between !important; margin-bottom: 4px !important;">
                                <span style="color: ${candyColors.textSecondary} !important; font-size: 0.9em !important;">âš¡ ç²¾åŠ›</span>
                                <span style="color: ${candyColors.energy} !important; font-size: 0.9em !important;">${Math.round(petData.energy)}/100</span>
                            </div>
                            <div style="background: ${candyColors.border} !important; height: 6px !important; border-radius: 3px !important; overflow: hidden !important;">
                                <div style="background: ${candyColors.energy} !important; height: 100% !important; width: ${petData.energy}% !important; transition: width 0.3s ease !important;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é‡‘å¸æ˜¾ç¤º -->
                ${petData.dataVersion >= 4.0 ? `
                <div class="pet-coins-section" style="
                    text-align: center !important;
                    padding: 10px !important;
                    background: rgba(255,215,0,0.1) !important;
                    border-radius: 8px !important;
                    margin-bottom: 10px !important;
                ">
                    <span style="color: #ffd700 !important; font-weight: bold !important; font-size: 1.1em !important;">
                        ğŸ’° ${petData.coins || 100} é‡‘å¸
                    </span>
                </div>
                ` : ''}

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="pet-actions-section" style="
                    display: grid !important;
                    grid-template-columns: 1fr 1fr 1fr !important;
                    gap: 8px !important;
                ">
                    <button class="action-btn feed-btn" style="
                        padding: 12px !important;
                        background: ${candyColors.buttonPrimary} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1.1em !important;">ğŸ–</span>
                        <span>å–‚é£Ÿ</span>
                    </button>
                    <button class="action-btn play-btn" style="
                        padding: 12px !important;
                        background: ${candyColors.buttonSecondary} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1.1em !important;">ğŸ®</span>
                        <span>ç©è€</span>
                    </button>
                    <button class="action-btn sleep-btn" style="
                        padding: 12px !important;
                        background: ${candyColors.buttonAccent} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1.1em !important;">ğŸ˜´</span>
                        <span>ä¼‘æ¯</span>
                    </button>
                    <button class="action-btn hug-btn" style="
                        padding: 12px !important;
                        background: #FF69B4 !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1.1em !important;">ğŸ¤—</span>
                        <span>æŠ±æŠ±</span>
                    </button>
                    <button class="action-btn heal-btn" style="
                        padding: 12px !important;
                        background: ${(petData.sickness || 0) > 10 ? candyColors.health : candyColors.secondary} !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: ${(petData.sickness || 0) > 10 ? 'pointer' : 'not-allowed'} !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                        opacity: ${(petData.sickness || 0) > 10 ? '1' : '0.5'} !important;
                    ">
                        <span style="font-size: 1.1em !important;">ğŸ’Š</span>
                        <span>æ²»ç–—</span>
                    </button>
                    <button class="action-btn shop-btn" style="
                        padding: 12px !important;
                        background: ${candyColors.happiness} !important;
                        color: ${candyColors.textPrimary} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1.1em !important;">ğŸ›’</span>
                        <span>å•†åº—</span>
                    </button>
                    <button class="action-btn chat-btn" style="
                        padding: 12px !important;
                        background: ${candyColors.info} !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1.1em !important;">ğŸ’¬</span>
                        <span>èŠå¤©</span>
                    </button>
                    <button class="action-btn settings-btn" style="
                        padding: 12px !important;
                        background: #8B5CF6 !important;
                        color: ${candyColors.textWhite} !important;
                        border: 2px solid ${candyColors.border} !important;
                        border-radius: 0 !important;
                        font-family: 'Courier New', monospace !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        text-transform: none !important;
                        cursor: pointer !important;
                        min-height: 44px !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        gap: 6px !important;
                        box-shadow: 2px 2px 0px ${candyColors.shadow} !important;
                        transition: none !important;
                    ">
                        <span style="font-size: 1.1em !important;">âš™ï¸</span>
                        <span>è®¾ç½®</span>
                    </button>
                </div>

                <!-- èŠå¤©è§†å›¾ (éšè—) -->
                <div id="pet-chat-view" class="pet-view" style="display: none;">
                    <div class="pet-section">
                        <h3>ğŸ’¬ ä¸ <span id="chat-pet-name"></span> èŠå¤©</h3>
                        <div id="chat-messages-container" class="chat-messages-container">
                            <!-- èŠå¤©æ¶ˆæ¯ä¼šé€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        </div>
                        <div class="chat-input-container">
                            <textarea id="chat-user-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." rows="3"></textarea>
                            <button id="chat-send-btn" class="pet-button">å‘é€</button>
                        </div>
                        <div class="pet-nav-buttons">
                            <button class="pet-button back-to-main-btn">â† è¿”å›</button>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨ä¿¡æ¯ -->
                <div class="pet-info-section" style="
                    text-align: center !important;
                    padding: 10px !important;
                    color: ${candyColors.textLight} !important;
                    font-size: 0.8em !important;
                ">
                    <p style="margin: 0 !important;">ğŸ‰ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ v1.0</p>
                    <p style="margin: 3px 0 0 0 !important;">ä¸Šæ¬¡äº’åŠ¨: åˆšåˆš</p>
                </div>
            </div>
        `;
    }

    // ç»‘å®šç»Ÿä¸€UIçš„äº‹ä»¶
    function bindUnifiedUIEvents($container) {
        console.log(`[${extensionName}] Binding unified UI events`);

        // å–‚é£ŸæŒ‰é’®
        $container.find(".feed-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ– å–‚é£Ÿå® ç‰©");
            feedPet();
            // æ›´æ–°UIæ˜¾ç¤º
            setTimeout(() => {
                updateUnifiedUIStatus();
            }, 100);
        });

        // ç©è€æŒ‰é’®
        $container.find(".play-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ® å’Œå® ç‰©ç©è€");
            playWithPet();
            // æ›´æ–°UIæ˜¾ç¤º
            setTimeout(() => {
                updateUnifiedUIStatus();
            }, 100);
        });

        // ä¼‘æ¯æŒ‰é’®
        $container.find(".sleep-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ˜´ å® ç‰©ä¼‘æ¯");
            petSleep();
            // æ›´æ–°UIæ˜¾ç¤º
            setTimeout(() => {
                updateUnifiedUIStatus();
            }, 100);
        });

        // æŠ±æŠ±æŒ‰é’®
        $container.find(".hug-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ¤— æŠ±æŠ±å® ç‰©");
            hugPet();
            // æ›´æ–°UIæ˜¾ç¤º
            setTimeout(() => {
                updateUnifiedUIStatus();
            }, 100);
        });

        // æ²»ç–—æŒ‰é’®
        $container.find(".heal-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ’Š æ²»ç–—å® ç‰©");
            healPet();
            // æ›´æ–°UIæ˜¾ç¤º
            setTimeout(() => {
                updateUnifiedUIStatus();
            }, 100);
        });

        // å•†åº—æŒ‰é’®
        $container.find(".shop-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ›’ æ‰“å¼€å•†åº—");
            openShop();
        });

        // èŠå¤©æŒ‰é’® (ç»Ÿä¸€UIä¸­çš„chat-btnç±»)
        $container.find(".chat-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ’¬ ä¸å® ç‰©èŠå¤©");
            console.log(`[${extensionName}] èŠå¤©æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå¼€å§‹å¤„ç†...`);
            try {
                handleChatButtonClick();
                console.log(`[${extensionName}] handleChatButtonClick æ‰§è¡Œå®Œæˆ`);
            } catch (error) {
                console.error(`[${extensionName}] handleChatButtonClick æ‰§è¡Œå¤±è´¥:`, error);
            }
        });

        // èŠå¤©æŒ‰é’® (popup.htmlä¸­çš„goto-chat-btn ID)
        $container.find("#goto-chat-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("ğŸ’¬ ä¸å® ç‰©èŠå¤© (popup.html)");
            console.log(`[${extensionName}] popup.htmlèŠå¤©æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå¼€å§‹å¤„ç†...`);
            try {
                handleChatButtonClick();
                console.log(`[${extensionName}] handleChatButtonClick æ‰§è¡Œå®Œæˆ`);
            } catch (error) {
                console.error(`[${extensionName}] handleChatButtonClick æ‰§è¡Œå¤±è´¥:`, error);
            }
        });

        // è®¾ç½®æŒ‰é’®
        $container.find(".settings-btn").on("click touchend", function(e) {
            e.preventDefault();
            console.log("âš™ï¸ æ‰“å¼€è®¾ç½®");
            openSettings();
        });

        // å® ç‰©åå­—ç‚¹å‡»äº‹ä»¶ï¼ˆå¤‡ç”¨ï¼Œä¸»è¦é€šè¿‡onclickå±æ€§ï¼‰
        $container.find(".pet-name").on("click touchend", function(e) {
            e.preventDefault();
            editPetName();
        });

        // éªŒè¯èŠå¤©æŒ‰é’®æ˜¯å¦æ­£ç¡®ç»‘å®š
        const chatButtons = $container.find(".chat-btn");
        console.log(`[${extensionName}] èŠå¤©æŒ‰é’®ç»‘å®šéªŒè¯: æ‰¾åˆ° ${chatButtons.length} ä¸ªèŠå¤©æŒ‰é’®`);

        if (chatButtons.length > 0) {
            chatButtons.each(function(index) {
                const events = $._data(this, 'events');
                console.log(`[${extensionName}] èŠå¤©æŒ‰é’® ${index + 1} äº‹ä»¶:`, events ? Object.keys(events) : 'æ— äº‹ä»¶');
            });
        }

        console.log(`[${extensionName}] Unified UI events bound successfully`);

        // ç¡®ä¿èŠå¤©æŒ‰é’®å§‹ç»ˆå¯è§
        updateChatButtonVisibility();
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = "info") {
        // ç§»é™¤ç°æœ‰é€šçŸ¥
        $(".pet-notification").remove();

        const colors = {
            success: "#43b581",
            info: "#7289da",
            warning: "#faa61a",
            error: "#f04747"
        };

        const notification = $(`
            <div class="pet-notification" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: ${SAFE_Z_INDEX.notification};
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            ">${message}</div>
        `);

        $("body").append(notification);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }

    // iOSæµ‹è¯•æŒ‰é’® - å¯ä»¥åœ¨iOSä¸Šç›´æ¥ç‚¹å‡»æµ‹è¯•
    window.createIOSTestButton = function() {
        // ç§»é™¤ç°æœ‰æµ‹è¯•æŒ‰é’®
        $("#ios-test-button").remove();

        // åˆ›å»ºiOSæµ‹è¯•æŒ‰é’®
        const testButton = $(`
            <button id="ios-test-button" style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: ${SAFE_Z_INDEX.popup};
                background: #43b581;
                color: white;
                border: none;
                padding: 15px 20px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                min-width: 120px;
                min-height: 50px;
            ">ğŸ iOSæµ‹è¯•</button>
        `);

        $("body").append(testButton);

        testButton.on("click touchend", function(e) {
            e.preventDefault();
            console.log("iOSæµ‹è¯•æŒ‰é’®è¢«ç‚¹å‡»");

            // å…ˆæ¸…ç†æ‰€æœ‰å¼¹çª—
            window.clearAllPopups();

            // å»¶è¿Ÿæ˜¾ç¤ºç»Ÿä¸€å¼¹çª—
            setTimeout(() => {
                try {
                    showPopup();
                } catch (error) {
                    console.error("å¼¹çª—æµ‹è¯•å¤±è´¥:", error);
                    alert("å¼¹çª—æµ‹è¯•å¤±è´¥: " + error.message);
                }
            }, 100);
        });

        console.log("iOSæµ‹è¯•æŒ‰é’®å·²åˆ›å»ºï¼Œä½äºå±å¹•å³ä¸‹è§’");

        // 5ç§’åè‡ªåŠ¨ç§»é™¤æµ‹è¯•æŒ‰é’®
        setTimeout(() => {
            $("#ios-test-button").fadeOut(500, function() {
                $(this).remove();
            });
        }, 10000);

        return true;
    };

    // æµ‹è¯•ç»Ÿä¸€UIçš„å‡½æ•°
    window.testUnifiedUIForAllPlatforms = function() {
        console.log("ğŸ¨ æµ‹è¯•æ‰€æœ‰å¹³å°çš„ç»Ÿä¸€UI...");

        // è·å–è®¾å¤‡ä¿¡æ¯
        const windowWidth = $(window).width();
        const windowHeight = $(window).height();
        const userAgent = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        const isAndroid = /Android/.test(userAgent);
        const isMobile = windowWidth <= 767 || isIOS || isAndroid;

        console.log("=== è®¾å¤‡ä¿¡æ¯ ===");
        console.log("çª—å£å°ºå¯¸:", windowWidth + "x" + windowHeight);
        console.log("User Agent:", userAgent);
        console.log("iOS:", isIOS);
        console.log("Android:", isAndroid);
        console.log("Mobile:", isMobile);

        // æ¸…ç†ç°æœ‰å¼¹çª—
        window.clearAllPopups();

        // æ˜¾ç¤ºç»Ÿä¸€UI
        setTimeout(() => {
            console.log("ğŸ¨ æ˜¾ç¤ºç»Ÿä¸€UIï¼ˆæ‰€æœ‰å¹³å°ç›¸åŒï¼‰");
            showPopup();

            // æ£€æŸ¥UIå†…å®¹
            setTimeout(() => {
                const popup = $("#virtual-pet-popup");
                const header = popup.find(".pet-popup-header h2");
                const avatar = popup.find(".pet-avatar");
                const buttons = popup.find(".action-btn");

                console.log("=== UIæ£€æŸ¥ç»“æœ ===");
                console.log("å¼¹çª—å­˜åœ¨:", popup.length > 0);
                console.log("æ ‡é¢˜å†…å®¹:", header.text());
                console.log("å¤´åƒå†…å®¹:", avatar.text());
                console.log("æŒ‰é’®æ•°é‡:", buttons.length);
                console.log("æŒ‰é’®æ–‡å­—:", buttons.map((i, btn) => $(btn).text().trim()).get());

                if (popup.length > 0 && buttons.length === 4) {
                    console.log("âœ… ç»Ÿä¸€UIæµ‹è¯•æˆåŠŸï¼æ‰€æœ‰å¹³å°æ˜¾ç¤ºç›¸åŒå†…å®¹");
                } else {
                    console.log("âŒ ç»Ÿä¸€UIæµ‹è¯•å¤±è´¥ï¼å†…å®¹ä¸ä¸€è‡´");
                }
            }, 500);
        }, 200);

        return {
            windowSize: { width: windowWidth, height: windowHeight },
            device: { isIOS, isAndroid, isMobile },
            userAgent
        };
    };

    // iOSå…³é—­æµ‹è¯•å‡½æ•°
    window.testIOSClose = function() {
        console.log("ğŸ æµ‹è¯•iOSå…³é—­åŠŸèƒ½...");

        // æ£€æŸ¥æ˜¯å¦ä¸ºiOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        console.log("æ˜¯å¦iOSè®¾å¤‡:", isIOS);

        // æ£€æŸ¥å¼¹çª—æ˜¯å¦å­˜åœ¨
        const overlay = $("#virtual-pet-popup-overlay");
        const closeButton = overlay.find(".close-button");

        console.log("å¼¹çª—å­˜åœ¨:", overlay.length > 0);
        console.log("å…³é—­æŒ‰é’®å­˜åœ¨:", closeButton.length > 0);

        if (overlay.length > 0) {
            // æ£€æŸ¥äº‹ä»¶ç»‘å®š
            const events = $._data(closeButton[0], 'events');
            console.log("å…³é—­æŒ‰é’®äº‹ä»¶:", events);

            // æ‰‹åŠ¨è§¦å‘å…³é—­
            console.log("ğŸ æ‰‹åŠ¨è§¦å‘å…³é—­...");
            closePopup();
        } else {
            console.log("âŒ æ²¡æœ‰æ‰¾åˆ°å¼¹çª—");
        }

        return { isIOS, hasOverlay: overlay.length > 0, hasCloseButton: closeButton.length > 0 };
    };

    // å¼ºåˆ¶å…³é—­æ‰€æœ‰å¼¹çª—
    window.forceCloseAllPopups = function() {
        console.log("ğŸš¨ å¼ºåˆ¶å…³é—­æ‰€æœ‰å¼¹çª—...");

        // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„å¼¹çª—å…ƒç´ 
        $("#virtual-pet-popup-overlay").remove();
        $(".virtual-pet-popup-overlay").remove();
        $("[id*='virtual-pet-popup']").remove();
        $("[class*='virtual-pet-popup']").remove();

        // æ¸…ç†bodyä¸Šå¯èƒ½çš„æ ·å¼
        $("body").css("overflow", "");

        console.log("âœ… æ‰€æœ‰å¼¹çª—å·²å¼ºåˆ¶å…³é—­");
        return true;
    };

    // å¿«é€Ÿä¿®å¤æŒ‰é’®ä½ç½®å‡½æ•°
    window.fixPetButtonPosition = function() {
        console.log("ğŸ¾ ä¿®å¤æŒ‰é’®ä½ç½®...");

        const button = $('#virtual-pet-button');
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        // è·å–çª—å£å°ºå¯¸
        const windowWidth = $(window).width();
        const windowHeight = $(window).height();

        // è®¾ç½®å®‰å…¨çš„é»˜è®¤ä½ç½®
        const safeLeft = 20;
        const safeTop = Math.floor(windowHeight / 2);

        button.css({
            'top': safeTop + 'px',
            'left': safeLeft + 'px',
            'transform': 'none',
            'position': 'fixed',
            'display': 'flex',
            'opacity': '1',
            'visibility': 'visible',
            'z-index': SAFE_Z_INDEX.button
        });

        // æ¸…é™¤å¯èƒ½æœ‰é—®é¢˜çš„ä¿å­˜ä½ç½®
        localStorage.removeItem('virtual-pet-button-position');

        console.log(`ğŸ¾ æŒ‰é’®ä½ç½®å·²ä¿®å¤åˆ°: left=${safeLeft}px, top=${safeTop}px`);
        console.log(`ğŸ¾ çª—å£å°ºå¯¸: ${windowWidth}x${windowHeight}`);

        return true;
    };

    // æµ‹è¯•æ‹–æ‹½åŠŸèƒ½
    window.testDragFunction = function() {
        console.log("ğŸ¾ æµ‹è¯•æ‹–æ‹½åŠŸèƒ½...");

        const button = $('#virtual-pet-button');
        if (button.length === 0) {
            console.log("âŒ æŒ‰é’®ä¸å­˜åœ¨");
            return false;
        }

        // æ£€æŸ¥äº‹ä»¶ç»‘å®š
        const events = $._data(button[0], 'events');
        console.log("ğŸ” æŒ‰é’®äº‹ä»¶ç»‘å®š:", events);

        if (events) {
            console.log("   - mousedown:", events.mousedown ? "âœ… å·²ç»‘å®š" : "âŒ æœªç»‘å®š");
            console.log("   - touchstart:", events.touchstart ? "âœ… å·²ç»‘å®š" : "âŒ æœªç»‘å®š");
            console.log("   - click:", events.click ? "âœ… å·²ç»‘å®š" : "âŒ æœªç»‘å®š");
        }

        // æ£€æŸ¥documentäº‹ä»¶
        const docEvents = $._data(document, 'events');
        if (docEvents) {
            console.log("   - document mousemove:", docEvents.mousemove ? "âœ… å·²ç»‘å®š" : "âŒ æœªç»‘å®š");
            console.log("   - document mouseup:", docEvents.mouseup ? "âœ… å·²ç»‘å®š" : "âŒ æœªç»‘å®š");
        }

        // é‡æ–°ç»‘å®šæ‹–æ‹½åŠŸèƒ½
        console.log("ğŸ”„ é‡æ–°ç»‘å®šæ‹–æ‹½åŠŸèƒ½...");
        makeButtonDraggable(button);

        console.log("âœ… æ‹–æ‹½åŠŸèƒ½æµ‹è¯•å®Œæˆ");
        return true;
    };

    // -----------------------------------------------------------------
    // æµ‹è¯•å’Œè°ƒè¯•åŠŸèƒ½
    // -----------------------------------------------------------------

    /**
     * å¿«é€Ÿè¯Šæ–­SillyTavernç¯å¢ƒ
     */
    window.diagnoseSillyTavernEnvironment = function() {
        console.log("ğŸ” SillyTavernç¯å¢ƒè¯Šæ–­å¼€å§‹...");
        console.log("=".repeat(50));

        // 1. æ£€æŸ¥åŸºæœ¬å¯¹è±¡
        console.log("\n1ï¸âƒ£ åŸºæœ¬å¯¹è±¡æ£€æŸ¥:");
        console.log(`- windowå¯¹è±¡: ${typeof window !== 'undefined' ? 'âœ…' : 'âŒ'}`);
        console.log(`- jQueryå¯¹è±¡: ${typeof $ !== 'undefined' ? 'âœ…' : 'âŒ'}`);
        console.log(`- SillyTavernå¯¹è±¡: ${typeof SillyTavern !== 'undefined' ? 'âœ…' : 'âŒ'}`);

        // 2. æ£€æŸ¥SillyTavernç›¸å…³å‡½æ•°
        console.log("\n2ï¸âƒ£ SillyTavernå‡½æ•°æ£€æŸ¥:");
        const stFunctions = ['getContext', 'generateReply', 'Generate'];
        stFunctions.forEach(func => {
            if (typeof SillyTavern !== 'undefined' && SillyTavern[func]) {
                console.log(`- SillyTavern.${func}: âœ…`);
            } else if (typeof window[func] !== 'undefined') {
                console.log(`- window.${func}: âœ…`);
            } else {
                console.log(`- ${func}: âŒ`);
            }
        });

        // 3. æ£€æŸ¥å…¨å±€å˜é‡
        console.log("\n3ï¸âƒ£ å…¨å±€å˜é‡æ£€æŸ¥:");
        const globalVars = ['main_api', 'api_server', 'online_status', 'models', 'backends', 'extension_settings'];
        globalVars.forEach(varName => {
            const exists = typeof window[varName] !== 'undefined';
            console.log(`- ${varName}: ${exists ? 'âœ…' : 'âŒ'} ${exists ? typeof window[varName] : ''}`);
            if (exists && window[varName]) {
                console.log(`  å€¼: ${JSON.stringify(window[varName]).substring(0, 100)}...`);
            }
        });

        // 4. æ£€æŸ¥å½“å‰é¡µé¢URLå’Œè·¯å¾„
        console.log("\n4ï¸âƒ£ é¡µé¢ä¿¡æ¯:");
        console.log(`- URL: ${window.location.href}`);
        console.log(`- è·¯å¾„: ${window.location.pathname}`);
        console.log(`- ä¸»æœº: ${window.location.host}`);

        // 5. æ£€æŸ¥DOMä¸­çš„SillyTavernç‰¹å¾å…ƒç´ 
        console.log("\n5ï¸âƒ£ DOMå…ƒç´ æ£€æŸ¥:");
        const stSelectors = ['#chat', '#send_textarea', '#api_button', '.mes', '#extensions_settings'];
        stSelectors.forEach(selector => {
            const element = $(selector);
            console.log(`- ${selector}: ${element.length > 0 ? 'âœ…' : 'âŒ'} (${element.length}ä¸ª)`);
        });

        console.log("\n=".repeat(50));
        console.log("ğŸ” ç¯å¢ƒè¯Šæ–­å®Œæˆ");

        return {
            hasSillyTavern: typeof SillyTavern !== 'undefined',
            hasGetContext: typeof SillyTavern !== 'undefined' && typeof SillyTavern.getContext === 'function',
            hasJQuery: typeof $ !== 'undefined',
            url: window.location.href,
            globalVarsFound: globalVars.filter(v => typeof window[v] !== 'undefined')
        };
    };

    /**
     * æµ‹è¯•APIè·å–åŠŸèƒ½
     */
    window.testVirtualPetAPIDiscovery = async function() {
        console.log("ğŸ” æµ‹è¯•è™šæ‹Ÿå® ç‰©APIå‘ç°åŠŸèƒ½...");

        // å…ˆè¿›è¡Œç¯å¢ƒè¯Šæ–­
        const envInfo = window.diagnoseSillyTavernEnvironment();

        if (!envInfo.hasSillyTavern) {
            console.log("âš ï¸ è­¦å‘Š: æœªæ£€æµ‹åˆ°SillyTavernç¯å¢ƒï¼Œè¿™å¯èƒ½æ˜¯åŸå› ä¹‹ä¸€");
        }

        try {
            // æµ‹è¯•å®Œæ•´çš„APIè·å–åŠŸèƒ½
            console.log("\nğŸ”„ å¼€å§‹APIå‘ç°æµ‹è¯•:");
            const apis = await getAvailableAPIs();
            console.log(`\nğŸ‰ æµ‹è¯•å®Œæˆï¼Œå‘ç° ${apis.length} ä¸ªAPI:`, apis);

            if (apis.length === 0) {
                console.log("\nğŸ’¡ å»ºè®®:");
                console.log("1. ç¡®è®¤ä½ åœ¨SillyTaverné¡µé¢ä¸­è¿è¡Œæ­¤æµ‹è¯•");
                console.log("2. ç¡®è®¤SillyTavernå·²ç»é…ç½®äº†è‡³å°‘ä¸€ä¸ªAPI");
                console.log("3. å°è¯•åˆ·æ–°é¡µé¢åé‡æ–°æµ‹è¯•");
                console.log("4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯");
            }

            return apis;
        } catch (error) {
            console.error("âŒ æµ‹è¯•å¤±è´¥:", error);
            return [];
        }
    };

    /**
     * å¿«é€ŸAPIæµ‹è¯• - ç›´æ¥åç«¯APIç‰ˆæœ¬
     */
    window.quickAPITest = async function() {
        console.log("âš¡ å¿«é€Ÿåç«¯APIæµ‹è¯•å¼€å§‹...");

        // 1. åŸºç¡€æ£€æŸ¥
        console.log("\n1ï¸âƒ£ åŸºç¡€æ£€æŸ¥:");
        console.log(`SillyTavern: ${typeof SillyTavern !== 'undefined' ? 'âœ…' : 'âŒ'}`);
        console.log(`jQuery: ${typeof $ !== 'undefined' ? 'âœ…' : 'âŒ'}`);
        console.log(`Fetch API: ${typeof fetch !== 'undefined' ? 'âœ…' : 'âŒ'}`);

        // 2. æ£€æŸ¥ç”¨æˆ·é…ç½®çš„APIå¯†é’¥
        console.log("\n2ï¸âƒ£ APIå¯†é’¥æ£€æŸ¥:");
        const apiKeyInput = $('#ai-key-input').val();
        console.log(`ç”¨æˆ·è¾“å…¥çš„APIå¯†é’¥: ${apiKeyInput ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}`);

        // 3. å¿«é€Ÿæµ‹è¯•æœ¬åœ°API
        console.log("\n3ï¸âƒ£ æœ¬åœ°APIå¿«é€Ÿæµ‹è¯•:");
        const localEndpoints = [
            'http://localhost:11434/api/tags',  // Ollama
            'http://localhost:1234/v1/models', // LM Studio
            'http://localhost:5000/v1/models'  // Text Generation WebUI
        ];

        for (const endpoint of localEndpoints) {
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000) // 3ç§’è¶…æ—¶
                });
                console.log(`${endpoint}: ${response.ok ? 'âœ…' : 'âŒ'} (${response.status})`);
                if (response.ok) {
                    const data = await response.json();
                    const modelCount = data.models ? data.models.length : (data.data ? data.data.length : 0);
                    console.log(`  å‘ç° ${modelCount} ä¸ªæ¨¡å‹`);
                }
            } catch (error) {
                if (error.name === 'TimeoutError') {
                    console.log(`${endpoint}: â° è¶…æ—¶`);
                } else {
                    console.log(`${endpoint}: âŒ (${error.message})`);
                }
            }
        }

        // 4. æµ‹è¯•åœ¨çº¿APIï¼ˆå¦‚æœæœ‰å¯†é’¥ï¼‰
        if (apiKeyInput) {
            console.log("\n4ï¸âƒ£ åœ¨çº¿APIæµ‹è¯•:");
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKeyInput}`,
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(5000)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`OpenAI API: âœ… å‘ç° ${data.data.length} ä¸ªæ¨¡å‹`);
                } else if (response.status === 401) {
                    console.log(`OpenAI API: ğŸ” APIå¯†é’¥æ— æ•ˆ`);
                } else {
                    console.log(`OpenAI API: âŒ HTTP ${response.status}`);
                }
            } catch (error) {
                console.log(`OpenAI API: âŒ ${error.message}`);
            }
        } else {
            console.log("\n4ï¸âƒ£ è·³è¿‡åœ¨çº¿APIæµ‹è¯• (æœªè®¾ç½®APIå¯†é’¥)");
        }

        // 5. å®Œæ•´APIå‘ç°æµ‹è¯•
        console.log("\n5ï¸âƒ£ å®Œæ•´APIå‘ç°æµ‹è¯•:");
        try {
            const apis = await getAvailableAPIs();
            console.log(`ç»“æœ: ${apis.length > 0 ? 'âœ…' : 'âŒ'} å‘ç°${apis.length}ä¸ªAPI`);
            if (apis.length > 0) {
                const grouped = {};
                apis.forEach(api => {
                    const provider = api.provider || 'Other';
                    if (!grouped[provider]) grouped[provider] = 0;
                    grouped[provider]++;
                });
                Object.entries(grouped).forEach(([provider, count]) => {
                    console.log(`  ğŸ“Š ${provider}: ${count}ä¸ª`);
                });
            }
            return apis;
        } catch (error) {
            console.log(`ç»“æœ: âŒ é”™è¯¯: ${error.message}`);
            return [];
        }
    };

    /**
     * æµ‹è¯•ç‰¹å®šAPIç«¯ç‚¹
     */
    window.testSpecificAPI = async function(apiType, apiKey = null) {
        console.log(`ğŸ” æµ‹è¯•ç‰¹å®šAPI: ${apiType}`);

        const endpoints = {
            'openai': 'https://api.openai.com/v1/models',
            'claude': 'https://api.anthropic.com/v1/models',
            'google': 'https://generativelanguage.googleapis.com/v1beta/models',
            'ollama': 'http://localhost:11434/api/tags',
            'lmstudio': 'http://localhost:1234/v1/models'
        };

        const endpoint = endpoints[apiType];
        if (!endpoint) {
            console.log(`âŒ ä¸æ”¯æŒçš„APIç±»å‹: ${apiType}`);
            return null;
        }

        try {
            const headers = { 'Content-Type': 'application/json' };

            // æ·»åŠ è®¤è¯å¤´
            if (apiKey) {
                if (apiType === 'openai' || apiType === 'google') {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                } else if (apiType === 'claude') {
                    headers['x-api-key'] = apiKey;
                }
            }

            const response = await fetch(endpoint, {
                method: 'GET',
                headers: headers,
                signal: AbortSignal.timeout(10000)
            });

            if (response.ok) {
                const data = await response.json();
                console.log(`âœ… ${apiType} API æˆåŠŸ:`, data);
                return data;
            } else {
                console.log(`âŒ ${apiType} API å¤±è´¥: HTTP ${response.status}`);
                return null;
            }
        } catch (error) {
            console.log(`âŒ ${apiType} API é”™è¯¯: ${error.message}`);
            return null;
        }
    };

    /**
     * è·å–ç”¨æˆ·é…ç½®APIçš„æ¨¡å‹åˆ—è¡¨
     */
    window.getUserConfiguredModels = async function() {
        console.log("ğŸ¯ è·å–ç”¨æˆ·é…ç½®APIçš„æ¨¡å‹åˆ—è¡¨...");

        const apiUrl = $('#ai-url-input').val();
        const apiKey = $('#ai-key-input').val();

        if (!apiUrl) {
            console.log("âŒ æœªé…ç½®API URL");
            return [];
        }

        console.log(`ğŸ”— API URL: ${apiUrl}`);
        console.log(`ğŸ”‘ API Key: ${apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);

        // æ„å»ºæ¨¡å‹åˆ—è¡¨ç«¯ç‚¹
        let modelsEndpoint = apiUrl;
        if (!modelsEndpoint.endsWith('/models')) {
            if (modelsEndpoint.endsWith('/')) {
                modelsEndpoint += 'models';
            } else {
                modelsEndpoint += '/models';
            }
        }

        console.log(`ğŸ“¡ å°è¯•è·å–æ¨¡å‹åˆ—è¡¨: ${modelsEndpoint}`);

        try {
            const headers = {
                'Content-Type': 'application/json'
            };

            // æ·»åŠ è®¤è¯å¤´
            if (apiKey) {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }

            const response = await fetch(modelsEndpoint, {
                method: 'GET',
                headers: headers,
                signal: AbortSignal.timeout(15000) // 15ç§’è¶…æ—¶
            });

            if (response.ok) {
                const data = await response.json();
                console.log(`âœ… æˆåŠŸè·å–æ¨¡å‹åˆ—è¡¨:`, data);

                // è§£ææ¨¡å‹æ•°æ®
                let models = [];
                if (data.data && Array.isArray(data.data)) {
                    // OpenAIæ ¼å¼
                    models = data.data.map(model => ({
                        id: model.id,
                        name: model.id,
                        type: 'user_configured',
                        status: 'available',
                        source: modelsEndpoint,
                        provider: 'ç”¨æˆ·é…ç½®API'
                    }));
                } else if (data.models && Array.isArray(data.models)) {
                    // å…¶ä»–æ ¼å¼
                    models = data.models.map(model => ({
                        id: typeof model === 'string' ? model : model.id || model.name,
                        name: typeof model === 'string' ? model : model.id || model.name,
                        type: 'user_configured',
                        status: 'available',
                        source: modelsEndpoint,
                        provider: 'ç”¨æˆ·é…ç½®API'
                    }));
                }

                console.log(`ğŸ“‹ è§£æå‡º ${models.length} ä¸ªæ¨¡å‹:`, models.map(m => m.name));
                return models;

            } else {
                console.log(`âŒ è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: HTTP ${response.status}`);

                // å°è¯•è¯»å–é”™è¯¯ä¿¡æ¯
                try {
                    const errorText = await response.text();
                    console.log(`é”™è¯¯è¯¦æƒ…:`, errorText.substring(0, 200));
                } catch (e) {
                    console.log(`æ— æ³•è¯»å–é”™è¯¯è¯¦æƒ…`);
                }

                return [];
            }

        } catch (error) {
            console.log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            return [];
        }
    };

    /**
     * åˆ·æ–°å¹¶æ˜¾ç¤ºç”¨æˆ·é…ç½®çš„æ¨¡å‹
     */
    window.refreshUserModels = async function() {
        console.log("ğŸ”„ åˆ·æ–°ç”¨æˆ·é…ç½®çš„æ¨¡å‹...");

        const models = await getUserConfiguredModels();

        if (models.length > 0) {
            console.log(`ğŸ‰ å‘ç° ${models.length} ä¸ªå¯ç”¨æ¨¡å‹:`);
            models.forEach((model, index) => {
                console.log(`  ${index + 1}. ${model.name}`);
            });

            // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨
            updateAPIDropdown(models);

            toastr.success(`å‘ç° ${models.length} ä¸ªå¯ç”¨æ¨¡å‹ï¼`, 'ğŸ‰ æ¨¡å‹è·å–æˆåŠŸ', { timeOut: 5000 });
        } else {
            console.log("âŒ æœªå‘ç°ä»»ä½•æ¨¡å‹");
            toastr.warning('æœªå‘ç°ä»»ä½•æ¨¡å‹ï¼Œè¯·æ£€æŸ¥APIé…ç½®', 'âš ï¸ æ¨¡å‹è·å–å¤±è´¥', { timeOut: 5000 });
        }

        return models;
    };

    /**
     * å¸¦é‡è¯•æœºåˆ¶çš„fetchå‡½æ•°ï¼Œç”¨äºå¤„ç†ç½‘ç»œè¿æ¥é—®é¢˜
     * @param {string} url - è¯·æ±‚URL
     * @param {object} options - fetché€‰é¡¹
     * @param {number} maxRetries - æœ€å¤§é‡è¯•æ¬¡æ•°
     * @returns {Promise<Response>} fetchå“åº”
     */
    async function fetchWithRetry(url, options = {}, maxRetries = 2) {
        let lastError;

        for (let attempt = 0; attempt <= maxRetries; attempt++) {
            try {
                if (attempt > 0) {
                    console.log(`ğŸ”„ é‡è¯•ç¬¬ ${attempt} æ¬¡: ${url}`);
                    // é‡è¯•å‰ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œé¿å…ç«‹å³é‡è¯•
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }

                const response = await fetch(url, options);
                return response;

            } catch (error) {
                lastError = error;

                // æ£€æŸ¥æ˜¯å¦æ˜¯CORSé”™è¯¯ï¼ˆä¸åº”è¯¥é‡è¯•ï¼‰
                if (error.message.includes('CORS') ||
                    error.message.includes('Access-Control-Allow-Origin') ||
                    error.message.includes('preflight')) {
                    console.log(`ğŸš« CORSé”™è¯¯ï¼Œæ— æ³•é‡è¯•: ${error.message}`);
                    throw error;
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œè¿æ¥é—®é¢˜ï¼ˆå¯ä»¥é‡è¯•ï¼‰
                if (error.message.includes('Failed to fetch') ||
                    error.message.includes('ERR_CONNECTION_RESET') ||
                    error.message.includes('ERR_NETWORK') ||
                    error.message.includes('ERR_INTERNET_DISCONNECTED')) {

                    console.log(`ğŸŒ ç½‘ç»œè¿æ¥é—®é¢˜ (å°è¯• ${attempt + 1}/${maxRetries + 1}): ${error.message}`);

                    if (attempt < maxRetries) {
                        continue; // ç»§ç»­é‡è¯•
                    }
                } else {
                    // å…¶ä»–é”™è¯¯ï¼Œç›´æ¥æŠ›å‡º
                    console.log(`âŒ å…¶ä»–é”™è¯¯ï¼Œä¸é‡è¯•: ${error.message}`);
                    throw error;
                }
            }
        }

        // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†
        throw lastError;
    }

    /**
     * æ£€æµ‹ç½‘ç»œè¿æ¥çŠ¶æ€
     * @returns {Promise<boolean>} æ˜¯å¦æœ‰ç½‘ç»œè¿æ¥
     */
    async function checkNetworkConnection() {
        try {
            // å°è¯•è®¿é—®ä¸€ä¸ªå¯é çš„æµ‹è¯•ç«¯ç‚¹
            const response = await fetch('https://httpbin.org/get', {
                method: 'GET',
                signal: AbortSignal.timeout(3000)
            });
            return response.ok;
        } catch (error) {
            console.log(`ğŸŒ ç½‘ç»œè¿æ¥æ£€æµ‹å¤±è´¥: ${error.message}`);
            return false;
        }
    }

    /**
     * é€šç”¨ç¬¬ä¸‰æ–¹APIæ¨¡å‹è·å–å™¨ - æ”¯æŒç›´è¿+ä¸­ç»§é€€å›
     */
    window.getThirdPartyModels = async function() {
        console.log("ğŸŒ é€šç”¨ç¬¬ä¸‰æ–¹APIæ¨¡å‹è·å–å™¨å¯åŠ¨...");

        const apiUrl = $('#ai-url-input').val();
        const apiKey = $('#ai-key-input').val();
        const apiType = $('#ai-api-select').val();

        if (!apiUrl) {
            console.log("âŒ è¯·å…ˆé…ç½®API URL");
            return [];
        }

        console.log(`ğŸ”— API URL: ${apiUrl}`);
        console.log(`ğŸ”‘ API Key: ${apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
        console.log(`ğŸ·ï¸ APIç±»å‹: ${apiType}`);

        // æ£€æµ‹æ˜¯å¦ä¸ºå®˜æ–¹API
        const isOfficialAPI = ['openai', 'claude', 'google', 'deepseek'].includes(apiType);

        if (isOfficialAPI) {
            console.log("ğŸ¯ æ£€æµ‹åˆ°å®˜æ–¹APIï¼Œå°è¯•ç›´è¿è·å–æ¨¡å‹...");

            try {
                const directModels = await getModelsDirectly(apiUrl, apiKey, apiType);
                if (directModels && directModels.length > 0) {
                    console.log(`âœ… ç›´è¿è·å–æ¨¡å‹æˆåŠŸ: ${directModels.length} ä¸ªæ¨¡å‹`);
                    return directModels;
                }
            } catch (error) {
                console.log(`âš ï¸ ç›´è¿è·å–æ¨¡å‹å¤±è´¥: ${error.message}`);

                // æ£€æŸ¥æ˜¯å¦ä¸ºCORSé”™è¯¯
                if (error.message.includes('CORS') ||
                    error.message.includes('Failed to fetch') ||
                    error.message.includes('Access-Control-Allow-Origin')) {

                    console.log("ğŸ”„ æ£€æµ‹åˆ°CORSé”™è¯¯ï¼Œé€€å›ä¸­ç»§æœåŠ¡å™¨è·å–æ¨¡å‹...");

                    try {
                        const relayModels = await getModelsViaRelay(apiUrl, apiKey, apiType);
                        if (relayModels && relayModels.length > 0) {
                            console.log(`âœ… ä¸­ç»§è·å–æ¨¡å‹æˆåŠŸ: ${relayModels.length} ä¸ªæ¨¡å‹`);
                            return relayModels;
                        }
                    } catch (relayError) {
                        console.log(`âŒ ä¸­ç»§è·å–æ¨¡å‹ä¹Ÿå¤±è´¥: ${relayError.message}`);
                    }
                }
            }
        } else {
            console.log("ğŸ”§ æ£€æµ‹åˆ°è‡ªå®šä¹‰APIï¼Œå°è¯•ç›´è¿è·å–æ¨¡å‹...");

            try {
                const directModels = await getModelsDirectly(apiUrl, apiKey, apiType);
                if (directModels && directModels.length > 0) {
                    console.log(`âœ… è‡ªå®šä¹‰APIç›´è¿è·å–æ¨¡å‹æˆåŠŸ: ${directModels.length} ä¸ªæ¨¡å‹`);
                    return directModels;
                }
            } catch (error) {
                console.log(`âš ï¸ è‡ªå®šä¹‰APIç›´è¿è·å–æ¨¡å‹å¤±è´¥: ${error.message}`);

                // æ£€æŸ¥æ˜¯å¦ä¸ºCORSé”™è¯¯æˆ–ç½‘ç»œé”™è¯¯
                if (error.message.includes('CORS') ||
                    error.message.includes('Failed to fetch') ||
                    error.message.includes('Access-Control-Allow-Origin') ||
                    error.message.includes('ERR_NETWORK') ||
                    error.message.includes('ERR_CONNECTION')) {

                    console.log("ğŸ”„ æ£€æµ‹åˆ°ç½‘ç»œ/CORSé”™è¯¯ï¼Œé€€å›ä¸­ç»§æœåŠ¡å™¨è·å–æ¨¡å‹...");

                    try {
                        const relayModels = await getModelsViaRelay(apiUrl, apiKey, apiType);
                        if (relayModels && relayModels.length > 0) {
                            console.log(`âœ… è‡ªå®šä¹‰APIä¸­ç»§è·å–æ¨¡å‹æˆåŠŸ: ${relayModels.length} ä¸ªæ¨¡å‹`);
                            return relayModels;
                        }
                    } catch (relayError) {
                        console.log(`âŒ è‡ªå®šä¹‰APIä¸­ç»§è·å–æ¨¡å‹ä¹Ÿå¤±è´¥: ${relayError.message}`);
                    }
                } else {
                    console.log(`âŒ è‡ªå®šä¹‰APIå…¶ä»–é”™è¯¯ï¼Œä¸ä½¿ç”¨ä¸­ç»§: ${error.message}`);
                }
            }
        }

        // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œè¿”å›æ¨èæ¨¡å‹
        console.log("âš ï¸ æ— æ³•ä»APIè·å–æ¨¡å‹åˆ—è¡¨ï¼Œæ ¹æ®APIç±»å‹æä¾›æ¨èæ¨¡å‹");
        return getRecommendedModels(apiType);
    };

    /**
     * ç›´è¿æ–¹å¼è·å–æ¨¡å‹åˆ—è¡¨
     */
    async function getModelsDirectly(apiUrl, apiKey, apiType) {
        console.log("ğŸ¯ å¼€å§‹ç›´è¿è·å–æ¨¡å‹...");

        const baseUrl = apiUrl.replace(/\/+$/, '');
        let modelsEndpoint = '';

        // æ ¹æ®APIç±»å‹æ„å»ºç«¯ç‚¹
        if (apiType === 'google') {
            if (baseUrl.includes('/v1beta')) {
                modelsEndpoint = `${baseUrl}/models`;
            } else {
                modelsEndpoint = `${baseUrl}/v1beta/models`;
            }
        } else if (apiType === 'claude') {
            if (baseUrl.includes('/v1')) {
                modelsEndpoint = `${baseUrl}/models`;
            } else {
                modelsEndpoint = `${baseUrl}/v1/models`;
            }
        } else if (apiType === 'custom') {
            // è‡ªå®šä¹‰APIï¼šå°è¯•å¤šç§å¸¸è§ç«¯ç‚¹æ ¼å¼
            const possibleEndpoints = [];

            if (baseUrl.includes('/v1')) {
                possibleEndpoints.push(`${baseUrl}/models`);
            } else {
                possibleEndpoints.push(`${baseUrl}/v1/models`);
                possibleEndpoints.push(`${baseUrl}/models`);
            }

            // å…¶ä»–å¸¸è§æ ¼å¼
            possibleEndpoints.push(
                `${baseUrl}/engines`,
                `${baseUrl}/v1/engines`,
                `${baseUrl}/api/models`,
                `${baseUrl}/api/v1/models`
            );

            // å¯¹äºè‡ªå®šä¹‰APIï¼Œæˆ‘ä»¬éœ€è¦å°è¯•å¤šä¸ªç«¯ç‚¹
            return await tryMultipleEndpoints(possibleEndpoints, apiKey, apiType);
        } else {
            // OpenAI, DeepSeekç­‰å®˜æ–¹API
            if (baseUrl.includes('/v1')) {
                modelsEndpoint = `${baseUrl}/models`;
            } else {
                modelsEndpoint = `${baseUrl}/v1/models`;
            }
        }

        console.log(`ğŸ“¡ ç›´è¿ç«¯ç‚¹: ${modelsEndpoint}`);

        // æ„å»ºè¯·æ±‚å¤´
        const headers = { 'Content-Type': 'application/json' };

        if (apiKey) {
            if (apiType === 'google') {
                headers['x-goog-api-key'] = apiKey;
            } else if (apiType === 'claude') {
                headers['x-api-key'] = apiKey;
                headers['anthropic-version'] = '2023-06-01';
            } else {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }
        }

        const response = await fetch(modelsEndpoint, {
            method: 'GET',
            headers: headers,
            signal: AbortSignal.timeout(10000)
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        return parseModelsFromResponseNew(data, modelsEndpoint, apiType);
    }

    /**
     * å°è¯•å¤šä¸ªç«¯ç‚¹è·å–æ¨¡å‹ï¼ˆç”¨äºè‡ªå®šä¹‰APIï¼‰
     */
    async function tryMultipleEndpoints(endpoints, apiKey, apiType) {
        console.log(`ğŸ” å°è¯• ${endpoints.length} ä¸ªç«¯ç‚¹è·å–æ¨¡å‹...`);

        for (const endpoint of endpoints) {
            try {
                console.log(`ğŸ“¡ å°è¯•ç«¯ç‚¹: ${endpoint}`);

                // æ„å»ºè¯·æ±‚å¤´
                const headers = { 'Content-Type': 'application/json' };

                if (apiKey) {
                    // å°è¯•å¤šç§è®¤è¯æ–¹å¼
                    const authMethods = [
                        { name: 'Bearer', headers: { ...headers, 'Authorization': `Bearer ${apiKey}` } },
                        { name: 'x-api-key', headers: { ...headers, 'x-api-key': apiKey } },
                        { name: 'api-key', headers: { ...headers, 'api-key': apiKey } }
                    ];

                    for (const auth of authMethods) {
                        try {
                            console.log(`ğŸ” å°è¯•è®¤è¯æ–¹å¼: ${auth.name}`);

                            const response = await fetch(endpoint, {
                                method: 'GET',
                                headers: auth.headers,
                                signal: AbortSignal.timeout(8000)
                            });

                            if (response.ok) {
                                const data = await response.json();
                                const models = parseModelsFromResponseNew(data, endpoint, apiType);

                                if (models && models.length > 0) {
                                    console.log(`âœ… æˆåŠŸè·å–æ¨¡å‹: ${endpoint} (${auth.name})`);
                                    return models;
                                }
                            } else if (response.status === 401 || response.status === 403) {
                                console.log(`ğŸ” è®¤è¯å¤±è´¥: ${endpoint} (${auth.name}) - ${response.status}`);
                                continue; // å°è¯•ä¸‹ä¸€ç§è®¤è¯æ–¹å¼
                            } else {
                                console.log(`âŒ HTTPé”™è¯¯: ${endpoint} (${auth.name}) - ${response.status}`);
                            }

                        } catch (authError) {
                            console.log(`âŒ è®¤è¯æ–¹å¼å¤±è´¥: ${auth.name} - ${authError.message}`);
                        }
                    }
                } else {
                    // æ— APIå¯†é’¥çš„æƒ…å†µ
                    try {
                        const response = await fetch(endpoint, {
                            method: 'GET',
                            headers: headers,
                            signal: AbortSignal.timeout(8000)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const models = parseModelsFromResponseNew(data, endpoint, apiType);

                            if (models && models.length > 0) {
                                console.log(`âœ… æˆåŠŸè·å–æ¨¡å‹: ${endpoint} (æ— è®¤è¯)`);
                                return models;
                            }
                        }
                    } catch (noAuthError) {
                        console.log(`âŒ æ— è®¤è¯è¯·æ±‚å¤±è´¥: ${endpoint} - ${noAuthError.message}`);
                    }
                }

            } catch (error) {
                console.log(`âŒ ç«¯ç‚¹å¤±è´¥: ${endpoint} - ${error.message}`);

                // å¦‚æœæ˜¯CORSé”™è¯¯ï¼ŒæŠ›å‡ºä»¥ä¾¿ä¸Šå±‚å¤„ç†
                if (error.message.includes('CORS') ||
                    error.message.includes('Failed to fetch') ||
                    error.message.includes('Access-Control-Allow-Origin')) {
                    throw error;
                }
            }
        }

        throw new Error('æ‰€æœ‰ç«¯ç‚¹éƒ½æ— æ³•è·å–æ¨¡å‹');
    }

    /**
     * ä¸­ç»§æ–¹å¼è·å–æ¨¡å‹åˆ—è¡¨
     */
    async function getModelsViaRelay(apiUrl, apiKey, apiType) {
        console.log("ğŸ”„ å¼€å§‹ä¸­ç»§è·å–æ¨¡å‹...");

        const baseUrl = apiUrl.replace(/\/+$/, '');
        let modelsEndpoint = '';

        // æ ¹æ®APIç±»å‹æ„å»ºç«¯ç‚¹
        if (apiType === 'google') {
            if (baseUrl.includes('/v1beta')) {
                modelsEndpoint = `${baseUrl}/models`;
            } else {
                modelsEndpoint = `${baseUrl}/v1beta/models`;
            }
        } else if (apiType === 'claude') {
            if (baseUrl.includes('/v1')) {
                modelsEndpoint = `${baseUrl}/models`;
            } else {
                modelsEndpoint = `${baseUrl}/v1/models`;
            }
        } else {
            // OpenAI, DeepSeekç­‰
            if (baseUrl.includes('/v1')) {
                modelsEndpoint = `${baseUrl}/models`;
            } else {
                modelsEndpoint = `${baseUrl}/v1/models`;
            }
        }

        console.log(`ğŸ“¡ ä¸­ç»§ç«¯ç‚¹: ${modelsEndpoint}`);

        // æ„å»ºè¯·æ±‚å¤´
        const headers = { 'Content-Type': 'application/json' };

        if (apiKey) {
            if (apiType === 'google') {
                headers['x-goog-api-key'] = apiKey;
            } else if (apiType === 'claude') {
                headers['x-api-key'] = apiKey;
                headers['anthropic-version'] = '2023-06-01';
            } else {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }
        }

        // é€šè¿‡ä¸­ç»§æœåŠ¡å™¨å‘é€è¯·æ±‚
        const relayServerUrl = 'http://154.12.38.33:3000/proxy';

        const response = await fetch(relayServerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                targetUrl: modelsEndpoint,
                method: 'GET',
                headers: headers
            }),
            signal: AbortSignal.timeout(15000)
        });

        if (!response.ok) {
            throw new Error(`ä¸­ç»§æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        return parseModelsFromResponseNew(data, modelsEndpoint, apiType);
    }

    /**
     * æ–°çš„æ¨¡å‹å“åº”è§£æå™¨
     */
    function parseModelsFromResponseNew(data, endpoint, apiType) {
        console.log("ğŸ“‹ è§£ææ¨¡å‹å“åº”æ•°æ®...", data);

        let models = [];

        // æ ¹æ®ä¸åŒçš„å“åº”æ ¼å¼è§£æ
        if (data.data && Array.isArray(data.data)) {
            // OpenAIæ ¼å¼: {data: [{id: "gpt-3.5-turbo", ...}, ...]}
            models = data.data;
        } else if (data.models && Array.isArray(data.models)) {
            // Google/å…¶ä»–æ ¼å¼: {models: [{name: "models/gemini-pro", ...}, ...]}
            models = data.models;
        } else if (Array.isArray(data)) {
            // ç›´æ¥æ•°ç»„æ ¼å¼
            models = data;
        }

        // æ ‡å‡†åŒ–æ¨¡å‹æ•°æ®
        const standardizedModels = models.map(model => {
            let modelId, modelName;

            if (typeof model === 'string') {
                modelId = modelName = model;
            } else if (model.id) {
                modelId = model.id;
                modelName = model.name || model.id;
            } else if (model.name) {
                modelId = model.name;
                modelName = model.name;

                // Google APIç‰¹æ®Šå¤„ç†ï¼šç§»é™¤models/å‰ç¼€
                if (apiType === 'google' && modelName.startsWith('models/')) {
                    modelName = modelName.replace('models/', '');
                }
            } else if (model.model) {
                modelId = modelName = model.model;
            }

            if (modelId) {
                return {
                    id: modelId,
                    name: modelName,
                    object: 'model',
                    type: 'third_party',
                    status: 'available',
                    source: endpoint,
                    provider: `${apiType.toUpperCase()} API`
                };
            }
            return null;
        }).filter(Boolean);

        console.log(`âœ… è§£æå‡º ${standardizedModels.length} ä¸ªæ¨¡å‹`);
        return standardizedModels;
    }



    /**
     * é€šç”¨æ¨¡å‹æ•°æ®è§£æå™¨
     */
    function parseModelsFromResponse(data, endpoint, serviceType) {
        const models = [];

        console.log(`ğŸ” è§£æå“åº”æ•°æ®ï¼ŒæœåŠ¡ç±»å‹: ${serviceType}`);

        // OpenAIæ ‡å‡†æ ¼å¼: {data: [{id: "model-name", ...}, ...]}
        if (data.data && Array.isArray(data.data)) {
            console.log(`ğŸ“‹ æ£€æµ‹åˆ°OpenAIæ ‡å‡†æ ¼å¼ï¼Œ${data.data.length} ä¸ªæ¨¡å‹`);
            data.data.forEach(model => {
                if (model.id || model.name) {
                    models.push({
                        id: model.id || model.name,
                        name: model.id || model.name,
                        type: 'third_party',
                        status: 'available',
                        source: endpoint,
                        provider: `ç¬¬ä¸‰æ–¹API (${serviceType})`,
                        details: model
                    });
                }
            });
        }

        // é€šç”¨modelsæ•°ç»„æ ¼å¼: {models: [...]}
        else if (data.models && Array.isArray(data.models)) {
            console.log(`ğŸ“‹ æ£€æµ‹åˆ°é€šç”¨modelsæ ¼å¼ï¼Œ${data.models.length} ä¸ªæ¨¡å‹`);
            data.models.forEach(model => {
                let modelId, modelName;

                if (typeof model === 'string') {
                    modelId = modelName = model;
                } else if (model.id) {
                    modelId = model.id;
                    modelName = model.name || model.id;
                } else if (model.name) {
                    modelId = model.name;
                    modelName = model.name;
                } else if (model.model) {
                    modelId = modelName = model.model;
                }

                if (modelId) {
                    models.push({
                        id: modelId,
                        name: modelName,
                        type: 'third_party',
                        status: 'available',
                        source: endpoint,
                        provider: `ç¬¬ä¸‰æ–¹API (${serviceType})`,
                        details: model
                    });
                }
            });
        }

        // Ollamaæ ¼å¼: {models: [{name: "model:tag", ...}, ...]}
        else if (data.models && serviceType === 'local_api') {
            console.log(`ğŸ“‹ æ£€æµ‹åˆ°Ollamaæ ¼å¼ï¼Œ${data.models.length} ä¸ªæ¨¡å‹`);
            data.models.forEach(model => {
                if (model.name) {
                    models.push({
                        id: model.name,
                        name: model.name,
                        type: 'local_model',
                        status: 'available',
                        source: endpoint,
                        provider: 'Ollama (æœ¬åœ°)',
                        details: model
                    });
                }
            });
        }

        // ç›´æ¥æ•°ç»„æ ¼å¼: ["model1", "model2", ...]
        else if (Array.isArray(data)) {
            console.log(`ğŸ“‹ æ£€æµ‹åˆ°ç›´æ¥æ•°ç»„æ ¼å¼ï¼Œ${data.length} ä¸ªæ¨¡å‹`);
            data.forEach(model => {
                if (typeof model === 'string') {
                    models.push({
                        id: model,
                        name: model,
                        type: 'third_party',
                        status: 'available',
                        source: endpoint,
                        provider: `ç¬¬ä¸‰æ–¹API (${serviceType})`
                    });
                }
            });
        }

        // å…¶ä»–å¯èƒ½çš„æ ¼å¼
        else if (data.result && Array.isArray(data.result)) {
            console.log(`ğŸ“‹ æ£€æµ‹åˆ°resultæ•°ç»„æ ¼å¼ï¼Œ${data.result.length} ä¸ªæ¨¡å‹`);
            data.result.forEach(model => {
                const modelId = typeof model === 'string' ? model : (model.id || model.name);
                if (modelId) {
                    models.push({
                        id: modelId,
                        name: modelId,
                        type: 'third_party',
                        status: 'available',
                        source: endpoint,
                        provider: `ç¬¬ä¸‰æ–¹API (${serviceType})`
                    });
                }
            });
        }

        console.log(`âœ… è§£æå®Œæˆï¼Œè·å¾— ${models.length} ä¸ªæ¨¡å‹`);
        return models;
    }

    /**
     * æ ¹æ®æœåŠ¡ç±»å‹è·å–æ¨èæ¨¡å‹
     */
    function getRecommendedModels(serviceType, apiUrl) {
        console.log(`ğŸ¯ ä¸ºæœåŠ¡ç±»å‹ ${serviceType} ç”Ÿæˆæ¨èæ¨¡å‹`);

        let recommendedModels = [];

        // æ ¹æ®æœåŠ¡ç±»å‹æ¨èä¸åŒçš„æ¨¡å‹
        switch (serviceType) {
            case 'openai_official':
            case 'openai_proxy':
            case 'nyabit':
            case 'api2d':
            case 'generic_third_party':
                recommendedModels = [
                    { id: "gpt-4", name: "GPT-4" },
                    { id: "gpt-4-turbo", name: "GPT-4 Turbo" },
                    { id: "gpt-4-turbo-preview", name: "GPT-4 Turbo Preview" },
                    { id: "gpt-3.5-turbo", name: "GPT-3.5 Turbo" },
                    { id: "gpt-3.5-turbo-16k", name: "GPT-3.5 Turbo 16K" }
                ];
                break;

            case 'anthropic_official':
            case 'claude_proxy':
                recommendedModels = [
                    { id: "claude-3-opus-20240229", name: "Claude 3 Opus" },
                    { id: "claude-3-sonnet-20240229", name: "Claude 3 Sonnet" },
                    { id: "claude-3-haiku-20240307", name: "Claude 3 Haiku" },
                    { id: "claude-2.1", name: "Claude 2.1" },
                    { id: "claude-2.0", name: "Claude 2.0" }
                ];
                break;

            case 'google_official':
            case 'google_proxy':
                recommendedModels = [
                    { id: "gemini-pro", name: "Gemini Pro" },
                    { id: "gemini-1.5-pro", name: "Gemini 1.5 Pro" },
                    { id: "gemini-pro-vision", name: "Gemini Pro Vision" }
                ];
                break;

            case 'local_api':
                recommendedModels = [
                    { id: "llama2", name: "Llama 2" },
                    { id: "codellama", name: "Code Llama" },
                    { id: "mistral", name: "Mistral" },
                    { id: "vicuna", name: "Vicuna" },
                    { id: "alpaca", name: "Alpaca" }
                ];
                break;

            default:
                // é€šç”¨æ¨è
                recommendedModels = [
                    { id: "gpt-4", name: "GPT-4" },
                    { id: "gpt-3.5-turbo", name: "GPT-3.5 Turbo" },
                    { id: "claude-3-sonnet-20240229", name: "Claude 3 Sonnet" },
                    { id: "gemini-pro", name: "Gemini Pro" }
                ];
        }

        return recommendedModels.map(model => ({
            id: model.id,
            name: model.name,
            type: 'recommended',
            status: 'suggested',
            source: 'recommendation',
            provider: `æ¨èæ¨¡å‹ (${serviceType})`,
            note: 'åŸºäºAPIç±»å‹çš„æ™ºèƒ½æ¨è'
        }));
    }

    /**
     * æµ‹è¯•AIå›å¤åŠŸèƒ½
     */
    window.testVirtualPetAI = function() {
        console.log("ğŸ¤– æµ‹è¯•è™šæ‹Ÿå® ç‰©AIå›å¤åŠŸèƒ½...");

        // æ£€æŸ¥APIå¯ç”¨æ€§
        const apiAvailable = isAIAPIAvailable();
        console.log(`APIå¯ç”¨æ€§: ${apiAvailable ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);

        if (!apiAvailable) {
            console.log("å¯ç”¨çš„APIæ£€æŸ¥:");
            console.log(`- window.generateReply: ${typeof window.generateReply}`);
            console.log(`- window.SillyTavern: ${typeof window.SillyTavern}`);
            console.log(`- window.Generate: ${typeof window.Generate}`);
        }

        // æ˜¾ç¤ºå½“å‰å® ç‰©ä¿¡æ¯
        console.log("å½“å‰å® ç‰©ä¿¡æ¯:");
        console.log(`- åç§°: ${petData.name}`);
        console.log(`- ç±»å‹: ${getPetTypeName(petData.type)}`);
        console.log(`- ç­‰çº§: ${petData.level}`);
        console.log(`- äººè®¾ç±»å‹: ${localStorage.getItem(`${extensionName}-personality-type`) || 'default'}`);
        console.log(`- äººè®¾å†…å®¹: ${getCurrentPersonality()}`);
        console.log(`- å¥åº·: ${Math.round(petData.health)}/100`);
        console.log(`- å¿«ä¹: ${Math.round(petData.happiness)}/100`);
        console.log(`- é¥¥é¥¿: ${Math.round(petData.hunger)}/100`);
        console.log(`- ç²¾åŠ›: ${Math.round(petData.energy)}/100`);

        // ç”Ÿæˆæµ‹è¯•Prompt
        const testPrompt = buildInteractionPrompt('feed');
        console.log("ç”Ÿæˆçš„æµ‹è¯•Prompt:");
        console.log(testPrompt);

        return {
            apiAvailable,
            petData: { ...petData },
            personalityType: localStorage.getItem(`${extensionName}-personality-type`) || 'default',
            currentPersonality: getCurrentPersonality(),
            testPrompt
        };
    };

    /**
     * æ‰‹åŠ¨æµ‹è¯•AIå›å¤
     */
    window.testAIReply = async function(action = 'feed') {
        console.log(`ğŸ¯ æ‰‹åŠ¨æµ‹è¯•AIå›å¤ - è¡Œä¸º: ${action}`);

        try {
            const fallbackMessages = {
                'feed': `${petData.name} åƒå¾—å¾ˆå¼€å¿ƒï¼`,
                'play': `${petData.name} ç©å¾—å¾ˆå¼€å¿ƒï¼`,
                'sleep': `${petData.name} ç¡å¾—å¾ˆé¦™ï¼`
            };

            await handleAIReply(action, fallbackMessages[action] || 'å® ç‰©å¾ˆå¼€å¿ƒï¼');
            console.log("âœ… AIå›å¤æµ‹è¯•å®Œæˆ");
        } catch (error) {
            console.error("âŒ AIå›å¤æµ‹è¯•å¤±è´¥:", error);
        }
    };

    /**
     * æµ‹è¯•äººè®¾åˆ‡æ¢åŠŸèƒ½
     */
    window.testPersonalitySwitch = function(personalityType = 'default') {
        console.log(`ğŸ­ æµ‹è¯•äººè®¾åˆ‡æ¢: ${personalityType}`);

        if (personalityType === 'custom') {
            const customText = prompt("è¯·è¾“å…¥è‡ªå®šä¹‰äººè®¾:", "ä¸€åªç‰¹åˆ«çš„å® ç‰©");
            if (customText) {
                savePersonalitySettings('custom', customText);
            }
        } else if (PRESET_PERSONALITIES[personalityType]) {
            savePersonalitySettings(personalityType);
        } else {
            console.error("âŒ æ— æ•ˆçš„äººè®¾ç±»å‹:", personalityType);
            console.log("å¯ç”¨çš„äººè®¾ç±»å‹:", Object.keys(PRESET_PERSONALITIES));
            return;
        }

        console.log("âœ… äººè®¾åˆ‡æ¢å®Œæˆ");
        console.log("å½“å‰äººè®¾:", getCurrentPersonality());
    };

    /**
     * ç§»åŠ¨ç«¯APIè¿æ¥è¯Šæ–­å’Œä¿®å¤
     */
    window.diagnoseMobileAPI = function() {
        console.log('ğŸ“± ç§»åŠ¨ç«¯APIè¿æ¥è¯Šæ–­...');

        // æ£€æµ‹è®¾å¤‡ç±»å‹
        const userAgent = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        const isAndroid = /Android/.test(userAgent);
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);

        console.log('\nğŸ“± è®¾å¤‡ä¿¡æ¯:');
        console.log(`User Agent: ${userAgent}`);
        console.log(`iOS: ${isIOS}`);
        console.log(`Android: ${isAndroid}`);
        console.log(`ç§»åŠ¨ç«¯: ${isMobile}`);
        console.log(`çª—å£å°ºå¯¸: ${window.innerWidth}x${window.innerHeight}`);

        // æ£€æŸ¥ç½‘ç»œè¿æ¥
        console.log('\nğŸŒ ç½‘ç»œè¿æ¥:');
        console.log(`åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}`);
        console.log(`è¿æ¥ç±»å‹: ${navigator.connection ? navigator.connection.effectiveType : 'æœªçŸ¥'}`);

        // æ£€æŸ¥APIé…ç½®
        console.log('\nğŸ”§ APIé…ç½®:');
        const apiUrl = $('#ai-url-input').val();
        const apiKey = $('#ai-key-input').val();
        console.log(`API URL: ${apiUrl || 'âŒ æœªé…ç½®'}`);
        console.log(`API Key: ${apiKey ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`);

        // ç§»åŠ¨ç«¯ç‰¹æ®Šé—®é¢˜æ£€æŸ¥
        console.log('\nğŸ” ç§»åŠ¨ç«¯ç‰¹æ®Šé—®é¢˜:');

        // 1. CORSé—®é¢˜
        if (apiUrl && !apiUrl.includes('localhost') && !apiUrl.includes('127.0.0.1')) {
            console.log('âš ï¸ å¤–éƒ¨APIå¯èƒ½å­˜åœ¨CORSé™åˆ¶');
            console.log('ğŸ’¡ å»ºè®®: ä½¿ç”¨æ”¯æŒCORSçš„APIæˆ–æœ¬åœ°ä»£ç†');
        }

        // 2. HTTPSé—®é¢˜
        if (location.protocol === 'https:' && apiUrl && apiUrl.startsWith('http:')) {
            console.log('âŒ HTTPSé¡µé¢æ— æ³•è®¿é—®HTTP API');
            console.log('ğŸ’¡ å»ºè®®: ä½¿ç”¨HTTPS APIæˆ–åœ¨HTTPç¯å¢ƒä¸‹ä½¿ç”¨');
        }

        // 3. ç§»åŠ¨ç«¯ç½‘ç»œé™åˆ¶
        if (isMobile) {
            console.log('ğŸ“± ç§»åŠ¨ç«¯ç½‘ç»œä¼˜åŒ–å»ºè®®:');
            console.log('- ä½¿ç”¨ç¨³å®šçš„WiFiè¿æ¥');
            console.log('- é¿å…ä½¿ç”¨ç§»åŠ¨æ•°æ®è®¿é—®å¤–éƒ¨API');
            console.log('- å¢åŠ è¯·æ±‚è¶…æ—¶æ—¶é—´');
        }

        return {
            device: { userAgent, isIOS, isAndroid, isMobile },
            network: { online: navigator.onLine, connection: navigator.connection },
            api: { url: apiUrl, hasKey: !!apiKey },
            recommendations: getMobileAPIRecommendations(isMobile, apiUrl, apiKey)
        };
    };

    /**
     * è·å–ç§»åŠ¨ç«¯APIè¿æ¥å»ºè®®
     */
    function getMobileAPIRecommendations(isMobile, apiUrl, apiKey) {
        const recommendations = [];

        if (isMobile) {
            recommendations.push('ä½¿ç”¨ç¨³å®šçš„WiFiç½‘ç»œ');
            recommendations.push('é¿å…åœ¨ç§»åŠ¨æ•°æ®ä¸‹ä½¿ç”¨å¤–éƒ¨API');
        }

        if (!apiUrl) {
            recommendations.push('é…ç½®API URL');
        }

        if (!apiKey) {
            recommendations.push('é…ç½®APIå¯†é’¥');
        }

        if (apiUrl && apiUrl.startsWith('http:') && location.protocol === 'https:') {
            recommendations.push('ä½¿ç”¨HTTPS APIæˆ–åˆ‡æ¢åˆ°HTTPç¯å¢ƒ');
        }

        return recommendations;
    }

    /**
     * ç§»åŠ¨ç«¯API URLæ™ºèƒ½ä¿®å¤
     */
    window.fixMobileAPIURL = function(originalUrl) {
        console.log('ğŸ”§ ç§»åŠ¨ç«¯API URLæ™ºèƒ½ä¿®å¤...');
        console.log(`åŸå§‹URL: ${originalUrl}`);

        if (!originalUrl) {
            console.log('âŒ URLä¸ºç©º');
            return null;
        }

        // ç§»é™¤æœ«å°¾æ–œæ 
        let fixedUrl = originalUrl.replace(/\/+$/, '');

        // å¸¸è§çš„ç§»åŠ¨ç«¯404é—®é¢˜ä¿®å¤
        const fixes = [];

        // 1. ç¼ºå°‘/v1è·¯å¾„
        if (!fixedUrl.includes('/v1') && !fixedUrl.includes('/api/v1')) {
            if (fixedUrl.includes('openai.com') ||
                fixedUrl.includes('localhost') ||
                fixedUrl.includes('127.0.0.1')) {
                fixes.push({
                    type: 'æ·»åŠ /v1è·¯å¾„',
                    url: fixedUrl + '/v1',
                    reason: 'æ ‡å‡†OpenAI APIéœ€è¦/v1è·¯å¾„'
                });
            }
        }

        // 2. ç¼ºå°‘/chat/completionsç«¯ç‚¹
        if (!fixedUrl.includes('/chat/completions')) {
            fixes.push({
                type: 'æ·»åŠ èŠå¤©ç«¯ç‚¹',
                url: fixedUrl + '/chat/completions',
                reason: 'èŠå¤©APIéœ€è¦/chat/completionsç«¯ç‚¹'
            });

            if (fixedUrl.includes('/v1')) {
                fixes.push({
                    type: 'æ·»åŠ èŠå¤©ç«¯ç‚¹(v1)',
                    url: fixedUrl + '/chat/completions',
                    reason: 'å·²æœ‰v1è·¯å¾„ï¼Œç›´æ¥æ·»åŠ èŠå¤©ç«¯ç‚¹'
                });
            } else {
                fixes.push({
                    type: 'æ·»åŠ å®Œæ•´è·¯å¾„',
                    url: fixedUrl + '/v1/chat/completions',
                    reason: 'æ·»åŠ å®Œæ•´çš„v1èŠå¤©ç«¯ç‚¹è·¯å¾„'
                });
            }
        }

        // 3. åè®®é—®é¢˜ä¿®å¤
        if (fixedUrl.startsWith('http:') && location.protocol === 'https:') {
            fixes.push({
                type: 'HTTPSåè®®ä¿®å¤',
                url: fixedUrl.replace('http:', 'https:'),
                reason: 'HTTPSé¡µé¢éœ€è¦HTTPS API'
            });
        }

        // 4. ç«¯å£é—®é¢˜ä¿®å¤
        if (fixedUrl.includes('localhost') && !fixedUrl.includes(':')) {
            fixes.push({
                type: 'æ·»åŠ é»˜è®¤ç«¯å£',
                url: fixedUrl.replace('localhost', 'localhost:1234'),
                reason: 'LM Studioé»˜è®¤ç«¯å£1234'
            });
            fixes.push({
                type: 'æ·»åŠ Ollamaç«¯å£',
                url: fixedUrl.replace('localhost', 'localhost:11434'),
                reason: 'Ollamaé»˜è®¤ç«¯å£11434'
            });
        }

        console.log(`ğŸ”§ å‘ç° ${fixes.length} ä¸ªå¯èƒ½çš„ä¿®å¤æ–¹æ¡ˆ:`);
        fixes.forEach((fix, index) => {
            console.log(`${index + 1}. ${fix.type}: ${fix.url} (${fix.reason})`);
        });

        return fixes;
    };

    /**
     * ç§»åŠ¨ç«¯APIè¿æ¥æµ‹è¯• - å¢å¼ºç‰ˆ
     */
    window.testMobileAPIConnection = async function() {
        console.log('ğŸ“± æµ‹è¯•ç§»åŠ¨ç«¯APIè¿æ¥...');

        const originalUrl = $('#ai-url-input').val();
        const apiKey = $('#ai-key-input').val();

        if (!originalUrl) {
            console.log('âŒ è¯·å…ˆé…ç½®API URL');
            toastr.error('è¯·å…ˆé…ç½®API URL');
            return false;
        }

        // è·å–URLä¿®å¤å»ºè®®
        const urlFixes = window.fixMobileAPIURL(originalUrl);

        // è¦æµ‹è¯•çš„URLåˆ—è¡¨
        const urlsToTest = [originalUrl];
        if (urlFixes && urlFixes.length > 0) {
            urlFixes.forEach(fix => urlsToTest.push(fix.url));
        }

        console.log(`ğŸ” å°†æµ‹è¯• ${urlsToTest.length} ä¸ªURL...`);

        for (let i = 0; i < urlsToTest.length; i++) {
            const testUrl = urlsToTest[i];
            console.log(`\nğŸ”— æµ‹è¯• ${i + 1}/${urlsToTest.length}: ${testUrl}`);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // ç§»åŠ¨ç«¯15ç§’è¶…æ—¶

                const headers = {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                };

                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }

                // å°è¯•modelsç«¯ç‚¹è€Œä¸æ˜¯chatç«¯ç‚¹è¿›è¡Œæµ‹è¯•
                let testEndpoint = testUrl;
                if (testUrl.includes('/chat/completions')) {
                    testEndpoint = testUrl.replace('/chat/completions', '/models');
                } else if (!testUrl.includes('/models')) {
                    testEndpoint = testUrl + '/models';
                }

                console.log(`ğŸ“¡ å®é™…æµ‹è¯•ç«¯ç‚¹: ${testEndpoint}`);

                const response = await fetch(testEndpoint, {
                    method: 'GET',
                    headers: headers,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log(`ğŸ“Š å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… è¿æ¥æˆåŠŸ!', data);

                    // å¦‚æœæˆåŠŸçš„URLä¸æ˜¯åŸå§‹URLï¼Œå»ºè®®ç”¨æˆ·æ›´æ–°
                    if (testUrl !== originalUrl) {
                        const message = `ğŸ“± å»ºè®®æ›´æ–°API URLä¸º: ${testUrl}`;
                        console.log(message);
                        toastr.success(message, 'è¿æ¥æˆåŠŸ!', { timeOut: 8000 });

                        // è¯¢é—®æ˜¯å¦è‡ªåŠ¨æ›´æ–°URL
                        if (confirm(`APIè¿æ¥æˆåŠŸ!\n\nå»ºè®®å°†URLæ›´æ–°ä¸º:\n${testUrl}\n\næ˜¯å¦è‡ªåŠ¨æ›´æ–°?`)) {
                            $('#ai-url-input').val(testUrl);
                            toastr.info('API URLå·²è‡ªåŠ¨æ›´æ–°');
                        }
                    } else {
                        toastr.success('ğŸ“± ç§»åŠ¨ç«¯APIè¿æ¥æµ‹è¯•æˆåŠŸ!');
                    }

                    return true;

                } else if (response.status === 404) {
                    console.log(`âŒ 404é”™è¯¯: ${testEndpoint} ç«¯ç‚¹ä¸å­˜åœ¨`);
                    if (i === 0) {
                        console.log('ğŸ’¡ å°è¯•ä¿®å¤URL...');
                    }
                } else if (response.status === 401 || response.status === 403) {
                    console.log(`ğŸ” è®¤è¯é”™è¯¯: ${response.status} - å¯èƒ½éœ€è¦æ­£ç¡®çš„APIå¯†é’¥`);
                    if (i === 0) {
                        toastr.warning('APIè®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥');
                    }
                } else {
                    console.log(`âš ï¸ HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                console.log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);

                if (error.name === 'AbortError') {
                    console.log('â° è¯·æ±‚è¶…æ—¶');
                    if (i === 0) {
                        console.log('ğŸ’¡ å»ºè®®: ç½‘ç»œè¾ƒæ…¢ï¼Œå°è¯•ä½¿ç”¨æ›´ç¨³å®šçš„ç½‘ç»œ');
                    }
                } else if (error.message.includes('CORS')) {
                    console.log('ğŸš« CORSé™åˆ¶');
                    if (i === 0) {
                        console.log('ğŸ’¡ å»ºè®®: APIä¸æ”¯æŒè·¨åŸŸè®¿é—®ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°ä»£ç†');
                    }
                } else if (error.message.includes('Failed to fetch')) {
                    console.log('ğŸŒ ç½‘ç»œè¿æ¥å¤±è´¥');
                    if (i === 0) {
                        console.log('ğŸ’¡ å»ºè®®: æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIæœåŠ¡æ˜¯å¦è¿è¡Œ');
                    }
                }
            }
        }

        // æ‰€æœ‰URLéƒ½å¤±è´¥
        console.log('\nâŒ æ‰€æœ‰URLæµ‹è¯•éƒ½å¤±è´¥äº†');
        toastr.error('ğŸ“± ç§»åŠ¨ç«¯APIè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®', 'è¿æ¥å¤±è´¥', { timeOut: 5000 });

        // æä¾›è¯¦ç»†çš„æ•…éšœæ’é™¤å»ºè®®
        console.log('\nğŸ”§ ç§»åŠ¨ç«¯API 404æ•…éšœæ’é™¤å»ºè®®:');
        console.log('1. æ£€æŸ¥API URLæ ¼å¼æ˜¯å¦æ­£ç¡®');
        console.log('2. ç¡®è®¤APIæœåŠ¡æ­£åœ¨è¿è¡Œ');
        console.log('3. æ£€æŸ¥ç½‘ç»œè¿æ¥');
        console.log('4. å°è¯•ä½¿ç”¨æœ¬åœ°API (Ollama/LM Studio)');
        console.log('5. æ£€æŸ¥CORSè®¾ç½®');

        return false;
    };

    console.log("ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»ŸåŠ è½½å®Œæˆï¼");
    console.log("ğŸ¾ å¦‚æœæ²¡æœ‰çœ‹åˆ°æŒ‰é’®ï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œ: testVirtualPet()");
    console.log("ğŸ‰ AIäººè®¾åŠŸèƒ½å·²åŠ è½½ï¼å¯ç”¨æµ‹è¯•å‘½ä»¤:");
    console.log("  - testVirtualPetAI() - æ£€æŸ¥AIåŠŸèƒ½çŠ¶æ€");
    console.log("  - testAIReply('feed'|'play'|'sleep') - æ‰‹åŠ¨æµ‹è¯•AIå›å¤");
    console.log("  - testPersonalitySwitch('default'|'cheerful'|'elegant'|'shy'|'smart'|'custom') - æµ‹è¯•äººè®¾åˆ‡æ¢");
    console.log("ğŸ“± ç§»åŠ¨ç«¯ä¸“ç”¨å‘½ä»¤:");
    console.log("  - diagnoseMobileAPI() - ç§»åŠ¨ç«¯APIè¯Šæ–­");
    console.log("  - testMobileAPIConnection() - æµ‹è¯•ç§»åŠ¨ç«¯APIè¿æ¥");
    console.log("  - testURLBuilder('your-url') - æµ‹è¯•URLè‡ªåŠ¨æ„å»ºåŠŸèƒ½");
    console.log("ğŸ¤– ç¬¬ä¸‰æ–¹APIä¸“ç”¨å‘½ä»¤:");
    console.log("  - testGeminiAPI() - æµ‹è¯•Gemini APIè¿æ¥å’Œæ ¼å¼");
    console.log("  - testThirdPartyAPI() - æµ‹è¯•å½“å‰é…ç½®çš„ç¬¬ä¸‰æ–¹API");
    console.log("  - debugAPICall() - è°ƒè¯•APIè°ƒç”¨æµç¨‹");
    console.log("  - debugAPIResponse() - è°ƒè¯•APIå“åº”è§£æ");
    console.log("  - quickFixAPI() - å¿«é€Ÿä¿®å¤APIå“åº”è§£æé—®é¢˜");
    console.log("  - testSimpleRequest() - æµ‹è¯•ç®€åŒ–çš„è¯·æ±‚æ ¼å¼");

    /**
     * æµ‹è¯•URLè‡ªåŠ¨æ„å»ºåŠŸèƒ½
     */
    window.testURLBuilder = function(inputUrl) {
        console.log('ğŸ”§ æµ‹è¯•URLè‡ªåŠ¨æ„å»ºåŠŸèƒ½...');
        console.log('è¾“å…¥URL:', inputUrl);

        // æ¨¡æ‹ŸURLæ„å»ºé€»è¾‘
        let apiUrl = inputUrl;
        apiUrl = apiUrl.replace(/\/+$/, '');

        console.log('æ¸…ç†åURL:', apiUrl);

        // OpenAI/Custom APIç±»å‹çš„URLæ„å»º
        if (!apiUrl.includes('/chat/completions')) {
            let finalUrl;
            if (apiUrl.endsWith('/v1')) {
                finalUrl = apiUrl + '/chat/completions';
                console.log('âœ… æ£€æµ‹åˆ°/v1ç»“å°¾ï¼Œæ·»åŠ /chat/completions');
            } else if (!apiUrl.includes('/v1')) {
                finalUrl = apiUrl + '/v1/chat/completions';
                console.log('âœ… æœªæ£€æµ‹åˆ°/v1ï¼Œæ·»åŠ /v1/chat/completions');
            } else {
                finalUrl = apiUrl + '/chat/completions';
                console.log('âœ… æ£€æµ‹åˆ°/v1ä½†ä¸åœ¨æœ«å°¾ï¼Œæ·»åŠ /chat/completions');
            }
            console.log('æœ€ç»ˆURL:', finalUrl);
            return finalUrl;
        } else {
            console.log('âœ… URLå·²åŒ…å«/chat/completionsï¼Œæ— éœ€ä¿®æ”¹');
            return apiUrl;
        }
    };

    /**
     * æµ‹è¯•æ–°çš„æç¤ºè¯ç³»ç»Ÿ
     */
    window.testNewPrompt = function(action = 'play') {
        console.log('ğŸ” æµ‹è¯•æ–°çš„æç¤ºè¯ç³»ç»Ÿ...');

        console.log('=== å½“å‰è®¾ç½® ===');
        console.log(`å® ç‰©åç§°: ${petData.name}`);
        console.log(`äººè®¾ç±»å‹: ${localStorage.getItem(`${extensionName}-personality-type`) || 'default'}`);
        console.log(`å½“å‰äººè®¾: ${getCurrentPersonality()}`);

        console.log('\n=== ç”Ÿæˆçš„æç¤ºè¯ ===');
        const prompt = buildInteractionPrompt(action);
        console.log(prompt);

        console.log('\n=== æç¤ºè¯åˆ†æ ===');
        const hasAnimalType = prompt.includes('çŒ«') || prompt.includes('ç‹—') || prompt.includes('é¾™') || prompt.includes('ç±»å‹ï¼š');
        const hasPersonality = prompt.includes(getCurrentPersonality());
        const hasConflict = hasAnimalType && getCurrentPersonality().includes('æ­¥å¼€æ˜Ÿ');

        console.log(`åŒ…å«åŠ¨ç‰©ç±»å‹: ${hasAnimalType ? 'âŒ æ˜¯' : 'âœ… å¦'}`);
        console.log(`åŒ…å«äººè®¾å†…å®¹: ${hasPersonality ? 'âœ… æ˜¯' : 'âŒ å¦'}`);
        console.log(`å­˜åœ¨èº«ä»½å†²çª: ${hasConflict ? 'âŒ æ˜¯' : 'âœ… å¦'}`);

        if (!hasAnimalType && hasPersonality && !hasConflict) {
            console.log('âœ… æç¤ºè¯ç³»ç»Ÿæ­£å¸¸ï¼Œåº”è¯¥ä¸ä¼šå‡ºç°èº«ä»½æ··æ·†');
            toastr.success('æç¤ºè¯ç³»ç»Ÿæ­£å¸¸ï¼');
        } else {
            console.log('âš ï¸ æç¤ºè¯å¯èƒ½ä»æœ‰é—®é¢˜');
            toastr.warning('æç¤ºè¯å¯èƒ½ä»æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
        }

        return prompt;
    };

    /**
     * æµ‹è¯•Gemini APIè¿æ¥å’Œæ ¼å¼
     */
    window.testGeminiAPI = async function() {
        console.log('ğŸ¤– æµ‹è¯•Gemini APIè¿æ¥å’Œæ ¼å¼...');

        const apiUrl = $('#ai-url-input').val();
        const apiKey = $('#ai-key-input').val();
        const apiModel = $('#ai-model-input').val() || 'gemini-pro';

        if (!apiUrl) {
            console.log('âŒ è¯·å…ˆé…ç½®API URL');
            toastr.error('è¯·å…ˆé…ç½®API URL');
            return false;
        }

        if (!apiKey) {
            console.log('âŒ è¯·å…ˆé…ç½®APIå¯†é’¥');
            toastr.error('è¯·å…ˆé…ç½®APIå¯†é’¥');
            return false;
        }

        console.log(`ğŸ”— API URL: ${apiUrl}`);
        console.log(`ğŸ”‘ API Key: ${apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
        console.log(`ğŸ¤– æ¨¡å‹: ${apiModel}`);

        // æ„å»ºæµ‹è¯•è®¾ç½®
        const testSettings = {
            apiType: 'google',
            apiUrl: apiUrl,
            apiKey: apiKey,
            apiModel: apiModel
        };

        try {
            console.log('\nğŸ“¡ å¼€å§‹æµ‹è¯•Gemini API...');
            const testPrompt = "è¯·ç®€å•å›å¤'æµ‹è¯•æˆåŠŸ'ï¼Œä¸è¶…è¿‡10ä¸ªå­—ã€‚";

            const response = await callCustomAPI(testPrompt, testSettings, 15000);

            if (response && response.trim()) {
                console.log('âœ… Gemini APIæµ‹è¯•æˆåŠŸ!');
                console.log(`ğŸ“ AIå›å¤: ${response}`);
                toastr.success(`Gemini APIæµ‹è¯•æˆåŠŸï¼AIå›å¤: ${response.substring(0, 50)}`, 'ğŸ¤– æµ‹è¯•æˆåŠŸ');
                return true;
            } else {
                console.log('âŒ Gemini APIè¿”å›ç©ºå“åº”');
                toastr.error('Gemini APIè¿”å›ç©ºå“åº”', 'âŒ æµ‹è¯•å¤±è´¥');
                return false;
            }

        } catch (error) {
            console.error('âŒ Gemini APIæµ‹è¯•å¤±è´¥:', error);

            // æä¾›è¯¦ç»†çš„é”™è¯¯åˆ†æ
            if (error.message.includes('500')) {
                console.log('ğŸ’¡ 500é”™è¯¯å¯èƒ½åŸå› :');
                console.log('1. è¯·æ±‚æ ¼å¼ä¸æ­£ç¡®');
                console.log('2. æ¨¡å‹åç§°é”™è¯¯');
                console.log('3. APIå¯†é’¥æƒé™ä¸è¶³');
                toastr.error('500é”™è¯¯ï¼šè¯·æ£€æŸ¥è¯·æ±‚æ ¼å¼å’Œæ¨¡å‹åç§°', 'âŒ æœåŠ¡å™¨é”™è¯¯', { timeOut: 8000 });
            } else if (error.message.includes('401') || error.message.includes('403')) {
                console.log('ğŸ’¡ è®¤è¯é”™è¯¯å¯èƒ½åŸå› :');
                console.log('1. APIå¯†é’¥æ— æ•ˆ');
                console.log('2. APIå¯†é’¥æƒé™ä¸è¶³');
                console.log('3. è®¤è¯å¤´æ ¼å¼é”™è¯¯');
                toastr.error('è®¤è¯å¤±è´¥ï¼šè¯·æ£€æŸ¥APIå¯†é’¥', 'âŒ è®¤è¯é”™è¯¯', { timeOut: 8000 });
            } else if (error.message.includes('404')) {
                console.log('ğŸ’¡ 404é”™è¯¯å¯èƒ½åŸå› :');
                console.log('1. APIç«¯ç‚¹URLé”™è¯¯');
                console.log('2. æ¨¡å‹åç§°ä¸å­˜åœ¨');
                console.log('3. APIç‰ˆæœ¬ä¸æ­£ç¡®');
                toastr.error('404é”™è¯¯ï¼šè¯·æ£€æŸ¥API URLå’Œæ¨¡å‹åç§°', 'âŒ ç«¯ç‚¹é”™è¯¯', { timeOut: 8000 });
            }

            toastr.error(`Gemini APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'âŒ æµ‹è¯•å¤±è´¥', { timeOut: 10000 });
            return false;
        }
    };

    /**
     * æµ‹è¯•å½“å‰é…ç½®çš„ç¬¬ä¸‰æ–¹API
     */
    window.testThirdPartyAPI = async function() {
        console.log('ğŸŒ æµ‹è¯•å½“å‰é…ç½®çš„ç¬¬ä¸‰æ–¹API...');

        const settings = loadAISettings();
        console.log('ğŸ“‹ å½“å‰APIé…ç½®:', settings);

        if (!settings.apiType || !settings.apiUrl || !settings.apiKey) {
            console.log('âŒ APIé…ç½®ä¸å®Œæ•´');
            console.log(`APIç±»å‹: ${settings.apiType || 'æœªè®¾ç½®'}`);
            console.log(`API URL: ${settings.apiUrl || 'æœªè®¾ç½®'}`);
            console.log(`APIå¯†é’¥: ${settings.apiKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
            toastr.error('è¯·å…ˆå®Œæ•´é…ç½®APIä¿¡æ¯', 'âŒ é…ç½®ä¸å®Œæ•´');
            return false;
        }

        try {
            console.log('\nğŸ“¡ å¼€å§‹æµ‹è¯•ç¬¬ä¸‰æ–¹API...');
            const testPrompt = "è¯·ç®€å•å›å¤'æµ‹è¯•æˆåŠŸ'ï¼Œä¸è¶…è¿‡10ä¸ªå­—ã€‚";

            const response = await callCustomAPI(testPrompt, settings, 15000);

            if (response && response.trim()) {
                console.log('âœ… ç¬¬ä¸‰æ–¹APIæµ‹è¯•æˆåŠŸ!');
                console.log(`ğŸ“ AIå›å¤: ${response}`);
                toastr.success(`ç¬¬ä¸‰æ–¹APIæµ‹è¯•æˆåŠŸï¼AIå›å¤: ${response.substring(0, 50)}`, 'ğŸŒ æµ‹è¯•æˆåŠŸ');
                return true;
            } else {
                console.log('âŒ ç¬¬ä¸‰æ–¹APIè¿”å›ç©ºå“åº”');
                toastr.error('ç¬¬ä¸‰æ–¹APIè¿”å›ç©ºå“åº”', 'âŒ æµ‹è¯•å¤±è´¥');
                return false;
            }

        } catch (error) {
            console.error('âŒ ç¬¬ä¸‰æ–¹APIæµ‹è¯•å¤±è´¥:', error);

            // æä¾›è¯¦ç»†çš„é”™è¯¯åˆ†æ
            if (error.message.includes('500')) {
                console.log('ğŸ’¡ 500é”™è¯¯åˆ†æ:');
                console.log('1. è¯·æ±‚æ ¼å¼å¯èƒ½ä¸æ­£ç¡®');
                console.log('2. æ¨¡å‹åç§°å¯èƒ½é”™è¯¯');
                console.log('3. APIæœåŠ¡å™¨å†…éƒ¨é”™è¯¯');
                console.log('4. è¯·æ±‚å‚æ•°ä¸ç¬¦åˆAPIè¦æ±‚');
                toastr.error('500é”™è¯¯ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯·æ±‚æ ¼å¼', 'âŒ æœåŠ¡å™¨é”™è¯¯', { timeOut: 8000 });
            } else if (error.message.includes('401') || error.message.includes('403')) {
                console.log('ğŸ’¡ è®¤è¯é”™è¯¯åˆ†æ:');
                console.log('1. APIå¯†é’¥æ— æ•ˆæˆ–è¿‡æœŸ');
                console.log('2. APIå¯†é’¥æƒé™ä¸è¶³');
                console.log('3. è®¤è¯å¤´æ ¼å¼é”™è¯¯');
                console.log('4. APIé…é¢å·²ç”¨å®Œ');
                toastr.error('è®¤è¯å¤±è´¥ï¼šè¯·æ£€æŸ¥APIå¯†é’¥å’Œæƒé™', 'âŒ è®¤è¯é”™è¯¯', { timeOut: 8000 });
            } else if (error.message.includes('404')) {
                console.log('ğŸ’¡ 404é”™è¯¯åˆ†æ:');
                console.log('1. APIç«¯ç‚¹URLé”™è¯¯');
                console.log('2. æ¨¡å‹åç§°ä¸å­˜åœ¨');
                console.log('3. APIç‰ˆæœ¬è·¯å¾„é”™è¯¯');
                toastr.error('404é”™è¯¯ï¼šè¯·æ£€æŸ¥API URLå’Œç«¯ç‚¹', 'âŒ ç«¯ç‚¹é”™è¯¯', { timeOut: 8000 });
            }

            toastr.error(`ç¬¬ä¸‰æ–¹APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'âŒ æµ‹è¯•å¤±è´¥', { timeOut: 10000 });
            return false;
        }
    };

    /**
     * è°ƒè¯•APIè°ƒç”¨æµç¨‹
     */
    window.debugAPICall = async function() {
        console.log('ğŸ” è°ƒè¯•APIè°ƒç”¨æµç¨‹...');

        const settings = loadAISettings();
        console.log('\nğŸ“‹ APIé…ç½®æ£€æŸ¥:');
        console.log(`APIç±»å‹: ${settings.apiType || 'âŒ æœªè®¾ç½®'}`);
        console.log(`API URL: ${settings.apiUrl || 'âŒ æœªè®¾ç½®'}`);
        console.log(`APIå¯†é’¥: ${settings.apiKey ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}`);
        console.log(`APIæ¨¡å‹: ${settings.apiModel || 'âŒ æœªè®¾ç½®'}`);

        console.log('\nâœ… æ³¨æ„: æ’ä»¶ç°åœ¨åªä½¿ç”¨è‡ªå®šä¹‰APIé…ç½®ï¼Œä¸å†è°ƒç”¨SillyTavern API');

        console.log('\nğŸ“¡ å¼€å§‹è°ƒè¯•APIè°ƒç”¨...');
        const testPrompt = "æµ‹è¯•";

        try {
            const result = await callAIAPI(testPrompt, 10000);
            console.log('âœ… APIè°ƒç”¨æˆåŠŸ:', result);
            toastr.success(`APIè°ƒç”¨æˆåŠŸ: ${result}`, 'ğŸ” è°ƒè¯•æˆåŠŸ');
        } catch (error) {
            console.error('âŒ APIè°ƒç”¨å¤±è´¥:', error);
            toastr.error(`APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'ğŸ” è°ƒè¯•å¤±è´¥', { timeOut: 8000 });
        }
    };

    /**
     * è°ƒè¯•APIå“åº”è§£æ
     */
    window.debugAPIResponse = function(mockResponse = null) {
        console.log('ğŸ” è°ƒè¯•APIå“åº”è§£æ...');

        const settings = loadAISettings();
        console.log('ğŸ“‹ å½“å‰APIé…ç½®:', settings);

        // å¦‚æœæ²¡æœ‰æä¾›æ¨¡æ‹Ÿå“åº”ï¼Œä½¿ç”¨ä¸€äº›å¸¸è§çš„å“åº”æ ¼å¼ç¤ºä¾‹
        const mockResponses = {
            openai: {
                choices: [{
                    message: { content: "è¿™æ˜¯OpenAIæ ¼å¼çš„å›å¤" },
                    text: "è¿™æ˜¯å¤‡ç”¨çš„textå­—æ®µ"
                }]
            },
            claude: {
                content: [{
                    text: "è¿™æ˜¯Claudeæ ¼å¼çš„å›å¤"
                }]
            },
            google: {
                candidates: [{
                    content: {
                        parts: [{
                            text: "è¿™æ˜¯Geminiæ ¼å¼çš„å›å¤"
                        }]
                    }
                }]
            },
            generic: {
                text: "è¿™æ˜¯é€šç”¨æ ¼å¼çš„textå­—æ®µ",
                response: "è¿™æ˜¯é€šç”¨æ ¼å¼çš„responseå­—æ®µ",
                result: "è¿™æ˜¯é€šç”¨æ ¼å¼çš„resultå­—æ®µ"
            }
        };

        const testResponse = mockResponse || mockResponses[settings.apiType] || mockResponses.generic;
        console.log('ğŸ§ª æµ‹è¯•å“åº”æ•°æ®:', testResponse);

        // æ¨¡æ‹Ÿè§£æé€»è¾‘
        let result = '';
        console.log(`ğŸ”§ ä½¿ç”¨APIç±»å‹: ${settings.apiType}`);

        if (settings.apiType === 'openai' || settings.apiType === 'custom') {
            result = testResponse.choices?.[0]?.message?.content || testResponse.choices?.[0]?.text || '';
            console.log('ğŸ“Š OpenAIè§£æç»“æœ:', {
                'choices[0].message.content': testResponse.choices?.[0]?.message?.content,
                'choices[0].text': testResponse.choices?.[0]?.text,
                'final_result': result
            });
        } else if (settings.apiType === 'claude') {
            result = testResponse.content?.[0]?.text || '';
            console.log('ğŸ“Š Claudeè§£æç»“æœ:', {
                'content[0].text': testResponse.content?.[0]?.text,
                'final_result': result
            });
        } else if (settings.apiType === 'google') {
            result = testResponse.candidates?.[0]?.content?.parts?.[0]?.text || '';
            console.log('ğŸ“Š Geminiè§£æç»“æœ:', {
                'candidates[0].content.parts[0].text': testResponse.candidates?.[0]?.content?.parts?.[0]?.text,
                'final_result': result
            });

            if (!result) {
                result = testResponse.text || testResponse.response || testResponse.result || '';
                console.log('ğŸ“Š Geminiå¤‡ç”¨è§£æ:', {
                    'text': testResponse.text,
                    'response': testResponse.response,
                    'result': testResponse.result,
                    'backup_result': result
                });
            }
        } else {
            result = testResponse.text || testResponse.response || testResponse.result || '';
            console.log('ğŸ“Š é€šç”¨è§£æç»“æœ:', {
                'text': testResponse.text,
                'response': testResponse.response,
                'result': testResponse.result,
                'final_result': result
            });
        }

        console.log('âœ… æœ€ç»ˆè§£æç»“æœ:', {
            result: result,
            type: typeof result,
            length: result ? result.length : 'null/undefined',
            isEmpty: !result || result.trim() === '',
            trimmed: result ? result.trim() : 'cannot trim'
        });

        if (result && result.trim()) {
            console.log('âœ… è§£ææˆåŠŸï¼');
            toastr.success(`è§£ææˆåŠŸ: ${result}`, 'ğŸ” è°ƒè¯•æˆåŠŸ');
        } else {
            console.log('âŒ è§£æå¤±è´¥ï¼Œè¿”å›ç©ºç»“æœ');
            toastr.error('è§£æå¤±è´¥ï¼Œè¿”å›ç©ºç»“æœ', 'ğŸ” è°ƒè¯•å¤±è´¥');
        }

        return result;
    };

    /**
     * å¿«é€Ÿä¿®å¤APIå“åº”è§£æé—®é¢˜
     */
    window.quickFixAPI = async function() {
        console.log('ğŸ”§ å¿«é€Ÿä¿®å¤APIå“åº”è§£æé—®é¢˜...');

        const settings = loadAISettings();
        if (!settings.apiType || !settings.apiUrl || !settings.apiKey) {
            console.log('âŒ è¯·å…ˆé…ç½®APIä¿¡æ¯');
            return false;
        }

        console.log('ğŸ“¡ å‘é€æµ‹è¯•è¯·æ±‚ä»¥è·å–çœŸå®å“åº”ç»“æ„...');

        try {
            // ç›´æ¥è°ƒç”¨callCustomAPIæ¥è·å–çœŸå®å“åº”
            const testPrompt = "æµ‹è¯•";
            await callCustomAPI(testPrompt, settings, 10000);
        } catch (error) {
            console.log('ğŸ“Š ä»é”™è¯¯ä¸­è·å–å“åº”ä¿¡æ¯...');
        }

        console.log('\nğŸ’¡ åŸºäºä½ çš„æ—¥å¿—ï¼Œé—®é¢˜æ˜¯choices[0].message.contentä¸ºç©ºå­—ç¬¦ä¸²');
        console.log('ğŸ” è®©æˆ‘ä»¬æ£€æŸ¥choices[0]çš„å®Œæ•´ç»“æ„...');

        // æ¨¡æ‹Ÿä½ çš„å“åº”æ•°æ®è¿›è¡Œåˆ†æ
        const mockResponse = {
            id: 'chatcmpl-20250708132707348110513aE2tFtcY',
            model: 'gemini-2.5-pro-preview-06-05',
            object: 'chat.completion',
            created: 1751952430,
            choices: [{
                // è¿™é‡Œå¯èƒ½æœ‰å…¶ä»–å­—æ®µ
                message: {
                    content: '', // è¿™ä¸ªæ˜¯ç©ºçš„
                    // å¯èƒ½è¿˜æœ‰å…¶ä»–å­—æ®µ
                },
                // å¯èƒ½è¿˜æœ‰å…¶ä»–å­—æ®µ
            }]
        };

        console.log('ğŸ§ª åˆ†æå¯èƒ½çš„å“åº”ç»“æ„...');
        console.log('å¦‚æœchoices[0].message.contentæ˜¯ç©ºçš„ï¼Œå¯èƒ½çš„åŸå› ï¼š');
        console.log('1. å†…å®¹åœ¨choices[0].message.textå­—æ®µ');
        console.log('2. å†…å®¹åœ¨choices[0].textå­—æ®µ');
        console.log('3. å†…å®¹åœ¨choices[0].contentå­—æ®µ');
        console.log('4. å†…å®¹åœ¨choices[0].delta.contentå­—æ®µ');
        console.log('5. APIè¿”å›äº†ç©ºå†…å®¹ï¼ˆå¯èƒ½æ˜¯æ¨¡å‹é—®é¢˜ï¼‰');

        console.log('\nğŸ”§ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆï¼š');
        console.log('1. å†æ¬¡è¿è¡ŒtestThirdPartyAPI()æŸ¥çœ‹è¯¦ç»†æ—¥å¿—');
        console.log('2. æ£€æŸ¥ä½ çš„APIæä¾›å•†æ–‡æ¡£');
        console.log('3. å°è¯•ä¸åŒçš„æ¨¡å‹åç§°');
        console.log('4. æ£€æŸ¥APIé…é¢å’Œæƒé™');

        toastr.info('è¯·æŸ¥çœ‹æ§åˆ¶å°çš„è¯¦ç»†åˆ†æ', 'ğŸ”§ å¿«é€Ÿä¿®å¤', { timeOut: 5000 });

        return true;
    };

    /**
     * æµ‹è¯•ç®€åŒ–çš„è¯·æ±‚æ ¼å¼
     */
    window.testSimpleRequest = async function() {
        console.log('ğŸ§ª æµ‹è¯•ç®€åŒ–çš„è¯·æ±‚æ ¼å¼...');

        const settings = loadAISettings();
        if (!settings.apiType || !settings.apiUrl || !settings.apiKey) {
            console.log('âŒ è¯·å…ˆé…ç½®APIä¿¡æ¯');
            return false;
        }

        console.log('ğŸ“‹ å½“å‰é…ç½®:', settings);

        // æµ‹è¯•ä¸åŒçš„æ¨¡å‹åç§°
        const testModels = [
            'gemini-pro',
            'gpt-3.5-turbo',
            'gpt-4',
            settings.apiModel // åŸå§‹æ¨¡å‹åç§°
        ];

        for (const model of testModels) {
            console.log(`\nğŸ” æµ‹è¯•æ¨¡å‹: ${model}`);

            const testSettings = {
                ...settings,
                apiModel: model
            };

            try {
                const result = await callCustomAPI("æµ‹è¯•", testSettings, 10000);
                if (result && result.trim()) {
                    console.log(`âœ… æ¨¡å‹ ${model} æµ‹è¯•æˆåŠŸ: ${result}`);
                    toastr.success(`æ¨¡å‹ ${model} å¯ç”¨ï¼`, 'ğŸ§ª æµ‹è¯•æˆåŠŸ');
                    return { success: true, model: model, response: result };
                } else {
                    console.log(`âŒ æ¨¡å‹ ${model} è¿”å›ç©ºå†…å®¹`);
                }
            } catch (error) {
                console.log(`âŒ æ¨¡å‹ ${model} æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        console.log('\nğŸ’¡ å»ºè®®:');
        console.log('1. å°è¯•ä½¿ç”¨æ ‡å‡†æ¨¡å‹åç§° (gemini-pro, gpt-3.5-turbo)');
        console.log('2. æ£€æŸ¥APIæä¾›å•†æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨');
        console.log('3. ç¡®è®¤æ¨¡å‹åç§°æ ¼å¼æ˜¯å¦æ­£ç¡®');

        toastr.warning('æ‰€æœ‰æ¨¡å‹æµ‹è¯•éƒ½å¤±è´¥äº†', 'ğŸ§ª æµ‹è¯•å®Œæˆ', { timeOut: 5000 });
        return { success: false };
    };

    /**
     * å¿«é€ŸéªŒè¯æŠ±æŠ±åŠŸèƒ½æ˜¯å¦å®Œæ•´
     */
    window.quickVerifyHugFunction = function() {
        console.log('ğŸš€ å¿«é€ŸéªŒè¯æŠ±æŠ±åŠŸèƒ½æ˜¯å¦å®Œæ•´...');

        const checks = {
            hugFunctionExists: typeof window.hugPet === 'function',
            promptSupport: false,
            uiButton: false,
            rewardSystem: false
        };

        // æ£€æŸ¥æç¤ºè¯æ”¯æŒ
        try {
            const prompt = buildInteractionPrompt('hug');
            checks.promptSupport = prompt.includes('ç»™äº†æˆ‘ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±');
        } catch (e) {
            checks.promptSupport = false;
        }

        // æ£€æŸ¥UIæŒ‰é’®
        const popup = $("#virtual-pet-popup");
        if (popup.length > 0) {
            checks.uiButton = popup.find(".hug-btn").length > 0;
        }

        // æ£€æŸ¥å¥–åŠ±ç³»ç»Ÿ
        if (checks.hugFunctionExists) {
            const hugCode = window.hugPet.toString();
            checks.rewardSystem = hugCode.includes('gainCoins') && hugCode.includes('gainExperience');
        }

        console.log('\nğŸ“Š éªŒè¯ç»“æœ:');
        console.log(`âœ… hugPetå‡½æ•°å­˜åœ¨: ${checks.hugFunctionExists ? 'âœ…' : 'âŒ'}`);
        console.log(`âœ… æç¤ºè¯æ”¯æŒ: ${checks.promptSupport ? 'âœ…' : 'âŒ'}`);
        console.log(`âœ… UIæŒ‰é’®å­˜åœ¨: ${checks.uiButton ? 'âœ…' : 'âŒ'} ${!popup.length ? '(éœ€è¦å…ˆæ‰“å¼€å® ç‰©ç•Œé¢)' : ''}`);
        console.log(`âœ… å¥–åŠ±ç³»ç»Ÿ: ${checks.rewardSystem ? 'âœ…' : 'âŒ'}`);

        const allGood = checks.hugFunctionExists && checks.promptSupport && checks.rewardSystem;

        if (allGood) {
            console.log('\nğŸ‰ æŠ±æŠ±åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼');
            console.log('ğŸ’¡ ç‰¹ç‚¹: 25ç§’å†·å´ï¼Œ+10å¿«ä¹+3å¥åº·ï¼Œ2é‡‘å¸+1ç»éªŒ');
            toastr.success('ğŸ¤— æŠ±æŠ±åŠŸèƒ½éªŒè¯é€šè¿‡ï¼', '', { timeOut: 2000 });
        } else {
            console.log('\nâš ï¸ æŠ±æŠ±åŠŸèƒ½å¯èƒ½å­˜åœ¨é—®é¢˜');
            if (!checks.hugFunctionExists) console.log('ğŸ’¡ è¿è¡Œ: forceApplyTamagotchiSystem()');
        }

        return {
            allGood,
            details: checks,
            recommendation: allGood ? 'åŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥ä½¿ç”¨' : 'éœ€è¦æ£€æŸ¥æˆ–é‡æ–°åº”ç”¨æ‹“éº»æ­Œå­ç³»ç»Ÿ'
        };
    };

    /**
     * æµ‹è¯•æç¤ºè¯ç”Ÿæˆï¼ˆæ£€æŸ¥undefinedé—®é¢˜ï¼‰
     */
    window.testPromptGeneration = function() {
        console.log('ğŸ“ æµ‹è¯•æç¤ºè¯ç”Ÿæˆï¼ˆæ£€æŸ¥undefinedé—®é¢˜ï¼‰...');

        const actions = ['feed', 'play', 'sleep', 'hug'];

        actions.forEach(action => {
            console.log(`\nğŸ§ª æµ‹è¯• ${action} åŠ¨ä½œ:`);

            try {
                const prompt = buildInteractionPrompt(action);

                // æ£€æŸ¥æ˜¯å¦åŒ…å«undefined
                const hasUndefined = prompt.includes('undefined');
                console.log(`- åŒ…å«undefined: ${hasUndefined ? 'âŒ æ˜¯' : 'âœ… å¦'}`);

                // æå–æƒ…æ™¯éƒ¨åˆ†
                const scenarioMatch = prompt.match(/ã€æƒ…æ™¯ã€‘ï¼š(.+?)ã€‚/);
                if (scenarioMatch) {
                    console.log(`- æƒ…æ™¯æè¿°: "${scenarioMatch[1]}"`);
                } else {
                    console.log('- æƒ…æ™¯æè¿°: âŒ æœªæ‰¾åˆ°');
                }

                // æ£€æŸ¥åŠ¨ä½œæè¿°
                const actionDescriptions = {
                    'feed': 'ç»™æˆ‘å–‚äº†é£Ÿç‰©',
                    'play': 'é™ªæˆ‘ç©è€',
                    'sleep': 'è®©æˆ‘ä¼‘æ¯',
                    'hug': 'ç»™äº†æˆ‘ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±'
                };

                const expectedDesc = actionDescriptions[action];
                const hasCorrectDesc = prompt.includes(expectedDesc);
                console.log(`- é¢„æœŸæè¿°: "${expectedDesc}"`);
                console.log(`- æè¿°æ­£ç¡®: ${hasCorrectDesc ? 'âœ… æ˜¯' : 'âŒ å¦'}`);

            } catch (error) {
                console.log(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        });

        console.log('\nğŸ’¡ å¦‚æœå‘ç°undefinedé—®é¢˜:');
        console.log('1. æ£€æŸ¥actionDescriptionså¯¹è±¡æ˜¯å¦åŒ…å«æ‰€æœ‰åŠ¨ä½œ');
        console.log('2. æ£€æŸ¥ä¼ é€’ç»™buildInteractionPromptçš„å‚æ•°æ˜¯å¦æ­£ç¡®');
        console.log('3. æ£€æŸ¥æ˜¯å¦æœ‰æ‹¼å†™é”™è¯¯');

        return true;
    };

    /**
     * è¯Šæ–­å’Œä¿®å¤75æ•°å€¼é—®é¢˜
     */
    window.diagnose75ValueIssue = function() {
        console.log('ğŸ” è¯Šæ–­75æ•°å€¼é—®é¢˜...');

        console.log('\nğŸ“Š å½“å‰å® ç‰©çŠ¶æ€:');
        console.log(`- å¥åº·: ${petData.health}/100`);
        console.log(`- å¿«ä¹: ${petData.happiness}/100`);
        console.log(`- é¥±é£Ÿ: ${petData.hunger}/100`);
        console.log(`- ç²¾åŠ›: ${petData.energy}/100`);

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ•°å€¼éƒ½æ˜¯75
        const values = [petData.health, petData.happiness, petData.hunger, petData.energy];
        const allAre75 = values.every(val => val === 75);

        console.log('\nğŸ” é—®é¢˜åˆ†æ:');
        console.log(`- æ‰€æœ‰æ•°å€¼éƒ½æ˜¯75: ${allAre75 ? 'âœ… æ˜¯çš„ï¼Œè¿™å°±æ˜¯é—®é¢˜' : 'âŒ ä¸æ˜¯'}`);

        if (allAre75) {
            console.log('\nâŒ ç¡®è®¤é—®é¢˜: æ•°å€¼è¢«å¼ºåˆ¶é™åˆ¶åœ¨75');
            console.log('ğŸ”§ åŸå› : æ•°æ®åŠ è½½æ—¶çš„è¿‡é«˜æ•°å€¼æ£€æµ‹é€»è¾‘æœ‰é—®é¢˜');
            console.log('âœ… ä¿®å¤: å·²ç§»é™¤å¼ºåˆ¶75é™åˆ¶çš„ä»£ç ');
        }

        // æ£€æŸ¥æ•°æ®ç‰ˆæœ¬
        console.log('\nğŸ“‹ æ•°æ®ç‰ˆæœ¬ä¿¡æ¯:');
        console.log(`- æ•°æ®ç‰ˆæœ¬: ${petData.dataVersion}`);
        console.log(`- ä¸Šæ¬¡æ›´æ–°æ—¶é—´: ${new Date(petData.lastUpdateTime || 0).toLocaleString()}`);

        // æ£€æŸ¥æ—¶é—´å·®
        const now = Date.now();
        const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
        const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);
        console.log(`- è·ç¦»ä¸Šæ¬¡æ›´æ–°: ${hoursElapsed.toFixed(1)}å°æ—¶`);

        // æä¾›ä¿®å¤æ–¹æ¡ˆ
        console.log('\nğŸ”§ ä¿®å¤æ–¹æ¡ˆ:');

        if (allAre75) {
            console.log('1. é‡ç½®ä¸ºæ›´åˆç†çš„åˆå§‹æ•°å€¼:');

            // è®¾ç½®50ä¸Šé™ç³»ç»Ÿæ ‡å‡†æ•°å€¼
            petData.health = 30;
            petData.happiness = 25;
            petData.hunger = 35;
            petData.energy = 40;

            // æ›´æ–°æ—¶é—´æˆ³
            petData.lastUpdateTime = now;
            petData.lastFeedTime = now - 20000; // 20ç§’å‰
            petData.lastPlayTime = now - 30000; // 30ç§’å‰
            petData.lastSleepTime = now - 60000; // 1åˆ†é’Ÿå‰
            petData.lastHugTime = now - 15000; // 15ç§’å‰

            // ä¿å­˜æ•°æ®
            savePetData();

            console.log('âœ… å·²é‡ç½®æ•°å€¼:');
            console.log(`   - å¥åº·: 75 â†’ ${petData.health}`);
            console.log(`   - å¿«ä¹: 75 â†’ ${petData.happiness}`);
            console.log(`   - é¥±é£Ÿ: 75 â†’ ${petData.hunger}`);
            console.log(`   - ç²¾åŠ›: 75 â†’ ${petData.energy}`);

            // æ›´æ–°UI
            if (typeof updateUnifiedUIStatus === 'function') {
                updateUnifiedUIStatus();
            }
            if (typeof renderPetStatus === 'function') {
                renderPetStatus();
            }

            toastr.success('ğŸ¯ å·²ä¿®å¤75æ•°å€¼é—®é¢˜ï¼ç°åœ¨æ•°å€¼ä¼šæ­£å¸¸å˜åŒ–äº†', '', { timeOut: 5000 });
        }

        console.log('\nğŸ’¡ é¢„é˜²æªæ–½:');
        console.log('âœ… å·²ç§»é™¤å¼ºåˆ¶75é™åˆ¶çš„ä»£ç ');
        console.log('âœ… æ•°å€¼ç°åœ¨ä¼šæ ¹æ®æ—¶é—´è‡ªç„¶è¡°å‡');
        console.log('âœ… ç¼“å†²æœºåˆ¶åªåœ¨çœŸæ­£éœ€è¦æ—¶è§¦å‘');

        console.log('\nğŸ§ª æµ‹è¯•å»ºè®®:');
        console.log('1. å…³é—­å¹¶é‡æ–°æ‰“å¼€SillyTavern');
        console.log('2. è§‚å¯Ÿæ•°å€¼æ˜¯å¦ä¸å†å›ºå®šåœ¨75');
        console.log('3. è¿›è¡Œå‡ æ¬¡äº’åŠ¨ï¼Œè§‚å¯Ÿæ•°å€¼å˜åŒ–');

        return {
            wasFixed: allAre75,
            currentValues: {
                health: petData.health,
                happiness: petData.happiness,
                hunger: petData.hunger,
                energy: petData.energy
            },
            hoursElapsed: hoursElapsed
        };
    };



    /**
     * è¯Šæ–­æ•°å€¼é‡ç½®é—®é¢˜
     */
    window.diagnoseValueResetIssue = function() {
        console.log('ğŸ” è¯Šæ–­æ•°å€¼é‡ç½®é—®é¢˜...');

        // æ£€æŸ¥å½“å‰æ•°æ®ç‰ˆæœ¬
        console.log('\nğŸ“Š å½“å‰æ•°æ®çŠ¶æ€:');
        console.log(`- æ•°æ®ç‰ˆæœ¬: ${petData.dataVersion}`);
        console.log(`- å¥åº·: ${petData.health}/100`);
        console.log(`- å¿«ä¹: ${petData.happiness}/100`);
        console.log(`- é¥±é£Ÿ: ${petData.hunger}/100`);
        console.log(`- ç²¾åŠ›: ${petData.energy}/100`);

        // æ£€æŸ¥å­˜å‚¨çš„æ•°æ®
        console.log('\nğŸ’¾ å­˜å‚¨æ•°æ®æ£€æŸ¥:');
        const localData = localStorage.getItem(STORAGE_KEY_PET_DATA);
        const syncData = loadFromSyncStorage();

        console.log(`- æœ¬åœ°å­˜å‚¨: ${localData ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
        console.log(`- åŒæ­¥å­˜å‚¨: ${syncData ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);

        if (localData) {
            try {
                const parsed = JSON.parse(localData);
                console.log(`- æœ¬åœ°æ•°æ®ç‰ˆæœ¬: ${parsed.dataVersion}`);
                console.log(`- æœ¬åœ°æ•°å€¼: å¥åº·${parsed.health}, å¿«ä¹${parsed.happiness}, é¥±é£Ÿ${parsed.hunger}, ç²¾åŠ›${parsed.energy}`);
            } catch (e) {
                console.log('- æœ¬åœ°æ•°æ®è§£æå¤±è´¥');
            }
        }

        if (syncData) {
            try {
                const parsed = typeof syncData === 'object' ? syncData : JSON.parse(syncData);
                console.log(`- åŒæ­¥æ•°æ®ç‰ˆæœ¬: ${parsed.dataVersion}`);
                console.log(`- åŒæ­¥æ•°å€¼: å¥åº·${parsed.health}, å¿«ä¹${parsed.happiness}, é¥±é£Ÿ${parsed.hunger}, ç²¾åŠ›${parsed.energy}`);
            } catch (e) {
                console.log('- åŒæ­¥æ•°æ®è§£æå¤±è´¥');
            }
        }

        // æ£€æŸ¥æ—¶é—´ä¿¡æ¯
        console.log('\nâ° æ—¶é—´ä¿¡æ¯:');
        const now = Date.now();
        const timeSinceLastUpdate = now - (petData.lastUpdateTime || now);
        const hoursElapsed = timeSinceLastUpdate / (1000 * 60 * 60);
        console.log(`- è·ç¦»ä¸Šæ¬¡æ›´æ–°: ${hoursElapsed.toFixed(1)}å°æ—¶`);
        console.log(`- ä¸Šæ¬¡æ›´æ–°æ—¶é—´: ${new Date(petData.lastUpdateTime || 0).toLocaleString()}`);

        // åˆ†æå¯èƒ½çš„é‡ç½®åŸå› 
        console.log('\nğŸ” å¯èƒ½çš„é‡ç½®åŸå› åˆ†æ:');

        if (!petData.dataVersion || petData.dataVersion < 4.0) {
            console.log('âŒ æ•°æ®ç‰ˆæœ¬è¿‡ä½ï¼Œä¼šè§¦å‘è¿ç§»é‡ç½®');
        } else {
            console.log('âœ… æ•°æ®ç‰ˆæœ¬æ­£å¸¸ï¼Œä¸ä¼šè§¦å‘è¿ç§»');
        }

        if (hoursElapsed > 2) {
            console.log('âš ï¸ é•¿æ—¶é—´ç¦»çº¿ï¼Œä¼šè§¦å‘åˆå§‹åŒ–ç¼“å†²');
        } else {
            console.log('âœ… ç¦»çº¿æ—¶é—´æ­£å¸¸ï¼Œä¸ä¼šè§¦å‘ç¼“å†²');
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°å€¼é™åˆ¶
        const hasValueCaps = petData.health > 50 || petData.happiness > 50 ||
                            petData.hunger > 50 || petData.energy > 50;

        if (hasValueCaps) {
            console.log('âš ï¸ æ£€æµ‹åˆ°æ•°å€¼è¶…è¿‡50ä¸Šé™');
        } else {
            console.log('âœ… æ•°å€¼åœ¨50ä¸Šé™èŒƒå›´å†…');
        }

        console.log('\nğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ:');

        if (!petData.dataVersion || petData.dataVersion < 4.0) {
            console.log('1. æ•°æ®ç‰ˆæœ¬é—®é¢˜ - è¿è¡Œ: petData.dataVersion = 4.0; savePetData();');
        }

        if (hoursElapsed > 2) {
            console.log('2. ç¼“å†²æœºåˆ¶é—®é¢˜ - è¿è¡Œ: petData.lastUpdateTime = Date.now(); savePetData();');
        }

        if (hasValueCaps) {
            console.log('3. æ•°å€¼è¶…é™é—®é¢˜ - è¿è¡Œ: testSmartInitSystem();');
        }

        console.log('\nğŸ§ª æµ‹è¯•æ­¥éª¤:');
        console.log('1. è®°å½•å½“å‰æ•°å€¼');
        console.log('2. å…³é—­å¹¶é‡æ–°æ‰“å¼€SillyTavern');
        console.log('3. è§‚å¯Ÿæ•°å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–');
        console.log('4. å¦‚æœå˜åŒ–ï¼Œè¿è¡Œæ­¤è¯Šæ–­å‡½æ•°æŸ¥çœ‹åŸå› ');

        return {
            dataVersion: petData.dataVersion,
            currentValues: {
                health: petData.health,
                happiness: petData.happiness,
                hunger: petData.hunger,
                energy: petData.energy
            },
            hoursElapsed: hoursElapsed,
            hasLocalData: !!localData,
            hasSyncData: !!syncData,
            needsMigration: !petData.dataVersion || petData.dataVersion < 4.0,
            needsBuffer: hoursElapsed > 2,
            hasValueCaps: hasValueCaps
        };
    };



    /**
     * æµ‹è¯•æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿ
     */
    window.testSmartInitSystem = function() {
        console.log('ğŸ§ª æµ‹è¯•æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿ...');

        console.log('\nğŸ“Š å½“å‰çŠ¶æ€:');
        console.log(`- å¥åº·: ${petData.health}/100`);
        console.log(`- å¿«ä¹: ${petData.happiness}/100`);
        console.log(`- é¥±é£Ÿ: ${petData.hunger}/100`);
        console.log(`- ç²¾åŠ›: ${petData.energy}/100`);
        console.log(`- å·²éšæœºåŒ–: ${petData.hasBeenRandomized ? 'âœ…' : 'âŒ'}`);

        console.log('\nğŸ² æ¨¡æ‹Ÿé¦–æ¬¡æ‰“å¼€éšæœºåŒ–:');
        const oldValues = {
            health: petData.health,
            happiness: petData.happiness,
            hunger: petData.hunger,
            energy: petData.energy
        };

        // é‡ç½®éšæœºåŒ–æ ‡è®°
        petData.hasBeenRandomized = false;

        // åº”ç”¨éšæœºåŒ–
        applyFirstTimeRandomization();

        console.log('éšæœºåŒ–ç»“æœ:');
        console.log(`- å¥åº·: ${oldValues.health} â†’ ${petData.health} (${petData.health <= 50 ? 'âœ…' : 'âŒ'} â‰¤50)`);
        console.log(`- å¿«ä¹: ${oldValues.happiness} â†’ ${petData.happiness} (${petData.happiness <= 50 ? 'âœ…' : 'âŒ'} â‰¤50)`);
        console.log(`- é¥±é£Ÿ: ${oldValues.hunger} â†’ ${petData.hunger} (${petData.hunger <= 50 ? 'âœ…' : 'âŒ'} â‰¤50)`);
        console.log(`- ç²¾åŠ›: ${oldValues.energy} â†’ ${petData.energy} (${petData.energy <= 50 ? 'âœ…' : 'âŒ'} â‰¤50)`);

        // ä¿å­˜æ•°æ®
        savePetData();

        console.log('\nğŸ’¡ ç³»ç»Ÿç‰¹ç‚¹:');
        console.log('âœ… é¦–æ¬¡æ‰“å¼€ï¼šæ•°å€¼éšæœºåŒ–åˆ°50ä»¥ä¸‹');
        console.log('âœ… åç»­ä½¿ç”¨ï¼šæ•°å€¼è‡ªç„¶è¡°å‡ï¼Œä¸å†å¼ºåˆ¶é‡ç½®');
        console.log('âœ… æ»¡å€¼ä¸Šé™ï¼š100ï¼ˆå¯ä»¥é€šè¿‡äº’åŠ¨è¾¾åˆ°ï¼‰');
        console.log('âœ… é•¿æœŸç¦»çº¿ï¼šæœ‰ç¼“å†²ä¿æŠ¤æœºåˆ¶');

        console.log('\nğŸ® ä½¿ç”¨æµç¨‹:');
        console.log('1. é¦–æ¬¡æ‰“å¼€ â†’ éšæœºåŒ–åˆ°50ä»¥ä¸‹');
        console.log('2. äº’åŠ¨æå‡ â†’ å¯ä»¥è¶…è¿‡50ï¼Œæœ€é«˜100');
        console.log('3. æ—¶é—´è¡°å‡ â†’ æ ¹æ®ç¦»çº¿æ—¶é—´è‡ªç„¶ä¸‹é™');
        console.log('4. é‡æ–°æ‰“å¼€ â†’ ä¸å†é‡ç½®ï¼Œä¿æŒè¡°å‡åçš„æ•°å€¼');

        return {
            system: 'æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿ',
            firstTimeRandomized: petData.hasBeenRandomized,
            currentValues: {
                health: petData.health,
                happiness: petData.happiness,
                hunger: petData.hunger,
                energy: petData.energy
            },
            maxValues: 100,
            firstTimeCap: 50
        };
    };

    /**
     * é‡ç½®éšæœºåŒ–æ ‡è®°ï¼ˆç”¨äºæµ‹è¯•ï¼‰
     */
    window.resetRandomizationFlag = function() {
        petData.hasBeenRandomized = false;
        savePetData();
        console.log('âœ… éšæœºåŒ–æ ‡è®°å·²é‡ç½®ï¼Œä¸‹æ¬¡åŠ è½½æ•°æ®æ—¶ä¼šé‡æ–°éšæœºåŒ–');
        toastr.info('éšæœºåŒ–æ ‡è®°å·²é‡ç½®', '', { timeOut: 2000 });
    };

    console.log("ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿè„šæœ¬å·²åŠ è½½å®Œæˆ");
    console.log("ğŸ² æ™ºèƒ½åˆå§‹åŒ–ç³»ç»Ÿï¼šé¦–æ¬¡æ‰“å¼€éšæœºåŒ–åˆ°50ä»¥ä¸‹ï¼Œåç»­è‡ªç„¶è¡°å‡åˆ°100");
});
