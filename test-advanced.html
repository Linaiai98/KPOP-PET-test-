<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ - æ™ºèƒ½APIé…ç½®æµ‹è¯•</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #2b2b2b;
            color: #fff;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #3b3b3b;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #4b4b4b;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            background: #2b2b2b;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .config-display {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ - æ™ºèƒ½APIé…ç½®åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. æ¨¡æ‹ŸSillyTavernç¯å¢ƒ</h2>
            <p>è¿™ä¸ªæµ‹è¯•é¡µé¢æ¨¡æ‹Ÿäº†SillyTavernçš„ç¯å¢ƒï¼ŒåŒ…æ‹¬é…ç½®æ•°æ®ç»“æ„ã€‚</p>
            <button onclick="setupMockSillyTavern()">è®¾ç½®æ¨¡æ‹ŸSillyTavernç¯å¢ƒ</button>
            <div id="extensions_settings2" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>2. SillyTaverné…ç½®ä¾¦æµ‹æµ‹è¯•</h2>
            <button onclick="testDetection()">ğŸ•µï¸ ä¾¦æµ‹SillyTaverné…ç½®</button>
            <button onclick="testPopulateDropdown()">ğŸ”„ åŠ¨æ€å¡«å……ä¸‹æ‹‰æ¡†</button>
            <button onclick="testApiEndpointInfo()">ğŸ“Š æµ‹è¯•ç«¯ç‚¹ä¿¡æ¯è·å–</button>
            <button onclick="clearStorage()">ğŸ—‘ï¸ æ¸…é™¤å­˜å‚¨æ•°æ®</button>
            <div id="test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>3. å½“å‰é…ç½®çŠ¶æ€</h2>
            <div id="current-config" class="config-display">
                <strong>å½“å‰é…ç½®:</strong> æœªåŠ è½½
            </div>
            <button onclick="refreshConfigDisplay()">ğŸ”„ åˆ·æ–°é…ç½®æ˜¾ç¤º</button>
        </div>

        <div class="test-section">
            <h2>4. æ‰‹åŠ¨æµ‹è¯•åŒºåŸŸ</h2>
            <label>é€‰æ‹©é…ç½®:</label>
            <select id="manual-config-select">
                <option value="">è¯·å…ˆè¿è¡Œä¾¦æµ‹</option>
            </select>
            <br>
            <button onclick="manualConfigTest()">æµ‹è¯•é€‰ä¸­é…ç½®</button>
        </div>
    </div>

    <script src="index.js"></script>
    <script>
        function log(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setupMockSillyTavern() {
            log('ğŸ”§ è®¾ç½®æ¨¡æ‹ŸSillyTavernç¯å¢ƒ...');
            
            // æ¨¡æ‹Ÿ window.stores ç»“æ„
            window.stores = {
                connections: {
                    connections: [
                        {
                            name: "æœ¬åœ°Oobabooga",
                            uri: "http://127.0.0.1:5000/api/v1/generate",
                            api_key: null,
                            enabled: true
                        },
                        {
                            name: "OpenAI GPT-4",
                            uri: "https://api.openai.com/v1/completions",
                            api_key: "sk-test123456789",
                            enabled: true
                        },
                        {
                            name: "Claude API",
                            uri: "https://api.anthropic.com/v1/messages",
                            api_key: "claude-key-123",
                            enabled: false
                        }
                    ]
                }
            };
            
            log('âœ… æ¨¡æ‹Ÿç¯å¢ƒè®¾ç½®å®Œæˆ');
            log(`ğŸ“Š æ¨¡æ‹Ÿäº† ${window.stores.connections.connections.length} ä¸ªAPIé…ç½®`);
        }

        function testDetection() {
            log('ğŸ•µï¸ å¼€å§‹ä¾¦æµ‹æµ‹è¯•...');
            
            try {
                const result = detectSillyTavernConfigs();
                log(`ä¾¦æµ‹ç»“æœ: ${result.found ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                log(`æ•°æ®è·¯å¾„: ${result.dataPath || 'æœªæ‰¾åˆ°'}`);
                log(`é…ç½®æ•°é‡: ${result.configs.length}`);
                
                if (result.configs.length > 0) {
                    result.configs.forEach((config, index) => {
                        log(`é…ç½® ${index + 1}: ${config.name || 'æœªå‘½å'} -> ${config.uri || config.url || 'æ— URL'}`);
                    });
                }
                
                log('âœ… ä¾¦æµ‹æµ‹è¯•å®Œæˆ');
            } catch (error) {
                log(`âŒ ä¾¦æµ‹æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        function testPopulateDropdown() {
            log('ğŸ”„ æµ‹è¯•åŠ¨æ€å¡«å……ä¸‹æ‹‰æ¡†...');
            
            try {
                populateApiDropdownFromSillyTavern();
                
                const dropdown = $("#virtual-pet-api-endpoint-select");
                const optionCount = dropdown.find('option').length;
                log(`ä¸‹æ‹‰æ¡†é€‰é¡¹æ•°é‡: ${optionCount}`);
                
                dropdown.find('option').each(function(index) {
                    log(`é€‰é¡¹ ${index + 1}: ${$(this).text()} (å€¼: ${$(this).val()})`);
                });
                
                log('âœ… ä¸‹æ‹‰æ¡†å¡«å……æµ‹è¯•å®Œæˆ');
            } catch (error) {
                log(`âŒ ä¸‹æ‹‰æ¡†å¡«å……æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        function testApiEndpointInfo() {
            log('ğŸ“Š æµ‹è¯•ç«¯ç‚¹ä¿¡æ¯è·å–...');
            
            try {
                const endpointInfo = getUserApiEndpoint();
                log(`å½“å‰ç«¯ç‚¹URL: ${endpointInfo.url}`);
                log(`APIå¯†é’¥: ${endpointInfo.apiKey ? 'å·²é…ç½®' : 'æœªé…ç½®'}`);
                log(`é…ç½®æ¥æº: ${endpointInfo.source}`);
                if (endpointInfo.name) {
                    log(`é…ç½®åç§°: ${endpointInfo.name}`);
                }
                
                log('âœ… ç«¯ç‚¹ä¿¡æ¯è·å–æµ‹è¯•å®Œæˆ');
            } catch (error) {
                log(`âŒ ç«¯ç‚¹ä¿¡æ¯è·å–æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        function refreshConfigDisplay() {
            try {
                const endpointInfo = getUserApiEndpoint();
                const configDiv = document.getElementById('current-config');
                
                let configText = `<strong>å½“å‰é…ç½®:</strong><br>`;
                configText += `URL: ${endpointInfo.url}<br>`;
                configText += `æ¥æº: ${endpointInfo.source}<br>`;
                configText += `APIå¯†é’¥: ${endpointInfo.apiKey ? 'å·²é…ç½®' : 'æœªé…ç½®'}<br>`;
                if (endpointInfo.name) {
                    configText += `åç§°: ${endpointInfo.name}<br>`;
                }
                
                configDiv.innerHTML = configText;
            } catch (error) {
                document.getElementById('current-config').innerHTML = `<strong>é…ç½®åŠ è½½å¤±è´¥:</strong> ${error.message}`;
            }
        }

        function clearStorage() {
            localStorage.clear();
            log('ğŸ—‘ï¸ å­˜å‚¨æ•°æ®å·²æ¸…é™¤');
            refreshConfigDisplay();
        }

        function manualConfigTest() {
            const select = document.getElementById('manual-config-select');
            const selectedValue = select.value;
            
            if (!selectedValue) {
                log('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®');
                return;
            }
            
            log(`ğŸ§ª æ‰‹åŠ¨æµ‹è¯•é…ç½®: ${selectedValue}`);
            
            // ä¿å­˜é€‰æ‹©çš„é…ç½®
            saveApiEndpointSettings(selectedValue);
            
            // è·å–å¹¶æ˜¾ç¤ºç»“æœ
            testApiEndpointInfo();
            refreshConfigDisplay();
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        $(document).ready(function() {
            log('ğŸ“„ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('ğŸš€ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–...');
            
            // è®¾ç½®æ¨¡æ‹Ÿç¯å¢ƒ
            setupMockSillyTavern();
            
            // åˆ·æ–°é…ç½®æ˜¾ç¤º
            setTimeout(() => {
                refreshConfigDisplay();
            }, 1000);
        });
    </script>
</body>
</html>
