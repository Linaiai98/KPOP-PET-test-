# 🐾 虚拟宠物聊天功能使用指南

## 功能概述

新增的聊天功能允许您与虚拟宠物进行AI对话，宠物会根据其当前状态（健康、快乐、饥饿、精力）和设定的人设来回应您的消息。

## 如何使用

### 1. 进入聊天界面

1. 点击虚拟宠物浮动按钮打开宠物弹窗
2. 在主界面中点击 **💬 聊天** 按钮
3. 进入聊天界面，可以看到宠物的欢迎消息

### 2. 与宠物聊天

1. 在底部的文本框中输入您想说的话
2. 点击 **发送** 按钮或按 **回车键** 发送消息
3. 宠物会根据其人设和当前状态回复您

### 3. 返回主界面

点击 **← 返回** 按钮回到宠物主界面

## 功能特点

### 🎭 个性化回复
- 宠物会根据设定的人设来回应
- 回复会考虑宠物当前的健康、快乐、饥饿、精力状态
- 每个宠物都有独特的对话风格

### 💭 对话记忆
- 系统会记住最近的对话内容
- 宠物能够基于之前的对话进行连贯回复
- 自动管理对话历史，避免内存过载

### 🎨 美观界面
- 用户消息显示在右侧（粉色气泡）
- 宠物消息显示在左侧（绿色气泡）
- 支持消息滚动和动画效果

### ⚡ 智能优化
- 回复长度控制在100字以内，简短有趣
- 自动显示"正在思考..."提示
- 错误处理和重试机制

## 前置要求

### API配置
使用聊天功能前，需要在插件设置中配置AI API：

1. 打开SillyTavern的扩展管理页面
2. 找到虚拟宠物系统设置
3. 配置以下信息：
   - **API类型**：选择您使用的AI服务
   - **API URL**：填入API地址
   - **API密钥**：填入您的API密钥
   - **模型名称**：选择合适的AI模型

### 宠物人设
确保已设置宠物人设：

1. 在扩展设置中选择人设类型
2. 可选择预设人设或自定义人设
3. 人设会影响宠物的对话风格和回复内容

## 技术实现

### 核心函数
- `showChatView()` - 显示聊天界面
- `handleSendMessage()` - 处理消息发送
- `addMessageToChatbox()` - 添加消息到聊天框
- `buildChatPrompt()` - 构建AI提示词
- `callCustomAPIForChat()` - 调用AI API

### 数据管理
- 聊天历史存储在 `chatHistory` 数组中
- 自动限制历史记录长度（最多20条）
- 与现有的宠物数据系统完全兼容

### UI组件
- 新增聊天视图 `#pet-chat-view`
- 消息容器 `#chat-messages-container`
- 输入区域 `#chat-user-input` 和 `#chat-send-btn`

## 故障排除

### 常见问题

**Q: 点击聊天按钮没有反应**
A: 检查浏览器控制台是否有错误，确保所有脚本正确加载

**Q: 宠物不回复消息**
A: 
1. 检查API配置是否正确
2. 确认API密钥有效且有足够额度
3. 查看控制台错误信息

**Q: 回复内容不符合宠物人设**
A: 
1. 检查人设配置是否正确
2. 尝试重新设置宠物人设
3. 确认getCurrentPersonality()函数返回正确内容

**Q: 聊天界面样式异常**
A: 
1. 确认style.css文件包含聊天样式
2. 检查CSS变量是否正确定义
3. 清除浏览器缓存后重试

### 调试命令

在浏览器控制台中可以使用以下命令进行调试：

```javascript
// 检查聊天历史
console.log(chatHistory);

// 测试消息添加
addMessageToChatbox('pet', '测试消息');

// 检查当前人设
console.log(getCurrentPersonality());

// 检查AI设置
console.log(loadAISettings());
```

## 更新日志

### v1.0.0 (2024-07-14)
- ✨ 新增聊天功能
- 🎨 添加聊天界面UI
- 💬 实现AI对话系统
- 🔧 集成现有API配置
- 📱 支持移动端操作

## 反馈与支持

如果您在使用聊天功能时遇到问题或有改进建议，请：

1. 检查控制台错误信息
2. 确认API配置正确
3. 尝试重启SillyTavern
4. 查看本指南的故障排除部分

聊天功能让您的虚拟宠物更加生动有趣，享受与您的数字伙伴的对话时光！🐾💕
