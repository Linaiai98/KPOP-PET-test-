<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase UI æµ‹è¯•</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        /* æ¨¡æ‹ŸSillyTavernçš„æ‰©å±•è®¾ç½®å®¹å™¨ */
        #extensions_settings2 {
            background: #2a2a2a;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* ç¡®ä¿Firebaseè®¾ç½®åœ¨æ·±è‰²èƒŒæ™¯ä¸‹å¯è§ */
        #extensions_settings2 input,
        #extensions_settings2 select,
        #extensions_settings2 button {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            padding: 8px;
            border-radius: 4px;
        }
        
        #extensions_settings2 button {
            background: #007bff;
            cursor: pointer;
        }
        
        #extensions_settings2 button:hover {
            background: #0056b3;
        }
        
        #extensions_settings2 button:disabled {
            background: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”¥ Firebase UI æµ‹è¯•é¡µé¢</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•è™šæ‹Ÿå® ç‰©æ’ä»¶çš„Firebaseè®¾ç½®ç•Œé¢æ˜¯å¦æ­£å¸¸æ˜¾ç¤ºå’Œå·¥ä½œã€‚</p>
            <ul>
                <li>æ£€æŸ¥Firebaseè®¾ç½®ç•Œé¢æ˜¯å¦æ­£ç¡®æ¸²æŸ“</li>
                <li>éªŒè¯æŒ‰é’®å’Œè¾“å…¥æ¡†æ˜¯å¦å¯ä»¥æ­£å¸¸äº¤äº’</li>
                <li>æµ‹è¯•Firebaseè¿æ¥çŠ¶æ€æ˜¾ç¤º</li>
                <li>éªŒè¯äº‹ä»¶å¤„ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ” åŠ è½½çŠ¶æ€</h3>
            <div id="loading-status" class="status info">æ­£åœ¨åŠ è½½æ’ä»¶...</div>
        </div>

        <!-- æ¨¡æ‹ŸSillyTavernçš„æ‰©å±•è®¾ç½®å®¹å™¨ -->
        <div id="extensions_settings2">
            <h3>ğŸ“¦ æ‰©å±•è®¾ç½®å®¹å™¨ (æ¨¡æ‹ŸSillyTavern)</h3>
            <p>æ’ä»¶çš„è®¾ç½®ç•Œé¢å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•æ“ä½œ</h3>
            <button onclick="testFirebaseStatus()">æµ‹è¯•FirebaseçŠ¶æ€æ›´æ–°</button>
            <button onclick="testFirebasePanel()">æµ‹è¯•Firebaseé¢æ¿æ‰“å¼€</button>
            <button onclick="simulateAuthChange()">æ¨¡æ‹Ÿè®¤è¯çŠ¶æ€å˜åŒ–</button>
            <button onclick="checkElements()">æ£€æŸ¥DOMå…ƒç´ </button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿtoastrå¦‚æœä¸å­˜åœ¨
        if (typeof toastr === 'undefined') {
            window.toastr = {
                success: (msg) => console.log('SUCCESS:', msg),
                error: (msg) => console.log('ERROR:', msg),
                warning: (msg) => console.log('WARNING:', msg),
                info: (msg) => console.log('INFO:', msg)
            };
        }

        // åŠ è½½æ’ä»¶
        $(document).ready(function() {
            console.log('ğŸš€ å¼€å§‹åŠ è½½è™šæ‹Ÿå® ç‰©æ’ä»¶...');
            
            // åŠ¨æ€åŠ è½½æ’ä»¶çš„ä¸»æ–‡ä»¶
            const script = document.createElement('script');
            script.src = './index.js';
            script.onload = function() {
                $('#loading-status').removeClass('info').addClass('success').text('âœ… æ’ä»¶åŠ è½½å®Œæˆ');
                console.log('âœ… æ’ä»¶åŠ è½½å®Œæˆ');
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æ’ä»¶å®Œå…¨åˆå§‹åŒ–
                setTimeout(checkPluginStatus, 2000);
            };
            script.onerror = function() {
                $('#loading-status').removeClass('info').addClass('error').text('âŒ æ’ä»¶åŠ è½½å¤±è´¥');
                console.error('âŒ æ’ä»¶åŠ è½½å¤±è´¥');
            };
            document.head.appendChild(script);
        });

        function checkPluginStatus() {
            const results = [];
            
            // æ£€æŸ¥è®¾ç½®é¢æ¿æ˜¯å¦å­˜åœ¨
            const settingsPanel = $('#virtual-pet-settings');
            if (settingsPanel.length > 0) {
                results.push('âœ… è®¾ç½®é¢æ¿å·²åˆ›å»º');
                
                // æ£€æŸ¥Firebaseè®¾ç½®éƒ¨åˆ†
                const firebaseSection = $('#firebase-status-value');
                if (firebaseSection.length > 0) {
                    results.push('âœ… Firebaseè®¾ç½®ç•Œé¢å·²æ˜¾ç¤º');
                } else {
                    results.push('âŒ Firebaseè®¾ç½®ç•Œé¢æœªæ‰¾åˆ°');
                }
                
                // æ£€æŸ¥FirebaseæŒ‰é’®
                const firebaseButtons = $('#copy-uid-button, #pull-from-id-button, #open-firebase-panel-btn');
                results.push(`ğŸ“Š FirebaseæŒ‰é’®æ•°é‡: ${firebaseButtons.length}/3`);
                
            } else {
                results.push('âŒ è®¾ç½®é¢æ¿æœªåˆ›å»º');
            }
            
            // æ£€æŸ¥Firebaseæ¨¡å—
            if (window.FirebaseService) {
                results.push('âœ… FirebaseService å·²åŠ è½½');
            } else {
                results.push('âš ï¸ FirebaseService æœªåŠ è½½');
            }
            
            if (window.FirebaseUI) {
                results.push('âœ… FirebaseUI å·²åŠ è½½');
            } else {
                results.push('âš ï¸ FirebaseUI æœªåŠ è½½');
            }
            
            $('#test-results').html(results.map(r => `<div class="status ${r.startsWith('âœ…') ? 'success' : r.startsWith('âŒ') ? 'error' : 'warning'}">${r}</div>`).join(''));
        }

        function testFirebaseStatus() {
            console.log('ğŸ§ª æµ‹è¯•FirebaseçŠ¶æ€æ›´æ–°...');
            if (typeof window.initializeFirebaseSettings === 'function') {
                // å¦‚æœå‡½æ•°å­˜åœ¨ï¼Œè°ƒç”¨å®ƒ
                console.log('è°ƒç”¨ initializeFirebaseSettings...');
            } else {
                console.log('initializeFirebaseSettings å‡½æ•°æœªæ‰¾åˆ°');
            }
            
            // æ‰‹åŠ¨æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusEl = $('#firebase-status-value');
            if (statusEl.length > 0) {
                statusEl.text('æµ‹è¯•çŠ¶æ€').css('color', 'blue');
                toastr.info('FirebaseçŠ¶æ€å·²æ›´æ–°ä¸ºæµ‹è¯•çŠ¶æ€');
            } else {
                toastr.error('FirebaseçŠ¶æ€å…ƒç´ æœªæ‰¾åˆ°');
            }
        }

        function testFirebasePanel() {
            console.log('ğŸ§ª æµ‹è¯•Firebaseé¢æ¿æ‰“å¼€...');
            const panelBtn = $('#open-firebase-panel-btn');
            if (panelBtn.length > 0) {
                panelBtn.click();
                toastr.info('å·²ç‚¹å‡»Firebaseé¢æ¿æŒ‰é’®');
            } else {
                toastr.error('Firebaseé¢æ¿æŒ‰é’®æœªæ‰¾åˆ°');
            }
        }

        function simulateAuthChange() {
            console.log('ğŸ§ª æ¨¡æ‹Ÿè®¤è¯çŠ¶æ€å˜åŒ–...');
            const mockUser = {
                uid: 'test-uid-' + Date.now(),
                email: 'test@example.com'
            };
            
            // è§¦å‘è®¤è¯çŠ¶æ€å˜åŒ–äº‹ä»¶
            const event = new CustomEvent('firebase-auth-state-changed', {
                detail: { user: mockUser }
            });
            document.dispatchEvent(event);
            toastr.success('å·²æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•: ' + mockUser.uid);
        }

        function checkElements() {
            console.log('ğŸ§ª æ£€æŸ¥DOMå…ƒç´ ...');
            const elements = [
                '#virtual-pet-settings',
                '#firebase-status-value',
                '#firebase-uid',
                '#copy-uid-button',
                '#sync-id-input',
                '#pull-from-id-button',
                '#open-firebase-panel-btn'
            ];
            
            const results = elements.map(selector => {
                const el = $(selector);
                return `${selector}: ${el.length > 0 ? 'âœ…' : 'âŒ'} (${el.length}ä¸ª)`;
            });
            
            console.log('DOMå…ƒç´ æ£€æŸ¥ç»“æœ:', results);
            alert('DOMå…ƒç´ æ£€æŸ¥ç»“æœ:\n' + results.join('\n'));
        }
    </script>
</body>
</html>
