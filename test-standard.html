<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ - æ ‡å‡†åŒ–ç‰ˆæœ¬æµ‹è¯•</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #2b2b2b;
            color: #fff;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #3b3b3b;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #4b4b4b;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .side-by-side {
            display: flex;
            gap: 20px;
        }
        .side-by-side > div {
            flex: 1;
        }
        #extensions_settings2 {
            background: #2b2b2b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¾ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ - æ ‡å‡†åŒ–ç‰ˆæœ¬æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. SillyTavernç¯å¢ƒæ¨¡æ‹Ÿ</h2>
            <p>æ¨¡æ‹ŸSillyTavernçš„æ ‡å‡†æ‰©å±•ç¯å¢ƒï¼ŒåŒ…æ‹¬extension_settingsã€getContextç­‰APIã€‚</p>
            <button onclick="setupSillyTavernEnvironment()">ğŸ­ è®¾ç½®SillyTavernç¯å¢ƒ</button>
            <button onclick="clearEnvironment()">ğŸ§¹ æ¸…é™¤ç¯å¢ƒ</button>
            <div id="env-log" class="log" style="max-height: 150px;"></div>
        </div>

        <div class="side-by-side">
            <div class="test-section">
                <h2>2. æ‰©å±•åŠŸèƒ½æµ‹è¯•</h2>
                <button onclick="testExtensionLoading()">ğŸ“¦ æµ‹è¯•æ‰©å±•åŠ è½½</button>
                <button onclick="testSettingsManagement()">âš™ï¸ æµ‹è¯•è®¾ç½®ç®¡ç†</button>
                <button onclick="testApiIntrospection()">ğŸ•µï¸ æµ‹è¯•APIå†…çœ</button>
                <button onclick="testPetButton()">ğŸ¾ æµ‹è¯•å® ç‰©æŒ‰é’®</button>
                <button onclick="runFullTest()">ğŸ” å®Œæ•´æµ‹è¯•</button>
                <div id="test-log" class="log"></div>
            </div>

            <div class="test-section">
                <h2>3. è®¾ç½®é¢æ¿é¢„è§ˆ</h2>
                <p>è¿™é‡Œæ˜¾ç¤ºå®é™…çš„è®¾ç½®é¢æ¿ï¼š</p>
                <div id="extensions_settings2"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>4. å®æ—¶çŠ¶æ€ç›‘æ§</h2>
            <button onclick="startStatusMonitoring()">ğŸ“Š å¼€å§‹ç›‘æ§</button>
            <button onclick="stopStatusMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
            <div id="status-log" class="log" style="max-height: 200px;"></div>
        </div>
    </div>

    <!-- æ¨¡æ‹ŸSillyTavernçš„å…¨å±€å¯¹è±¡ -->
    <script>
        // æ¨¡æ‹ŸSillyTavernçš„extension_settings
        window.extension_settings = {};
        
        // æ¨¡æ‹ŸgetContextå‡½æ•°
        window.getContext = function() {
            return {
                api_server: '/api/v1/generate',
                chat: [],
                characters: [],
                characterId: 0,
                groups: [],
                extensionSettings: window.extension_settings,
                saveSettingsDebounced: function() {
                    console.log('Settings saved (debounced)');
                    envLog('ğŸ’¾ è®¾ç½®å·²ä¿å­˜ (é˜²æŠ–)', 'success');
                }
            };
        };
        
        // æ¨¡æ‹ŸsaveSettingsDebounced
        window.saveSettingsDebounced = function() {
            console.log('Settings saved (debounced)');
            envLog('ğŸ’¾ è®¾ç½®å·²ä¿å­˜ (é˜²æŠ–)', 'success');
        };

        let statusMonitoringInterval = null;

        function envLog(message, type = 'info') {
            const logDiv = document.getElementById('env-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testLog(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function statusLog(message) {
            const logDiv = document.getElementById('status-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setupSillyTavernEnvironment() {
            // æ¨¡æ‹Ÿæ›´å¤šSillyTavernå¯¹è±¡
            window.SillyTavern = {
                settings: {
                    api_endpoint: '/api/v1/generate',
                    generation_settings: {
                        endpoint: '/api/generate'
                    }
                },
                config: {
                    api_url: '/completions'
                },
                generateReply: async function(prompt) {
                    return `æ¨¡æ‹ŸAIå›å¤: ${prompt.substring(0, 50)}...`;
                }
            };

            window.st = {
                api: {
                    endpoint: '/api/st/generate'
                }
            };

            // æ¨¡æ‹Ÿtoastrï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (typeof toastr === 'undefined') {
                window.toastr = {
                    success: (msg) => envLog(`âœ… ${msg}`, 'success'),
                    info: (msg) => envLog(`â„¹ï¸ ${msg}`, 'info'),
                    warning: (msg) => envLog(`âš ï¸ ${msg}`, 'warning'),
                    error: (msg) => envLog(`âŒ ${msg}`, 'error')
                };
            }

            envLog('âœ… SillyTavernç¯å¢ƒå·²è®¾ç½®', 'success');
            envLog('- window.extension_settings å·²åˆå§‹åŒ–', 'info');
            envLog('- window.getContext() å¯ç”¨', 'info');
            envLog('- window.SillyTavern å¯¹è±¡å·²åˆ›å»º', 'info');
            envLog('- æ¨¡æ‹ŸAPIç«¯ç‚¹å·²é…ç½®', 'info');
        }

        function clearEnvironment() {
            delete window.SillyTavern;
            delete window.st;
            window.extension_settings = {};
            envLog('ğŸ§¹ ç¯å¢ƒå·²æ¸…é™¤', 'warning');
        }

        function testExtensionLoading() {
            testLog('ğŸ“¦ å¼€å§‹æµ‹è¯•æ‰©å±•åŠ è½½...', 'info');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„å…¨å±€å‡½æ•°
                if (typeof getContext === 'function') {
                    testLog('âœ… getContext() å‡½æ•°å¯ç”¨', 'success');
                } else {
                    testLog('âŒ getContext() å‡½æ•°ä¸å¯ç”¨', 'error');
                }

                if (typeof saveSettingsDebounced === 'function') {
                    testLog('âœ… saveSettingsDebounced() å‡½æ•°å¯ç”¨', 'success');
                } else {
                    testLog('âŒ saveSettingsDebounced() å‡½æ•°ä¸å¯ç”¨', 'error');
                }

                if (typeof extension_settings === 'object') {
                    testLog('âœ… extension_settings å¯¹è±¡å¯ç”¨', 'success');
                } else {
                    testLog('âŒ extension_settings å¯¹è±¡ä¸å¯ç”¨', 'error');
                }

                testLog('ğŸ“¦ æ‰©å±•åŠ è½½æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                testLog(`âŒ æ‰©å±•åŠ è½½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testSettingsManagement() {
            testLog('âš™ï¸ å¼€å§‹æµ‹è¯•è®¾ç½®ç®¡ç†...', 'info');
            
            try {
                // æ¨¡æ‹Ÿè®¾ç½®æ“ä½œ
                const testSettings = {
                    enabled: true,
                    personalityType: 'cheerful',
                    apiEndpoint: 'auto'
                };

                extension_settings['virtual-pet-system'] = testSettings;
                testLog('âœ… è®¾ç½®å†™å…¥æˆåŠŸ', 'success');

                const readSettings = extension_settings['virtual-pet-system'];
                if (readSettings && readSettings.enabled === true) {
                    testLog('âœ… è®¾ç½®è¯»å–æˆåŠŸ', 'success');
                } else {
                    testLog('âŒ è®¾ç½®è¯»å–å¤±è´¥', 'error');
                }

                testLog('âš™ï¸ è®¾ç½®ç®¡ç†æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                testLog(`âŒ è®¾ç½®ç®¡ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testApiIntrospection() {
            testLog('ğŸ•µï¸ å¼€å§‹æµ‹è¯•APIå†…çœ...', 'info');
            
            try {
                // æ£€æŸ¥æ˜¯å¦èƒ½æ‰¾åˆ°APIé…ç½®
                const candidates = ['SillyTavern', 'st', 'config'];
                let found = false;

                for (const candidate of candidates) {
                    if (window[candidate]) {
                        testLog(`âœ… æ‰¾åˆ°å…¨å±€å¯¹è±¡: window.${candidate}`, 'success');
                        found = true;
                    }
                }

                if (!found) {
                    testLog('âš ï¸ æœªæ‰¾åˆ°APIé…ç½®å¯¹è±¡', 'warning');
                }

                testLog('ğŸ•µï¸ APIå†…çœæµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                testLog(`âŒ APIå†…çœæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testPetButton() {
            testLog('ğŸ¾ å¼€å§‹æµ‹è¯•å® ç‰©æŒ‰é’®...', 'info');
            
            try {
                // æ£€æŸ¥æ˜¯å¦èƒ½åˆ›å»ºæŒ‰é’®
                const testButton = $('<div id="test-pet-button" style="position: fixed; top: 100px; left: 100px; width: 48px; height: 48px; background: #FF9EC7; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 999999;">ğŸ¾</div>');
                $('body').append(testButton);
                
                testLog('âœ… æµ‹è¯•æŒ‰é’®åˆ›å»ºæˆåŠŸ', 'success');
                
                // 3ç§’åç§»é™¤æµ‹è¯•æŒ‰é’®
                setTimeout(() => {
                    testButton.remove();
                    testLog('ğŸ§¹ æµ‹è¯•æŒ‰é’®å·²ç§»é™¤', 'info');
                }, 3000);

                testLog('ğŸ¾ å® ç‰©æŒ‰é’®æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                testLog(`âŒ å® ç‰©æŒ‰é’®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function runFullTest() {
            testLog('ğŸ” å¼€å§‹å®Œæ•´æµ‹è¯•...', 'info');
            testLog('='.repeat(50), 'info');
            
            testExtensionLoading();
            setTimeout(() => testSettingsManagement(), 500);
            setTimeout(() => testApiIntrospection(), 1000);
            setTimeout(() => testPetButton(), 1500);
            setTimeout(() => {
                testLog('='.repeat(50), 'info');
                testLog('ğŸ” å®Œæ•´æµ‹è¯•å®Œæˆ', 'success');
            }, 2000);
        }

        function startStatusMonitoring() {
            if (statusMonitoringInterval) return;
            
            statusLog('ğŸ“Š å¼€å§‹çŠ¶æ€ç›‘æ§...');
            
            statusMonitoringInterval = setInterval(() => {
                const stats = {
                    æ‰©å±•è®¾ç½®æ•°é‡: Object.keys(extension_settings).length,
                    jQueryç‰ˆæœ¬: $.fn.jquery || 'N/A',
                    å½“å‰æ—¶é—´: new Date().toLocaleTimeString(),
                    å†…å­˜ä½¿ç”¨: performance.memory ? `${Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)}MB` : 'N/A'
                };
                
                statusLog(`çŠ¶æ€: ${JSON.stringify(stats, null, 2)}`);
            }, 3000);
        }

        function stopStatusMonitoring() {
            if (statusMonitoringInterval) {
                clearInterval(statusMonitoringInterval);
                statusMonitoringInterval = null;
                statusLog('â¹ï¸ çŠ¶æ€ç›‘æ§å·²åœæ­¢');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è®¾ç½®ç¯å¢ƒ
        $(document).ready(function() {
            setupSillyTavernEnvironment();
            testLog('ğŸš€ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            testLog('å¯ä»¥å¼€å§‹æµ‹è¯•æ ‡å‡†åŒ–çš„è™šæ‹Ÿå® ç‰©æ‰©å±•', 'info');
        });
    </script>

    <!-- åŠ è½½æ–°çš„æ ‡å‡†åŒ–æ‰©å±• -->
    <script type="module" src="index-new.js"></script>
</body>
</html>
