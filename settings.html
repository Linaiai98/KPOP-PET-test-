<!-- 虚拟宠物系统设置面板 -->
<div id="virtual-pet-settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>🐾 虚拟宠物系统</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            <div class="flex-container">
                <label class="checkbox_label" for="virtual-pet-enabled-toggle">
                    <input id="virtual-pet-enabled-toggle" type="checkbox" checked>
                    <span>启用虚拟宠物系统</span>
                </label>
            </div>
            <small class="notes">
                启用后会在屏幕上显示一个可拖动的宠物按钮（🐾），点击可以打开宠物管理界面。<br>
                你可以通过喂食、玩耍、休息等方式与虚拟宠物互动，宠物会随着时间成长升级。
            </small>
            
            <div class="flex-container" style="margin-top: 15px;">
                <div class="flex1">
                    <h4>插件信息</h4>
                    <p><strong>版本:</strong> 1.0.0</p>
                    <p><strong>作者:</strong> Augment Agent</p>
                    <p><strong>描述:</strong> 一个为SillyTavern设计的虚拟宠物系统</p>
                </div>
            </div>
            
            <div class="flex-container" style="margin-top: 15px;">
                <div class="flex1">
                    <h4>使用说明</h4>
                    <ul style="margin-left: 20px; color: var(--SmartThemeBodyColor);">
                        <li>点击屏幕上的🐾按钮打开宠物界面</li>
                        <li>使用"喂食"、"玩耍"、"休息"按钮与宠物互动</li>
                        <li>宠物状态会随时间自然变化，需要定期照顾</li>
                        <li>通过互动获得经验值，宠物会升级成长</li>
                        <li>在设置页面可以自定义宠物名称和类型</li>
                    </ul>
                </div>
            </div>
            
            <!-- Firebase 同步设置 -->
            <div class="kpop-pet-settings-section" id="firebase-sync-settings">
                <h3>☁️ Firebase 同步</h3>
                <div class="kpop-pet-settings-item">
                    <label>连接状态:</label>
                    <span id="firebase-status-value" style="color:red; font-weight: bold;">未连接</span>
                </div>
                <div class="kpop-pet-settings-item">
                    <label>本机同步ID:</label>
                    <span id="firebase-uid" style="word-break: break-all;">N/A</span>
                    <button id="copy-uid-button" class="kpop-pet-button" disabled>复制ID</button>
                </div>
                <hr>
                <h4>从其他设备同步</h4>
                <p class="kpop-pet-settings-description">
                    要同步另一台设备的数据，请在那台设备上复制它的同步ID，然后粘贴到下方并点击按钮。
                </p>
                <div class="kpop-pet-settings-item">
                    <input type="text" id="sync-id-input" class="text_pole" placeholder="在此处粘贴其他设备的同步ID">
                    <button id="pull-from-id-button" class="kpop-pet-button">从ID同步</button>
                </div>
            </div>
            
            <div class="pet-nav-buttons">
                <button class="pet-button back-to-main-btn">
                    ← 返回
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseStatusEl = document.getElementById('firebase-status-value');
        const firebaseUidEl = document.getElementById('firebase-uid');
        const copyUidBtn = document.getElementById('copy-uid-button');
        const syncIdInput = document.getElementById('sync-id-input');
        const pullFromIdBtn = document.getElementById('pull-from-id-button');

        const FIREBASE_UID_KEY = 'kpop-pet-firebase-uid';

        // 监听来自 firebase-config.js 的认证状态变化事件
        document.addEventListener('firebase-auth-state-changed', (event) => {
            const user = event.detail.user;
            if (user && user.uid) {
                firebaseStatusEl.textContent = '已连接';
                firebaseStatusEl.style.color = 'green';
                firebaseUidEl.textContent = user.uid;
                copyUidBtn.disabled = false;
            } else {
                firebaseStatusEl.textContent = '未连接';
                firebaseStatusEl.style.color = 'red';
                firebaseUidEl.textContent = 'N/A';
                copyUidBtn.disabled = true;
            }
        });

        // 检查初始状态
        setTimeout(() => {
            // SillyTavern环境中，currentUser可能作为全局变量存在
            if (window.currentUser && window.currentUser.uid) {
                 document.dispatchEvent(new CustomEvent('firebase-auth-state-changed', { detail: { user: window.currentUser } }));
            } else {
                document.dispatchEvent(new CustomEvent('firebase-auth-state-changed', { detail: { user: null } }));
            }
        }, 500); // 延迟执行以确保Firebase脚本已加载

        // 复制ID
        copyUidBtn.addEventListener('click', () => {
            if (firebaseUidEl.textContent && firebaseUidEl.textContent !== 'N/A') {
                navigator.clipboard.writeText(firebaseUidEl.textContent)
                    .then(() => { alert('同步ID已复制到剪贴板!'); })
                    .catch(err => { 
                        console.error('无法复制ID: ', err);
                        alert('复制失败，请手动复制。');
                    });
            }
        });

        // 从ID同步
        pullFromIdBtn.addEventListener('click', () => {
            const newUid = syncIdInput.value.trim();
            if (newUid) {
                if (confirm(`确定要从新的ID同步数据吗？\n\nID: ${newUid}\n\n这将会刷新页面并使用这个新ID作为本机的身份。`)) {
                    console.log(`[Settings] Storing new UID (${newUid}) and reloading page.`);
                    localStorage.setItem(FIREBASE_UID_KEY, newUid);
                    alert('同步ID已更新。页面即将刷新以加载新ID的数据。');
                    location.reload();
                }
            } else {
                alert('请输入一个有效的同步ID。');
            }
        });
    });
</script>
