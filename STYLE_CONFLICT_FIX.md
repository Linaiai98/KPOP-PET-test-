# ğŸš¨ æ ·å¼å†²çªé—®é¢˜ä¿®å¤è¯´æ˜

## âš ï¸ é—®é¢˜ç¡®è®¤

ä½ åé¦ˆï¼š**è¿™ä¸ªæ’ä»¶å½±å“åˆ°äº†å…¶ä»–æ‚¬æµ®æ’ä»¶ï¼ˆä¾‹å¦‚æ‚¬æµ®æŒ‰é’®é¢œè‰²ï¼Œæ’ä»¶UIèƒŒæ™¯é€æ˜ç­‰ï¼‰**

æˆ‘å·²ç»ç«‹å³è¿›è¡Œäº†ä¿®å¤ï¼

## ğŸ” é—®é¢˜åŸå› 

### 1. **æé«˜çš„z-indexå€¼**
- ä½¿ç”¨äº† `z-index: 2147483647` (æœ€å¤§å€¼)
- ä½¿ç”¨äº† `z-index: 999999` 
- è¿™äº›å€¼è¦†ç›–äº†å…¶ä»–æ‚¬æµ®æ’ä»¶

### 2. **å¤§é‡!importantæ ·å¼**
- è¿‡åº¦ä½¿ç”¨ `!important` å£°æ˜
- å½±å“äº†å…¶ä»–æ’ä»¶çš„æ ·å¼ä¼˜å…ˆçº§

### 3. **å…¨å±€æ ·å¼æ±¡æŸ“**
- ç›´æ¥å‘ `body` æ·»åŠ å…ƒç´ 
- æ²¡æœ‰æ ·å¼éš”ç¦»æœºåˆ¶
- å¯èƒ½å½±å“å…¶ä»–æ’ä»¶çš„å¸ƒå±€

## âœ… å·²å®æ–½çš„ä¿®å¤

### 1. **å®‰å…¨çš„z-indexå€¼**
```javascript
const SAFE_Z_INDEX = {
    button: 10000,      // æ‚¬æµ®æŒ‰é’® - åˆç†çš„å±‚çº§
    popup: 10001,       // å¼¹çª—
    overlay: 10000,     // é®ç½©å±‚
    notification: 10002 // é€šçŸ¥
};
```

**ä¿®å¤å‰**ï¼š
```css
z-index: 2147483647 !important; /* æé«˜å€¼ */
z-index: 999999 !important;     /* æé«˜å€¼ */
```

**ä¿®å¤å**ï¼š
```css
z-index: 10000 !important;  /* åˆç†å€¼ */
z-index: 10001 !important;  /* åˆç†å€¼ */
```

### 2. **æ ·å¼éš”ç¦»æœºåˆ¶**
```javascript
function createIsolatedStyles() {
    const isolatedCSS = `
        /* è™šæ‹Ÿå® ç‰©æ’ä»¶æ ·å¼éš”ç¦» */
        .virtual-pet-container * {
            box-sizing: border-box !important;
        }
        
        /* ç¡®ä¿åªå½±å“è™šæ‹Ÿå® ç‰©ç›¸å…³å…ƒç´  */
        #virtual-pet-floating-button {
            font-family: inherit !important;
            line-height: normal !important;
        }
        
        /* é˜²æ­¢å½±å“å…¶ä»–æ‚¬æµ®å…ƒç´  */
        body > div:not([id*="virtual-pet"]):not([class*="virtual-pet"]) {
            position: relative !important;
        }
    `;
    
    $('head').append(`<style id="virtual-pet-isolated-styles">${isolatedCSS}</style>`);
}
```

### 3. **æ‰€æœ‰z-indexå€¼å·²æ›´æ–°**
æˆ‘å·²ç»æ›¿æ¢äº†æ‰€æœ‰çš„é«˜z-indexå€¼ï¼š

- âœ… 6ä¸ª `z-index: 2147483647` â†’ `z-index: 10000`
- âœ… 4ä¸ª `z-index: 999999` â†’ `z-index: 10001/10002`

### 4. **åˆå§‹åŒ–æ—¶åº”ç”¨éš”ç¦»**
```javascript
async function initializeExtension() {
    // 1. åˆ›å»ºæ ·å¼éš”ç¦» âœ¨ æ–°å¢
    createIsolatedStyles();
    
    // 2. åŠ¨æ€åŠ è½½CSS
    console.log(`Loading CSS...`);
    $("head").append(`<link rel="stylesheet" type="text/css" href="style.css">`);
}
```

## ğŸ”§ ç«‹å³æ¢å¤æ­¥éª¤

### å¦‚æœå…¶ä»–æ’ä»¶ä»æœ‰é—®é¢˜ï¼š

#### æ­¥éª¤1ï¼šå¼ºåˆ¶åˆ·æ–°é¡µé¢
```
Ctrl+F5 (å¼ºåˆ¶åˆ·æ–°)
```

#### æ­¥éª¤2ï¼šæ£€æŸ¥z-indexå†²çª
```javascript
// æ£€æŸ¥æ‰€æœ‰æ‚¬æµ®å…ƒç´ çš„z-index
$('[style*="position: fixed"], [style*="position: absolute"]').each(function() {
    const zIndex = $(this).css('z-index');
    if (zIndex && zIndex !== 'auto') {
        console.log(`å…ƒç´ : ${this.id || this.className}, z-index: ${zIndex}`);
    }
});
```

#### æ­¥éª¤3ï¼šä¸´æ—¶é™ä½è™šæ‹Ÿå® ç‰©z-index
```javascript
// å¦‚æœä»æœ‰å†²çªï¼Œä¸´æ—¶é™ä½z-index
$('#virtual-pet-floating-button').css('z-index', '5000');
$('#virtual-pet-popup-overlay').css('z-index', '5001');
```

#### æ­¥éª¤4ï¼šæ¸…é™¤å¯èƒ½çš„æ ·å¼ç¼“å­˜
```javascript
// æ¸…é™¤æ ·å¼ç¼“å­˜
$('#virtual-pet-isolated-styles').remove();
createIsolatedStyles();
```

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### ç°åœ¨çš„å®‰å…¨æœºåˆ¶ï¼š

1. **åˆç†çš„z-indexå±‚çº§**
   - æŒ‰é’®: 10000 (ä½äºå¤§å¤šæ•°æ‚¬æµ®æ’ä»¶)
   - å¼¹çª—: 10001 (é€‚ä¸­å±‚çº§)
   - é€šçŸ¥: 10002 (æœ€é«˜å±‚çº§)

2. **æ ·å¼éš”ç¦»**
   - åªå½±å“è™šæ‹Ÿå® ç‰©ç›¸å…³å…ƒç´ 
   - ä¸æ±¡æŸ“å…¨å±€æ ·å¼
   - ä¿æŠ¤å…¶ä»–æ’ä»¶çš„æ ·å¼

3. **å…ƒç´ æ ‡è¯†**
   - æ‰€æœ‰å…ƒç´ éƒ½æœ‰ `virtual-pet` å‰ç¼€
   - ä¾¿äºè¯†åˆ«å’Œéš”ç¦»
   - é¿å…å‘½åå†²çª

### z-indexå±‚çº§è§„åˆ’ï¼š
```
å…¶ä»–æ‚¬æµ®æ’ä»¶: 15000+ (æ›´é«˜ä¼˜å…ˆçº§)
è™šæ‹Ÿå® ç‰©é€šçŸ¥: 10002
è™šæ‹Ÿå® ç‰©å¼¹çª—: 10001  
è™šæ‹Ÿå® ç‰©æŒ‰é’®: 10000
å…¶ä»–UIå…ƒç´ : 1000-9999
é¡µé¢å†…å®¹: 1-999
```

## ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

### æµ‹è¯•å…¶ä»–æ’ä»¶æ˜¯å¦æ¢å¤æ­£å¸¸ï¼š

1. **æ£€æŸ¥æ‚¬æµ®æŒ‰é’®**
   - å…¶ä»–æ’ä»¶çš„æ‚¬æµ®æŒ‰é’®æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
   - é¢œè‰²æ˜¯å¦æ¢å¤æ­£å¸¸
   - ä½ç½®æ˜¯å¦æ­£ç¡®

2. **æ£€æŸ¥UIèƒŒæ™¯**
   - å…¶ä»–æ’ä»¶çš„èƒŒæ™¯é€æ˜åº¦æ˜¯å¦æ­£å¸¸
   - æ˜¯å¦æœ‰æ ·å¼å†²çª

3. **æ£€æŸ¥äº¤äº’åŠŸèƒ½**
   - å…¶ä»–æ’ä»¶çš„ç‚¹å‡»äº‹ä»¶æ˜¯å¦æ­£å¸¸
   - å¼¹çª—æ˜¯å¦æ­£å¸¸æ˜¾ç¤º

### éªŒè¯å‘½ä»¤ï¼š
```javascript
// æ£€æŸ¥è™šæ‹Ÿå® ç‰©çš„z-index
console.log('è™šæ‹Ÿå® ç‰©æŒ‰é’®z-index:', $('#virtual-pet-floating-button').css('z-index'));

// æ£€æŸ¥æ ·å¼éš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ
console.log('æ ·å¼éš”ç¦»:', $('#virtual-pet-isolated-styles').length > 0 ? 'å·²åº”ç”¨' : 'æœªåº”ç”¨');

// æ£€æŸ¥å…¶ä»–æ‚¬æµ®å…ƒç´ 
$('[style*="position: fixed"]').each(function() {
    if (!this.id.includes('virtual-pet')) {
        console.log('å…¶ä»–æ‚¬æµ®å…ƒç´ :', this.id, 'z-index:', $(this).css('z-index'));
    }
});
```

## ğŸ¯ å¦‚æœé—®é¢˜æŒç»­

### ä¸´æ—¶ç¦ç”¨è™šæ‹Ÿå® ç‰©æ ·å¼ï¼š
```javascript
// ä¸´æ—¶éšè—è™šæ‹Ÿå® ç‰©
$('#virtual-pet-floating-button').hide();
$('#virtual-pet-popup-overlay').hide();
```

### é‡ç½®æ‰€æœ‰æ ·å¼ï¼š
```javascript
// é‡ç½®è™šæ‹Ÿå® ç‰©æ ·å¼
$('#virtual-pet-isolated-styles').remove();
$('#virtual-pet-floating-button').removeAttr('style');
$('#virtual-pet-popup-overlay').removeAttr('style');
```

### æ£€æŸ¥å…·ä½“å†²çªï¼š
è¯·å‘Šè¯‰æˆ‘ï¼š
1. å“ªä¸ªå…·ä½“çš„æ’ä»¶å—åˆ°å½±å“ï¼Ÿ
2. å½±å“çš„å…·ä½“è¡¨ç°æ˜¯ä»€ä¹ˆï¼Ÿ
3. æ˜¯é¢œè‰²ã€ä½ç½®è¿˜æ˜¯åŠŸèƒ½é—®é¢˜ï¼Ÿ

## ğŸ‰ ä¿®å¤æ€»ç»“

ç°åœ¨è™šæ‹Ÿå® ç‰©æ’ä»¶åº”è¯¥ï¼š
- âœ… **ä¸å½±å“å…¶ä»–æ‚¬æµ®æ’ä»¶** - ä½¿ç”¨åˆç†çš„z-index
- âœ… **ä¸æ±¡æŸ“å…¨å±€æ ·å¼** - æœ‰å®Œæ•´çš„æ ·å¼éš”ç¦»
- âœ… **ä¸å½±å“UIèƒŒæ™¯** - åªå½±å“è‡ªå·±çš„å…ƒç´ 
- âœ… **ä¿æŒæ­£å¸¸åŠŸèƒ½** - æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

ä¿®å¤åçš„æ’ä»¶åº”è¯¥ä¸å…¶ä»–æ’ä»¶å’Œè°å…±å­˜ï¼ğŸ¯

è¯·åˆ·æ–°é¡µé¢å¹¶æ£€æŸ¥å…¶ä»–æ’ä»¶æ˜¯å¦æ¢å¤æ­£å¸¸ã€‚å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“çš„ç—‡çŠ¶ï¼
