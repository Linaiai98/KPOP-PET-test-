<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ - æ™ºèƒ½å†…çœæµ‹è¯•</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #2b2b2b;
            color: #fff;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #3b3b3b;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #4b4b4b;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            background: #2b2b2b;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ•µï¸ è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ - æ™ºèƒ½å†…çœæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. æ¨¡æ‹ŸSillyTavernç¯å¢ƒ</h2>
            <p>è¿™ä¸ªæµ‹è¯•é¡µé¢æ¨¡æ‹Ÿäº†SillyTavernçš„åŸºæœ¬ç¯å¢ƒã€‚</p>
            <button onclick="simulateSillyTavernEnv()">ğŸ­ æ¨¡æ‹ŸSillyTavernç¯å¢ƒ</button>
            <button onclick="clearSimulation()">ğŸ§¹ æ¸…é™¤æ¨¡æ‹Ÿç¯å¢ƒ</button>
            <div id="extensions_settings2" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>2. æ™ºèƒ½å†…çœç³»ç»Ÿæµ‹è¯•</h2>
            <button onclick="testIntrospectionSystem()">ğŸ•µï¸ æµ‹è¯•æ™ºèƒ½å†…çœ</button>
            <button onclick="testSmartEndpoint()">ğŸ¤– æµ‹è¯•æ™ºèƒ½ç«¯ç‚¹è·å–</button>
            <button onclick="runFullDiagnostic()">ğŸ” å®Œæ•´è¯Šæ–­</button>
            <button onclick="clearStorage()">ğŸ—‘ï¸ æ¸…é™¤å­˜å‚¨æ•°æ®</button>
            <div id="test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>3. æ‰‹åŠ¨ç¯å¢ƒé…ç½®</h2>
            <label>æ¨¡æ‹Ÿå…¨å±€å¯¹è±¡:</label>
            <select id="global-object-type">
                <option value="none">æ— å…¨å±€å¯¹è±¡</option>
                <option value="SillyTavern">window.SillyTavern</option>
                <option value="st">window.st</option>
                <option value="config">window.config</option>
            </select>
            <br>
            <label>æ¨¡æ‹ŸAPIç«¯ç‚¹:</label>
            <input type="text" id="simulated-endpoint" placeholder="/api/custom/generate">
            <br>
            <button onclick="setupSimulatedEnvironment()">ğŸ¯ è®¾ç½®æ¨¡æ‹Ÿç¯å¢ƒ</button>
        </div>

        <div class="test-section">
            <h2>4. å®æ—¶ç›‘æ§</h2>
            <button onclick="startMonitoring()">ğŸ“Š å¼€å§‹ç›‘æ§</button>
            <button onclick="stopMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
            <div id="monitor-log" class="log" style="max-height: 200px;"></div>
        </div>
    </div>

    <script src="index.js"></script>
    <script>
        let monitoringInterval = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function monitorLog(message) {
            const logDiv = document.getElementById('monitor-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function simulateSillyTavernEnv() {
            // æ¨¡æ‹Ÿä¸€äº›å¸¸è§çš„SillyTavernå…¨å±€å¯¹è±¡
            window.SillyTavern = {
                settings: {
                    api_endpoint: '/api/v1/generate',
                    generation_settings: {
                        endpoint: '/api/generate'
                    }
                },
                config: {
                    api_url: '/completions'
                }
            };

            window.st = {
                api: {
                    endpoint: '/api/st/generate'
                }
            };

            log('âœ… å·²æ¨¡æ‹ŸSillyTavernç¯å¢ƒ', 'success');
            log('- window.SillyTavern.settings.api_endpoint = "/api/v1/generate"', 'info');
            log('- window.st.api.endpoint = "/api/st/generate"', 'info');
        }

        function clearSimulation() {
            delete window.SillyTavern;
            delete window.st;
            delete window.config;
            log('ğŸ§¹ å·²æ¸…é™¤æ¨¡æ‹Ÿç¯å¢ƒ', 'warning');
        }

        function testIntrospectionSystem() {
            log('ğŸ•µï¸ å¼€å§‹æµ‹è¯•æ™ºèƒ½å†…çœç³»ç»Ÿ...', 'info');
            
            try {
                if (typeof introspectSillyTavernAPI === 'function') {
                    const results = introspectSillyTavernAPI();
                    
                    log(`å†…çœç»“æœ: ${results.found ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`, results.found ? 'success' : 'error');
                    if (results.found) {
                        log(`- å‘ç°ç«¯ç‚¹: ${results.endpoint}`, 'success');
                        log(`- æ¥æº: ${results.source}`, 'info');
                        log(`- ç½®ä¿¡åº¦: ${results.confidence}%`, 'info');
                    }
                    
                    log('è¯¦ç»†è¿‡ç¨‹:', 'info');
                    results.details.forEach(detail => {
                        log(`  ${detail}`, 'info');
                    });
                } else {
                    log('âŒ introspectSillyTavernAPI å‡½æ•°æœªæ‰¾åˆ°', 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testSmartEndpoint() {
            log('ğŸ¤– æµ‹è¯•æ™ºèƒ½ç«¯ç‚¹è·å–...', 'info');
            
            try {
                if (typeof getSmartApiEndpoint === 'function') {
                    const endpoint = getSmartApiEndpoint();
                    log(`âœ… æ™ºèƒ½ç«¯ç‚¹è·å–æˆåŠŸ: ${endpoint}`, 'success');
                } else {
                    log('âŒ getSmartApiEndpoint å‡½æ•°æœªæ‰¾åˆ°', 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function runFullDiagnostic() {
            log('ğŸ” å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            log('='.repeat(50), 'info');
            
            // 1. æ£€æŸ¥å…¨å±€å¯¹è±¡
            log('1. æ£€æŸ¥å…¨å±€å¯¹è±¡:', 'info');
            const globalObjects = ['SillyTavern', 'st', 'config', 'settings'];
            globalObjects.forEach(obj => {
                if (window[obj]) {
                    log(`  âœ… window.${obj} å­˜åœ¨`, 'success');
                } else {
                    log(`  âŒ window.${obj} ä¸å­˜åœ¨`, 'warning');
                }
            });

            // 2. æµ‹è¯•å†…çœ
            log('2. æµ‹è¯•å†…çœç³»ç»Ÿ:', 'info');
            testIntrospectionSystem();

            // 3. æµ‹è¯•æ™ºèƒ½ç«¯ç‚¹
            log('3. æµ‹è¯•æ™ºèƒ½ç«¯ç‚¹:', 'info');
            testSmartEndpoint();

            // 4. æ£€æŸ¥å­˜å‚¨
            log('4. æ£€æŸ¥æœ¬åœ°å­˜å‚¨:', 'info');
            const apiEndpoint = localStorage.getItem('virtual-pet-api-endpoint');
            const customUrl = localStorage.getItem('virtual-pet-custom-api-url');
            log(`  APIç«¯ç‚¹é…ç½®: ${apiEndpoint || 'æœªè®¾ç½®'}`, 'info');
            log(`  è‡ªå®šä¹‰URL: ${customUrl || 'æœªè®¾ç½®'}`, 'info');

            log('='.repeat(50), 'info');
            log('ğŸ” å®Œæ•´è¯Šæ–­å®Œæˆ', 'success');
        }

        function setupSimulatedEnvironment() {
            const objType = document.getElementById('global-object-type').value;
            const endpoint = document.getElementById('simulated-endpoint').value;

            clearSimulation();

            if (objType !== 'none' && endpoint) {
                if (objType === 'SillyTavern') {
                    window.SillyTavern = {
                        settings: { api_endpoint: endpoint }
                    };
                } else if (objType === 'st') {
                    window.st = {
                        api: { endpoint: endpoint }
                    };
                } else if (objType === 'config') {
                    window.config = {
                        api_url: endpoint
                    };
                }
                log(`âœ… å·²è®¾ç½® window.${objType} åŒ…å«ç«¯ç‚¹: ${endpoint}`, 'success');
            }
        }

        function startMonitoring() {
            if (monitoringInterval) return;
            
            monitorLog('ğŸ“Š å¼€å§‹ç›‘æ§æ™ºèƒ½ç«¯ç‚¹ç³»ç»Ÿ...');
            
            monitoringInterval = setInterval(() => {
                try {
                    if (typeof getSmartApiEndpoint === 'function') {
                        const endpoint = getSmartApiEndpoint();
                        monitorLog(`å½“å‰æ™ºèƒ½ç«¯ç‚¹: ${endpoint}`);
                    }
                } catch (error) {
                    monitorLog(`ç›‘æ§é”™è¯¯: ${error.message}`);
                }
            }, 3000);
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                monitorLog('â¹ï¸ ç›‘æ§å·²åœæ­¢');
            }
        }

        function clearStorage() {
            localStorage.clear();
            log('ğŸ—‘ï¸ æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤', 'warning');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        $(document).ready(function() {
            log('ğŸš€ æ™ºèƒ½å†…çœæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log('è™šæ‹Ÿå® ç‰©ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–...', 'info');
            
            // ç­‰å¾…ä¸€ä¸‹è®©æ’ä»¶å®Œå…¨åŠ è½½
            setTimeout(() => {
                log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
            }, 1000);
        });
    </script>
</body>
</html>
