<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase UI é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #4285f4;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        
        /* æ¨¡æ‹ŸSillyTavernçš„æ‰©å±•è®¾ç½®æ ·å¼ */
        #extensions_settings2 {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .inline-drawer {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
        }
        
        .inline-drawer-toggle {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        
        .inline-drawer-content {
            padding: 16px;
        }
        
        .flex-container {
            margin-bottom: 15px;
        }
        
        .flex1 {
            flex: 1;
        }
        
        .checkbox_label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .notes {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }
        
        h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1em;
        }
        
        /* æµ‹è¯•æŒ‰é’®æ ·å¼ */
        .test-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: all 0.2s ease;
            background: #007bff;
            color: white;
        }
        
        .test-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
    </style>
    
    <!-- åŠ è½½jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- åŠ è½½Firebase CSSæ ·å¼ -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>ğŸ”¥ Firebase UI é›†æˆæµ‹è¯•</h1>
    
    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªé¡µé¢æ¨¡æ‹ŸSillyTavernçš„æ‰©å±•è®¾ç½®ç¯å¢ƒï¼Œç”¨äºæµ‹è¯•Firebaseäº‘ç«¯å¤‡ä»½UIæ˜¯å¦æ­£ç¡®é›†æˆã€‚</p>
        
        <div class="status info">
            <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>
            <ul style="margin: 10px 0 0 20px;">
                <li>éªŒè¯Firebase UIæ˜¯å¦æ­£ç¡®æ˜¾ç¤ºåœ¨æ‰©å±•è®¾ç½®ä¸­</li>
                <li>æµ‹è¯•æ‰€æœ‰æŒ‰é’®å’Œè¾“å…¥æ¡†æ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
                <li>æ£€æŸ¥æ ·å¼æ˜¯å¦ä¸SillyTaverné£æ ¼ä¸€è‡´</li>
                <li>éªŒè¯äº‹ä»¶ç»‘å®šæ˜¯å¦æ­£ç¡®</li>
            </ul>
        </div>
        
        <button id="load-ui-btn" class="test-btn">ğŸš€ åŠ è½½Firebase UI</button>
        <button id="test-events-btn" class="test-btn">ğŸ”§ æµ‹è¯•äº‹ä»¶ç»‘å®š</button>
        <button id="clear-log-btn" class="test-btn">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="container">
        <h2>ğŸ“± æ¨¡æ‹ŸSillyTavernæ‰©å±•è®¾ç½®</h2>
        <div id="extensions_settings2">
            <p style="color: #666; font-style: italic;">æ‰©å±•è®¾ç½®å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
        </div>
    </div>
    
    <div class="container">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div id="test-log" class="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ‰©å±•å
        const extensionName = 'virtual-pet-system';
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // æ¨¡æ‹ŸFirebaseé…ç½®
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA74TnN9IoyQjCncKOIOShWEktrL1hd96o",
            authDomain: "kpop-pett.firebaseapp.com",
            projectId: "kpop-pett",
            storageBucket: "kpop-pett.firebasestorage.app",
            messagingSenderId: "264650615774",
            appId: "1:264650615774:web:f500ff555183110c3f0b4f",
            measurementId: "G-3BH0GMJR3D"
        };
        
        // æ¨¡æ‹ŸFirebaseçŠ¶æ€å˜é‡
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let firebaseStorage = null;
        let currentUser = null;
        let isFirebaseInitialized = false;
        let connectionCode = null;
        let connectionCodeExpiry = null;
        
        // åŠ è½½Firebase UI
        function loadFirebaseUI() {
            log('ğŸš€ å¼€å§‹åŠ è½½Firebase UI...');
            
            const firebaseSettingsHtml = `
                <!-- Firebase äº‘ç«¯å¤‡ä»½è®¾ç½® -->
                <div class="inline-drawer">
                    <div class="inline-drawer-toggle inline-drawer-header">
                        <b>â˜ï¸ Firebase äº‘ç«¯å¤‡ä»½</b>
                        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                    </div>
                    <div class="inline-drawer-content">
                        <div class="flex-container">
                            <div class="flex1">
                                <small class="notes" style="margin-bottom: 15px; display: block;">
                                    ä½¿ç”¨Firebaseå®ç°å…¨å¹³å°æ•°æ®åŒæ­¥ï¼Œæ”¯æŒiOSã€å®‰å“ã€ç”µè„‘ç«¯æ•°æ®å¤‡ä»½ä¸æ¢å¤ã€‚
                                </small>
                                
                                <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                                <div id="firebase-status" class="firebase-status-container" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; background: #f8f9fa; border-left: 4px solid #6c757d;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span id="firebase-status-icon">âšª</span>
                                        <span id="firebase-status-text">æœªè¿æ¥</span>
                                    </div>
                                    <div id="firebase-user-info" style="font-size: 0.9em; color: #6c757d; margin-top: 5px; display: none;">
                                        <div>ç”¨æˆ·ID: <span id="firebase-user-id">-</span></div>
                                        <div>è®¾å¤‡: <span id="firebase-device-name">-</span></div>
                                    </div>
                                </div>

                                <!-- ä¸»è®¾å¤‡æ“ä½œ -->
                                <div id="firebase-primary-device" class="firebase-section">
                                    <h5 style="margin-bottom: 10px;">ğŸ“± ä¸»è®¾å¤‡è®¾ç½®</h5>
                                    <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 10px;">
                                        åœ¨ä¸»è®¾å¤‡ä¸Šç”Ÿæˆè¿æ¥ç ï¼Œå…¶ä»–è®¾å¤‡å¯ä»¥ä½¿ç”¨æ­¤è¿æ¥ç åŒæ­¥æ•°æ®ã€‚
                                    </p>
                                    
                                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                                        <button id="firebase-init-btn" class="firebase-btn firebase-btn-primary">
                                            ğŸ”— åˆå§‹åŒ–äº‘ç«¯å¤‡ä»½
                                        </button>
                                        <button id="firebase-generate-code-btn" class="firebase-btn firebase-btn-secondary" disabled>
                                            ğŸ”‘ ç”Ÿæˆè¿æ¥ç 
                                        </button>
                                        <button id="firebase-backup-now-btn" class="firebase-btn firebase-btn-success" disabled>
                                            â˜ï¸ ç«‹å³å¤‡ä»½
                                        </button>
                                    </div>

                                    <!-- è¿æ¥ç æ˜¾ç¤º -->
                                    <div id="firebase-connection-code-display" style="display: none; margin-bottom: 15px;">
                                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">ğŸ”‘ è®¾å¤‡è¿æ¥ç </label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="text" id="firebase-connection-code-text" readonly 
                                                   style="flex: 1; padding: 8px; border: 2px solid #28a745; border-radius: 4px; background: #f8fff9; font-family: monospace; font-size: 16px; text-align: center; letter-spacing: 2px;">
                                            <button id="firebase-copy-code-btn" class="firebase-btn firebase-btn-outline">
                                                ğŸ“‹ å¤åˆ¶
                                            </button>
                                        </div>
                                        <small style="color: #28a745; margin-top: 5px; display: block;">
                                            â° è¿æ¥ç æœ‰æ•ˆæœŸï¼š5åˆ†é’Ÿï¼Œè¯·å°½å¿«åœ¨å…¶ä»–è®¾å¤‡ä¸Šä½¿ç”¨
                                        </small>
                                    </div>
                                </div>

                                <!-- ä»è®¾å¤‡æ“ä½œ -->
                                <div id="firebase-secondary-device" class="firebase-section" style="margin-top: 20px;">
                                    <h5 style="margin-bottom: 10px;">ğŸ“² ä»è®¾å¤‡è¿æ¥</h5>
                                    <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 10px;">
                                        è¾“å…¥ä¸»è®¾å¤‡ç”Ÿæˆçš„è¿æ¥ç ï¼ŒåŒæ­¥æ‰€æœ‰å® ç‰©æ•°æ®ã€AIè®¾ç½®å’Œå¤´åƒã€‚
                                    </p>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">ğŸ”‘ è¾“å…¥è¿æ¥ç </label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="text" id="firebase-connection-code-input" placeholder="è¾“å…¥6ä½è¿æ¥ç " 
                                                   maxlength="6" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 16px; text-align: center; letter-spacing: 2px; text-transform: uppercase;">
                                            <button id="firebase-connect-btn" class="firebase-btn firebase-btn-primary">
                                                ğŸ”— è¿æ¥åŒæ­¥
                                            </button>
                                        </div>
                                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                                            ğŸ’¡ è¿æ¥ç æ ¼å¼ï¼š6ä½å¤§å†™å­—æ¯å’Œæ•°å­—ç»„åˆï¼Œå¦‚ï¼šABC123
                                        </small>
                                    </div>
                                </div>

                                <!-- æ•°æ®ç®¡ç† -->
                                <div id="firebase-data-management" class="firebase-section" style="margin-top: 20px; display: none;">
                                    <h5 style="margin-bottom: 10px;">ğŸ“Š æ•°æ®ç®¡ç†</h5>
                                    
                                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                                        <button id="firebase-restore-btn" class="firebase-btn firebase-btn-info">
                                            ğŸ“¥ æ¢å¤æ•°æ®
                                        </button>
                                        <button id="firebase-check-status-btn" class="firebase-btn firebase-btn-outline">
                                            ğŸ” æ£€æŸ¥åŒæ­¥çŠ¶æ€
                                        </button>
                                        <button id="firebase-disconnect-btn" class="firebase-btn firebase-btn-danger">
                                            ğŸ”Œ æ–­å¼€è¿æ¥
                                        </button>
                                    </div>

                                    <!-- åŒæ­¥çŠ¶æ€è¯¦æƒ… -->
                                    <div id="firebase-sync-details" style="display: none; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em;">
                                        <div><strong>ğŸ“± å® ç‰©æ•°æ®:</strong> <span id="sync-pet-status">-</span></div>
                                        <div><strong>ğŸ¤– AIè®¾ç½®:</strong> <span id="sync-ai-status">-</span></div>
                                        <div><strong>ğŸ¨ å¤´åƒ:</strong> <span id="sync-avatar-status">-</span></div>
                                        <div><strong>â° æœ€ååŒæ­¥:</strong> <span id="sync-last-time">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $("#extensions_settings2").html(firebaseSettingsHtml);
            log('âœ… Firebase UIå·²åŠ è½½åˆ°æ‰©å±•è®¾ç½®åŒºåŸŸ');
            
            // ç»‘å®šæµ‹è¯•äº‹ä»¶
            bindTestEvents();
        }
        
        // ç»‘å®šæµ‹è¯•äº‹ä»¶
        function bindTestEvents() {
            log('ğŸ”§ å¼€å§‹ç»‘å®šæµ‹è¯•äº‹ä»¶...');
            
            // æ¨¡æ‹ŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#firebase-init-btn').on('click', function() {
                log('ğŸ”— ç‚¹å‡»äº†"åˆå§‹åŒ–äº‘ç«¯å¤‡ä»½"æŒ‰é’®');
                $(this).text('âœ… åˆå§‹åŒ–å®Œæˆ').prop('disabled', true);
                $('#firebase-generate-code-btn, #firebase-backup-now-btn').prop('disabled', false);
                updateFirebaseStatus('connected', 'å·²è¿æ¥ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰');
            });
            
            $('#firebase-generate-code-btn').on('click', function() {
                log('ğŸ”‘ ç‚¹å‡»äº†"ç”Ÿæˆè¿æ¥ç "æŒ‰é’®');
                const testCode = 'ABC123';
                $('#firebase-connection-code-text').val(testCode);
                $('#firebase-connection-code-display').show();
                log(`âœ… ç”Ÿæˆæµ‹è¯•è¿æ¥ç : ${testCode}`);
            });
            
            $('#firebase-copy-code-btn').on('click', function() {
                log('ğŸ“‹ ç‚¹å‡»äº†"å¤åˆ¶è¿æ¥ç "æŒ‰é’®');
                const code = $('#firebase-connection-code-text').val();
                log(`ğŸ“‹ å¤åˆ¶è¿æ¥ç : ${code}`);
            });
            
            $('#firebase-connect-btn').on('click', function() {
                const code = $('#firebase-connection-code-input').val();
                log(`ğŸ”— ç‚¹å‡»äº†"è¿æ¥åŒæ­¥"æŒ‰é’®ï¼Œè¾“å…¥çš„è¿æ¥ç : ${code}`);
                if (code.length === 6) {
                    log('âœ… è¿æ¥ç æ ¼å¼æ­£ç¡®');
                    $('#firebase-data-management').show();
                } else {
                    log('âŒ è¿æ¥ç æ ¼å¼é”™è¯¯');
                }
            });
            
            // è¿æ¥ç è¾“å…¥æ¡†æ ¼å¼åŒ–
            $('#firebase-connection-code-input').on('input', function() {
                let value = $(this).val().toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (value.length > 6) {
                    value = value.substring(0, 6);
                }
                $(this).val(value);
                log(`ğŸ“ è¿æ¥ç è¾“å…¥: ${value}`);
            });
            
            log('âœ… æµ‹è¯•äº‹ä»¶ç»‘å®šå®Œæˆ');
        }
        
        // æ›´æ–°FirebaseçŠ¶æ€æ˜¾ç¤º
        function updateFirebaseStatus(status = 'disconnected', message = '') {
            const statusContainer = $('#firebase-status');
            const statusIcon = $('#firebase-status-icon');
            const statusText = $('#firebase-status-text');
            const userInfo = $('#firebase-user-info');
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusContainer.removeClass('connected connecting error');
            
            switch (status) {
                case 'connected':
                    statusContainer.addClass('connected');
                    statusIcon.text('ğŸŸ¢');
                    statusText.text(message || 'å·²è¿æ¥');
                    userInfo.show();
                    $('#firebase-user-id').text('test-user-123');
                    $('#firebase-device-name').text('æµ‹è¯•è®¾å¤‡');
                    break;
                    
                case 'connecting':
                    statusContainer.addClass('connecting');
                    statusIcon.text('ğŸŸ¡');
                    statusText.text(message || 'è¿æ¥ä¸­...');
                    userInfo.hide();
                    break;
                    
                case 'error':
                    statusContainer.addClass('error');
                    statusIcon.text('ğŸ”´');
                    statusText.text(message || 'è¿æ¥é”™è¯¯');
                    userInfo.hide();
                    break;
                    
                default: // disconnected
                    statusIcon.text('âšª');
                    statusText.text(message || 'æœªè¿æ¥');
                    userInfo.hide();
                    break;
            }
            
            log(`ğŸ“Š çŠ¶æ€æ›´æ–°: ${status} - ${message}`);
        }
        
        // æµ‹è¯•æ‰€æœ‰äº‹ä»¶
        function testAllEvents() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•æ‰€æœ‰äº‹ä»¶...');
            
            const tests = [
                {
                    name: 'åˆå§‹åŒ–æŒ‰é’®',
                    selector: '#firebase-init-btn',
                    test: () => $('#firebase-init-btn').length > 0
                },
                {
                    name: 'ç”Ÿæˆè¿æ¥ç æŒ‰é’®',
                    selector: '#firebase-generate-code-btn',
                    test: () => $('#firebase-generate-code-btn').length > 0
                },
                {
                    name: 'è¿æ¥ç è¾“å…¥æ¡†',
                    selector: '#firebase-connection-code-input',
                    test: () => $('#firebase-connection-code-input').length > 0
                },
                {
                    name: 'è¿æ¥åŒæ­¥æŒ‰é’®',
                    selector: '#firebase-connect-btn',
                    test: () => $('#firebase-connect-btn').length > 0
                },
                {
                    name: 'çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ',
                    selector: '#firebase-status',
                    test: () => $('#firebase-status').length > 0
                }
            ];
            
            let passedTests = 0;
            tests.forEach(test => {
                const result = test.test();
                if (result) {
                    log(`âœ… ${test.name}: é€šè¿‡`);
                    passedTests++;
                } else {
                    log(`âŒ ${test.name}: å¤±è´¥`);
                }
            });
            
            log(`ğŸ“Š æµ‹è¯•ç»“æœ: ${passedTests}/${tests.length} é€šè¿‡`);
            
            if (passedTests === tests.length) {
                log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Firebase UIé›†æˆæˆåŠŸï¼');
            } else {
                log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥UIé›†æˆ');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
        $(document).ready(function() {
            log('ğŸ“± æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            $('#load-ui-btn').on('click', function() {
                loadFirebaseUI();
            });
            
            $('#test-events-btn').on('click', function() {
                testAllEvents();
            });
            
            $('#clear-log-btn').on('click', function() {
                $('#test-log').text('');
                log('æ—¥å¿—å·²æ¸…ç©º');
            });
            
            log('ğŸš€ ç‚¹å‡»"åŠ è½½Firebase UI"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
